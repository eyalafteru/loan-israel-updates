# 🏷️ סוכן הטמעת DataLayer לכפתורי העתקת קוד

## ✅ סטטוס: הושלם בהצלחה!

**תאריך הרצה אחרונה:** 22 בדצמבר 2025

### סיכום ביצוע:
- **קבצים שעודכנו:** 23/23 ✅
- **פונקציות שהוטמעו:** 42
- **סוגי כפתורים:** `copy-embed-code`, `copy-preview-code`

---

## 📋 תיאור הסוכן

סוכן אוטומטי שעובר על כל עמודי המחשבונים ומטמיע קוד DataLayer לכל כפתורי "העתקת הקוד" לצורך מעקב ב-Google Tag Manager.

---

## 🎯 מטרה

מעקב אחרי כל לחיצה על כפתור "העתקת קוד" באתר כדי:
- לדעת כמה אנשים מעתיקים את הקוד של המחשבונים
- לזהות אילו מחשבונים הכי פופולריים להטמעה
- למדוד את האפקטיביות של כל מחשבון

---

## 📁 תיקיית יעד

```
C:\Users\eyal\עדכון עמודים מיוחדים מאני\מחשבונים מוכנים לעלייה לאוויר
```

### רשימת הקבצים שהסוכן מעבד:

| # | שם הקובץ | שם המחשבון |
|---|----------|------------|
| 1 | מחשבון איחוד הלוואות.html | מחשבון איחוד הלוואות |
| 2 | מחשבון ברוטו נטו.html | מחשבון ברוטו נטו |
| 3 | מחשבון הלוואות ישן.html | מחשבון הלוואות |
| 4 | מחשבון הלוואת בלון גרייס.html | מחשבון הלוואת בלון גרייס |
| 5 | מחשבון חופש כלכלי.html | מחשבון חופש כלכלי |
| 6 | מחשבון חיסכון.html | מחשבון חיסכון |
| 7 | מחשבון יחס החזר מהכנסה DTI.html | מחשבון יחס החזר מהכנסה DTI |
| 8 | מחשבון מדד תשומות הבנייה.html | מחשבון מדד תשומות הבנייה |
| 9 | מחשבון מס רכישה.html | מחשבון מס רכישה |
| 10 | מחשבון משכנתא.html | מחשבון משכנתא |
| 11 | מחשבון ניכיון צקים.html | מחשבון ניכיון צ'קים |
| 12 | מחשבון עלות מעסיק.html | מחשבון עלות מעסיק |
| 13 | מחשבון עלות רכב TCO.html | מחשבון עלות רכב TCO |
| 14 | מחשבון עמלת פירעון מוקדם.html | מחשבון עמלת פירעון מוקדם |
| 15 | מחשבון עצמאי מול שכיר.html | מחשבון עצמאי מול שכיר |
| 16 | מחשבון פיצויים 360.html | מחשבון פיצויים 360 |
| 17 | מחשבון פנסיה ישן.html | מחשבון פנסיה |
| 18 | מחשבון קיצור הלוואה.html | מחשבון קיצור הלוואה |
| 19 | מחשבון ריבית אפקטיבית.html | מחשבון ריבית אפקטיבית |
| 20 | מחשבון ריבית דה ריבית.html | מחשבון ריבית דריבית |
| 21 | מחשבון שווי אופציות.html | מחשבון שווי אופציות |
| 22 | מחשבון שווי שימוש רכב.html | מחשבון שווי שימוש רכב |
| 23 | מחשבון שכירות מול רכישה.html | מחשבון שכירות מול רכישה |

---

## 🔍 כפתורים שהסוכן מזהה

### 1. כפתור העתקת קוד HTML מלא
```html
<button data-action="copy-embed-code">📋 העתק קוד HTML מלא</button>
```
- פונקציה: `copyEmbedCode()`
- תפקיד: מעתיק את כל הקוד של המחשבון כולל CSS ו-JavaScript

### 2. כפתור העתקת קוד עם צבע נבחר
```html
<button data-action="copy-preview-code">📋 העתק קוד עם הצבע הנבחר</button>
```
- פונקציה: `copyPreviewCode()`
- תפקיד: מעתיק את הקוד עם התאמת צבע אישית

---

## 📊 מבנה ה-DataLayer שנוסף

### קוד שמוזרק לכל פונקציית העתקה:

```javascript
// 🏷️ DataLayer Push - מעקב Tag Manager
window.dataLayer = window.dataLayer || [];
window.dataLayer.push({
    'event': 'copy_code_click',
    'calculator_name': 'שם המחשבון',
    'button_type': 'copy-embed-code'  // או 'copy-preview-code'
});
```

### פרמטרים:

| פרמטר | תיאור | דוגמה |
|-------|-------|-------|
| `event` | שם האירוע קבוע | `copy_code_click` |
| `calculator_name` | שם המחשבון (מחולץ מהקוד או משם הקובץ) | `מחשבון ברוטו נטו` |
| `button_type` | סוג כפתור ההעתקה | `copy-embed-code` |

---

## 🚀 הפעלת הסוכן

### הרצה מומלצת (מתיקיית C:\Users\eyal):
```bash
py run_datalayer_agent.py           # הפעלה עם שינויים
py run_datalayer_agent.py --dry-run # בדיקה בלבד
```

### או עם נתיב מלא לPython:
```bash
"C:\Users\eyal\AppData\Local\Programs\Python\Python311\python.exe" "C:\Users\eyal\run_datalayer_agent.py"
```

### הרצה מתוך תיקיית הפרויקט:
```bash
run_datalayer_agent.bat --dry-run
```

> 💡 **הערה:** במצב `--dry-run` הסוכן מציג מה יעשה אבל לא משנה קבצים

---

## 🔧 מה הסוכן עושה בכל עמוד

### שלב 1: קריאת הקובץ
- פותח את קובץ ה-HTML
- קורא את כל התוכן

### שלב 2: חילוץ שם המחשבון
1. מחפש `const CALCULATOR_NAME = '...'` בקוד
2. אם לא נמצא - מחפש כותרת `<h1>`
3. אם לא נמצא - משתמש בשם הקובץ

### שלב 3: בדיקה אם כבר קיים DataLayer
- מחפש את המחרוזת `copy_code_click`
- אם קיים - מדלג על הקובץ (מונע כפילויות)

### שלב 4: זיהוי כפתורי העתקה
- מחפש `data-action="copy-embed-code"`
- מחפש `data-action="copy-preview-code"`

### שלב 5: עדכון הפונקציות
- מוצא את פונקציית `copyEmbedCode()`
- מוסיף קוד DataLayer בתחילת הפונקציה
- חוזר עבור `copyPreviewCode()` אם קיימת

### שלב 6: שמירת הקובץ
- שומר את הקובץ המעודכן (אלא אם במצב dry-run)

---

## 📋 דוגמה לפלט הסוכן

```
======================================================================
🏷️  סוכן הטמעת DataLayer לכפתורי העתקת קוד
======================================================================

📁 תיקיית יעד: C:\...\מחשבונים מוכנים לעלייה לאוויר
🔧 מצב: עדכון אמיתי
----------------------------------------------------------------------

📊 נמצאו 23 קבצי HTML

[1/23] 📄 מחשבון ברוטו נטו.html
--------------------------------------------------
   ✅ סטטוס: עודכן בהצלחה - 2 פונקציות
   📛 שם מחשבון: מחשבון ברוטו נטו
   🔘 כפתורים שנמצאו: copy-embed-code, copy-preview-code
   🔧 פונקציות שעודכנו: copyEmbedCode, copyPreviewCode

[2/23] 📄 מחשבון משכנתא.html
--------------------------------------------------
   ⏭️ סטטוס: DataLayer כבר קיים - דילוג
   📛 שם מחשבון: מחשבון משכנתא

...

======================================================================
📊 סיכום הפעלה
======================================================================

    📁 סה"כ קבצים:        23
    ✅ קבצים שעודכנו:     21
    ⏭️ קבצים שדולגו:      2
    🔘 כפתורים שנמצאו:    44
    🔧 פונקציות שעודכנו:  42
    
    📅 תאריך הפעלה: 2025-12-22 16:30:00
======================================================================
```

---

## 🎛️ הגדרת Tag ב-Google Tag Manager

### שלב 1: צור Trigger חדש
- **Trigger Type**: Custom Event
- **Event Name**: `copy_code_click`

### שלב 2: צור Tag חדש (GA4 Event)
- **Event Name**: `copy_code_click`
- **Parameters**:
  - `calculator_name`: `{{DL - calculator_name}}`
  - `button_type`: `{{DL - button_type}}`

### שלב 3: צור Data Layer Variables
**Variable 1:**
- **Name**: `DL - calculator_name`
- **Variable Type**: Data Layer Variable
- **Data Layer Variable Name**: `calculator_name`

**Variable 2:**
- **Name**: `DL - button_type`
- **Variable Type**: Data Layer Variable  
- **Data Layer Variable Name**: `button_type`

---

## 🔒 בטיחות הסוכן

### מנגנוני הגנה מובנים:

1. **מניעת כפילויות** - בודק אם DataLayer כבר קיים לפני הוספה
2. **בדיקת קיום פונקציה** - לא מנסה לעדכן פונקציה שלא קיימת
3. **שמירת מקור** - לא משנה את הקוד המקורי, רק מוסיף
4. **מצב dry-run** - אפשר לבדוק לפני ביצוע שינויים
5. **דוחות מפורטים** - מציג בדיוק מה נעשה בכל קובץ

---

## ❓ פתרון בעיות

### הסוכן לא רץ
- ודא ש-Python מותקן
- ודא שהנתיב לתיקייה קיים
- נסה להריץ מ-cmd עם `chcp 65001` לתמיכה בעברית

### הסוכן מדלג על קבצים
- הקובץ כבר מכיל `copy_code_click`
- הקובץ לא מכיל כפתורי העתקה
- הפונקציה כבר מכילה `dataLayer.push`

### שגיאות encoding
- ודא שהקבצים שמורים ב-UTF-8
- הרץ עם `[Console]::OutputEncoding = [System.Text.Encoding]::UTF8`

---

## 📝 הערות נוספות

- הסוכן מחלץ את שם המחשבון באופן אוטומטי מהקוד או משם הקובץ
- ניתן להריץ מספר פעמים - הסוכן לא יוסיף כפילויות
- הקוד הנוסף מסומן בקומנט `🏷️ DataLayer Push` לזיהוי קל

