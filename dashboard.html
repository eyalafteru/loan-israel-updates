<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת ניהול אתרים - After You</title>
    <style>
        :root {
            --bg-primary: #0f0f0f;
            --bg-secondary: #1a1a2e;
            --bg-tertiary: #16213e;
            --accent: #e94560;
            --accent-hover: #ff6b6b;
            --text-primary: #eee;
            --text-secondary: #aaa;
            --border: #333;
            --success: #4ade80;
            --warning: #fbbf24;
            --info: #60a5fa;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
            padding: 1rem 2rem;
            display: flex;
            flex-direction: row-reverse;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--accent);
        }
        
        .header h1 {
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .header-controls {
            display: flex;
            flex-direction: row-reverse;
            gap: 1rem;
            align-items: center;
        }
        
        /* Git Status */
        .git-status-container {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            background: rgba(0,0,0,0.3);
            padding: 0.3rem 0.5rem;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .git-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-weight: 500;
        }
        .git-badge.synced {
            background: #10b981;
            color: white;
        }
        .git-badge.has-changes {
            background: #f59e0b;
            color: white;
        }
        .git-badge.behind {
            background: #ef4444;
            color: white;
        }
        .git-badge.pushing, .git-badge.pulling, .git-badge.syncing {
            background: #3b82f6;
            color: white;
        }
        .btn-git {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }
        .btn-git.btn-sync {
            background: linear-gradient(135deg, #10b981, #3b82f6);
            color: white;
            font-weight: 600;
            padding: 0.35rem 0.75rem;
        }
        .btn-git.btn-sync:hover {
            background: linear-gradient(135deg, #059669, #2563eb);
        }
        .btn-git.btn-small {
            padding: 0.2rem 0.4rem;
            font-size: 0.7rem;
            min-width: 28px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            background: #374151;
            color: white;
            transition: all 0.2s;
        }
        .btn-git:hover:not(:disabled) {
            background: #4b5563;
        }
        .btn-git:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-git.active {
            background: #3b82f6;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            flex-direction: row-reverse;
            gap: 0.5rem;
        }
        
        .tab {
            padding: 0.5rem 1rem;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .tab:hover {
            border-color: var(--accent);
            color: var(--text-primary);
        }
        
        .tab.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }
        
        /* Buttons */
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
        }
        
        .btn-primary {
            background: var(--accent);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--accent-hover);
        }
        
        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover {
            border-color: var(--accent);
        }
        
        .btn-success {
            background: var(--success);
            color: #000;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
            animation: pulse 1.5s infinite;
        }
        
        .btn-warning {
            background: #f59e0b;
            color: #000;
        }
        
        .btn-warning:hover {
            background: #d97706;
        }
        
        .btn-info {
            background: #3b82f6;
            color: #fff;
        }
        
        .btn-info:hover {
            background: #2563eb;
        }
        
        .btn-danger {
            background: #dc2626;
            color: #fff;
        }
        
        .btn-danger:hover {
            background: #b91c1c;
        }
        
        .btn-outline-danger {
            background: transparent;
            color: #f87171;
            border: 1px solid #f87171;
        }
        
        .btn-outline-danger:hover {
            background: #dc2626;
            color: #fff;
        }
        
        .backup-value-display {
            margin-top: 8px;
            padding: 8px 12px;
            background: rgba(248, 113, 113, 0.1);
            border: 1px solid rgba(248, 113, 113, 0.3);
            border-radius: 6px;
            font-size: 0.9em;
        }
        
        .backup-value-display .backup-label {
            color: #f87171;
            font-weight: bold;
            margin-left: 8px;
        }
        
        .backup-value-display .backup-text {
            color: #94a3b8;
            word-break: break-word;
        }
        
        .pulse-green {
            animation: pulse-green 1.5s infinite;
        }
        
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { box-shadow: 0 0 0 8px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }
        
        .save-edit-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
            color: white !important;
            font-weight: bold;
            padding: 0.4rem 1rem !important;
            border: none !important;
        }
        
        .save-edit-btn:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%) !important;
            transform: scale(1.05);
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
            70% { box-shadow: 0 0 0 6px rgba(220, 53, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
        }
        
        .btn-small {
            padding: 0.3rem 0.6rem;
            font-size: 0.8rem;
        }
        
        /* Select */
        select {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 0.9rem;
        }
        
        /* Main Layout */
        .main {
            display: flex;
            height: calc(100vh - 70px);
        }
        
        /* Sidebar - Page List */
        .sidebar {
            width: 400px;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }
        
        .sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .sidebar-header h2 {
            font-size: 1rem;
            font-weight: normal;
        }
        
        .page-list {
            flex: 1;
            overflow-y: auto;
        }
        
        .page-item {
            padding: 0.8rem 1rem;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .page-item:hover {
            background: var(--bg-tertiary);
        }
        
        .page-item.selected {
            background: var(--bg-tertiary);
            border-right: 3px solid var(--accent);
        }
        
        .page-item-title {
            font-weight: 500;
            margin-bottom: 0.3rem;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            direction: rtl;
            gap: 0.5rem;
        }
        
        .page-item-meta {
            font-size: 0.8rem;
            color: var(--text-secondary);
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .page-item-folder {
            color: var(--info);
        }
        
        .site-badge {
            font-size: 0.7rem;
            margin-right: 4px;
        }
        
        .site-badge.site-business {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            padding: 1px 4px;
            border-radius: 3px;
        }
        
        .site-badge.site-main {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            padding: 1px 4px;
            border-radius: 3px;
        }
        
        /* Site config cards */
        .sites-management {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .site-config-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
        }
        
        .site-config-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border);
        }
        
        .site-config-header .site-badge {
            font-size: 1.2rem;
            padding: 4px 8px;
        }
        
        .site-name-input {
            flex: 1;
            font-size: 1.1rem;
            font-weight: bold;
            background: transparent;
            border: 1px solid transparent;
            color: var(--text);
            padding: 0.3rem 0.5rem;
            border-radius: 4px;
        }
        
        .site-name-input:hover {
            border-color: var(--border);
            background: var(--bg-secondary);
        }
        
        .site-name-input:focus {
            border-color: var(--primary);
            background: var(--bg-secondary);
            outline: none;
        }
        
        .site-config-section {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }
        
        .site-config-section h4 {
            margin: 0 0 0.75rem 0;
            font-size: 0.85rem;
            color: var(--text-muted);
        }
        
        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
            cursor: pointer;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-secondary);
            transition: 0.3s;
            border-radius: 26px;
            border: 1px solid var(--border);
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: #888;
            transition: 0.3s;
            border-radius: 50%;
        }
        
        .toggle-switch input:checked + .toggle-slider {
            background-color: rgba(74, 222, 128, 0.2);
            border-color: #4ade80;
        }
        
        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(24px);
            background-color: #4ade80;
        }
        
        .site-config-row {
            display: flex;
            gap: 1rem;
            align-items: end;
        }
        
        .site-config-row .form-group {
            flex: 1;
        }
        
        .site-id-input {
            background: var(--bg-secondary);
            color: var(--text-muted);
            cursor: not-allowed;
        }
        
        .site-stats {
            color: var(--text-muted);
            font-size: 0.85rem;
            white-space: nowrap;
            padding: 0.5rem;
            background: var(--bg-secondary);
            border-radius: 4px;
        }
        
        .word-count-badge {
            background: rgba(59, 130, 246, 0.15);
            color: #60a5fa;
            padding: 1px 6px;
            border-radius: 8px;
            font-size: 0.7rem;
        }
        
        .special-badge {
            margin-left: 4px;
            font-size: 0.85rem;
        }
        
        .page-item.is-special {
            border-right: 3px solid #fbbf24;
        }
        
        .btn-special {
            opacity: 0.5;
            transition: opacity 0.2s;
        }
        
        .btn-special:hover {
            opacity: 1;
        }
        
        .btn-special.is-active {
            opacity: 1;
            background: rgba(251, 191, 36, 0.2);
        }
        
        .last-upload-badge {
            background: rgba(34, 197, 94, 0.15);
            color: #22c55e;
            padding: 1px 6px;
            border-radius: 8px;
            font-size: 0.65rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .last-upload-badge:hover {
            background: rgba(34, 197, 94, 0.3);
        }
        
        .page-item-actions {
            display: flex;
            gap: 4px;
            margin-top: 4px;
        }
        
        
        .btn-mini {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-mini:hover {
            background: var(--surface);
            border-color: var(--accent);
        }
        
        .btn-delete {
            background: #dc2626 !important;
            border-color: #dc2626 !important;
            color: white !important;
        }
        
        .btn-delete:hover {
            background: #b91c1c !important;
            border-color: #b91c1c !important;
        }
        
        /* Removed modal-centered class as we use direct positioning on modal-content */
        
        /* System Modal base styles - Fixed viewport centering using absolute positioning method */
        .system-modal {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            background: rgba(0,0,0,0.7) !important;
            z-index: 2147483647 !important; /* Max z-index */
            margin: 0 !important;
            padding: 0 !important;
            display: none; /* Hidden by default */
            /* Reset any transforms or flex that might be inherited */
            transform: none !important;
        }
        
        .system-modal[style*="display: flex"],
        .system-modal[style*="display: block"] {
            display: block !important; /* Force block to allow child positioning */
        }
        
        .system-modal .modal-content {
            position: fixed !important;
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) !important;
            background: var(--bg-secondary) !important;
            padding: 2rem !important;
            border-radius: 12px !important;
            max-width: 500px !important;
            width: 90% !important;
            border: 1px solid var(--border) !important;
            max-height: 90vh !important;
            overflow-y: auto !important;
            margin: 0 !important; /* Reset margin */
        }
        
        .btn-mini.btn-reset {
            color: var(--warning);
        }
        
        .btn-mini.btn-reset:hover {
            background: rgba(251, 191, 36, 0.2);
            border-color: var(--warning);
        }
        
        .btn-mini.btn-wp {
            color: #22c55e;
            background: rgba(34, 197, 94, 0.1);
            border-color: rgba(34, 197, 94, 0.3);
        }
        
        .btn-mini.btn-wp:hover {
            background: rgba(34, 197, 94, 0.25);
            border-color: #22c55e;
        }
        
        .btn-seo {
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.3);
            color: #10b981;
        }
        
        .btn-seo:hover {
            background: rgba(16, 185, 129, 0.2);
            border-color: #10b981;
        }
        
        .btn-keywords {
            background: rgba(99, 102, 241, 0.1);
            border-color: rgba(99, 102, 241, 0.3);
            color: #818cf8;
        }
        
        .btn-keywords:hover {
            background: rgba(99, 102, 241, 0.2);
            border-color: #818cf8;
        }
        
        .btn-keywords.has-keywords {
            background: rgba(16, 185, 129, 0.15);
            border-color: rgba(16, 185, 129, 0.4);
            color: #10b981;
        }
        
        .btn-keywords.has-keywords:hover {
            background: rgba(16, 185, 129, 0.25);
            border-color: #10b981;
        }
        
        .page-keywords-panel {
            background: var(--bg-tertiary);
            border-top: 1px solid var(--border);
            padding: 0.5rem;
            margin-top: 0.5rem;
            border-radius: 6px;
            font-size: 0.8rem;
        }
        
        .page-keywords-panel .keywords-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .page-keywords-panel .keywords-title {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .page-keywords-panel .keywords-actions {
            display: flex;
            gap: 0.25rem;
        }
        
        .page-keywords-panel .keywords-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
        }
        
        .page-keywords-panel .keyword-tag {
            background: rgba(99, 102, 241, 0.15);
            color: #a5b4fc;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .page-keywords-panel .keyword-tag:hover {
            background: rgba(99, 102, 241, 0.25);
        }
        
        .page-keywords-panel .keyword-tag.cluster {
            border-right: 2px solid #f59e0b;
        }
        
        /* Related searches - different color (orange/amber) */
        .page-keywords-panel .keyword-tag.from-related {
            background: rgba(245, 158, 11, 0.15);
            color: #fbbf24;
        }
        
        .page-keywords-panel .keyword-tag.from-related:hover {
            background: rgba(245, 158, 11, 0.25);
        }
        
        /* Autocomplete - keep default blue */
        .page-keywords-panel .keyword-tag.from-autocomplete {
            background: rgba(99, 102, 241, 0.15);
            color: #a5b4fc;
        }
        
        .page-keywords-panel .keyword-delete {
            cursor: pointer;
            color: #ef4444;
            font-size: 0.65rem;
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        
        .page-keywords-panel .keyword-delete:hover {
            opacity: 1;
        }
        
        .page-keywords-panel .keywords-legend {
            display: flex;
            gap: 10px;
            margin-bottom: 6px;
            font-size: 0.65rem;
            color: var(--text-secondary);
        }
        
        .page-keywords-panel .legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .page-keywords-panel .legend-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .page-keywords-panel .legend-dot.autocomplete {
            background: #a5b4fc;
        }
        
        .page-keywords-panel .legend-dot.related {
            background: #fbbf24;
        }
        
        .page-item.is-running {
            border-right: 4px solid var(--warning);
            background: rgba(251, 191, 36, 0.1);
        }
        
        .page-item.is-completed {
            border-right: 4px solid var(--success);
            background: rgba(74, 222, 128, 0.1);
        }
        
        /* Collapsible Calculator Section */
        .page-group-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.8rem 1rem;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(59, 130, 246, 0.2));
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 8px;
            margin: 0.5rem 0;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .page-group-header:hover {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.3), rgba(59, 130, 246, 0.3));
        }
        
        .page-group-header .group-title {
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .page-group-header .group-count {
            background: rgba(139, 92, 246, 0.3);
            color: #a78bfa;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
        }
        
        .page-group-header .toggle-icon {
            transition: transform 0.3s;
        }
        
        .page-group-header.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }
        
        .page-group-content {
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        
        .page-group-content.collapsed {
            max-height: 0;
        }
        
        .page-group-content .page-item {
            padding-right: 2rem;
            border-right: 2px solid rgba(139, 92, 246, 0.3);
        }
        
        .page-status-dot {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 0;
            margin-left: 8px;
            flex-shrink: 0;
        }
        
        .page-name {
            flex: 1;
            text-align: right;
        }
        
        .page-status-dot.running {
            background: var(--warning);
            animation: pulse-dot 1s ease-in-out infinite;
            box-shadow: 0 0 8px var(--warning);
        }
        
        .page-status-dot.completed {
            background: var(--success);
            box-shadow: 0 0 8px var(--success);
        }
        
        .page-status-dot.pending {
            background: var(--border);
            border: 1px solid var(--text-secondary);
        }
        
        .page-status-dot.step1 {
            background: var(--info);
            box-shadow: 0 0 6px var(--info);
        }
        
        .page-status-dot.step2 {
            background: #f59e0b;
            box-shadow: 0 0 6px #f59e0b;
        }
        
        .page-status-dot.step3 {
            background: #8b5cf6;
            box-shadow: 0 0 6px #8b5cf6;
        }
        
        .page-status-dot.step4 {
            background: #ec4899;
            box-shadow: 0 0 6px #ec4899;
        }
        
        .page-status-dot.step5 {
            background: #14b8a6;
            box-shadow: 0 0 6px #14b8a6;
        }
        
        .page-status-dot.step6 {
            background: #06b6d4;
            box-shadow: 0 0 6px #06b6d4;
        }
        
        /* Multi-agent status display */
        .multi-agent-status {
            display: flex;
            gap: 8px;
            margin-top: 4px;
        }
        
        .agent-progress {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(255,255,255,0.05);
        }
        
        .agent-progress.atomic {
            border-left: 2px solid #f59e0b;
        }
        
        .agent-progress.seo {
            border-left: 2px solid #06b6d4;
        }
        
        .agent-progress.agent-3 {
            border-left: 2px solid #8b5cf6;
        }
        
        .agent-progress.agent-4 {
            border-left: 2px solid #ec4899;
        }
        
        .agent-progress.agent-5 {
            border-left: 2px solid #10b981;
        }
        
        .agent-progress.agent-6 {
            border-left: 2px solid #ef4444;
        }
        
        .agent-progress {
            position: relative;
        }
        
        .btn-reset-agent {
            position: absolute;
            left: 2px;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            color: #ef4444;
            font-size: 0.8rem;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            padding: 0 4px;
            line-height: 1;
        }
        
        .agent-progress:hover .btn-reset-agent {
            opacity: 0.6;
        }
        
        .btn-reset-agent:hover {
            opacity: 1 !important;
        }
        
        .agent-progress .agent-label {
            color: var(--text-secondary);
            font-weight: 600;
        }
        
        .progress-bar-mini {
            display: flex;
            gap: 2px;
        }
        
        .progress-bar-mini .step-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--border);
        }
        
        .progress-bar-mini .step-dot.completed {
            background: var(--success);
        }
        
        .progress-bar-mini .step-dot.atomic.completed {
            background: #f59e0b;
        }
        
        .progress-bar-mini .step-dot.seo.completed {
            background: #06b6d4;
        }
        
        .progress-bar-mini .step-dot.agent-3.completed {
            background: #8b5cf6;
        }
        
        .progress-bar-mini .step-dot.agent-4.completed {
            background: #ec4899;
        }
        
        .progress-bar-mini .step-dot.agent-5.completed {
            background: #10b981;
        }
        
        .progress-bar-mini .step-dot.agent-6.completed {
            background: #ef4444;
        }
        
        .agent-progress.is-done {
            background: rgba(16, 185, 129, 0.1);
            border-color: var(--success);
        }
        
        .agent-done-badge {
            color: var(--success);
            font-weight: bold;
            font-size: 0.7rem;
            margin-right: 2px;
        }
        
        .backup-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.2rem;
            padding: 0.15rem 0.4rem;
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
            border-radius: 10px;
            font-size: 0.65rem;
            margin-top: 0.3rem;
        }
        
        .page-item.is-step3 {
            border-left: 3px solid #8b5cf6;
        }
        
        .step-badge.step3 {
            background: #8b5cf6;
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        .page-item.is-step1 {
            border-right: 4px solid var(--info);
            background: rgba(96, 165, 250, 0.1);
        }
        
        .page-item.is-step2 {
            border-right: 4px solid #f59e0b;
            background: rgba(245, 158, 11, 0.1);
        }
        
        .step-badge {
            font-size: 0.7rem;
            padding: 0.1rem 0.4rem;
            border-radius: 4px;
            margin-right: 0.5rem;
        }
        
        .step-badge.running {
            background: var(--warning);
            color: #000;
        }
        
        .step-badge.step1 {
            background: var(--info);
            color: #000;
        }
        
        .step-badge.step2 {
            background: #f59e0b;
            color: #000;
        }
        
        .step-badge.step3 {
            background: #8b5cf6;
            color: white;
        }
        
        .step-badge.step4 {
            background: #ec4899;
            color: white;
        }
        
        .step-badge.step5 {
            background: #14b8a6;
            color: white;
        }
        
        .step-badge.step6 {
            background: #06b6d4;
            color: white;
        }
        
        .step-badge.completed {
            background: var(--success);
            color: #000;
        }
        
        @keyframes pulse-dot {
            0%, 100% { 
                opacity: 1; 
                transform: scale(1);
            }
            50% { 
                opacity: 0.5; 
                transform: scale(0.8);
            }
        }
        
        .running-indicator {
            margin-left: 0.3rem;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Content Area */
        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .content-header {
            padding: 1rem;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .agent-selector {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .agent-queue {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            margin-left: 1rem;
            padding: 0.25rem 0.5rem;
            background: rgba(147, 51, 234, 0.1);
            border-radius: 6px;
        }
        
        .agent-queue label {
            font-size: 0.8rem;
            color: var(--accent);
        }
        
        .queue-tags {
            display: flex;
            gap: 0.25rem;
            flex-wrap: wrap;
        }
        
        .queue-tag {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            background: var(--accent);
            color: white;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-size: 0.75rem;
        }
        
        .queue-tag .remove-tag {
            cursor: pointer;
            opacity: 0.7;
            font-size: 0.65rem;
        }
        
        .queue-tag .remove-tag:hover {
            opacity: 1;
        }
        
        .workflow-buttons {
            display: flex;
            gap: 0.5rem;
        }
        
        /* Agent queue popup */
        .agent-queue-popup {
            position: fixed;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 1000;
            min-width: 200px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .agent-queue-popup .popup-header {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border);
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .agent-queue-popup .popup-list {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .agent-queue-popup .popup-item {
            padding: 0.6rem 1rem;
            cursor: pointer;
            transition: background 0.2s;
            color: var(--text-primary);
        }
        
        .agent-queue-popup .popup-item:hover {
            background: var(--accent);
            color: white;
        }
        
        .agent-queue-popup .popup-close {
            width: 100%;
            padding: 0.5rem;
            background: transparent;
            border: none;
            border-top: 1px solid var(--border);
            color: var(--text-secondary);
            cursor: pointer;
        }
        
        .agent-queue-popup .popup-close:hover {
            background: rgba(255,255,255,0.05);
        }
        
        /* Batch selection mode */
        .page-checkbox {
            margin-left: 0.5rem;
            cursor: pointer;
        }
        
        .batch-selection-bar {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.5rem 1rem;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 6px;
            margin-bottom: 0.5rem;
        }
        
        .batch-count {
            font-size: 0.85rem;
            color: var(--accent);
        }
        
        /* Panels */
        .panels {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        
        .panel {
            min-width: 200px;
            display: flex;
            flex-direction: column;
            border-left: 1px solid var(--border);
            overflow: hidden;
        }
        
        #reportPanel {
            flex: 1 1 50%;
        }
        
        #previewPanel {
            flex: 1 1 50%;
        }
        
        /* SEO Meta Bar */
        .seo-meta-bar {
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border);
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
        }
        
        .meta-item {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            margin-bottom: 0.3rem;
        }
        
        .meta-label {
            color: var(--text-secondary);
            min-width: 70px;
            flex-shrink: 0;
        }
        
        .meta-value {
            color: var(--text-primary);
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .meta-count {
            font-size: 0.7rem;
            padding: 0.1rem 0.4rem;
            border-radius: 10px;
            flex-shrink: 0;
        }
        
        .meta-count.good {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }
        
        .meta-count.warning {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }
        
        .meta-count.bad {
            background: rgba(239, 68, 68, 0.2);
            color: var(--accent);
        }
        
        .meta-warnings {
            display: flex;
            flex-wrap: wrap;
            gap: 0.3rem;
            margin-top: 0.3rem;
        }
        
        .meta-warning {
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent);
        }
        
        .meta-warning.info {
            background: rgba(59, 130, 246, 0.15);
            color: #60a5fa;
        }
        
        .panel:first-child {
            border-left: none;
        }
        
        /* Resize Handle */
        .resize-handle {
            width: 8px;
            background: var(--bg-tertiary);
            cursor: col-resize;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s ease;
            flex-shrink: 0;
            position: relative;
        }
        
        .resize-handle:hover,
        .resize-handle.dragging {
            background: var(--accent);
        }
        
        .resize-handle::before {
            content: '⋮';
            color: var(--text-secondary);
            font-size: 14px;
            letter-spacing: -2px;
        }
        
        .resize-handle:hover::before,
        .resize-handle.dragging::before {
            color: white;
        }
        
        body.resizing {
            cursor: col-resize !important;
            user-select: none !important;
        }
        
        body.resizing iframe {
            pointer-events: none;
        }
        
        .panel-header {
            padding: 0.8rem 1rem;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border);
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .panel-content {
            flex: 1;
            overflow: auto;
            padding: 1rem;
            min-width: 0;
        }
        
        .panel-content.report {
            background: #111;
            font-family: 'Consolas', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        
        .panel-content.report h1,
        .panel-content.report h2,
        .panel-content.report h3 {
            color: var(--accent);
            margin: 1rem 0 0.5rem;
        }
        
        .panel-content.report ul,
        .panel-content.report ol {
            padding-right: 1.5rem;
        }
        
        .panel-content.report code {
            background: var(--bg-secondary);
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            word-wrap: break-word;
        }
        
        .panel-content.report pre {
            background: var(--bg-secondary);
            padding: 1rem;
            border-radius: 8px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-width: 100%;
        }
        
        .panel-content iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
            border-radius: 8px;
        }
        
        /* WYSIWYG Editor Styles */
        #editorContainer {
            height: calc(100% - 10px);
            display: flex;
            flex-direction: column;
        }
        
        #editorContainer .tox-tinymce {
            flex: 1;
            border: none !important;
            border-radius: 8px !important;
        }
        
        /* TinyMCE Light Mode (White Background) */
        #editorContainer .tox .tox-edit-area__iframe {
            background: #ffffff !important;
        }
        
        #editorContainer .tox:not(.tox-tinymce-inline) .tox-editor-header {
            background: #f8fafc !important;
            border-bottom: 1px solid #e2e8f0 !important;
        }
        
        #editorContainer .tox .tox-toolbar,
        #editorContainer .tox .tox-toolbar__overflow,
        #editorContainer .tox .tox-toolbar__primary {
            background: #f8fafc !important;
        }
        
        #editorContainer .tox .tox-tbtn {
            color: #334155 !important;
        }
        
        #editorContainer .tox .tox-tbtn:hover {
            background: #e2e8f0 !important;
        }
        
        #editorContainer .tox .tox-tbtn--enabled,
        #editorContainer .tox .tox-tbtn--enabled:hover {
            background: #3b82f6 !important;
            color: white !important;
        }
        
        #editorContainer .tox .tox-statusbar {
            background: #f8fafc !important;
            border-top: 1px solid #e2e8f0 !important;
            color: #64748b !important;
        }
        
        #editorContainer .tox-tinymce {
            border: 1px solid #e2e8f0 !important;
        }
        
        /* Editor Save Button */
        #editorSaveBtn {
            display: none;
        }
        
        #editorSaveBtn.visible {
            display: inline-flex;
        }
        
        /* Special Page Notice */
        #specialPageNotice {
            height: 100%;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 1rem;
            color: var(--text-secondary);
        }
        
        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
        }
        
        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        .no-report {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
            text-align: center;
            padding: 2rem;
            font-size: 1.1rem;
        }
        
        /* Report Tabs */
        .report-tabs {
            display: flex;
            gap: 0.5rem;
            padding: 0.5rem;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .report-tab {
            padding: 0.5rem 1rem;
            border: none;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .report-tab:hover {
            background: var(--accent-color);
            color: white;
        }
        
        .report-tab.active {
            background: var(--success-color);
            color: white;
        }
        
        .report-content-tab {
            display: none;
            padding: 1rem;
        }
        
        .report-content-tab.active {
            display: block;
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            display: none;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal {
            background: var(--bg-secondary);
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow: hidden;
            border: 1px solid var(--border);
        }
        
        .modal-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            font-size: 1.2rem;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .modal-close:hover {
            color: var(--accent);
        }
        
        .modal-large {
            max-width: 700px;
            width: 95%;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        
        #uploadModal .modal-body {
            max-height: calc(60vh - 60px);
        }
        
        #uploadModal .modal-footer {
            max-height: none;
            overflow: visible;
        }
        
        .modal-fullscreen {
            max-width: 95vw;
            width: 95vw;
            max-height: 95vh;
            height: 95vh;
            display: flex;
            flex-direction: column;
        }
        
        .modal-fullscreen .modal-body {
            flex: 1;
            max-height: none;
            overflow-y: auto;
        }
        
        .modal-fullscreen .modal-footer {
            flex-shrink: 0;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border);
            background: var(--bg-tertiary);
        }
        
        /* Upload Modal Styles */
        .upload-loading {
            text-align: center;
            padding: 3rem;
        }
        
        .upload-loading .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .upload-section {
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border);
        }
        
        .upload-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .upload-section h3 {
            margin: 0 0 1rem 0;
            color: var(--text-primary);
            font-size: 1rem;
        }
        
        .upload-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .info-item {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }
        
        .info-item label {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }
        
        .info-item span, .info-item a {
            color: var(--text-primary);
            font-weight: 500;
        }
        
        .backup-status {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .backup-badge {
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
        }
        
        .backup-badge.exists {
            background: rgba(74, 222, 128, 0.2);
            color: var(--success);
        }
        
        .backup-badge.missing {
            background: rgba(239, 68, 68, 0.2);
            color: var(--accent);
        }
        
        .form-group small {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }
        
        /* Compare Modal Styles */
        .compare-container {
            display: flex;
            gap: 1rem;
            height: calc(100% - 2rem);
        }
        
        .compare-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }
        
        .compare-panel h3 {
            margin: 0 0 0.5rem 0;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }
        
        .compare-content {
            flex: 1;
            overflow: auto;
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0;
        }
        
        .compare-content iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: #fff;
        }
        
        .compare-controls {
            display: flex;
            gap: 0.5rem;
            margin-left: auto;
            margin-right: 1rem;
        }
        
        .compare-controls .btn.active {
            background: var(--accent);
            border-color: var(--accent);
        }
        
        /* Edit Mode Styles */
        .edit-mode-active {
            border: 3px solid #ff6b35 !important;
            box-shadow: 0 0 10px rgba(255, 107, 53, 0.5);
        }
        
        .direct-edit-active {
            border: 3px solid #10b981 !important;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }
        
        .direct-edit-indicator {
            position: absolute;
            top: 5px;
            left: 5px;
            background: #10b981;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            z-index: 100;
        }
        
        .annotations-sidebar {
            width: 350px;
            background: var(--surface);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: width 0.3s ease;
        }
        
        .annotations-sidebar.hidden {
            width: 0;
            overflow: hidden;
            border: none;
        }
        
        .annotations-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .annotations-header h4 {
            margin: 0;
            font-size: 0.95rem;
        }
        
        .annotations-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }
        
        .annotation-item {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            position: relative;
        }
        
        .annotation-item:hover {
            border-color: var(--accent);
        }
        
        .annotation-element-preview {
            font-family: monospace;
            font-size: 0.75rem;
            color: var(--text-muted);
            background: rgba(0,0,0,0.1);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            margin-bottom: 0.5rem;
            max-height: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            direction: ltr;
        }
        
        .annotation-action {
            display: inline-block;
            background: var(--accent);
            color: white;
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            font-size: 0.7rem;
            margin-left: 0.25rem;
        }
        
        .annotation-action.styling {
            background: #9c27b0;
        }
        
        .annotation-note {
            font-size: 0.85rem;
            margin-top: 0.5rem;
            color: var(--text);
        }
        
        .annotation-remove {
            position: absolute;
            top: 0.5rem;
            left: 0.5rem;
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
            font-size: 1rem;
            opacity: 0.6;
        }
        
        .annotation-remove:hover {
            opacity: 1;
        }
        
        .annotations-footer {
            padding: 1rem;
            border-top: 1px solid var(--border);
        }
        
        .annotations-footer .btn {
            width: 100%;
        }
        
        /* Annotation Popup */
        .annotation-popup {
            position: fixed;
            background: #1a1a2e;
            border: 2px solid #ff6b35;
            border-radius: 12px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.8), 0 0 20px rgba(255, 107, 53, 0.3);
            padding: 1.5rem;
            z-index: 99999;
            min-width: 350px;
            max-width: 420px;
            display: none;
        }
        
        .annotation-popup.visible {
            display: block;
        }
        
        .annotation-popup h4 {
            margin: 0 0 1rem 0;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid #ff6b35;
            color: #fff;
            font-size: 1.1rem;
        }
        
        .popup-close-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255,255,255,0.1);
            border: none;
            color: #fff;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .popup-close-btn:hover {
            background: #ff6b35;
            transform: scale(1.1);
        }
        
        .annotation-popup-section {
            margin-bottom: 1rem;
        }
        
        .annotation-popup-section label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
        }
        
        .annotation-options {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .annotation-option {
            padding: 0.4rem 0.8rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg);
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }
        
        .annotation-option:hover {
            border-color: var(--accent);
        }
        
        .annotation-option.selected {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        
        .annotation-popup textarea {
            width: 100%;
            min-height: 80px;
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.85rem;
            resize: vertical;
        }
        
        .annotation-popup-buttons {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
            margin-top: 1rem;
        }
        
        .annotation-popup-buttons .btn {
            padding: 0.5rem 1rem;
        }
        
        .annotation-element-tag {
            font-family: monospace;
            font-size: 0.75rem;
            color: var(--accent);
            margin-bottom: 0.5rem;
        }
        
        .diff-added {
            background-color: #fef08a !important;
            border-bottom: 2px solid #eab308;
        }
        
        .diff-removed {
            background-color: #fecaca !important;
            text-decoration: line-through;
            opacity: 0.7;
        }
        
        /* SEO Report Panel */
        .seo-report-panel {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-secondary);
            z-index: 10;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* Fix scroll issue when details is open */
        .seo-report-content details[open] {
            overflow: visible;
        }
        
        .seo-section-content {
            max-height: none !important;
            overflow: visible !important;
        }
        
        .seo-report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            background: var(--bg-tertiary);
        }
        
        .seo-report-header h3 {
            margin: 0;
        }
        
        .seo-report-content {
            flex: 1;
            overflow: auto;
            padding: 0.75rem;
            direction: rtl;
            text-align: right;
        }
        
        /* SEO Report Expandable Sections */
        .seo-expandable-section {
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            overflow: visible;
            border: 1px solid var(--border-color);
        }
        
        .seo-expandable-section:not([open]) {
            overflow: hidden;
        }
        
        .seo-section-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: background 0.2s;
            direction: rtl;
        }
        
        .seo-section-header:hover {
            background: rgba(255,255,255,0.05);
        }
        
        .seo-section-icon {
            font-size: 1.2rem;
            flex-shrink: 0;
        }
        
        .seo-section-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            flex-shrink: 0;
        }
        
        .seo-section-summary {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
            flex-wrap: wrap;
            justify-content: flex-start;
        }
        
        .seo-summary-badge {
            font-size: 0.85rem;
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-weight: 500;
            white-space: nowrap;
        }
        
        .seo-summary-badge.good {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }
        
        .seo-summary-badge.warning {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }
        
        .seo-summary-badge.bad {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        
        .seo-summary-badge.neutral {
            background: rgba(107, 114, 128, 0.2);
            color: #9ca3af;
        }
        
        .seo-section-actions {
            display: flex;
            gap: 0.5rem;
            margin-right: auto;
        }
        
        .seo-action-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }
        
        .seo-action-btn:hover {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }
        
        .seo-section-arrow {
            font-size: 0.9rem;
            transition: transform 0.3s;
            color: var(--text-secondary);
        }
        
        .seo-expandable-section[open] .seo-section-arrow {
            transform: rotate(180deg);
        }
        
        .seo-section-content {
            padding: 0.75rem 1rem 1rem;
            border-top: 1px solid var(--border-color);
            background: var(--bg-primary);
            direction: rtl;
        }
        
        /* Info tooltip for header scores - Fixed positioning */
        .info-tooltip {
            position: relative;
            z-index: 10;
        }
        
        .info-tooltip:hover {
            z-index: 999998;
        }
        
        .info-tooltip:hover .tooltip-content {
            display: block !important;
            position: fixed !important;
            z-index: 999999 !important;
        }
        
        .info-tooltip .tooltip-content::after {
            content: '';
            position: absolute;
            top: 100%;
            right: 10px;
            border-width: 6px;
            border-style: solid;
            border-color: #1f2937 transparent transparent transparent;
        }
        
        /* SEO Metrics inside sections */
        .seo-metric-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 0.9rem;
        }
        
        .seo-metric-row:last-child {
            border-bottom: none;
        }
        
        .seo-metric-label {
            font-weight: 500;
            color: var(--text-secondary);
            min-width: 80px;
        }
        
        .seo-metric-value {
            flex: 1;
            color: var(--text-primary);
        }
        
        .seo-metric-status {
            padding: 0.15rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        /* Heading item in list */
        .seo-heading-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.6rem;
            margin: 0.25rem 0;
            background: rgba(255,255,255,0.03);
            border-radius: 4px;
            font-size: 0.85rem;
            border-right: 3px solid var(--border-color);
        }
        
        .seo-heading-item.has-keyword {
            background: rgba(245, 158, 11, 0.1);
            border-right-color: #f59e0b;
        }
        
        .seo-heading-item .heading-text {
            flex: 1;
            color: var(--text-primary);
        }
        
        .seo-heading-item .heading-tag {
            font-size: 0.7rem;
            padding: 0.1rem 0.4rem;
            border-radius: 3px;
            font-weight: bold;
            min-width: 28px;
            text-align: center;
        }
        
        .seo-heading-item .heading-tag.h1 { background: #f59e0b; color: #1a1a2e; }
        .seo-heading-item .heading-tag.h2 { background: #60a5fa; color: #1a1a2e; }
        .seo-heading-item .heading-tag.h3 { background: #a78bfa; color: #1a1a2e; }
        .seo-heading-item .heading-tag.h4 { background: #6b7280; color: white; }
        .seo-heading-item .heading-tag.h5 { background: #4b5563; color: white; }
        .seo-heading-item .heading-tag.h6 { background: #374151; color: white; }
        
        .seo-edit-btn {
            background: #4b5563;
            border: none;
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        
        .seo-heading-item:hover .seo-edit-btn {
            opacity: 1;
        }
        
        /* Link item in list */
        .seo-link-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.6rem;
            margin: 0.25rem 0;
            background: rgba(255,255,255,0.03);
            border-radius: 4px;
            font-size: 0.85rem;
        }
        
        .seo-link-item.duplicate {
            background: rgba(239, 68, 68, 0.1);
            border-right: 3px solid #ef4444;
        }
        
        .seo-link-item .link-context {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        .seo-link-item .link-anchor {
            background: #fef08a;
            color: #1f2937;
            padding: 0.1rem 0.3rem;
            border-radius: 2px;
            font-weight: 500;
        }
        
        /* Progress bar for densities */
        .seo-progress-bar {
            height: 6px;
            background: var(--bg-secondary);
            border-radius: 3px;
            overflow: hidden;
            width: 80px;
            direction: ltr;
        }
        
        .seo-progress-bar .fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s;
        }
        
        .seo-progress-bar .fill.good { background: #10b981; }
        .seo-progress-bar .fill.warning { background: #f59e0b; }
        .seo-progress-bar .fill.bad { background: #ef4444; }
        
        /* Opportunity keyword checkbox */
        .seo-opportunity-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 0.75rem;
            margin: 0.25rem 0;
            background: rgba(255,255,255,0.03);
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .seo-opportunity-item.found {
            background: rgba(16, 185, 129, 0.1);
            border-right: 3px solid #10b981;
        }
        
        .seo-opportunity-item.missing {
            background: rgba(245, 158, 11, 0.1);
            border-right: 3px solid #f59e0b;
        }
        
        .seo-opportunity-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        /* Comparison grid adjustments */
        .seo-comparison-mini {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .seo-comparison-mini .old-value {
            color: #9ca3af;
            font-size: 0.85rem;
        }
        
        .seo-comparison-mini .new-value {
            color: #10b981;
            font-size: 0.85rem;
        }
        
        .seo-change-indicator {
            font-size: 0.75rem;
            padding: 0.1rem 0.4rem;
            border-radius: 3px;
            margin-right: 0.25rem;
        }
        
        .seo-change-indicator.improved {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }
        
        .seo-change-indicator.degraded {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        
        /* Competitor Report Styles */
        .competitor-report-intro {
            text-align: center;
            padding: 2rem;
        }
        
        .competitor-report-intro p {
            color: var(--text-muted);
            margin-bottom: 1.5rem;
        }
        
        .competitor-section {
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .competitor-section h4 {
            margin: 0 0 0.75rem 0;
            color: var(--accent-primary);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }
        
        .autocomplete-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .autocomplete-tag {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
        }
        
        .serp-result {
            display: flex;
            gap: 0.75rem;
            padding: 0.75rem;
            background: var(--bg-tertiary);
            border-radius: 6px;
            margin-bottom: 0.5rem;
        }
        
        .serp-rank {
            background: var(--accent-primary);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }
        
        .serp-info {
            flex: 1;
            min-width: 0;
        }
        
        .serp-title {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }
        
        .serp-url {
            font-size: 0.8rem;
            color: var(--accent-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .serp-stats {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }
        
        .gap-analysis-content {
            line-height: 1.7;
        }
        
        .gap-analysis-content h2 {
            color: var(--accent-primary);
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            font-size: 1.2rem;
        }
        
        .gap-analysis-content h3 {
            color: var(--text-primary);
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }
        
        .gap-analysis-content ul {
            padding-right: 1.5rem;
            margin: 0.5rem 0;
        }
        
        .gap-analysis-content li {
            margin-bottom: 0.5rem;
        }
        
        .competitor-loading {
            text-align: center;
            padding: 3rem;
        }
        
        .competitor-loading .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        .competitor-progress {
            margin-top: 1rem;
        }
        
        .competitor-progress-step {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            color: var(--text-muted);
        }
        
        .competitor-progress-step.active {
            color: var(--accent-primary);
            font-weight: 500;
        }
        
        .competitor-progress-step.done {
            color: var(--accent-success);
        }
        
        .competitor-progress-step .step-icon {
            width: 20px;
            text-align: center;
        }
        
        .seo-comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .seo-column {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 1rem;
        }
        
        .seo-column h4 {
            margin: 0 0 1rem 0;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }
        
        .seo-column.old h4 {
            color: #f59e0b;
        }
        
        .seo-column.new h4 {
            color: #10b981;
        }
        
        .seo-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border);
            font-size: 0.9rem;
            direction: rtl;
        }
        
        .seo-metric:last-child {
            border-bottom: none;
        }
        
        .seo-metric-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .seo-metric-value {
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .seo-metric-value.good {
            color: var(--success);
        }
        
        .seo-metric-value.warning {
            color: #f59e0b;
        }
        
        .seo-metric-value.bad {
            color: var(--accent);
        }
        
        .keyword-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0.5rem;
            direction: rtl;
        }
        
        .keyword-table th, .keyword-table td {
            padding: 0.5rem 0.75rem;
            text-align: right;
            border-bottom: 1px solid var(--border);
            font-size: 0.9rem;
        }
        
        .keyword-table th {
            background: var(--bg-primary);
            font-weight: 600;
            font-size: 0.95rem;
        }
        
        .seo-section {
            margin-bottom: 0.75rem;
            direction: rtl;
        }
        
        .seo-section h5 {
            margin: 0 0 0.5rem 0;
            color: var(--text-primary);
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .heading-structure {
            font-family: monospace;
            font-size: 0.8rem;
            background: var(--bg-primary);
            padding: 0.5rem;
            border-radius: 4px;
            max-height: 150px;
            overflow: auto;
        }
        
        .heading-item {
            padding: 0.2rem 0;
        }
        
        .heading-item.h1 { color: #ef4444; font-weight: bold; }
        .heading-item.h2 { color: #f59e0b; padding-right: 1rem; }
        .heading-item.h3 { color: #10b981; padding-right: 2rem; }
        .heading-item.h4 { color: #3b82f6; padding-right: 3rem; }
        
        .compare-divider {
            width: 2px;
            background: var(--border);
        }
        
        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            max-height: calc(70vh - 60px);
            flex: 1;
        }
        
        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }
        
        /* Prompt Modal */
        #promptModal {
            z-index: 10001;
        }
        
        #promptModal .modal {
            max-width: 900px;
            width: 95%;
            max-height: 85vh;
        }
        
        #promptModal .prompt-content {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            white-space: pre-wrap;
            overflow-y: auto;
            max-height: 60vh;
            direction: rtl;
            text-align: right;
        }
        
        #promptModal .prompt-highlight {
            background: rgba(245, 158, 11, 0.2);
            border-right: 3px solid #f59e0b;
            padding: 0.5rem;
            margin: 0.5rem 0;
        }
        
        #promptModal .prompt-source {
            background: var(--bg-tertiary);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
            border-right: 3px solid var(--accent);
        }
        
        #promptModal .prompt-body {
            line-height: 1.8;
            white-space: pre-wrap;
        }
        
        #promptModal .prompt-section-header {
            font-weight: bold;
            color: var(--accent);
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }
        
        #promptModal .shortcode-placeholder {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            padding: 0.1rem 0.3rem;
            border-radius: 3px;
            font-family: monospace;
        }
        
        .btn-view-prompt {
            background: rgba(139, 92, 246, 0.2);
            color: #a78bfa;
            border: 1px solid rgba(139, 92, 246, 0.3);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            margin-right: 5px;
        }
        
        .btn-view-prompt:hover {
            background: rgba(139, 92, 246, 0.3);
        }
        
        .btn-view-prompt.pulse-animation {
            animation: pulse-prompt 0.5s ease-in-out 3;
        }
        
        @keyframes pulse-prompt {
            0%, 100% { transform: scale(1); background: rgba(139, 92, 246, 0.2); }
            50% { transform: scale(1.1); background: rgba(139, 92, 246, 0.5); }
        }
        
        .prompt-tab {
            background: rgba(139, 92, 246, 0.2) !important;
            color: #a78bfa !important;
            border: 1px solid rgba(139, 92, 246, 0.3) !important;
        }
        
        .prompt-tab.active {
            background: rgba(139, 92, 246, 0.4) !important;
            color: white !important;
        }
        
        .prompt-content-display {
            background: var(--bg-primary);
        }
        
        .prompt-content-display .prompt-highlight {
            background: rgba(245, 158, 11, 0.15);
            border-right: 3px solid #f59e0b;
            padding: 0.5rem;
            margin: 0.5rem 0;
            flex-shrink: 0;
            max-height: 200px;
            overflow-y: auto;
        }
        
        /* Form */
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.7rem 1rem;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 0.9rem;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        .form-row {
            display: flex;
            gap: 1rem;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        .meta-input-wrapper {
            display: flex;
            gap: 0.5rem;
            align-items: flex-start;
        }
        
        .meta-input-wrapper input,
        .meta-input-wrapper textarea {
            flex: 1;
        }
        
        /* Title Suffix Badge */
        .title-suffix-badge {
            display: inline-flex;
            align-items: center;
            background: rgba(139, 92, 246, 0.2);
            color: #a78bfa;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.9rem;
            border: 1px dashed rgba(139, 92, 246, 0.4);
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .meta-edit-btn {
            padding: 0.5rem !important;
            min-width: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
        }
        
        .meta-edit-btn:hover {
            transform: scale(1.05);
        }
        
        /* Meta Edit Popup */
        .meta-edit-popup {
            position: fixed;
            background: #1a1a2e;
            border: 2px solid #ff6b35;
            border-radius: 12px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.8), 0 0 20px rgba(255, 107, 53, 0.3);
            padding: 1.5rem;
            z-index: 99999;
            min-width: 320px;
            display: none;
        }
        
        .meta-edit-popup.visible {
            display: block;
        }
        
        .meta-edit-popup h4 {
            margin: 0 0 1rem 0;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid #ff6b35;
            color: #fff;
            font-size: 1.1rem;
        }
        
        .meta-edit-options {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .meta-edit-option {
            padding: 0.4rem 0.8rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg);
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }
        
        .meta-edit-option:hover {
            border-color: var(--accent);
            background: rgba(255, 107, 53, 0.1);
        }
        
        .meta-edit-option.selected {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        
        .form-section {
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }
        
        .form-section-title {
            color: var(--accent);
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }
        
        /* Status Badge */
        .status-badge {
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .status-pending { background: var(--border); color: var(--text-secondary); }
        .status-report { background: var(--warning); color: #000; }
        .status-fixed { background: var(--info); color: #000; }
        .status-uploaded { background: var(--success); color: #000; }
        
        /* Toast */
        .toast-container {
            position: fixed;
            top: 0.5rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2000;
            max-width: 400px;
        }
        
        .toast {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem 1.5rem;
            margin-top: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            animation: slideIn 0.3s ease;
        }
        
        .toast.success { border-color: var(--success); }
        .toast.error { border-color: var(--accent); }
        .toast.info { border-color: var(--info); }
        
        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Command Display */
        .command-display {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            font-family: 'Consolas', monospace;
            font-size: 0.9rem;
            word-break: break-all;
            margin: 1rem 0;
        }
        
        /* Agent List */
        .agent-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .agent-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem 1rem;
            background: var(--bg-primary);
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        
        .agent-list-item-info {
            display: flex;
            flex-direction: column;
        }
        
        .agent-list-item-name {
            font-weight: 500;
        }
        
        .agent-list-item-type {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        .agent-list-item-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* WordPress Sites */
        .wp-site {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .wp-site-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .wp-site-title {
            color: var(--accent);
            font-weight: 500;
        }
        
        .wp-site-status {
            font-size: 0.8rem;
        }
        
        .wp-site-status.connected {
            color: var(--success);
        }
        
        .wp-site-status.disconnected {
            color: var(--text-secondary);
        }
        
        /* Work Status Panel */
        .work-status-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-top: 2px solid var(--accent);
            max-height: 300px;
            transition: transform 0.3s ease;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }
        
        .work-status-panel.hidden {
            transform: translateY(100%);
        }
        
        .work-status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 1rem;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border);
            cursor: pointer;
        }
        
        .work-status-header h3 {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }
        
        .work-status-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 0.85rem;
            line-height: 1.5;
            background: #0a0a0a;
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 220px;
        }
        
        .work-status-content .step-header {
            color: var(--accent);
            font-weight: bold;
            margin: 0.5rem 0;
        }
        
        .work-status-content .tool-use {
            color: var(--warning);
        }
        
        .work-status-content .file-op {
            color: var(--success);
        }
        
        .work-status-content .thinking {
            color: var(--info);
            font-style: italic;
        }
        
        .work-status-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--text-secondary);
        }
        
        .status-dot.running {
            background: var(--success);
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .status-dot.completed {
            background: var(--info);
        }
        
        .status-dot.error {
            background: var(--accent);
        }
        
        .minimize-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0.2rem;
        }
        
        .minimize-btn:hover {
            color: var(--text-primary);
        }
        
        .work-status-input input:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        .work-status-input input::placeholder {
            color: var(--text-secondary);
        }
        
        /* ============================================
           Keyword Density Analyzer Module Styles
           ============================================ */
        
        .kd-module {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 1.25rem;
            margin-top: 1rem;
        }
        
        .kd-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .kd-header h3 {
            margin: 0;
            font-size: 1.1rem;
            color: var(--text-primary);
        }
        
        .kd-keyword {
            background: linear-gradient(135deg, var(--accent), #ff6b6b);
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            color: white;
        }
        
        /* Summary Cards */
        .kd-summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1.25rem;
        }
        
        .kd-card {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 1rem;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
            transition: transform 0.2s, border-color 0.2s;
        }
        
        .kd-card:hover {
            transform: translateY(-2px);
            border-color: rgba(255,255,255,0.2);
        }
        
        .kd-score-card {
            border-width: 2px;
        }
        
        .kd-card-icon {
            font-size: 1.3rem;
            margin-bottom: 0.4rem;
        }
        
        .kd-card-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.2rem;
        }
        
        .kd-card-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        .kd-card-hint {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-top: 0.3rem;
            opacity: 0.8;
        }
        
        /* Zone Breakdown */
        .kd-zones {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .kd-zones h4 {
            margin: 0 0 0.75rem 0;
            font-size: 0.95rem;
            color: var(--text-primary);
        }
        
        .kd-zone-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        
        .kd-zone-row:last-child {
            border-bottom: none;
        }
        
        .kd-zone-label {
            flex: 0 0 120px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .kd-zone-count {
            font-size: 0.85rem;
            color: var(--text-primary);
            font-weight: 500;
            min-width: 60px;
        }
        
        .kd-zone-status {
            font-size: 0.85rem;
            padding: 0.15rem 0.5rem;
            border-radius: 4px;
        }
        
        .kd-zone-status.found {
            color: #10b981;
        }
        
        .kd-zone-status.missing {
            color: #f59e0b;
        }
        
        .kd-zone-status.neutral {
            color: var(--text-secondary);
        }
        
        /* Density Bar */
        .kd-density-bar {
            flex: 1;
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            position: relative;
            overflow: hidden;
        }
        
        .kd-density-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        
        .kd-density-optimal {
            position: absolute;
            top: 0;
            height: 100%;
            background: rgba(16, 185, 129, 0.3);
            border-left: 2px solid #10b981;
            border-right: 2px solid #10b981;
            pointer-events: none;
        }
        
        /* Suggestions */
        .kd-suggestions {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 1rem;
        }
        
        .kd-suggestions h4 {
            margin: 0 0 0.75rem 0;
            font-size: 0.95rem;
            color: var(--text-primary);
        }
        
        .kd-suggestion {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            border-right: 3px solid transparent;
        }
        
        .kd-suggestion:last-child {
            margin-bottom: 0;
        }
        
        .kd-suggestion-high {
            border-right-color: #ef4444;
        }
        
        .kd-suggestion-medium {
            border-right-color: #f59e0b;
        }
        
        .kd-suggestion-low {
            border-right-color: #10b981;
        }
        
        .kd-suggestion-icon {
            font-size: 1.1rem;
        }
        
        .kd-suggestion-text {
            flex: 1;
            font-size: 0.85rem;
            color: var(--text-primary);
        }
        
        .kd-fix-btn {
            padding: 0.35rem 0.7rem;
            font-size: 0.8rem;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            white-space: nowrap;
        }
        
        .kd-fix-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);
        }
        
        /* Keyword Highlight in Preview */
        .keyword-highlight {
            background: linear-gradient(135deg, rgba(233, 69, 96, 0.3), rgba(255, 107, 107, 0.3));
            padding: 0.1rem 0.2rem;
            border-radius: 3px;
            border-bottom: 2px solid var(--accent);
        }
        
        /* Before/After Comparison */
        .kd-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .kd-comparison-card {
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            padding: 1rem;
        }
        
        .kd-comparison-card h5 {
            margin: 0 0 0.5rem 0;
            font-size: 0.9rem;
        }
        
        .kd-comparison-card.before h5 {
            color: #9ca3af;
        }
        
        .kd-comparison-card.after h5 {
            color: #10b981;
        }
        
        /* ============================================
           Calculation Details Expand Styles
           ============================================ */
        
        details.calc-details summary {
            cursor: pointer;
            list-style: none;
        }
        
        details.calc-details summary::-webkit-details-marker {
            display: none;
        }
        
        details.calc-details summary span:first-child {
            display: inline-block;
            transition: transform 0.2s ease;
        }
        
        details.calc-details[open] summary span:first-child {
            transform: rotate(90deg);
        }
        
        details summary:hover {
            opacity: 0.8;
        }
        
        /* ============================================
           Spam Analyzer Module Styles
           ============================================ */
        
        .spam-module {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 1.25rem;
            margin-top: 1rem;
        }
        
        .spam-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .spam-header h3 {
            margin: 0;
            font-size: 1.1rem;
            color: var(--text-primary);
        }
        
        .spam-risk-badge {
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        /* Summary Cards */
        .spam-summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1.25rem;
        }
        
        .spam-card {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 0.75rem;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
            border-right-width: 3px;
        }
        
        .spam-card-value {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 0.2rem;
        }
        
        .spam-card-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        
        .spam-card-hint {
            font-size: 0.65rem;
            color: var(--text-secondary);
            margin-top: 0.2rem;
            opacity: 0.7;
        }
        
        /* Sections */
        .spam-section {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .spam-section:last-child {
            margin-bottom: 0;
        }
        
        .spam-section h4 {
            margin: 0 0 0.75rem 0;
            font-size: 0.95rem;
            color: var(--text-primary);
        }
        
        /* Metrics */
        .spam-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }
        
        .spam-metric {
            display: flex;
            justify-content: space-between;
            padding: 0.4rem 0.6rem;
            background: rgba(0,0,0,0.2);
            border-radius: 6px;
            font-size: 0.8rem;
        }
        
        .spam-metric-label {
            color: var(--text-secondary);
        }
        
        .spam-metric-value {
            font-weight: 600;
        }
        
        .spam-metric-value.good {
            color: #10b981;
        }
        
        .spam-metric-value.warning {
            color: #f59e0b;
        }
        
        .spam-metric-value.bad {
            color: #ef4444;
        }
        
        /* Context Quality Bar */
        .spam-context-quality {
            margin-top: 0.75rem;
        }
        
        .spam-context-bar {
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 0.4rem;
        }
        
        .spam-context-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        
        .spam-context-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        
        /* Issues */
        .spam-issues {
            margin-top: 0.75rem;
        }
        
        .spam-issue {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.75rem;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            border-right: 3px solid transparent;
        }
        
        .spam-issue:last-child {
            margin-bottom: 0;
        }
        
        .spam-issue-high {
            border-right-color: #ef4444;
        }
        
        .spam-issue-medium {
            border-right-color: #f59e0b;
        }
        
        .spam-issue-icon {
            font-size: 1rem;
            flex-shrink: 0;
        }
        
        .spam-issue-content {
            flex: 1;
        }
        
        .spam-issue-message {
            font-size: 0.85rem;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }
        
        .spam-issue-suggestion {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        
        .spam-fix-btn {
            padding: 0.35rem 0.7rem;
            font-size: 0.75rem;
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .spam-fix-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.4);
        }
        
        /* ============ Agent Builder Styles ============ */
        
        .agents-section {
            display: none;
            position: fixed;
            top: 60px;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            z-index: 100;
            overflow: hidden;
        }
        
        .agents-section.active {
            display: flex;
        }
        
        .agent-builder-container {
            display: flex;
            height: 100%;
            width: 100%;
        }
        
        /* Agent List Sidebar */
        .agent-list-sidebar {
            width: 280px;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .agent-list-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .agent-list-header h3 {
            margin: 0;
            font-size: 1rem;
        }
        
        .agent-list-items {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }
        
        .agent-list-card {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            pointer-events: auto;
            position: relative;
            z-index: 1;
        }
        
        .agent-list-card:hover {
            border-color: var(--primary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .agent-list-card.active {
            border-color: var(--primary);
            background: rgba(59, 130, 246, 0.1);
        }
        
        .agent-list-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.25rem;
        }
        
        .agent-list-card-name {
            font-weight: 600;
        }
        
        .btn-delete-agent {
            background: transparent;
            border: none;
            cursor: pointer;
            opacity: 0.4;
            font-size: 0.9rem;
            padding: 0.2rem;
            transition: opacity 0.2s;
        }
        
        .btn-delete-agent:hover {
            opacity: 1;
        }
        
        .agent-list-card-info {
            font-size: 0.75rem;
            color: var(--text-muted);
            display: flex;
            gap: 0.5rem;
        }
        
        .agent-type-badge {
            padding: 0.1rem 0.4rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 500;
        }
        
        .agent-type-badge.update {
            background: #10b981;
            color: white;
        }
        
        .agent-type-badge.build {
            background: #f59e0b;
            color: white;
        }
        
        .agent-status-badge {
            padding: 0.1rem 0.4rem;
            border-radius: 4px;
            font-size: 0.7rem;
        }
        
        .agent-status-badge.active {
            background: #10b981;
            color: white;
        }
        
        .agent-status-badge.test {
            background: #6b7280;
            color: white;
        }
        
        /* Agent Editor Main Area */
        .agent-editor-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .agent-editor-header {
            padding: 1rem;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .agent-editor-title {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .agent-editor-title h2 {
            margin: 0;
        }
        
        .agent-editor-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .agent-editor-body {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        
        /* Blocks Sidebar */
        .blocks-sidebar {
            width: 250px;
            min-width: 250px;
            background: var(--bg-tertiary);
            border-left: 1px solid var(--border);
            padding: 1rem;
            overflow-y: auto;
        }
        
        .blocks-sidebar h4 {
            margin: 0 0 0.75rem 0;
            font-size: 0.85rem;
            color: var(--text-muted);
        }
        
        /* Collapsible section headers */
        .collapsible-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
            padding: 0.3rem 0;
            margin: 0.75rem 0 0.5rem 0;
        }
        
        .collapsible-header:hover {
            color: var(--primary);
        }
        
        .collapsible-header .toggle-icon {
            font-size: 0.7rem;
            transition: transform 0.2s;
        }
        
        .collapsible-header.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }
        
        .collapsible-content {
            transition: max-height 0.3s ease-out, opacity 0.2s;
            overflow: hidden;
        }
        
        .collapsible-content.collapsed {
            max-height: 0 !important;
            opacity: 0;
            margin: 0;
            padding: 0;
        }
        
        /* Site filter */
        .site-filter-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 0.3rem;
            padding: 0.4rem;
            border-bottom: 1px solid var(--border);
            background: var(--bg-tertiary);
        }
        
        .site-filter-bar select {
            flex: 1 1 auto;
            min-width: 70px;
            padding: 0.3rem 0.2rem;
            font-size: 0.75rem;
            border-radius: 4px;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            color: var(--text);
            cursor: pointer;
        }
        
        .site-filter-bar select:hover {
            border-color: var(--primary);
        }
        
        /* Custom date range filter */
        #customDateRange {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            padding: 0.4rem;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
        }
        
        #customDateRange label {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        
        #customDateRange input[type="date"] {
            background: var(--bg-secondary);
            color: var(--text);
            border: 1px solid var(--border);
            padding: 0.3rem;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
        }
        
        #customDateRange input[type="date"]:hover {
            border-color: var(--primary);
        }
        
        #customDateRange input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(0.8);
            cursor: pointer;
        }
        
        /* Agent filter */
        .agent-filter-bar {
            display: flex;
            gap: 0.5rem;
            padding: 0.5rem;
            border-bottom: 1px solid var(--border);
            background: var(--bg-tertiary);
        }
        
        .agent-filter-bar select {
            flex: 1;
            padding: 0.3rem;
            font-size: 0.8rem;
            border-radius: 4px;
            border: 1px solid var(--border);
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        
        /* Active toggle in agent card */
        .agent-active-toggle {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.7rem;
        }
        
        .agent-active-toggle input[type="checkbox"] {
            width: 14px;
            height: 14px;
            cursor: pointer;
        }
        
        .agent-list-card.inactive {
            opacity: 0.5;
            border-style: dashed;
        }
        
        .block-item {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.5rem 0.75rem;
            margin-bottom: 0.5rem;
            cursor: grab;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }
        
        .block-item:hover {
            border-color: var(--primary);
            background: rgba(59, 130, 246, 0.05);
        }
        
        .block-item:active {
            cursor: grabbing;
        }
        
        .shortcode-item {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 0.25rem 0.5rem;
            margin-bottom: 0.25rem;
            cursor: pointer;
            font-size: 0.75rem;
            font-family: monospace;
            color: var(--accent);
            transition: all 0.2s;
        }
        
        .shortcode-item:hover {
            background: var(--accent);
            color: white;
        }
        
        .shortcode-item.step-context {
            background: rgba(147, 51, 234, 0.1);
            border-color: #9333ea;
            color: #9333ea;
            display: flex;
            flex-direction: column;
            gap: 0.15rem;
        }
        
        .shortcode-item.step-context:hover {
            background: #9333ea;
            color: white;
        }
        
        .shortcode-hint {
            font-size: 0.6rem;
            opacity: 0.7;
        }
        
        .shortcode-category {
            margin-bottom: 0.5rem;
        }
        
        .shortcode-category-hint {
            font-size: 0.65rem;
            color: var(--text-secondary);
            margin: 0.25rem 0;
            opacity: 0.7;
        }
        
        .category-badge {
            font-size: 0.6rem;
            background: var(--accent);
            color: white;
            padding: 0.1rem 0.3rem;
            border-radius: 3px;
            margin-right: 0.25rem;
        }
        
        .per-page-category .shortcode-item {
            border-right: 3px solid #10b981;
        }
        
        .global-category .shortcode-item {
            border-right: 3px solid #3b82f6;
        }
        
        .custom-category .shortcode-item {
            border-right: 3px solid #f59e0b;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: nowrap;
            overflow: hidden;
        }
        
        .custom-category .shortcode-item span {
            flex: 1;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 0.65rem;
        }
        
        .shortcode-actions {
            display: flex;
            gap: 0.1rem;
            flex-shrink: 0;
            margin-right: 0.2rem;
        }
        
        .shortcode-actions button {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 0.1rem 0.15rem;
            font-size: 0.65rem;
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        
        .shortcode-actions button:hover {
            opacity: 1;
        }
        
        .step-context-shortcodes .shortcode-item {
            padding: 0.4rem 0.5rem;
        }
        
        .add-source-btn {
            width: 100%;
            padding: 0.4rem;
            background: transparent;
            border: 1px dashed var(--border);
            border-radius: 4px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.75rem;
        }
        
        .add-source-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }
        
        .step-file-item {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .step-file-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.3rem;
        }
        
        .step-file-num {
            background: var(--accent);
            color: white;
            padding: 0.1rem 0.4rem;
            border-radius: 3px;
            font-size: 0.7rem;
            font-weight: bold;
        }
        
        .step-file-actions {
            display: flex;
            gap: 0.2rem;
            flex-wrap: wrap;
            justify-content: flex-end;
        }
        
        .step-file-btn {
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 3px;
            padding: 0.15rem 0.3rem;
            font-size: 0.7rem;
            cursor: pointer;
            color: var(--text-secondary);
            flex-shrink: 0;
        }
        
        .step-file-btn:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        
        .step-file-btn.edit {
            color: #22c55e;
            border-color: #22c55e;
        }
        
        .step-file-btn.edit:hover {
            background: #22c55e;
            color: white;
        }
        
        .step-file-path {
            font-size: 0.65rem;
            color: var(--text-secondary);
            word-break: break-all;
            cursor: pointer;
        }
        
        .step-file-path:hover {
            color: var(--accent);
        }
        
        .step-file-shortcode {
            font-family: monospace;
            font-size: 0.7rem;
            color: #9333ea;
            margin-top: 0.2rem;
        }
        
        .step-file-note {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            text-align: center;
            padding: 0.5rem;
        }
        
        .copy-icon {
            opacity: 0.5;
            font-size: 0.75rem;
            margin-right: 0.3rem;
            transition: opacity 0.2s;
        }
        
        .shortcode-item:hover .copy-icon {
            opacity: 1;
        }
        
        /* Current Agent Header */
        .current-agent-header {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-bottom: 2px solid var(--accent);
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .current-agent-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .current-agent-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .current-agent-name {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--accent);
        }
        
        .current-agent-stats {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        /* Steps Editor */
        .steps-editor {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .steps-list {
            padding: 1rem;
            overflow-y: auto;
            flex: 1;
        }
        
        .step-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 1rem;
            overflow: hidden;
        }
        
        .step-card-header {
            background: var(--bg-tertiary);
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        
        .step-card-header:hover {
            background: rgba(59, 130, 246, 0.1);
        }
        
        .step-card-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
        }
        
        .step-number {
            background: var(--primary);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
        }
        
        .step-card-body {
            padding: 1rem;
            display: none; /* Hidden by default, JS opens first step */
        }
        
        .step-card.expanded .step-card-body {
            display: block;
        }
        
        .step-card-body.collapsed {
            display: none !important;
        }
        
        .step-card-body label {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-bottom: 0.25rem;
            display: block;
        }
        
        .step-card-body input[type="text"] {
            width: 100%;
            padding: 0.5rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }
        
        .step-card-body input[type="text"]:focus {
            border-color: var(--accent);
            outline: none;
        }
        
        .step-card-header input {
            color: var(--text-primary) !important;
        }
        
        .load-prompt-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 0.4rem 0.8rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-top: 0.5rem;
        }
        
        .load-prompt-btn:hover {
            background: var(--accent-hover);
        }
        
        .prompt-file-row {
            display: flex;
            gap: 0.5rem;
            align-items: flex-end;
        }
        
        .prompt-file-row > div:first-child {
            flex: 1;
        }
        
        .shortcode-tag {
            background: rgba(59, 130, 246, 0.2);
            color: var(--accent);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.8rem;
            border: 1px solid var(--accent);
        }
        
        .shortcodes-helper {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: var(--bg-tertiary);
            border-radius: 6px;
        }
        
        .helper-label {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }
        
        .shortcode-add-btn {
            background: transparent;
            border: 1px dashed var(--border);
            color: var(--text-secondary);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .shortcode-add-btn:hover {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }
        
        .prompt-main-editor {
            border: 2px solid var(--accent);
            border-radius: 8px;
            padding: 1rem;
            background: rgba(59, 130, 246, 0.05);
        }
        
        .prompt-editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .prompt-editor-header label {
            font-weight: 600;
            color: var(--accent);
            font-size: 1rem;
        }
        
        .prompt-editor-actions {
            display: flex;
            gap: 0.25rem;
            flex-wrap: wrap;
        }
        
        .prompt-editor-actions .btn {
            font-size: 0.7rem;
            padding: 0.25rem 0.5rem;
        }
        
        .prompt-editor-hint {
            margin-top: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.8rem;
            padding: 0.5rem;
            background: var(--bg-tertiary);
            border-radius: 4px;
        }
        
        .prompt-editor {
            min-height: 350px !important;
        }
        
        .prompt-buttons {
            display: flex;
            gap: 0.5rem;
        }
        
        .preview-btn {
            background: var(--success) !important;
        }
        
        .preview-btn:hover {
            background: #059669 !important;
        }
        
        /* Prompt Preview Modal */
        .prompt-preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }
        
        .prompt-preview-content {
            background: var(--bg-secondary);
            border-radius: 12px;
            width: 90%;
            max-width: 1200px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .prompt-preview-header {
            background: var(--bg-tertiary);
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }
        
        .prompt-preview-header h3 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .prompt-preview-body {
            padding: 1.5rem;
            overflow-y: auto;
            flex: 1;
        }
        
        .prompt-preview-text {
            background: var(--bg-tertiary);
            padding: 1rem;
            border-radius: 8px;
            white-space: pre-wrap;
            font-family: 'Consolas', monospace;
            font-size: 0.85rem;
            line-height: 1.6;
            max-height: 60vh;
            overflow-y: auto;
            direction: rtl;
            text-align: right;
        }
        
        .prompt-preview-info {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid var(--accent);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .prompt-preview-info h4 {
            margin: 0 0 0.5rem 0;
            color: var(--accent);
        }
        
        .prompt-section {
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 1rem;
            overflow: hidden;
        }
        
        .prompt-section-header {
            background: var(--bg-tertiary);
            padding: 0.75rem 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .prompt-section-header:hover {
            background: rgba(59, 130, 246, 0.1);
        }
        
        .prompt-section-body {
            padding: 1rem;
            border-top: 1px solid var(--border);
        }
        
        /* Prompt Editor */
        .prompt-editor {
            width: 100%;
            min-height: 200px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9rem;
            padding: 1rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg-primary);
            color: var(--text-primary);
            resize: vertical;
            direction: rtl;
        }
        
        .prompt-editor:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        /* Settings Panel */
        .agent-settings-panel {
            width: 300px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            padding: 1rem;
            overflow-y: auto;
        }
        
        .settings-section {
            margin-bottom: 1.5rem;
        }
        
        .settings-section h4 {
            margin: 0 0 0.75rem 0;
            font-size: 0.9rem;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border);
            padding-bottom: 0.5rem;
        }
        
        .setting-row {
            margin-bottom: 0.75rem;
        }
        
        .setting-row label {
            display: block;
            font-size: 0.85rem;
            margin-bottom: 0.25rem;
        }
        
        .setting-row select,
        .setting-row input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        
        /* Add Step Button */
        .add-step-btn {
            width: 100%;
            padding: 1rem;
            border: 2px dashed var(--border);
            border-radius: 8px;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .add-step-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: rgba(59, 130, 246, 0.05);
        }
        
        /* Data Sources Section */
        .data-sources-list {
            margin-top: 1rem;
        }
        
        .data-source-item {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.5rem 0.75rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .data-source-info {
            display: flex;
            flex-direction: column;
        }
        
        .data-source-name {
            font-weight: 500;
            font-size: 0.85rem;
        }
        
        .data-source-shortcode {
            font-size: 0.75rem;
            font-family: monospace;
            color: var(--accent);
        }
        
        /* ============ Reports Tab Styles ============ */
        
        .reports-section {
            display: none;
            position: fixed;
            top: 60px;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            z-index: 100;
            overflow-y: auto;
            padding: 2rem;
        }
        
        .reports-section.active {
            display: block;
        }
        
        .reports-container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .reports-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border);
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .reports-header h2 {
            margin: 0;
            font-size: 1.5rem;
            color: var(--text-primary);
        }
        
        .reports-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }
        
        .reports-tabs .report-type-tab {
            padding: 0.75rem 1.5rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.95rem;
        }
        
        .reports-tabs .report-type-tab:hover {
            border-color: var(--accent);
            color: var(--text-primary);
        }
        
        .reports-tabs .report-type-tab.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }
        
        .report-content {
            display: none;
        }
        
        .report-content.active {
            display: block;
        }
        
        .report-stats {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        
        .report-stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem 1.5rem;
            min-width: 150px;
        }
        
        .report-stat-card .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--accent);
        }
        
        .report-stat-card .stat-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .report-stat-card.success .stat-value {
            color: var(--success);
        }
        
        .report-stat-card.warning .stat-value {
            color: var(--warning);
        }
        
        .report-table-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }
        
        .report-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .report-table th,
        .report-table td {
            padding: 0.75rem 1rem;
            text-align: right;
            border-bottom: 1px solid var(--border);
        }
        
        .report-table th {
            background: var(--bg-tertiary);
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .report-table tr:hover {
            background: rgba(233, 69, 96, 0.1);
        }
        
        .report-table .page-name {
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .report-table .site-badge {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }
        
        .report-table .context-text {
            font-family: monospace;
            font-size: 0.85rem;
            background: var(--bg-primary);
            padding: 0.5rem;
            border-radius: 4px;
            max-width: 400px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .report-table .context-text .highlight {
            background: var(--warning);
            color: #000;
            padding: 0 2px;
            border-radius: 2px;
        }
        
        .report-table .action-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .report-table .btn-action {
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .report-table .btn-action.btn-upload {
            background: var(--success);
            color: white;
        }
        
        .report-table .btn-action.btn-remove {
            background: var(--accent);
            color: white;
        }
        
        .report-table .btn-action.btn-edit {
            background: var(--info);
            color: white;
        }
        
        .report-table .btn-action.btn-replace {
            background: var(--warning);
            color: #000;
        }
        
        .report-table .btn-action:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }
        
        .report-config {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .report-config label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .report-config input[type="text"] {
            width: 100%;
            padding: 0.75rem;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }
        
        .report-config input[type="text"]:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        .report-loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }
        
        .report-loading .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .anchor-text {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: var(--info);
        }
        
        .whatsapp-link {
            font-family: monospace;
            font-size: 0.8rem;
            color: var(--text-secondary);
            max-width: 250px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* ============ Duplicates Tab Styles ============ */
        
        .duplicates-section {
            display: none;
            position: fixed;
            top: 60px;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            z-index: 100;
            overflow-y: auto;
            padding: 2rem;
        }
        
        .duplicates-section.active {
            display: block;
        }
        
        .duplicates-container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .duplicates-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border);
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .duplicates-header h2 {
            margin: 0;
            font-size: 1.5rem;
            color: var(--text-primary);
        }
        
        .duplicates-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .duplicates-controls select {
            padding: 0.5rem;
            border-radius: 6px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-primary);
        }
        
        .duplicates-controls label {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        /* Statistics Dashboard */
        .duplicates-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .stat-card {
            background: var(--bg-secondary);
            padding: 1.5rem;
            border-radius: 12px;
            border: 2px solid var(--border);
            text-align: center;
            transition: all 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .stat-card.alert {
            border-color: #ef4444;
        }
        
        .stat-card.warning {
            border-color: #f59e0b;
        }
        
        .stat-card.info {
            border-color: #3b82f6;
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--accent);
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        /* Severity Breakdown */
        .severity-breakdown {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            flex-wrap: wrap;
        }
        
        .severity-item {
            flex: 1;
            min-width: 150px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 6px;
        }
        
        .severity-item.critical {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid #ef4444;
        }
        
        .severity-item.high {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid #f59e0b;
        }
        
        .severity-item.medium {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid #10b981;
        }
        
        .severity-badge {
            font-weight: 600;
        }
        
        .severity-count {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        /* Filters */
        .duplicates-filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .duplicates-filters input[type="text"] {
            flex: 1;
            min-width: 250px;
            padding: 0.5rem;
            border-radius: 6px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-primary);
        }
        
        .duplicates-filters select {
            padding: 0.5rem;
            border-radius: 6px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-primary);
        }
        
        /* Bulk Actions Bar */
        .bulk-actions-bar {
            display: flex;
            gap: 1rem;
            align-items: center;
            padding: 1rem;
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
            border-radius: 8px;
            margin-bottom: 1.5rem;
            border: 2px solid var(--accent);
            flex-wrap: wrap;
        }
        
        .bulk-actions-bar label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }
        
        #selected-count {
            margin-left: auto;
            font-weight: bold;
            color: var(--accent);
        }
        
        /* Selected Directories Bar */
        .selected-directories-bar {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
            border-radius: 8px;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border);
            flex-wrap: wrap;
        }
        
        .selected-directories-bar > span {
            font-weight: 600;
            color: var(--text-secondary);
        }
        
        #selected-directories-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            flex: 1;
        }
        
        .directory-badge {
            padding: 0.4rem 0.8rem;
            background: var(--accent);
            color: white;
            border-radius: 16px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        /* Duplicate Group */
        .duplicate-group {
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: all 0.3s;
        }
        
        .duplicate-group.selected {
            border-color: var(--accent);
            background: rgba(233, 69, 96, 0.05);
        }
        
        .duplicate-group:hover {
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        
        .duplicate-group-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        
        .group-checkbox {
            width: 24px;
            height: 24px;
            cursor: pointer;
        }
        
        .duplicate-header-info {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            flex: 1;
            flex-wrap: wrap;
        }
        
        .duplicate-header-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .similarity-badge {
            padding: 0.4rem 1rem;
            border-radius: 20px;
            color: white;
            font-weight: bold;
            font-size: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .seo-impact-badge {
            padding: 0.4rem 1rem;
            border-radius: 20px;
            color: white;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: help;
        }
        
        .pages-count {
            padding: 0.25rem 0.75rem;
            background: var(--bg-secondary);
            border-radius: 12px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        /* Page Cards */
        .duplicate-pages {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .page-card {
            background: var(--bg-secondary);
            padding: 1rem;
            border-radius: 8px;
            border-right: 4px solid var(--accent);
        }
        
        .page-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        
        .page-card-header strong {
            font-size: 1.1rem;
            color: var(--text-primary);
        }
        
        .page-badge {
            background: var(--accent);
            color: white;
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.8rem;
        }
        
        .page-meta {
            margin-bottom: 0.75rem;
        }
        
        .page-title {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }
        
        .page-description {
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        
        .page-path {
            display: block;
            font-size: 0.75rem;
            color: var(--text-muted);
            font-family: monospace;
            margin-bottom: 0.75rem;
            word-break: break-all;
        }
        
        .page-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn-xs {
            padding: 0.3rem 0.6rem;
            font-size: 0.8rem;
        }
        
        .btn-sm {
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
        }
        
        /* Group Details */
        .group-details {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 2px solid var(--border);
        }
        
        /* Duplicate Snippets */
        .duplicate-snippets {
            background: rgba(0,0,0,0.3);
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .duplicate-snippets h4 {
            margin: 0 0 1rem 0;
            color: var(--accent);
        }
        
        .duplicate-snippet-item {
            display: flex;
            gap: 0.75rem;
            padding: 1rem;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            margin-bottom: 0.75rem;
            border: 2px solid transparent;
            transition: all 0.2s;
            align-items: flex-start;
        }
        
        .duplicate-snippet-item:has(input:checked) {
            border-color: var(--accent);
            background: rgba(233, 69, 96, 0.1);
        }
        
        .snippet-checkbox {
            width: 22px;
            height: 22px;
            cursor: pointer;
            flex-shrink: 0;
            margin-top: 0.5rem;
        }
        
        .snippet-preview {
            flex: 1;
            min-width: 0;
        }
        
        .snippet-header {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
        }
        
        .snippet-header strong {
            color: var(--accent);
        }
        
        .snippet-length {
            padding: 0.2rem 0.5rem;
            background: var(--bg-tertiary);
            border-radius: 12px;
            font-size: 0.75rem;
        }
        
        .snippet-pages-count {
            padding: 0.2rem 0.5rem;
            background: #f59e0b;
            color: black;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .snippet-preview pre {
            background: rgba(0,0,0,0.4);
            padding: 0.75rem;
            border-radius: 6px;
            font-size: 0.85rem;
            margin: 0.5rem 0;
            white-space: pre-wrap;
            border-left: 3px solid #f59e0b;
            overflow-x: auto;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .snippets-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }
        
        /* Headings Duplicates */
        .headings-duplicates {
            background: rgba(96, 165, 250, 0.1);
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid #3b82f6;
        }
        
        .headings-duplicates h4 {
            color: #60a5fa;
            margin: 0 0 1rem 0;
        }
        
        .heading-level-group {
            margin-bottom: 1rem;
        }
        
        .heading-level-group strong {
            color: #60a5fa;
            display: block;
            margin-bottom: 0.5rem;
        }
        
        .heading-level-group ul {
            list-style: none;
            padding-right: 1rem;
            margin: 0;
        }
        
        .heading-level-group li {
            padding: 0.5rem;
            background: rgba(0,0,0,0.2);
            border-radius: 4px;
            margin-bottom: 0.25rem;
        }
        
        /* No Duplicates */
        .no-duplicates {
            text-align: center;
            padding: 4rem 2rem;
            font-size: 1.8rem;
            color: #10b981;
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 2px dashed #10b981;
        }
        
        .no-snippets {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
            font-style: italic;
        }
        
        /* Empty State */
        .duplicates-empty-state {
            text-align: center;
            padding: 4rem 2rem;
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 2px dashed var(--border);
        }
        
        .duplicates-empty-state h3 {
            margin: 1rem 0 0.5rem 0;
            color: var(--text-primary);
        }
        
        .duplicates-empty-state p {
            color: var(--text-secondary);
        }
        
        /* Loading */
        .duplicates-loading {
            text-align: center;
            padding: 4rem 2rem;
        }
        
        .duplicates-loading .loading-spinner {
            font-size: 4rem;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .loading-spinner {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
        }
        
        /* Heatmap */
        .heatmap-modal {
            max-width: 1200px !important;
        }
        
        .heatmap-wrapper {
            overflow-x: auto;
        }
        
        .heatmap-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .heatmap-table th,
        .heatmap-table td {
            padding: 0.5rem;
            text-align: center;
            font-size: 0.75rem;
            border: 1px solid var(--border);
            min-width: 40px;
        }
        
        .heatmap-table th {
            background: var(--bg-tertiary);
            font-weight: 600;
        }
        
        .heatmap-table td {
            color: white;
            font-weight: 600;
        }
        
        /* Diff Viewer */
        .diff-viewer-modal {
            max-width: 1400px !important;
        }
        
        .diff-viewer {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            max-height: 70vh;
        }
        
        .diff-column {
            overflow-y: auto;
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
        }
        
        .diff-column h3 {
            position: sticky;
            top: 0;
            background: var(--bg-secondary);
            padding: 0.75rem;
            border-radius: 6px;
            margin: 0 0 1rem 0;
            z-index: 10;
        }
        
        .diff-column pre {
            white-space: pre-wrap;
            word-break: break-word;
            font-size: 0.85rem;
            line-height: 1.6;
        }
        
        .diff-match {
            background: rgba(239, 68, 68, 0.3);
            border-left: 3px solid #ef4444;
            padding: 0.25rem 0.5rem;
            display: inline;
        }
        
        /* Settings Modal */
        .duplicate-settings-modal {
            max-width: 900px !important;
        }
        
        .settings-section {
            margin-bottom: 2rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid var(--border);
        }
        
        .settings-section:last-child {
            border-bottom: none;
        }
        
        .settings-section h3 {
            margin: 0 0 1rem 0;
            color: var(--accent);
        }
        
        .settings-hint {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: rgba(96, 165, 250, 0.1);
            border-radius: 6px;
            border-right: 3px solid #3b82f6;
        }
        
        .directories-list {
            display: grid;
            gap: 0.75rem;
            max-height: 300px;
            overflow-y: auto;
            padding: 0.5rem;
        }
        
        .directory-item {
            background: var(--bg-tertiary);
            border-radius: 8px;
            border: 2px solid var(--border);
            transition: all 0.2s;
        }
        
        .directory-item:hover {
            border-color: var(--accent);
        }
        
        .directory-checkbox-label {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            cursor: pointer;
        }
        
        .directory-checkbox {
            width: 24px;
            height: 24px;
            cursor: pointer;
            flex-shrink: 0;
        }
        
        .directory-info {
            flex: 1;
        }
        
        .directory-info strong {
            display: block;
            margin-bottom: 0.25rem;
            font-size: 1.05rem;
        }
        
        .directory-info small {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }
        
        .settings-checkbox {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .settings-checkbox:hover {
            background: var(--bg-secondary);
        }
        
        .settings-checkbox input {
            width: 20px;
            height: 20px;
            cursor: pointer;
            flex-shrink: 0;
            margin-top: 0.1rem;
        }
        
        .settings-checkbox span {
            flex: 1;
        }
        
        .settings-checkbox small {
            display: block;
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-top: 0.25rem;
        }
        
        /* Ignore Manager Modal */
        .ignore-manager-modal {
            max-width: 1000px !important;
        }
        
        .ignore-manager-content {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }
        
        .add-pattern-section {
            background: var(--bg-tertiary);
            padding: 1.5rem;
            border-radius: 8px;
            border: 2px dashed var(--border);
        }
        
        .add-pattern-section h3 {
            margin: 0 0 1rem 0;
            color: #10b981;
        }
        
        .pattern-input-group {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .pattern-input-group textarea {
            width: 100%;
            padding: 0.75rem;
            border-radius: 6px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            font-family: inherit;
            resize: vertical;
        }
        
        .pattern-input-group input[type="text"] {
            padding: 0.5rem;
            border-radius: 6px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-primary);
        }
        
        .pattern-options {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
        }
        
        .pattern-options label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }
        
        .pattern-options input[type="radio"] {
            cursor: pointer;
        }
        
        .current-patterns-section {
            background: var(--bg-secondary);
            padding: 1.5rem;
            border-radius: 8px;
        }
        
        .patterns-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .patterns-header h3 {
            margin: 0;
        }
        
        .patterns-count {
            padding: 0.3rem 0.8rem;
            background: var(--accent);
            color: white;
            border-radius: 16px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .patterns-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .pattern-item {
            background: var(--bg-tertiary);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid var(--border);
            transition: all 0.2s;
        }
        
        .pattern-item:hover {
            border-color: var(--accent);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .pattern-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .pattern-type {
            padding: 0.2rem 0.6rem;
            background: #3b82f6;
            color: white;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .btn-delete {
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .btn-delete:hover {
            background: rgba(239, 68, 68, 0.2);
        }
        
        .pattern-text {
            padding: 0.75rem;
            background: rgba(0,0,0,0.3);
            border-radius: 6px;
            font-family: monospace;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            white-space: pre-wrap;
            word-break: break-word;
            border-right: 3px solid #f59e0b;
        }
        
        .pattern-description {
            font-size: 0.85rem;
            color: var(--text-secondary);
            padding: 0.5rem;
            background: rgba(96, 165, 250, 0.1);
            border-radius: 4px;
            margin-bottom: 0.5rem;
        }
        
        .pattern-meta {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-align: left;
        }
        
        .no-patterns {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
            font-size: 1.1rem;
        }
        
        .templates-section {
            background: var(--bg-tertiary);
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        
        .templates-section h3 {
            margin: 0 0 0.5rem 0;
            color: #3b82f6;
        }
        
        .templates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 0.75rem;
            margin-top: 1rem;
        }
        
        .template-btn {
            padding: 0.75rem;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
            text-align: right;
        }
        
        .template-btn:hover {
            border-color: var(--accent);
            background: var(--bg-primary);
            transform: translateY(-2px);
        }
        
        /* Duplicate Fix Modal */
        .duplicate-fix-modal {
            max-width: 1000px !important;
        }
        
        .duplicate-fix-modal textarea {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            border-radius: 8px;
            padding: 1rem;
        }
        
        /* Snippet Page Links */
        .snippet-page-links {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px dashed var(--border);
        }
        
        .snippet-links-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 600;
        }
        
        .btn-link {
            background: rgba(59, 130, 246, 0.2) !important;
            border: 1px solid #3b82f6 !important;
            color: #60a5fa !important;
            transition: all 0.2s;
        }
        
        .btn-link:hover {
            background: rgba(59, 130, 246, 0.4) !important;
            transform: translateY(-1px);
        }
        
        /* Snippet Location Modal - White Background Theme */
        .snippet-location-modal {
            max-width: 1000px !important;
            background: #ffffff !important;
            color: #1a1a1a !important;
        }
        
        .snippet-location-modal .modal-header {
            background: #f8fafc !important;
            border-bottom: 1px solid #e2e8f0 !important;
        }
        
        .snippet-location-modal .modal-header h2 {
            color: #1e293b !important;
        }
        
        .snippet-location-modal .modal-body {
            background: #ffffff !important;
        }
        
        .snippet-location-modal .modal-footer {
            background: #f8fafc !important;
            border-top: 1px solid #e2e8f0 !important;
        }
        
        .snippet-location-info {
            padding: 0.75rem;
            background: #f1f5f9;
            border-radius: 6px;
            margin-bottom: 1rem;
            color: #334155;
        }
        
        .snippet-location-info strong {
            color: #2563eb;
        }
        
        .snippet-location-search {
            margin-bottom: 1rem;
        }
        
        .snippet-highlight-preview {
            padding: 0.75rem;
            background: #fef2f2;
            border: 1px solid #ef4444;
            border-radius: 6px;
            font-family: monospace;
            font-size: 0.85rem;
            margin-top: 0.5rem;
            color: #991b1b;
        }
        
        .snippet-location-content {
            background: #f8fafc;
            border-radius: 8px;
            padding: 1rem;
            max-height: 50vh;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
        }
        
        .snippet-context {
            line-height: 1.8;
            font-size: 0.95rem;
            color: #334155;
        }
        
        .context-ellipsis {
            color: #94a3b8;
            font-style: italic;
        }
        
        .context-before,
        .context-after {
            color: #475569;
        }
        
        .snippet-highlight {
            background: #fef2f2;
            border: 2px solid #ef4444;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-weight: 600;
            color: #991b1b;
            display: inline;
        }
        
        .full-content-toggle {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e2e8f0;
        }
        
        .full-content {
            margin-top: 1rem;
            background: #f1f5f9;
            border-radius: 6px;
            padding: 1rem;
            border: 1px solid #e2e8f0;
        }
        
        .full-content pre {
            white-space: pre-wrap;
            word-break: break-word;
            font-size: 0.85rem;
            line-height: 1.6;
            margin: 0;
            max-height: 400px;
            overflow-y: auto;
            color: #334155;
        }
        
        .snippet-not-found {
            padding: 1rem;
            background: #fffbeb;
            border: 1px solid #f59e0b;
            border-radius: 6px;
            color: #92400e;
            margin-bottom: 1rem;
        }
        
        /* Inline Editor in Snippet Modal */
        .snippet-inline-editor {
            margin-top: 1rem;
            padding: 1rem;
            background: #ffffff;
            border: 2px solid #3b82f6;
            border-radius: 8px;
        }
        
        .snippet-inline-editor textarea {
            width: 100%;
            min-height: 150px;
            padding: 0.75rem;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.95rem;
            line-height: 1.6;
            resize: vertical;
            color: #1e293b;
            background: #ffffff;
        }
        
        .snippet-inline-editor textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        
        .snippet-editor-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
            justify-content: flex-end;
        }
        
        .snippet-location-modal .btn-secondary {
            background: #e2e8f0 !important;
            color: #475569 !important;
            border: 1px solid #cbd5e1 !important;
        }
        
        .snippet-location-modal .btn-secondary:hover {
            background: #cbd5e1 !important;
        }
        
        .snippet-location-modal .btn-primary {
            background: #3b82f6 !important;
            color: white !important;
        }
        
        .snippet-location-modal .btn-success {
            background: #22c55e !important;
            color: white !important;
        }
        
    </style>
    <!-- TinyMCE WYSIWYG Editor (jsDelivr CDN - no API key required, includes all themes) -->
    <script src="https://cdn.jsdelivr.net/npm/tinymce@6.8.2/tinymce.min.js" referrerpolicy="origin"></script>
</head>
<body>
    <!-- Header -->
    <header class="header" dir="rtl" style="text-align: right;">
        <h1>🚀 מערכת ניהול אתרים - After You</h1>
        <div class="header-controls">
            <div class="tabs">
                <button class="tab" data-tab="reports">📊 דוחות</button>
                <button class="tab" data-tab="archive">📦 ארכיון</button>
                <button class="tab" data-tab="duplicates">📋 כפילויות</button>
                <button class="tab" data-tab="agents">🤖 סוכנים</button>
                <button class="tab active" data-tab="edit">📁 עמודים</button>
            </div>
            <select id="modeSelect">
                <option value="claude">מצב: Claude Code (אוטומטי)</option>
                <option value="cursor">מצב: Cursor (ידני)</option>
            </select>
            <button class="btn btn-secondary" onclick="openSettings()">⚙️ הגדרות</button>
            <button class="btn btn-secondary" onclick="restartServer()" title="אתחול שרת">🔄</button>
            <button id="stopClaudeBtn" class="btn btn-danger" onclick="stopClaude()" style="display: none;" title="עצור את Claude">🛑 עצור</button>
            <div class="git-status-container">
                <span id="gitStatusBadge" class="git-badge synced" title="Git Status">
                    <span class="git-icon">✓</span>
                    <span class="git-text">בודק...</span>
                </span>
                <button id="gitSyncBtn" class="btn btn-git btn-sync" onclick="gitSync()" title="סנכרן אוטומטי">
                    🔄 סנכרן
                </button>
                <button id="gitPullBtn" class="btn btn-git btn-small" onclick="gitPull()" disabled title="משוך מGit">
                    ↓
                </button>
                <button id="gitPushBtn" class="btn btn-git btn-small" onclick="gitPush()" disabled title="העלה לGit">
                    ↑
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main">
        <!-- Sidebar - Page List -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>📁 עמודים</h2>
                <div style="display: flex; gap: 0.3rem;">
                    <button class="btn btn-small" style="background: #22c55e; color: white; font-size: 11px;" onclick="uploadToWordPress()" title="העלה לוורדפרס">📤 העלה ל-WP</button>
                    <button class="btn btn-small btn-secondary" onclick="loadPages()" title="רענן">🔄</button>
                    <button class="btn btn-small btn-secondary" onclick="clearAllStatus()" title="נקה סטטוסים">🧹</button>
                    <button class="btn btn-small btn-secondary" onclick="toggleBatchSelectionMode()" title="בחירה מרובה">☑️</button>
                </div>
            </div>
            <div class="site-filter-bar">
                <select id="siteFilter" onchange="renderPageList()">
                    <!-- Populated dynamically by populateSiteFilter() -->
                    <option value="all">🌐 כל האתרים</option>
                </select>
                <select id="sortFilter" onchange="renderPageList()">
                    <option value="last_upload" selected>📅 עודכן לאחרונה</option>
                    <option value="name">🔤 לפי שם</option>
                    <option value="words_asc">📝 מילים ↑</option>
                    <option value="words_desc">📝 מילים ↓</option>
                </select>
                <select id="agentCompletionFilter" onchange="renderPageList()">
                    <!-- Populated dynamically by populateAgentCompletionFilter() -->
                    <option value="all">🎯 כל העמודים</option>
                </select>
                <select id="specialFilter" onchange="renderPageList()">
                    <option value="all">🌟 הכל</option>
                    <option value="special">⭐ מיוחדים</option>
                    <option value="regular">📄 רגילים</option>
                </select>
                <select id="uploadDateFilter" onchange="renderPageList()">
                    <option value="all">📅 כל התאריכים</option>
                    <option value="not_uploaded">❌ לא עלו לוורדפרס</option>
                    <option value="today">🕐 היום</option>
                    <option value="this_week">📆 השבוע</option>
                    <option value="this_month">📊 החודש</option>
                    <option value="custom">🗓️ טווח מותאם אישית</option>
                </select>
            </div>
            <div id="customDateRange" style="display: none; margin-top: 0.5rem;">
                <label>מתאריך: <input type="date" id="uploadDateFrom" onchange="renderPageList()"></label>
                <label>עד תאריך: <input type="date" id="uploadDateTo" onchange="renderPageList()"></label>
            </div>
            <div id="pageFilterCount" style="padding: 5px 10px; font-size: 12px; color: #888; text-align: center; border-bottom: 1px solid #333;">
                <!-- Populated by renderPageList() -->
            </div>
            <div class="batch-selection-bar" id="batchSelectionBar" style="display:none;">
                <span class="batch-count" id="batchCount">0 עמודים נבחרו</span>
                <button class="btn btn-small btn-secondary" onclick="selectAllPages()">בחר הכל</button>
                <button class="btn btn-small btn-secondary" onclick="clearPageSelection()">נקה</button>
            </div>
            <div class="page-list" id="pageList">
                <!-- Pages loaded dynamically -->
            </div>
            
        </aside>

        <!-- Content Area -->
        <section class="content">
            <div class="content-header">
                <div class="agent-selector">
                    <label>סוכן:</label>
                    <select id="agentSelect">
                        <!-- Agents loaded dynamically -->
                    </select>
                    <button class="btn btn-small btn-secondary" onclick="addAgentToQueue()" title="הוסף סוכן לתור">➕</button>
                </div>
                <div class="agent-queue" id="agentQueue" style="display:none;">
                    <label>תור:</label>
                    <div class="queue-tags" id="queueTags">
                        <!-- Agent tags shown here -->
                    </div>
                </div>
                <div class="workflow-buttons" id="workflowButtons">
                    <!-- Buttons shown based on agent type -->
                </div>
            </div>

            <div class="panels">
                <!-- Report Panel -->
                <div class="panel" id="reportPanel">
                    <div class="panel-header">
                        <span>📋 דוח</span>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <button id="viewPromptBtn" class="btn-view-prompt" onclick="viewCurrentPrompt()" style="display:none;" title="צפה בפרומפט שנשלח לקלוד">📝 פרומפט</button>
                            <button id="deleteReportBtn" class="btn btn-small btn-danger" onclick="deleteCurrentReport()" style="display:none;" title="מחק דוח">🗑️</button>
                            <span id="statusIndicator" class="status-badge status-pending">ממתין</span>
                            <select id="reportSelect" style="display:none;">
                                <!-- Reports loaded dynamically -->
                            </select>
                        </div>
                    </div>
                    <div class="panel-content report" id="reportContent">
                        <div class="empty-state">
                            <div class="empty-state-icon">📋</div>
                            <p>בחר עמוד והרץ סוכן דוח</p>
                        </div>
                    </div>
                </div>

                <!-- Resize Handle -->
                <div class="resize-handle" id="resizeHandle" title="גרור לשינוי גודל"></div>

                <!-- Preview Panel -->
                <div class="panel" id="previewPanel">
                    <div class="panel-header">
                        <span>👁️ תצוגה מקדימה</span>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <!-- Preview/Edit mode tabs -->
                            <div class="preview-tabs" style="display: flex; gap: 2px; margin-right: 10px;">
                                <button class="preview-tab active" id="previewTabCurrent" onclick="switchPreviewTab('current')" style="padding: 3px 8px; font-size: 11px; border: 1px solid #444; background: #3b82f6; color: white; border-radius: 4px 0 0 0; cursor: pointer;">📄 נוכחי</button>
                                <button class="preview-tab" id="previewTabBackup" onclick="switchPreviewTab('backup')" style="padding: 3px 8px; font-size: 11px; border: 1px solid #444; background: #333; color: #888; cursor: pointer;">💾 גיבוי</button>
                                <button class="preview-tab" id="previewTabEdit" onclick="switchPreviewTab('edit')" style="padding: 3px 8px; font-size: 11px; border: 1px solid #444; background: #333; color: #888; border-radius: 0 4px 4px 0; cursor: pointer;">✏️ עריכה</button>
                            </div>
                            <button id="viewLocalBtn" class="btn btn-small" onclick="copyLocalPath()" title="העתק נתיב מקומי" style="display: none;">
                                🖥️ מקומי
                            </button>
                            <a href="#" id="viewOnSiteBtn" class="btn btn-small" target="_blank" title="צפה באתר" style="display: none; text-decoration: none; color: #fff !important;">
                                🔗 צפה באתר
                            </a>
                            <button class="btn btn-small" onclick="loadPreview()" title="רענן תצוגה">
                                🔄
                            </button>
                            <button class="btn btn-small btn-success" id="uploadBtn" onclick="uploadToWordPress()">
                                🌐 העלה ל-WordPress
                            </button>
                            <button class="btn btn-small btn-success" id="editorSaveBtn" onclick="saveWysiwygEditor()" style="display: none;">
                                💾 שמור
                            </button>
                        </div>
                    </div>
                    <!-- SEO Metadata Display -->
                    <div class="seo-meta-bar" id="seoMetaBar" style="display: none;">
                        <div class="meta-item title-item">
                            <span class="meta-label">Title:</span>
                            <span class="meta-value" id="previewTitle">-</span>
                            <span class="meta-count" id="previewTitleCount"></span>
                        </div>
                        <div class="meta-item desc-item">
                            <span class="meta-label">Description:</span>
                            <span class="meta-value" id="previewDesc">-</span>
                            <span class="meta-count" id="previewDescCount"></span>
                        </div>
                        <div class="meta-warnings" id="metaWarnings"></div>
                    </div>
                    <div class="panel-content" id="previewContent">
                        <div class="empty-state">
                            <div class="empty-state-icon">👁️</div>
                            <p>בחר עמוד לתצוגה מקדימה</p>
                        </div>
                    </div>
                    <!-- WYSIWYG Editor Container (for regular pages) -->
                    <div id="editorContainer" style="display: none; height: 100%; padding: 0;">
                        <textarea id="tinymceEditor"></textarea>
                    </div>
                    <!-- Special Page Notice (for is_special pages) -->
                    <div id="specialPageNotice" style="display: none;">
                        <div style="font-size: 3rem;">⭐</div>
                        <div style="font-size: 1.2rem; font-weight: bold;">עמוד מיוחד</div>
                        <div style="text-align: center;">לעריכה מתקדמת השתמש בכפתור<br><strong>"השוואת תוכן"</strong> למעלה</div>
                        <button class="btn btn-primary" onclick="openCompareModal()" style="margin-top: 1rem;">📊 פתח השוואת תוכן</button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Agent Builder Section -->
    <section class="agents-section" id="agentsSection">
        <div class="agent-builder-container">
            <!-- Agent List Sidebar -->
            <aside class="agent-list-sidebar">
                <div class="agent-list-header">
                    <h3>📋 סוכנים</h3>
                    <button class="btn btn-small btn-primary" onclick="openAddAgentBuilderModal()">➕ חדש</button>
                </div>
                <div class="agent-filter-bar">
                    <select id="agentStatusFilter" onchange="filterAgentList()">
                        <option value="all">📋 כל הסוכנים</option>
                        <option value="active">✅ פעילים בלבד</option>
                        <option value="inactive">⏸️ לא פעילים</option>
                    </select>
                </div>
                <div class="agent-list-items" id="agentBuilderList">
                    <!-- Agents loaded dynamically -->
                </div>
            </aside>

            <!-- Agent Editor Main Area -->
            <div class="agent-editor-main">
                <div class="agent-editor-header">
                    <div class="agent-editor-title">
                        <h2 id="currentAgentName">בחר סוכן לעריכה</h2>
                        <span class="agent-type-badge update" id="currentAgentType" style="display:none;"></span>
                    </div>
                    <div class="agent-editor-actions">
                        <button class="btn btn-secondary" onclick="duplicateAgent()" id="duplicateAgentBtn" style="display:none;">📋 שכפל</button>
                        <button class="btn btn-danger" onclick="deleteCurrentAgent()" id="deleteAgentBtn" style="display:none;">🗑️ מחק</button>
                        <button class="btn btn-primary" onclick="saveCurrentAgent()" id="saveAgentBtn" style="display:none;">💾 שמור</button>
                    </div>
                </div>

                <div class="agent-editor-body">
                    <!-- Blocks Sidebar -->
                    <aside class="blocks-sidebar">
                        <!-- בלוקים -->
                        <h4 class="collapsible-header" onclick="toggleSection(this)">
                            📦 בלוקים <span class="toggle-icon">▼</span>
                        </h4>
                        <div class="collapsible-content">
                            <div class="block-item" draggable="true" data-block="step">📋 שלב חדש</div>
                            <div class="block-item" draggable="true" data-block="condition">🔀 תנאי</div>
                        </div>
                        
                        <!-- קבצי הוראות לשלבים -->
                        <h4 class="collapsible-header" onclick="toggleSection(this)">
                            🎯 קבצי הוראות <span class="toggle-icon">▼</span>
                        </h4>
                        <div class="collapsible-content">
                            <div class="shortcode-category step-files-list" id="stepFilesList">
                                <div class="step-file-note">בחר סוכן לראות את הקבצים</div>
                            </div>
                        </div>
                        
                        <!-- נתיבים דינאמיים -->
                        <h4 class="collapsible-header" onclick="toggleSection(this)">
                            📍 נתיבים דינאמיים <span class="toggle-icon">▼</span>
                        </h4>
                        <div class="collapsible-content">
                            <div class="shortcode-category step-context-shortcodes">
                                <div class="shortcode-item step-context" onclick="insertShortcode('PAGE_HTML_PATH')" title="נתיב לקובץ HTML">{{PAGE_HTML_PATH}}</div>
                                <div class="shortcode-item step-context" onclick="insertShortcode('OUTPUT_PATH')" title="נתיב לפלט">{{OUTPUT_PATH}} <span class="shortcode-hint">🔄</span></div>
                            </div>
                        </div>
                        
                        <!-- דינמי - פר עמוד -->
                        <h4 class="collapsible-header" onclick="toggleSection(this)">
                            📄 פר עמוד <span class="toggle-icon">▼</span>
                        </h4>
                        <div class="collapsible-content">
                            <div class="shortcode-category per-page-category">
                                <div class="shortcode-item" onclick="copyShortcode('PAGE_HTML')" ondblclick="insertShortcode('PAGE_HTML')" title="תוכן HTML">📄 {{PAGE_HTML}}</div>
                                <div class="shortcode-item" onclick="copyShortcode('PAGE_PATH')" ondblclick="insertShortcode('PAGE_PATH')" title="נתיב">📄 {{PAGE_PATH}}</div>
                                <div class="shortcode-item" onclick="copyShortcode('PAGE_KEYWORD')" ondblclick="insertShortcode('PAGE_KEYWORD')" title="מילת מפתח">📄 {{PAGE_KEYWORD}}</div>
                                <div class="shortcode-item" onclick="copyShortcode('PAGE_URL')" ondblclick="insertShortcode('PAGE_URL')" title="כתובת">📄 {{PAGE_URL}}</div>
                                <div class="shortcode-item" onclick="copyShortcode('PAGE_WORD_COUNT')" ondblclick="insertShortcode('PAGE_WORD_COUNT')" title="מספר מילים בעמוד">📝 {{PAGE_WORD_COUNT}}</div>
                                <div class="shortcode-item" onclick="copyShortcode('KEYWORDS_AUTOCOMPLETE')" ondblclick="insertShortcode('KEYWORDS_AUTOCOMPLETE')" title="מילות מפתח">📄 {{KEYWORDS_AUTOCOMPLETE}}</div>
                                <div class="shortcode-item" onclick="copyShortcode('KEYWORDS_RELATED')" ondblclick="insertShortcode('KEYWORDS_RELATED')" title="חיפושים קשורים">📄 {{KEYWORDS_RELATED}}</div>
                                <div class="shortcode-item" onclick="copyShortcode('SERP_ORGANIC')" ondblclick="insertShortcode('SERP_ORGANIC')" title="תוצאות">📄 {{SERP_ORGANIC}}</div>
                                <div class="shortcode-item" onclick="copyShortcode('SERP_AI_OVERVIEW')" ondblclick="insertShortcode('SERP_AI_OVERVIEW')" title="AI">📄 {{SERP_AI_OVERVIEW}}</div>
                                <div class="shortcode-item" onclick="copyShortcode('DENSITY_ANALYSIS')" ondblclick="insertShortcode('DENSITY_ANALYSIS')" title="ניתוח צפיפות מילות מפתח">📊 {{DENSITY_ANALYSIS}}</div>
                            </div>
                        </div>
                        
                        <!-- גלובלי - קבועים -->
                        <h4 class="collapsible-header" onclick="toggleSection(this)">
                            🌐 גלובלי <span class="toggle-icon">▼</span>
                        </h4>
                        <div class="collapsible-content">
                            <div class="shortcode-category global-category">
                                <div class="shortcode-item" onclick="copyShortcode('TODAY_DATE')" ondblclick="insertShortcode('TODAY_DATE')" title="תאריך">🌐 {{TODAY_DATE}}</div>
                                <div class="shortcode-item" onclick="copyShortcode('CURRENT_MONTH')" ondblclick="insertShortcode('CURRENT_MONTH')" title="החודש הנוכחי בעברית">🗓️ {{CURRENT_MONTH}}</div>
                                <div class="shortcode-item" onclick="copyShortcode('BOI_INTEREST_RATE')" ondblclick="insertShortcode('BOI_INTEREST_RATE')" title="ריבית בנק ישראל">🏦 {{BOI_INTEREST_RATE}}</div>
                            </div>
                            <div class="global-value-editor" style="margin-top: 0.5rem; padding: 0.5rem; background: var(--bg-tertiary); border-radius: 4px;">
                                <div style="display: flex; gap: 0.3rem; align-items: center; flex-wrap: nowrap; min-width: 0;">
                                    <span style="font-size: 0.75rem;">🏦</span>
                                    <input type="text" id="boiInterestInput" style="width: 60px; min-width: 50px; padding: 0.25rem 0.4rem; font-size: 0.8rem; border-radius: 4px; border: 1px solid var(--border); background: var(--bg-primary); color: var(--text); text-align: center;" placeholder="4.5%">
                                    <button class="btn-mini" onclick="saveGlobalValue('BOI_INTEREST_RATE', document.getElementById('boiInterestInput').value)" title="שמור ריבית">💾</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- דוחות שלבים -->
                        <h4 class="collapsible-header" onclick="toggleSection(this)">
                            📊 דוחות שלבים <span class="toggle-icon">▼</span>
                        </h4>
                        <div class="collapsible-content">
                            <div class="shortcode-category" id="stepReportsList">
                                <div class="shortcode-item" onclick="copyShortcode('STEP1_REPORT')" ondblclick="insertShortcode('STEP1_REPORT')" title="דוח שלב 1">{{STEP1_REPORT}}</div>
                                <div class="shortcode-item" onclick="copyShortcode('STEP1_REPORT_PATH')" ondblclick="insertShortcode('STEP1_REPORT_PATH')" title="נתיב דוח">{{STEP1_REPORT_PATH}}</div>
                                <div class="shortcode-item" onclick="copyShortcode('PREVIOUS_STEP_REPORT')" ondblclick="insertShortcode('PREVIOUS_STEP_REPORT')" title="דוח קודם">{{PREVIOUS_STEP_REPORT}}</div>
                            </div>
                        </div>
                        
                        <!-- מאגרי מידע - בסוף! -->
                        <h4 class="collapsible-header" onclick="toggleSection(this)" style="margin-top: 1.5rem; border-top: 1px solid var(--border); padding-top: 0.75rem;">
                            📚 מאגרי מידע <span class="category-badge">קבצים</span> <span class="toggle-icon">▼</span>
                        </h4>
                        <div class="collapsible-content">
                            <p class="shortcode-category-hint">ניתן לערוך/למחוק</p>
                            <div class="shortcode-category custom-category" id="customDataSourcesList">
                                <!-- Loaded dynamically -->
                            </div>
                            <button class="add-source-btn" onclick="openAddDataSourceModal()">➕ הוסף מאגר חדש</button>
                        </div>
                    </aside>

                    <!-- Steps Editor -->
                    <div class="steps-editor">
                        <!-- Current Agent Header -->
                        <div class="current-agent-header" id="currentAgentHeader" style="display: none;">
                            <div class="current-agent-info">
                                <span class="current-agent-label">עורך סוכן:</span>
                                <span class="current-agent-name" id="editingAgentName"></span>
                                <span class="agent-type-badge" id="editingAgentType"></span>
                            </div>
                            <div class="current-agent-stats">
                                <span id="editingAgentSteps"></span>
                            </div>
                        </div>
                        
                        <div class="steps-list" id="stepsList">
                            <div class="empty-state" id="noAgentSelected">
                                <div class="empty-state-icon">🤖</div>
                                <p>בחר סוכן מהרשימה או צור סוכן חדש</p>
                            </div>
                        </div>
                    </div>

                    <!-- Settings Panel -->
                    <aside class="agent-settings-panel" id="agentSettingsPanel" style="display:none;">
                        <div class="settings-section">
                            <h4>⚙️ הגדרות כלליות</h4>
                            <div class="setting-row">
                                <label>שם הסוכן</label>
                                <input type="text" id="agentNameInput" placeholder="שם הסוכן">
                            </div>
                            <div class="setting-row">
                                <label>מזהה (ID)</label>
                                <input type="text" id="agentIdInput" placeholder="agent_id" disabled>
                            </div>
                            <div class="setting-row">
                                <label>תיאור</label>
                                <input type="text" id="agentDescInput" placeholder="תיאור הסוכן">
                            </div>
                            <div class="setting-row">
                                <label>שם תיקייה</label>
                                <input type="text" id="agentFolderInput" placeholder="SEO">
                            </div>
                        </div>

                        <div class="settings-section">
                            <h4>🎯 סוג ומצב</h4>
                            <div class="setting-row">
                                <label>סוג סוכן</label>
                                <select id="agentTypeSelect">
                                    <option value="update">עדכון עמוד קיים</option>
                                    <option value="build">בניית עמוד חדש</option>
                                </select>
                            </div>
                            <div class="setting-row">
                                <label>מצב</label>
                                <select id="agentStatusSelect">
                                    <option value="active">פעיל ✅</option>
                                    <option value="test">טסט 🧪</option>
                                </select>
                            </div>
                        </div>

                        <div class="settings-section">
                            <h4>🧠 מודל AI</h4>
                            <div class="setting-row">
                                <label>מודל Claude</label>
                                <select id="agentModelSelect">
                                    <option value="claude-opus-4-5">Claude Opus 4.5</option>
                                    <option value="claude-sonnet-4-5" selected>Claude Sonnet 4.5</option>
                                    <option value="claude-sonnet-4">Claude Sonnet 4</option>
                                    <option value="claude-haiku-4-5">Claude Haiku 4.5</option>
                                </select>
                            </div>
                        </div>

                        <div class="settings-section">
                            <h4>🌐 הגבלת אתרים</h4>
                            <p class="settings-note" style="font-size: 0.85rem; color: #888; margin-bottom: 0.5rem;">ריק = כל האתרים</p>
                            <div class="setting-row" id="agentSitesCheckboxes">
                                <!-- Site checkboxes populated dynamically -->
                            </div>
                        </div>

                        <div class="settings-section">
                            <h4>🔗 שרשור סוכנים</h4>
                            <div class="setting-row">
                                <label>
                                    <input type="checkbox" id="chainEnabledCheck"> הפעל שרשור
                                </label>
                            </div>
                            <div class="setting-row" id="chainAgentRow" style="display:none;">
                                <label>סוכן הבא</label>
                                <select id="chainAgentSelect">
                                    <!-- Agents loaded dynamically -->
                                </select>
                            </div>
                        </div>

                        <div class="settings-section">
                            <h4>🌐 WordPress</h4>
                            <div class="setting-row">
                                <label>פעולה</label>
                                <select id="wpActionSelect">
                                    <option value="">ללא</option>
                                    <option value="update">עדכון פוסט</option>
                                    <option value="create">יצירת פוסט חדש</option>
                                </select>
                            </div>
                            <div class="setting-row">
                                <label>אתר</label>
                                <select id="wpSiteSelect">
                                    <!-- Populated dynamically by populateWpSiteSelect() -->
                                </select>
                            </div>
                            <div class="setting-row" id="wpCategoryRow" style="display:none;">
                                <label>קטגוריה</label>
                                <select id="wpCategorySelect">
                                    <!-- Categories loaded dynamically -->
                                </select>
                                <button class="btn btn-small btn-secondary" style="margin-top: 0.5rem;" onclick="createNewCategory()">➕ קטגוריה חדשה</button>
                            </div>
                        </div>

                        <!-- מאגרי מידע הועברו לסיידבר הימני -->
                    </aside>
                </div>
            </div>
        </div>
    </section>

    <!-- Reports Section -->
    <section class="reports-section" id="reportsSection">
        <div class="reports-container">
            <!-- Header -->
            <div class="reports-header">
                <h2>📊 דוחות מערכת</h2>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn btn-secondary" onclick="refreshCurrentReport()">🔄 רענן</button>
                </div>
            </div>
            
            <!-- Report Type Tabs -->
            <div class="reports-tabs">
                <button class="report-type-tab active" data-report="interest-rate" onclick="switchReportType('interest-rate')">💰 עדכוני ריבית</button>
                <button class="report-type-tab" data-report="whatsapp" onclick="switchReportType('whatsapp')">📱 קישורי WhatsApp</button>
                <button class="report-type-tab" data-report="year-update" onclick="switchReportType('year-update')">📅 עדכון שנה</button>
            </div>
            
            <!-- Interest Rate Report -->
            <div class="report-content active" id="reportInterestRate">
                <div class="report-config">
                    <label>המשפט המעודכן הנוכחי:</label>
                    <input type="text" id="currentInterestSentence" value="💡 הריביות בתוכן מעודכנות לפי ריבית פריים 5.5% (ריבית בנק ישראל 4%, נכון לינואר 2026)" />
                    <div style="margin-top: 0.5rem; display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="scanInterestRate()">🔍 סרוק עמודים</button>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <label style="font-size: 0.9rem;">סטטוס:</label>
                            <select id="interestRateFilter" onchange="filterInterestRateTable()" style="padding: 0.4rem; border-radius: 4px; background: var(--bg-tertiary); color: var(--text); border: 1px solid var(--border);">
                                <option value="all">הכל</option>
                                <option value="updated_uploaded">✅ עודכן + עלה</option>
                                <option value="updated_not_uploaded">⚠️ עודכן, לא עלה</option>
                                <option value="outdated">❌ לא מעודכן</option>
                                <option value="not_found">➖ אין משפט ריבית</option>
                                <option value="special">⭐ עמודים מיוחדים</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <label style="font-size: 0.9rem;">אתרים:</label>
                            <label style="display: flex; align-items: center; gap: 0.2rem; cursor: pointer;">
                                <input type="checkbox" id="interestRateSiteMain" checked onchange="filterInterestRateTable()" style="cursor: pointer;">
                                <span style="font-size: 0.85rem;">ראשי</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.2rem; cursor: pointer;">
                                <input type="checkbox" id="interestRateSiteBusiness" checked onchange="filterInterestRateTable()" style="cursor: pointer;">
                                <span style="font-size: 0.85rem;">עסקים</span>
                            </label>
                        </div>
                        <span id="interestRateFilterInfo" style="font-size: 0.85rem; color: var(--text-secondary);"></span>
                    </div>
                </div>
                
                <div class="report-stats" id="interestRateStats">
                    <!-- Stats populated by JS -->
                </div>
                
                <div class="report-table-container">
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th>עמוד</th>
                                <th>אתר</th>
                                <th>סטטוס</th>
                                <th>עלה לוורדפרס</th>
                                <th>פעולות</th>
                            </tr>
                        </thead>
                        <tbody id="interestRateTableBody">
                            <tr><td colspan="5" class="report-loading"><div class="spinner"></div><br>לחץ על "סרוק עמודים" להתחלה</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- WhatsApp Links Report -->
            <div class="report-content" id="reportWhatsApp">
                <div class="report-config">
                    <label>סינון לפי אתר:</label>
                    <select id="whatsappSiteFilter" onchange="scanWhatsAppLinks()">
                        <option value="all">הכל</option>
                        <option value="main">אתר ראשי</option>
                        <option value="business">עסקים</option>
                    </select>
                    <button class="btn btn-secondary" style="margin-right: 1rem;" onclick="scanWhatsAppLinks()">🔍 סרוק קישורים</button>
                </div>
                
                <div class="report-stats" id="whatsappStats">
                    <!-- Stats populated by JS -->
                </div>
                
                <div class="report-table-container">
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th>עמוד</th>
                                <th>אתר</th>
                                <th>שורה</th>
                                <th>קישור</th>
                                <th>אנקור</th>
                                <th>פעולות</th>
                            </tr>
                        </thead>
                        <tbody id="whatsappTableBody">
                            <tr><td colspan="6" class="report-loading"><div class="spinner"></div><br>לחץ על "סרוק קישורים" להתחלה</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Year Update Report -->
            <div class="report-content" id="reportYearUpdate">
                <div class="report-config">
                    <label>החלף שנה:</label>
                    <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                        <input type="text" id="yearFrom" value="2025" style="width: 80px; text-align: center;" />
                        <span style="color: var(--text-secondary);">→</span>
                        <input type="text" id="yearTo" value="2026" style="width: 80px; text-align: center;" />
                        <button class="btn btn-secondary" onclick="scanYearOccurrences()">🔍 סרוק</button>
                        <div style="display: flex; gap: 0.5rem; align-items: center; margin-right: 1rem;">
                            <label style="display: flex; align-items: center; gap: 0.3rem; cursor: pointer; font-size: 0.9rem;">
                                <input type="checkbox" id="yearHideLinks" checked onchange="filterYearUpdateTable()" style="cursor: pointer;">
                                <span>🖼️ הסתר קישורי קבצים</span>
                            </label>
                        </div>
                        <span id="yearFilterInfo" style="font-size: 0.85rem; color: var(--text-secondary);"></span>
                    </div>
                </div>
                
                <div class="report-stats" id="yearUpdateStats">
                    <!-- Stats populated by JS -->
                </div>
                
                <div class="report-table-container">
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th>עמוד</th>
                                <th>אתר</th>
                                <th>שורה</th>
                                <th>הקשר</th>
                                <th>פעולות</th>
                            </tr>
                        </thead>
                        <tbody id="yearUpdateTableBody">
                            <tr><td colspan="5" class="report-loading"><div class="spinner"></div><br>לחץ על "סרוק" להתחלה</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>

    <!-- Duplicates Section -->
    <section class="duplicates-section" id="duplicatesSection">
        <div class="duplicates-container">
            <!-- Header with controls -->
            <div class="duplicates-header">
                <h2>🔍 זיהוי כפילויות תוכן</h2>
                <div class="duplicates-controls">
                    <button id="btn-open-settings" class="btn btn-secondary" onclick="openDuplicateSettings()">
                        ⚙️ הגדרות סריקה
                    </button>
                    
                    <select id="duplicates-threshold">
                        <option value="0.5">50%+ דמיון (רגיש)</option>
                        <option value="0.7" selected>70%+ דמיון (Google)</option>
                        <option value="0.85">85%+ דמיון (מחמיר)</option>
                    </select>
                    
                    <label style="display: flex; align-items: center; gap: 0.3rem;">
                        <input type="checkbox" id="include-meta" checked>
                        <span>Title/Description</span>
                    </label>
                    
                    <label style="display: flex; align-items: center; gap: 0.3rem;">
                        <input type="checkbox" id="include-headings" checked>
                        <span>כותרות H1-H6</span>
                    </label>
                    
                    <button id="btn-scan-duplicates" class="btn btn-primary" onclick="scanDuplicates()">
                        🔍 סרוק כפילויות
                    </button>
                </div>
            </div>
            
            <!-- Selected directories indicator -->
            <div id="selected-directories-bar" class="selected-directories-bar" style="display: none;">
                <span>📁 תיקיות נבחרות:</span>
                <div id="selected-directories-list"></div>
                <button class="btn btn-xs" onclick="openDuplicateSettings()">שנה</button>
            </div>
            
            <!-- Statistics Dashboard -->
            <div id="duplicates-stats" class="duplicates-stats" style="display: none;">
                <div class="stat-card">
                    <div class="stat-value" id="stat-total-pages">0</div>
                    <div class="stat-label">עמודים נסרקו</div>
                </div>
                <div class="stat-card alert">
                    <div class="stat-value" id="stat-pages-with-duplicates">0</div>
                    <div class="stat-label">עמודים עם כפילויות</div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-value" id="stat-duplicate-snippets">0</div>
                    <div class="stat-label">קטעים כפולים</div>
                </div>
                <div class="stat-card info">
                    <div class="stat-value" id="stat-avg-similarity">0%</div>
                    <div class="stat-label">דמיון ממוצע</div>
                </div>
            </div>
            
            <!-- Severity Breakdown -->
            <div id="severity-breakdown" class="severity-breakdown" style="display: none;">
                <div class="severity-item critical">
                    <span class="severity-badge">🔴 קריטי</span>
                    <span class="severity-count" id="severity-critical">0</span>
                </div>
                <div class="severity-item high">
                    <span class="severity-badge">🟡 גבוה</span>
                    <span class="severity-count" id="severity-high">0</span>
                </div>
                <div class="severity-item medium">
                    <span class="severity-badge">🟢 בינוני</span>
                    <span class="severity-count" id="severity-medium">0</span>
                </div>
            </div>
            
            <!-- Filters and Sort -->
            <div id="duplicates-filters" class="duplicates-filters" style="display: none;">
                <input type="text" id="filter-search" placeholder="🔍 חפש עמוד או מילת מפתח..." oninput="applyDuplicatesFilter()">
                
                <select id="filter-sort" onchange="applyDuplicatesFilter()">
                    <option value="similarity-desc">דמיון (גבוה → נמוך)</option>
                    <option value="similarity-asc">דמיון (נמוך → גבוה)</option>
                    <option value="pages-count-desc">מספר עמודים מושפעים</option>
                    <option value="seo-impact-desc">השפעת SEO</option>
                    <option value="keyword-asc">מילת מפתח (א-ת)</option>
                </select>
                
                <select id="filter-severity" onchange="applyDuplicatesFilter()">
                    <option value="all">כל הרמות</option>
                    <option value="critical">🔴 קריטי בלבד</option>
                    <option value="high">🟡 גבוה בלבד</option>
                    <option value="medium">🟢 בינוני בלבד</option>
                </select>
                
                <button id="btn-show-heatmap" class="btn btn-secondary" onclick="showHeatmap()">
                    📊 הצג Heatmap
                </button>
            </div>
            
            <!-- Bulk Actions Bar -->
            <div id="bulk-actions-bar" class="bulk-actions-bar" style="display: none;">
                <label>
                    <input type="checkbox" id="select-all-groups" onchange="toggleAllGroupsSelection()">
                    <span>בחר הכל</span>
                </label>
                <span id="selected-count">0 נבחרו</span>
                <button class="btn btn-success" onclick="bulkSendToClaude()">
                    🤖 תקן את כל הנבחרים
                </button>
                <button class="btn btn-secondary" onclick="bulkIgnore()">
                    🚫 התעלם מהנבחרים
                </button>
                <button class="btn btn-info" onclick="bulkExport()">
                    📄 ייצא נבחרים
                </button>
            </div>
            
            <!-- Results Container -->
            <div id="duplicates-results" class="duplicates-results">
                <div class="duplicates-empty-state">
                    <div style="font-size: 4rem;">🔍</div>
                    <h3>בחר תיקיות והתחל סריקה</h3>
                    <p>לחץ על "הגדרות סריקה" כדי לבחור את התיקיות לסריקה, ואז לחץ "סרוק כפילויות"</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Heatmap Modal -->
    <div id="heatmap-modal" class="modal-overlay">
        <div class="modal heatmap-modal">
            <div class="modal-header">
                <h2>📊 Heatmap כפילויות</h2>
                <button class="modal-close" onclick="closeHeatmap()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="heatmap-container"></div>
            </div>
        </div>
    </div>

    <!-- Diff Viewer Modal -->
    <div id="diff-viewer-modal" class="modal-overlay">
        <div class="modal diff-viewer-modal">
            <div class="modal-header">
                <h2>👁️ השוואה ויזואלית</h2>
                <button class="modal-close" onclick="closeDiffViewer()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="diff-viewer-container" class="diff-viewer">
                    <div class="diff-column">
                        <h3 id="diff-page1-title"></h3>
                        <div id="diff-page1-content"></div>
                    </div>
                    <div class="diff-column">
                        <h3 id="diff-page2-title"></h3>
                        <div id="diff-page2-content"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Duplicate Settings Modal -->
    <div id="duplicate-settings-modal" class="modal-overlay">
        <div class="modal duplicate-settings-modal">
            <div class="modal-header">
                <h2>⚙️ הגדרות סריקת כפילויות</h2>
                <button class="modal-close" onclick="closeDuplicateSettings()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="settings-section">
                    <h3>📁 בחירת תיקיות לסריקה</h3>
                    <p class="settings-hint">
                        בחר אילו תיקיות תחת "דפים לשינוי" לכלול בסריקה. 
                        כל תיקייה מייצגת אתר או פרויקט נפרד.
                    </p>
                    
                    <div id="directories-loading" class="loading-spinner">
                        טוען תיקיות...
                    </div>
                    
                    <div id="directories-list" class="directories-list" style="display: none;">
                        <!-- Populated dynamically -->
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>🔄 סריקה חוצת תיקיות</h3>
                    <label class="settings-checkbox">
                        <input type="checkbox" id="cross-directory-scan">
                        <span>
                            אפשר זיהוי כפילויות <strong>בין תיקיות</strong>
                            <small>(למשל, תוכן זהה בין "main" ל-"business")</small>
                        </span>
                    </label>
                </div>
                
                <div class="settings-section">
                    <h3>⚡ הגדרות נוספות</h3>
                    <label class="settings-checkbox">
                        <input type="checkbox" id="auto-scan-enabled">
                        <span>
                            סריקה אוטומטית בכניסה לטאב
                            <small>(ישתמש בדוח אחרון אם קיים)</small>
                        </span>
                    </label>
                </div>
                
                <div class="settings-section">
                    <h3>🚫 ניהול פטורים (Ignore List)</h3>
                    <p class="settings-hint">
                        הוסף קטעי טקסט שחוזרים בכל העמודים באופן לגיטימי (disclaimers, תאריכים, וכו').
                        הם לא ייחשבו ככפילויות.
                    </p>
                    <button class="btn btn-info" onclick="openIgnoreManager()">
                        🚫 נהל רשימת פטורים
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDuplicateSettings()">ביטול</button>
                <button class="btn btn-primary" onclick="saveDuplicateSettings()">💾 שמור הגדרות</button>
            </div>
        </div>
    </div>

    <!-- Ignore Manager Modal -->
    <div id="ignore-manager-modal" class="modal-overlay">
        <div class="modal ignore-manager-modal">
            <div class="modal-header">
                <h2>🚫 ניהול רשימת פטורים</h2>
                <button class="modal-close" onclick="closeIgnoreManager()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="ignore-manager-content">
                    <!-- Add New Pattern -->
                    <div class="add-pattern-section">
                        <h3>➕ הוסף פטור חדש</h3>
                        <div class="pattern-input-group">
                            <textarea id="new-pattern-text" 
                                      placeholder="הדבק כאן טקסט להחרגה (לדוגמה: עודכן לאחרונה...)"
                                      rows="3"></textarea>
                            <div class="pattern-options">
                                <label>
                                    <input type="radio" name="pattern-type" value="exact" checked>
                                    <span>התאמה מדויקת</span>
                                </label>
                                <label>
                                    <input type="radio" name="pattern-type" value="contains">
                                    <span>מכיל טקסט</span>
                                </label>
                                <label>
                                    <input type="radio" name="pattern-type" value="regex">
                                    <span>ביטוי רגולרי (Regex)</span>
                                </label>
                            </div>
                            <input type="text" 
                                   id="pattern-description" 
                                   placeholder="תיאור (אופציונלי): למה הטקסט הזה חוזר?"
                                   style="margin-top: 0.5rem;">
                            <button class="btn btn-success" onclick="addIgnorePattern()">
                                ➕ הוסף לרשימה
                            </button>
                        </div>
                    </div>
                    
                    <!-- Current Patterns List -->
                    <div class="current-patterns-section">
                        <div class="patterns-header">
                            <h3>📋 פטורים קיימים</h3>
                            <span class="patterns-count" id="patterns-count">0 פטורים</span>
                        </div>
                        
                        <div id="patterns-list" class="patterns-list">
                            <!-- Populated dynamically -->
                        </div>
                    </div>
                    
                    <!-- Predefined Templates -->
                    <div class="templates-section">
                        <h3>📦 תבניות מוכנות</h3>
                        <p class="settings-hint">לחץ להוספה מהירה</p>
                        <div class="templates-grid">
                            <button class="template-btn" onclick="addTemplatePattern('date-updated')">
                                📅 עודכן לאחרונה
                            </button>
                            <button class="template-btn" onclick="addTemplatePattern('interest-rate')">
                                💰 ריבית פריים
                            </button>
                            <button class="template-btn" onclick="addTemplatePattern('copyright')">
                                ©️ זכויות יוצרים
                            </button>
                            <button class="template-btn" onclick="addTemplatePattern('contact-cta')">
                                📞 צור קשר
                            </button>
                            <button class="template-btn" onclick="addTemplatePattern('disclaimer')">
                                ⚠️ Disclaimer
                            </button>
                            <button class="template-btn" onclick="addTemplatePattern('footer')">
                                📄 Footer
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeIgnoreManager()">סגור</button>
            </div>
        </div>
    </div>

    <!-- Duplicate Fix Prompt Preview Modal -->
    <div id="duplicate-fix-modal" class="modal-overlay">
        <div class="modal duplicate-fix-modal">
            <div class="modal-header">
                <h2>🤖 פרומפט לתיקון כפילויות</h2>
                <button class="modal-close" onclick="closeDuplicateFixModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p class="settings-hint">בדוק את הפרומפט לפני שליחה לקלוד:</p>
                <textarea id="duplicate-fix-prompt" rows="20" style="width: 100%; font-family: monospace; font-size: 0.9rem;"></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDuplicateFixModal()">ביטול</button>
                <button class="btn btn-primary" onclick="executeDuplicateFix()">🚀 שלח לקלוד</button>
            </div>
        </div>
    </div>

    <!-- Work Status Panel -->
    <div class="work-status-panel hidden" id="workStatusPanel">
        <div class="work-status-header" onclick="toggleWorkStatus()">
            <h3>
                <span class="status-dot" id="workStatusDot"></span>
                <span id="workStatusTitle">סטטוס עבודה</span>
            </h3>
            <div class="work-status-controls">
                <span id="workStatusTime"></span>
                <button class="minimize-btn" id="minimizeBtn">▼</button>
            </div>
        </div>
        <div class="work-status-content" id="workStatusContent">
            מחכה להתחלת עבודה...
        </div>
        <div class="work-status-input" id="workStatusInput" style="display: none;">
            <div style="display: flex; gap: 0.5rem; padding: 0.5rem 1rem; background: var(--bg-tertiary); border-top: 1px solid var(--border);">
                <input type="text" id="correctionInput" placeholder="כתוב תיקון או הוראה נוספת..." 
                       style="flex: 1; padding: 0.5rem; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-primary); color: var(--text-primary);"
                       onkeypress="if(event.key === 'Enter') sendCorrection()">
                <button class="btn btn-primary" onclick="sendCorrection()">📤 שלח</button>
                <button class="btn btn-secondary" onclick="hideCorrectionsInput()">✕</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <div class="modal-header">
                <h2>⚙️ הגדרות</h2>
                <button class="modal-close" onclick="closeModal('settingsModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="tabs" style="margin-bottom: 1rem;">
                    <button class="tab active" data-settings-tab="sites">🏢 אתרים</button>
                    <button class="tab" data-settings-tab="agents">🤖 סוכנים</button>
                </div>

                <!-- Sites Settings (Combined: Site Info + WordPress) -->
                <div id="settingsSites">
                    <div class="sites-management">
                        
                        <!-- Sync WordPress Titles Button -->
                        <div style="margin-bottom: 1rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 8px; display: flex; align-items: center; gap: 1rem;">
                            <span style="flex: 1;">🔄 סנכרן כותרות עמודים מוורדפרס לכל הדפים</span>
                            <button class="btn btn-info" onclick="syncWpTitles()" id="syncWpTitlesBtn">
                                📥 סנכרן כותרות
                            </button>
                        </div>
                        
                        <!-- Site Config Cards - Populated dynamically by renderSiteConfigCards() -->
                        <div id="siteConfigContainer">
                            <!-- Dynamic site cards will be rendered here -->
                        </div>
                        
                    </div>
                </div>

                <!-- Agents Settings -->
                <div id="settingsAgents" style="display:none;">
                    <div class="agent-list" id="agentList">
                        <!-- Agents loaded dynamically -->
                    </div>
                    <button class="btn btn-primary" style="margin-top: 1rem;" onclick="openAddAgent()">➕ הוסף סוכן</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('settingsModal')">סגור</button>
                <button class="btn btn-primary" onclick="saveSettings()">💾 שמור</button>
            </div>
        </div>
    </div>

    <!-- Add Agent Builder Modal (for dynamic agent creation) -->
    <div class="modal-overlay" id="addAgentBuilderModal">
        <div class="modal">
            <div class="modal-header">
                <h2>➕ יצירת סוכן חדש</h2>
                <button class="modal-close" onclick="closeModal('addAgentBuilderModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>📝 שם הסוכן</label>
                    <input type="text" id="builderAgentName" placeholder="לדוגמה: בודק נגישות" required autofocus>
                </div>
                <div class="form-group">
                    <label>📄 תיאור (אופציונלי)</label>
                    <textarea id="builderAgentDesc" rows="2" placeholder="מה הסוכן עושה?"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addAgentBuilderModal')">ביטול</button>
                <button class="btn btn-primary" onclick="saveNewAgentBuilder()">✅ צור סוכן</button>
            </div>
        </div>
    </div>

    <!-- Add Agent Modal -->
    <div id="addAgentModal" class="modal-overlay" style="display:none;">
        <div class="modal">
            <div class="modal-header">
                <h2>➕ הוספת סוכן</h2>
                <button class="modal-close" onclick="closeModal('addAgentModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>שם הסוכן</label>
                    <input type="text" id="newAgentName" placeholder="לדוגמה: בדיקת נגישות">
                </div>
                <div class="form-group">
                    <label>מזהה (ID)</label>
                    <input type="text" id="newAgentId" placeholder="לדוגמה: accessibility">
                </div>
                <div class="form-group">
                    <label>תיאור</label>
                    <input type="text" id="newAgentDesc">
                </div>
                <div class="form-group">
                    <label>סוג סוכן</label>
                    <select id="newAgentType" onchange="toggleAgentTypeFields()">
                        <option value="single-step">חד-שלבי</option>
                        <option value="two-step">דו-שלבי</option>
                    </select>
                </div>

                <!-- Single Step Fields -->
                <div id="singleStepFields">
                    <div class="form-group">
                        <label>קובץ סוכן</label>
                        <input type="text" id="singleAgentFile" placeholder="פרומטים/סוכן-חדש.md">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>סיומת פלט</label>
                            <input type="text" id="singleOutputSuffix" value="_מתוקן.html">
                        </div>
                        <div class="form-group">
                            <label>תיקיית פלט</label>
                            <input type="text" id="singleOutputFolder" value="עמודים מתוקנים">
                        </div>
                    </div>
                </div>

                <!-- Two Step Fields -->
                <div id="twoStepFields" style="display:none;">
                    <div class="form-section">
                        <div class="form-section-title">שלב 1 - דוח</div>
                        <div class="form-group">
                            <label>קובץ סוכן דוח</label>
                            <input type="text" id="step1AgentFile" placeholder="פרומטים/סוכן-דוח.md">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>סיומת דוח</label>
                                <input type="text" id="step1OutputSuffix" value="_דוח.md">
                            </div>
                            <div class="form-group">
                                <label>תיקיית דוח</label>
                                <input type="text" id="step1OutputFolder" value="תיקונים לעמודים">
                            </div>
                        </div>
                    </div>
                    <div class="form-section">
                        <div class="form-section-title">שלב 2 - ביצוע</div>
                        <div class="form-group">
                            <label>קובץ סוכן מבצע</label>
                            <input type="text" id="step2AgentFile" placeholder="פרומטים/סוכן-מבצע.md">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>סיומת פלט</label>
                                <input type="text" id="step2OutputSuffix" value="_מתוקן.html">
                            </div>
                            <div class="form-group">
                                <label>תיקיית פלט</label>
                                <input type="text" id="step2OutputFolder" value="עמודים מתוקנים">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group" style="margin-top: 1rem;">
                    <label>
                        <input type="checkbox" id="createAgentFile" checked>
                        צור קבצי סוכן עם תבנית בסיסית
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addAgentModal')">ביטול</button>
                <button class="btn btn-primary" onclick="saveNewAgent()">💾 שמור</button>
            </div>
        </div>
    </div>

    <!-- Command Modal -->
    <div class="modal-overlay" id="commandModal">
        <div class="modal">
            <div class="modal-header">
                <h2>📋 פקודה ל-Cursor</h2>
                <button class="modal-close" onclick="closeModal('commandModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p>הפקודה הועתקה ל-Clipboard. הדבק ב-Cursor והרץ:</p>
                <div class="command-display" id="commandDisplay"></div>
                <p style="color: var(--text-secondary); font-size: 0.9rem;">
                    אחרי שהסוכן סיים, לחץ "סיום" כדי להמשיך.
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('commandModal')">ביטול</button>
                <button class="btn btn-primary" onclick="markStepComplete()">✅ סיום</button>
            </div>
        </div>
    </div>

    <!-- Data Source Modal -->
    <div class="modal-overlay" id="dataSourceModal">
        <div class="modal">
            <div class="modal-header">
                <h2>➕ הוספת מאגר מידע</h2>
                <button class="modal-close" onclick="closeModal('dataSourceModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>שם המאגר</label>
                    <input type="text" id="dataSourceName" placeholder="לדוגמה: מחירון שירותים">
                </div>
                <div class="form-group">
                    <label>שורטקוד (ללא סוגריים)</label>
                    <input type="text" id="dataSourceShortcode" placeholder="לדוגמה: PRICING_DATA" style="text-transform: uppercase;">
                </div>
                <div class="form-group">
                    <label>נתיב לקובץ</label>
                    <input type="text" id="dataSourcePath" placeholder="לדוגמה: data/pricing.txt">
                    <small style="color: var(--text-secondary);">נתיב יחסי לתיקיית הפרויקט</small>
                </div>
                <div class="form-group">
                    <label>תיאור</label>
                    <textarea id="dataSourceDescription" rows="2" placeholder="הסבר קצר על תוכן המאגר"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('dataSourceModal')">ביטול</button>
                <button class="btn btn-primary" onclick="saveDataSource()">💾 שמור</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Upload to WordPress Modal -->
    <div class="modal-overlay" id="uploadModal">
        <div class="modal modal-large">
            <div class="modal-header">
                <h2>🌐 העלאה ל-WordPress</h2>
                <button class="modal-close" onclick="closeModal('uploadModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="uploadLoading" class="upload-loading">
                    <div class="spinner"></div>
                    <p>שולף נתונים מ-WordPress...</p>
                </div>
                
                <div id="uploadContent" style="display: none;">
                    <!-- Page Info -->
                    <div class="upload-section">
                        <h3>📄 מידע עמוד</h3>
                        <div class="upload-info-grid">
                            <div class="info-item">
                                <label>שם העמוד:</label>
                                <span id="uploadPageName">-</span>
                            </div>
                            <div class="info-item" style="display: flex; align-items: center; gap: 10px;">
                                <label>Post ID:</label>
                                <input type="text" id="uploadPostIdInput" style="width: 80px; padding: 5px 8px; border: 1px solid #444; border-radius: 5px; background: #2a2a2a; color: #fff; font-size: 14px;" />
                                <button class="btn btn-small" onclick="savePageInfo()" style="padding: 5px 10px; font-size: 12px;">💾</button>
                            </div>
                            <div class="info-item" style="display: flex; align-items: center; gap: 10px;">
                                <label>מילת מפתח:</label>
                                <input type="text" id="uploadKeywordInput" style="width: 150px; padding: 5px 8px; border: 1px solid #444; border-radius: 5px; background: #2a2a2a; color: #fff; font-size: 14px;" />
                            </div>
                            <div class="info-item">
                                <label>URL:</label>
                                <a id="uploadPageUrl" href="#" target="_blank">-</a>
                            </div>
                        </div>
                    </div>

                    <!-- Backup Status & Compare -->
                    <div class="upload-section" style="background: linear-gradient(135deg, rgba(59,130,246,0.1), rgba(139,92,246,0.1)); border: 1px solid rgba(59,130,246,0.3); border-radius: 10px; padding: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                            <div>
                                <h3 style="margin: 0 0 10px 0;">💾 גיבוי</h3>
                                <div class="backup-status">
                                    <span id="backupStatus" class="backup-badge">-</span>
                                    <button class="btn btn-small btn-secondary" onclick="fetchWordPressBackup()">🔄 שלוף וגבה</button>
                                </div>
                            </div>
                            <div style="text-align: center;">
                                <button class="btn btn-primary" onclick="openCompareView()" id="compareBtn" disabled style="font-size: 1.1em; padding: 12px 25px; background: linear-gradient(135deg, #3b82f6, #8b5cf6);">
                                    📊 השוואה בין גרסאות
                                </button>
                                <small style="display: block; margin-top: 5px; color: #888;">צפייה ועריכת תוכן</small>
                            </div>
                        </div>
                    </div>

                    <!-- WordPress Post Title (separate from Yoast) -->
                    <div class="upload-section">
                        <h3>📝 כותרת עמוד (WordPress Post Title)</h3>
                        <div class="form-group">
                            <label>כותרת העמוד בוורדפרס - חדש:</label>
                            <div class="meta-input-wrapper">
                                <input type="text" id="uploadWpTitle" placeholder="כותרת העמוד בוורדפרס" maxlength="100">
                            </div>
                            <small><span style="color: #4ade80;">חדש:</span> <span id="uploadWpTitleCount">0</span>/100 תווים</small>
                            <div class="backup-value-display" id="backupWpTitleDisplay" style="display: none;">
                                <span class="backup-label">📋 ישן (<span id="backupWpTitleCount">0</span>/100):</span>
                                <span class="backup-text" id="backupWpTitleText">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Metadata Editor -->
                    <div class="upload-section">
                        <h3>✏️ עריכת מטא-תגיות (Yoast SEO)</h3>
                        <div class="form-group">
                            <label>כותרת SEO (Title) - חדש:</label>
                            <div class="meta-input-wrapper" style="position: relative;">
                                <input type="text" id="uploadTitle" placeholder="כותרת SEO (בלי סיומת)" maxlength="70" oninput="updateTitleCharCountWithSuffix()">
                                <span id="titleSuffixPreview" class="title-suffix-badge" style="display: none;"></span>
                                <button class="btn btn-small meta-edit-btn" onclick="showMetaEditPopup('title')" title="שכתוב עם AI">✨</button>
                            </div>
                            <small><span style="color: #4ade80;">חדש:</span> <span id="uploadTitleCount">0</span><span id="titleSuffixCount"></span>/70 תווים</small>
                            <div class="backup-value-display" id="backupTitleDisplay" style="display: none;">
                                <span class="backup-label">📋 ישן (<span id="backupTitleCount">0</span>/70):</span>
                                <span class="backup-text" id="backupTitleText">-</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>תיאור (Description) - חדש:</label>
                            <div class="meta-input-wrapper">
                                <textarea id="uploadDescription" rows="3" placeholder="תיאור העמוד" maxlength="160"></textarea>
                                <button class="btn btn-small meta-edit-btn" onclick="showMetaEditPopup('description')" title="שכתוב עם AI">✨</button>
                            </div>
                            <div class="backup-value-display" id="backupDescDisplay" style="display: none;">
                                <span class="backup-label">📋 ישן (<span id="backupDescCount">0</span>/160):</span>
                                <span class="backup-text" id="backupDescText">-</span>
                            </div>
                            <small id="uploadDescCount">0/160 תווים</small>
                        </div>
                        <div class="form-group" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button class="btn btn-primary" onclick="runTitleDescriptionAgent()" id="runTitleDescAgentBtn">
                                    🏆 הפעל סוכן טייטלים מנצחים
                                </button>
                                <button class="btn btn-secondary" onclick="loadExistingMetaOptions()" title="טען אפשרויות קיימות מ-page_info.json">
                                    📂 טען אפשרויות קיימות
                                </button>
                            </div>
                            <small style="display: block; margin-top: 5px; color: #888;">מייצר 3 אפשרויות לכל אחד עם הסברים</small>
                        </div>
                    </div>

                </div>
            </div>
            <div class="modal-footer" style="flex-direction: column; gap: 15px;">
                <!-- Save locally row (NEW!) -->
                <div style="display: flex; flex-wrap: wrap; gap: 10px; width: 100%; justify-content: flex-end; background: rgba(59, 130, 246, 0.1); padding: 10px; border-radius: 8px;">
                    <span style="color: #3b82f6; font-weight: bold; margin-left: auto;">💾 שמור לוקלית (ללא העלאה):</span>
                    <button class="btn btn-primary" onclick="saveMetaLocally()" id="saveMetaLocallyBtn" title="שמור Title ו-Description לקובץ page_info.json">
                        💾 שמור מטא-תגיות
                    </button>
                </div>
                <!-- Upload new content row -->
                <div style="display: flex; flex-wrap: wrap; gap: 10px; width: 100%; justify-content: flex-end;">
                    <span style="color: #4ade80; font-weight: bold; margin-left: auto;">📤 העלה ל-WordPress:</span>
                    <button class="btn btn-secondary" onclick="uploadWpPostTitle()" id="uploadWpTitleBtn" disabled title="עדכן רק את כותרת העמוד (לא Yoast)">
                        📝 WP Title
                    </button>
                    <button class="btn btn-info" onclick="uploadToWP('title')" id="uploadTitleBtn" disabled title="עדכן רק את ה-Yoast Title">
                        📝 SEO Title
                    </button>
                    <button class="btn btn-info" onclick="uploadToWP('description')" id="uploadDescBtn" disabled title="עדכן רק את ה-Description">
                        📝 Description
                    </button>
                    <button class="btn btn-warning" onclick="uploadToWP('content')" id="uploadContentBtn" disabled title="עדכן רק את תוכן הגוף">
                        📄 תוכן
                    </button>
                    <button class="btn btn-success" onclick="uploadToWP('all')" id="confirmUploadBtn" disabled title="עדכן הכל ביחד">
                        🚀 הכל
                    </button>
                </div>
                <!-- Restore backup row -->
                <div style="display: flex; flex-wrap: wrap; gap: 10px; width: 100%; justify-content: flex-end; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px;">
                    <span style="color: #f87171; font-weight: bold; margin-left: auto;">⏪ שחזר גיבוי:</span>
                    <button class="btn btn-outline-danger" onclick="restoreBackup('title')" id="restoreTitleBtn" disabled title="שחזר Title מהגיבוי">
                        📝 Title
                    </button>
                    <button class="btn btn-outline-danger" onclick="restoreBackup('description')" id="restoreDescBtn" disabled title="שחזר Description מהגיבוי">
                        📝 Description
                    </button>
                    <button class="btn btn-outline-danger" onclick="restoreBackup('content')" id="restoreContentBtn" disabled title="שחזר תוכן מהגיבוי">
                        📄 תוכן
                    </button>
                    <button class="btn btn-danger" onclick="restoreBackup('all')" id="restoreAllBtn" disabled title="שחזר הכל מהגיבוי">
                        ⏪ הכל
                    </button>
                </div>
                <!-- Cancel button -->
                <div style="display: flex; width: 100%; justify-content: flex-start;">
                    <button class="btn btn-secondary" onclick="closeModal('uploadModal')">ביטול</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Compare Modal -->
    <div class="modal-overlay" id="compareModal">
        <div class="modal modal-fullscreen">
            <div class="modal-header">
                <h2>📊 השוואת תוכן</h2>
                <div class="compare-controls">
                    <!-- Search in content -->
                    <div style="display: flex; align-items: center; gap: 0.5rem; background: var(--bg-tertiary); padding: 0.25rem 0.5rem; border-radius: 6px; border: 1px solid var(--border-color);">
                        <span style="font-size: 0.9rem;">🔎</span>
                        <input type="text" id="compareSearchInput" placeholder="חפש מילה..." 
                               style="background: transparent; border: none; color: var(--text-primary); width: 120px; font-size: 0.85rem; outline: none;"
                               onkeyup="if(event.key === 'Enter') searchInCompare()">
                        <button onclick="searchInCompare()" style="background: var(--accent-primary); border: none; color: white; padding: 2px 8px; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">חפש</button>
                        <button onclick="clearCompareSearch()" style="background: #6b7280; border: none; color: white; padding: 2px 6px; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">✕</button>
                        <span id="searchResultCount" style="font-size: 0.75rem; color: var(--text-secondary); min-width: 60px;"></span>
                    </div>
                    <button class="btn btn-small" id="editModeBtn" onclick="toggleEditMode()">
                        ✏️ מצב עריכה
                    </button>
                    <button class="btn btn-small save-edit-btn" id="saveDirectEditBtn" onclick="saveDirectEdit()" style="display: none;">
                        💾 שמור שינויים
                    </button>
                    <button class="btn btn-small" id="highlightDiffBtn" onclick="toggleDiffHighlight()">
                        🔍 הדגש שינויים
                    </button>
                    <button class="btn btn-small active" id="syncScrollBtn" onclick="toggleSyncScroll()">
                        🔗 גלילה מסונכרנת
                    </button>
                    <button class="btn btn-small" id="seoReportBtn" onclick="toggleSeoReport()">
                        📊 דוח SEO
                    </button>
                    <button class="btn btn-small" id="competitorReportBtn" onclick="toggleCompetitorReport()">
                        🔍 ניתוח מתחרים
                    </button>
                    <button class="btn btn-small" id="densityReportBtn" onclick="toggleDensityReport()">
                        📊 צפיפות
                    </button>
                    <button class="btn btn-small" id="aiReportBtn" onclick="toggleAiReport()">
                        🤖 דוח AI
                    </button>
                    <button class="btn btn-small" id="refreshContentBtn" onclick="refreshCompareContent()">
                        🔄 רענן
                    </button>
                </div>
                <button class="modal-close" onclick="closeModal('compareModal')">&times;</button>
            </div>
            <div class="modal-body compare-container">
                <div class="compare-panel">
                    <h3>📄 תוכן ישן (מ-WordPress)</h3>
                    <div class="compare-content" id="compareOldContent">
                        <div class="empty-state">אין גיבוי זמין</div>
                    </div>
                </div>
                <div class="compare-divider"></div>
                <div class="compare-panel">
                    <h3 style="display: flex; align-items: center; gap: 10px;">
                        ✨ תוכן חדש (לאחר עריכה)
                        <button onclick="refreshNewContentPreview()" style="background: #4b5563; border: none; color: white; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.75rem;" title="רענן תצוגה">🔄 רענן</button>
                    </h3>
                    <div class="compare-content" id="compareNewContent">
                        <div class="empty-state">אין תוכן</div>
                    </div>
                </div>
                <!-- SEO Report Panel -->
                <div class="seo-report-panel" id="seoReportPanel" style="display: none;">
                    <div class="seo-report-header">
                        <h3>📊 דוח SEO השוואתי</h3>
                        <button class="btn btn-small" onclick="toggleSeoReport()">✕</button>
                    </div>
                    <div class="seo-report-content" id="seoReportContent">
                        <!-- Report generated dynamically -->
                    </div>
                </div>
                
                <!-- AI Detection Report Panel -->
                <div class="seo-report-panel" id="aiReportPanel" style="display: none;">
                    <div class="seo-report-header">
                        <h3>🤖 דוח זיהוי תוכן AI</h3>
                        <button class="btn btn-small" onclick="toggleAiReport()">✕</button>
                    </div>
                    <div class="seo-report-content" id="aiReportContent">
                        <!-- AI Report generated dynamically -->
                    </div>
                </div>
                
                <!-- Competitor Analysis Report Panel -->
                <div class="seo-report-panel" id="competitorReportPanel" style="display: none;">
                    <div class="seo-report-header">
                        <h3>🔍 דוח ניתוח מתחרים</h3>
                        <button class="btn btn-small" onclick="toggleCompetitorReport()">✕</button>
                    </div>
                    <div class="seo-report-content" id="competitorReportContent">
                        <div class="competitor-report-intro">
                            <p>טוען נתונים...</p>
                        </div>
                        <div id="competitorAnalysisResults" style="display: none;">
                            <!-- Results will be populated here -->
                        </div>
                    </div>
                </div>
                
                <!-- Keyword Density Analysis Panel -->
                <div class="seo-report-panel" id="densityReportPanel" style="display: none;">
                    <div class="seo-report-header">
                        <h3>📊 בודק צפיפות מילות מפתח</h3>
                        <button class="btn btn-small" onclick="toggleDensityReport()">✕</button>
                    </div>
                    <div class="seo-report-content" id="densityReportContent">
                        <div class="density-input-section" style="margin-bottom: 1rem; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px;">
                            <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <input type="text" id="densityKeyword" placeholder="מילת מפתח" style="flex: 1; padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border); background: var(--bg-primary); color: var(--text);">
                                <button class="btn btn-primary" onclick="runDensityAnalysis()">🔍 נתח</button>
                            </div>
                            <small style="color: var(--text-muted);">מילת המפתח תילקח אוטומטית מפרטי העמוד אם לא תוזן</small>
                        </div>
                        <div id="densityAnalysisResults">
                            <div class="empty-state" style="padding: 2rem; text-align: center; color: var(--text-muted);">
                                לחץ על "נתח" לביצוע ניתוח צפיפות מילות מפתח
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Annotations Sidebar -->
                <div class="annotations-sidebar hidden" id="annotationsSidebar">
                    <div class="annotations-header">
                        <h4>📝 הערות לתיקון</h4>
                        <span id="annotationsCount">0</span>
                    </div>
                    <div class="annotations-list" id="annotationsList">
                        <div class="empty-state" style="padding: 2rem; text-align: center; color: var(--text-muted);">
                            לחץ על אלמנט בתוכן החדש כדי להוסיף הערה
                        </div>
                    </div>
                    <div class="annotations-footer">
                        <button class="btn btn-primary" onclick="generateAnnotationsPrompt()" id="generatePromptBtn" disabled>
                            🚀 צור פרומפט לתיקון
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('compareModal')">סגור</button>
            </div>
        </div>
    </div>

    <!-- Annotation Popup -->
    <div class="annotation-popup" id="annotationPopup">
        <button class="popup-close-btn" onclick="closeAnnotationPopup()">✕</button>
        <h4>➕ הוסף הערה לאלמנט</h4>
        <div class="annotation-element-tag" id="annotationElementTag"></div>
        
        <div class="annotation-popup-section" id="contentOptionsSection">
            <label>📝 פעולה על התוכן (אופציונלי):</label>
            <div class="annotation-options" id="contentOptions">
                <div class="annotation-option" data-value="none" onclick="selectAnnotationOption(this, 'contentAction')">➖ ללא</div>
                <div class="annotation-option selected" data-value="rewrite" onclick="selectAnnotationOption(this, 'contentAction')">🔄 שכתב</div>
                <div class="annotation-option" data-value="human" onclick="selectAnnotationOption(this, 'contentAction')">🧑 יותר אנושי</div>
                <div class="annotation-option" data-value="marketing" onclick="selectAnnotationOption(this, 'contentAction')">📢 שיווקי</div>
                <div class="annotation-option" data-value="seo" onclick="selectAnnotationOption(this, 'contentAction')">🔍 SEO</div>
                <div class="annotation-option" data-value="shorter" onclick="selectAnnotationOption(this, 'contentAction')">✂️ קצר</div>
                <div class="annotation-option" data-value="longer" onclick="selectAnnotationOption(this, 'contentAction')">📄 ארוך</div>
                <div class="annotation-option" data-value="removeLink" onclick="selectAnnotationOption(this, 'contentAction')">🔗 הסר קישור</div>
                <div class="annotation-option" data-value="removeBold" onclick="selectAnnotationOption(this, 'contentAction')">🅱️ הסר בולד</div>
                <div class="annotation-option" data-value="removeElement" onclick="selectAnnotationOption(this, 'contentAction')" style="background: #dc2626;">🗑️ הסר אלמנט</div>
                <div class="annotation-option" data-value="custom" onclick="selectAnnotationOption(this, 'contentAction')">💬 מותאם</div>
            </div>
        </div>
        
        <div class="annotation-popup-section" id="stylingOptionsSection">
            <label>🎨 פעולה על העיצוב (אופציונלי):</label>
            <div class="annotation-options" id="stylingOptions">
                <div class="annotation-option" data-value="none" onclick="selectAnnotationOption(this, 'stylingAction')">➖ ללא</div>
                <div class="annotation-option" data-value="match" onclick="selectAnnotationOption(this, 'stylingAction')">🎯 התאם לעמוד</div>
                <div class="annotation-option" data-value="restyle" onclick="selectAnnotationOption(this, 'stylingAction')">✨ עצב מחדש</div>
            </div>
        </div>
        
        <div class="annotation-popup-section">
            <label>הערה/הוראות (אופציונלי):</label>
            <textarea id="annotationNote" placeholder="הוסף הוראות ספציפיות..."></textarea>
        </div>
        
        <div class="annotation-popup-section" id="directActionsSection" style="display: none; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px; margin-top: 10px;">
            <label>⚡ פעולות מיידיות (ללא שליחה לסוכן):</label>
            <div style="display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap;">
                <button class="btn btn-small btn-danger" onclick="directRemoveLink()" id="directRemoveLinkBtn" style="display: none;">
                    🔗✂️ הסר קישור עכשיו
                </button>
                <button class="btn btn-small" onclick="directRemoveBold()" id="directRemoveBoldBtn" style="display: none; background: #f97316;">
                    🅱️✂️ הסר בולד עכשיו
                </button>
                <button class="btn btn-small" onclick="directRemoveElement()" id="directRemoveElementBtn" style="display: none; background: #dc2626;">
                    🗑️ הסר אלמנט עכשיו
                </button>
            </div>
        </div>
        
        <div class="annotation-popup-buttons">
            <button class="btn btn-warning" onclick="restoreFromBackup()" title="שחזר את התוכן מהגיבוי">🔙 שחזר מגיבוי</button>
            <button class="btn btn-secondary" onclick="closeAnnotationPopup()">ביטול</button>
            <button class="btn btn-primary" onclick="addAnnotation()">➕ הוסף</button>
        </div>
    </div>

    <!-- Meta Edit Popup -->
    <div class="meta-edit-popup" id="metaEditPopup">
        <button class="popup-close-btn" onclick="closeMetaEditPopup()">✕</button>
        <h4 id="metaEditTitle">✨ שכתוב כותרת</h4>
        
        <div class="annotation-popup-section">
            <label>בחר סגנון:</label>
            <div class="meta-edit-options" id="metaEditOptions">
                <div class="meta-edit-option selected" data-value="rewrite" onclick="selectMetaOption(this)">🔄 שכתב</div>
                <div class="meta-edit-option" data-value="human" onclick="selectMetaOption(this)">🧑 יותר אנושי</div>
                <div class="meta-edit-option" data-value="marketing" onclick="selectMetaOption(this)">📢 שיווקי</div>
                <div class="meta-edit-option" data-value="seo" onclick="selectMetaOption(this)">🔍 SEO</div>
                <div class="meta-edit-option" data-value="shorter" onclick="selectMetaOption(this)">✂️ קצר</div>
                <div class="meta-edit-option" data-value="longer" onclick="selectMetaOption(this)">📄 ארוך</div>
                <div class="meta-edit-option" data-value="custom" onclick="selectMetaOption(this)">💬 מותאם</div>
            </div>
        </div>
        
        <div class="annotation-popup-section">
            <label>הוראות נוספות (אופציונלי):</label>
            <textarea id="metaEditNote" placeholder="הוסף הוראות ספציפיות..."></textarea>
        </div>
        
        <div class="annotation-popup-buttons">
            <button class="btn btn-secondary" onclick="closeMetaEditPopup()">ביטול</button>
            <button class="btn btn-primary" onclick="addMetaAnnotation()">➕ הוסף להערות</button>
        </div>
    </div>

    <!-- Keyword Density Analyzer Module - MUST load before main script -->
    <script>
/**
 * KeywordDensityAnalyzer - Advanced Hebrew SEO Keyword Density Module
 */
class KeywordDensityAnalyzer {
    constructor(htmlContent, keyword, options = {}) {
        this.htmlContent = htmlContent;
        this.keyword = keyword;
        this.options = {
            optimalRange: [1.5, 2.5],
            warningRange: [1.0, 3.0],
            useNLP: false,
            // External metadata from JSON/WordPress (overrides HTML extraction)
            externalTitle: null,
            externalDescription: null,
            ...options
        };
        this.zoneWeights = { title: 3, metaDescription: 2, h1: 3, h2: 2, h3: 1.5, h4: 1.5, h5: 1.5, h6: 1.5, body: 1 };
        this.hebrewPrefixes = ['ה', 'ב', 'ל', 'מ', 'ו', 'כ', 'ש', 'וה', 'וב', 'ול', 'שה', 'שב', 'של'];
        this._parsedContent = null;
        this._analysisResult = null;
    }
    
    normalizeHebrew(text) {
        if (!text) return '';
        return text.replace(/[\u0591-\u05C7]/g, '').replace(/[^\u0590-\u05FF\sa-zA-Z0-9]/g, ' ').replace(/\s+/g, ' ').trim();
    }
    
    extractHebrewWords(text) {
        const normalized = this.normalizeHebrew(text);
        return normalized.split(/\s+/).filter(word => word.length > 0 && /[\u0590-\u05FF]/.test(word));
    }
    
    getKeywordVariations(keyword) {
        const normalized = this.normalizeHebrew(keyword);
        const words = normalized.split(/\s+/);
        const variations = new Set([normalized]);
        if (words.length === 1) {
            const word = words[0];
            this.hebrewPrefixes.forEach(prefix => variations.add(prefix + word));
            if (word.endsWith('ה')) {
                variations.add(word.slice(0, -1) + 'ות');
                variations.add(word.slice(0, -1) + 'ת');
            }
            variations.add(word + 'ים');
            variations.add(word + 'ות');
            if (!word.startsWith('ה')) variations.add('ה' + word);
        } else {
            const firstWord = words[0];
            const rest = words.slice(1).join(' ');
            this.hebrewPrefixes.slice(0, 7).forEach(prefix => {
                if (!firstWord.startsWith(prefix)) variations.add(prefix + firstWord + ' ' + rest);
            });
        }
        return Array.from(variations);
    }
    
    parseHTML() {
        if (this._parsedContent) return this._parsedContent;
        const parser = new DOMParser();
        const doc = parser.parseFromString(this.htmlContent, 'text/html');
        
        // Use external metadata if provided, otherwise extract from HTML
        const titleEl = doc.querySelector('title');
        const htmlTitle = titleEl ? titleEl.textContent.trim() : '';
        const title = this.options.externalTitle || htmlTitle;
        
        const metaDesc = doc.querySelector('meta[name="description"]');
        const htmlMetaDesc = metaDesc ? metaDesc.getAttribute('content') || '' : '';
        const metaDescription = this.options.externalDescription || htmlMetaDesc;
        
        // Log which source is being used
        if (this.options.externalTitle && this.options.externalTitle !== htmlTitle) {
            console.log('📝 Using external title from JSON:', this.options.externalTitle.substring(0, 50) + '...');
        }
        if (this.options.externalDescription && this.options.externalDescription !== htmlMetaDesc) {
            console.log('📝 Using external description from JSON:', this.options.externalDescription.substring(0, 50) + '...');
        }
        
        const headings = {};
        ['h1', 'h2', 'h3', 'h4', 'h5', 'h6'].forEach(tag => {
            headings[tag] = Array.from(doc.querySelectorAll(tag))
                .map(el => ({ text: el.textContent.trim(), html: el.innerHTML }))
                .filter(h => h.text.length > 0); // Filter out empty headings
        });
        const clone = doc.body.cloneNode(true);
        ['script', 'style', 'noscript', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6'].forEach(sel => {
            clone.querySelectorAll(sel).forEach(el => el.remove());
        });
        const bodyText = clone.textContent || '';
        const fullText = doc.body ? doc.body.textContent : '';
        this._parsedContent = { title, metaDescription, headings, bodyText: bodyText.trim(), fullText: fullText.trim(), doc };
        return this._parsedContent;
    }
    
    countOccurrences(text, variations = null) {
        const normalizedText = this.normalizeHebrew(text);
        const keywordVariations = variations || this.getKeywordVariations(this.keyword);
        let totalCount = 0;
        const variationCounts = {};
        const positions = [];
        keywordVariations.forEach(variation => {
            try {
                const regex = new RegExp(variation.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
                const matches = [...normalizedText.matchAll(regex)];
                const count = matches.length;
                if (count > 0) {
                    variationCounts[variation] = count;
                    totalCount += count;
                    matches.forEach(match => {
                        positions.push({ start: match.index, end: match.index + match[0].length, variation, matchedText: match[0] });
                    });
                }
            } catch (e) { console.warn('Regex error:', variation, e); }
        });
        return { totalCount, variationCounts, positions };
    }
    
    calculateWeightedDensity() {
        const parsed = this.parseHTML();
        const variations = this.getKeywordVariations(this.keyword);
        const zones = {};
        const titleResult = this.countOccurrences(parsed.title, variations);
        zones.title = { text: parsed.title, count: titleResult.totalCount, found: titleResult.totalCount > 0, weight: this.zoneWeights.title, weightedCount: titleResult.totalCount * this.zoneWeights.title };
        const metaResult = this.countOccurrences(parsed.metaDescription, variations);
        zones.metaDescription = { text: parsed.metaDescription, count: metaResult.totalCount, found: metaResult.totalCount > 0, weight: this.zoneWeights.metaDescription, weightedCount: metaResult.totalCount * this.zoneWeights.metaDescription };
        ['h1', 'h2', 'h3', 'h4', 'h5', 'h6'].forEach(level => {
            const headingsOfLevel = parsed.headings[level] || [];
            const analyzedHeadings = headingsOfLevel.map(h => {
                const result = this.countOccurrences(h.text, variations);
                return { text: h.text, count: result.totalCount, found: result.totalCount > 0, weight: this.zoneWeights[level], weightedCount: result.totalCount * this.zoneWeights[level] };
            });
            zones[level] = { items: analyzedHeadings, totalCount: analyzedHeadings.reduce((sum, h) => sum + h.count, 0), foundCount: analyzedHeadings.filter(h => h.found).length, totalItems: analyzedHeadings.length, weightedCount: analyzedHeadings.reduce((sum, h) => sum + h.weightedCount, 0) };
        });
        const bodyResult = this.countOccurrences(parsed.bodyText, variations);
        const bodyWords = this.extractHebrewWords(parsed.bodyText);
        zones.body = { count: bodyResult.totalCount, wordCount: bodyWords.length, weight: this.zoneWeights.body, weightedCount: bodyResult.totalCount * this.zoneWeights.body, positions: bodyResult.positions, variationCounts: bodyResult.variationCounts };
        let totalWeightedCount = zones.title.weightedCount + zones.metaDescription.weightedCount + zones.body.weightedCount;
        ['h1', 'h2', 'h3', 'h4', 'h5', 'h6'].forEach(level => { totalWeightedCount += zones[level].weightedCount; });
        let totalWeightedWords = zones.body.wordCount * this.zoneWeights.body;
        totalWeightedWords += this.extractHebrewWords(parsed.title).length * this.zoneWeights.title;
        totalWeightedWords += this.extractHebrewWords(parsed.metaDescription).length * this.zoneWeights.metaDescription;
        ['h1', 'h2', 'h3', 'h4', 'h5', 'h6'].forEach(level => {
            parsed.headings[level].forEach(h => { totalWeightedWords += this.extractHebrewWords(h.text).length * this.zoneWeights[level]; });
        });
        const weightedDensity = totalWeightedWords > 0 ? (totalWeightedCount / totalWeightedWords * 100) : 0;
        const simpleDensity = zones.body.wordCount > 0 ? (zones.body.count / zones.body.wordCount * 100) : 0;
        return { zones, totalWeightedCount, totalWeightedWords, weightedDensity: Math.round(weightedDensity * 100) / 100, simpleDensity: Math.round(simpleDensity * 100) / 100, totalOccurrences: zones.title.count + zones.metaDescription.count + zones.body.count + ['h1', 'h2', 'h3', 'h4', 'h5', 'h6'].reduce((sum, l) => sum + zones[l].totalCount, 0), totalWords: zones.body.wordCount };
    }
    
    calculateScore(density) {
        const [optimalMin, optimalMax] = this.options.optimalRange;
        const [warningMin, warningMax] = this.options.warningRange;
        if (density >= optimalMin && density <= optimalMax) return 100;
        else if (density >= warningMin && density < optimalMin) return 60 + ((density - warningMin) / (optimalMin - warningMin)) * 30;
        else if (density > optimalMax && density <= warningMax) return 60 + ((warningMax - density) / (warningMax - optimalMax)) * 30;
        else if (density < warningMin) return Math.max(0, 60 * (density / warningMin));
        else return Math.max(0, 60 - ((density - warningMax) * 20));
    }
    
    getStatus(density) {
        const [optimalMin, optimalMax] = this.options.optimalRange;
        const [warningMin, warningMax] = this.options.warningRange;
        if (density >= optimalMin && density <= optimalMax) return { code: 'ideal', label: 'אידיאלי', color: '#10b981', icon: '✅' };
        else if (density >= warningMin && density <= warningMax) return density < optimalMin ? { code: 'low', label: 'נמוך', color: '#f59e0b', icon: '⚠️' } : { code: 'high', label: 'גבוה', color: '#f59e0b', icon: '⚠️' };
        else if (density < warningMin) return { code: 'too_thin', label: 'דליל מדי', color: '#ef4444', icon: '🔴' };
        else return { code: 'stuffing', label: 'ספאם מילות מפתח', color: '#ef4444', icon: '🔴' };
    }
    
    generateSuggestions(analysisResult) {
        const suggestions = [];
        const { zones, weightedDensity } = analysisResult;
        const status = this.getStatus(weightedDensity);
        const [optimalMin, optimalMax] = this.options.optimalRange;
        if (!zones.title.found && zones.title.text) suggestions.push({ type: 'missing_title', severity: 'high', message: `מילת המפתח "${this.keyword}" חסרה בכותרת העמוד`, location: 'title', currentText: zones.title.text, action: 'add_keyword' });
        if (!zones.metaDescription.found && zones.metaDescription.text) suggestions.push({ type: 'missing_meta', severity: 'medium', message: `מילת המפתח חסרה בתיאור המטא`, location: 'meta_description', currentText: zones.metaDescription.text, action: 'add_keyword' });
        if (zones.h1.totalItems === 0) suggestions.push({ type: 'missing_h1', severity: 'high', message: 'חסרה כותרת H1 בעמוד', location: 'h1', action: 'create_h1' });
        else if (zones.h1.foundCount === 0) suggestions.push({ type: 'keyword_missing_h1', severity: 'high', message: `מילת המפתח חסרה ב-H1`, location: 'h1', currentText: zones.h1.items[0]?.text, action: 'add_keyword' });
        if (zones.h2.totalItems > 0 && zones.h2.foundCount === 0) suggestions.push({ type: 'keyword_missing_h2', severity: 'medium', message: `מילת המפתח לא מופיעה באף כותרת H2`, location: 'h2', action: 'add_keyword' });
        else if (zones.h2.totalItems > 2 && zones.h2.foundCount < Math.ceil(zones.h2.totalItems / 3)) suggestions.push({ type: 'low_h2_coverage', severity: 'low', message: `מילת המפתח מופיעה רק ב-${zones.h2.foundCount} מתוך ${zones.h2.totalItems} כותרות H2`, location: 'h2', action: 'add_keyword' });
        if (status.code === 'too_thin') { const targetCount = Math.ceil(zones.body.wordCount * optimalMin / 100); const addCount = targetCount - zones.body.count; suggestions.push({ type: 'add_occurrences', severity: 'high', message: `הוסף ${addCount} מופעים של מילת המפתח להגעה לצפיפות אופטימלית`, location: 'body', currentCount: zones.body.count, targetCount, action: 'increase_density' }); }
        else if (status.code === 'stuffing') { const targetCount = Math.floor(zones.body.wordCount * optimalMax / 100); const removeCount = zones.body.count - targetCount; suggestions.push({ type: 'remove_occurrences', severity: 'high', message: `הפחת ${removeCount} מופעים של מילת המפתח למניעת ספאם`, location: 'body', currentCount: zones.body.count, targetCount, action: 'decrease_density' }); }
        return suggestions;
    }
    
    analyze() {
        if (this._analysisResult) return this._analysisResult;
        const densityResult = this.calculateWeightedDensity();
        const score = this.calculateScore(densityResult.weightedDensity);
        const status = this.getStatus(densityResult.weightedDensity);
        const suggestions = this.generateSuggestions(densityResult);
        this._analysisResult = { keyword: this.keyword, variations: this.getKeywordVariations(this.keyword), totalWords: densityResult.totalWords, totalOccurrences: densityResult.totalOccurrences, simpleDensity: densityResult.simpleDensity, weightedDensity: densityResult.weightedDensity, score: Math.round(score), status, breakdown: densityResult.zones, suggestions, optimalRange: this.options.optimalRange, timestamp: new Date().toISOString() };
        return this._analysisResult;
    }
}

class SpamAnalyzer {
    constructor(htmlContent, keyword) {
        this.htmlContent = htmlContent;
        this.keyword = keyword;
        this.thresholds = { exactMatchRatio: 0.6, startsWithRatio: 0.5, minHeadersForAnalysis: 3, boldRatio: { safe: 0.2, warning: 0.4, spam: 1.0 }, contextRatio: { isolated: 1.2, contextual: 2.0 }, clusterWindow: 50, maxClusterOccurrences: 2 };
        this.hebrewPrefixes = ['ה', 'ב', 'ל', 'מ', 'ו', 'כ', 'ש', 'וה', 'וב', 'ול', 'שה', 'שב', 'של'];
        this._doc = null;
    }
    
    parseHTML() { if (this._doc) return this._doc; const parser = new DOMParser(); this._doc = parser.parseFromString(this.htmlContent, 'text/html'); return this._doc; }
    normalizeHebrew(text) { if (!text) return ''; return text.replace(/[\u0591-\u05C7]/g, '').replace(/[^\u0590-\u05FF\sa-zA-Z0-9]/g, ' ').replace(/\s+/g, ' ').trim(); }
    
    getKeywordVariations() {
        const normalized = this.normalizeHebrew(this.keyword);
        const words = normalized.split(/\s+/);
        const variations = new Set([normalized]);
        if (words.length === 1) {
            const word = words[0];
            this.hebrewPrefixes.forEach(prefix => variations.add(prefix + word));
            if (word.endsWith('ה')) { variations.add(word.slice(0, -1) + 'ות'); variations.add(word.slice(0, -1) + 'ת'); }
            variations.add(word + 'ים'); variations.add(word + 'ות');
            if (!word.startsWith('ה')) variations.add('ה' + word);
        }
        return Array.from(variations);
    }
    
    containsKeyword(text) {
        const normalizedText = this.normalizeHebrew(text);
        const variations = this.getKeywordVariations();
        return variations.some(variation => { try { const regex = new RegExp(variation.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi'); return regex.test(normalizedText); } catch (e) { return false; } });
    }
    
    startsWithKeyword(text) {
        const normalizedText = this.normalizeHebrew(text);
        const variations = this.getKeywordVariations();
        return variations.some(variation => { const normalizedVariation = this.normalizeHebrew(variation); return normalizedText.startsWith(normalizedVariation) || normalizedText.startsWith(normalizedVariation + ' '); });
    }
    
    analyzeHeaders() {
        const doc = this.parseHTML();
        const headers = [];
        const issues = [];
        ['h1', 'h2', 'h3', 'h4', 'h5', 'h6'].forEach((tag, index) => {
            doc.querySelectorAll(tag).forEach((el, i) => {
                const text = el.textContent.trim();
                if (text.length > 0) { // Only include non-empty headings
                    headers.push({ tag: tag.toUpperCase(), level: index + 1, text, id: `${tag}-${i}`, hasKeyword: this.containsKeyword(text), startsWithKeyword: this.startsWithKeyword(text) });
                }
            });
        });
        const subheaders = headers.filter(h => h.level > 1);
        const h1s = headers.filter(h => h.level === 1);
        const totalHeaders = headers.length;
        const exactMatchRatio = subheaders.length > 0 ? subheaders.filter(h => h.hasKeyword).length / subheaders.length : 0;
        const startsWithRatio = subheaders.length > 0 ? subheaders.filter(h => h.startsWithKeyword).length / subheaders.length : 0;
        let h1IsolationIssue = false;
        if (h1s.length > 0) {
            const h1Text = this.normalizeHebrew(h1s[0].text);
            const keywordNormalized = this.normalizeHebrew(this.keyword);
            const h1Words = h1Text.split(/\s+/).length;
            const keywordWords = keywordNormalized.split(/\s+/).length;
            if (this.containsKeyword(h1Text) && h1Words <= keywordWords + 1) {
                h1IsolationIssue = true;
                issues.push({ type: 'H1_ISOLATION', severity: 'medium', message: `כותרת H1 מכילה רק את מילת המפתח ללא הקשר נוסף`, affectedTags: [h1s[0].id], currentText: h1s[0].text, suggestion: 'הרחב את כותרת ה-H1 עם מילים נוספות' });
            }
        }
        if (subheaders.length >= this.thresholds.minHeadersForAnalysis) {
            if (exactMatchRatio > this.thresholds.exactMatchRatio) {
                const affectedHeaders = subheaders.filter(h => h.hasKeyword);
                issues.push({ type: 'REPETITIVE_PATTERN', severity: 'high', message: `${Math.round(exactMatchRatio * 100)}% מכותרות המשנה מכילות את מילת המפתח - זה נראה כספאם`, affectedTags: affectedHeaders.map(h => h.id), suggestion: 'גוון את הכותרות עם ביטויים שונים' });
            }
            if (startsWithRatio > this.thresholds.startsWithRatio) {
                const affectedHeaders = subheaders.filter(h => h.startsWithKeyword);
                issues.push({ type: 'LEADING_KEYWORD', severity: 'medium', message: `${Math.round(startsWithRatio * 100)}% מהכותרות מתחילות במילת המפתח`, affectedTags: affectedHeaders.map(h => h.id), suggestion: 'מקם את מילת המפתח במיקומים שונים בכותרות' });
            }
        }
        const headerSpamScore = Math.max(0, Math.min(100, 100 - (exactMatchRatio * 30) - (startsWithRatio * 20) - (h1IsolationIssue ? 10 : 0)));
        let status = 'good';
        if (headerSpamScore < 50) status = 'critical';
        else if (headerSpamScore < 70) status = 'warning';
        return { status, score: Math.round(headerSpamScore), metrics: { totalHeaders, subheaderCount: subheaders.length, headersWithKeyword: headers.filter(h => h.hasKeyword).length, exactMatchRatio: Math.round(exactMatchRatio * 100) / 100, startsWithKeywordRatio: Math.round(startsWithRatio * 100) / 100, h1IsolationIssue }, headers, issues };
    }
    
    analyzeEmphasis() {
        const doc = this.parseHTML();
        const issues = [];
        const variations = this.getKeywordVariations();
        const emphasisTags = [...doc.querySelectorAll('strong, b, em')];
        const bodyText = doc.body ? doc.body.textContent : '';
        let totalKeywordCount = 0;
        variations.forEach(variation => { try { const regex = new RegExp(variation.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi'); const matches = bodyText.match(regex); totalKeywordCount += matches ? matches.length : 0; } catch (e) {} });
        let boldedKeywordCount = 0;
        let isolatedBoldCount = 0;
        emphasisTags.forEach((el) => {
            const innerText = el.textContent.trim();
            const containsKw = this.containsKeyword(innerText);
            if (containsKw) {
                boldedKeywordCount++;
                const keywordLen = this.normalizeHebrew(this.keyword).length;
                const tagLen = this.normalizeHebrew(innerText).length;
                const contextRatio = tagLen / keywordLen;
                if (contextRatio <= this.thresholds.contextRatio.isolated) isolatedBoldCount++;
            }
        });
        const boldRatio = totalKeywordCount > 0 ? boldedKeywordCount / totalKeywordCount : 0;
        const contextScore = boldedKeywordCount > 0 ? Math.round((1 - (isolatedBoldCount / boldedKeywordCount)) * 100) : 100;
        const clusters = [];
        let status = 'good';
        if (boldRatio > this.thresholds.boldRatio.warning) {
            status = boldRatio > this.thresholds.boldRatio.spam * 0.6 ? 'critical' : 'warning';
            issues.push({ type: 'HIGH_BOLD_RATIO', severity: 'high', message: `${Math.round(boldRatio * 100)}% ממופעי מילת המפתח מודגשים - גבוה מדי`, boldedCount: boldedKeywordCount, totalCount: totalKeywordCount, suggestion: 'הסר הדגשות מחלק ממופעי מילת המפתח' });
        }
        if (isolatedBoldCount > 0 && isolatedBoldCount >= boldedKeywordCount * 0.5) {
            issues.push({ type: 'ISOLATED_BOLD', severity: 'medium', message: `${isolatedBoldCount} מתוך ${boldedKeywordCount} הדגשות הן מבודדות (רק מילת המפתח ללא הקשר)`, isolatedCount: isolatedBoldCount, suggestion: 'הרחב את ההדגשות לכלול משפטים שלמים' });
        }
        const emphasisSpamScore = Math.max(0, Math.min(100, 100 - (boldRatio * 50) - ((1 - contextScore / 100) * 30) - (clusters.length * 10)));
        return { status, score: Math.round(emphasisSpamScore), metrics: { totalKeywords: totalKeywordCount, boldedKeywords: boldedKeywordCount, boldRatio: Math.round(boldRatio * 100) / 100, isolatedBoldCount }, contextQuality: { score: contextScore, explanation: contextScore < 50 ? 'רוב ההדגשות הן תגיות מבודדות ללא הקשר סביב' : contextScore < 80 ? 'חלק מההדגשות מבודדות - כדאי להרחיב' : 'ההדגשות כוללות הקשר טוב' }, clustersDetected: clusters, issues };
    }
    
    analyze() {
        const headersAnalysis = this.analyzeHeaders();
        const emphasisAnalysis = this.analyzeEmphasis();
        const riskScore = Math.max(0, Math.min(100, ((100 - headersAnalysis.score) * 0.4) + ((100 - emphasisAnalysis.score) * 0.6)));
        let overallRisk = 'Low';
        if (riskScore > 60) overallRisk = 'High';
        else if (riskScore > 30) overallRisk = 'Medium';
        return { overall_spam_risk: overallRisk, risk_score: Math.round(riskScore), headers_analysis: headersAnalysis, emphasis_analysis: emphasisAnalysis, timestamp: new Date().toISOString() };
    }
}

/**
 * HeaderQualityScorer - Advanced header scoring algorithm (0-10 per header)
 * with dynamic pacing, relevance, penalties, and fix recommendations
 */
class HeaderQualityScorer {
    constructor(htmlContent, keyword) {
        this.htmlContent = htmlContent;
        this.keyword = keyword;
        this.hebrewPrefixes = ['ה', 'ב', 'ל', 'מ', 'ו', 'כ', 'ש', 'וה', 'וב', 'ול', 'שה', 'שב', 'של'];
        this._doc = null;
        this.globalContext = null;
    }
    
    parseHTML() {
        if (this._doc) return this._doc;
        const parser = new DOMParser();
        this._doc = parser.parseFromString(this.htmlContent, 'text/html');
        return this._doc;
    }
    
    normalizeHebrew(text) {
        if (!text) return '';
        return text.replace(/[\u0591-\u05C7]/g, '')
            .replace(/[^\u0590-\u05FF\sa-zA-Z0-9]/g, ' ')
            .replace(/\s+/g, ' ')
            .trim();
    }
    
    getKeywordVariations() {
        const normalized = this.normalizeHebrew(this.keyword);
        const words = normalized.split(/\s+/);
        const variations = new Set([normalized]);
        
        if (words.length === 1) {
            const word = words[0];
            this.hebrewPrefixes.forEach(prefix => variations.add(prefix + word));
            if (word.endsWith('ה')) {
                variations.add(word.slice(0, -1) + 'ות');
                variations.add(word.slice(0, -1) + 'ת');
            }
            variations.add(word + 'ים');
            variations.add(word + 'ות');
            if (!word.startsWith('ה')) variations.add('ה' + word);
        } else {
            // Multi-word keyword variations
            this.hebrewPrefixes.forEach(prefix => variations.add(prefix + normalized));
            variations.add(words.join(' '));
        }
        return Array.from(variations);
    }
    
    containsKeyword(text, exact = false) {
        const normalizedText = this.normalizeHebrew(text);
        if (exact) {
            const normalizedKeyword = this.normalizeHebrew(this.keyword);
            return normalizedText.includes(normalizedKeyword);
        }
        const variations = this.getKeywordVariations();
        return variations.some(variation => {
            try {
                const regex = new RegExp(variation.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
                return regex.test(normalizedText);
            } catch (e) { return false; }
        });
    }
    
    startsWithKeyword(text) {
        const normalizedText = this.normalizeHebrew(text);
        const variations = this.getKeywordVariations();
        return variations.some(variation => {
            const normalizedVariation = this.normalizeHebrew(variation);
            return normalizedText.startsWith(normalizedVariation) || 
                   normalizedText.startsWith(normalizedVariation + ' ');
        });
    }
    
    countKeywordOccurrences(text) {
        const normalizedText = this.normalizeHebrew(text);
        const normalizedKeyword = this.normalizeHebrew(this.keyword);
        const regex = new RegExp(normalizedKeyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
        const matches = normalizedText.match(regex);
        return matches ? matches.length : 0;
    }
    
    // Calculate global context for the entire page
    calculateGlobalContext() {
        if (this.globalContext) return this.globalContext;
        
        const doc = this.parseHTML();
        const body = doc.body;
        
        // Get all text content
        const clone = body.cloneNode(true);
        ['script', 'style', 'noscript'].forEach(sel => {
            clone.querySelectorAll(sel).forEach(el => el.remove());
        });
        const fullText = clone.textContent || '';
        const words = fullText.split(/\s+/).filter(w => w.length > 0);
        const totalWordCount = words.length;
        
        // Get all headers
        const allHeaders = [];
        ['h1', 'h2', 'h3', 'h4', 'h5', 'h6'].forEach((tag, level) => {
            doc.querySelectorAll(tag).forEach((el, i) => {
                const text = el.textContent.trim();
                if (text.length > 0) {
                    allHeaders.push({
                        tag: tag.toUpperCase(),
                        level: level + 1,
                        text,
                        element: el,
                        hasKeyword: this.containsKeyword(text),
                        hasExactKeyword: this.containsKeyword(text, true),
                        startsWithKeyword: this.startsWithKeyword(text)
                    });
                }
            });
        });
        
        const totalHeaders = allHeaders.length;
        const avgWordsPerSection = totalHeaders > 0 ? Math.round(totalWordCount / totalHeaders) : totalWordCount;
        
        // Determine structure health
        let structureHealth = 'Healthy';
        if (avgWordsPerSection < 80) structureHealth = 'Slightly Cluttered';
        else if (avgWordsPerSection < 50) structureHealth = 'Too Many Headers';
        else if (avgWordsPerSection > 500) structureHealth = 'Sparse';
        
        // Count headers with keyword
        const headersWithKeyword = allHeaders.filter(h => h.hasKeyword).length;
        const keywordRatio = totalHeaders > 0 ? headersWithKeyword / totalHeaders : 0;
        
        // Calculate per-tag spam ratios (this is the key fix!)
        const tagStats = {};
        ['H1', 'H2', 'H3', 'H4', 'H5', 'H6'].forEach(tag => {
            const headersOfType = allHeaders.filter(h => h.tag === tag);
            const withKeyword = headersOfType.filter(h => h.hasKeyword).length;
            const total = headersOfType.length;
            tagStats[tag] = {
                total,
                withKeyword,
                ratio: total > 0 ? withKeyword / total : 0
            };
        });
        
        console.log('📊 Per-tag spam stats:', tagStats);
        
        this.globalContext = {
            totalWordCount,
            totalHeaders,
            avgWordsPerSection,
            tagStats, // NEW: per-tag statistics
            structureHealth,
            headersWithKeyword,
            keywordRatio,
            allHeaders
        };
        
        return this.globalContext;
    }
    
    // Calculate word count between headers using simple text extraction
    calculateWordsBetweenHeaders(doc, allHeaders) {
        if (!allHeaders || allHeaders.length === 0) return [];
        
        // Simple approach: get all text and calculate positions
        const bodyText = doc.body.textContent || '';
        const totalWords = bodyText.split(/\s+/).filter(w => w.length > 0).length;
        
        // If we can't properly calculate, estimate based on total words / headers
        const avgWordsPerSection = Math.round(totalWords / allHeaders.length);
        
        // Return estimated word counts - first element is 0 (before first header)
        // Then estimate reasonable word counts based on average
        const wordCounts = allHeaders.map((header, index) => {
            if (index === 0) return 0; // First header has no content before it
            // Estimate based on average, with some variation
            return Math.max(50, avgWordsPerSection);
        });
        
        console.log('📊 Word counts between headers (estimated):', {
            totalWords,
            avgWordsPerSection,
            numHeaders: allHeaders.length,
            wordCounts: wordCounts.slice(0, 5)
        });
        
        return wordCounts;
    }
    
    // Score a single header (0-10) - NEW ALGORITHM with PER-TAG SPAM MODE
    scoreHeader(header, index, allHeaders, wordsSinceLast, globalContext) {
        let score = 5; // Base score
        const issues = [];
        const notes = [];
        
        const text = header.text;
        const tag = header.tag;
        const charCount = text.length;
        
        // Get spam ratio for THIS specific header type (H1, H2, H3...)
        const tagStat = globalContext.tagStats?.[tag] || { total: 0, withKeyword: 0, ratio: 0 };
        const tagSpamRatio = tagStat.ratio;
        
        // H1 is NEVER in spam mode - you always want keyword in H1!
        // Only H2+ can be in spam mode
        const isSpamMode = tag !== 'H1' && tagSpamRatio > 0.35;
        
        // Debug log (only for first header of each type)
        const isFirstOfType = allHeaders.findIndex(h => h.tag === tag) === index;
        if (isFirstOfType) {
            console.log(`🎯 ${tag} Scoring:`, {
                tagSpamRatio: Math.round(tagSpamRatio * 100) + '%',
                isSpamMode,
                total: tagStat.total,
                withKeyword: tagStat.withKeyword
            });
        }
        
        // ========================================
        // TWO DIFFERENT MODES BASED ON SPAM LEVEL
        // ========================================
        
        if (isSpamMode) {
            // ===== SPAM MODE (>35% of this tag type has keyword) =====
            // In spam mode: having keyword is BAD, not having it is GOOD
            
            if (header.hasKeyword) {
                // Calculate linear penalty based on how bad the spam is for THIS tag type
                // At 35%: penalty = 0, At 88%: penalty = (0.88-0.35)*10 = 5.3
                const spamPenalty = Math.round((tagSpamRatio - 0.35) * 10);
                score -= spamPenalty;
                issues.push('Spam');
                
                const headersToFix = Math.ceil((tagSpamRatio - 0.35) * tagStat.total);
                notes.push(`🔴 ספאם ב-${tag}! ${Math.round(tagSpamRatio * 100)}% מכותרות ${tag} עם מילת מפתח`);
                notes.push(`הסר מילת מפתח מ-${headersToFix} כותרות ${tag}`);
                notes.push(`עונש: -${spamPenalty} נקודות`);
                
            } else {
                // Header WITHOUT keyword in spam mode = GOOD!
                score += 3;
                notes.push('✅ כותרת ללא מילת מפתח - מצוין במצב ספאם (+3)');
            }
            
            // H1 is special - should still have keyword even in spam mode
            if (tag === 'H1') {
                if (header.hasKeyword) {
                    score += 4; // Restore points for H1
                    notes.push('H1 עם מילת מפתח - תקין (+4)');
                } else {
                    score -= 2;
                    issues.push('Missing Keyword H1');
                    notes.push('H1 חייב להכיל מילת מפתח (-2)');
                }
            }
            
        } else {
            // ===== NORMAL MODE (≤35% headers have keyword) =====
            // In normal mode: having keyword is GOOD
            
            if (header.hasExactKeyword) {
                score += 3;
                notes.push('מילת מפתח מדויקת (+3)');
            } else if (header.hasKeyword) {
                score += 2;
                notes.push('וריאציה של מילת מפתח (+2)');
            }
            
            // H1 Bonus in normal mode
            if (tag === 'H1' && header.hasKeyword) {
                score += 1;
                notes.push('בונוס H1 (+1)');
            }
            
            // H1 without keyword
            if (tag === 'H1' && !header.hasKeyword) {
                score -= 2;
                issues.push('Missing Keyword H1');
                notes.push('H1 ללא מילת מפתח (-2)');
            }
        }
        
        // ===== UNIVERSAL SCORING (applies in both modes) =====
        
        // Length scoring
        if (charCount >= 20 && charCount <= 70) {
            score += 1;
            notes.push('אורך אידיאלי (+1)');
        } else if (charCount < 10) {
            score -= 1;
            notes.push('כותרת קצרה מדי (-1)');
        } else if (charCount > 100) {
            score -= 1;
            issues.push('Too Long');
            notes.push('כותרת ארוכה מדי (-1)');
        }
        
        // Short & Spammy: Header is just the keyword (always bad)
        const normalizedText = this.normalizeHebrew(text);
        const normalizedKeyword = this.normalizeHebrew(this.keyword);
        const textWords = normalizedText.split(/\s+/).filter(w => w.length > 0);
        const keywordWords = normalizedKeyword.split(/\s+/).filter(w => w.length > 0);
        
        if (textWords.length <= keywordWords.length + 1 && header.hasKeyword) {
            score -= 2;
            issues.push('Short & Spammy');
            notes.push('כותרת קצרה מדי - רק מילת המפתח (-2)');
        }
        
        // Keyword stuffing: Keyword appears twice in same header
        const keywordCount = this.countKeywordOccurrences(text);
        if (keywordCount >= 2) {
            score -= 2;
            issues.push('Keyword Stuffing');
            notes.push('מילת המפתח מופיעה פעמיים (-2)');
        }
        
        // Ensure score is between 0 and 10
        score = Math.max(0, Math.min(10, score));
        
        // Determine label
        let label = 'Weak';
        if (score >= 8) label = 'Excellent';
        else if (score >= 6) label = 'Good';
        else if (score < 4) label = 'Critical';
        
        return {
            tag,
            text,
            score,
            label,
            issues,
            notes,
            wordsSinceLast,
            charCount
        };
    }
    
    // Generate fix suggestion based on issues
    generateSuggestion(scoredHeader) {
        const { issues, tag, text } = scoredHeader;
        
        if (issues.length === 0) return null;
        
        // Priority order of suggestions - SPAM issues first (most critical)
        if (issues.includes('Spam')) {
            // Generate alternative header without keyword
            const escapedKeyword = this.keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const textWithoutKeyword = text.replace(new RegExp(escapedKeyword, 'gi'), '').trim();
            const cleanText = textWithoutKeyword.replace(/\s+/g, ' ').replace(/^[-–—:,]\s*/, '').trim();
            
            // Create actionable suggestion
            if (cleanText.length > 5) {
                return {
                    type: 'Spam',
                    message: `🚫 הסר את "${this.keyword}" מכותרת זו`,
                    example: `✏️ שנה ל: "${cleanText}"`
                };
            } else {
                return {
                    type: 'Spam',
                    message: `🚫 שכתב כותרת זו ללא "${this.keyword}"`,
                    example: `✏️ דוגמה: "יתרונות וחסרונות" או "מה חשוב לדעת?"`
                };
            }
        }
        
        if (issues.includes('Short & Spammy')) {
            return {
                type: 'Short & Spammy',
                message: '📝 הכותרת קצרה מדי. הוסף הקשר או שנה לשאלה.',
                example: `✏️ נסח: "${text} - המדריך המלא" או "כל מה שצריך לדעת על ${text}"`
            };
        }
        
        if (issues.includes('Missing Keyword H1')) {
            return {
                type: 'Missing Keyword',
                message: `⚠️ H1 חייב להכיל "${this.keyword}"`,
                example: `✏️ הוסף את מילת המפתח לכותרת הראשית`
            };
        }
        
        if (issues.includes('Thin Content')) {
            return {
                type: 'Thin Content',
                message: '📄 תוכן דליל מתחת לכותרת זו',
                example: '✏️ הוסף עוד תוכן או מזג עם הקטע הקודם'
            };
        }
        
        if (issues.includes('Keyword Stuffing')) {
            return {
                type: 'Keyword Stuffing',
                message: '🔄 מילת המפתח מופיעה פעמיים',
                example: '✏️ הסר מופע אחד של מילת המפתח'
            };
        }
        
        if (issues.includes('Too Long')) {
            return {
                type: 'Too Long',
                message: '✂️ הכותרת ארוכה מדי (מעל 100 תווים)',
                example: null
            };
        }
        
        if (issues.includes('Too Short')) {
            return {
                type: 'Too Short',
                message: 'הכותרת קצרה מדי. הוסף הקשר או פירוט.',
                example: null
            };
        }
        
        return null;
    }
    
    // Main analysis method
    analyze() {
        const doc = this.parseHTML();
        const globalContext = this.calculateGlobalContext();
        const allHeaders = globalContext.allHeaders;
        
        // Calculate approximate word counts between headers
        const wordCounts = [];
        let prevHeaderEnd = 0;
        
        // Simplified word count calculation using DOM order
        const bodyText = doc.body?.textContent || '';
        const words = bodyText.split(/\s+/).filter(w => w.length > 0);
        
        allHeaders.forEach((header, index) => {
            // Approximate: divide total words evenly for now
            const approximateWordsBefore = index === 0 ? 
                Math.floor(globalContext.avgWordsPerSection * 0.3) :
                Math.floor(globalContext.avgWordsPerSection);
            wordCounts.push(approximateWordsBefore);
        });
        
        // Score each header
        const scoredHeaders = allHeaders.map((header, index) => {
            const wordsSinceLast = wordCounts[index] || 0;
            const scored = this.scoreHeader(header, index, allHeaders, wordsSinceLast, globalContext);
            scored.suggestion = this.generateSuggestion(scored);
            return scored;
        });
        
        // Calculate overall score
        const avgScore = scoredHeaders.length > 0 ?
            scoredHeaders.reduce((sum, h) => sum + h.score, 0) / scoredHeaders.length : 0;
        
        // Count issues
        const weakHeaders = scoredHeaders.filter(h => h.score < 6).length;
        const criticalHeaders = scoredHeaders.filter(h => h.score < 4).length;
        
        return {
            global_metrics: {
                total_words: globalContext.totalWordCount,
                total_headers: globalContext.totalHeaders,
                avg_words_per_section: globalContext.avgWordsPerSection,
                structure_health: globalContext.structureHealth,
                headers_with_keyword: globalContext.headersWithKeyword,
                keyword_ratio: Math.round(globalContext.keywordRatio * 100),
                tag_stats: globalContext.tagStats // NEW: per-tag spam stats
            },
            headers_analysis: scoredHeaders,
            summary: {
                average_score: Math.round(avgScore * 10) / 10,
                weak_headers: weakHeaders,
                critical_headers: criticalHeaders,
                needs_attention: weakHeaders > 0
            }
        };
    }
}

/**
 * IntroAnalyzer - Analyzes the first 500 words (hook/intro) with adaptive logic
 * for tool/calculator pages
 */
class IntroAnalyzer {
    constructor(htmlContent, keyword, globalContext = null) {
        this.htmlContent = htmlContent;
        this.keyword = keyword;
        this.globalContext = globalContext;
        this.hebrewPrefixes = ['ה', 'ב', 'ל', 'מ', 'ו', 'כ', 'ש', 'וה', 'וב', 'ול', 'שה', 'שב', 'של'];
        this._doc = null;
        this.pageType = null;
    }
    
    parseHTML() {
        if (this._doc) return this._doc;
        const parser = new DOMParser();
        this._doc = parser.parseFromString(this.htmlContent, 'text/html');
        return this._doc;
    }
    
    normalizeHebrew(text) {
        if (!text) return '';
        return text.replace(/[\u0591-\u05C7]/g, '')
            .replace(/[^\u0590-\u05FF\sa-zA-Z0-9]/g, ' ')
            .replace(/\s+/g, ' ')
            .trim();
    }
    
    getKeywordVariations() {
        const normalized = this.normalizeHebrew(this.keyword);
        const words = normalized.split(/\s+/);
        const variations = new Set([normalized]);
        
        if (words.length === 1) {
            const word = words[0];
            this.hebrewPrefixes.forEach(prefix => variations.add(prefix + word));
            if (word.endsWith('ה')) {
                variations.add(word.slice(0, -1) + 'ות');
                variations.add(word.slice(0, -1) + 'ת');
            }
            variations.add(word + 'ים');
            variations.add(word + 'ות');
            if (!word.startsWith('ה')) variations.add('ה' + word);
        }
        return Array.from(variations);
    }
    
    // Detect if page is a Tool/Calculator type
    detectPageType() {
        if (this.pageType) return this.pageType;
        
        const doc = this.parseHTML();
        const toolKeywords = ['מחשבון', 'סימולטור', 'כלי', 'השוואת', 'calculator', 'tool', 'simulator'];
        
        // Check title/H1
        const title = doc.querySelector('title')?.textContent?.toLowerCase() || '';
        const h1 = doc.querySelector('h1')?.textContent?.toLowerCase() || '';
        
        const isTitleTool = toolKeywords.some(kw => title.includes(kw) || h1.includes(kw));
        
        // Check for form elements in first 600 words
        const body = doc.body;
        const inputs = body.querySelectorAll('input, select, button');
        
        // Count interactive elements
        let interactiveCount = 0;
        const walker = document.createTreeWalker(body, NodeFilter.SHOW_TEXT, null, false);
        let wordCount = 0;
        
        while (walker.nextNode() && wordCount < 600) {
            const text = walker.currentNode.textContent.trim();
            wordCount += text.split(/\s+/).filter(w => w.length > 0).length;
        }
        
        // Check how many inputs are in the early content
        inputs.forEach(input => {
            interactiveCount++;
        });
        
        const isFormHeavy = interactiveCount > 5;
        
        this.pageType = (isTitleTool || isFormHeavy) ? 'Tool/Calculator' : 'Article';
        return this.pageType;
    }
    
    // Find first meaningful text block (for tool pages)
    findFirstMeaningfulBlock() {
        const doc = this.parseHTML();
        const paragraphs = doc.querySelectorAll('p');
        
        for (const p of paragraphs) {
            const text = p.textContent.trim();
            const words = text.split(/\s+/).filter(w => w.length > 0);
            
            // Skip if inside label, option, or form element
            const parent = p.parentElement;
            if (parent && (parent.tagName === 'LABEL' || parent.tagName === 'OPTION')) {
                continue;
            }
            
            // Look for paragraph with 20+ words
            if (words.length >= 20) {
                return {
                    text,
                    wordCount: words.length,
                    element: p
                };
            }
        }
        
        return null;
    }
    
    // Calculate the zone limit based on content length
    calculateZoneLimit(totalWords) {
        if (totalWords < 600) {
            return Math.floor(totalWords * 0.5);
        }
        return 500;
    }
    
    // Get intro zone text
    getIntroZoneText(limit) {
        const doc = this.parseHTML();
        const pageType = this.detectPageType();
        
        if (pageType === 'Tool/Calculator') {
            // For tool pages, find first meaningful block
            const meaningfulBlock = this.findFirstMeaningfulBlock();
            if (meaningfulBlock) {
                return {
                    text: meaningfulBlock.text,
                    wordCount: meaningfulBlock.wordCount,
                    source: 'First meaningful text block (Tool Mode)',
                    skippedUIElements: true
                };
            }
        }
        
        // Standard article mode: get first N words
        const body = doc.body;
        const clone = body.cloneNode(true);
        
        // Remove non-content elements
        ['script', 'style', 'noscript', 'label', 'option'].forEach(sel => {
            clone.querySelectorAll(sel).forEach(el => el.remove());
        });
        
        const fullText = clone.textContent || '';
        const words = fullText.split(/\s+/).filter(w => w.length > 0);
        const zoneWords = words.slice(0, limit);
        
        return {
            text: zoneWords.join(' '),
            wordCount: zoneWords.length,
            source: `First ${limit} words`,
            skippedUIElements: false
        };
    }
    
    // Calculate Time to First Keyword (TTFK)
    calculateTTFK(zoneText, zoneWordCount) {
        const normalizedText = this.normalizeHebrew(zoneText);
        const variations = this.getKeywordVariations();
        
        let firstOccurrenceIndex = -1;
        
        for (const variation of variations) {
            try {
                const regex = new RegExp(variation.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
                const match = regex.exec(normalizedText);
                
                if (match) {
                    // Calculate word position
                    const textBefore = normalizedText.substring(0, match.index);
                    const wordsBefore = textBefore.split(/\s+/).filter(w => w.length > 0).length;
                    
                    if (firstOccurrenceIndex === -1 || wordsBefore < firstOccurrenceIndex) {
                        firstOccurrenceIndex = wordsBefore;
                    }
                }
            } catch (e) {}
        }
        
        // Calculate percentage position
        const percentPosition = zoneWordCount > 0 && firstOccurrenceIndex >= 0 ?
            Math.round((firstOccurrenceIndex / zoneWordCount) * 100) : -1;
        
        // Determine rating
        let rating = 'Not Found';
        if (firstOccurrenceIndex >= 0) {
            const threshold = Math.min(zoneWordCount * 0.1, 50);
            if (firstOccurrenceIndex <= threshold) {
                rating = 'Excellent';
            } else if (firstOccurrenceIndex <= zoneWordCount * 0.25) {
                rating = 'Good';
            } else if (firstOccurrenceIndex <= zoneWordCount * 0.5) {
                rating = 'Adequate';
            } else {
                rating = 'Late';
            }
        }
        
        return {
            wordIndex: firstOccurrenceIndex,
            percentPosition,
            rating
        };
    }
    
    // Calculate local density in intro zone
    calculateLocalDensity(zoneText, zoneWordCount) {
        const normalizedText = this.normalizeHebrew(zoneText);
        const variations = this.getKeywordVariations();
        
        let totalOccurrences = 0;
        
        for (const variation of variations) {
            try {
                const regex = new RegExp(variation.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
                const matches = normalizedText.match(regex);
                if (matches) {
                    totalOccurrences += matches.length;
                }
            } catch (e) {}
        }
        
        const density = zoneWordCount > 0 ? (totalOccurrences / zoneWordCount) * 100 : 0;
        
        // Determine optimal range based on content length
        let optimalMin = 2;
        let optimalMax = 4;
        
        if (zoneWordCount < 300) {
            optimalMin = 3;
            optimalMax = 5;
        }
        
        let status = 'optimal';
        if (density < optimalMin) {
            status = 'low';
        } else if (density > optimalMax) {
            status = 'high';
        }
        
        return {
            occurrences: totalOccurrences,
            density: Math.round(density * 100) / 100,
            status,
            optimalRange: [optimalMin, optimalMax]
        };
    }
    
    // Main analysis method
    analyze() {
        const doc = this.parseHTML();
        const pageType = this.detectPageType();
        
        // Get total word count
        const body = doc.body;
        const clone = body.cloneNode(true);
        ['script', 'style', 'noscript'].forEach(sel => {
            clone.querySelectorAll(sel).forEach(el => el.remove());
        });
        const fullText = clone.textContent || '';
        const totalWords = fullText.split(/\s+/).filter(w => w.length > 0).length;
        
        // Calculate zone limit
        const zoneLimit = this.calculateZoneLimit(totalWords);
        
        // Get intro zone text
        const introZone = this.getIntroZoneText(zoneLimit);
        
        // Calculate TTFK
        const ttfk = this.calculateTTFK(introZone.text, introZone.wordCount);
        
        // Calculate local density
        const localDensity = this.calculateLocalDensity(introZone.text, introZone.wordCount);
        
        // Calculate overall intro score (0-100)
        let score = 50; // Base score
        
        // TTFK scoring (up to 40 points)
        if (ttfk.rating === 'Excellent') score += 40;
        else if (ttfk.rating === 'Good') score += 30;
        else if (ttfk.rating === 'Adequate') score += 15;
        else if (ttfk.rating === 'Late') score += 5;
        else score -= 20; // Not found
        
        // Density scoring (up to 30 points)
        if (localDensity.status === 'optimal') score += 30;
        else if (localDensity.status === 'low') score += 10;
        else score += 5; // High density
        
        // Page type adjustment
        let note = null;
        if (pageType === 'Tool/Calculator') {
            note = `זוהה עמוד כלי/מחשבון. הניתוח התבסס על הפסקה המשמעותית הראשונה.`;
            if (introZone.skippedUIElements) {
                note += ` דילגנו על אלמנטי UI.`;
            }
        }
        
        // Determine verdict
        let verdict = 'Weak';
        if (score >= 80) verdict = 'Strong Hook';
        else if (score >= 60) verdict = 'Adequate';
        
        score = Math.max(0, Math.min(100, score));
        
        return {
            page_type: pageType,
            zone_checked: introZone.source,
            zone_word_count: introZone.wordCount,
            total_words: totalWords,
            score: Math.round(score),
            verdict,
            ttfk: {
                first_occurrence_index: ttfk.wordIndex,
                percent_position: ttfk.percentPosition,
                rating: ttfk.rating
            },
            local_density: {
                occurrences: localDensity.occurrences,
                density: localDensity.density + '%',
                status: localDensity.status,
                optimal_range: localDensity.optimalRange.map(v => v + '%').join('-')
            },
            note
        };
    }
}

console.log('🚀 KeywordDensityAnalyzer, SpamAnalyzer, HeaderQualityScorer & IntroAnalyzer loaded');
    </script>

    <script>
        // ============ State ============
        let pages = [];
        let agents = {};
        let selectedPage = null;
        let selectedAgent = null;
        let currentStep = 0;
        let currentMode = 'cursor';
        let isRunning = false;
        let expectedReportPath = null;
        let pollInterval = null;
        let pageInfoCache = {}; // Cache for page info including word counts

        // ============ Floating Tooltip Functions ============
        
        function showFloatingTooltip(event, tooltipId) {
            const tooltip = document.getElementById(tooltipId);
            if (!tooltip) return;
            
            tooltip.style.display = 'block';
            
            // Position tooltip near the mouse but ensure it stays in viewport
            const rect = event.target.getBoundingClientRect();
            const tooltipRect = tooltip.getBoundingClientRect();
            
            // Position above the element
            let top = rect.top - tooltipRect.height - 10;
            let left = rect.left - tooltipRect.width / 2 + rect.width / 2;
            
            // Keep within viewport
            if (top < 10) {
                top = rect.bottom + 10; // Show below if no room above
            }
            if (left < 10) left = 10;
            if (left + tooltipRect.width > window.innerWidth - 10) {
                left = window.innerWidth - tooltipRect.width - 10;
            }
            
            tooltip.style.top = top + 'px';
            tooltip.style.left = left + 'px';
        }
        
        function hideFloatingTooltip(tooltipId) {
            const tooltip = document.getElementById(tooltipId);
            if (tooltip) {
                tooltip.style.display = 'none';
            }
        }
        
        // ============ Helper Functions for New Folder Structure ============
        
        function getPageFolder(pagePath) {
            // pagePath might use \ on Windows or / on other systems
            // Normalize to forward slashes first
            const normalizedPath = pagePath.replace(/\\/g, '/');
            const parts = normalizedPath.split('/');
            parts.pop(); // Remove filename
            return parts.join('/');
        }
        
        function getAgentStepCount(agent) {
            // Count steps from both old and new formats
            if (!agent) return 0;
            if (agent.steps && agent.steps.length > 0) {
                return agent.steps.length;
            }
            let count = 0;
            for (let i = 1; i <= 10; i++) {
                if (agent[`step${i}`]) count++;
            }
            return count;
        }
        
        function isAgentFourStep(agent) {
            return agent?.type === 'four-step' || getAgentStepCount(agent) === 4;
        }
        
        /**
         * Generic step runner - works for ANY step number.
         * Uses the new /api/workflow/step/<n> endpoint with composite key support.
         */
        async function runStepGeneric(stepNum) {
            if (!selectedPage || !selectedAgent) {
                showToast('בחר עמוד וסוכן', 'error');
                return;
            }
            
            const totalSteps = getAgentStepCount(selectedAgent);
            if (stepNum > totalSteps) {
                showToast(`סוכן זה תומך רק ב-${totalSteps} שלבים`, 'error');
                return;
            }
            
            currentMode = document.getElementById('modeSelect')?.value || 'claude';
            isRunning = true;
            currentStep = stepNum;
            
            updateStatusDisplay('running', `מריץ שלב ${stepNum}...`);
            showPromptButton(`step${stepNum}`);
            
            // Use the new generic step endpoint
            const result = await apiCall(`/api/workflow/step/${stepNum}`, {
                method: 'POST',
                body: JSON.stringify({
                    agent_id: selectedAgent.id,
                    page_path: selectedPage.path,
                    keyword: selectedPage.keywords || selectedPage.name,
                    mode: currentMode,
                    full_auto: fullAutoMode || combinedAutoMode,
                    total_steps: totalSteps
                })
            });
            
            if (result.success) {
                if (result.blocked) {
                    showToast(`שלב ${stepNum} כבר רץ`, 'warning');
                    return;
                }
                
                // Show work status panel
                showWorkStatusPanel();
                const fullAutoLabel = (fullAutoMode || combinedAutoMode) ? ' 🚀 Full Auto' : '';
                updateWorkStatusTitle(`📄 ${selectedPage.name?.replace('.html', '')} - שלב ${stepNum}/${totalSteps} רץ...${fullAutoLabel}`);
                setWorkStatusDot('running');
                showStopButton();
                startWorkLogPolling();
                startStatusPolling();
                
                // Start SSE listener for step events (especially important for Full Auto)
                if (fullAutoMode || combinedAutoMode) {
                    startStepEventListener();
                }
                
                // Track locally
                localRunningPages[selectedPage.path] = { step: stepNum, started: Date.now() };
                renderPageList();
                
                showToast(`שלב ${stepNum} הופעל`, 'success');
            } else {
                isRunning = false;
                updateStatusDisplay('error', result.error || 'שגיאה');
                showToast(result.error || 'שגיאה', 'error');
            }
        }
        
        function isAgentSixStep(agent) {
            return agent?.type === 'six-step' || getAgentStepCount(agent) === 6;
        }
        
        function getAgentFolder(pagePath, agentConfig) {
            // Returns the agent folder for a page
            // e.g., "דפים לשינוי/הלוואה בצ_יקים/שיווק אטומי"
            const pageFolder = getPageFolder(pagePath);
            const agentFolderName = agentConfig?.folder_name || agentConfig?.name || 'שיווק אטומי';
            return `${pageFolder}/${agentFolderName}`;
        }
        
        // ============ API Calls ============
        const API_BASE = '';

        // Fix invalid HTML: <p><style> and <p><script> wrappers from WordPress
        function cleanupInvalidHtml(html) {
            if (!html) return html;
            
            const originalLen = html.length;
            const hadPStyle = html.includes('<p><style') || html.includes('<p>\n<style');
            
            // Remove <p> wrapping <style> tags
            html = html.replace(/<p>\s*(<style[^>]*>)/gi, '$1');
            html = html.replace(/(<\/style>)\s*<\/p>/gi, '$1');
            
            // Remove <p> wrapping <script> tags
            html = html.replace(/<p>\s*(<script[^>]*>)/gi, '$1');
            html = html.replace(/(<\/script>)\s*<\/p>/gi, '$1');
            
            // Remove <p> wrapping block elements
            html = html.replace(/<p>\s*(<(?:div|table|section|article|aside|header|footer|nav|ul|ol|dl|figure|figcaption|blockquote|pre|hr|form)[^>]*>)/gi, '$1');
            html = html.replace(/(<\/(?:div|table|section|article|aside|header|footer|nav|ul|ol|dl|figure|figcaption|blockquote|pre|form)>)\s*<\/p>/gi, '$1');
            
            if (hadPStyle) {
                console.log('🧹 HTML Cleanup: Removed <p><style> wrappers', {
                    originalLen,
                    newLen: html.length,
                    diff: originalLen - html.length,
                    stillHasPStyle: html.includes('<p><style')
                });
            }
            
            return html;
        }

        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    headers: { 'Content-Type': 'application/json' },
                    ...options
                });
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                showToast('שגיאה בתקשורת עם השרת', 'error');
                return { success: false, error: error.message };
            }
        }

        // ============ Keywords Research ============
        let keywordsState = {
            keywords: [],
            clusters: [],
            isLoading: false,
            lastFetch: null
        };
        
        // Toggle keywords panel for a specific page
        async function togglePageKeywords(pagePath) {
            // Find the page item and its keywords panel
            const pageItem = document.querySelector(`.page-item[data-path="${pagePath.replace(/\\/g, '\\\\')}"]`);
            if (!pageItem) return;
            
            const panel = pageItem.querySelector('.page-keywords-panel');
            const loadingEl = panel.querySelector('.keywords-loading');
            const contentEl = panel.querySelector('.keywords-content');
            
            // Toggle visibility
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                openKeywordsPanels.add(pagePath);  // Track as open
                
                // Check if already has content
                if (contentEl.innerHTML.trim()) {
                    return; // Already loaded, just show
                }
                
                // Check if keywords exist in cache
                const cachedInfo = pageInfoCache[pagePath];
                if (cachedInfo && cachedInfo.fetched_keywords && cachedInfo.fetched_keywords.final_keywords?.length > 0) {
                    // Show from cache
                    displayPageKeywords(contentEl, cachedInfo.fetched_keywords, pagePath);
                } else {
                    // Need to fetch - find the page data and keyword
                    const page = pages.find(p => p.path === pagePath);
                    
                    // Try to get keyword from multiple sources
                    let keyword = page?.keyword;
                    
                    // Check pageInfoCache
                    if (!keyword && pageInfoCache[pagePath]) {
                        keyword = pageInfoCache[pagePath].keyword || pageInfoCache[pagePath].main_keyword;
                    }
                    
                    // If still no keyword, try to fetch page_info
                    if (!keyword) {
                        try {
                            const infoResult = await apiCall(`/api/page/info?path=${encodeURIComponent(pagePath)}`);
                            if (infoResult.success && infoResult.has_info && infoResult.info.keyword) {
                                keyword = infoResult.info.keyword;
                                // Update cache
                                if (!pageInfoCache[pagePath]) pageInfoCache[pagePath] = {};
                                pageInfoCache[pagePath].keyword = keyword;
                            }
                        } catch (e) {
                            console.error('Error fetching page info:', e);
                        }
                    }
                    
                    if (!keyword) {
                        contentEl.innerHTML = '<div style="color: var(--warning);">אין מילת מפתח מוגדרת לעמוד ב-page_info.json</div>';
                        return;
                    }
                    
                    // Fetch keywords
                    loadingEl.style.display = 'block';
                    contentEl.innerHTML = '';
                    
                    // Get page URL for rank tracking
                    const pageUrl = pageInfoCache[pagePath]?.url || page?.url || '';
                    
                    console.log('🔍 [Keywords Fetch] Starting...', 'keyword:', keyword, 'pageUrl:', pageUrl, 'pagePath:', pagePath);
                    
                    try {
                        // Fetch from API with rank tracking
                        const fetchResult = await apiCall('/api/keywords/fetch', {
                            method: 'POST',
                            body: JSON.stringify({ 
                                keyword: keyword,
                                page_url: pageUrl,  // For rank checking
                                page_path: pagePath  // For saving rank history
                            })
                        });
                        
                        console.log('📊 [Keywords Fetch] Result:', 
                            'success:', fetchResult.success,
                            'autocomplete:', fetchResult.autocomplete?.length,
                            'related:', fetchResult.related?.length,
                            'rank_position:', fetchResult.rank_position,
                            'full result:', JSON.stringify(fetchResult, null, 2));
                        
                        if (!fetchResult.success) {
                            throw new Error(fetchResult.error || 'שגיאה בשליפה');
                        }
                        
                        // Process keywords - send sources separately for color coding
                        const processResult = await apiCall('/api/keywords/process', {
                            method: 'POST',
                            body: JSON.stringify({
                                autocomplete: fetchResult.autocomplete || [],
                                related: fetchResult.related || [],
                                main_keyword: keyword
                            })
                        });
                        
                        if (!processResult.success) {
                            throw new Error(processResult.error || 'שגיאה בעיבוד');
                        }
                        
                        // Save to page_info (include rank position, AI results, competitor data)
                        console.log('💾 [Keywords Save] Saving keywords for:', pagePath);
                        const saveResult = await apiCall('/api/keywords/save', {
                            method: 'POST',
                            body: JSON.stringify({
                                page_path: pagePath,
                                keywords_data: {
                                    timestamp: new Date().toISOString(),
                                    main_keyword: keyword,
                                    clusters: processResult.clusters,
                                    final_keywords: processResult.final_keywords,
                                    unique_topics: processResult.unique_topics,
                                    rank_position: fetchResult.rank_position || null,
                                    rank_checked_url: pageUrl,
                                    organic_results: fetchResult.organic_results || [],
                                    ai_mode_results: fetchResult.ai_mode_results || [],
                                    ai_rank_position: fetchResult.ai_rank_position || null,
                                    competitor_data: fetchResult.competitor_data || []
                                }
                            })
                        });
                        
                        if (!saveResult.success) {
                            console.error('❌ [Keywords Save] Failed:', saveResult.error);
                            showToast('מילות מפתח נטענו אבל לא נשמרו! ' + (saveResult.error || ''), 'warning');
                        } else {
                            console.log('✅ [Keywords Save] Saved successfully!');
                        }
                        
                        // Update cache
                        if (!pageInfoCache[pagePath]) pageInfoCache[pagePath] = {};
                        pageInfoCache[pagePath].fetched_keywords = {
                            final_keywords: processResult.final_keywords,
                            clusters: processResult.clusters,
                            organic_results: fetchResult.organic_results || [],
                            rank_position: fetchResult.rank_position,
                            ai_mode_results: fetchResult.ai_mode_results || [],
                            ai_rank_position: fetchResult.ai_rank_position || null,
                            competitor_data: fetchResult.competitor_data || []
                        };
                        
                        // Display with rank position - add organic_results and AI data
                        const displayData = {
                            ...processResult,
                            organic_results: fetchResult.organic_results || [],
                            rank_position: fetchResult.rank_position,
                            ai_mode_results: fetchResult.ai_mode_results || [],
                            ai_rank_position: fetchResult.ai_rank_position || null
                        };
                        displayPageKeywords(contentEl, displayData, pagePath, fetchResult.rank_position);
                        
                        // Update button icon
                        const btn = pageItem.querySelector('.btn-keywords');
                        if (btn) {
                            btn.classList.add('has-keywords');
                            btn.innerHTML = '🔑';
                            btn.title = `${processResult.final_keywords.length} מילות מפתח`;
                        }
                        
                        // Show rank in toast if found
                        const rankMsg = fetchResult.rank_position 
                            ? ` | מיקום בגוגל: #${fetchResult.rank_position}` 
                            : '';
                        showToast(`נמצאו ${processResult.final_keywords.length} מילות מפתח${rankMsg}`, 'success');
                        
                    } catch (error) {
                        console.error('Keywords fetch error:', error);
                        contentEl.innerHTML = `<div style="color: var(--danger);">❌ ${error.message}</div>`;
                    } finally {
                        loadingEl.style.display = 'none';
                    }
                }
            } else {
                panel.style.display = 'none';
                openKeywordsPanels.delete(pagePath);  // Track as closed
            }
        }
        
        function displayPageKeywords(container, data, pagePath, rankPosition = null) {
            const keywords = data.final_keywords || [];
            const clusters = data.clusters || [];
            // Use passed rankPosition or get from data
            const rank = rankPosition ?? data.rank_position ?? null;
            
            if (keywords.length === 0) {
                container.innerHTML = '<div style="color: var(--text-secondary);">לא נמצאו מילות מפתח</div>';
                return;
            }
            
            // Store pagePath on container for later use
            container.dataset.pagePath = pagePath || '';
            
            // If no clusters but we have keywords, create simple clusters from keywords
            let displayClusters = clusters;
            if (clusters.length === 0 && keywords.length > 0) {
                console.log('[displayPageKeywords] No clusters found, creating from keywords list');
                displayClusters = keywords.map(kw => ({
                    primary: kw,
                    source: 'autocomplete',  // Default source
                    type: 'unique',
                    unique_part: '',
                    variants: []
                }));
            }
            
            // Count by source
            const autocompleteCount = displayClusters.filter(c => c.source === 'autocomplete').length;
            const relatedCount = displayClusters.filter(c => c.source === 'related').length;
            
            // Rank is now shown in page title, not in keywords panel
            
            // Check if we have organic results OR AI results
            const organicResults = data.organic_results || [];
            const aiResults = data.ai_mode_results || [];
            const showSerpBtn = (organicResults.length > 0 || aiResults.length > 0) ? 
                `<button class="btn-mini btn-serp" onclick="event.stopPropagation(); showSerpResults('${(pagePath || '').replace(/'/g, "\\'").replace(/\\/g, "\\\\")}')" title="הצג תוצאות SERP">🔍</button>` : '';
            
            let html = `
                <div class="keywords-header">
                    <span class="keywords-title">🔑 ${keywords.length} מילות מפתח</span>
                    <div class="keywords-actions">
                        ${showSerpBtn}
                        <button class="btn-mini" onclick="event.stopPropagation(); copyPageKeywords(this)" title="העתק">📋</button>
                        <button class="btn-mini btn-rescan" onclick="event.stopPropagation(); rescanKeywords(this, '${(pagePath || '').replace(/'/g, "\\'").replace(/\\/g, "\\\\")}')" title="סרוק מחדש">🔄</button>
                    </div>
                </div>
                <div class="keywords-legend">
                    <span class="legend-item"><span class="legend-dot autocomplete"></span> השלמות (${autocompleteCount})</span>
                    <span class="legend-item"><span class="legend-dot related"></span> חיפושים קשורים (${relatedCount})</span>
                </div>
                <div class="keywords-list">
            `;
            
            displayClusters.forEach((cluster, idx) => {
                const isCluster = cluster.variants && cluster.variants.length > 0;
                const escapedPrimary = cluster.primary.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                const sourceClass = cluster.source === 'related' ? 'from-related' : 'from-autocomplete';
                html += `
                    <span class="keyword-tag ${isCluster ? 'cluster' : ''} ${sourceClass}" title="${isCluster ? 'כולל: ' + cluster.variants.join(', ') : (cluster.source === 'related' ? 'מחיפושים קשורים' : 'מהשלמות')}">
                        ${cluster.primary}
                        <span class="keyword-delete" onclick="event.stopPropagation(); deleteKeyword(this, '${escapedPrimary}')" title="מחק">✕</span>
                    </span>`;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        function copyPageKeywords(btn) {
            const panel = btn.closest('.page-keywords-panel');
            const tags = panel.querySelectorAll('.keyword-tag');
            const keywords = Array.from(tags).map(t => t.textContent.replace('✕', '').trim());
            
            if (keywords.length === 0) {
                showToast('אין מילות מפתח להעתקה', 'warning');
                return;
            }
            
            navigator.clipboard.writeText(keywords.join('\n')).then(() => {
                showToast(`${keywords.length} מילות מפתח הועתקו`, 'success');
            }).catch(err => {
                console.error('Clipboard error:', err);
                showToast('שגיאה בהעתקה', 'error');
            });
        }
        
        async function deleteKeyword(btn, keyword) {
            const panel = btn.closest('.page-keywords-panel');
            const contentEl = panel.querySelector('.keywords-content');
            const pageItem = btn.closest('.page-item');
            const pagePath = pageItem?.dataset.path;
            
            if (!pagePath) {
                showToast('לא נמצא נתיב עמוד', 'error');
                return;
            }
            
            // Confirm deletion
            if (!confirm(`למחוק את "${keyword}"?`)) {
                return;
            }
            
            try {
                // Call API to delete keyword
                const result = await apiCall('/api/keywords/delete', {
                    method: 'POST',
                    body: JSON.stringify({
                        page_path: pagePath,
                        keyword: keyword
                    })
                });
                
                if (!result.success) {
                    throw new Error(result.error || 'שגיאה במחיקה');
                }
                
                // Remove from UI
                const tagElement = btn.closest('.keyword-tag');
                const wasFromRelated = tagElement.classList.contains('from-related');
                tagElement.remove();
                
                // Update count in header
                const remainingTags = panel.querySelectorAll('.keyword-tag');
                const titleEl = panel.querySelector('.keywords-title');
                if (titleEl) {
                    titleEl.textContent = `🔑 ${remainingTags.length} מילות מפתח`;
                }
                
                // Update legend counts
                const legendEl = panel.querySelector('.keywords-legend');
                if (legendEl) {
                    const autocompleteCount = panel.querySelectorAll('.keyword-tag.from-autocomplete').length;
                    const relatedCount = panel.querySelectorAll('.keyword-tag.from-related').length;
                    legendEl.innerHTML = `
                        <span class="legend-item"><span class="legend-dot autocomplete"></span> השלמות (${autocompleteCount})</span>
                        <span class="legend-item"><span class="legend-dot related"></span> חיפושים קשורים (${relatedCount})</span>
                    `;
                }
                
                // Update button if no keywords left
                if (remainingTags.length === 0) {
                    const kwBtn = pageItem.querySelector('.btn-keywords');
                    if (kwBtn) {
                        kwBtn.classList.remove('has-keywords');
                        kwBtn.innerHTML = '🔍';
                        kwBtn.title = 'סרוק מילות מפתח';
                    }
                    contentEl.innerHTML = '<div style="color: var(--text-secondary);">לא נמצאו מילות מפתח</div>';
                }
                
                // Update cache
                if (pageInfoCache[pagePath] && pageInfoCache[pagePath].fetched_keywords) {
                    const cache = pageInfoCache[pagePath].fetched_keywords;
                    cache.final_keywords = cache.final_keywords.filter(k => k !== keyword);
                    cache.clusters = cache.clusters.filter(c => c.primary !== keyword);
                }
                
                showToast(`"${keyword}" נמחקה`, 'success');
                
            } catch (error) {
                console.error('Delete keyword error:', error);
                showToast(error.message, 'error');
            }
        }
        
        function showSerpResults(pagePath) {
            const cachedInfo = pageInfoCache[pagePath];
            console.log('🔍 [showSerpResults] pagePath:', pagePath);
            console.log('🔍 [showSerpResults] cachedInfo:', cachedInfo);
            console.log('🔍 [showSerpResults] fetched_keywords:', cachedInfo?.fetched_keywords);
            
            const organicResults = cachedInfo?.fetched_keywords?.organic_results || [];
            const aiModeResults = cachedInfo?.fetched_keywords?.ai_mode_results || [];
            const mainKeyword = cachedInfo?.fetched_keywords?.main_keyword || cachedInfo?.keyword || '';
            const ourRank = cachedInfo?.fetched_keywords?.rank_position;
            const aiRank = cachedInfo?.fetched_keywords?.ai_rank_position;
            
            console.log('🔍 [showSerpResults] organicResults count:', organicResults.length);
            console.log('🔍 [showSerpResults] aiModeResults count:', aiModeResults.length);
            console.log('🔍 [showSerpResults] aiModeResults data:', aiModeResults);
            console.log('🔍 [showSerpResults] ourRank:', ourRank, 'aiRank:', aiRank);
            
            if (organicResults.length === 0 && aiModeResults.length === 0) {
                showToast('אין תוצאות SERP זמינות - סרוק מחדש', 'warning');
                return;
            }
            
            // Build status summary
            let statusHtml = '<div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">';
            
            // Organic rank status
            if (ourRank) {
                statusHtml += `<div style="flex: 1; min-width: 200px; padding: 12px; background: rgba(16, 185, 129, 0.2); border-radius: 8px; text-align: center;">
                    📍 <strong>מיקום אורגני:</strong> <span style="font-size: 1.3rem; color: #10b981; font-weight: bold;">#${ourRank}</span>
                </div>`;
            } else {
                statusHtml += `<div style="flex: 1; min-width: 200px; padding: 12px; background: rgba(239, 68, 68, 0.2); border-radius: 8px; text-align: center;">
                    ❌ לא נמצא ב-20 הראשונים
                </div>`;
            }
            
            // AI rank status
            if (aiRank) {
                statusHtml += `<div style="flex: 1; min-width: 200px; padding: 12px; background: rgba(59, 130, 246, 0.2); border-radius: 8px; text-align: center;">
                    🤖 <strong>מיקום AI:</strong> <span style="font-size: 1.3rem; color: #3b82f6; font-weight: bold;">#${aiRank}</span>
                </div>`;
            } else if (aiModeResults.length > 0) {
                statusHtml += `<div style="flex: 1; min-width: 200px; padding: 12px; background: rgba(156, 163, 175, 0.2); border-radius: 8px; text-align: center;">
                    🤖 לא מופיע ב-AI Overview
                </div>`;
            }
            
            statusHtml += '</div>';
            
            // Build modal content
            let content = `
                <div style="max-height: 70vh; overflow-y: auto; direction: rtl;">
                    <h3 style="margin-bottom: 15px; color: var(--primary);">🔍 תוצאות גוגל: "${mainKeyword}"</h3>
                    ${statusHtml}
            `;
            
            // AI Overview Section (if exists)
            if (aiModeResults.length > 0) {
                content += `
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #3b82f6; margin-bottom: 10px;">🤖 AI Overview</h4>
                        <div style="background: rgba(59, 130, 246, 0.1); padding: 15px; border-radius: 8px; border-right: 3px solid #3b82f6;">
                `;
                
                aiModeResults.forEach((result, idx) => {
                    if (result.is_summary) {
                        // AI Summary
                        content += `<div style="margin-bottom: 15px; font-style: italic; color: var(--text-secondary);">${result.description}</div>`;
                    } else {
                        // AI Source
                        const isOurs = aiRank === result.position;
                        const bgStyle = isOurs ? 'background: rgba(16, 185, 129, 0.3); border-radius: 6px; padding: 8px;' : '';
                        content += `
                            <div style="margin-bottom: 10px; ${bgStyle}">
                                <div style="font-weight: bold;">${isOurs ? '⭐ ' : ''}${result.position}. ${result.title || 'ללא כותרת'}</div>
                                <div style="font-size: 0.85rem; color: var(--text-secondary); margin: 4px 0;">${result.description || ''}</div>
                                <a href="${result.url}" target="_blank" style="font-size: 0.75rem; color: var(--info);">${result.url}</a>
                            </div>
                        `;
                    }
                });
                
                content += `</div></div>`;
            }
            
            // Organic Results Table
            content += `
                <h4 style="color: var(--primary); margin-bottom: 10px;">📊 תוצאות אורגניות (Top 10)</h4>
                <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                    <thead>
                        <tr style="background: rgba(255,255,255,0.1);">
                            <th style="padding: 8px; text-align: center; width: 40px;">#</th>
                            <th style="padding: 8px; text-align: right;">כותרת</th>
                            <th style="padding: 8px; text-align: right;">URL</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            organicResults.forEach((result, idx) => {
                const isOurs = ourRank === result.position;
                const rowStyle = isOurs ? 'background: rgba(16, 185, 129, 0.3); font-weight: bold;' : (idx % 2 === 0 ? 'background: rgba(255,255,255,0.05);' : '');
                const posColor = result.position <= 3 ? '#10b981' : result.position <= 10 ? '#f59e0b' : '#ef4444';
                
                content += `
                    <tr style="${rowStyle}">
                        <td style="padding: 8px; text-align: center; color: ${posColor}; font-weight: bold;">${result.position}</td>
                        <td style="padding: 8px; text-align: right; max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${result.title}">${result.title || '-'}</td>
                        <td style="padding: 8px; text-align: right; max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            <a href="${result.url}" target="_blank" style="color: var(--info); text-decoration: none;" title="${result.url}">${result.displayedUrl || result.url}</a>
                        </td>
                    </tr>
                `;
            });
            
            content += `
                        </tbody>
                    </table>
                </div>
            `;
            
            // Show in modal
            showModal('תוצאות SERP', content);
        }
        
        async function rescanKeywords(btn, pagePath) {
            if (!pagePath) {
                showToast('לא נמצא נתיב עמוד', 'error');
                return;
            }
            
            const panel = btn.closest('.page-keywords-panel');
            const contentEl = panel.querySelector('.keywords-content');
            const pageItem = btn.closest('.page-item');
            
            // Get keyword for this page
            const page = pages.find(p => p.path === pagePath);
            let keyword = page?.keyword;
            
            if (!keyword) {
                const cachedInfo = pageInfoCache[pagePath];
                keyword = cachedInfo?.keyword;
            }
            
            if (!keyword) {
                try {
                    const pageInfo = await apiCall(`/api/page/info?path=${encodeURIComponent(pagePath)}`);
                    keyword = pageInfo?.keyword;
                } catch (e) {}
            }
            
            if (!keyword) {
                showToast('אין מילת מפתח מוגדרת לעמוד זה', 'error');
                return;
            }
            
            // Show loading
            const originalContent = contentEl.innerHTML;
            contentEl.innerHTML = '<div style="color: var(--text-secondary);">🔄 סורק מחדש...</div>';
            btn.disabled = true;
            
            // Get page URL for rank tracking
            const pageUrl = pageInfoCache[pagePath]?.url || '';
            
            console.log('🔄 [Rescan Keywords] Starting...', 'keyword:', keyword, 'pageUrl:', pageUrl, 'pagePath:', pagePath);
            
            try {
                // Fetch fresh keywords with rank tracking
                const fetchResult = await apiCall('/api/keywords/fetch', {
                    method: 'POST',
                    body: JSON.stringify({ 
                        keyword: keyword,
                        page_url: pageUrl,
                        page_path: pagePath
                    })
                });
                
                console.log('📊 [Rescan Keywords] Result:', fetchResult);
                console.log('📊 [Rescan] success:', fetchResult.success);
                console.log('📊 [Rescan] autocomplete count:', fetchResult.autocomplete?.length);
                console.log('📊 [Rescan] related count:', fetchResult.related?.length);
                console.log('📊 [Rescan] related data:', fetchResult.related);
                console.log('📊 [Rescan] organic_results count:', fetchResult.organic_results?.length);
                console.log('📊 [Rescan] ai_mode_results count:', fetchResult.ai_mode_results?.length);
                console.log('📊 [Rescan] ai_mode_results data:', fetchResult.ai_mode_results);
                console.log('📊 [Rescan] rank_position:', fetchResult.rank_position);
                console.log('📊 [Rescan] ai_rank_position:', fetchResult.ai_rank_position);
                
                if (!fetchResult.success) {
                    throw new Error(fetchResult.error || 'שגיאה בשליפה');
                }
                
                // Process keywords
                const processResult = await apiCall('/api/keywords/process', {
                    method: 'POST',
                    body: JSON.stringify({
                        autocomplete: fetchResult.autocomplete || [],
                        related: fetchResult.related || [],
                        main_keyword: keyword
                    })
                });
                
                if (!processResult.success) {
                    throw new Error(processResult.error || 'שגיאה בעיבוד');
                }
                
                // Save to page_info.json (include rank, AI results, competitor data)
                console.log('💾 [Keywords Refresh] Saving keywords for:', pagePath);
                const saveResult = await apiCall('/api/keywords/save', {
                    method: 'POST',
                    body: JSON.stringify({
                        page_path: pagePath,
                        keywords_data: {
                            timestamp: new Date().toISOString(),
                            main_keyword: keyword,
                            clusters: processResult.clusters,
                            final_keywords: processResult.final_keywords,
                            unique_topics: processResult.unique_topics,
                            rank_position: fetchResult.rank_position || null,
                            rank_checked_url: pageUrl,
                            organic_results: fetchResult.organic_results || [],
                            ai_mode_results: fetchResult.ai_mode_results || [],
                            ai_rank_position: fetchResult.ai_rank_position || null,
                            competitor_data: fetchResult.competitor_data || []
                        }
                    })
                });
                
                if (!saveResult.success) {
                    console.error('❌ [Keywords Refresh] Save failed:', saveResult.error);
                    showToast('מילות מפתח נטענו אבל לא נשמרו! ' + (saveResult.error || ''), 'warning');
                } else {
                    console.log('✅ [Keywords Refresh] Saved successfully!');
                }
                
                // Update cache
                if (!pageInfoCache[pagePath]) pageInfoCache[pagePath] = {};
                pageInfoCache[pagePath].fetched_keywords = {
                    final_keywords: processResult.final_keywords,
                    clusters: processResult.clusters,
                    organic_results: fetchResult.organic_results || [],
                    rank_position: fetchResult.rank_position,
                    ai_mode_results: fetchResult.ai_mode_results || [],
                    ai_rank_position: fetchResult.ai_rank_position || null,
                    competitor_data: fetchResult.competitor_data || []
                };
                
                // Display updated keywords - add organic_results and AI data
                const displayData = {
                    ...processResult,
                    organic_results: fetchResult.organic_results || [],
                    rank_position: fetchResult.rank_position,
                    ai_mode_results: fetchResult.ai_mode_results || [],
                    ai_rank_position: fetchResult.ai_rank_position || null
                };
                displayPageKeywords(contentEl, displayData, pagePath, fetchResult.rank_position);
                
                // Show rank in toast if found (include AI rank)
                let rankMsg = fetchResult.rank_position 
                    ? ` | מיקום בגוגל: #${fetchResult.rank_position}` 
                    : '';
                if (fetchResult.ai_rank_position) {
                    rankMsg += ` | AI: #${fetchResult.ai_rank_position}`;
                }
                showToast(`נסרקו ${processResult.final_keywords.length} מילות מפתח חדשות${rankMsg}`, 'success');
                
            } catch (error) {
                console.error('Rescan keywords error:', error);
                contentEl.innerHTML = originalContent;
                showToast(error.message, 'error');
            } finally {
                btn.disabled = false;
            }
        }
        
        function getSelectedKeywords() {
            return keywordsState.keywords || [];
        }
        
        // No longer needed - keywords are per-page now
        async function loadSavedKeywords() {
            // This function is kept for compatibility but does nothing now
            // Keywords are loaded per-page when clicking the button
        }
        
        // ============ Pages ============
        let runningPagesMap = {};  // Track which pages are running (from server)
        let localRunningPages = {};  // Track locally which pages we started
        let pageStatusMap = {};  // Track page status (hasReport, hasFixed)
        let multiAgentStatusMap = {};  // Track status for ALL agents per page
        let openKeywordsPanels = new Set();  // Track which keywords panels are open
        let siteConfigCache = {};  // Cache site configuration for dynamic UI
        let wpSitesConfig = {};  // WordPress sites configuration (including title suffix)
        let preferredAgentOrder = [];  // Preferred order for agent dropdown (from config)
        let baseDir = '';  // Base directory path from server
        
        // Load UI configuration from server
        async function loadUIConfig() {
            try {
                const result = await apiCall('/api/config');
                if (result.success && result.config) {
                    preferredAgentOrder = result.config.ui?.preferred_agent_order || [];
                    baseDir = result.config.base_dir || '';
                    // Store WordPress sites config globally for title suffix feature
                    if (result.config.wordpress?.sites) {
                        wpSitesConfig = result.config.wordpress.sites;
                    }
                    console.log('⚙️ UI config loaded, base_dir:', baseDir, ', wpSites:', Object.keys(wpSitesConfig));
                }
            } catch (e) {
                console.error('Error loading UI config:', e);
            }
        }
        
        // Load site configuration for dynamic dropdowns
        async function loadSiteConfig() {
            try {
                const result = await apiCall('/api/sites/settings');
                if (result.success) {
                    siteConfigCache = result.sites || {};
                    console.log('🌐 Site config loaded:', Object.keys(siteConfigCache));
                }
            } catch (e) {
                console.error('Error loading site config:', e);
            }
        }
        
        // Get site badge HTML dynamically
        function getSiteBadge(siteId) {
            const cfg = siteConfigCache[siteId] || { icon: '📁', name: siteId };
            return `<span class="site-badge" title="${cfg.name || siteId}">${cfg.icon || '📁'}</span>`;
        }
        
        // Check if agent is allowed for a specific site
        function isAgentAllowedForSite(agent, pageSite) {
            if (!agent || !agent.sites || agent.sites.length === 0) return true;
            return agent.sites.includes(pageSite);
        }
        
        // Populate site filter dropdown dynamically
        async function populateSiteFilter() {
            const select = document.getElementById('siteFilter');
            if (!select) return;
            
            // Ensure site config is loaded
            if (Object.keys(siteConfigCache).length === 0) {
                await loadSiteConfig();
            }
            
            select.innerHTML = '<option value="all">🌐 כל האתרים</option>';
            
            for (const [siteId, siteInfo] of Object.entries(siteConfigCache)) {
                const icon = siteInfo.icon || '📁';
                const name = siteInfo.name || siteId;
                select.innerHTML += `<option value="${siteId}">${icon} ${name}</option>`;
            }
        }
        
        // Populate agent completion filter dynamically
        async function populateAgentCompletionFilter() {
            const select = document.getElementById('agentCompletionFilter');
            if (!select) return;
            
            select.innerHTML = '<option value="all">🎯 כל העמודים</option>';
            
            // Use the already loaded agents
            for (const [agentId, agent] of Object.entries(agents)) {
                if (agent.enabled === false) continue;
                const shortName = (agent.name || agentId).substring(0, 10);
                select.innerHTML += `
                    <option value="${agentId}_done">✅ סיימו ${shortName}</option>
                    <option value="${agentId}_not">❌ לא סיימו ${shortName}</option>
                `;
            }
        }
        
        // Populate WordPress site select dropdown dynamically
        async function populateWpSiteSelect() {
            const select = document.getElementById('wpSiteSelect');
            if (!select) return;
            
            // Ensure site config is loaded
            if (Object.keys(siteConfigCache).length === 0) {
                await loadSiteConfig();
            }
            
            select.innerHTML = '';
            for (const [siteId, siteInfo] of Object.entries(siteConfigCache)) {
                select.innerHTML += `<option value="${siteId}">${siteInfo.name || siteId}</option>`;
            }
        }
        
        // Render site config cards dynamically in settings
        async function renderSiteConfigCards() {
            const container = document.getElementById('siteConfigContainer');
            if (!container) return;
            
            // Ensure site config is loaded
            if (Object.keys(siteConfigCache).length === 0) {
                await loadSiteConfig();
            }
            
            // Get WordPress config for additional details
            let wpConfig = {};
            try {
                const result = await apiCall('/api/config');
                if (result.success && result.config?.wordpress?.sites) {
                    wpConfig = result.config.wordpress.sites;
                }
            } catch (e) {
                console.error('Error loading WP config:', e);
            }
            
            container.innerHTML = '';
            for (const [siteId, siteInfo] of Object.entries(siteConfigCache)) {
                const wpSite = wpConfig[siteId] || {};
                const icon = siteInfo.icon || '📁';
                const name = siteInfo.name || siteId;
                const folder = siteInfo.folder || '';
                const pageCount = siteInfo.page_count || 0;
                const wpUrl = wpSite.site_url || '';
                const wpUser = wpSite.username || '';
                
                container.innerHTML += `
                    <div class="site-config-card" data-site-id="${siteId}">
                        <div class="site-config-header">
                            <span class="site-badge">${icon}</span>
                            <input type="text" class="site-name-input" data-field="name" value="${name}" placeholder="שם האתר">
                            <span class="wp-site-status disconnected" data-wp-status="${siteId}">לא מחובר</span>
                        </div>
                        
                        <div class="site-config-section">
                            <h4>📁 תיקיות</h4>
                            <div class="site-config-row">
                                <div class="form-group">
                                    <label>מזהה</label>
                                    <input type="text" value="${siteId}" disabled class="site-id-input">
                                </div>
                                <div class="form-group" style="flex:2">
                                    <label>תיקיית עמודים</label>
                                    <input type="text" data-field="folder" value="${folder}">
                                </div>
                                <div class="site-stats">
                                    <span>${pageCount} עמודים</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="site-config-section">
                            <h4>🌐 WordPress</h4>
                            <div class="form-group">
                                <label>URL</label>
                                <input type="text" data-field="wp_url" value="${wpUrl}">
                            </div>
                            <div class="site-config-row">
                                <div class="form-group">
                                    <label>שם משתמש</label>
                                    <input type="text" data-field="wp_user" value="${wpUser}">
                                </div>
                                <div class="form-group">
                                    <label>סיסמה</label>
                                    <input type="password" data-field="wp_pass">
                                </div>
                                <button class="btn btn-secondary" onclick="testWpConnection('${siteId}')">🔌 בדוק</button>
                            </div>
                        </div>
                        
                        <div class="site-config-section">
                            <h4>🏷️ סיומת כותרת (Title Suffix)</h4>
                            <div class="site-config-row">
                                <div class="form-group" style="flex:2">
                                    <label>טקסט הסיומת</label>
                                    <input type="text" data-field="title_suffix" value="${wpSite.title_suffix || ''}" placeholder=" - ✔️ רק תבקש">
                                </div>
                                <div class="form-group">
                                    <label>פעיל</label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" data-field="title_suffix_enabled" ${wpSite.title_suffix_enabled ? 'checked' : ''}>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="suffix-preview" style="display: flex; align-items: center; gap: 5px;">
                                    <span style="color: #888; font-size: 0.85rem;">אורך:</span>
                                    <span class="suffix-length-badge" style="background: rgba(74, 222, 128, 0.2); color: #4ade80; padding: 2px 8px; border-radius: 4px; font-size: 0.85rem;">${(wpSite.title_suffix || '').length} תווים</span>
                                </div>
                            </div>
                            <small style="color: #888; display: block; margin-top: 5px;">הסיומת תתווסף אוטומטית לכותרות ע"י תבנית וורדפרס. הסוכן ייצר כותרות בלעדיה.</small>
                        </div>
                    </div>
                `;
            }
        }
        
        async function loadPages() {
            const result = await apiCall('/api/pages');
            if (result.success) {
                pages = result.pages;
                // Also load running status and page status
                await loadRunningStatus();
                await loadPageStatus();
                await loadMultiAgentStatus();
                renderPageList();
                
                // Auto-select first page if none selected
                if (!selectedPage && pages.length > 0) {
                    // Find first non-backup page
                    const firstNonBackupIndex = pages.findIndex(p => 
                        !p.name.toLowerCase().includes('_backup') && 
                        !p.path.toLowerCase().includes('_backup')
                    );
                    if (firstNonBackupIndex >= 0) {
                        await selectPage(firstNonBackupIndex);
                    }
                }
                
                // Load page info in background for word counts
                loadAllPageInfo();
            }
        }
        
        // Load page info for all pages (for word count display)
        async function loadAllPageInfo() {
            console.log('📊 Loading page info for word counts...');
            // Load page info in parallel batches of 5
            const batchSize = 5;
            let updated = false;
            let loadedCount = 0;
            
            for (let i = 0; i < pages.length; i += batchSize) {
                const batch = pages.slice(i, i + batchSize);
                
                await Promise.all(batch.map(async (page) => {
                    if (pageInfoCache[page.path]) return; // Skip if already cached
                    
                    try {
                        const result = await apiCall(`/api/page/info?path=${encodeURIComponent(page.path)}`);
                        if (result.success && result.has_info && result.info) {
                            // Server now calculates and saves word_count automatically
                            pageInfoCache[page.path] = result.info;
                            loadedCount++;
                            console.log(`📝 Loaded: ${page.name} - ${result.info.word_count || 'no count'} words`);
                            updated = true;
                        }
                    } catch (e) {
                        // Silently skip pages without info
                    }
                }));
                
                // Re-render after each batch to show progress
                if (updated) {
                    renderPageList();
                    updated = false;
                }
            }
            console.log(`📊 Loaded ${loadedCount} pages with word counts`);
        }
        
        // Open SEO report directly - fetches backup automatically
        async function openSeoReportDirect(pageIndex) {
            showToast('🔄 טוען דוח SEO...', 'info');
            
            // Validate index
            if (pageIndex < 0 || pageIndex >= pages.length) {
                showToast('❌ עמוד לא נמצא', 'error');
                return;
            }
            
            // Select the page
            await selectPage(pageIndex);
            
            try {
                // Load page info
                const infoResult = await apiCall(`/api/page/info?path=${encodeURIComponent(selectedPage.path)}`);
                if (infoResult.success && infoResult.has_info) {
                    uploadState.pageInfo = infoResult.info;
                    uploadState.postId = infoResult.info.post_id;
                    uploadState.url = infoResult.info.url;
                    uploadState.keyword = infoResult.info.keyword || '';
                }
                
                // Load backup from local file
                const backupResult = await apiCall(`/api/page/backup?path=${encodeURIComponent(selectedPage.path)}`);
                if (backupResult.success) {
                    uploadState.backupMeta = backupResult.meta;
                    uploadState.backupContent = cleanupInvalidHtml(backupResult.content);
                }
                
                // Load new content
                const htmlResult = await apiCall(`/api/page/html-content?path=${encodeURIComponent(selectedPage.path)}`);
                if (htmlResult.success && htmlResult.content) {
                    uploadState.newContent = cleanupInvalidHtml(htmlResult.content);
                }
                
                // If no backup content, try to fetch from WordPress
                if (!uploadState.backupContent && uploadState.postId) {
                    showToast('🔄 מושך גיבוי מוורדפרס...', 'info');
                    await fetchWordPressBackup();
                }
                
                // Open compare view
                await openCompareView();
                
                // Generate SEO report
                await generateSeoReport();
                
                // Show SEO report panel
                const seoPanel = document.getElementById('seoReportPanel');
                if (seoPanel) {
                    seoPanel.style.display = 'flex';
                }
                
                showToast('📊 דוח SEO נטען', 'success');
            } catch (error) {
                console.error('Error opening SEO report:', error);
                showToast('❌ שגיאה בטעינת הדוח', 'error');
            }
        }
        
        async function loadRunningStatus() {
            const result = await apiCall('/api/status/running');
            if (result.success) {
                runningPagesMap = result.running || {};
                // Debug: log running pages
                console.log('Running pages from server:', Object.keys(runningPagesMap));
                if (pages.length > 0) {
                    console.log('First page path in list:', pages[0].path);
                }
            }
        }
        
        // Reset page - delete reports and restore from backup
        async function resetAgentForPage(pagePath, agentId) {
            // Reset a specific agent for a page (delete only that agent's reports)
            const normalizedPath = pagePath.replace(/\\/g, '/');
            const pageName = normalizedPath.split('/').pop().replace('.html', '');
            
            // Get agent name from cache
            const agentName = agentsCache?.[agentId]?.name || agentId;
            
            if (!confirm(`איפוס "${agentName}" לעמוד: ${pageName}\n\nפעולה זו תמחק את כל הדוחות של הסוכן הזה בלבד.\n\nלהמשיך?`)) {
                return;
            }
            
            showToast(`🔄 מאפס ${agentName}...`, 'info');
            
            try {
                const result = await apiCall('/api/page/reset-agent', {
                    method: 'POST',
                    body: JSON.stringify({ 
                        path: normalizedPath,
                        agent_id: agentId
                    })
                });
                
                if (result.success) {
                    showToast(`✅ ${agentName} אופס בהצלחה`, 'success');
                    await loadMultiAgentStatus();
                    renderPageList();
                } else {
                    showToast(result.error || 'שגיאה באיפוס', 'error');
                }
            } catch (e) {
                showToast('שגיאה: ' + e.message, 'error');
            }
        }
        
        async function resetPage(pagePath) {
            // Normalize path separators and extract page name
            const normalizedPath = pagePath.replace(/\\/g, '/');
            const pageName = normalizedPath.split('/').pop().replace('.html', '');
            
            console.log('[Reset] Original path:', pagePath);
            console.log('[Reset] Normalized path:', normalizedPath);
            
            if (!confirm(`⚠️ איפוס עמוד: ${pageName}\n\nפעולה זו תמחק:\n• כל הדוחות של כל הסוכנים\n• קבצי גיבוי ביניים (.bak)\n\nותשחזר את הקובץ הראשי מהגיבוי המקורי.\n\nלהמשיך?`)) {
                return;
            }
            
            showToast('🔄 מאפס עמוד...', 'info');
            
            try {
                // Send path in request body to avoid URL encoding issues
                const requestBody = { path: normalizedPath };
                console.log('[Reset] Sending request:', requestBody);
                console.log('[Reset] JSON body:', JSON.stringify(requestBody));
                
                const result = await fetch('/api/page/reset', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                }).then(async r => {
                    console.log('[Reset] Response status:', r.status);
                    const text = await r.text();
                    console.log('[Reset] Response body:', text);
                    try {
                        return JSON.parse(text);
                    } catch (e) {
                        return { success: false, error: text };
                    }
                });
                
                if (result.success) {
                    // Show what was deleted
                    const deletedList = result.deleted?.join('\n') || '';
                    showToast(`✅ ${result.message}\n${deletedList}`, 'success', 5000);
                    
                    // Refresh page list, status and page info cache (for keywords display)
                    await loadPageStatus();
                    await loadMultiAgentStatus();
                    await loadAllPageInfo();  // Refresh keywords cache
                    renderPageList();
                    
                    // If this was the selected page, reload it
                    if (selectedPage?.path === pagePath) {
                        await selectPage(pages.findIndex(p => p.path === pagePath));
                    }
                } else {
                    showToast(`❌ שגיאה: ${result.error}`, 'error');
                }
            } catch (e) {
                showToast(`❌ שגיאה: ${e.message}`, 'error');
                console.error('Reset page error:', e);
            }
        }
        
        // Toggle special page status
        async function toggleSpecialPage(pagePath) {
            try {
                const result = await fetch(`/api/pages/${encodeURIComponent(pagePath)}/special`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                }).then(r => r.json());
                
                if (result.success) {
                    showToast(result.message, 'success');
                    
                    // Update the page in pages array
                    const pageIndex = pages.findIndex(p => p.path.replace(/\\/g, '/') === pagePath.replace(/\\/g, '/'));
                    if (pageIndex >= 0) {
                        pages[pageIndex].is_special = result.is_special;
                    }
                    
                    // Update cache if exists
                    if (pageInfoCache[pagePath]) {
                        pageInfoCache[pagePath].is_special = result.is_special;
                    }
                    
                    renderPageList();
                } else {
                    showToast(`שגיאה: ${result.error}`, 'error');
                }
            } catch (e) {
                showToast(`שגיאה: ${e.message}`, 'error');
            }
        }
        
        // Show page history in a popup
        async function showPageHistory(pagePath) {
            try {
                const result = await apiCall(`/api/pages/${encodeURIComponent(pagePath)}/history`);
                
                if (!result.success) {
                    showToast('לא נמצאה היסטוריה לעמוד זה', 'info');
                    return;
                }
                
                const history = result.history;
                const runs = history.runs || [];
                
                if (runs.length === 0) {
                    showToast('אין עדכונים בהיסטוריה', 'info');
                    return;
                }
                
                // Build history HTML
                let historyHtml = '<div style="max-height:400px;overflow-y:auto;">';
                historyHtml += '<h4 style="margin-bottom:12px;">📜 היסטוריית עדכונים</h4>';
                historyHtml += '<table style="width:100%;font-size:0.85rem;border-collapse:collapse;">';
                historyHtml += '<tr style="background:var(--bg-tertiary);"><th style="padding:6px;text-align:right;">תאריך</th><th style="padding:6px;text-align:right;">סוכן</th><th style="padding:6px;text-align:right;">עדכון WP</th></tr>';
                
                runs.slice().reverse().forEach(run => {
                    const date = new Date(run.timestamp).toLocaleString('he-IL');
                    const agentName = run.agent?.name || 'לא ידוע';
                    const wpUpdate = run.wordpress_update?.performed ? 
                        `✅ ${(run.wordpress_update.fields_updated || []).join(', ')}` : 
                        '❌';
                    
                    historyHtml += `<tr style="border-bottom:1px solid var(--border);">
                        <td style="padding:6px;">${date}</td>
                        <td style="padding:6px;">${agentName}</td>
                        <td style="padding:6px;">${wpUpdate}</td>
                    </tr>`;
                });
                
                historyHtml += '</table></div>';
                
                // Show in modal
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:9999;';
                modal.innerHTML = `
                    <div style="background:var(--bg-secondary);padding:20px;border-radius:8px;max-width:600px;width:90%;direction:rtl;">
                        ${historyHtml}
                        <button onclick="this.closest('.modal-overlay').remove()" style="margin-top:12px;padding:8px 16px;background:var(--accent);color:white;border:none;border-radius:4px;cursor:pointer;">סגור</button>
                    </div>
                `;
                modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
                document.body.appendChild(modal);
                
            } catch (e) {
                showToast(`שגיאה בטעינת היסטוריה: ${e.message}`, 'error');
            }
        }
        
        async function loadPageStatus() {
            // Get status for all pages based on selected agent
            const agentId = selectedAgent?.id || '';
            const result = await apiCall(`/api/status/pages?agent=${encodeURIComponent(agentId)}`);
            if (result.success) {
                pageStatusMap = result.status || {};
                console.log('Page status loaded:', Object.keys(pageStatusMap).length, 'pages with status');
            }
        }
        
        async function loadMultiAgentStatus() {
            // Get status for ALL agents per page
            const result = await apiCall('/api/status/multi-agent');
            if (result.success) {
                multiAgentStatusMap = result.status || {};
                console.log('Multi-agent status loaded:', Object.keys(multiAgentStatusMap).length, 'pages');
            }
        }
        
        function renderMultiAgentProgress(pagePath, pageSite = 'main') {
            const normalizedPath = pagePath.replace(/\\/g, '/');
            const status = multiAgentStatusMap[pagePath] || multiAgentStatusMap[normalizedPath];
            if (!status) return '';
            
            let html = '<div class="multi-agent-status">';
            
            // Define color classes for different agents
            const agentColors = ['atomic', 'seo', 'agent-3', 'agent-4', 'agent-5', 'agent-6'];
            let colorIndex = 0;
            
            // Dynamically render ALL agents from status
            for (const [agentId, agentStatus] of Object.entries(status)) {
                // Skip non-agent entries like 'backup'
                if (agentId === 'backup' || !agentStatus.maxSteps) continue;
                
                // Filter by site: only show agents allowed for this page's site
                const agent = agents[agentId];
                if (agent && !isAgentAllowedForSite(agent, pageSite)) continue;
                
                const isCompleted = agentStatus.completedSteps >= agentStatus.maxSteps;
                const hasProgress = agentStatus.completedSteps > 0;
                const colorClass = agentColors[colorIndex % agentColors.length];
                colorIndex++;
                
                // Get short label (first 6 chars of agent name or ID)
                const shortLabel = (agentStatus.agentName || agentId).substring(0, 6);
                const fullName = agentStatus.agentName || agentId;
                
                // Only show agents that have at least 1 step completed OR are multi-step
                if (agentStatus.maxSteps > 1 || hasProgress) {
                    html += `<div class="agent-progress ${colorClass} ${isCompleted ? 'is-done' : ''}" title="${fullName} - לחץ להצגת דוחות" data-agent-id="${agentId}" onclick="switchToAgentReports('${agentId}', event)" style="cursor:pointer;">`;
                    html += `<span class="agent-label">${shortLabel}</span>`;
                    html += '<div class="progress-bar-mini">';
                    for (let i = 1; i <= agentStatus.maxSteps; i++) {
                        const completed = i <= agentStatus.completedSteps ? `completed ${colorClass}` : '';
                        html += `<span class="step-dot ${completed}"></span>`;
                    }
                    html += '</div>';
                    if (isCompleted) {
                        html += '<span class="agent-done-badge">✓</span>';
                    }
                    // Add reset button for this specific agent
                    html += `<button class="btn-reset-agent" onclick="event.stopPropagation(); resetAgentForPage('${pagePath.replace(/\\/g, '\\\\')}', '${agentId}')" title="איפוס ${fullName}">×</button>`;
                    html += '</div>';
                }
            }
            
            // Backup status
            const backup = status.backup;
            if (backup && backup.exists) {
                const date = backup.fetched_at ? new Date(backup.fetched_at).toLocaleDateString('he-IL') : '';
                html += `<div class="backup-status-badge" title="גיבוי נשלף: ${date}">`;
                html += `💾 ${date || 'יש גיבוי'}`;
                html += '</div>';
            }
            
            html += '</div>';
            return html;
        }
        
        async function clearAllStatus() {
            const result = await apiCall('/api/status/clear-all', { method: 'POST' });
            if (result.success) {
                runningPagesMap = {};
                localRunningPages = {};
                pageStatusMap = {};
                renderPageList();
                hideWorkStatusPanel();
                showToast('🧹 כל הסטטוסים נוקו', 'success');
            }
        }

        let calculatorsCollapsed = true; // Start collapsed
        
        function renderPageList() {
            const list = document.getElementById('pageList');
            
            // Get filter values
            const siteFilter = document.getElementById('siteFilter')?.value || 'all';
            const sortFilter = document.getElementById('sortFilter')?.value || 'name';
            const agentCompletionFilter = document.getElementById('agentCompletionFilter')?.value || 'all';
            const specialFilter = document.getElementById('specialFilter')?.value || 'all';
            const uploadDateFilter = document.getElementById('uploadDateFilter')?.value || 'all';
            
            // Filter out backup files and apply site filter
            const filteredPages = pages.filter(page => {
                const name = page.name.toLowerCase();
                const path = page.path.toLowerCase();
                // Exclude backup files
                if (name.includes('_backup') || path.includes('_backup')) return false;
                if (name.includes('backup_meta') || path.includes('backup_meta')) return false;
                
                // Apply site filter
                if (siteFilter !== 'all') {
                    const pageSite = page.site || 'main';
                    if (pageSite !== siteFilter) return false;
                }
                
                // Apply special page filter
                if (specialFilter !== 'all') {
                    const isSpecial = page.is_special || pageInfoCache[page.path]?.is_special;
                    if (specialFilter === 'special' && !isSpecial) return false;
                    if (specialFilter === 'regular' && isSpecial) return false;
                }
                
                // Apply agent completion filter (dynamic parsing)
                if (agentCompletionFilter !== 'all') {
                    const normalizedPath = page.path.replace(/\\/g, '/');
                    const multiStatus = multiAgentStatusMap[page.path] || multiAgentStatusMap[normalizedPath] || {};
                    
                    // Dynamic parsing: format is {agentId}_done or {agentId}_not
                    const match = agentCompletionFilter.match(/^(.+)_(done|not)$/);
                    if (match) {
                        const [, agentId, status] = match;
                        const agentStatus = multiStatus[agentId];
                        const isCompleted = agentStatus && agentStatus.completedSteps >= agentStatus.maxSteps;
                        
                        if (status === 'done' && !isCompleted) return false;
                        if (status === 'not' && isCompleted) return false;
                    }
                }
                
                // Apply upload date filter
                if (uploadDateFilter !== 'all') {
                    const pageInfo = pageInfoCache[page.path];
                    const lastUpload = pageInfo?.last_upload || page.last_upload;
                    
                    if (uploadDateFilter === 'not_uploaded') {
                        // Show only pages that have NOT been uploaded
                        if (lastUpload) return false;
                    } else {
                        // For all other filters, skip pages without upload date
                        if (!lastUpload) return false;
                        
                        const uploadDate = new Date(lastUpload);
                        const now = new Date();
                        
                        if (uploadDateFilter === 'today') {
                            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                            if (uploadDate < today) return false;
                        } else if (uploadDateFilter === 'this_week') {
                            const weekAgo = new Date(now);
                            weekAgo.setDate(now.getDate() - 7);
                            if (uploadDate < weekAgo) return false;
                        } else if (uploadDateFilter === 'this_month') {
                            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                            if (uploadDate < monthStart) return false;
                        } else if (uploadDateFilter === 'custom') {
                            const fromDate = document.getElementById('uploadDateFrom')?.value;
                            const toDate = document.getElementById('uploadDateTo')?.value;
                            
                            if (fromDate) {
                                const from = new Date(fromDate);
                                from.setHours(0, 0, 0, 0);
                                if (uploadDate < from) return false;
                            }
                            if (toDate) {
                                const to = new Date(toDate);
                                to.setHours(23, 59, 59, 999);
                                if (uploadDate > to) return false;
                            }
                        }
                    }
                }
                
                return true;
            });
            
            // Sort pages based on sortFilter
            const sortedPages = [...filteredPages];
            if (sortFilter === 'last_upload') {
                // Sort by last WordPress upload date (newest first)
                sortedPages.sort((a, b) => {
                    const dateA = pageInfoCache[a.path]?.last_upload || '';
                    const dateB = pageInfoCache[b.path]?.last_upload || '';
                    // Empty dates go to the end
                    if (!dateA && !dateB) return a.name.localeCompare(b.name, 'he');
                    if (!dateA) return 1;
                    if (!dateB) return -1;
                    // Newest first
                    return dateB.localeCompare(dateA);
                });
            } else if (sortFilter === 'words_asc' || sortFilter === 'words_desc') {
                sortedPages.sort((a, b) => {
                    const wordCountA = pageInfoCache[a.path]?.word_count || 0;
                    const wordCountB = pageInfoCache[b.path]?.word_count || 0;
                    return sortFilter === 'words_asc' 
                        ? wordCountA - wordCountB 
                        : wordCountB - wordCountA;
                });
            } else {
                // Default: sort by name
                sortedPages.sort((a, b) => a.name.localeCompare(b.name, 'he'));
            }
            
            // Update filtered page count display
            const totalCount = pages.filter(p => 
                !p.name.toLowerCase().includes('_backup') && 
                !p.path.toLowerCase().includes('_backup') &&
                !p.name.toLowerCase().includes('backup_meta') &&
                !p.path.toLowerCase().includes('backup_meta')
            ).length;
            const filteredCount = sortedPages.length;
            
            const countEl = document.getElementById('pageFilterCount');
            if (countEl) {
                if (filteredCount < totalCount) {
                    countEl.textContent = `מציג ${filteredCount} מתוך ${totalCount} עמודים`;
                    countEl.style.color = '#f59e0b';  // Orange when filtered
                } else {
                    countEl.textContent = `${totalCount} עמודים`;
                    countEl.style.color = '#888';  // Gray when showing all
                }
            }
            
            // Separate calculator pages from regular pages
            const calculatorPages = sortedPages.filter(page => page.name.includes('מחשבון'));
            const regularPages = sortedPages.filter(page => !page.name.includes('מחשבון'));
            
            // Helper function to render a page item
            function renderPageItem(page, originalIndex) {
                // Normalize path for comparison (handle both / and \)
                const normalizedPath = page.path.replace(/\\/g, '/');
                
                // Check running status from LOCAL tracking (more reliable)
                let isRunning = localRunningPages[page.path] || localRunningPages[normalizedPath];
                
                // Also check by page name in local running
                if (!isRunning) {
                    for (const [runPath, runInfo] of Object.entries(localRunningPages)) {
                        const runPathNorm = runPath.replace(/\\/g, '/');
                        if (runPathNorm.includes(page.name + '.html') || runPathNorm.includes(page.name)) {
                            isRunning = runInfo;
                            break;
                        }
                    }
                }
                
                const pageStatus = pageStatusMap[page.path] || pageStatusMap[normalizedPath] || {};
                
                let statusDot = '';
                let stepInfo = '';
                let itemClass = selectedPage?.path === page.path ? 'selected' : '';
                
                if (isRunning) {
                    const step = isRunning.step || '?';
                    statusDot = `<span class="page-status-dot running" title="רץ שלב ${step}"></span>`;
                    stepInfo = `<span class="step-badge running">שלב ${step}</span>`;
                    itemClass += ' is-running';
                } else if (pageStatus.hasStep6Report) {
                    statusDot = '<span class="page-status-dot completed" title="הושלם"></span>';
                    stepInfo = '<span class="step-badge completed">✓ הושלם</span>';
                    itemClass += ' is-completed';
                } else if (pageStatus.hasStep5Report) {
                    statusDot = '<span class="page-status-dot step5" title="שלב 5 הושלם"></span>';
                    stepInfo = '<span class="step-badge step5">שלב 5 ✓</span>';
                } else if (pageStatus.hasStep4Report) {
                    const isSixStep = isAgentSixStep(selectedAgent);
                    if (isSixStep) {
                        statusDot = '<span class="page-status-dot step4" title="שלב 4 הושלם"></span>';
                        stepInfo = '<span class="step-badge step4">שלב 4 ✓</span>';
                    } else {
                        statusDot = '<span class="page-status-dot completed" title="הושלם"></span>';
                        stepInfo = '<span class="step-badge completed">✓ הושלם</span>';
                        itemClass += ' is-completed';
                    }
                } else if (pageStatus.hasStep3Report) {
                    const isFourStep = isAgentFourStep(selectedAgent);
                    const isSixStep = isAgentSixStep(selectedAgent);
                    if (isFourStep || isSixStep) {
                        statusDot = '<span class="page-status-dot step3" title="שלב 3 הושלם"></span>';
                        stepInfo = '<span class="step-badge step3">שלב 3 ✓</span>';
                        itemClass += ' is-step3';
                    } else {
                        statusDot = '<span class="page-status-dot completed" title="הושלם"></span>';
                        stepInfo = '<span class="step-badge completed">✓ הושלם</span>';
                        itemClass += ' is-completed';
                    }
                } else if (pageStatus.hasStep2Report) {
                    statusDot = '<span class="page-status-dot step2" title="שלב 2 הושלם"></span>';
                    stepInfo = '<span class="step-badge step2">שלב 2 ✓</span>';
                    itemClass += ' is-step2';
                } else if (pageStatus.hasReport) {
                    statusDot = '<span class="page-status-dot step1" title="דוח מוכן"></span>';
                    stepInfo = '<span class="step-badge step1">שלב 1 ✓</span>';
                    itemClass += ' is-step1';
                } else {
                    statusDot = '<span class="page-status-dot pending" title="ממתין"></span>';
                }
                
                const multiAgentProgress = renderMultiAgentProgress(page.path, page.site || 'main');
                
                // Get word count if available in pageInfoCache
                const cachedInfo = pageInfoCache[page.path] || {};
                const wordCountDisplay = cachedInfo.word_count 
                    ? `<span class="word-count-badge" title="מילים בעמוד">📝 ${cachedInfo.word_count.toLocaleString()}</span>` 
                    : '';
                
                // Check if page has fetched keywords
                const hasKeywords = cachedInfo.fetched_keywords && cachedInfo.fetched_keywords.final_keywords?.length > 0;
                const keywordsCount = hasKeywords ? cachedInfo.fetched_keywords.final_keywords.length : 0;
                const keywordsBtnClass = hasKeywords ? 'btn-keywords has-keywords' : 'btn-keywords';
                const keywordsBtnTitle = hasKeywords ? `${keywordsCount} מילות מפתח` : 'סרוק מילות מפתח';
                const keywordsBtnIcon = hasKeywords ? '🔑' : '🔍';
                
                // Build rank badge for page title (organic + AI)
                let rankBadge = '';
                const rankPos = cachedInfo.fetched_keywords?.rank_position ?? cachedInfo.rank_position;
                const aiRankPos = cachedInfo.fetched_keywords?.ai_rank_position;
                const hasKeywordsScan = cachedInfo.fetched_keywords?.timestamp;
                
                // Show rank badges only if we have a scan
                if (hasKeywordsScan) {
                    // Google organic rank - ORANGE
                    const googleRankText = (rankPos !== null && rankPos !== undefined) ? `#${rankPos}` : '-';
                    const googleRankTitle = (rankPos !== null && rankPos !== undefined) ? `מיקום ${rankPos} בגוגל` : 'לא נמצא ב-10 הראשונים';
                    rankBadge = `<span style="background:#f59e0b;color:white;padding:1px 6px;border-radius:3px;font-size:0.7rem;font-weight:bold;margin-right:4px;" title="${googleRankTitle}">🔍${googleRankText}</span>`;
                    
                    // AI rank - GREEN
                    const aiRankText = (aiRankPos !== null && aiRankPos !== undefined) ? `#${aiRankPos}` : '-';
                    const aiRankTitle = (aiRankPos !== null && aiRankPos !== undefined) ? `מיקום ${aiRankPos} ב-AI Overview` : 'לא מופיע ב-AI Overview';
                    rankBadge += `<span style="background:#10b981;color:white;padding:1px 6px;border-radius:3px;font-size:0.7rem;font-weight:bold;margin-right:4px;" title="${aiRankTitle}">🤖${aiRankText}</span>`;
                    
                    // Scan date
                    const scanDate = new Date(cachedInfo.fetched_keywords.timestamp).toLocaleDateString('he-IL');
                    rankBadge += `<span style="font-size:0.6rem;opacity:0.5;margin-right:4px;">${scanDate}</span>`;
                }
                
                // Special page badge (⭐)
                const isSpecial = page.is_special || cachedInfo.is_special;
                const specialBadge = isSpecial ? '<span class="special-badge" title="עמוד מיוחד">⭐</span>' : '';
                
                // Last upload date
                const lastUpload = page.last_upload || cachedInfo.last_upload;
                let lastUploadDisplay = '';
                if (lastUpload) {
                    const uploadDate = new Date(lastUpload).toLocaleDateString('he-IL');
                    const uploadType = page.last_upload_type || cachedInfo.last_upload_type || '';
                    const typeEmoji = uploadType === 'title' ? '📌' : uploadType === 'content' ? '📝' : '📤';
                    lastUploadDisplay = `<span class="last-upload-badge" onclick="event.stopPropagation(); showPageHistory('${page.path.replace(/\\/g, '/').replace(/'/g, "\\'")}')" title="עדכון אחרון: ${uploadDate} (${uploadType || 'לחץ לפרטים'})">${typeEmoji} ${uploadDate}</span>`;
                }
                
                // Debug: Log if word count is available
                if (cachedInfo.word_count) {
                    console.log(`📝 Rendering ${page.name}: ${cachedInfo.word_count} words`);
                }
                
                // Checkbox for batch selection
                const normalizedPagePath = page.path.replace(/\\/g, '/');
                const isChecked = selectedPagesForBatch.some(p => p.replace(/\\/g, '/') === normalizedPagePath);
                const checkboxHtml = batchSelectionMode ? 
                    `<input type="checkbox" class="page-checkbox" ${isChecked ? 'checked' : ''} onclick="togglePageSelection('${page.path.replace(/\\/g, '/').replace(/'/g, "\\'")}', event)">` : '';
                
                // Site badge - show which site this page belongs to (dynamic)
                const siteBadge = getSiteBadge(page.site || 'main');
                
                return `
                <div class="page-item ${itemClass}${isSpecial ? ' is-special' : ''}" data-index="${originalIndex}" data-path="${page.path.replace(/"/g, '&quot;')}">
                    <div class="page-item-title">${checkboxHtml}${siteBadge}${specialBadge}<span class="page-name">${page.name}</span>${rankBadge}${statusDot}</div>
                    <div class="page-item-meta">
                        <span class="page-item-folder">📁 ${page.folder}</span>
                        ${wordCountDisplay}
                        ${lastUploadDisplay}
                        ${stepInfo}
                    </div>
                    <div class="page-item-actions">
                        <button class="btn-mini btn-special ${isSpecial ? 'is-active' : ''}" onclick="event.stopPropagation(); toggleSpecialPage('${page.path.replace(/\\/g, '/').replace(/'/g, "\\'")}')" title="${isSpecial ? 'הסר סימון מיוחד' : 'סמן כעמוד מיוחד'}">${isSpecial ? '⭐' : '☆'}</button>
                        <button class="btn-mini ${keywordsBtnClass}" onclick="event.stopPropagation(); togglePageKeywords('${page.path.replace(/'/g, "\\'").replace(/\\/g, "\\\\")}')" title="${keywordsBtnTitle}">${keywordsBtnIcon}</button>
                        <button class="btn-mini btn-seo" onclick="event.stopPropagation(); openSeoReportDirect(${originalIndex})" title="דוח SEO (מושך גיבוי אוטומטי)">📊</button>
                        <button class="btn-mini btn-reset" data-reset-path="${page.path.replace(/"/g, '&quot;')}" onclick="event.stopPropagation(); resetPage(this.dataset.resetPath)" title="איפוס עמוד - מחיקת דוחות סוכנים ושחזור מגיבוי">🔄</button>
                        <button class="btn-mini btn-delete" onclick="event.stopPropagation(); confirmDeletePage('${page.path.replace(/\\/g, '/').replace(/'/g, "\\'")}')" title="מחיקת עמוד מהמערכת ומ-WordPress">🗑️</button>
                        <button class="btn-mini btn-wp" onclick="event.stopPropagation(); openUploadModalForPage(${originalIndex})" title="העלה ל-WordPress">📤</button>
                    </div>
                    <div class="page-keywords-panel" id="keywords-${originalIndex}" style="display: none;">
                        <div class="keywords-loading" style="display: none;">⏳ סורק...</div>
                        <div class="keywords-content"></div>
                    </div>
                    ${multiAgentProgress}
                </div>`;
            }
            
            // Build HTML with grouped calculators
            let html = '';
            
            // Regular pages first
            regularPages.forEach(page => {
                // Use original pages array index, not filteredPages index!
                const originalIndex = pages.indexOf(page);
                html += renderPageItem(page, originalIndex);
            });
            
            // Calculator group
            if (calculatorPages.length > 0) {
                const collapsedClass = calculatorsCollapsed ? 'collapsed' : '';
                html += `
                <div class="page-group-header ${collapsedClass}" onclick="toggleCalculatorsGroup()">
                    <span class="group-title">🧮 מחשבונים <span class="group-count">${calculatorPages.length}</span></span>
                    <span class="toggle-icon">▼</span>
                </div>
                <div class="page-group-content ${collapsedClass}" id="calculatorsGroup">
                `;
                
                calculatorPages.forEach(page => {
                    // Use original pages array index, not filteredPages index!
                    const originalIndex = pages.indexOf(page);
                    html += renderPageItem(page, originalIndex);
                });
                
                html += '</div>';
            }
            
            list.innerHTML = html;
            
            // Add click handlers
            list.querySelectorAll('.page-item').forEach(item => {
                item.addEventListener('click', () => {
                    const index = parseInt(item.dataset.index);
                    selectPage(index);
                });
            });
            
            // Restore open keywords panels
            openKeywordsPanels.forEach(pagePath => {
                const escapedPath = pagePath.replace(/\\/g, '\\\\');
                const pageItem = list.querySelector(`.page-item[data-path="${escapedPath}"]`);
                if (pageItem) {
                    const panel = pageItem.querySelector('.page-keywords-panel');
                    if (panel) {
                        panel.style.display = 'block';
                        // Reload keywords content if cached
                        const contentEl = panel.querySelector('.keywords-content');
                        const cachedInfo = pageInfoCache[pagePath];
                        if (cachedInfo?.fetched_keywords?.final_keywords?.length > 0 && contentEl) {
                            displayPageKeywords(contentEl, cachedInfo.fetched_keywords, pagePath);
                        }
                    }
                }
            });
        }

        function toggleCalculatorsGroup() {
            calculatorsCollapsed = !calculatorsCollapsed;
            const header = document.querySelector('.page-group-header');
            const content = document.getElementById('calculatorsGroup');
            
            if (calculatorsCollapsed) {
                header.classList.add('collapsed');
                content.classList.add('collapsed');
            } else {
                header.classList.remove('collapsed');
                content.classList.remove('collapsed');
            }
        }
        
        async function selectPage(index) {
            selectedPage = pages[index];
            
            // Clear cached prompt info when switching pages
            window.runningStepPromptInfo = null;
            window.currentPromptInfo = null;
            
            // Update agent dropdown to only show agents allowed for this page's site
            updateAgentDropdownForSite(selectedPage.site || 'main');
            
            // Refresh running status before rendering
            await loadRunningStatus();
            renderPageList();
            
            // If in edit mode, reload editor; otherwise load preview
            if (currentPreviewMode === 'edit') {
                // Re-apply the edit mode to load new page content into editor
                switchPreviewTab('edit');
                // Also load metadata (Title, Description, etc.)
                await loadPreviewMetadata();
            } else {
                await loadPreview(); // This also loads metadata
            }
            
            loadReports(); // Load report and update workflow buttons
            
            // Check if this page is running - now using COMPOSITE KEY (page_path:agent_id)
            const normalizedPath = selectedPage.path.replace(/\\/g, '/');
            const agentId = selectedAgent?.id || 'atomic_marketing';
            const jobKey = `${normalizedPath}:${agentId}`;
            
            // Try composite key first, then fallback to just page path for backward compatibility
            let isRunning = runningPagesMap[jobKey];
            if (!isRunning) {
                // Fallback: search for any job with this page path
                for (const [key, info] of Object.entries(runningPagesMap)) {
                    if (key.startsWith(normalizedPath + ':') || key === normalizedPath) {
                        isRunning = info;
                        break;
                    }
                }
            }
            const pageName = selectedPage.name?.replace('.html', '') || 'עמוד';
            
            if (isRunning) {
                // Page is running - show work status panel
                const info = isRunning;
                showWorkStatusPanel();
                
                // Check if running in Full Auto mode on the server
                const fullAutoLabel = info.full_auto ? ' 🚀 Full Auto' : '';
                const stepsInfo = info.full_auto ? ` (${info.step}/${info.total_steps})` : '';
                updateWorkStatusTitle(`📄 ${pageName} - שלב ${info.step}${stepsInfo} רץ...${fullAutoLabel}`);
                
                setWorkStatusDot('running');
                lastLogContent = '';  // Reset to force refresh
                showStopButton();
                startStatusPolling();
                startWorkLogPolling();
                
                // If server is in Full Auto, sync the client state
                if (info.full_auto) {
                    fullAutoMode = true;
                    fullAutoStep = info.step;
                    console.log('🔄 Restored Full Auto state from server:', { step: info.step, total: info.total_steps });
                }
            } else {
                // Page is not running - check if there's a recent log
                stopStatusPolling();
                hideStopButton();
                
                // Try to load log anyway (might have finished recently)
                const agentIdForLog = selectedAgent?.id || '';
                const logResult = await apiCall(`/api/worklog?page=${encodeURIComponent(selectedPage.path)}&agent_id=${encodeURIComponent(agentIdForLog)}`);
                if (logResult.success && logResult.content && logResult.content.trim()) {
                    // There's a log for this page - show it
                    showWorkStatusPanel();
                    const content = document.getElementById('workStatusContent');
                    content.innerHTML = formatWorkLog(logResult.content);
                    content.scrollTop = content.scrollHeight;
                    
                    // Check if it finished or still running based on log
                    if (logResult.content.includes('🏁 סיום!') || logResult.content.includes('✅ Claude סיים!')) {
                        setWorkStatusDot('completed');
                        updateWorkStatusTitle(`📄 ${pageName} - הסתיים ✅`);
                        clearRunningStepPrompt(); // Step actually completed
                        // Refresh reports since it's completed
                        loadReports();
                    } else {
                        setWorkStatusDot('running');
                        updateWorkStatusTitle(`📄 ${pageName} - רץ...`);
                        startWorkLogPolling();
                    }
                } else {
                    // No log - hide panel
                    stopWorkLogPolling();
                    hideWorkStatusPanel();
                }
            }
        }

        // Track current preview source
        let currentPreviewSource = 'current';
        
        async function loadPreview(source = null) {
            if (!selectedPage) return;
            const previewContent = document.getElementById('previewContent');
            const encodedPath = encodeURIComponent(selectedPage.path);
            
            // Use provided source or current source
            const previewSource = source || currentPreviewSource;
            currentPreviewSource = previewSource;
            
            if (previewSource === 'backup') {
                // Load backup file instead
                const backupPath = selectedPage.path.replace(/\.html$/i, '_backup.html');
                const encodedBackupPath = encodeURIComponent(backupPath);
                previewContent.innerHTML = `<iframe src="/api/preview/${encodedBackupPath}" id="previewFrame" onload="onPreviewLoad()"></iframe>`;
            } else {
                // Load current file
                previewContent.innerHTML = `<iframe src="/api/preview/${encodedPath}" id="previewFrame" onload="onPreviewLoad()"></iframe>`;
            }
            
            // Load metadata from page_info and backup
            await loadPreviewMetadata();
        }
        
        // ============ WYSIWYG Editor State ============
        let wysiwygEditorInitialized = false;
        let currentPreviewMode = 'current'; // 'current', 'backup', 'edit'
        
        function switchPreviewTab(source) {
            currentPreviewMode = source;
            currentPreviewSource = source === 'edit' ? 'current' : source;
            
            // Update tab styles
            const currentTab = document.getElementById('previewTabCurrent');
            const backupTab = document.getElementById('previewTabBackup');
            const editTab = document.getElementById('previewTabEdit');
            
            // Reset all tabs
            [currentTab, backupTab, editTab].forEach(tab => {
                if (tab) {
                    tab.style.background = '#333';
                    tab.style.color = '#888';
                }
            });
            
            // Highlight active tab
            if (source === 'current' && currentTab) {
                currentTab.style.background = '#3b82f6';
                currentTab.style.color = 'white';
            } else if (source === 'backup' && backupTab) {
                backupTab.style.background = '#f59e0b';
                backupTab.style.color = 'white';
            } else if (source === 'edit' && editTab) {
                editTab.style.background = '#10b981';
                editTab.style.color = 'white';
            }
            
            // Show/hide containers based on mode
            const previewContent = document.getElementById('previewContent');
            const editorContainer = document.getElementById('editorContainer');
            const specialNotice = document.getElementById('specialPageNotice');
            const saveBtn = document.getElementById('editorSaveBtn');
            const uploadBtn = document.getElementById('uploadBtn');
            
            if (source === 'edit') {
                // Check if page is special
                if (isCurrentPageSpecial()) {
                    // Special page - show notice to use Compare Modal
                    previewContent.style.display = 'none';
                    editorContainer.style.display = 'none';
                    specialNotice.style.display = 'flex';
                    saveBtn.style.display = 'none';
                    uploadBtn.style.display = 'inline-flex';
                } else {
                    // Regular page - show WYSIWYG editor
                    previewContent.style.display = 'none';
                    specialNotice.style.display = 'none';
                    editorContainer.style.display = 'flex';
                    saveBtn.style.display = 'inline-flex';
                    uploadBtn.style.display = 'none';
                    loadWysiwygEditor();
                }
            } else {
                // View mode (current or backup)
                previewContent.style.display = 'block';
                editorContainer.style.display = 'none';
                specialNotice.style.display = 'none';
                saveBtn.style.display = 'none';
                uploadBtn.style.display = 'inline-flex';
                loadPreview(source);
            }
        }
        
        // Check if current page is marked as special
        function isCurrentPageSpecial() {
            if (!selectedPage) return false;
            // Check both the page object and the cache
            return selectedPage.is_special === true || 
                   pageInfoCache[selectedPage.path]?.is_special === true;
        }
        
        // Initialize TinyMCE WYSIWYG Editor
        function initWysiwygEditor() {
            if (wysiwygEditorInitialized) return;
            
            if (typeof tinymce === 'undefined') {
                console.error('TinyMCE not loaded');
                showToast('עורך לא זמין - TinyMCE לא נטען', 'error');
                return;
            }
            
            tinymce.init({
                selector: '#tinymceEditor',
                language: 'he_IL',
                directionality: 'rtl',
                height: '100%',
                menubar: false,
                plugins: 'link lists table code searchreplace',
                toolbar: 'undo redo | bold italic underline | link | bullist numlist | table | code | searchreplace',
                content_style: `
                    body { 
                        font-family: 'Segoe UI', Tahoma, sans-serif; 
                        font-size: 14px; 
                        direction: rtl; 
                        background: #ffffff; 
                        color: #1a1a1a; 
                        padding: 15px;
                        line-height: 1.6;
                    }
                    a { color: #2563eb; }
                    h1, h2, h3, h4, h5, h6 { color: #1e40af; margin-top: 1em; margin-bottom: 0.5em; }
                    table { border-collapse: collapse; width: 100%; }
                    th, td { border: 1px solid #d1d5db; padding: 8px; }
                    th { background: #f3f4f6; }
                    ul, ol { margin: 0.5em 0; padding-right: 1.5em; }
                    p { margin: 0.5em 0; }
                `,
                skin_url: 'https://cdn.jsdelivr.net/npm/tinymce@6.8.2/skins/ui/oxide',
                content_css: 'https://cdn.jsdelivr.net/npm/tinymce@6.8.2/skins/content/default/content.min.css',
                icons_url: 'https://cdn.jsdelivr.net/npm/tinymce@6.8.2/icons/default/icons.min.js',
                theme_url: 'https://cdn.jsdelivr.net/npm/tinymce@6.8.2/themes/silver/theme.min.js',
                base_url: 'https://cdn.jsdelivr.net/npm/tinymce@6.8.2',
                suffix: '.min',
                setup: function(editor) {
                    // Track if content was changed
                    let hasUnsavedChanges = false;
                    
                    editor.on('change', function() {
                        hasUnsavedChanges = true;
                        // Mark as having unsaved changes
                        const saveBtn = document.getElementById('editorSaveBtn');
                        if (saveBtn) {
                            saveBtn.classList.add('pulse-green');
                        }
                    });
                    
                    // Auto-save when editor loses focus (blur)
                    editor.on('blur', function() {
                        if (hasUnsavedChanges) {
                            console.log('Editor blur - auto-saving...');
                            saveWysiwygEditor().then(() => {
                                hasUnsavedChanges = false;
                            });
                        }
                    });
                }
            }).then(() => {
                wysiwygEditorInitialized = true;
                console.log('TinyMCE initialized');
            });
        }
        
        // Load content into WYSIWYG editor
        // Note: We load the raw HTML and let TinyMCE handle formatting.
        // The preview applies wpautop to simulate WordPress display.
        async function loadWysiwygEditor() {
            if (!selectedPage?.path) {
                showToast('לא נבחר עמוד', 'error');
                return;
            }
            
            // Initialize editor if not done yet
            if (!wysiwygEditorInitialized) {
                initWysiwygEditor();
                // Wait for init
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            try {
                const result = await apiCall(`/api/page/${encodeURIComponent(selectedPage.path)}`);
                if (result.success && result.content) {
                    // Store raw content for saving later
                    window.currentPageRawContent = result.content;
                    
                    // Now get the wpautop'd version from preview API (same as what preview shows)
                    try {
                        const previewResponse = await fetch(`/api/preview/${encodeURIComponent(selectedPage.path)}`);
                        if (previewResponse.ok) {
                            const previewHtml = await previewResponse.text();
                            
                            // Extract body content from the full HTML document
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(previewHtml, 'text/html');
                            const bodyContent = doc.body.innerHTML;
                            
                            const editor = tinymce.get('tinymceEditor');
                            if (editor) {
                                editor.setContent(bodyContent);
                                console.log('Content loaded into WYSIWYG editor (from preview API)');
                            }
                        } else {
                            // Fallback to raw content with JS wpautop
                            const editor = tinymce.get('tinymceEditor');
                            if (editor) {
                                editor.setContent(applyWpautopForEditor(result.content));
                            }
                        }
                    } catch (previewErr) {
                        console.error('Error loading preview:', previewErr);
                        const editor = tinymce.get('tinymceEditor');
                        if (editor) {
                            editor.setContent(applyWpautopForEditor(result.content));
                        }
                    }
                } else {
                    showToast('שגיאה בטעינת התוכן', 'error');
                }
            } catch (err) {
                console.error('Error loading content:', err);
                showToast('שגיאה בטעינת התוכן', 'error');
            }
        }
        
        // Apply wpautop-like transformation for editor display
        // This matches how WordPress renders content
        function applyWpautopForEditor(content) {
            if (!content) return '';
            
            // Normalize line endings
            content = content.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
            
            // List of block-level elements that should not be wrapped
            const blockElements = 'table|thead|tbody|tfoot|tr|td|th|caption|colgroup|col|div|p|h[1-6]|ul|ol|li|dl|dt|dd|blockquote|pre|form|fieldset|legend|section|article|aside|header|footer|nav|figure|figcaption|address|hr|iframe|script|style';
            
            // Preserve content inside these tags (don't modify)
            const preserveRegex = new RegExp(`(<(${blockElements})[^>]*>[\\s\\S]*?<\\/\\2>)`, 'gi');
            const preserved = [];
            let preserveIndex = 0;
            
            content = content.replace(preserveRegex, (match) => {
                const placeholder = `<!--PRESERVE_${preserveIndex}-->`;
                preserved.push(match);
                preserveIndex++;
                return placeholder;
            });
            
            // Convert double newlines to paragraph breaks
            const paragraphs = content.split(/\n\n+/);
            content = paragraphs.map(para => {
                para = para.trim();
                if (!para) return '';
                if (para.startsWith('<!--PRESERVE_')) return para;
                // Convert single newlines to <br>
                para = para.replace(/\n/g, '<br>\n');
                return '<p>' + para + '</p>';
            }).filter(p => p).join('\n');
            
            // Restore preserved content
            preserved.forEach((original, index) => {
                content = content.replace(`<!--PRESERVE_${index}-->`, original);
            });
            
            // Clean up empty paragraphs
            content = content.replace(/<p>\s*<\/p>/gi, '');
            
            // Clean up <p> tags around block elements
            content = content.replace(/<p>\s*(<(?:table|div|ul|ol|h[1-6]|blockquote|pre|section|article)[^>]*>)/gi, '$1');
            content = content.replace(/(<\/(?:table|div|ul|ol|h[1-6]|blockquote|pre|section|article)>)\s*<\/p>/gi, '$1');
            
            return content;
        }
        
        // Reverse wpautop: convert editor HTML back to raw format for saving
        function reverseWpautopForSave(html) {
            if (!html) return '';
            
            // Replace </p><p> with double newlines
            html = html.replace(/<\/p>\s*<p[^>]*>/gi, '\n\n');
            
            // Remove opening <p> tags
            html = html.replace(/<p[^>]*>/gi, '');
            
            // Replace closing </p> with double newlines
            html = html.replace(/<\/p>/gi, '\n\n');
            
            // Replace <br> with single newlines
            html = html.replace(/<br\s*\/?>\s*/gi, '\n');
            
            // Clean up excessive newlines
            html = html.replace(/\n{3,}/g, '\n\n');
            
            // Trim each line
            html = html.split('\n').map(line => line.trimEnd()).join('\n');
            
            // Final trim
            html = html.trim();
            
            return html;
        }
        
        // Save WYSIWYG editor content
        async function saveWysiwygEditor() {
            if (!selectedPage?.path) {
                showToast('לא נבחר עמוד', 'error');
                return;
            }
            
            const editor = tinymce.get('tinymceEditor');
            if (!editor) {
                showToast('העורך לא זמין', 'error');
                return;
            }
            
            // Get content and reverse wpautop to save in original format
            let content = editor.getContent();
            content = reverseWpautopForSave(content);
            
            showToast('שומר...', 'info');
            
            try {
                const result = await apiCall('/api/page/content', {
                    method: 'POST',
                    body: JSON.stringify({
                        path: selectedPage.path,
                        content: content
                    })
                });
                
                if (result.success) {
                    showToast('✅ נשמר בהצלחה!', 'success');
                    const saveBtn = document.getElementById('editorSaveBtn');
                    if (saveBtn) {
                        saveBtn.classList.remove('pulse-green');
                    }
                    // Refresh preview to show saved changes
                    loadPreview('current');
                } else {
                    showToast('שגיאה בשמירה: ' + (result.error || 'לא ידוע'), 'error');
                }
            } catch (err) {
                console.error('Save error:', err);
                showToast('שגיאה בשמירה', 'error');
            }
        }
        
        function copyLocalPath() {
            if (!selectedPage?.path) {
                showToast('לא נבחר עמוד', 'error');
                return;
            }
            
            // Construct full path by joining base_dir with relative path
            let fullPath = selectedPage.path;
            if (baseDir) {
                // Normalize path separators and join
                const baseDirNorm = baseDir.replace(/\//g, '\\');
                const relPath = selectedPage.path.replace(/\//g, '\\');
                // Check if relPath already starts with baseDir
                if (!relPath.startsWith(baseDirNorm)) {
                    fullPath = baseDirNorm + '\\' + relPath;
                } else {
                    fullPath = relPath;
                }
            }
            
            navigator.clipboard.writeText(fullPath).then(() => {
                showToast(`📋 הנתיב הועתק`, 'success');
            }).catch(err => {
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = fullPath;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showToast(`📋 הנתיב הועתק`, 'success');
            });
        }
        
        function onPreviewLoad() {
            const frame = document.getElementById('previewFrame');
            if (!frame) return;
            
            try {
                const doc = frame.contentDocument || frame.contentWindow.document;
                if (!doc || !doc.body) return;
                
                // Always set RTL direction
                doc.body.style.direction = 'rtl';
                doc.body.style.textAlign = 'right';
                
                // If no dir attribute on html or body, add it
                if (!doc.documentElement.hasAttribute('dir')) {
                    doc.documentElement.setAttribute('dir', 'rtl');
                }
                if (!doc.body.hasAttribute('dir')) {
                    doc.body.setAttribute('dir', 'rtl');
                }
                
                // Also run SEO analysis
                analyzePreviewSeo();
            } catch (e) {
                console.log('Could not inject RTL into preview iframe:', e);
                analyzePreviewSeo();
            }
        }
        
        async function loadPreviewMetadata() {
            const metaBar = document.getElementById('seoMetaBar');
            const titleEl = document.getElementById('previewTitle');
            const descEl = document.getElementById('previewDesc');
            const titleCountEl = document.getElementById('previewTitleCount');
            const descCountEl = document.getElementById('previewDescCount');
            const warningsEl = document.getElementById('metaWarnings');
            
            if (!selectedPage) {
                metaBar.style.display = 'none';
                const viewOnSiteBtn = document.getElementById('viewOnSiteBtn');
                if (viewOnSiteBtn) viewOnSiteBtn.style.display = 'none';
                return;
            }
            
            try {
                // Get page info (for keyword)
                const infoResult = await apiCall(`/api/page/info?path=${encodeURIComponent(selectedPage.path)}`);
                const keyword = infoResult.info?.keyword || '';
                const pageUrl = infoResult.info?.url || '';
                const slug = pageUrl.split('/').filter(p => p).pop() || '';
                
                // Update "View on Site" button
                const viewOnSiteBtn = document.getElementById('viewOnSiteBtn');
                if (viewOnSiteBtn) {
                    if (pageUrl) {
                        viewOnSiteBtn.href = pageUrl;
                        viewOnSiteBtn.style.display = 'inline-flex';
                    } else {
                        viewOnSiteBtn.style.display = 'none';
                    }
                }
                
                // Update "View Local" button (copies path to clipboard)
                const viewLocalBtn = document.getElementById('viewLocalBtn');
                if (viewLocalBtn && selectedPage?.path) {
                    viewLocalBtn.style.display = 'inline-flex';
                }
                
                // Get backup metadata (for title/description)
                const backupResult = await apiCall(`/api/page/backup?path=${encodeURIComponent(selectedPage.path)}`);
                
                let title = '';
                let description = '';
                
                if (backupResult.success && backupResult.meta) {
                    title = backupResult.meta.title || '';
                    description = backupResult.meta.description || '';
                }
                
                // Display metadata
                metaBar.style.display = 'block';
                titleEl.textContent = title || '(לא נשלף - לחץ על העלה ל-WordPress ושלוף גיבוי)';
                titleEl.title = title;
                descEl.textContent = description || '(לא נשלף)';
                descEl.title = description;
                
                // Title count and status
                const titleLen = title.length;
                titleCountEl.textContent = `${titleLen}/60`;
                titleCountEl.className = 'meta-count ' + (titleLen === 0 ? '' : titleLen <= 60 ? 'good' : titleLen <= 70 ? 'warning' : 'bad');
                
                // Description count and status
                const descLen = description.length;
                descCountEl.textContent = `${descLen}/160`;
                descCountEl.className = 'meta-count ' + (descLen === 0 ? '' : descLen <= 160 ? 'good' : descLen <= 180 ? 'warning' : 'bad');
                
                // Generate warnings
                const warnings = [];
                
                if (titleLen > 60) {
                    warnings.push({ text: `⚠️ Title ארוך מדי (${titleLen} תווים, מקסימום 60)`, type: 'warning' });
                }
                
                if (descLen > 160) {
                    warnings.push({ text: `⚠️ Description ארוך מדי (${descLen} תווים, מקסימום 160)`, type: 'warning' });
                }
                
                if (keyword) {
                    const keywordLower = keyword.toLowerCase();
                    const keywordVariations = getHebrewVariations(keywordLower);
                    
                    // Check keyword in title
                    const titleLower = title.toLowerCase();
                    const keywordInTitle = keywordVariations.some(v => titleLower.includes(v));
                    if (!keywordInTitle && title) {
                        warnings.push({ text: `❌ מילת מפתח "${keyword}" לא ב-Title`, type: 'error' });
                    }
                    
                    // Check keyword in description
                    const descLower = description.toLowerCase();
                    const keywordInDesc = keywordVariations.some(v => descLower.includes(v));
                    if (!keywordInDesc && description) {
                        warnings.push({ text: `❌ מילת מפתח "${keyword}" לא ב-Description`, type: 'error' });
                    }
                    
                    // Check keyword in slug
                    const slugDecoded = decodeURIComponent(slug).toLowerCase();
                    const keywordInSlug = keywordVariations.some(v => slugDecoded.includes(v.replace(/\s/g, '-')));
                    if (!keywordInSlug && slug) {
                        warnings.push({ text: `⚠️ מילת מפתח לא ב-Slug (${slug})`, type: 'warning' });
                    }
                    
                    // Store keyword for H1 check (done in analyzePreviewSeo)
                    window.currentKeyword = keyword;
                    window.keywordVariations = keywordVariations;
                }
                
                // Display warnings
                warningsEl.innerHTML = warnings.map(w => 
                    `<span class="meta-warning ${w.type === 'error' ? '' : 'info'}">${w.text}</span>`
                ).join('');
                
            } catch (error) {
                console.error('Error loading preview metadata:', error);
                metaBar.style.display = 'none';
                const viewOnSiteBtn = document.getElementById('viewOnSiteBtn');
                if (viewOnSiteBtn) viewOnSiteBtn.style.display = 'none';
            }
        }
        
        function analyzePreviewSeo() {
            // Check H1 for keyword after iframe loads
            const frame = document.getElementById('previewFrame');
            if (!frame || !window.currentKeyword) return;
            
            try {
                const doc = frame.contentDocument || frame.contentWindow.document;
                if (!doc || !doc.body) return;
                
                const h1s = doc.querySelectorAll('h1');
                const h1Texts = Array.from(h1s).map(h => h.innerText.toLowerCase());
                
                const keywordInH1 = h1Texts.some(h1 => 
                    window.keywordVariations?.some(v => h1.includes(v))
                );
                
                if (!keywordInH1 && h1s.length > 0) {
                    const warningsEl = document.getElementById('metaWarnings');
                    warningsEl.innerHTML += `<span class="meta-warning">❌ מילת מפתח "${window.currentKeyword}" לא ב-H1</span>`;
                }
            } catch (e) {
                // Cross-origin frame access might fail
                console.log('Cannot analyze preview frame (cross-origin)');
            }
        }

        // ============ Agents ============
        async function loadAgents() {
            const result = await apiCall('/api/agents');
            if (result.success) {
                agents = result.agents;
                renderAgentSelect();
                renderAgentList();
                // Populate agent completion filter after agents are loaded
                populateAgentCompletionFilter();
            }
        }

        function renderAgentSelect() {
            const select = document.getElementById('agentSelect');
            
            // Use preferred order from config (loaded by loadUIConfig)
            // preferredAgentOrder is a global variable
            
            // Filter out inactive agents (enabled !== false)
            const agentEntries = Object.entries(agents).filter(([id, agent]) => agent.enabled !== false);
            
            // Sort agents: preferred order first, then rest alphabetically
            agentEntries.sort(([idA], [idB]) => {
                const indexA = preferredAgentOrder.indexOf(idA);
                const indexB = preferredAgentOrder.indexOf(idB);
                
                if (indexA !== -1 && indexB !== -1) return indexA - indexB;
                if (indexA !== -1) return -1;
                if (indexB !== -1) return 1;
                return idA.localeCompare(idB);
            });
            
            // Include step count in option text
            select.innerHTML = agentEntries.map(([id, agent]) => {
                const stepCount = getAgentStepCount({ id, ...agent });
                return `<option value="${id}">${agent.name} (${stepCount} שלבים)</option>`;
            }).join('');
            
            if (agentEntries.length > 0) {
                // Try to keep current selection if still valid
                const currentValue = select.value;
                if (agentEntries.some(([id]) => id === currentValue)) {
                    selectAgent(currentValue);
                } else {
                    selectAgent(agentEntries[0][0]);
                }
            }
        }
        
        // Update agent dropdown to only show agents allowed for a specific site
        function updateAgentDropdownForSite(pageSite) {
            const select = document.getElementById('agentSelect');
            const currentValue = select.value;
            
            // Filter agents by site restriction
            let agentEntries = Object.entries(agents).filter(([id, agent]) => {
                if (agent.enabled === false) return false;
                return isAgentAllowedForSite(agent, pageSite);
            });
            
            // Sort by preferred order
            agentEntries.sort(([idA], [idB]) => {
                const indexA = preferredAgentOrder.indexOf(idA);
                const indexB = preferredAgentOrder.indexOf(idB);
                
                if (indexA !== -1 && indexB !== -1) return indexA - indexB;
                if (indexA !== -1) return -1;
                if (indexB !== -1) return 1;
                return idA.localeCompare(idB);
            });
            
            // Include step count in option text
            select.innerHTML = agentEntries.map(([id, agent]) => {
                const stepCount = getAgentStepCount({ id, ...agent });
                return `<option value="${id}">${agent.name} (${stepCount} שלבים)</option>`;
            }).join('');
            
            // Try to keep current selection if still valid
            if (agentEntries.some(([id]) => id === currentValue)) {
                select.value = currentValue;
            } else if (agentEntries.length > 0) {
                // If current selection not valid for this site, select first available
                selectAgent(agentEntries[0][0]);
            }
        }

        async function selectAgent(agentId) {
            selectedAgent = { id: agentId, ...agents[agentId] };
            
            // Reload page status for new agent and re-render
            await loadPageStatus();
            await loadMultiAgentStatus();
            renderPageList();
            loadReports(); // Reload reports and update workflow buttons
            updateWorkflowButtons(); // Also update workflow buttons
        }
        
        // Switch to agent reports when clicking on agent progress bar in sidebar
        async function switchToAgentReports(agentId, event) {
            event.stopPropagation(); // Don't trigger page selection
            
            // Check if agent exists
            if (!agents[agentId]) {
                console.warn('Agent not found:', agentId);
                return;
            }
            
            // Update the dropdown
            const agentSelect = document.getElementById('agentSelect');
            if (agentSelect) {
                agentSelect.value = agentId;
            }
            
            // Select the agent and load its reports
            await selectAgent(agentId);
            showToast(`מציג דוחות: ${agents[agentId]?.name || agentId}`, 'info');
        }

        async function updateWorkflowButtons() {
            const container = document.getElementById('workflowButtons');
            
            if (!selectedPage || !selectedAgent) {
                container.innerHTML = '';
                return;
            }

            // Get step count for this agent
            const stepCount = getAgentStepCount(selectedAgent);
            console.log('[WorkflowButtons] Agent:', selectedAgent.id, 'Type:', selectedAgent.type, 'StepCount:', stepCount, 'Steps array:', selectedAgent.steps?.length);
            
            // Debug: check which branch will be taken
            const isSixStep = selectedAgent.type === 'six-step' && stepCount === 6;
            const isFourStep = selectedAgent.type === 'four-step' && stepCount === 4;
            const isThreeStep = selectedAgent.type === 'three-step' && stepCount === 3;
            const isTwoStep = selectedAgent.type === 'two-step' && stepCount === 2;
            const isSingleStep = selectedAgent.type === 'single-step';
            const isMultiStep = selectedAgent.type === 'multi-step';
            const isDynamic = !isSixStep && !isFourStep && !isThreeStep && !isTwoStep && !isSingleStep && !isMultiStep;
            console.log('[WorkflowButtons] Branch:', { isSixStep, isFourStep, isThreeStep, isTwoStep, isSingleStep, isMultiStep, isDynamic });

            // Check page status using new folder structure
            const normalizedPath = selectedPage.path.replace(/\\/g, '/');
            const status = pageStatusMap[selectedPage.path] || pageStatusMap[normalizedPath] || {};
            const hasReport = status.hasReport || currentReportPath !== null;
            const hasStep2Report = status.hasStep2Report || false;
            const hasStep3Report = status.hasStep3Report || false;
            
            // Combined Auto button (only visible if multiple agents in queue)
            const combinedAutoBtn = selectedAgentsQueue.length > 1 ? 
                `<button class="btn btn-danger" onclick="runCombinedAuto()" title="הרצת סוכנים ברצף">⚡ הרצה משולבת</button>` : '';

            // Use dynamic rendering for all agent types (not hardcoded)
            // Only use hardcoded paths for legacy agents with exact type match
            if (selectedAgent.type === 'six-step' && stepCount === 6) {
                // Six-step workflow: report → QA → fixes → QA fixes → AI removal → AI debug
                let buttons = '';
                const hasStep2Report = status.hasStep2Report || false;
                const hasStep3Report = status.hasStep3Report || false;
                const hasStep4Report = status.hasStep4Report || false;
                const hasStep5Report = status.hasStep5Report || false;
                const hasStep6Report = status.hasStep6Report || false;
                
                // Full Auto button (if supported)
                if (selectedAgent.supports_full_auto) {
                    buttons += `<button class="btn btn-warning" onclick="runFullAuto()" title="הרצה אוטומטית">🚀 אוטומט מלא</button>`;
                }
                
                if (hasStep6Report) {
                    // All steps done
                    buttons += `
                        <button class="btn btn-secondary btn-small" onclick="runStep1()">1️⃣</button>
                        <button class="btn btn-secondary btn-small" onclick="runStep2()">2️⃣</button>
                        <button class="btn btn-secondary btn-small" onclick="runStep3()">3️⃣</button>
                        <button class="btn btn-secondary btn-small" onclick="runStep4()">4️⃣</button>
                        <button class="btn btn-secondary btn-small" onclick="runStep5()">5️⃣</button>
                        <button class="btn btn-secondary btn-small" onclick="runStep6()">6️⃣</button>
                        <span class="completed-badge">✓ הושלם</span>
                    `;
                } else if (hasStep5Report) {
                    // Step 5 done - show step 6
                    buttons += `
                        <button class="btn btn-secondary btn-small" onclick="runStep1()">1️⃣</button>
                        <button class="btn btn-secondary btn-small" onclick="runStep2()">2️⃣</button>
                        <button class="btn btn-secondary btn-small" onclick="runStep3()">3️⃣</button>
                        <button class="btn btn-secondary btn-small" onclick="runStep4()">4️⃣</button>
                        <button class="btn btn-secondary btn-small" onclick="runStep5()">5️⃣</button>
                        <button class="btn btn-success" onclick="runStep6()">🔍 שלב 6: דיבאג AI</button>
                    `;
                } else if (hasStep4Report) {
                    // Step 4 done - show step 5
                    buttons += `
                        <button class="btn btn-secondary btn-small" onclick="runStep1()">1️⃣</button>
                        <button class="btn btn-secondary btn-small" onclick="runStep2()">2️⃣</button>
                        <button class="btn btn-secondary btn-small" onclick="runStep3()">3️⃣</button>
                        <button class="btn btn-secondary btn-small" onclick="runStep4()">4️⃣</button>
                        <button class="btn btn-success" onclick="runStep5()">🤖 שלב 5: הסרת AI</button>
                        <button class="btn btn-secondary btn-small" style="opacity: 0.5;">6️⃣</button>
                    `;
                } else if (hasStep3Report) {
                    // Step 3 done - show step 4
                    buttons += `
                        <button class="btn btn-secondary btn-small" onclick="runStep1()">1️⃣</button>
                        <button class="btn btn-secondary btn-small" onclick="runStep2()">2️⃣</button>
                        <button class="btn btn-secondary btn-small" onclick="runStep3()">3️⃣</button>
                        <button class="btn btn-success" onclick="runStep4()">✓ שלב 4: QA לתיקונים</button>
                        <button class="btn btn-secondary btn-small" style="opacity: 0.5;">5️⃣</button>
                        <button class="btn btn-secondary btn-small" style="opacity: 0.5;">6️⃣</button>
                    `;
                } else if (hasStep2Report) {
                    // Step 2 done - show step 3
                    buttons += `
                        <button class="btn btn-secondary btn-small" onclick="runStep1()">1️⃣</button>
                        <button class="btn btn-secondary btn-small" onclick="runStep2()">2️⃣</button>
                        <button class="btn btn-success" onclick="runStep3()">🔧 שלב 3: תיקונים</button>
                        <button class="btn btn-secondary btn-small" style="opacity: 0.5;">4️⃣</button>
                        <button class="btn btn-secondary btn-small" style="opacity: 0.5;">5️⃣</button>
                        <button class="btn btn-secondary btn-small" style="opacity: 0.5;">6️⃣</button>
                    `;
                } else if (hasReport) {
                    // Step 1 done - show step 2
                    buttons += `
                        <button class="btn btn-secondary btn-small" onclick="runStep1()">1️⃣</button>
                        <button class="btn btn-success" onclick="runStep2()">📋 שלב 2: QA</button>
                        <button class="btn btn-secondary btn-small" style="opacity: 0.5;">3️⃣</button>
                        <button class="btn btn-secondary btn-small" style="opacity: 0.5;">4️⃣</button>
                        <button class="btn btn-secondary btn-small" style="opacity: 0.5;">5️⃣</button>
                        <button class="btn btn-secondary btn-small" style="opacity: 0.5;">6️⃣</button>
                    `;
                } else {
                    // Nothing done - show step 1
                    buttons += `
                        <button class="btn btn-primary" onclick="runStep1()">📋 שלב 1: דוח</button>
                        <button class="btn btn-secondary btn-small" style="opacity: 0.5;">2️⃣</button>
                        <button class="btn btn-secondary btn-small" style="opacity: 0.5;">3️⃣</button>
                        <button class="btn btn-secondary btn-small" style="opacity: 0.5;">4️⃣</button>
                        <button class="btn btn-secondary btn-small" style="opacity: 0.5;">5️⃣</button>
                        <button class="btn btn-secondary btn-small" style="opacity: 0.5;">6️⃣</button>
                    `;
                }
                
                container.innerHTML = combinedAutoBtn + buttons;
            } else if (selectedAgent.type === 'four-step' && stepCount === 4) {
                // Four-step workflow: report → QA → fixes → debug
                let buttons = '';
                const hasStep2Report = status.hasStep2Report || false;  // QA report (דוח מורחב)
                const hasStep3Report = status.hasStep3Report || false;  // Fixes report
                const hasStep4Report = status.hasStep4Report || false;  // Debug report
                
                // Full Auto button (if supported)
                if (selectedAgent.supports_full_auto) {
                    buttons += `<button class="btn btn-warning" onclick="runFullAuto()" title="הרצה אוטומטית">🚀 אוטומט מלא</button>`;
                }
                
                if (hasStep4Report) {
                    // All steps done
                    buttons += `
                        <button class="btn btn-secondary btn-small" onclick="runStep1()">1️⃣</button>
                        <button class="btn btn-secondary btn-small" onclick="runStep2()">2️⃣</button>
                        <button class="btn btn-secondary btn-small" onclick="runStep3()">3️⃣</button>
                        <button class="btn btn-secondary btn-small" onclick="runStep4()">4️⃣</button>
                        <span class="completed-badge">✓ הושלם</span>
                    `;
                } else if (hasStep3Report) {
                    // Step 3 done - show step 4
                    buttons += `
                        <button class="btn btn-secondary btn-small" onclick="runStep1()">1️⃣</button>
                        <button class="btn btn-secondary btn-small" onclick="runStep2()">2️⃣</button>
                        <button class="btn btn-secondary btn-small" onclick="runStep3()">3️⃣</button>
                        <button class="btn btn-success" onclick="runStep4()">🔍 שלב 4: דיבאג</button>
                    `;
                } else if (hasStep2Report) {
                    // Step 2 done - show step 3
                    buttons += `
                        <button class="btn btn-secondary btn-small" onclick="runStep1()">1️⃣</button>
                        <button class="btn btn-secondary btn-small" onclick="runStep2()">2️⃣</button>
                        <button class="btn btn-success" onclick="runStep3()">🔧 שלב 3: תיקונים</button>
                        <button class="btn btn-secondary btn-small" style="opacity: 0.5;">4️⃣</button>
                    `;
                } else if (hasReport) {
                    // Step 1 done - show step 2
                    buttons += `
                        <button class="btn btn-secondary btn-small" onclick="runStep1()">1️⃣</button>
                        <button class="btn btn-success" onclick="runStep2()">📋 שלב 2: QA</button>
                        <button class="btn btn-secondary btn-small" style="opacity: 0.5;">3️⃣</button>
                        <button class="btn btn-secondary btn-small" style="opacity: 0.5;">4️⃣</button>
                    `;
                } else {
                    // Nothing done - show step 1
                    buttons += `
                        <button class="btn btn-primary" onclick="runStep1()">📋 שלב 1: דוח</button>
                        <button class="btn btn-secondary btn-small" style="opacity: 0.5;">2️⃣</button>
                        <button class="btn btn-secondary btn-small" style="opacity: 0.5;">3️⃣</button>
                        <button class="btn btn-secondary btn-small" style="opacity: 0.5;">4️⃣</button>
                    `;
                }
                
                container.innerHTML = combinedAutoBtn + buttons;
            } else if (selectedAgent.type === 'three-step' && stepCount === 3) {
                // Three-step workflow (like atomic marketing with debug)
                let buttons = '';
                
                // Full Auto button (if supported)
                if (selectedAgent.supports_full_auto) {
                    buttons += `<button class="btn btn-warning" onclick="runFullAuto()" title="הרצה אוטומטית של כל השלבים">🚀 אוטומט מלא</button>`;
                }
                
                if (hasStep3Report) {
                    // All steps done
                    buttons += `
                        <button class="btn btn-secondary btn-small" onclick="runStep1()">1️⃣</button>
                        <button class="btn btn-secondary btn-small" onclick="runStep2()">2️⃣</button>
                        <button class="btn btn-secondary btn-small" onclick="runStep3()">3️⃣</button>
                        <span class="completed-badge">✓ הושלם</span>
                    `;
                } else if (hasStep2Report) {
                    // Step 2 done - show step 3 as primary
                    buttons += `
                        <button class="btn btn-secondary btn-small" onclick="runStep1()">1️⃣</button>
                        <button class="btn btn-secondary btn-small" onclick="runStep2()">2️⃣</button>
                        <button class="btn btn-success" onclick="runStep3()">🔍 שלב 3: דיבאג</button>
                    `;
                } else if (hasReport) {
                    // Step 1 done - show step 2 as primary
                    buttons += `
                        <button class="btn btn-secondary btn-small" onclick="runStep1()">1️⃣</button>
                        <button class="btn btn-success" onclick="runStep2()">🔧 שלב 2: תיקונים</button>
                        <button class="btn btn-secondary btn-small" onclick="showToast('צריך קודם שלב 2', 'error')" style="opacity: 0.5;">3️⃣</button>
                    `;
                } else {
                    // Nothing done - show step 1
                    buttons += `
                        <button class="btn btn-primary" onclick="runStep1()">📋 שלב 1: דוח</button>
                        <button class="btn btn-secondary btn-small" style="opacity: 0.5;">2️⃣</button>
                        <button class="btn btn-secondary btn-small" style="opacity: 0.5;">3️⃣</button>
                    `;
                }
                
                container.innerHTML = combinedAutoBtn + buttons;
            } else if (selectedAgent.type === 'two-step' && stepCount === 2) {
                // Two-step workflow
                if (hasReport) {
                    container.innerHTML = combinedAutoBtn + `
                        <button class="btn btn-secondary" onclick="runStep1()">📋 שלב 1: צור דוח מחדש</button>
                        <button class="btn btn-success" onclick="runStep2()">🔧 שלב 2: בצע תיקונים</button>
                    `;
                } else {
                    container.innerHTML = combinedAutoBtn + `
                        <button class="btn btn-primary" onclick="runStep1()">📋 שלב 1: צור דוח</button>
                        <button class="btn btn-secondary" onclick="showToast('צריך קודם ליצור דוח (שלב 1)', 'error')" style="opacity: 0.5;">🔧 שלב 2: בצע תיקונים</button>
                    `;
                }
            } else if (selectedAgent.type === 'single-step') {
                container.innerHTML = combinedAutoBtn + `
                    <button class="btn btn-primary" onclick="runSingleStep()">▶️ הרץ סוכן</button>
                `;
            } else if (selectedAgent.type === 'multi-step') {
                container.innerHTML = combinedAutoBtn + `
                    <button class="btn btn-primary" onclick="runBuildStep(0)">🏗️ התחל בנייה</button>
                `;
            } else {
                // Dynamic agent - generate buttons based on step count
                console.log('[WorkflowButtons] Using DYNAMIC branch for stepCount:', stepCount);
                const dynamicStepCount = stepCount || 1;
                let buttons = '';
                
                // Check which steps are done - use hasStepXReport for consistency
                const stepsDone = [];
                for (let i = 1; i <= dynamicStepCount; i++) {
                    // Check hasStepXReport for all steps (backend now provides this consistently)
                    const isDone = status[`hasStep${i}Report`] || (i === 1 && status.hasReport);
                    stepsDone[i] = isDone;
                }
                
                console.log('[WorkflowButtons] stepsDone:', stepsDone, 'status:', status);
                
                // Find first incomplete step
                let nextStep = 1;
                for (let i = 1; i <= dynamicStepCount; i++) {
                    if (!stepsDone[i]) {
                        nextStep = i;
                        break;
                    }
                    if (i === dynamicStepCount) {
                        nextStep = dynamicStepCount + 1; // All done
                    }
                }
                
                console.log('[WorkflowButtons] nextStep:', nextStep);
                
                // Full Auto button for dynamic agents
                const fullAutoBtn = `<button class="btn btn-success" onclick="runFullAuto()">🚀 אוטומט מלא</button>`;
                
                // Generate buttons for each step
                const stepEmojis = ['', '1️⃣', '2️⃣', '3️⃣', '4️⃣', '5️⃣', '6️⃣', '7️⃣', '8️⃣', '9️⃣', '🔟'];
                for (let i = 1; i <= dynamicStepCount; i++) {
                    const emoji = stepEmojis[i] || `${i}`;
                    
                    if (i === nextStep && nextStep <= dynamicStepCount) {
                        // Next step to run - primary button
                        buttons += `<button class="btn btn-primary" onclick="runStepGeneric(${i})">▶️ שלב ${i}</button>`;
                    } else if (stepsDone[i]) {
                        // Completed step - small secondary button (can re-run)
                        buttons += `<button class="btn btn-secondary btn-small" onclick="runStepGeneric(${i})">${emoji}</button>`;
                    } else {
                        // Future step - disabled
                        buttons += `<button class="btn btn-secondary btn-small" style="opacity: 0.5;" title="צריך קודם להשלים שלבים קודמים">${emoji}</button>`;
                    }
                }
                
                // Add completed badge if all done
                if (nextStep > dynamicStepCount) {
                    buttons += '<span class="completed-badge">✓ הושלם</span>';
                }
                
                container.innerHTML = fullAutoBtn + ' ' + combinedAutoBtn + buttons;
            }
        }

        // ============ Workflow ============
        // === LEGACY STEP FUNCTIONS - Now redirect to runStepGeneric ===
        async function runStep1() {
            return runStepGeneric(1);
        }

        async function runStep2() {
            return runStepGeneric(2);
        }

        async function runStep3() {
            return runStepGeneric(3);
        }

        async function runStep4() {
            return runStepGeneric(4);
        }

        async function runStep5() {
            return runStepGeneric(5);
        }

        async function runStep6() {
            return runStepGeneric(6);
        }

        // Full Auto mode - run all steps automatically
        let fullAutoMode = false;
        let fullAutoStep = 0;
        let lastCompletedStep = 0;  // Track which step we last completed
        let fullAutoLastLogCheck = null;  // Timestamp when we last saw completion marker
        let fullAutoExpectedReport = null;  // The report file we're waiting for
        let fullAutoReportCheckInterval = null;  // Interval for checking report existence
        
        // Multi-agent queue (for Combined Auto)
        let selectedAgentsQueue = [];  // Array of agent objects to run in sequence
        
        // Multi-page selection (for batch execution)
        let selectedPagesForBatch = [];  // Array of page paths for batch execution
        let batchSelectionMode = false;  // Whether checkboxes are visible
        
        // SSE (Server-Sent Events) for step completion webhooks
        let stepEventSource = null;
        let sseLastEvent = null;  // Timestamp of last SSE event (for health check)
        
        // Start SSE listener for step completion events
        function startStepEventListener() {
            if (!selectedPage) return;
            
            // Close existing connection if any
            if (stepEventSource) {
                stepEventSource.close();
                stepEventSource = null;
            }
            
            const url = '/api/step/events?page=' + encodeURIComponent(selectedPage.path);
            console.log('📡 Starting SSE listener:', url);
            stepEventSource = new EventSource(url);
            
            stepEventSource.onmessage = async (event) => {
                try {
                    const data = JSON.parse(event.data);
                    console.log('📡 SSE Event received:', data);
                    sseLastEvent = Date.now();
                    
                    // Verify this is for our current page - normalize paths for comparison
                    const eventPath = (data.page_path || '').replace(/\\/g, '/').toLowerCase();
                    const currentPath = (selectedPage?.path || '').replace(/\\/g, '/').toLowerCase();
                    const pathMatch = eventPath && currentPath && (currentPath.includes(eventPath) || eventPath.includes(currentPath));
                    
                    // Check if agent matches - in Combined Auto mode, accept events from any agent in the queue
                    const agentMatch = data.agent_id === selectedAgent?.id;
                    const inQueue = combinedAutoMode && selectedAgentsQueue.some(a => a.id === data.agent_id);
                    
                    console.log('📡 SSE check:', { eventPath, currentPath, pathMatch, agentMatch, inQueue, combinedAutoMode });
                    
                    if ((agentMatch || inQueue) && pathMatch) {
                        // Handle different event types
                        if (data.type === 'step_started') {
                            await handleStepStarted(data);
                        } else {
                            // Default: step_complete
                            await handleStepComplete(data);
                        }
                    }
                } catch (e) {
                    console.error('SSE parse error:', e);
                }
            };
            
            stepEventSource.onerror = (err) => {
                console.error('📡 SSE Error:', err);
                // Don't retry immediately - polling will be used as fallback
            };
            
            stepEventSource.onopen = () => {
                console.log('📡 SSE Connection opened');
            };
        }
        
        // Stop SSE listener
        function stopStepEventListener() {
            if (stepEventSource) {
                console.log('📡 Stopping SSE listener');
                stepEventSource.close();
                stepEventSource = null;
            }
        }
        
        // Handle step started from SSE
        async function handleStepStarted(data) {
            console.log('🚀 handleStepStarted called:', data);
            
            // If the agent changed (Combined Auto moved to next agent), update selectedAgent
            if (data.agent_id && data.agent_id !== selectedAgent?.id) {
                console.log(`🔄 Agent changed from ${selectedAgent?.id} to ${data.agent_id}`);
                const newAgent = agents[data.agent_id];
                if (newAgent) {
                    selectedAgent = { id: data.agent_id, ...newAgent };
                    // Update the dropdown to reflect the new agent
                    const agentSelect = document.getElementById('agentSelect');
                    if (agentSelect) agentSelect.value = data.agent_id;
                    showToast(`🔄 עובר לסוכן: ${newAgent.name}`, 'info');
                }
            }
            
            const pageName = selectedPage?.name?.replace('.html', '') || 'העמוד';
            const stepNum = data.step || 1;
            const totalSteps = data.total_steps || getAgentStepCount(selectedAgent);
            
            // Update the work status panel title and status
            const agentName = selectedAgent?.name || data.agent_id || '';
            const fullAutoLabel = (fullAutoMode || combinedAutoMode) ? ` 🚀 ${agentName}` : '';
            updateWorkStatusTitle(`📄 ${pageName} - שלב ${stepNum}/${totalSteps} רץ...${fullAutoLabel}`);
            setWorkStatusDot('running');
            showStopButton();
            
            // Show prompt button for this step
            showPromptButton(`step${stepNum}`);
            
            // Clear old log content so new step's log is shown fresh
            lastLogContent = '';
            const content = document.getElementById('workStatusContent');
            content.innerHTML = `⏳ מתחיל שלב ${stepNum}...`;
            
            // Show panel and force restart polling for fresh logs
            const panel = document.getElementById('workStatusPanel');
            panel.classList.remove('hidden');
            stopWorkLogPolling();
            startWorkLogPolling();
            
            // Update local running state
            if (selectedPage) {
                localRunningPages[selectedPage.path] = { step: stepNum, started: Date.now() };
                renderPageList();
            }
        }
        
        // Handle step completion from SSE
        async function handleStepComplete(data) {
            console.log('🎯 handleStepComplete called:', data);
            
            if (data.status === 'success') {
                const pageName = selectedPage?.name?.replace('.html', '') || 'העמוד';
                const agentName = selectedAgent?.name || data.agent_id || '';
                updateWorkStatusTitle(`📄 ${pageName} - ${agentName} שלב ${data.step} הסתיים ✅`);
                
                // Clear from local running
                if (selectedPage?.path) {
                    delete localRunningPages[selectedPage.path];
                }
                
                // Refresh data
                await loadPageStatus();
                await loadMultiAgentStatus();
                loadReports();  // This will load reports for selectedAgent which was updated in handleStepStarted
                loadPreview();
                renderPageList();
                updateWorkflowButtons();
                // Don't hide stop button if we're still in Combined Auto (more agents coming)
                if (!combinedAutoMode) {
                    hideStopButton();
                }
                
                // Trigger next step in Full Auto or Combined Auto
                if (fullAutoMode || combinedAutoMode) {
                    // Update fullAutoStep to match SSE event
                    fullAutoStep = data.step;
                    console.log('📡 SSE triggered checkFullAutoNext for step', data.step);
                    checkFullAutoNext();
                }
            } else {
                showToast(`שלב ${data.step} נכשל: ${data.error || 'שגיאה'}`, 'error');
                fullAutoMode = false;
                combinedAutoMode = false;
                combinedAutoPhase = null;
                stopReportPolling();
                stopStepEventListener();
            }
        }
        
        // SSE Health check - fallback to polling if SSE seems stuck
        setInterval(() => {
            if ((fullAutoMode || combinedAutoMode) && fullAutoStep > 0) {
                if (sseLastEvent) {
                    const elapsed = Date.now() - sseLastEvent;
                    // If no SSE event for 60 seconds and we're in auto mode, polling should handle it
                    if (elapsed > 60000) {
                        console.warn('📡 SSE seems stuck (no event for 60s), polling is active as fallback');
                    }
                }
            }
        }, 30000);
        
        // Debounce for completion handling - prevent multiple refreshes
        let lastCompletionRefresh = 0;
        const COMPLETION_DEBOUNCE_MS = 3000;  // Don't refresh more than once per 3 seconds
        
        function shouldRefreshOnCompletion() {
            const now = Date.now();
            if (now - lastCompletionRefresh < COMPLETION_DEBOUNCE_MS) {
                console.log('⏳ Debouncing completion refresh');
                return false;
            }
            lastCompletionRefresh = now;
            return true;
        }
        
        // Get the expected report name for a specific step
        function getExpectedReportName(agent, step) {
            if (!agent) return null;
            
            // Try old format first (step1, step2, etc.)
            let stepConfig = agent[`step${step}`];
            
            // Try new format (steps array) if old format doesn't exist
            if (!stepConfig && agent.steps && Array.isArray(agent.steps)) {
                stepConfig = agent.steps[step - 1];
            }
            
            if (!stepConfig) return null;
            
            // Handle both old format (output_name/report_name) and new format (output.path)
            if (stepConfig.output && typeof stepConfig.output === 'object') {
                return stepConfig.output.path || null;
            }
            return stepConfig.output_name || stepConfig.report_name || null;
        }
        
        // Get full path to expected report
        function getExpectedReportPath(step) {
            if (!selectedAgent || !selectedPage) return null;
            
            const reportName = getExpectedReportName(selectedAgent, step);
            if (!reportName) return null;
            
            const agentFolder = getAgentFolder(selectedPage.path, selectedAgent);
            return `${agentFolder}/${reportName}`;
        }
        
        // Start polling for report file existence
        function startReportPolling(step) {
            if (fullAutoReportCheckInterval) {
                clearInterval(fullAutoReportCheckInterval);
            }
            
            const expectedPath = getExpectedReportPath(step);
            if (!expectedPath) {
                console.warn('⚠️ Could not determine expected report path for step', step);
                return;
            }
            
            fullAutoExpectedReport = expectedPath;
            console.log(`📋 Waiting for report: ${expectedPath}`);
            
            // Check every 2 seconds if the report exists
            // Poll every 10 seconds as fallback (SSE is primary method now)
            fullAutoReportCheckInterval = setInterval(async () => {
                await checkReportExists();
            }, 10000);
        }
        
        // Stop polling for report
        function stopReportPolling() {
            if (fullAutoReportCheckInterval) {
                clearInterval(fullAutoReportCheckInterval);
                fullAutoReportCheckInterval = null;
            }
            fullAutoExpectedReport = null;
            // Also stop SSE listener
            stopStepEventListener();
        }
        
        // Check if the expected report exists and trigger next step
        async function checkReportExists() {
            // Check for Full Auto OR Combined Auto mode
            if ((!fullAutoMode && !combinedAutoMode) || !fullAutoExpectedReport) return;
            
            try {
                const encodedPath = encodeURIComponent(fullAutoExpectedReport);
                const result = await apiCall(`/api/file/exists?path=${encodedPath}`);
                
                if (result.success && result.exists) {
                    console.log(`✅ Report detected: ${fullAutoExpectedReport}`);
                    
                    // Debounce check - BEFORE stopping polling!
                    // If debounce fails, keep polling so we can try again
                    if (!shouldRefreshOnCompletion()) {
                        console.log('⏳ Debounce active, will retry...');
                        return;
                    }
                    
                    // Stop polling only after debounce passes
                    stopReportPolling();
                    
                    // Update UI
                    const pageName = selectedPage?.name?.replace('.html', '') || 'עמוד';
                    setWorkStatusDot('completed');
                    updateWorkStatusTitle(`📄 ${pageName} - שלב ${fullAutoStep} הסתיים ✅`);
                    clearRunningStepPrompt(); // Step actually completed
                    
                    // Clear from local running
                    if (selectedPage?.path) {
                        delete localRunningPages[selectedPage.path];
                    }
                    
                    // Refresh data
                    await loadPageStatus();
                    await loadMultiAgentStatus();
                    loadReports();
                    loadPreview();
                    renderPageList();
                    updateWorkflowButtons();
                    hideStopButton();
                    
                    // Trigger next step!
                    checkFullAutoNext();
                }
            } catch (e) {
                console.error('Error checking report existence:', e);
            }
        }
        
        // ============ Agent Queue Management ============
        function addAgentToQueue() {
            // Add the currently selected agent from the dropdown to the queue
            if (!selectedAgent) {
                showToast('בחר סוכן קודם', 'warning');
                return;
            }
            
            // Check if already in queue
            if (selectedAgentsQueue.find(a => a.id === selectedAgent.id)) {
                showToast('הסוכן כבר בתור', 'warning');
                return;
            }
            
            selectedAgentsQueue.push({ ...selectedAgent });
            renderAgentQueue();
            showToast(`${selectedAgent.name} נוסף לתור (${selectedAgentsQueue.length})`, 'success');
        }
        
        function removeAgentFromQueue(agentId) {
            selectedAgentsQueue = selectedAgentsQueue.filter(a => a.id !== agentId);
            renderAgentQueue();
        }
        
        function clearAgentQueue() {
            selectedAgentsQueue = [];
            renderAgentQueue();
        }
        
        function renderAgentQueue() {
            const container = document.getElementById('agentQueue');
            const tagsContainer = document.getElementById('queueTags');
            
            if (selectedAgentsQueue.length === 0) {
                container.style.display = 'none';
                updateWorkflowButtons(); // Update buttons visibility
                return;
            }
            
            container.style.display = 'flex';
            tagsContainer.innerHTML = selectedAgentsQueue.map(agent => `
                <div class="queue-tag">
                    <span>${agent.name}</span>
                    <span class="remove-tag" onclick="removeAgentFromQueue('${agent.id}')">✕</span>
                </div>
            `).join('');
            
            updateWorkflowButtons(); // Update buttons visibility
        }
        
        // ============ Multi-Page Selection ============
        function toggleBatchSelectionMode() {
            batchSelectionMode = !batchSelectionMode;
            if (!batchSelectionMode) {
                selectedPagesForBatch = [];
            }
            updateBatchSelectionUI();
            renderPageList();
        }
        
        function updateBatchSelectionUI() {
            const bar = document.getElementById('batchSelectionBar');
            const countEl = document.getElementById('batchCount');
            
            if (batchSelectionMode) {
                bar.style.display = 'flex';
                countEl.textContent = `${selectedPagesForBatch.length} עמודים נבחרו`;
            } else {
                bar.style.display = 'none';
            }
        }
        
        function togglePageSelection(pagePath, event) {
            event.stopPropagation();
            
            // Normalize path for comparison
            const normalizedPath = pagePath.replace(/\\/g, '/');
            const index = selectedPagesForBatch.findIndex(p => p.replace(/\\/g, '/') === normalizedPath);
            
            if (index === -1) {
                selectedPagesForBatch.push(normalizedPath);
            } else {
                selectedPagesForBatch.splice(index, 1);
            }
            updateBatchSelectionUI();
            renderPageList();
        }
        
        function selectAllPages() {
            selectedPagesForBatch = pages.map(p => p.path.replace(/\\/g, '/'));
            updateBatchSelectionUI();
            renderPageList();
        }
        
        function clearPageSelection() {
            selectedPagesForBatch = [];
            updateBatchSelectionUI();
            renderPageList();
        }
        
        // Run Full Auto for a specific page (used in batch mode)
        async function runFullAutoForPage(pagePath, agent) {
            try {
                console.log(`🚀 runFullAutoForPage: ${pagePath} with ${agent.id}`);
                
                // Determine step count
                let stepCount = 0;
                if (agent.steps && agent.steps.length > 0) {
                    stepCount = agent.steps.length;
                } else {
                    for (let i = 1; i <= 10; i++) {
                        if (agent[`step${i}`]) stepCount++;
                    }
                }
                const totalSteps = stepCount || 4;
                
                // Call the API to start full auto for this page
                const result = await apiCall('/api/workflow/step/1', {
                    method: 'POST',
                    body: JSON.stringify({
                        page_path: pagePath,
                        agent_id: agent.id,
                        full_auto: true,
                        total_steps: totalSteps
                    })
                });
                
                if (result.success) {
                    console.log(`✅ Started Full Auto for ${pagePath}`);
                } else {
                    console.error(`❌ Failed to start Full Auto for ${pagePath}: ${result.error}`);
                }
            } catch (e) {
                console.error(`❌ Error in runFullAutoForPage: ${e}`);
            }
        }
        
        async function runFullAuto() {
            if (!selectedAgent) {
                showToast('בחר סוכן', 'error');
                return;
            }
            
            // Check if we have batch selection
            const pagesToRun = selectedPagesForBatch.length > 0 ? [...selectedPagesForBatch] :
                (selectedPage ? [selectedPage.path] : []);
            
            if (pagesToRun.length === 0) {
                showToast('בחר עמוד או סמן עמודים להרצה', 'error');
                return;
            }
            
            // If multiple pages selected, run on all of them in parallel
            if (pagesToRun.length > 1) {
                if (!confirm(`להריץ ${selectedAgent.name} על ${pagesToRun.length} עמודים במקביל?`)) {
                    return;
                }
                
                console.log(`🚀 Running Full Auto on ${pagesToRun.length} pages`);
                
                for (const pagePath of pagesToRun) {
                    runFullAutoForPage(pagePath, selectedAgent);
                }
                
                showToast(`🚀 מריץ ${selectedAgent.name} על ${pagesToRun.length} עמודים`, 'info');
                return;
            }
            
            // Single page - continue with original logic
            if (!selectedPage) {
                showToast('בחר עמוד', 'error');
                return;
            }
            
            // Count steps from both old and new formats
            let stepCount = 0;
            if (selectedAgent.steps && selectedAgent.steps.length > 0) {
                stepCount = selectedAgent.steps.length;
            } else {
                for (let i = 1; i <= 10; i++) {
                    if (selectedAgent[`step${i}`]) stepCount++;
                }
            }
            const isFourStep = selectedAgent.type === 'four-step' || stepCount === 4;
            const isSixStep = selectedAgent.type === 'six-step' || stepCount === 6;
            const totalSteps = stepCount || (isSixStep ? 6 : (isFourStep ? 4 : 3));
            
            // Determine current step based on existing reports
            const normalizedPath = selectedPage.path.replace(/\\/g, '/');
            const pageStatus = pageStatusMap[selectedPage.path] || pageStatusMap[normalizedPath] || {};
            let startStep = 1;
            // Build steps text dynamically based on step count
            let stepsText = 'שלב ' + Array.from({length: totalSteps}, (_, i) => i + 1).join(' → ');
            
            console.log('Full Auto - checking status:', pageStatus, 'isFourStep:', isFourStep, 'isSixStep:', isSixStep);
            
            if (isSixStep) {
                if (pageStatus.hasStep6Report) {
                    // In Combined Auto mode, don't stop - just mark as done
                    if (!combinedAutoMode) {
                        showToast('כל השלבים הושלמו!', 'info');
                        return;
                    }
                    // Already done, skip to next phase
                    showToast('✅ כל שלבי SEO הושלמו', 'info');
                    return;
                } else if (pageStatus.hasStep5Report) {
                    startStep = 6;
                    stepsText = 'שלב 6';
                } else if (pageStatus.hasStep4Report) {
                    startStep = 5;
                    stepsText = 'שלב 5 → 6';
                } else if (pageStatus.hasStep3Report) {
                    startStep = 4;
                    stepsText = 'שלב 4 → 5 → 6';
                } else if (pageStatus.hasStep2Report) {
                    startStep = 3;
                    stepsText = 'שלב 3 → 4 → 5 → 6';
                } else if (pageStatus.hasReport) {
                    startStep = 2;
                    stepsText = 'שלב 2 → 3 → 4 → 5 → 6';
                }
            } else if (isFourStep) {
                if (pageStatus.hasStep4Report) {
                    // In Combined Auto mode, don't stop - just mark as done and proceed
                    if (!combinedAutoMode) {
                        showToast('כל השלבים הושלמו!', 'info');
                        return;
                    }
                    // Already done, move to SEO phase
                    showToast('✅ כל שלבי שיווק אטומי הושלמו, עובר ל-SEO', 'info');
                    combinedAutoPhase = 'seo';
                    setTimeout(async () => {
                        await selectAgent('seo');
                        await new Promise(r => setTimeout(r, 1000));
                        showToast('🚀 מתחיל SEO Full Auto...', 'info');
                        await runFullAuto();
                    }, 2000);
                    return;
                } else if (pageStatus.hasStep3Report) {
                    startStep = 4;
                    stepsText = 'שלב 4';
                } else if (pageStatus.hasStep2Report) {
                    startStep = 3;
                    stepsText = 'שלב 3 → 4';
                } else if (pageStatus.hasReport) {
                    startStep = 2;
                    stepsText = 'שלב 2 → 3 → 4';
                }
            } else {
                if (pageStatus.hasStep3Report) {
                    showToast('כל השלבים הושלמו!', 'info');
                    return;
                } else if (pageStatus.hasStep2Report) {
                    startStep = 3;
                    stepsText = 'שלב 3';
                } else if (pageStatus.hasReport) {
                    startStep = 2;
                    stepsText = 'שלב 2 → 3';
                }
            }
            
            // Skip confirm dialog if already in Combined Auto mode
            if (!combinedAutoMode) {
                if (!confirm(`להריץ אוטומטית? (${stepsText})`)) {
                    return;
                }
            }
            
            fullAutoMode = true;
            fullAutoStep = startStep;
            fullAutoLastLogCheck = null;
            fullAutoTransitioning = false;
            
            const agentName = selectedAgent.name || selectedAgent.id;
            if (startStep === 1) {
                showToast(`🚀 ${agentName} - מתחיל שלב 1`, 'info');
                await runStep1();
            } else if (startStep === 2) {
                showToast(`🚀 ${agentName} - מתחיל שלב 2`, 'info');
                await runStep2();
            } else if (startStep === 3) {
                showToast(`🚀 ${agentName} - מתחיל שלב 3`, 'info');
                await runStep3();
            } else if (startStep === 4) {
                showToast(`🚀 ${agentName} - מתחיל שלב 4`, 'info');
                await runStep4();
            } else if (startStep === 5 && isSixStep) {
                showToast(`🚀 ${agentName} - מתחיל שלב 5`, 'info');
                await runStep5();
            } else if (startStep === 6 && isSixStep) {
                showToast(`🚀 ${agentName} - מתחיל שלב 6`, 'info');
                await runStep6();
            }
        }
        
        // Called when a step completes to trigger next step in Full Auto mode
        // DISABLED: Backend webhook handles all step transitions now!
        let fullAutoTransitioning = false;  // Prevent double calls
        
        async function checkFullAutoNext() {
            // ========================================
            // DISABLED - BACKEND HANDLES STEP TRANSITIONS
            // ========================================
            console.log('🚫 checkFullAutoNext DISABLED - backend handles step transitions via webhook');
            return;  // Exit immediately - backend handles this
            
            // OLD CODE BELOW (disabled):
            console.log('🔄 checkFullAutoNext called! fullAutoMode:', fullAutoMode, 'fullAutoStep:', fullAutoStep, 'transitioning:', fullAutoTransitioning, 'combinedMode:', combinedAutoMode, 'combinedPhase:', combinedAutoPhase);
            
            // Check for Full Auto OR Combined Auto mode
            if (!fullAutoMode && !combinedAutoMode) {
                console.log('❌ Not in Full Auto or Combined Auto mode, skipping');
                return;
            }
            
            // If in Combined Auto mode, treat it like Full Auto
            if (combinedAutoMode && !fullAutoMode) {
                fullAutoMode = true;
                console.log('🔗 Combined Auto mode detected, enabling fullAutoMode');
            }
            
            // Prevent double-calling during transition
            if (fullAutoTransitioning) {
                console.log('⏳ Already transitioning, skipping duplicate call');
                return;
            }
            
            // Prevent calling again within 3 seconds of last call (debounce)
            const now = Date.now();
            if (fullAutoLastLogCheck && (now - fullAutoLastLogCheck) < 3000) {
                console.log('⏳ Called too soon after last check, skipping (debounce)');
                return;
            }
            fullAutoLastLogCheck = now;
            
            fullAutoTransitioning = true;
            fullAutoStep++;
            console.log('📈 Moving to step:', fullAutoStep, 'agent:', selectedAgent?.id);
            
            const isFourStep = isAgentFourStep(selectedAgent);
            const isSixStep = isAgentSixStep(selectedAgent);
            const stepCount = getAgentStepCount(selectedAgent);
            const totalSteps = stepCount || (isSixStep ? 6 : (isFourStep ? 4 : 3));
            
            if (fullAutoStep === 2) {
                const agentName = selectedAgent?.name || 'סוכן';
                showToast(`🚀 ${agentName} - עובר לשלב 2 (מחכה 3 שניות)`, 'info');
                setTimeout(async () => {
                    // Clear all debounce timestamps so next step can be detected
                    fullAutoLastLogCheck = null;
                    fullAutoTransitioning = false;
                    lastCompletionRefresh = 0;  // Reset UI debounce too
                    console.log('▶️ Starting step 2...');
                    await runStep2();
                    await new Promise(r => setTimeout(r, 2000));
                }, 3000);
            } else if (fullAutoStep === 3) {
                const agentName = selectedAgent?.name || 'סוכן';
                showToast(`🚀 ${agentName} - עובר לשלב 3 (מחכה 5 שניות)`, 'info');
                setTimeout(async () => {
                    fullAutoLastLogCheck = null;
                    fullAutoTransitioning = false;
                    lastCompletionRefresh = 0;
                    
                    // Verify step 2 report exists before proceeding
                    const step2ReportPath = getExpectedReportPath(2);
                    if (step2ReportPath) {
                        const checkResult = await apiCall(`/api/file/exists?path=${encodeURIComponent(step2ReportPath)}`);
                        if (!checkResult?.exists) {
                            console.log('⏳ Step 2 report not ready yet, waiting 3 more seconds...');
                            await new Promise(r => setTimeout(r, 3000));
                        }
                    }
                    
                    console.log('▶️ Starting step 3...');
                    await runStep3();
                    await new Promise(r => setTimeout(r, 2000));
                }, 5000);
            } else if (fullAutoStep === 4 && (isFourStep || isSixStep)) {
                const agentName = selectedAgent?.name || 'סוכן';
                showToast(`🚀 ${agentName} - עובר לשלב 4 (מחכה 5 שניות)`, 'info');
                setTimeout(async () => {
                    fullAutoLastLogCheck = null;
                    fullAutoTransitioning = false;
                    lastCompletionRefresh = 0;
                    
                    // Verify step 3 report exists before proceeding
                    const step3ReportPath = getExpectedReportPath(3);
                    if (step3ReportPath) {
                        const checkResult = await apiCall(`/api/file/exists?path=${encodeURIComponent(step3ReportPath)}`);
                        if (!checkResult?.exists) {
                            console.log('⏳ Step 3 report not ready yet, waiting 3 more seconds...');
                            await new Promise(r => setTimeout(r, 3000));
                        }
                    }
                    
                    console.log('▶️ Starting step 4...');
                    await runStep4();
                    await new Promise(r => setTimeout(r, 2000));
                }, 5000);
            } else if (fullAutoStep === 5 && isSixStep) {
                const agentName = selectedAgent?.name || 'סוכן';
                showToast(`🚀 ${agentName} - עובר לשלב 5 (מחכה 5 שניות)`, 'info');
                setTimeout(async () => {
                    fullAutoLastLogCheck = null;
                    fullAutoTransitioning = false;
                    lastCompletionRefresh = 0;
                    
                    // Verify step 4 report exists before proceeding
                    const step4ReportPath = getExpectedReportPath(4);
                    if (step4ReportPath) {
                        const checkResult = await apiCall(`/api/file/exists?path=${encodeURIComponent(step4ReportPath)}`);
                        if (!checkResult?.exists) {
                            console.log('⏳ Step 4 report not ready yet, waiting 3 more seconds...');
                            await new Promise(r => setTimeout(r, 3000));
                        }
                    }
                    
                    console.log('▶️ Starting step 5...');
                    await runStep5();
                    await new Promise(r => setTimeout(r, 2000));
                }, 5000);
            } else if (fullAutoStep === 6 && isSixStep) {
                const agentName = selectedAgent?.name || 'סוכן';
                showToast(`🚀 ${agentName} - עובר לשלב 6 (מחכה 5 שניות)`, 'info');
                setTimeout(async () => {
                    fullAutoLastLogCheck = null;
                    fullAutoTransitioning = false;
                    lastCompletionRefresh = 0;
                    
                    // Verify step 5 report exists before proceeding
                    const step5ReportPath = getExpectedReportPath(5);
                    if (step5ReportPath) {
                        const checkResult = await apiCall(`/api/file/exists?path=${encodeURIComponent(step5ReportPath)}`);
                        if (!checkResult?.exists) {
                            console.log('⏳ Step 5 report not ready yet, waiting 3 more seconds...');
                            await new Promise(r => setTimeout(r, 3000));
                        }
                    }
                    
                    console.log('▶️ Starting step 6...');
                    await runStep6();
                    await new Promise(r => setTimeout(r, 2000));
                }, 5000);
            } else if (fullAutoStep > totalSteps) {
                console.log('🏁 All steps completed! combinedAutoMode:', combinedAutoMode, 'combinedAutoPhase:', combinedAutoPhase);
                
                fullAutoMode = false;
                fullAutoStep = 0;
                fullAutoTransitioning = false;
                fullAutoLastLogCheck = null;
                
                // Check if we're in Combined Auto mode and need to switch to SEO
                if (combinedAutoMode && combinedAutoPhase === 'atomic') {
                    console.log('🔄 Switching from Atomic to SEO...');
                    showToast('🎉 שיווק אטומי הושלם! עובר ל-SEO...', 'success');
                    combinedAutoPhase = 'seo';
                    
                    // Switch to SEO agent and continue
                    setTimeout(async () => {
                        try {
                            console.log('🔄 Selecting SEO agent...');
                            await selectAgent('seo');
                            await new Promise(r => setTimeout(r, 1500));
                            
                            // Refresh page status before running SEO
                            await loadPageStatus();
                            await new Promise(r => setTimeout(r, 500));
                            
                            console.log('🚀 Starting SEO Full Auto...');
                            showToast('🚀 מתחיל SEO Full Auto...', 'info');
                            await runFullAuto();
                        } catch (e) {
                            console.error('Error switching to SEO:', e);
                            showToast('❌ שגיאה במעבר ל-SEO', 'error');
                            combinedAutoMode = false;
                            combinedAutoPhase = null;
                        }
                    }, 3000);
                } else if (combinedAutoMode && combinedAutoPhase === 'seo') {
                    console.log('🎉 Combined Auto fully completed!');
                    combinedAutoMode = false;
                    combinedAutoPhase = null;
                    showToast('🎉 Combined Auto הושלם! (שיווק אטומי + SEO)', 'success');
                } else {
                    console.log('🎉 Full Auto completed (single agent)');
                    showToast('🎉 Full Auto הושלם!', 'success');
                }
            } else {
                // If we get here with an unexpected step number, reset
                console.warn('⚠️ Unexpected fullAutoStep:', fullAutoStep, 'for totalSteps:', totalSteps);
                fullAutoTransitioning = false;
            }
        }
        
        // Safety timeout - reset transitioning state if stuck for too long
        setInterval(() => {
            if (fullAutoTransitioning) {
                const now = Date.now();
                if (fullAutoLastLogCheck && (now - fullAutoLastLogCheck) > 60000) {
                    console.warn('⚠️ Full Auto seems stuck, resetting transitioning state');
                    fullAutoTransitioning = false;
                }
            }
        }, 10000);
        
        // Combined Auto Mode - runs Atomic Marketing then SEO
        let combinedAutoMode = false;
        let combinedAutoPhase = null;  // 'atomic' or 'seo'
        
        async function runCombinedAuto() {
            console.log('🔥 runCombinedAuto started!');
            
            // Determine which agents to run
            const agentsToRun = selectedAgentsQueue.length > 0 ? [...selectedAgentsQueue] : 
                (selectedAgent ? [selectedAgent] : []);
            
            if (agentsToRun.length === 0) {
                showToast('בחר סוכן או הוסף סוכנים לתור', 'error');
                return;
            }
            
            // Determine which pages to run on
            const pagesToRun = selectedPagesForBatch.length > 0 ? [...selectedPagesForBatch] :
                (selectedPage ? [selectedPage.path] : []);
            
            if (pagesToRun.length === 0) {
                showToast('בחר עמוד או סמן עמודים להרצה', 'error');
                return;
            }
            
            const agentNames = agentsToRun.map(a => a.name).join(' → ');
            const pageCount = pagesToRun.length;
            
            if (!confirm(`להריץ ${agentNames}\nעל ${pageCount} עמודים?`)) {
                return;
            }
            
            console.log('🔥 Combined Auto confirmed:', { agentsToRun, pagesToRun });
            
            // Run on all pages in parallel, each with agent queue
            for (const pagePath of pagesToRun) {
                runAgentQueueForPage(pagePath, agentsToRun);
            }
            
            showToast(`🚀 מריץ ${agentNames} על ${pageCount} עמודים`, 'info');
        }
        
        async function runAgentQueueForPage(pagePath, agentsQueue) {
            // Start the first agent in the queue
            if (agentsQueue.length === 0) return;
            
            const firstAgent = agentsQueue[0];
            console.log(`🎯 Starting agent queue for ${pagePath}: ${agentsQueue.map(a=>a.name).join(' → ')}`);
            
            // Set Combined Auto mode
            combinedAutoMode = true;
            fullAutoMode = true;
            fullAutoStep = 0;
            
            try {
                // Call backend to start Full Auto with agent queue
                const result = await apiCall('/api/workflow/combined', {
                    method: 'POST',
                    body: JSON.stringify({
                        page_path: pagePath,
                        agent_queue: agentsQueue.map(a => a.id)
                    })
                });
                
                if (result.success) {
                    console.log(`✅ Combined Auto started for ${pagePath}`);
                    
                    // Show work status panel
                    showWorkStatusPanel();
                    updateWorkStatusTitle(`📄 ${selectedPage?.name?.replace('.html', '') || pagePath} - מריץ תור סוכנים...`);
                    setWorkStatusDot('running');
                    showStopButton();
                    
                    // Start SSE listener and polling
                    startStepEventListener();
                    startWorkLogPolling();
                    startStatusPolling();
                    
                    // Track locally
                    localRunningPages[pagePath] = { step: 1, started: Date.now() };
                    renderPageList();
                } else {
                    showToast(`שגיאה: ${result.error}`, 'error');
                    combinedAutoMode = false;
                    fullAutoMode = false;
                }
            } catch (e) {
                console.error('Error starting combined auto:', e);
                showToast('שגיאה בהתחלת הרצה משולבת', 'error');
                combinedAutoMode = false;
                fullAutoMode = false;
            }
        }

        async function runSingleStep() {
            if (!selectedPage || !selectedAgent) {
                showToast('בחר עמוד וסוכן', 'error');
                return;
            }

            currentMode = document.getElementById('modeSelect').value;
            
            const result = await apiCall('/api/workflow/single', {
                method: 'POST',
                body: JSON.stringify({
                    agent_id: selectedAgent.id,
                    page_path: selectedPage.path,
                    mode: currentMode
                })
            });

            if (result.success) {
                if (currentMode === 'cursor') {
                    document.getElementById('commandDisplay').textContent = result.command;
                    currentStep = 1;
                    openModal('commandModal');
                } else {
                    showToast('הסוכן רץ בהצלחה', 'success');
                }
            } else {
                showToast(result.error || 'שגיאה', 'error');
            }
        }

        function markStepComplete() {
            closeModal('commandModal');
            stopPolling();
            hideStopButton();
            isRunning = false;
            
            if (currentStep === 1 && selectedAgent?.type === 'two-step') {
                showToast('שלב 1 הושלם - אפשר להמשיך לשלב 2', 'success');
                loadReports();
                updateStatusDisplay('report_ready', 'הדוח מוכן! בדוק אותו ולחץ על שלב 2');
            } else {
                showToast('הפעולה הושלמה', 'success');
                document.getElementById('uploadBtn').style.display = 'inline-flex';
                loadPreview();
                updateStatusDisplay('fixed', 'הקובץ מתוקן! אפשר להעלות ל-WordPress');
            }
        }
        
        // ============ Status & Polling ============
        function updateStatusDisplay(status, message, showToastMessage = false) {
            const indicator = document.getElementById('statusIndicator');
            
            const statusConfig = {
                'pending': { text: 'ממתין', class: 'status-pending' },
                'running': { text: '🔄 רץ...', class: 'status-report' },
                'report_ready': { text: '📋 דוח שלב 1', class: 'status-report' },
                'step2_done': { text: '🔧 שלב 2 הושלם', class: 'status-fixed' },
                'completed': { text: '✅ הושלם', class: 'status-uploaded' },
                'fixed': { text: '✅ מתוקן', class: 'status-uploaded' },
                'error': { text: '❌ שגיאה', class: 'status-pending' }
            };
            
            const config = statusConfig[status] || statusConfig.pending;
            indicator.textContent = config.text;
            indicator.className = `status-badge ${config.class}`;
            
            // Only show toast if explicitly requested (3rd param = true)
            // or for errors (always show)
            if (message && (showToastMessage || status === 'error')) {
                showToast(message, status === 'error' ? 'error' : 'info');
            }
        }
        
        function startPolling(expectedPath) {
            expectedReportPath = expectedPath;
            updateStatusDisplay('running', 'הסוכן רץ... מחכה לקובץ');
            
            pollInterval = setInterval(async () => {
                const result = await apiCall('/api/status/check-files', {
                    method: 'POST',
                    body: JSON.stringify({ files: [expectedPath] })
                });
                
                if (result.success && result.files[expectedPath]?.exists) {
                    stopPolling();
                    hideStopButton();
                    isRunning = false;
                    
                    showToast('הסוכן סיים! הקובץ נוצר', 'success');
                    updateStatusDisplay('report_ready', 'הדוח מוכן!');
                    
                    // Auto-load the report
                    loadReport(expectedPath);
                    
                    // If in Claude Code mode, auto-close modal
                    if (currentMode === 'claude') {
                        closeModal('commandModal');
                    }
                }
            }, 3000); // Check every 3 seconds
        }
        
        function stopPolling() {
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }
        }
        
        let statusPollInterval = null;
        
        function startStatusPolling() {
            if (statusPollInterval) return;
            
            statusPollInterval = setInterval(async () => {
                // Update running status for all pages
                await loadRunningStatus();
                renderPageList();
                
                if (!selectedPage) return;
                
                const result = await apiCall(`/api/status/page/${encodeURIComponent(selectedPage.path)}`);
                
                if (result.success) {
                    const pageName = selectedPage?.name?.replace('.html', '') || 'העמוד';
                    if (result.running) {
                        updateStatusDisplay('running', `🔄 רץ שלב ${result.info.step}...`);
                        updateWorkStatusTitle(`📄 ${pageName} - שלב ${result.info.step} רץ...`);
                        setWorkStatusDot('running');
                    } else {
                        // Job finished - reload reports
                        stopStatusPolling();
                        stopPolling();
                        hideStopButton();
                        setWorkStatusDot('completed');
                        updateWorkStatusTitle(`📄 ${pageName} - הסתיים ✅`);
                        // NOTE: Don't call clearRunningStepPrompt() here - polling may detect
                        // "not running" before server knows step started. Only clear when
                        // we get explicit completion signals (🏁 in logs, step callbacks).
                        // Refresh page list
                        await loadRunningStatus();
                        renderPageList();
                        loadReports();
                        showToast(`✅ סיים: ${pageName}`, 'success');
                    }
                }
            }, 2000);
        }
        
        function stopStatusPolling() {
            if (statusPollInterval) {
                clearInterval(statusPollInterval);
                statusPollInterval = null;
            }
        }

        // ============ Work Status Panel ============
        let workLogPollInterval = null;
        let workStatusMinimized = false;
        let lastLogContent = '';
        
        function showWorkStatusPanel() {
            const panel = document.getElementById('workStatusPanel');
            panel.classList.remove('hidden');
            const content = document.getElementById('workStatusContent');
            content.innerHTML = '⏳ מחכה להתחלת עבודה...';
            lastLogContent = '';
            // Force restart polling to get fresh logs
            stopWorkLogPolling();
            startWorkLogPolling();
        }
        
        function hideWorkStatusPanel() {
            const panel = document.getElementById('workStatusPanel');
            panel.classList.add('hidden');
            stopWorkLogPolling();
        }
        
        function toggleWorkStatus() {
            workStatusMinimized = !workStatusMinimized;
            const content = document.getElementById('workStatusContent');
            const btn = document.getElementById('minimizeBtn');
            
            if (workStatusMinimized) {
                content.style.display = 'none';
                btn.textContent = '▲';
            } else {
                content.style.display = 'block';
                btn.textContent = '▼';
            }
        }
        
        function startWorkLogPolling() {
            if (workLogPollInterval) return;
            
            // Initial fetch
            fetchWorkLog();
            
            // Poll every 300ms for real-time updates
            workLogPollInterval = setInterval(fetchWorkLog, 300);
        }
        
        function stopWorkLogPolling() {
            if (workLogPollInterval) {
                clearInterval(workLogPollInterval);
                workLogPollInterval = null;
            }
        }
        
        async function fetchWorkLog() {
            try {
                // Get log for the currently selected page AND agent
                const pagePath = selectedPage?.path || '';
                const agentId = selectedAgent?.id || '';
                const encodedPath = encodeURIComponent(pagePath);
                const encodedAgentId = encodeURIComponent(agentId);
                const result = await apiCall(`/api/worklog?page=${encodedPath}&agent_id=${encodedAgentId}`);
                if (result.success) {
                    const content = document.getElementById('workStatusContent');
                    
                    // Only update if content changed
                    if (result.content !== lastLogContent) {
                        lastLogContent = result.content;
                        
                        if (result.content) {
                            // Format and colorize the output
                            let formattedContent = formatWorkLog(result.content);
                            content.innerHTML = formattedContent;
                            
                            // Auto-scroll to bottom
                            content.scrollTop = content.scrollHeight;
                            
                            // Check if still running or completed based on log content
                            const pageName = selectedPage?.name?.replace('.html', '') || 'עמוד';
                            const isCompleted = result.content.includes('🏁 סיום!') || result.content.includes('✅ Claude סיים!');
                            
                            if (isCompleted) {
                                // Check if this is an old log (less than 10 lines means it might be stale/clearing)
                                const logLines = result.content.split('\n').filter(l => l.trim()).length;
                                if (logLines < 10) {
                                    console.log('⚠️ Log too short, might be stale - skipping completion check');
                                    return;
                                }
                                
                                // Debounce - prevent multiple refreshes
                                if (!shouldRefreshOnCompletion()) {
                                    return;
                                }
                                
                                console.log('🎉 Log shows completion!');
                                setWorkStatusDot('completed');
                                updateWorkStatusTitle(`📄 ${pageName} - הסתיים ✅`);
                                clearRunningStepPrompt(); // Step actually completed
                                
                                // Stop log polling
                                stopWorkLogPolling();
                                
                                // Clear from local running
                                if (selectedPage?.path) {
                                    delete localRunningPages[selectedPage.path];
                                }
                                
                                // Auto-refresh data (once)
                                await loadPageStatus();
                                await loadMultiAgentStatus();
                                loadReports();
                                loadPreview();
                                renderPageList();
                                updateWorkflowButtons();
                                hideStopButton();
                                
                                // Trigger Full Auto next step!
                                checkFullAutoNext();
                            } else if (result.content.includes('🔄') || result.content.includes('💭') || result.content.includes('🔧')) {
                                setWorkStatusDot('running');
                                updateWorkStatusTitle(`📄 ${pageName} - רץ...`);
                            }
                        }
                    }
                }
            } catch (e) {
                console.error('Error fetching work log:', e);
            }
        }
        
        function formatWorkLog(text) {
            // Escape HTML
            let html = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            
            // Color specific patterns - Hebrew patterns
            // Headers with emoji
            html = html.replace(/(🚀.*|🔧.*שלב 2.*)/g, '<span class="step-header">$1</span>');
            html = html.replace(/(={60})/g, '<span style="color: #666;">$1</span>');
            html = html.replace(/(-{60})/g, '<span style="color: #444;">$1</span>');
            
            // Tool usage (🔧)
            html = html.replace(/(🔧 משתמש בכלי:.*)/g, '<span class="tool-use">$1</span>');
            
            // Thinking (💭)
            html = html.replace(/(💭.*)/g, '<span class="thinking">$1</span>');
            
            // Success (✅)
            html = html.replace(/(✅.*)/g, '<span class="file-op">$1</span>');
            
            // Finish (🏁)
            html = html.replace(/(🏁.*)/g, '<span class="step-header">$1</span>');
            
            // Warnings (⚠️)
            html = html.replace(/(⚠️.*)/g, '<span style="color: #fbbf24;">$1</span>');
            
            // Error (❌)
            html = html.replace(/(❌.*)/g, '<span style="color: #e94560;">$1</span>');
            
            // Page info (📄)
            html = html.replace(/(📄.*|📋.*)/g, '<span style="color: #60a5fa;">$1</span>');
            
            // Running (🔄)
            html = html.replace(/(🔄.*)/g, '<span style="color: #fbbf24;">$1</span>');
            
            // Server update (📡)
            html = html.replace(/(📡.*)/g, '<span style="color: #4ade80;">$1</span>');
            
            return html;
        }
        
        function updateWorkStatusTitle(title) {
            document.getElementById('workStatusTitle').textContent = title || 'סטטוס עבודה';
        }
        
        function setWorkStatusDot(status) {
            const dot = document.getElementById('workStatusDot');
            dot.className = 'status-dot';
            if (status === 'running') {
                dot.classList.add('running');
                hideCorrectionsInput();
            } else if (status === 'completed') {
                dot.classList.add('completed');
                showCorrectionsInput();  // Show input when completed
            } else if (status === 'error') {
                dot.classList.add('error');
            }
        }
        
        function showCorrectionsInput() {
            document.getElementById('workStatusInput').style.display = 'block';
        }
        
        function hideCorrectionsInput() {
            document.getElementById('workStatusInput').style.display = 'none';
        }
        
        async function sendCorrection() {
            const input = document.getElementById('correctionInput');
            const correction = input.value.trim();
            
            if (!correction) {
                showToast('כתוב תיקון או הוראה', 'error');
                return;
            }
            
            if (!selectedPage) {
                showToast('בחר עמוד', 'error');
                return;
            }
            
            // Clear input
            input.value = '';
            hideCorrectionsInput();
            setWorkStatusDot('running');
            const pageName = selectedPage.name?.replace('.html', '') || 'עמוד';
            updateWorkStatusTitle(`📄 ${pageName} - ממשיך עם תיקון...`);
            
            // Send correction to server
            const result = await apiCall('/api/workflow/continue', {
                method: 'POST',
                body: JSON.stringify({
                    page_path: selectedPage.path,
                    correction: correction
                })
            });
            
            if (result.success) {
                showToast('📤 התיקון נשלח - Claude ממשיך...', 'info');
                showStopButton();
                startStatusPolling();
                startWorkLogPolling();  // Resume log polling
            } else {
                showToast(result.error || 'שגיאה בשליחת התיקון', 'error');
                setWorkStatusDot('error');
                showCorrectionsInput();  // Show input again on error
            }
        }

        // ============ Reports ============
        let currentReportPath = null;
        
        async function loadReports() {
            const deleteBtn = document.getElementById('deleteReportBtn');
            const promptBtn = document.getElementById('viewPromptBtn');
            deleteBtn.style.display = 'none';
            
            // Don't hide prompt button if a step is running - user might want to see the prompt
            if (!isRunning) {
                promptBtn.style.display = 'none';
                window.currentPromptInfo = null;
            }
            
            currentReportPath = null;
            
            if (!selectedPage) {
                document.getElementById('reportContent').innerHTML = '<p class="no-report">בחר עמוד כדי לראות דוח</p>';
                return;
            }
            
            // Check if this page is currently running
            const statusResult = await apiCall(`/api/status/page/${encodeURIComponent(selectedPage.path)}`);
            if (statusResult.success && statusResult.running) {
                updateStatusDisplay('running', `רץ שלב ${statusResult.info.step}...`);
                // Keep polling while running
                if (!pollInterval) {
                    startStatusPolling();
                }
            }
            
            if (!selectedAgent) {
                document.getElementById('reportContent').innerHTML = '<p class="no-report">בחר סוכן כדי לראות דוח</p>';
                return;
            }
            
            // For single-step agents, no report to show
            if (selectedAgent.type === 'single-step') {
                document.getElementById('reportContent').innerHTML = '<p class="no-report">סוכן חד-שלבי - אין דוח.<br>הסוכן מבצע תיקונים ישירות.</p>';
                updateStatusDisplay('pending', 'מוכן להרצה');
                updateWorkflowButtons();
                return;
            }
            
            // Use new folder structure - check agent folder directly
            const agentFolder = getAgentFolder(selectedPage.path, selectedAgent);
            const isFourStep = isAgentFourStep(selectedAgent);
            const isSixStep = isAgentSixStep(selectedAgent);
            const stepCount = getAgentStepCount(selectedAgent);
            
            // === DYNAMIC: Get report names from steps array if available ===
            let reportPaths = [];
            let reportNames = [];
            
            if (selectedAgent.steps && selectedAgent.steps.length > 0) {
                // Dynamic agent with steps array
                for (let i = 0; i < selectedAgent.steps.length; i++) {
                    const step = selectedAgent.steps[i];
                    const outputPath = step.output?.path || `דוח שלב ${i + 1}.md`;
                    reportNames.push(outputPath);
                    reportPaths.push(`${agentFolder}/${outputPath}`);
                }
            } else {
                // Legacy agent with stepX objects
                const report1Name = selectedAgent.step1?.output_name || 'דוח שלב 1.md';
                let report2Name, report3Name, report4Name, report5Name, report6Name;
                
                if (isSixStep) {
                    report2Name = selectedAgent.step2?.output_name || 'דוח שלב 1 מורחב.md';
                    report3Name = selectedAgent.step3?.report_name || 'דוח שלב 3.md';
                    report4Name = selectedAgent.step4?.report_name || 'דוח שלב 4.md';
                    report5Name = selectedAgent.step5?.report_name || 'דוח שלב 5.md';
                    report6Name = selectedAgent.step6?.report_name || 'דוח דיבאג AI.md';
                } else if (isFourStep) {
                    report2Name = selectedAgent.step2?.output_name || 'דוח שלב 1 מורחב.md';
                    report3Name = selectedAgent.step3?.report_name || 'דוח שלב 3.md';
                    report4Name = selectedAgent.step4?.report_name || 'דוח דיבאג.md';
                    report5Name = null;
                    report6Name = null;
                } else {
                    report2Name = selectedAgent.step2?.report_name || 'דוח שלב 2.md';
                    report3Name = selectedAgent.step3?.report_name || 'דוח דיבאג.md';
                    report4Name = null;
                    report5Name = null;
                    report6Name = null;
                }
                
                reportNames = [report1Name, report2Name, report3Name, report4Name, report5Name, report6Name].filter(n => n);
                reportPaths = reportNames.map(name => `${agentFolder}/${name}`);
            }
            
            // Build list of files to check
            const filesToCheck = reportPaths;
            
            // Check which reports exist
            const checkFiles = await apiCall('/api/status/check-files', {
                method: 'POST',
                body: JSON.stringify({ files: filesToCheck })
            });
            
            if (checkFiles.success) {
                // === DYNAMIC: Build available reports list from checked files ===
                const availableReports = [];
                
                for (let i = 0; i < reportPaths.length; i++) {
                    const path = reportPaths[i];
                    const exists = checkFiles.files[path]?.exists;
                    
                    if (exists) {
                        // Get step name from agent config or use default
                        let stepName = `דוח שלב ${i + 1}`;
                        
                        if (selectedAgent.steps && selectedAgent.steps[i]) {
                            // Dynamic agent - use step name from config
                            stepName = selectedAgent.steps[i].name || stepName;
                        } else {
                            // Legacy agent - use hardcoded names
                            if (isFourStep || isSixStep) {
                                const legacyNames = ['דוח שלב 1', 'דוח QA מורחב', 'דוח תיקונים', 'דוח דיבאג', 'דוח הסרת AI', 'דוח דיבאג AI'];
                                stepName = legacyNames[i] || stepName;
                            }
                        }
                        
                        availableReports.push({ path, name: stepName, step: i + 1 });
                    }
                }
                
                console.log('Report check:', { 
                    stepCount,
                    reportPaths,
                    availableReports,
                    agentFolder
                });
                
                if (availableReports.length > 0) {
                    // Show tabs for multiple reports
                    await loadMultipleReports(availableReports);
                    deleteBtn.style.display = 'inline-flex';
                    
                    // Show prompt button and set current info for viewing
                    // Only update if not already set by a running step
                    const promptBtn = document.getElementById('viewPromptBtn');
                    promptBtn.style.display = 'inline-flex';
                    const lastReport = availableReports[availableReports.length - 1];
                    console.log('📝 Reports loaded, runningStepPromptInfo:', window.runningStepPromptInfo);
                    if (!window.runningStepPromptInfo) {
                        // Use agent folder_name for agentType
                        const agentFolderName = selectedAgent.folder_name || selectedAgent.name || selectedAgent.id;
                        window.currentPromptInfo = {
                            pagePath: selectedPage.path,
                            step: `step${lastReport.step}`,
                            agentType: agentFolderName
                        };
                        console.log('📝 Reports updated currentPromptInfo to:', window.currentPromptInfo);
                    } else {
                        console.log('📝 Reports NOT updating - step is running');
                    }
                    
                    // Set status based on highest completed step - DYNAMIC
                    const maxStep = Math.max(...availableReports.map(r => r.step));
                    const totalSteps = stepCount || (isSixStep ? 6 : (isFourStep ? 4 : 3));
                    
                    if (maxStep >= totalSteps) {
                        updateStatusDisplay('completed', '✓ הושלם');
                    } else {
                        updateStatusDisplay(`step${maxStep}_done`, `שלב ${maxStep} הושלם`);
                    }
                    
                    // Set current report path to the latest
                    currentReportPath = availableReports[availableReports.length - 1].path;
                } else {
                    const agentName = selectedAgent.name || selectedAgent.id;
                    document.getElementById('reportContent').innerHTML = `<p class="no-report">אין דוח "${agentName}" לעמוד זה.<br>הרץ שלב 1 כדי ליצור דוח.</p>`;
                    updateStatusDisplay('pending', 'ממתין לדוח');
                }
            } else {
                document.getElementById('reportContent').innerHTML = '<p class="no-report">אין דוחות.<br>הרץ שלב 1 כדי ליצור דוח.</p>';
                updateStatusDisplay('pending', 'ממתין');
            }
            
            // Update workflow buttons based on report availability
            updateWorkflowButtons();
        }

        async function loadReport(path) {
            const result = await apiCall(`/api/report/${path}?render=true`);
            if (result.success) {
                document.getElementById('reportContent').innerHTML = result.html || `<pre>${result.content}</pre>`;
            }
        }
        
        async function loadMultipleReports(reports) {
            const pagePath = selectedPage?.path || '';
            // Use agent folder_name for agentType
            const agentType = selectedAgent?.folder_name || selectedAgent?.name || selectedAgent?.id || 'agent';
            
            // Create tabs - add prompt tabs for each step
            let tabsHtml = '<div class="report-tabs">';
            
            // Add prompt tabs first (for each report step)
            const uniqueSteps = [...new Set(reports.map(r => r.step))];
            uniqueSteps.forEach((step) => {
                tabsHtml += `<button class="report-tab prompt-tab" data-step="${step}" data-type="prompt" onclick="loadPromptTab('${pagePath.replace(/\\/g, '/').replace(/'/g, "\\'")}', 'step${step}', '${agentType}')">📝 פרומפט ${step}</button>`;
            });
            
            // Add report tabs
            reports.forEach((report, index) => {
                const activeClass = index === reports.length - 1 ? 'active' : '';
                tabsHtml += `<button class="report-tab ${activeClass}" data-index="${index}" data-type="report" onclick="switchReportTab(${index})">${report.name}</button>`;
            });
            tabsHtml += '</div><div class="report-contents">';
            
            // Load all reports
            for (let i = 0; i < reports.length; i++) {
                const report = reports[i];
                const result = await apiCall(`/api/report/${report.path}?render=true`);
                const content = result.success ? (result.html || `<pre>${result.content}</pre>`) : '<p>שגיאה בטעינת הדוח</p>';
                const activeClass = i === reports.length - 1 ? 'active' : '';
                tabsHtml += `<div class="report-content-tab ${activeClass}" data-index="${i}">${content}</div>`;
            }
            tabsHtml += '</div>';
            
            document.getElementById('reportContent').innerHTML = tabsHtml;
            
            // Store reports for tab switching
            window.currentReports = reports;
        }
        
        function switchReportTab(index) {
            // Deactivate all tabs
            document.querySelectorAll('.report-tab').forEach((tab) => {
                tab.classList.remove('active');
            });
            // Activate the clicked report tab
            const reportTabs = document.querySelectorAll('.report-tab[data-type="report"]');
            if (reportTabs[index]) {
                reportTabs[index].classList.add('active');
            }
            
            // Hide prompt content, show report contents
            const promptContent = document.getElementById('promptContentTab');
            if (promptContent) promptContent.style.display = 'none';
            
            // Update content
            document.querySelectorAll('.report-content-tab').forEach((content, i) => {
                content.classList.toggle('active', i === index);
                content.style.display = i === index ? 'block' : 'none';
            });
            
            // Update current report path for delete
            if (window.currentReports && window.currentReports[index]) {
                const report = window.currentReports[index];
                currentReportPath = report.path;
                // Only update currentPromptInfo if no step is actively running
                if (!window.runningStepPromptInfo) {
                    // Extract agent folder name from report path to determine agent
                    const pathParts = report.path.split('/');
                    const agentFolderName = pathParts.length >= 2 ? pathParts[pathParts.length - 2] : 'SEO';
                    // Find agent by folder_name
                    const matchedAgent = window.allAgents?.find(a => a.folder_name === agentFolderName) || selectedAgent;
                    
                    window.currentPromptInfo = {
                        pagePath: selectedPage?.path || '',
                        step: `step${report.step}`,
                        agentType: agentFolderName,
                        agentId: matchedAgent?.id || selectedAgent?.id || 'seo'
                    };
                }
            }
        }
        
        async function loadPromptTab(pagePath, step, agentType) {
            console.log('📝 loadPromptTab called:', { pagePath, step, agentType });
            
            // Deactivate all tabs
            document.querySelectorAll('.report-tab').forEach((tab) => {
                tab.classList.remove('active');
            });
            // Activate the clicked prompt tab
            const promptTab = document.querySelector(`.report-tab[data-step="${step.replace('step', '')}"][data-type="prompt"]`);
            if (promptTab) promptTab.classList.add('active');
            
            // Hide all report contents
            document.querySelectorAll('.report-content-tab').forEach((content) => {
                content.style.display = 'none';
                content.classList.remove('active');
            });
            
            // Show or create prompt content area
            let promptContent = document.getElementById('promptContentTab');
            if (!promptContent) {
                const contentsDiv = document.querySelector('.report-contents');
                if (contentsDiv) {
                    promptContent = document.createElement('div');
                    promptContent.id = 'promptContentTab';
                    promptContent.className = 'report-content-tab prompt-content-display';
                    contentsDiv.appendChild(promptContent);
                }
            }
            
            if (promptContent) {
                promptContent.style.display = 'block';
                promptContent.innerHTML = '<div style="padding: 1rem; color: var(--text-secondary);">🔄 טוען פרומפט...</div>';
                
                try {
                    const url = `/api/step/prompt?page_path=${encodeURIComponent(pagePath)}&step=${step}&agent_type=${agentType}`;
                    console.log('📝 Fetching prompt from:', url);
                    const response = await fetch(url);
                    const data = await response.json();
                    console.log('📝 Prompt API response:', data);
                    
                    if (data.success) {
                        // Format and highlight keywords section
                        let content = data.prompt;
                        content = content.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                        content = content.replace(/(## מילות מפתח נלוות לשילוב[\s\S]*?### רשימת שימור:.*)/g, 
                            '<div class="prompt-highlight">$1</div>');
                        content = content.replace(/(## מילות מפתח חשובות[\s\S]*?אל תמחק!)/g, 
                            '<div class="prompt-highlight">$1</div>');
                        
                        promptContent.innerHTML = `
                            <div class="prompt-header" style="padding: 0.5rem 1rem; background: var(--bg-tertiary); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                                <span>📝 פרומפט ${step.replace('step', 'שלב ')}</span>
                                <button class="btn btn-small" onclick="copyPromptFromTab()">📋 העתק</button>
                            </div>
                            <div class="prompt-body" style="padding: 1rem; font-family: 'Courier New', monospace; font-size: 0.85rem; white-space: pre-wrap; direction: rtl; text-align: right; max-height: 70vh; overflow-y: auto;">
${content}
                            </div>
                        `;
                    } else {
                        promptContent.innerHTML = `<div style="padding: 1rem; color: #ef4444;">❌ ${data.error || 'לא נמצא פרומפט'}</div>`;
                    }
                } catch (err) {
                    promptContent.innerHTML = `<div style="padding: 1rem; color: #ef4444;">❌ שגיאה: ${err.message}</div>`;
                }
            }
        }
        
        function copyPromptFromTab() {
            const promptBody = document.querySelector('#promptContentTab .prompt-body');
            if (promptBody) {
                navigator.clipboard.writeText(promptBody.innerText).then(() => {
                    showToast('הפרומפט הועתק', 'success');
                }).catch(err => {
                    showToast('שגיאה בהעתקה', 'error');
                });
            }
        }
        
        async function deleteCurrentReport() {
            if (!currentReportPath) {
                showToast('אין דוח למחיקה', 'error');
                return;
            }
            
            if (!confirm('האם אתה בטוח שרוצה למחוק את הדוח?')) {
                return;
            }
            
            const result = await apiCall(`/api/report/delete`, {
                method: 'POST',
                body: JSON.stringify({ path: currentReportPath })
            });
            
            if (result.success) {
                showToast('הדוח נמחק', 'success');
                currentReportPath = null;
                document.getElementById('deleteReportBtn').style.display = 'none';
                document.getElementById('reportContent').innerHTML = '<p class="no-report">הדוח נמחק.<br>הרץ שלב 1 כדי ליצור דוח חדש.</p>';
            } else {
                showToast(result.error || 'שגיאה במחיקה', 'error');
            }
        }

        // ============ WordPress ============
        async function testWpConnection(siteId) {
            // Get card for this site using data-attribute (dynamic)
            const card = document.querySelector(`.site-config-card[data-site-id="${siteId}"]`);
            if (!card) {
                showToast(`לא נמצא כרטיס עבור אתר ${siteId}`, 'error');
                return;
            }
            
            const user = card.querySelector('[data-field="wp_user"]')?.value || '';
            const pass = card.querySelector('[data-field="wp_pass"]')?.value || '';
            const url = card.querySelector('[data-field="wp_url"]')?.value || '';

            // First save settings
            await apiCall('/api/wordpress/settings', {
                method: 'POST',
                body: JSON.stringify({
                    site_id: siteId,
                    username: user,
                    password: pass,
                    site_url: url
                })
            });

            // Then test connection
            const result = await apiCall('/api/wordpress/test', {
                method: 'POST',
                body: JSON.stringify({ site_id: siteId })
            });

            const statusEl = card.querySelector(`[data-wp-status="${siteId}"]`);
            if (result.success) {
                if (statusEl) {
                    statusEl.textContent = '✅ מחובר';
                    statusEl.className = 'wp-site-status connected';
                }
                showToast(`מחובר בהצלחה! ${result.user_display_name || ''}`, 'success');
            } else {
                if (statusEl) {
                    statusEl.textContent = '❌ נכשל';
                    statusEl.className = 'wp-site-status disconnected';
                }
                showToast(result.error || 'שגיאת התחברות', 'error');
            }
        }

        // Upload state
        let uploadState = {
            pageInfo: null,
            backupMeta: null,
            backupContent: null,
            newContent: null,
            postId: null,
            url: null
        };

        // Open upload modal for a specific page from sidebar
        async function openUploadModalForPage(pageIndex) {
            // First select the page
            await selectPage(pageIndex);
            // Then open upload modal
            uploadToWordPress();
        }
        
        async function uploadToWordPress() {
            if (!selectedPage) {
                showToast('בחר עמוד קודם', 'error');
                return;
            }

            // Open modal and show loading
            openModal('uploadModal');
            document.getElementById('uploadLoading').style.display = 'block';
            document.getElementById('uploadContent').style.display = 'none';
            // Disable all upload buttons
            document.getElementById('confirmUploadBtn').disabled = true;
            document.getElementById('uploadWpTitleBtn').disabled = true;
            document.getElementById('uploadTitleBtn').disabled = true;
            document.getElementById('uploadDescBtn').disabled = true;
            document.getElementById('uploadContentBtn').disabled = true;
            document.getElementById('compareBtn').disabled = true;

            try {
                // Get page info from page_info.json
                const infoResult = await apiCall(`/api/page/info?path=${encodeURIComponent(selectedPage.path)}`);
                
                if (infoResult.success && infoResult.has_info) {
                    uploadState.pageInfo = infoResult.info;
                    uploadState.postId = infoResult.info.post_id;
                    uploadState.url = infoResult.info.url;
                    uploadState.keyword = infoResult.info.keyword || '';
                } else {
                    // Try to get from selectedPage
                    uploadState.postId = selectedPage.post_id;
                    uploadState.url = selectedPage.url;
                    uploadState.keyword = '';
                    uploadState.pageInfo = { 
                        page_name: selectedPage.name, 
                        post_id: selectedPage.post_id,
                        url: selectedPage.url 
                    };
                }

                if (!uploadState.postId) {
                    showToast('חסר Post ID לעמוד זה. הרץ את init_page_info.py', 'error');
                    closeModal('uploadModal');
                    return;
                }

                // Check for existing backup
                const backupResult = await apiCall(`/api/page/backup?path=${encodeURIComponent(selectedPage.path)}`);
                if (backupResult.success) {
                    uploadState.backupMeta = backupResult.meta;
                    uploadState.backupContent = cleanupInvalidHtml(backupResult.content);
                }

                // Load new content from HTML file
                const pageFolder = selectedPage.path.replace(/\/[^\/]+\.html$/, '').replace(/\\[^\\]+\.html$/, '');
                const htmlFiles = await apiCall(`/api/files?folder=${encodeURIComponent(pageFolder)}`);
                if (htmlFiles.success) {
                    const htmlFile = htmlFiles.files?.find(f => f.name.endsWith('.html') && !f.name.includes('backup'));
                    if (htmlFile) {
                        console.log('📄 Loading HTML file:', htmlFile.path, 'Size:', htmlFile.size || 'unknown');
                        const contentResult = await apiCall(`/api/file/content?path=${encodeURIComponent(htmlFile.path)}`);
                        if (contentResult.success) {
                            uploadState.newContent = cleanupInvalidHtml(contentResult.content);
                            console.log('📄 Content loaded, length:', uploadState.newContent?.length || 0);
                            console.log('📄 Content preview (first 500 chars):', uploadState.newContent?.substring(0, 500));
                        }
                    }
                }

                // Update UI
                updateUploadModal();
                
                document.getElementById('uploadLoading').style.display = 'none';
                document.getElementById('uploadContent').style.display = 'block';
                // Enable all upload buttons
                document.getElementById('confirmUploadBtn').disabled = false;
                document.getElementById('uploadWpTitleBtn').disabled = false;
                document.getElementById('uploadTitleBtn').disabled = false;
                document.getElementById('uploadDescBtn').disabled = false;
                document.getElementById('uploadContentBtn').disabled = false;

            } catch (error) {
                console.error('Upload modal error:', error);
                showToast('שגיאה בטעינת נתוני העמוד', 'error');
                closeModal('uploadModal');
            }
        }

        function updateUploadModal() {
            // Page info
            document.getElementById('uploadPageName').textContent = uploadState.pageInfo?.page_name || selectedPage?.name || '-';
            document.getElementById('uploadPostIdInput').value = uploadState.postId || '';
            document.getElementById('uploadKeywordInput').value = uploadState.pageInfo?.keyword || uploadState.keyword || '';
            
            const urlEl = document.getElementById('uploadPageUrl');
            if (uploadState.url) {
                urlEl.textContent = uploadState.url;
                urlEl.href = uploadState.url;
            } else {
                urlEl.textContent = '-';
                urlEl.removeAttribute('href');
            }

            // Backup status
            const backupStatus = document.getElementById('backupStatus');
            const backupTitleDisplay = document.getElementById('backupTitleDisplay');
            const backupDescDisplay = document.getElementById('backupDescDisplay');
            
            if (uploadState.backupMeta) {
                backupStatus.textContent = `✅ גיבוי קיים (${uploadState.backupMeta.fetched_at?.split('T')[0] || 'לא ידוע'})`;
                backupStatus.className = 'backup-badge exists';
                document.getElementById('compareBtn').disabled = false;
                // Enable restore buttons
                document.getElementById('restoreTitleBtn').disabled = false;
                document.getElementById('restoreDescBtn').disabled = false;
                document.getElementById('restoreContentBtn').disabled = false;
                document.getElementById('restoreAllBtn').disabled = false;
                
                // Show backup Title
                if (uploadState.backupMeta.title) {
                    const backupTitle = uploadState.backupMeta.title;
                    document.getElementById('backupTitleText').textContent = backupTitle;
                    document.getElementById('backupTitleCount').textContent = backupTitle.length;
                    backupTitleDisplay.style.display = 'block';
                } else {
                    backupTitleDisplay.style.display = 'none';
                }
                
                // Show backup Description
                if (uploadState.backupMeta.description) {
                    const backupDesc = uploadState.backupMeta.description;
                    document.getElementById('backupDescText').textContent = backupDesc;
                    document.getElementById('backupDescCount').textContent = backupDesc.length;
                    backupDescDisplay.style.display = 'block';
                } else {
                    backupDescDisplay.style.display = 'none';
                }
            } else {
                backupStatus.textContent = '❌ אין גיבוי';
                backupStatus.className = 'backup-badge missing';
                document.getElementById('compareBtn').disabled = true;
                // Disable restore buttons
                document.getElementById('restoreTitleBtn').disabled = true;
                document.getElementById('restoreDescBtn').disabled = true;
                document.getElementById('restoreContentBtn').disabled = true;
                document.getElementById('restoreAllBtn').disabled = true;
                // Hide backup displays
                backupTitleDisplay.style.display = 'none';
                backupDescDisplay.style.display = 'none';
            }

            // WordPress Post Title (separate from Yoast)
            const wpTitleInput = document.getElementById('uploadWpTitle');
            const currentWpTitle = uploadState.pageInfo?.wp_post_title || uploadState.pageInfo?.page_name || uploadState.backupMeta?.wp_post_title || '';
            wpTitleInput.value = currentWpTitle;
            
            // Show backup WP Title if available
            const backupWpTitleDisplay = document.getElementById('backupWpTitleDisplay');
            if (uploadState.backupMeta?.wp_post_title) {
                const backupWpTitle = uploadState.backupMeta.wp_post_title;
                document.getElementById('backupWpTitleText').textContent = backupWpTitle;
                document.getElementById('backupWpTitleCount').textContent = backupWpTitle.length;
                backupWpTitleDisplay.style.display = 'block';
            } else {
                backupWpTitleDisplay.style.display = 'none';
            }
            
            // Metadata editor - use page_info.json values (if updated after upload) 
            // Fall back to backup meta if no current value
            const titleInput = document.getElementById('uploadTitle');
            const descInput = document.getElementById('uploadDescription');
            
            // Priority: pageInfo.title (from JSON - updated after upload) > backupMeta.title (from WordPress)
            const currentTitle = uploadState.pageInfo?.title || uploadState.backupMeta?.title || '';
            const currentDesc = uploadState.pageInfo?.description || uploadState.backupMeta?.description || '';
            
            titleInput.value = currentTitle;
            descInput.value = currentDesc;
            
            // Setup suffix preview if enabled (must be before char count update)
            setupSuffixPreview();
            
            // Update character counts (after suffix is set up)
            updateCharCount('uploadWpTitle', 'uploadWpTitleCount', 100);
            updateTitleCharCountWithSuffix();
            updateCharCount('uploadDescription', 'uploadDescCount', 160);

            // Add event listeners for char count
            wpTitleInput.oninput = () => updateCharCount('uploadWpTitle', 'uploadWpTitleCount', 100);
            titleInput.oninput = () => updateTitleCharCountWithSuffix();
            descInput.oninput = () => updateCharCount('uploadDescription', 'uploadDescCount', 160);
        }
        
        function getSiteSuffix(siteId) {
            // Get suffix from wpSitesConfig (loaded via loadUIConfig)
            const site = wpSitesConfig?.[siteId || 'main'];
            if (site?.title_suffix_enabled && site?.title_suffix) {
                return site.title_suffix;
            }
            return '';
        }
        
        function setupSuffixPreview() {
            const site = selectedPage?.site || 'main';
            const suffix = getSiteSuffix(site);
            const suffixPreview = document.getElementById('titleSuffixPreview');
            const suffixCountSpan = document.getElementById('titleSuffixCount');
            
            if (suffix && suffix.length > 0) {
                suffixPreview.textContent = suffix;
                suffixPreview.style.display = 'inline-flex';
                suffixCountSpan.textContent = ` + ${suffix.length}`;
            } else {
                suffixPreview.style.display = 'none';
                suffixCountSpan.textContent = '';
            }
        }
        
        function updateTitleCharCountWithSuffix() {
            const input = document.getElementById('uploadTitle');
            const count = document.getElementById('uploadTitleCount');
            const suffixCountSpan = document.getElementById('titleSuffixCount');
            const site = selectedPage?.site || 'main';
            const suffix = getSiteSuffix(site);
            const suffixLen = suffix ? suffix.length : 0;
            const titleLen = input.value.length;
            const total = titleLen + suffixLen;
            const maxLength = 70;
            
            if (suffixLen > 0) {
                count.textContent = `${titleLen}`;
                suffixCountSpan.textContent = ` + ${suffixLen} = ${total}`;
            } else {
                count.textContent = `${titleLen}/${maxLength} תווים`;
                suffixCountSpan.textContent = '';
            }
            
            count.style.color = total > maxLength ? 'var(--accent)' : 'var(--text-secondary)';
        }

        function updateCharCount(inputId, countId, maxLength) {
            const input = document.getElementById(inputId);
            const count = document.getElementById(countId);
            const len = input.value.length;
            count.textContent = `${len}/${maxLength} תווים`;
            count.style.color = len > maxLength ? 'var(--accent)' : 'var(--text-secondary)';
        }

        async function savePageInfo() {
            const newPostId = document.getElementById('uploadPostIdInput').value.trim();
            const newKeyword = document.getElementById('uploadKeywordInput').value.trim();
            
            if (!newPostId) {
                showToast('Post ID לא יכול להיות ריק', 'error');
                return;
            }
            
            try {
                const pageFolder = getPageFolder(selectedPage.path);
                const response = await fetch('/api/page/update-info', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        page_folder: pageFolder,
                        post_id: newPostId,
                        keyword: newKeyword
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    // Update local state
                    uploadState.postId = newPostId;
                    uploadState.keyword = newKeyword;
                    if (uploadState.pageInfo) {
                        uploadState.pageInfo.post_id = newPostId;
                        uploadState.pageInfo.keyword = newKeyword;
                    }
                    showToast('✅ page_info.json עודכן בהצלחה', 'success');
                } else {
                    showToast('שגיאה בשמירה: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error saving page info:', error);
                showToast('שגיאה בשמירה', 'error');
            }
        }

        // Save Title & Description locally to page_info.json
        async function saveMetaLocally() {
            if (!selectedPage || !selectedPage.path) {
                showToast('שגיאה: לא נבחר עמוד', 'error');
                return;
            }

            const title = document.getElementById('uploadTitle').value.trim();
            const description = document.getElementById('uploadDescription').value.trim();
            
            if (!title && !description) {
                showToast('אין שינויים לשמור', 'warning');
                return;
            }

            try {
                showToast('שומר מטא-תגיות...', 'info');
                
                const pageFolder = getPageFolder(selectedPage.path);
                const response = await fetch('/api/page/update-meta-tags', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        page_folder: pageFolder,
                        title: title,
                        description: description
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    // Update local state
                    if (uploadState.pageInfo) {
                        uploadState.pageInfo.title = title;
                        uploadState.pageInfo.description = description;
                    }
                    showToast('✅ מטא-תגיות נשמרו בהצלחה ל-page_info.json', 'success');
                } else {
                    showToast('שגיאה בשמירה: ' + (result.error || 'לא ידוע'), 'error');
                }
            } catch (error) {
                console.error('Error saving meta tags:', error);
                showToast('שגיאה בשמירת מטא-תגיות: ' + error.message, 'error');
            }
        }

        // Edit heading from SEO report
        async function editHeading(tagType, index, currentText, event) {
            // Prevent any default behavior
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            // Check if page is selected
            if (!selectedPage || !selectedPage.path) {
                showToast('שגיאה: לא נבחר עמוד', 'error');
                console.error('selectedPage:', selectedPage);
                return;
            }
            
            const newText = prompt(`ערוך כותרת ${tagType.toUpperCase()}:`, currentText);
            if (newText === null || newText === currentText) return;
            
            if (!newText.trim()) {
                showToast('כותרת לא יכולה להיות ריקה', 'error');
                return;
            }
            
            try {
                showToast('שומר שינויים...', 'info');
                
                console.log('Editing heading:', { file_path: selectedPage.path, tag_type: tagType, old_text: currentText, new_text: newText.trim() });
                
                const response = await fetch('/api/edit-heading', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        file_path: selectedPage.path,
                        tag_type: tagType,
                        old_text: currentText,
                        new_text: newText.trim()
                    })
                });
                
                const result = await response.json();
                console.log('Edit heading result:', result);
                
                if (result.success) {
                    showToast('✅ הכותרת עודכנה בהצלחה', 'success');
                    // Refresh the new content preview
                    await refreshNewContentPreview();
                } else {
                    showToast('שגיאה: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error editing heading:', error);
                showToast('שגיאה בעריכת הכותרת: ' + error.message, 'error');
            }
        }

        async function fetchWordPressBackup() {
            if (!uploadState.postId) {
                showToast('חסר Post ID', 'error');
                return;
            }

            showToast('שולף נתונים מ-WordPress...', 'info');

            try {
                const pageFolder = selectedPage.path.replace(/[\/\\][^\/\\]+\.html$/, '');
                
                const result = await apiCall('/api/wordpress/fetch', {
                    method: 'POST',
                    body: JSON.stringify({
                        post_id: uploadState.postId,
                        url: uploadState.url,
                        page_folder: pageFolder
                    })
                });

                if (result.success) {
                    // Debug: Log what WordPress returned
                    const rawLen = result.data.content_raw?.length || 0;
                    const renderedLen = result.data.content_rendered?.length || 0;
                    const rawHasScript = result.data.content_raw?.includes('<script') || false;
                    const rawHasStyle = result.data.content_raw?.includes('<style') || false;
                    const renderedHasScript = result.data.content_rendered?.includes('<script') || false;
                    const renderedHasStyle = result.data.content_rendered?.includes('<style') || false;
                    
                    console.log('=' .repeat(60));
                    console.log('📊 WordPress fetch debug:');
                    console.log('   raw length:', rawLen);
                    console.log('   rendered length:', renderedLen);
                    console.log('   raw has <script>:', rawHasScript);
                    console.log('   raw has <style>:', rawHasStyle);
                    console.log('   rendered has <script>:', renderedHasScript);
                    console.log('   rendered has <style>:', renderedHasStyle);
                    console.log('   raw preview:', result.data.content_raw?.substring(0, 300));
                    console.log('=' .repeat(60));
                    
                    uploadState.backupMeta = {
                        title: result.data.meta_title,
                        description: result.data.meta_description,
                        slug: result.data.slug,
                        og_title: result.data.og_title,
                        og_description: result.data.og_description,
                        fetched_at: new Date().toISOString()
                    };
                    // Always use RAW content - it preserves <!-- wp:html --> blocks with CSS/JS
                    uploadState.backupContent = cleanupInvalidHtml(result.data.content_raw || result.data.content_rendered);
                    console.log(`✅ Using RAW content (${rawLen} chars)`);
                    
                    updateUploadModal();
                    showToast('✅ גיבוי נשמר בהצלחה!', 'success');
                } else {
                    showToast(result.error || 'שגיאה בשליפה מ-WordPress', 'error');
                }
            } catch (error) {
                console.error('Fetch backup error:', error);
                showToast('שגיאה בשליפה מ-WordPress', 'error');
            }
        }

        async function openCompareView() {
            openModal('compareModal');
            
            // Reset diff highlight state
            diffHighlightEnabled = false;
            const btn = document.getElementById('highlightDiffBtn');
            if (btn) {
                btn.classList.remove('active');
                btn.innerHTML = '🔍 הדגש שינויים';
            }
            
            // Reset edit mode state
            editModeEnabled = false;
            const editBtn = document.getElementById('editModeBtn');
            if (editBtn) {
                editBtn.classList.remove('active');
                editBtn.innerHTML = '📝 הערות';
            }
            document.getElementById('annotationsSidebar').classList.add('hidden');
            annotations = [];
            renderAnnotationsList();
            closeAnnotationPopup();
            
            // Reset direct edit mode
            directEditEnabled = false;
            hasUnsavedChanges = false;
            const directEditBtn = document.getElementById('directEditBtn');
            const saveBtn = document.getElementById('saveDirectEditBtn');
            if (directEditBtn) {
                directEditBtn.classList.remove('active');
                directEditBtn.innerHTML = '✍️ עריכה ישירה';
            }
            if (saveBtn) {
                saveBtn.style.display = 'none';
                saveBtn.classList.remove('pulse-green');
            }
            
            // Load content if not already loaded
            if (!uploadState.backupContent || !uploadState.newContent) {
                console.log('Loading content for compare view...');
                try {
                    // Load backup from local file
                    const backupResult = await apiCall(`/api/page/backup?path=${encodeURIComponent(selectedPage.path)}`);
                    if (backupResult.success && backupResult.content) {
                        uploadState.backupMeta = backupResult.meta;
                        uploadState.backupContent = cleanupInvalidHtml(backupResult.content);
                    }
                    
                    // Load new content
                    const htmlResult = await apiCall(`/api/page/html-content?path=${encodeURIComponent(selectedPage.path)}`);
                    if (htmlResult.success && htmlResult.content) {
                        uploadState.newContent = cleanupInvalidHtml(htmlResult.content);
                    }
                } catch (err) {
                    console.error('Error loading compare content:', err);
                }
            }
            
            // Old content (from backup)
            const oldContentEl = document.getElementById('compareOldContent');
            if (uploadState.backupContent) {
                oldContentEl.innerHTML = '<iframe id="compareOldFrame"></iframe>';
                const oldFrame = document.getElementById('compareOldFrame');
                oldFrame.onload = () => setupSyncScroll();
                const oldDoc = oldFrame.contentDocument || oldFrame.contentWindow.document;
                oldDoc.open();
                oldDoc.write(`<!DOCTYPE html><html dir="rtl"><head><meta charset="UTF-8"><base target="_blank"><style>body{font-family:Arial,sans-serif;padding:20px;margin:0;} a{color:#2563eb;text-decoration:underline;cursor:pointer;} a:hover{color:#1d4ed8;background:rgba(37,99,235,0.1);}</style></head><body>${uploadState.backupContent}</body></html>`);
                oldDoc.close();
            } else {
                oldContentEl.innerHTML = '<div class="empty-state">אין גיבוי זמין</div>';
            }

            // New content
            const newContentEl = document.getElementById('compareNewContent');
            if (uploadState.newContent) {
                newContentEl.innerHTML = '<iframe id="compareNewFrame"></iframe>';
                const newFrame = document.getElementById('compareNewFrame');
                newFrame.onload = () => setupSyncScroll();
                const newDoc = newFrame.contentDocument || newFrame.contentWindow.document;
                newDoc.open();
                newDoc.write(`<!DOCTYPE html><html dir="rtl"><head><meta charset="UTF-8"><base target="_blank"><style>body{font-family:Arial,sans-serif;padding:20px;margin:0;} a{color:#2563eb;text-decoration:underline;cursor:pointer;} a:hover{color:#1d4ed8;background:rgba(37,99,235,0.1);}</style></head><body>${uploadState.newContent}</body></html>`);
                newDoc.close();
            } else {
                newContentEl.innerHTML = '<div class="empty-state">אין תוכן חדש</div>';
            }
        }
        
        async function refreshCompareView() {
            // Reload the HTML file content
            try {
                const pageFolder = getPageFolder(selectedPage.path);
                const response = await fetch(`/api/page/html-content?page_folder=${encodeURIComponent(pageFolder)}`);
                const result = await response.json();
                
                if (result.success && result.content) {
                    uploadState.newContent = cleanupInvalidHtml(result.content);
                    
                    // Refresh the new content iframe
                    const newContentEl = document.getElementById('compareNewContent');
                    newContentEl.innerHTML = '<iframe id="compareNewFrame"></iframe>';
                    const newFrame = document.getElementById('compareNewFrame');
                    newFrame.onload = () => {
                        setupSyncScroll();
                        // Re-apply edit mode handlers if active
                        if (editModeEnabled) {
                            newFrame.classList.add('edit-mode-active');
                            injectUnifiedEditHandlers(newFrame);
                        }
                        // Refresh the SEO report
                        if (typeof generateSeoReport === 'function') {
                            setTimeout(() => generateSeoReport(), 100);
                        }
                    };
                    const newDoc = newFrame.contentDocument || newFrame.contentWindow.document;
                    newDoc.open();
                    newDoc.write(`<!DOCTYPE html><html dir="rtl"><head><meta charset="UTF-8"><base target="_blank"><style>body{font-family:Arial,sans-serif;padding:20px;margin:0;} a{color:#2563eb;text-decoration:underline;cursor:pointer;} a:hover{color:#1d4ed8;background:rgba(37,99,235,0.1);}</style></head><body>${uploadState.newContent}</body></html>`);
                    newDoc.close();
                }
            } catch (error) {
                console.error('Error refreshing compare view:', error);
            }
        }
        
        // Refresh the new content preview panel and SEO report
        async function refreshNewContentPreview() {
            showToast('מרענן תצוגה...', 'info');
            try {
                // Save the open state of all <details> elements in SEO report before refresh
                const seoReportContent = document.getElementById('seoReportContent');
                const openDetailsIndices = [];
                if (seoReportContent) {
                    const allDetails = seoReportContent.querySelectorAll('details');
                    allDetails.forEach((detail, idx) => {
                        if (detail.open) {
                            openDetailsIndices.push(idx);
                        }
                    });
                }
                
                // Reload HTML content from file
                const pageFolder = getPageFolder(selectedPage.path);
                const response = await fetch(`/api/page/html-content?page_folder=${encodeURIComponent(pageFolder)}`);
                const result = await response.json();
                
                if (result.success && result.content) {
                    uploadState.newContent = cleanupInvalidHtml(result.content);
                    
                    // Refresh the new content iframe
                    const newContentEl = document.getElementById('compareNewContent');
                    if (newContentEl) {
                        newContentEl.innerHTML = '<iframe id="compareNewFrame"></iframe>';
                        const newFrame = document.getElementById('compareNewFrame');
                        newFrame.onload = () => {
                            setupSyncScroll();
                            if (editModeEnabled) {
                                newFrame.classList.add('edit-mode-active');
                                injectUnifiedEditHandlers(newFrame);
                            }
                        };
                        const newDoc = newFrame.contentDocument || newFrame.contentWindow.document;
                        newDoc.open();
                        newDoc.write(`<!DOCTYPE html><html dir="rtl"><head><meta charset="UTF-8"><base target="_blank"><style>body{font-family:Arial,sans-serif;padding:20px;margin:0;} a{color:#2563eb;text-decoration:underline;cursor:pointer;} a:hover{color:#1d4ed8;background:rgba(37,99,235,0.1);}</style></head><body>${uploadState.newContent}</body></html>`);
                        newDoc.close();
                    }
                    
                    // Refresh the SEO report
                    if (typeof generateSeoReport === 'function') {
                        generateSeoReport();
                    }
                    
                    // Restore the open state of <details> elements after regeneration
                    if (seoReportContent && openDetailsIndices.length > 0) {
                        // Use setTimeout to ensure DOM is updated after generateSeoReport
                        setTimeout(() => {
                            const newDetails = seoReportContent.querySelectorAll('details');
                            openDetailsIndices.forEach(idx => {
                                if (newDetails[idx]) {
                                    newDetails[idx].open = true;
                                }
                            });
                        }, 50);
                    }
                    
                    showToast('✅ התצוגה רועננה', 'success');
                }
            } catch (error) {
                console.error('Error refreshing new content preview:', error);
                showToast('שגיאה ברענון התצוגה', 'error');
            }
        }
        
        // ============ Search in Compare View ============
        function searchInCompare() {
            const searchTerm = document.getElementById('compareSearchInput').value.trim();
            if (!searchTerm) {
                clearCompareSearch();
                return;
            }
            
            let totalCount = 0;
            let oldCount = 0;
            let newCount = 0;
            
            // Search in old content iframe
            const oldFrame = document.getElementById('compareOldFrame');
            if (oldFrame) {
                oldCount = highlightInFrame(oldFrame, searchTerm);
            }
            
            // Search in new content iframe
            const newFrame = document.getElementById('compareNewFrame');
            if (newFrame) {
                newCount = highlightInFrame(newFrame, searchTerm);
            }
            
            totalCount = oldCount + newCount;
            
            // Update count display
            const countEl = document.getElementById('searchResultCount');
            if (countEl) {
                countEl.innerHTML = `<span style="color: #10b981;">ישן: ${oldCount}</span> | <span style="color: #60a5fa;">חדש: ${newCount}</span>`;
            }
            
            showToast(`נמצאו ${totalCount} תוצאות`, 'info');
        }
        
        function highlightInFrame(frame, searchTerm) {
            try {
                const doc = frame.contentDocument || frame.contentWindow.document;
                if (!doc || !doc.body) return 0;
                
                // Remove previous highlights
                removeHighlightsFromFrame(frame);
                
                // Add highlight style if not exists
                let styleEl = doc.getElementById('search-highlight-style');
                if (!styleEl) {
                    styleEl = doc.createElement('style');
                    styleEl.id = 'search-highlight-style';
                    styleEl.textContent = '.search-highlight { background-color: #fef08a !important; color: #1f2937 !important; padding: 1px 2px; border-radius: 2px; box-shadow: 0 0 0 2px #facc15; }';
                    doc.head.appendChild(styleEl);
                }
                
                // Search and highlight
                const regex = new RegExp(`(${escapeRegex(searchTerm)})`, 'gi');
                let count = 0;
                
                const walker = doc.createTreeWalker(doc.body, NodeFilter.SHOW_TEXT, null, false);
                const nodesToReplace = [];
                
                while (walker.nextNode()) {
                    const node = walker.currentNode;
                    if (node.nodeValue && regex.test(node.nodeValue)) {
                        nodesToReplace.push(node);
                    }
                }
                
                nodesToReplace.forEach(node => {
                    const matches = node.nodeValue.match(regex);
                    if (matches) count += matches.length;
                    
                    const span = doc.createElement('span');
                    span.innerHTML = node.nodeValue.replace(regex, '<mark class="search-highlight">$1</mark>');
                    node.parentNode.replaceChild(span, node);
                });
                
                // Scroll to first highlight
                const firstHighlight = doc.querySelector('.search-highlight');
                if (firstHighlight) {
                    firstHighlight.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                
                return count;
            } catch (e) {
                console.error('Error highlighting in frame:', e);
                return 0;
            }
        }
        
        function removeHighlightsFromFrame(frame) {
            try {
                const doc = frame.contentDocument || frame.contentWindow.document;
                if (!doc || !doc.body) return;
                
                const highlights = doc.querySelectorAll('.search-highlight');
                highlights.forEach(el => {
                    const parent = el.parentNode;
                    parent.replaceChild(doc.createTextNode(el.textContent), el);
                    parent.normalize();
                });
                
                // Also remove wrapper spans
                const wrapperSpans = doc.querySelectorAll('span:not([class])');
                wrapperSpans.forEach(span => {
                    if (span.childNodes.length === 1 && span.firstChild.nodeType === Node.TEXT_NODE) {
                        span.parentNode.replaceChild(span.firstChild, span);
                    }
                });
            } catch (e) {
                console.error('Error removing highlights:', e);
            }
        }
        
        function clearCompareSearch() {
            document.getElementById('compareSearchInput').value = '';
            document.getElementById('searchResultCount').textContent = '';
            
            const oldFrame = document.getElementById('compareOldFrame');
            if (oldFrame) removeHighlightsFromFrame(oldFrame);
            
            const newFrame = document.getElementById('compareNewFrame');
            if (newFrame) removeHighlightsFromFrame(newFrame);
        }
        
        function escapeRegex(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }
        
        let syncScrolling = false;
        let syncScrollEnabled = true;  // Toggle for sync scroll feature
        let diffHighlightEnabled = false;
        
        // ============ Unified Edit Mode System ============
        let editModeEnabled = false;
        let hasUnsavedChanges = false;
        let annotations = [];
        let currentAnnotationElement = null;
        let currentAnnotationOptions = {
            actionType: 'content',
            contentAction: 'rewrite',
            stylingAction: 'match'
        };
        
        function toggleEditMode() {
            editModeEnabled = !editModeEnabled;
            const btn = document.getElementById('editModeBtn');
            const saveBtn = document.getElementById('saveDirectEditBtn');
            const sidebar = document.getElementById('annotationsSidebar');
            const newFrame = document.getElementById('compareNewFrame');
            
            if (editModeEnabled) {
                btn.classList.add('active');
                btn.innerHTML = '✏️ עריכה פעילה';
                saveBtn.style.display = 'inline-flex';
                // Sidebar stays hidden until user adds an annotation (Ctrl+click)
                // sidebar.classList.remove('hidden'); -- removed: opens only when annotations exist
                
                if (newFrame) {
                    newFrame.classList.add('edit-mode-active');
                    injectUnifiedEditHandlers(newFrame);
                }
                
                showToast('מצב עריכה: לחיצה רגילה לעריכת טקסט, Ctrl+לחיצה להערה ל-AI', 'info');
            } else {
                btn.classList.remove('active');
                btn.innerHTML = '✏️ מצב עריכה';
                saveBtn.style.display = 'none';
                sidebar.classList.add('hidden');
                
                if (newFrame) {
                    newFrame.classList.remove('edit-mode-active');
                    removeUnifiedEditHandlers(newFrame);
                }
                closeAnnotationPopup();
                
                if (hasUnsavedChanges) {
                    if (confirm('יש שינויים שלא נשמרו. האם לשמור?')) {
                        saveDirectEdit();
                    }
                }
                hasUnsavedChanges = false;
            }
        }
        
        function injectUnifiedEditHandlers(frame) {
            const doc = frame.contentDocument || frame.contentWindow.document;
            if (!doc) return;
            
            // Make body editable for direct typing
            doc.body.contentEditable = 'true';
            doc.body.style.outline = 'none';
            
            // Add unified editing styles
            const style = doc.createElement('style');
            style.id = 'editModeStyle';
            style.textContent = `
                [contenteditable="true"]:focus {
                    outline: none;
                }
                .edit-hoverable {
                    transition: all 0.15s ease;
                }
                .edit-hoverable:hover {
                    outline: 2px dashed #ff6b35 !important;
                    cursor: pointer !important;
                }
                .edit-selected {
                    outline: 3px solid #ff6b35 !important;
                    background: rgba(255, 107, 53, 0.1) !important;
                }
                .editing-direct {
                    outline: 3px solid #10b981 !important;
                    background: rgba(16, 185, 129, 0.1) !important;
                }
            `;
            doc.head.appendChild(style);
            
            // Track direct edit changes
            doc.body.addEventListener('input', () => {
                hasUnsavedChanges = true;
                const saveBtn = document.getElementById('saveDirectEditBtn');
                if (saveBtn) saveBtn.classList.add('pulse-green');
            });
            
            // Add click handlers for annotations (single click)
            const selectableElements = doc.body.querySelectorAll('p, h1, h2, h3, h4, h5, h6, li, td, th, blockquote, div, span, a, strong, em, ul, ol, section, article');
            
            selectableElements.forEach(el => {
                el.classList.add('edit-hoverable');
                
                // Ctrl+Click - show annotation popup for AI
                el._editModeClickHandler = function(e) {
                    // Only show popup if Ctrl is held
                    if (!e.ctrlKey) return;
                    
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Remove previous selection
                    doc.querySelectorAll('.edit-selected').forEach(s => s.classList.remove('edit-selected'));
                    
                    // Select this element
                    el.classList.add('edit-selected');
                    currentAnnotationElement = el;
                    
                    // Show popup
                    showAnnotationPopup(el, e);
                };
                
                el.addEventListener('click', el._editModeClickHandler);
            });
        }
        
        function removeUnifiedEditHandlers(frame) {
            const doc = frame.contentDocument || frame.contentWindow.document;
            if (!doc) return;
            
            doc.body.contentEditable = 'false';
            
            // Remove style
            const style = doc.getElementById('editModeStyle');
            if (style) style.remove();
            
            // Remove handlers and classes
            doc.querySelectorAll('.edit-hoverable').forEach(el => {
                el.classList.remove('edit-hoverable', 'edit-selected', 'editing-direct');
                if (el._editModeClickHandler) {
                    el.removeEventListener('click', el._editModeClickHandler);
                    delete el._editModeClickHandler;
                }
            });
        }
        
        async function saveDirectEdit() {
            if (!selectedPage) {
                showToast('לא נבחר עמוד', 'error');
                return;
            }
            
            const newFrame = document.getElementById('compareNewFrame');
            if (!newFrame) {
                showToast('אין תוכן לשמירה', 'error');
                return;
            }
            
            const doc = newFrame.contentDocument || newFrame.contentWindow.document;
            if (!doc) return;
            
            // Get the edited HTML content (just the body content)
            const editedContent = doc.body.innerHTML;
            
            showToast('שומר שינויים...', 'info');
            
            try {
                const result = await apiCall('/api/file/save', {
                    method: 'POST',
                    body: JSON.stringify({
                        path: selectedPage.path,
                        content: editedContent
                    })
                });
                
                if (result.success) {
                    hasUnsavedChanges = false;
                    document.getElementById('saveDirectEditBtn').classList.remove('pulse-green');
                    uploadState.newContent = editedContent;
                    showToast('✅ השינויים נשמרו!', 'success');
                } else {
                    showToast('שגיאה בשמירה: ' + (result.error || 'לא ידוע'), 'error');
                }
            } catch (err) {
                console.error('Save error:', err);
                showToast('שגיאה בשמירה', 'error');
            }
        }
        
        function removeEditModeHandlers(frame) {
            const doc = frame.contentDocument || frame.contentWindow.document;
            if (!doc) return;
            
            // Remove style
            const style = doc.getElementById('editModeStyle');
            if (style) style.remove();
            
            // Remove handlers and classes
            doc.querySelectorAll('.edit-hoverable').forEach(el => {
                el.classList.remove('edit-hoverable', 'edit-selected');
                if (el._editModeClickHandler) {
                    el.removeEventListener('click', el._editModeClickHandler);
                    delete el._editModeClickHandler;
                }
            });
        }
        
        function showAnnotationPopup(element, event) {
            const popup = document.getElementById('annotationPopup');
            const tagEl = document.getElementById('annotationElementTag');
            
            // Show element info
            const tagName = element.tagName.toLowerCase();
            const preview = element.outerHTML.substring(0, 150) + (element.outerHTML.length > 150 ? '...' : '');
            tagEl.innerHTML = `<strong>&lt;${tagName}&gt;</strong> - ${element.innerText.substring(0, 50)}...`;
            
            // Position popup
            const rect = document.getElementById('compareModal').getBoundingClientRect();
            let left = event.clientX;
            let top = event.clientY;
            
            // Make sure popup stays in view
            if (left + 400 > window.innerWidth) left = window.innerWidth - 420;
            if (top + 400 > window.innerHeight) top = window.innerHeight - 420;
            
            popup.style.left = left + 'px';
            popup.style.top = top + 'px';
            popup.classList.add('visible');
            
            // Reset options
            resetAnnotationOptions();
            
            // Show direct actions section if element is a link or contains links or has bold
            const isLink = tagName === 'a';
            const hasLinks = element.querySelectorAll('a').length > 0;
            const isBold = tagName === 'strong' || tagName === 'b';
            const hasBolds = element.querySelectorAll('strong, b').length > 0;
            const directActionsSection = document.getElementById('directActionsSection');
            const directRemoveLinkBtn = document.getElementById('directRemoveLinkBtn');
            const directRemoveBoldBtn = document.getElementById('directRemoveBoldBtn');
            const directRemoveElementBtn = document.getElementById('directRemoveElementBtn');
            
            // Reset visibility
            directRemoveLinkBtn.style.display = 'none';
            directRemoveBoldBtn.style.display = 'none';
            directRemoveElementBtn.style.display = 'none';
            
            // Always show direct actions section (at least for remove element)
            directActionsSection.style.display = 'block';
            
            // Always show remove element button
            directRemoveElementBtn.style.display = 'inline-block';
            
            if (isLink || hasLinks) {
                directRemoveLinkBtn.style.display = 'inline-block';
            }
            if (isBold || hasBolds) {
                directRemoveBoldBtn.style.display = 'inline-block';
            }
        }
        
        function closeAnnotationPopup() {
            const popup = document.getElementById('annotationPopup');
            popup.classList.remove('visible');
            
            // Clear selection in iframe
            const newFrame = document.getElementById('compareNewFrame');
            if (newFrame) {
                const doc = newFrame.contentDocument || newFrame.contentWindow.document;
                if (doc) {
                    doc.querySelectorAll('.edit-selected').forEach(s => s.classList.remove('edit-selected'));
                }
            }
            
            currentAnnotationElement = null;
            document.getElementById('annotationNote').value = '';
        }
        
        // Save direct edits (like remove link, remove bold) to file
        async function saveDirectEdits() {
            if (!selectedPage || !selectedPage.path) {
                console.error('No page selected for saving');
                return;
            }
            
            try {
                const pageFolder = getPageFolder(selectedPage.path);
                const htmlFileName = selectedPage.path.split('/').pop();
                const filePath = `${pageFolder}/${htmlFileName}`;
                
                // Get the current content from uploadState
                const content = uploadState.newContent;
                if (!content) {
                    console.error('No content to save');
                    return;
                }
                
                const response = await fetch('/api/file/save-content', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        path: filePath,
                        content: content
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    console.log('✅ Direct edits saved to file');
                    // Refresh to show updated content
                    await refreshNewContentPreview();
                } else {
                    console.error('Error saving direct edits:', result.error);
                    showToast('שגיאה בשמירת השינויים: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error saving direct edits:', error);
                showToast('שגיאה בשמירת השינויים', 'error');
            }
        }
        
        async function directRemoveLink() {
            if (!currentAnnotationElement) {
                showToast('לא נבחר אלמנט', 'error');
                return;
            }
            
            const newFrame = document.getElementById('compareNewFrame');
            if (!newFrame) return;
            
            const doc = newFrame.contentDocument || newFrame.contentWindow.document;
            
            // Find the element in the iframe
            let targetEl = currentAnnotationElement;
            
            // Helper function to create clean span without link styling
            function createCleanSpan(text) {
                const span = doc.createElement('span');
                span.textContent = text;
                span.style.textDecoration = 'none';
                span.style.color = 'inherit';
                span.style.cursor = 'auto';
                return span;
            }
            
            // If element is a link, unwrap it
            if (targetEl.tagName.toLowerCase() === 'a') {
                const text = targetEl.textContent;
                const cleanSpan = createCleanSpan(text);
                targetEl.parentNode.replaceChild(cleanSpan, targetEl);
                showToast('✅ קישור הוסר!', 'success');
            } else {
                // Find all links inside the element and unwrap them
                const links = Array.from(targetEl.querySelectorAll('a'));
                let removedCount = 0;
                
                links.forEach(link => {
                    const text = link.textContent;
                    const cleanSpan = createCleanSpan(text);
                    link.parentNode.replaceChild(cleanSpan, link);
                    removedCount++;
                });
                
                if (removedCount > 0) {
                    showToast(`✅ ${removedCount} קישורים הוסרו!`, 'success');
                } else {
                    showToast('לא נמצאו קישורים להסרה', 'warning');
                }
            }
            
            // Update the uploadState with new content
            uploadState.newContent = doc.body.innerHTML;
            
            closeAnnotationPopup();
            
            // Auto-save to file
            await saveDirectEdits();
        }
        
        async function directRemoveBold() {
            if (!currentAnnotationElement) {
                showToast('לא נבחר אלמנט', 'error');
                return;
            }
            
            // Get the text content to remove bold from
            let targetEl = currentAnnotationElement;
            const tagName = targetEl.tagName.toLowerCase();
            
            // Collect all bold texts to remove
            let boldsToRemove = [];
            
            if (tagName === 'strong' || tagName === 'b') {
                // The element itself is bold
                boldsToRemove.push(targetEl.textContent.trim());
            } else {
                // Find all bold elements inside
                const bolds = Array.from(targetEl.querySelectorAll('strong, b'));
                bolds.forEach(bold => {
                    boldsToRemove.push(bold.textContent.trim());
                });
            }
            
            if (boldsToRemove.length === 0) {
                showToast('לא נמצאו הדגשות להסרה', 'warning');
                closeAnnotationPopup();
                return;
            }
            
            closeAnnotationPopup();
            
            // Use the same API as removeBoldFormatting for each bold
            try {
                const pageFolder = getPageFolder(selectedPage.path);
                let successCount = 0;
                
                for (const boldText of boldsToRemove) {
                    showToast(`מסיר הדגשה: "${boldText.substring(0, 30)}..."`, 'info');
                    
                    const response = await fetch('/api/page/remove-bold', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            page_folder: pageFolder,
                            bold_text: boldText,
                            occurrence_index: 0  // Remove first occurrence
                        })
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        successCount++;
                    } else {
                        console.error('Error removing bold:', result.error);
                    }
                }
                
                if (successCount > 0) {
                    showToast(`✅ ${successCount} הדגשות הוסרו בהצלחה!`, 'success');
                    await refreshNewContentPreview();
                } else {
                    showToast('לא הצלחנו להסיר הדגשות', 'error');
                }
            } catch (error) {
                console.error('Error removing bold:', error);
                showToast('שגיאה בהסרת הדגשות: ' + error.message, 'error');
            }
        }
        
        async function directRemoveElement() {
            if (!currentAnnotationElement) {
                showToast('לא נבחר אלמנט', 'error');
                return;
            }
            
            const elementTag = currentAnnotationElement.tagName.toLowerCase();
            const elementText = currentAnnotationElement.textContent.substring(0, 50);
            
            // Confirm deletion
            if (!confirm(`האם למחוק את האלמנט <${elementTag}>?\n\n"${elementText}..."`)) {
                return;
            }
            
            const newFrame = document.getElementById('compareNewFrame');
            if (!newFrame) return;
            
            const doc = newFrame.contentDocument || newFrame.contentWindow.document;
            
            // Remove the element from the DOM
            currentAnnotationElement.remove();
            
            // Update the uploadState with new content
            uploadState.newContent = doc.body.innerHTML;
            
            showToast('✅ אלמנט הוסר!', 'success');
            closeAnnotationPopup();
            
            // Save the changes
            await saveDirectEdits();
        }
        
        function resetAnnotationOptions() {
            currentAnnotationOptions = {
                contentAction: 'rewrite',
                stylingAction: 'none'
            };
            
            // Reset UI
            document.querySelectorAll('#contentOptions .annotation-option').forEach(o => {
                o.classList.toggle('selected', o.dataset.value === 'rewrite');
            });
            document.querySelectorAll('#stylingOptions .annotation-option').forEach(o => {
                o.classList.toggle('selected', o.dataset.value === 'none');
            });
        }
        
        function selectAnnotationOption(el, optionType) {
            // Update selection UI
            el.parentElement.querySelectorAll('.annotation-option').forEach(o => o.classList.remove('selected'));
            el.classList.add('selected');
            
            // Update state
            const value = el.dataset.value;
            
            if (optionType === 'contentAction') {
                currentAnnotationOptions.contentAction = value;
            } else if (optionType === 'stylingAction') {
                currentAnnotationOptions.stylingAction = value;
            }
        }
        
        function restoreFromBackup() {
            if (!currentAnnotationElement) {
                showToast('לא נבחר אלמנט', 'error');
                return;
            }
            
            const oldFrame = document.getElementById('compareOldFrame');
            const newFrame = document.getElementById('compareNewFrame');
            
            if (!oldFrame) {
                showToast('אין גיבוי זמין', 'error');
                return;
            }
            
            const oldDoc = oldFrame.contentDocument || oldFrame.contentWindow.document;
            const newDoc = newFrame.contentDocument || newFrame.contentWindow.document;
            
            if (!oldDoc || !newDoc) {
                showToast('שגיאה בגישה לתוכן', 'error');
                return;
            }
            
            // Try to find matching element in old content
            const matchingElement = findMatchingElement(currentAnnotationElement, oldDoc, newDoc);
            
            if (matchingElement) {
                // Store original for undo
                const originalHtml = currentAnnotationElement.outerHTML;
                
                // Restore content from backup
                currentAnnotationElement.innerHTML = matchingElement.innerHTML;
                
                // Highlight restored element
                currentAnnotationElement.style.outline = '3px solid #10b981';
                currentAnnotationElement.style.background = 'rgba(16, 185, 129, 0.1)';
                
                setTimeout(() => {
                    currentAnnotationElement.style.outline = '';
                    currentAnnotationElement.style.background = '';
                }, 2000);
                
                showToast('✅ התוכן שוחזר מהגיבוי!', 'success');
                closeAnnotationPopup();
            } else {
                showToast('❌ לא נמצא אלמנט מקביל בגיבוי', 'error');
            }
        }
        
        function findMatchingElement(newElement, oldDoc, newDoc) {
            const tagName = newElement.tagName.toLowerCase();
            
            // Strategy 1: Try to match by ID
            if (newElement.id) {
                const byId = oldDoc.getElementById(newElement.id);
                if (byId) return byId;
            }
            
            // Strategy 2: Try to match by class + position
            if (newElement.className) {
                const classes = newElement.className.split(' ').filter(c => c.trim());
                if (classes.length > 0) {
                    const mainClass = classes[0];
                    const oldElements = oldDoc.querySelectorAll(`.${mainClass}`);
                    const newElements = newDoc.querySelectorAll(`.${mainClass}`);
                    
                    // Find index of current element
                    let index = -1;
                    newElements.forEach((el, i) => {
                        if (el === newElement) index = i;
                    });
                    
                    if (index >= 0 && oldElements[index]) {
                        return oldElements[index];
                    }
                }
            }
            
            // Strategy 3: Match by tag type and position
            const allNewOfType = newDoc.querySelectorAll(tagName);
            const allOldOfType = oldDoc.querySelectorAll(tagName);
            
            let index = -1;
            allNewOfType.forEach((el, i) => {
                if (el === newElement) index = i;
            });
            
            if (index >= 0 && allOldOfType[index]) {
                return allOldOfType[index];
            }
            
            // Strategy 4: Try to match by similar text content
            const newText = newElement.innerText.substring(0, 50);
            for (const oldEl of oldDoc.querySelectorAll(tagName)) {
                const oldText = oldEl.innerText.substring(0, 50);
                // Check if texts are similar (at least 50% match)
                if (oldText && newText) {
                    const similarity = calculateSimilarity(newText, oldText);
                    if (similarity > 0.5) {
                        return oldEl;
                    }
                }
            }
            
            return null;
        }
        
        function calculateSimilarity(str1, str2) {
            const longer = str1.length > str2.length ? str1 : str2;
            const shorter = str1.length > str2.length ? str2 : str1;
            
            if (longer.length === 0) return 1.0;
            
            let matches = 0;
            const shorterLen = shorter.length;
            
            for (let i = 0; i < shorterLen; i++) {
                if (shorter[i] === longer[i]) matches++;
            }
            
            return matches / longer.length;
        }
        
        function addAnnotation() {
            if (!currentAnnotationElement) {
                showToast('לא נבחר אלמנט', 'error');
                return;
            }
            
            const contentAction = currentAnnotationOptions.contentAction;
            const stylingAction = currentAnnotationOptions.stylingAction;
            
            // Must select at least one action
            if (contentAction === 'none' && stylingAction === 'none') {
                showToast('יש לבחור לפחות פעולה אחת (תוכן או עיצוב)', 'error');
                return;
            }
            
            const note = document.getElementById('annotationNote').value.trim();
            
            // Create annotation object
            const annotation = {
                id: Date.now(),
                elementTag: currentAnnotationElement.tagName.toLowerCase(),
                elementHtml: currentAnnotationElement.outerHTML.substring(0, 500),
                elementText: currentAnnotationElement.innerText.substring(0, 200),
                contentAction: contentAction !== 'none' ? contentAction : null,
                stylingAction: stylingAction !== 'none' ? stylingAction : null,
                note: note
            };
            
            annotations.push(annotation);
            renderAnnotationsList();
            closeAnnotationPopup();
            showToast('הערה נוספה', 'success');
        }
        
        function removeAnnotation(id) {
            annotations = annotations.filter(a => a.id !== id);
            renderAnnotationsList();
        }
        
        function renderAnnotationsList() {
            const listEl = document.getElementById('annotationsList');
            const countEl = document.getElementById('annotationsCount');
            const generateBtn = document.getElementById('generatePromptBtn');
            const sidebar = document.getElementById('annotationsSidebar');
            
            countEl.textContent = annotations.length;
            generateBtn.disabled = annotations.length === 0;
            
            // Show sidebar only when there are annotations
            if (annotations.length > 0 && editModeEnabled) {
                sidebar.classList.remove('hidden');
            } else if (annotations.length === 0) {
                sidebar.classList.add('hidden');
            }
            
            if (annotations.length === 0) {
                listEl.innerHTML = `
                    <div class="empty-state" style="padding: 2rem; text-align: center; color: var(--text-muted);">
                        לחץ על אלמנט בתוכן החדש כדי להוסיף הערה
                    </div>
                `;
                return;
            }
            
            const actionLabels = {
                rewrite: '🔄 שכתב',
                human: '🧑 יותר אנושי',
                marketing: '📢 שיווקי',
                seo: '🔍 SEO',
                shorter: '✂️ קצר',
                longer: '📄 ארוך',
                removeLink: '🔗 הסר קישור',
                removeElement: '🗑️ הסר אלמנט',
                custom: '💬 מותאם',
                match: '🎯 התאם',
                restyle: '✨ עצב מחדש'
            };
            
            listEl.innerHTML = annotations.map(ann => `
                <div class="annotation-item">
                    <button class="annotation-remove" onclick="removeAnnotation(${ann.id})">×</button>
                    <div class="annotation-element-preview">&lt;${ann.elementTag}&gt; ${ann.elementText.substring(0, 60)}...</div>
                    <div>
                        ${ann.contentAction ? `<span class="annotation-action">${actionLabels[ann.contentAction] || ann.contentAction}</span>` : ''}
                        ${ann.stylingAction ? `<span class="annotation-action styling">${actionLabels[ann.stylingAction] || ann.stylingAction}</span>` : ''}
                    </div>
                    ${ann.note ? `<div class="annotation-note">💬 ${ann.note}</div>` : ''}
                </div>
            `).join('');
        }
        
        // ============ Meta Edit System ============
        let metaEditTarget = null;
        let metaEditAction = 'rewrite';
        
        async function showMetaEditPopup(target) {
            // Run the agent directly instead of showing popup
            await runMetaAgent(target);
        }
        
        async function runMetaAgent(target) {
            if (!selectedPage) {
                showToast('בחר עמוד קודם', 'error');
                return;
            }

            const pagePath = selectedPage.path || '';
            // Handle both / and \ separators
            let pageDir = pagePath.substring(0, Math.max(pagePath.lastIndexOf('/'), pagePath.lastIndexOf('\\')));
            const pageInfoPath = pageDir + '/page_info.json';
            
            // Get current values
            const currentTitle = document.getElementById('uploadTitle').value || '';
            const currentDesc = document.getElementById('uploadDescription').value || '';
            
            // Try to read keyword from page_info.json first
            let keyword = uploadState.keyword || '';
            if (!keyword) {
                try {
                    const pageInfoResult = await apiCall(`/api/file/content?path=${encodeURIComponent(pageInfoPath)}`);
                    if (pageInfoResult.content) {
                        const pageInfo = JSON.parse(pageInfoResult.content);
                        keyword = pageInfo.keyword || selectedPage.name || '';
                    }
                } catch (e) {
                    keyword = selectedPage.name || '';
                }
            }
            
            const isTitle = target === 'title';
            const fieldName = isTitle ? 'Title' : 'Description';
            const currentValue = isTitle ? currentTitle : currentDesc;
            const maxLength = isTitle ? 60 : 160;
            
            showToast(`🚀 מייצר ${fieldName} חדש...`, 'info');

            const promptContent = `# משימה: יצירת ${fieldName} מנצח

## הוראות
@פרומטים/כללי/טייטלים ודסקריפשנים.md

## פרטי העמוד
- **שם העמוד:** ${selectedPage.name}
- **מילת מפתח ראשית:** ${keyword}
- **${fieldName} נוכחי:** ${currentValue || 'אין'}

## קובץ לעדכון
**חובה לעדכן את:** ${pageInfoPath}

## משימה ספציפית
צור **3 אפשרויות ל-${fieldName} בלבד** (לא ${isTitle ? 'Description' : 'Title'}!).

⚠️ **כללים קריטיים - כל אפשרות חייבת:**
1. 🚨 **להכיל את מילת המפתח "${keyword}"** - חובה! בלי זה זה לא תקין!
2. להיות עד ${maxLength} תווים
3. לשלב עקרונות SEO + שיווק אטומי
4. לא להבטיח הבטחות שלא ניתן לקיים (כמו "כסף תוך 24 שעות")

עדכן את ${pageInfoPath} עם:
- \`${isTitle ? 'title' : 'description'}\` - האפשרות המומלצת
- \`${isTitle ? 'title_options' : 'description_options'}\` - מערך של 3 אפשרויות עם הסברים

🏁 סיום!`;

            try {
                const result = await apiCall('/api/prompt/run-agent', {
                    method: 'POST',
                    body: JSON.stringify({
                        page_path: pagePath,
                        prompt: promptContent,
                        agent_type: isTitle ? 'title_agent' : 'description_agent',
                        page_info_path: pageInfoPath
                    })
                });

                if (result.success) {
                    showToast(`✅ סוכן ${fieldName} הופעל!`, 'success');
                    
                    // Open work status panel
                    const workStatusPanel = document.getElementById('workStatusPanel');
                    if (workStatusPanel) {
                        workStatusPanel.style.display = 'block';
                        workStatusPanel.classList.add('active');
                    }
                    
                    // Poll for results
                    pollForMetaOptions(pageInfoPath, target);
                } else {
                    showToast(result.error || 'שגיאה בהפעלת הסוכן', 'error');
                }
            } catch (error) {
                console.error('Meta agent error:', error);
                showToast(`שגיאה בהפעלת סוכן ${fieldName}`, 'error');
            }
        }
        
        async function pollForMetaOptions(pageInfoPath, target) {
            let attempts = 0;
            const maxAttempts = 60;
            const fieldName = target === 'title' ? 'title_options' : 'description_options';
            
            // Store initial options count to detect NEW options
            let initialOptionsCount = 0;
            try {
                const initial = await apiCall(`/api/file/content?path=${encodeURIComponent(pageInfoPath)}`);
                if (initial.content) {
                    const initialData = JSON.parse(initial.content);
                    initialOptionsCount = (initialData[fieldName] || []).length;
                }
            } catch (e) {}
            
            // First, mark that we're waiting for new options by adding a timestamp
            const startTime = Date.now();
            
            const checkOptions = async () => {
                attempts++;
                
                try {
                    const current = await apiCall(`/api/file/content?path=${encodeURIComponent(pageInfoPath)}`);
                    
                    if (current.content) {
                        try {
                            const data = JSON.parse(current.content);
                            const currentOptions = data[fieldName] || [];
                            
                            // Check if NEW options were added (more than before, or has generated_at timestamp after start)
                            const generatedAt = data[`${fieldName}_generated_at`];
                            const isNewGeneration = generatedAt && new Date(generatedAt).getTime() > startTime;
                            const hasMoreOptions = currentOptions.length > initialOptionsCount;
                            
                            if (currentOptions.length > 0 && (isNewGeneration || hasMoreOptions || attempts > 3)) {
                                // Wait at least 3 attempts (15 seconds) to avoid showing old options
                                if (attempts >= 3) {
                                    showToast(`✅ ${target === 'title' ? 'טייטלים' : 'דסקריפשנים'} מוכנים!`, 'success');
                                    showMetaOptions(data, target);
                                    return;
                                }
                            }
                        } catch (e) {}
                    }
                    
                    if (attempts < maxAttempts) {
                        setTimeout(checkOptions, 5000);
                    } else {
                        showToast('הזמן הקצוב עבר. בדוק את הטרמינל.', 'warning');
                    }
                } catch (error) {
                    console.error('Poll error:', error);
                }
            };
            
            setTimeout(checkOptions, 5000);
        }
        
        function showMetaOptions(data, target) {
            // Store for click handling
            currentMetaOptions = data;
            
            const isTitle = target === 'title';
            const options = isTitle ? data.title_options : data.description_options;
            const selected = isTitle ? data.title : data.description;
            const maxLength = isTitle ? 60 : 160;
            const fieldLabel = isTitle ? 'Title' : 'Description';
            
            if (!options || options.length === 0) {
                showToast(`לא נמצאו אפשרויות ל-${fieldLabel}`, 'error');
                return;
            }
            
            // Create modal
            let modal = document.getElementById('metaOptionsModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'metaOptionsModal';
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal" style="max-width: 600px;">
                        <div class="modal-header">
                            <h2 id="metaOptionsTitle">🏆 בחר אפשרות</h2>
                            <button class="modal-close" onclick="closeModal('metaOptionsModal')">&times;</button>
                        </div>
                        <div class="modal-body" id="metaOptionsContent" style="max-height: 60vh; overflow-y: auto;">
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            document.getElementById('metaOptionsTitle').textContent = 
                isTitle ? '🏆 בחר Title' : '🏆 בחר Description';
            
            let html = '<div style="direction: rtl; text-align: right;">';
            html += '<p style="color: #94a3b8; margin-bottom: 15px;">👆 לחץ על אפשרות כדי לבחור אותה</p>';
            
            // Selected/recommended option
            if (selected) {
                html += `<div style="background: #1a3a1a; padding: 12px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #2a5a2a; cursor: pointer;"
                         onmouseover="this.style.borderColor='#4ade80';"
                         onmouseout="this.style.borderColor='#2a5a2a';"
                         onclick="selectMetaFromOptions('${target}', 'recommended')">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: #4ade80;">✅ מומלץ</span>
                        <span style="background: #22c55e; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8em;">בחר</span>
                    </div>
                    <p style="margin: 8px 0 0 0; color: #e2e8f0; font-size: 1.05em;">"${escapeHtmlChars(selected)}"</p>
                    <small style="color: #888;">${selected.length}/${maxLength} תווים</small>
                </div>`;
            }
            
            // All options
            html += '<h4 style="color: #60a5fa; margin: 10px 0;">כל האפשרויות:</h4>';
            html += '<div style="display: flex; flex-direction: column; gap: 10px;">';
            
            options.forEach((opt, i) => {
                const text = typeof opt === 'string' ? opt : opt.text;
                const reason = typeof opt === 'object' ? opt.reason : '';
                const charCount = text ? text.length : 0;
                const isGoodLength = charCount <= maxLength;
                
                html += `
                    <div class="meta-option-card" style="background: #1a1a2e; padding: 12px; border-radius: 8px; border: 2px solid #333; cursor: pointer; transition: all 0.2s;" 
                         onmouseover="this.style.borderColor='#60a5fa'; this.style.background='#252540';"
                         onmouseout="this.style.borderColor='#333'; this.style.background='#1a1a2e';"
                         onclick="selectMetaFromOptions('${target}', ${i})">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: bold; color: #fff;">אפשרות ${i + 1}</span>
                            <div>
                                <span style="color: ${isGoodLength ? '#4ade80' : '#f87171'}; margin-left: 10px;">${charCount}/${maxLength}</span>
                                <span style="background: #3b82f6; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8em;">בחר</span>
                            </div>
                        </div>
                        <p style="margin: 8px 0; color: #e2e8f0; font-size: 1.05em;">"${escapeHtmlChars(text)}"</p>
                        ${reason ? `<p style="margin: 0; color: #94a3b8; font-size: 0.85em;">💡 ${reason}</p>` : ''}
                    </div>
                `;
            });
            
            html += '</div></div>';
            
            document.getElementById('metaOptionsContent').innerHTML = html;
            openModal('metaOptionsModal');
        }
        
        function applyMetaOption(target, text) {
            if (target === 'title') {
                document.getElementById('uploadTitle').value = text;
                updateTitleCharCountWithSuffix();
            } else {
                document.getElementById('uploadDescription').value = text;
                document.getElementById('uploadDescCount').textContent = `${text.length}/160 תווים`;
            }
            closeModal('metaOptionsModal');
            showToast(`✅ ${target === 'title' ? 'Title' : 'Description'} נבחר!`, 'success');
        }
        
        async function loadExistingMetaOptions() {
            if (!selectedPage) {
                showToast('בחר עמוד קודם', 'error');
                return;
            }
            
            const pagePath = selectedPage.path || '';
            // Handle both / and \ separators
            let pageDir = pagePath.substring(0, Math.max(pagePath.lastIndexOf('/'), pagePath.lastIndexOf('\\')));
            const pageInfoPath = pageDir + '/page_info.json';
            
            console.log('Looking for page_info.json at:', pageInfoPath);
            
            try {
                const result = await apiCall(`/api/file/content?path=${encodeURIComponent(pageInfoPath)}`);
                
                if (result.content) {
                    const data = JSON.parse(result.content);
                    
                    const hasTitleOptions = data.title_options && data.title_options.length > 0;
                    const hasDescOptions = data.description_options && data.description_options.length > 0;
                    
                    if (!hasTitleOptions && !hasDescOptions) {
                        showToast('אין אפשרויות שמורות. הפעל את הסוכן קודם.', 'info');
                        return;
                    }
                    
                    // Show combined modal with both
                    showCombinedMetaOptions(data);
                } else {
                    showToast('לא נמצא קובץ page_info.json', 'error');
                }
            } catch (error) {
                console.error('Load options error:', error);
                showToast('שגיאה בטעינת אפשרויות', 'error');
            }
        }
        
        // Store options globally for click handling
        let currentMetaOptions = null;
        
        function showCombinedMetaOptions(data) {
            currentMetaOptions = data;
            
            let modal = document.getElementById('combinedMetaModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'combinedMetaModal';
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal modal-large">
                        <div class="modal-header">
                            <h2>🏆 אפשרויות Title & Description</h2>
                            <button class="modal-close" onclick="closeModal('combinedMetaModal')">&times;</button>
                        </div>
                        <div class="modal-body" id="combinedMetaContent" style="max-height: 70vh; overflow-y: auto;">
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            let html = '<div style="direction: rtl; text-align: right;">';
            html += '<p style="color: #94a3b8; margin-bottom: 15px;">👆 לחץ על אפשרות כדי לבחור אותה</p>';
            
            // Title section
            if (data.title_options && data.title_options.length > 0) {
                html += '<h3 style="color: #60a5fa; margin: 0 0 15px 0;">📝 אפשרויות Title:</h3>';
                
                if (data.title) {
                    html += `<div style="background: #1a3a1a; padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #2a5a2a; cursor: pointer;" onclick="selectMetaFromOptions('title', 'recommended')">
                        <span style="color: #4ade80;">✅ מומלץ (לחץ לבחירה):</span> "${escapeHtmlChars(data.title)}" <small style="color: #888;">(${data.title.length}/60)</small>
                    </div>`;
                }
                
                html += '<div style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 25px;">';
                data.title_options.forEach((opt, i) => {
                    const text = typeof opt === 'string' ? opt : opt.text;
                    const reason = typeof opt === 'object' ? opt.reason : '';
                    html += `
                        <div class="meta-option-card" style="background: #1a1a2e; padding: 12px; border-radius: 8px; border: 2px solid #333; cursor: pointer; transition: all 0.2s;"
                             onmouseover="this.style.borderColor='#60a5fa'; this.style.background='#252540';"
                             onmouseout="this.style.borderColor='#333'; this.style.background='#1a1a2e';"
                             onclick="selectMetaFromOptions('title', ${i})">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <strong style="color: #fff;">אפשרות ${i + 1}</strong>
                                <div>
                                    <span style="color: ${text.length <= 60 ? '#4ade80' : '#f87171'}; margin-left: 10px;">${text.length}/60</span>
                                    <span style="background: #3b82f6; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8em;">בחר</span>
                                </div>
                            </div>
                            <p style="margin: 8px 0; color: #e2e8f0; font-size: 1.05em;">"${escapeHtmlChars(text)}"</p>
                            ${reason ? `<small style="color: #94a3b8;">💡 ${reason}</small>` : ''}
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            // Description section
            if (data.description_options && data.description_options.length > 0) {
                html += '<h3 style="color: #60a5fa; margin: 0 0 15px 0;">📝 אפשרויות Description:</h3>';
                
                if (data.description) {
                    html += `<div style="background: #1a3a1a; padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #2a5a2a; cursor: pointer;" onclick="selectMetaFromOptions('description', 'recommended')">
                        <span style="color: #4ade80;">✅ מומלץ (לחץ לבחירה):</span> "${escapeHtmlChars(data.description)}" <small style="color: #888;">(${data.description.length}/160)</small>
                    </div>`;
                }
                
                html += '<div style="display: flex; flex-direction: column; gap: 8px;">';
                data.description_options.forEach((opt, i) => {
                    const text = typeof opt === 'string' ? opt : opt.text;
                    const reason = typeof opt === 'object' ? opt.reason : '';
                    html += `
                        <div class="meta-option-card" style="background: #1a1a2e; padding: 12px; border-radius: 8px; border: 2px solid #333; cursor: pointer; transition: all 0.2s;"
                             onmouseover="this.style.borderColor='#60a5fa'; this.style.background='#252540';"
                             onmouseout="this.style.borderColor='#333'; this.style.background='#1a1a2e';"
                             onclick="selectMetaFromOptions('description', ${i})">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <strong style="color: #fff;">אפשרות ${i + 1}</strong>
                                <div>
                                    <span style="color: ${text.length <= 160 ? '#4ade80' : '#f87171'}; margin-left: 10px;">${text.length}/160</span>
                                    <span style="background: #3b82f6; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8em;">בחר</span>
                                </div>
                            </div>
                            <p style="margin: 8px 0; color: #e2e8f0; font-size: 1.05em;">"${escapeHtmlChars(text)}"</p>
                            ${reason ? `<small style="color: #94a3b8;">💡 ${reason}</small>` : ''}
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            html += '</div>';
            
            document.getElementById('combinedMetaContent').innerHTML = html;
            openModal('combinedMetaModal');
        }
        
        function escapeHtmlChars(text) {
            if (!text) return '';
            return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }
        
        function selectMetaFromOptions(target, index) {
            if (!currentMetaOptions) return;
            
            let text = '';
            const options = target === 'title' ? currentMetaOptions.title_options : currentMetaOptions.description_options;
            
            if (index === 'recommended') {
                text = target === 'title' ? currentMetaOptions.title : currentMetaOptions.description;
            } else if (options && options[index]) {
                const opt = options[index];
                text = typeof opt === 'string' ? opt : opt.text;
            }
            
            if (!text) {
                showToast('לא נמצא טקסט', 'error');
                return;
            }
            
            if (target === 'title') {
                document.getElementById('uploadTitle').value = text;
                updateTitleCharCountWithSuffix();
                showToast('✅ Title נבחר!', 'success');
            } else {
                document.getElementById('uploadDescription').value = text;
                document.getElementById('uploadDescCount').textContent = `${text.length}/160 תווים`;
                showToast('✅ Description נבחר!', 'success');
            }
            
            closeModal('combinedMetaModal');
        }
        
        function closeMetaEditPopup() {
            document.getElementById('metaEditPopup').classList.remove('visible');
            metaEditTarget = null;
        }
        
        function selectMetaOption(el) {
            el.parentElement.querySelectorAll('.meta-edit-option').forEach(o => o.classList.remove('selected'));
            el.classList.add('selected');
            metaEditAction = el.dataset.value;
        }
        
        function addMetaAnnotation() {
            if (!metaEditTarget) return;
            
            const note = document.getElementById('metaEditNote').value.trim();
            const currentValue = metaEditTarget === 'title' 
                ? document.getElementById('uploadTitle').value 
                : document.getElementById('uploadDescription').value;
            
            // Add as annotation
            const annotation = {
                id: Date.now(),
                elementTag: metaEditTarget === 'title' ? 'meta-title' : 'meta-description',
                elementHtml: `<${metaEditTarget}>${currentValue}</${metaEditTarget}>`,
                elementText: currentValue,
                actionType: 'meta',
                action: metaEditAction,
                note: note
            };
            
            annotations.push(annotation);
            renderAnnotationsList();
            closeMetaEditPopup();
            showToast(`הערה ל${metaEditTarget === 'title' ? 'כותרת' : 'תיאור'} נוספה`, 'success');
        }
        
        // ============ Prompt Generator ============
        async function generateAnnotationsPrompt() {
            if (annotations.length === 0) {
                showToast('אין הערות ליצירת פרומפט', 'error');
                return;
            }
            
            const pageName = selectedPage?.name || 'עמוד';
            const pageFolder = selectedPage ? getPageFolder(selectedPage.path) : '';
            const htmlPath = selectedPage?.path || '';
            
            const actionLabels = {
                rewrite: 'שכתב את התוכן מחדש',
                human: 'הפוך לטקסט יותר אנושי וטבעי - הסר סממני AI, הוסף אישיות וביטויים יומיומיים',
                marketing: 'שכתב בסגנון שיווקי ומשכנע יותר',
                seo: 'שכתב עם דגש על SEO ומילות מפתח',
                shorter: 'קצר את התוכן תוך שמירה על המסר העיקרי',
                longer: 'הרחב את התוכן עם פרטים נוספים',
                removeLink: 'הסר את הקישור (<a>) מהאלמנט והשאר רק את הטקסט',
                removeElement: 'הסר את האלמנט הזה מהעמוד לחלוטין (מחק את כל הקוד שלו)',
                removeBold: 'הסר את הבולד (<strong>/<b>) מהאלמנט והשאר רק את הטקסט',
                custom: 'תקן לפי ההוראות',
                match: `התאם את העיצוב לסגנון הקיים בעמוד:
⚠️ חוקים קריטיים:
1. השתמש רק ב-CSS classes שכבר קיימים בעמוד (חפש classes עם prefix כמו wpc-*)
2. אל תמציא צבעים חדשים! השתמש רק בצבעים שכבר מופיעים בעמוד
3. הסר inline styles מיותרים והחלף ב-classes קיימים
4. בדוק אילו classes משמשים אלמנטים דומים בעמוד והשתמש באותם classes
5. אם צריך צבע - חפש את הצבע הקרוב ביותר שכבר קיים ב-CSS של העמוד`,
                restyle: `עצב מחדש את האלמנט בהתאם לאופי הכללי של העמוד:
⚠️ חוקים קריטיים:
1. נתח את סגנון העמוד הקיים - צבעים, פונטים, רווחים
2. השתמש רק ב-CSS classes קיימים או צור classes חדשים בסגנון ה-namespace של העמוד (wpc-*)
3. אל תמציא צבעים - השתמש רק בפלטת הצבעים הקיימת בעמוד
4. שמור על עקביות עם שאר האלמנטים בעמוד`
            };
            
            // Build prompt
            let prompt = `# משימה: תיקונים בקובץ ${pageName}.html

## קובץ לעריכה
@${htmlPath}

## הוראות כלליות
- השתמש בכלי Edit (לא Write!) לעריכת הקובץ
- שמור על כל ה-classes והמבנה הקיים
- אל תוסיף הערות HTML שמסגירות עריכת AI
- וודא שהתוכן נשמע טבעי ואנושי

## הוראות עיצוב (אם רלוונטי)
- **אסור להמציא צבעים חדשים!** השתמש רק בצבעים שכבר קיימים בעמוד
- השתמש ב-CSS classes הקיימים בעמוד (חפש classes עם prefix כמו wpc-*)
- אם צריך עיצוב - חפש אלמנטים דומים בעמוד והעתק את ה-classes שלהם
- הסר inline styles מיותרים והחלף ב-classes קיימים

---

## הערות לתיקון (${annotations.length})

`;
            
            annotations.forEach((ann, i) => {
                const contentDesc = ann.contentAction ? actionLabels[ann.contentAction] : null;
                const stylingDesc = ann.stylingAction ? actionLabels[ann.stylingAction] : null;
                
                prompt += `### ${i + 1}. ${ann.elementTag === 'meta-title' ? 'כותרת (Title)' : ann.elementTag === 'meta-description' ? 'תיאור (Description)' : `<${ann.elementTag}>`}

**תוכן נוכחי:**
\`\`\`html
${ann.elementHtml}
\`\`\`

${contentDesc ? `**📝 פעולת תוכן:** ${contentDesc}` : ''}
${stylingDesc ? `**🎨 פעולת עיצוב:** ${stylingDesc}` : ''}
${ann.note ? `**💬 הוראות נוספות:** ${ann.note}` : ''}

---

`;
            });
            
            prompt += `
## סיום
לאחר ביצוע כל התיקונים, שמור את הקובץ ורשום סיכום קצר של מה שבוצע.

🏁 סיום!`;

            // Save prompt to file
            try {
                const promptPath = `${pageFolder}/prompt_annotations.md`;
                
                const result = await apiCall('/api/prompt/save', {
                    method: 'POST',
                    body: JSON.stringify({
                        path: promptPath,
                        content: prompt
                    })
                });
                
                // Show preview instead of copying directly
                showPromptPreview(prompt);
            } catch (err) {
                console.error('Error generating prompt:', err);
                showToast('שגיאה ביצירת פרומפט', 'error');
            }
        }
        
        function showPromptPreview(prompt) {
            // Create preview modal if not exists
            let previewModal = document.getElementById('promptPreviewModal');
            if (!previewModal) {
                previewModal = document.createElement('div');
                previewModal.id = 'promptPreviewModal';
                previewModal.className = 'modal-overlay';
                previewModal.innerHTML = `
                    <div class="modal" style="max-width: 900px; max-height: 85vh;">
                        <div class="modal-header">
                            <h2>📝 ערוך פרומפט לפני שליחה</h2>
                            <button class="modal-close" onclick="closePromptPreview()">&times;</button>
                        </div>
                        <div class="modal-body" style="max-height: 65vh; overflow-y: auto; padding: 0.5rem;">
                            <textarea id="promptPreviewContent" 
                                style="width: 100%; height: 55vh; font-size: 0.85rem; background: var(--bg); padding: 1rem; border-radius: 8px; direction: rtl; text-align: right; border: 1px solid var(--border); color: var(--text); resize: vertical; font-family: inherit; line-height: 1.6;"
                                placeholder="ערוך את הפרומפט כאן..."></textarea>
                        </div>
                        <div class="modal-footer" style="display: flex; gap: 0.5rem; justify-content: flex-end; flex-wrap: wrap;">
                            <button class="btn btn-secondary" onclick="closePromptPreview()">סגור</button>
                            <button class="btn btn-primary" onclick="copyAndClosePrompt()">📋 העתק</button>
                            <button class="btn btn-success" onclick="sendPromptToClaude()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                                🚀 שלח לביצוע
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(previewModal);
            }
            
            // Show preview with editable textarea
            const textarea = document.getElementById('promptPreviewContent');
            textarea.value = prompt;
            previewModal.classList.add('active');
            
            // Focus and scroll to top of textarea
            setTimeout(() => {
                textarea.focus();
                textarea.scrollTop = 0;
            }, 100);
        }
        
        function closePromptPreview() {
            const modal = document.getElementById('promptPreviewModal');
            if (modal) modal.classList.remove('active');
        }
        
        function copyAndClosePrompt() {
            const textarea = document.getElementById('promptPreviewContent');
            if (textarea && textarea.value) {
                copyToClipboardFallback(textarea.value);
                showToast('✅ הפרומפט הועתק!', 'success');
            }
        }
        
        async function sendPromptToClaude() {
            const textarea = document.getElementById('promptPreviewContent');
            if (!textarea || !textarea.value.trim()) {
                showToast('אין פרומפט לשליחה', 'error');
                return;
            }
            
            // Get edited prompt from textarea
            const prompt = textarea.value.trim();
            
            if (!selectedPage) {
                showToast('לא נבחר עמוד', 'error');
                return;
            }
            
            // Close preview modal
            closePromptPreview();
            
            // Close compare modal to see the work panel
            closeModal('compareModal');
            
            // Show work status panel
            showWorkStatusPanel();
            updateWorkStatusTitle('🚀 ביצוע תיקונים מהעורך');
            setWorkStatusDot('running');
            
            // Clear previous log
            const workContent = document.getElementById('workStatusContent');
            if (workContent) {
                workContent.innerHTML = '<div class="log-line">⏳ מתחיל ביצוע תיקונים...</div>';
            }
            
            try {
                // Save prompt to file first
                const pageFolder = getPageFolder(selectedPage.path);
                const promptPath = `${pageFolder}/prompt_annotations.md`;
                
                await apiCall('/api/prompt/save', {
                    method: 'POST',
                    body: JSON.stringify({
                        path: promptPath,
                        content: prompt
                    })
                });
                
                // Run Claude with the prompt
                const result = await apiCall('/api/workflow/run-annotation', {
                    method: 'POST',
                    body: JSON.stringify({
                        page_path: selectedPage.path,
                        prompt_path: promptPath,
                        prompt_content: prompt
                    })
                });
                
                if (result.success) {
                    showToast('🚀 התחלת ביצוע!', 'success');
                    
                    // Use existing log polling mechanism
                    startStatusPolling();
                    showStopButton();
                    
                    // Clear annotations
                    annotations = [];
                    renderAnnotationsList();
                } else {
                    showToast('שגיאה: ' + (result.error || 'לא ידוע'), 'error');
                    setWorkStatusDot('error');
                }
            } catch (err) {
                console.error('Error sending to Claude:', err);
                showToast('שגיאה בשליחה לקלוד', 'error');
                setWorkStatusDot('error');
            }
        }
        
        
        function copyToClipboardFallback(text) {
            try {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.left = '-9999px';
                textarea.style.top = '0';
                document.body.appendChild(textarea);
                textarea.focus();
                textarea.select();
                
                const success = document.execCommand('copy');
                document.body.removeChild(textarea);
                
                if (success) {
                    showToast('✅ פרומפט הועתק ללוח!', 'success');
                } else {
                    // Show prompt in alert as last resort
                    showToast('לא ניתן להעתיק - הפרומפט מוצג בחלון', 'warning');
                    alert('העתק את הפרומפט הבא:\n\n' + text.substring(0, 500) + '...');
                }
            } catch (e) {
                console.error('Fallback copy failed:', e);
                showToast('שגיאה בהעתקה', 'error');
            }
        }
        
        // ============ Refresh Content ============
        async function refreshCompareContent() {
            showToast('מרענן תוכן...', 'info');
            
            // Re-read the new content from file
            if (selectedPage) {
                try {
                    const result = await apiCall(`/api/file/content?path=${encodeURIComponent(selectedPage.path)}`);
                    if (result.success && result.content) {
                        uploadState.newContent = cleanupInvalidHtml(result.content);
                        
                        // Refresh the new content iframe
                        const newContentEl = document.getElementById('compareNewContent');
                        newContentEl.innerHTML = '<iframe id="compareNewFrame"></iframe>';
                        const newFrame = document.getElementById('compareNewFrame');
                        newFrame.onload = () => {
                            setupSyncScroll();
                            if (editModeEnabled) {
                                injectEditModeHandlers(newFrame);
                            }
                        };
                        const newDoc = newFrame.contentDocument || newFrame.contentWindow.document;
                        newDoc.open();
                        newDoc.write(`<!DOCTYPE html><html dir="rtl"><head><meta charset="UTF-8"><base target="_blank"><style>body{font-family:Arial,sans-serif;padding:20px;margin:0;} a{color:#2563eb;text-decoration:underline;cursor:pointer;} a:hover{color:#1d4ed8;background:rgba(37,99,235,0.1);}</style></head><body>${uploadState.newContent}</body></html>`);
                        newDoc.close();
                        
                        showToast('תוכן רוענן!', 'success');
                    } else {
                        showToast('לא נמצא תוכן', 'error');
                    }
                } catch (err) {
                    showToast('שגיאה ברענון', 'error');
                }
            }
        }
        
        function toggleDiffHighlight() {
            diffHighlightEnabled = !diffHighlightEnabled;
            const btn = document.getElementById('highlightDiffBtn');
            
            if (diffHighlightEnabled) {
                btn.classList.add('active');
                btn.innerHTML = '🔍 הדגשה פעילה';
                applyDiffHighlight();
            } else {
                btn.classList.remove('active');
                btn.innerHTML = '🔍 הדגש שינויים';
                removeDiffHighlight();
            }
        }
        
        function applyDiffHighlight() {
            const oldFrame = document.getElementById('compareOldFrame');
            const newFrame = document.getElementById('compareNewFrame');
            
            if (!oldFrame || !newFrame) return;
            
            const oldDoc = oldFrame.contentDocument || oldFrame.contentWindow.document;
            const newDoc = newFrame.contentDocument || newFrame.contentWindow.document;
            
            if (!oldDoc || !newDoc) return;
            
            // Add highlight styles to BOTH documents
            const styleContent = `
                .diff-changed-char {
                    background: rgba(245, 158, 11, 0.5) !important;
                    border-radius: 2px;
                    padding: 0 2px;
                }
                .diff-new-char {
                    background: rgba(16, 185, 129, 0.5) !important;
                    border-radius: 2px;
                    padding: 0 2px;
                }
                .diff-removed-char {
                    background: rgba(239, 68, 68, 0.5) !important;
                    border-radius: 2px;
                    padding: 0 2px;
                    text-decoration: line-through;
                }
                .diff-element-changed {
                    outline: 2px dashed #f59e0b !important;
                    outline-offset: 2px;
                }
                .diff-element-new {
                    outline: 2px solid #10b981 !important;
                    outline-offset: 2px;
                    background: rgba(16, 185, 129, 0.08) !important;
                }
                .diff-element-removed {
                    outline: 2px solid #ef4444 !important;
                    outline-offset: 2px;
                    background: rgba(239, 68, 68, 0.08) !important;
                }
            `;
            
            // Add styles to both docs
            [oldDoc, newDoc].forEach(doc => {
                if (doc.getElementById('diffHighlightStyle')) return;
                const style = doc.createElement('style');
                style.id = 'diffHighlightStyle';
                style.textContent = styleContent;
                doc.head.appendChild(style);
            });
            
            // Get all text-containing leaf elements
            const oldElements = getLeafTextElements(oldDoc);
            const newElements = getLeafTextElements(newDoc);
            
            console.log(`📊 Diff: ${oldElements.length} old elements, ${newElements.length} new elements`);
            
            // Create maps for quick lookup
            const oldTextMap = new Map();
            oldElements.forEach(el => {
                const text = el.innerText.trim();
                if (!oldTextMap.has(text)) oldTextMap.set(text, []);
                oldTextMap.get(text).push(el);
            });
            
            const newTextMap = new Map();
            newElements.forEach(el => {
                const text = el.innerText.trim();
                if (!newTextMap.has(text)) newTextMap.set(text, []);
                newTextMap.get(text).push(el);
            });
            
            let changesFound = 0;
            
            // Compare new elements against old
            newElements.forEach(newEl => {
                const newText = newEl.innerText.trim();
                
                // Exact match exists - no change
                if (oldTextMap.has(newText)) {
                    return;
                }
                
                // Find best match in old
                let bestMatch = null;
                let bestScore = 0;
                
                oldElements.forEach(oldEl => {
                    const oldText = oldEl.innerText.trim();
                    const score = quickSimilarity(oldText, newText);
                    if (score > bestScore) {
                        bestScore = score;
                        bestMatch = { el: oldEl, text: oldText };
                    }
                });
                
                if (bestScore >= 0.8) {
                    // Very similar - highlight only the character differences
                    changesFound++;
                    highlightCharDifferences(bestMatch.el, bestMatch.text, newEl, newText, oldDoc, newDoc);
                } else if (bestScore >= 0.5) {
                    // Moderately similar - mark element as changed
                    changesFound++;
                    newEl.classList.add('diff-element-changed');
                    if (bestMatch) bestMatch.el.classList.add('diff-element-changed');
                } else {
                    // New element
                    changesFound++;
                    newEl.classList.add('diff-element-new');
                }
            });
            
            // Find removed elements
            oldElements.forEach(oldEl => {
                const oldText = oldEl.innerText.trim();
                if (newTextMap.has(oldText)) return;
                
                // Check if similar exists in new
                const hasSimilar = newElements.some(newEl => 
                    quickSimilarity(oldText, newEl.innerText.trim()) >= 0.5
                );
                
                if (!hasSimilar) {
                    oldEl.classList.add('diff-element-removed');
                    changesFound++;
                }
            });
            
            console.log(`✅ Diff complete: ${changesFound} changes highlighted`);
        }
        
        function getLeafTextElements(doc) {
            const results = [];
            const skip = ['SCRIPT', 'STYLE', 'NOSCRIPT', 'META', 'LINK', 'BR', 'HR', 'IMG'];
            
            function walk(node) {
                if (node.nodeType !== Node.ELEMENT_NODE) return;
                if (skip.includes(node.tagName)) return;
                
                // Check if this is a "leaf" text element (has text but no child elements with substantial text)
                const text = node.innerText?.trim() || '';
                if (text.length < 5) return;
                
                // Check children
                const childElements = Array.from(node.children).filter(c => !skip.includes(c.tagName));
                const hasSubstantialChildren = childElements.some(c => (c.innerText?.trim()?.length || 0) > 10);
                
                if (!hasSubstantialChildren && text.length >= 5) {
                    // This is a leaf - add it
                    results.push(node);
                } else {
                    // Recurse into children
                    childElements.forEach(walk);
                }
            }
            
            walk(doc.body);
            return results;
        }
        
        function quickSimilarity(text1, text2) {
            if (text1 === text2) return 1.0;
            if (!text1 || !text2) return 0;
            
            const len1 = text1.length;
            const len2 = text2.length;
            
            // Quick length check
            const lenRatio = Math.min(len1, len2) / Math.max(len1, len2);
            if (lenRatio < 0.5) return lenRatio * 0.5;
            
            // Count matching characters from start and end
            let matchStart = 0;
            let matchEnd = 0;
            const minLen = Math.min(len1, len2);
            
            while (matchStart < minLen && text1[matchStart] === text2[matchStart]) matchStart++;
            while (matchEnd < minLen - matchStart && text1[len1 - 1 - matchEnd] === text2[len2 - 1 - matchEnd]) matchEnd++;
            
            const totalMatch = matchStart + matchEnd;
            return totalMatch / Math.max(len1, len2);
        }
        
        function highlightCharDifferences(oldEl, oldText, newEl, newText, oldDoc, newDoc) {
            // Find the exact differences
            let prefixLen = 0;
            let suffixLen = 0;
            const minLen = Math.min(oldText.length, newText.length);
            
            // Find common prefix
            while (prefixLen < minLen && oldText[prefixLen] === newText[prefixLen]) prefixLen++;
            
            // Find common suffix (don't overlap with prefix)
            while (suffixLen < minLen - prefixLen && 
                   oldText[oldText.length - 1 - suffixLen] === newText[newText.length - 1 - suffixLen]) {
                suffixLen++;
            }
            
            // Calculate the changed portions
            const oldChanged = oldText.slice(prefixLen, oldText.length - suffixLen);
            const newChanged = newText.slice(prefixLen, newText.length - suffixLen);
            
            console.log(`🔍 Diff found: "${oldChanged}" → "${newChanged}"`);
            
            // Only highlight if changes are small (less than 30% of text changed)
            const changeRatio = Math.max(oldChanged.length, newChanged.length) / Math.max(oldText.length, newText.length);
            if (changeRatio > 0.3) {
                // Too much changed - just mark the element
                oldEl.classList.add('diff-element-changed');
                newEl.classList.add('diff-element-changed');
                return;
            }
            
            // Mark the element with a subtle indicator
            oldEl.classList.add('diff-element-changed');
            newEl.classList.add('diff-element-changed');
            
            // For small changes, we could highlight in-place, but this is complex with HTML
            // For now, the dashed outline shows which elements changed
        }
        
        function calculateTextSimilarity(text1, text2) {
            if (text1 === text2) return 1.0;
            if (!text1 || !text2) return 0;
            
            // Normalize
            const t1 = text1.toLowerCase();
            const t2 = text2.toLowerCase();
            
            // 1. Check character-level similarity for small changes (numbers, dates)
            const charSim = calculateCharSimilarity(t1, t2);
            
            // 2. Check word-level similarity
            const wordSim = calculateWordSimilarity(t1, t2);
            
            // Return the higher score (more lenient matching)
            return Math.max(charSim, wordSim);
        }
        
        function calculateCharSimilarity(text1, text2) {
            if (text1 === text2) return 1.0;
            if (text1.length === 0 || text2.length === 0) return 0;
            
            // For very long texts, sample
            const maxLen = Math.max(text1.length, text2.length);
            const minLen = Math.min(text1.length, text2.length);
            
            // If lengths are very different, low similarity
            if (minLen / maxLen < 0.7) return 0.3;
            
            // Count matching characters at same position
            let matches = 0;
            const len = Math.min(text1.length, text2.length, 500);
            
            for (let i = 0; i < len; i++) {
                if (text1[i] === text2[i]) matches++;
            }
            
            return matches / Math.max(text1.length, text2.length);
        }
        
        function calculateWordSimilarity(text1, text2) {
            const words1 = new Set(text1.split(/\s+/).filter(w => w.length > 2));
            const words2 = new Set(text2.split(/\s+/).filter(w => w.length > 2));
            
            if (words1.size === 0 || words2.size === 0) return 0;
            
            let intersection = 0;
            for (const word of words1) {
                if (words2.has(word)) intersection++;
            }
            
            const union = words1.size + words2.size - intersection;
            return intersection / union;
        }
        
        function removeDiffHighlight() {
            const newFrame = document.getElementById('compareNewFrame');
            if (!newFrame) return;
            
            const newDoc = newFrame.contentDocument || newFrame.contentWindow.document;
            if (!newDoc) return;
            
            // Remove highlight style
            const style = newDoc.getElementById('diffHighlightStyle');
            if (style) style.remove();
            
            // Remove highlight classes
            const changedEls = newDoc.querySelectorAll('.diff-changed');
            changedEls.forEach(el => el.classList.remove('diff-changed'));
            
            const newEls = newDoc.querySelectorAll('.diff-new');
            newEls.forEach(el => el.classList.remove('diff-new'));
        }
        
        function toggleSeoReport() {
            const panel = document.getElementById('seoReportPanel');
            const btn = document.getElementById('seoReportBtn');
            
            if (panel.style.display === 'none') {
                panel.style.display = 'flex';
                btn.classList.add('active');
                generateSeoReport();
                // Hide AI report if open
                document.getElementById('aiReportPanel').style.display = 'none';
                document.getElementById('aiReportBtn').classList.remove('active');
                // Hide competitor report if open
                document.getElementById('competitorReportPanel').style.display = 'none';
                document.getElementById('competitorReportBtn').classList.remove('active');
            } else {
                panel.style.display = 'none';
                btn.classList.remove('active');
            }
        }
        
        // ============ AI Detection Report ============
        let aiReportData = null;
        let selectedAiIssues = new Set();
        
        function toggleAiReport() {
            const panel = document.getElementById('aiReportPanel');
            const btn = document.getElementById('aiReportBtn');
            
            if (panel.style.display === 'none') {
                panel.style.display = 'flex';
                btn.classList.add('active');
                generateAiReport();
                // Hide SEO report if open
                document.getElementById('seoReportPanel').style.display = 'none';
                document.getElementById('seoReportBtn').classList.remove('active');
                // Hide competitor report if open
                document.getElementById('competitorReportPanel').style.display = 'none';
                document.getElementById('competitorReportBtn').classList.remove('active');
            } else {
                panel.style.display = 'none';
                btn.classList.remove('active');
            }
        }
        
        // ============ Keyword Density Analysis Functions ============
        
        function toggleDensityReport() {
            const panel = document.getElementById('densityReportPanel');
            
            if (panel.style.display === 'none') {
                panel.style.display = 'flex';
                // Hide other panels
                document.getElementById('seoReportPanel').style.display = 'none';
                document.getElementById('seoReportBtn').classList.remove('active');
                document.getElementById('aiReportPanel').style.display = 'none';
                document.getElementById('aiReportBtn').classList.remove('active');
                document.getElementById('competitorReportPanel').style.display = 'none';
                document.getElementById('competitorReportBtn')?.classList.remove('active');
                
                // Auto-fill keyword from page info
                if (selectedPage?.keyword) {
                    document.getElementById('densityKeyword').value = selectedPage.keyword;
                }
            } else {
                panel.style.display = 'none';
            }
        }
        
        async function runDensityAnalysis() {
            if (!selectedPage) {
                alert('אנא בחר עמוד');
                return;
            }
            
            const keyword = document.getElementById('densityKeyword').value.trim() || selectedPage.keyword;
            if (!keyword) {
                alert('אנא הזן מילת מפתח');
                return;
            }
            
            const resultsDiv = document.getElementById('densityAnalysisResults');
            resultsDiv.innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <div class="spinner"></div>
                    <p>מנתח צפיפות...</p>
                </div>
            `;
            
            try {
                const response = await apiCall('/api/analyze-density', {
                    method: 'POST',
                    body: JSON.stringify({
                        page_path: selectedPage.path,
                        keyword: keyword
                    })
                });
                
                if (response.success) {
                    renderDensityResults(response.analysis);
                } else {
                    resultsDiv.innerHTML = `
                        <div style="color: #ef4444; padding: 1rem; text-align: center;">
                            ❌ שגיאה: ${response.error || 'שגיאה לא ידועה'}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Density analysis error:', error);
                resultsDiv.innerHTML = `
                    <div style="color: #ef4444; padding: 1rem; text-align: center;">
                        ❌ שגיאה בניתוח: ${error.message}
                    </div>
                `;
            }
        }
        
        function renderDensityResults(analysis) {
            const resultsDiv = document.getElementById('densityAnalysisResults');
            const status = analysis.frequencyStatus || {};
            const distribution = analysis.distribution || {};
            const h2 = analysis.h2Analysis || {};
            const position = analysis.position || {};
            
            resultsDiv.innerHTML = `
                <div class="density-results" style="direction: rtl;">
                    <!-- Summary Cards -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; margin-bottom: 1rem;">
                        <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold;">${analysis.frequency?.display || 'N/A'}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">תדירות</div>
                        </div>
                        <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold;">${analysis.totalOccurrences || 0}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">מופעים</div>
                        </div>
                        <div style="background: ${status.color || '#888'}; color: white; padding: 1rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.5rem;">${status.icon || '❓'}</div>
                            <div style="font-size: 0.8rem;">${status.label || 'לא ידוע'}</div>
                        </div>
                    </div>
                    
                    <!-- Position Check -->
                    <div style="background: var(--bg-tertiary); padding: 0.75rem; border-radius: 8px; margin-bottom: 0.75rem;">
                        <div style="font-weight: bold; margin-bottom: 0.5rem;">📍 מיקום</div>
                        <div style="display: flex; gap: 1rem;">
                            <span>${position.inFirstParagraph ? '✅' : '❌'} פסקה ראשונה</span>
                            <span>${position.inConclusion ? '✅' : '❌'} סיום</span>
                        </div>
                    </div>
                    
                    <!-- Distribution -->
                    <div style="background: var(--bg-tertiary); padding: 0.75rem; border-radius: 8px; margin-bottom: 0.75rem;">
                        <div style="font-weight: bold; margin-bottom: 0.5rem;">📊 פיזור ${distribution.isBalanced ? '✅' : '⚠️'}</div>
                        <div style="display: flex; gap: 0.5rem; align-items: flex-end; height: 60px;">
                            <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                                <div style="background: #10b981; width: 100%; height: ${(distribution.firstThird?.percentage || 0) * 0.6}px; max-height: 60px; border-radius: 4px 4px 0 0;"></div>
                                <small style="font-size: 0.7rem;">${distribution.firstThird?.percentage || 0}%</small>
                            </div>
                            <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                                <div style="background: #3b82f6; width: 100%; height: ${(distribution.middleThird?.percentage || 0) * 0.6}px; max-height: 60px; border-radius: 4px 4px 0 0;"></div>
                                <small style="font-size: 0.7rem;">${distribution.middleThird?.percentage || 0}%</small>
                            </div>
                            <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                                <div style="background: #f59e0b; width: 100%; height: ${(distribution.lastThird?.percentage || 0) * 0.6}px; max-height: 60px; border-radius: 4px 4px 0 0;"></div>
                                <small style="font-size: 0.7rem;">${distribution.lastThird?.percentage || 0}%</small>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 0.7rem; color: var(--text-muted); margin-top: 0.25rem;">
                            <span>שליש 1</span>
                            <span>שליש 2</span>
                            <span>שליש 3</span>
                        </div>
                    </div>
                    
                    <!-- H2 Analysis -->
                    <div style="background: var(--bg-tertiary); padding: 0.75rem; border-radius: 8px; margin-bottom: 0.75rem;">
                        <div style="font-weight: bold; margin-bottom: 0.5rem;">
                            🏷️ כותרות H2 ${h2.isOverLimit ? '⚠️' : '✅'}
                        </div>
                        <div style="font-size: 0.9rem;">
                            ${h2.h2WithKeyword || 0}/${h2.totalH2 || 0} עם מילת מפתח (${h2.percentage || 0}%)
                            <br><small style="color: var(--text-muted);">מקסימום מותר: ${h2.maxAllowed || 0}</small>
                        </div>
                    </div>
                    
                    <!-- Paragraph Issues -->
                    ${(analysis.paragraphIssues || []).length > 0 ? `
                        <div style="background: #fef3c7; color: #92400e; padding: 0.75rem; border-radius: 8px; margin-bottom: 0.75rem;">
                            <div style="font-weight: bold; margin-bottom: 0.5rem;">⚠️ פסקאות בעייתיות</div>
                            ${analysis.paragraphIssues.map(issue => `
                                <div style="font-size: 0.85rem; margin-bottom: 0.25rem;">
                                    <strong>פסקה ${issue.index}:</strong> ${issue.occurrences} מופעים (מקס ${issue.maxAllowed})
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    
                    <!-- Word Family -->
                    <div style="background: var(--bg-tertiary); padding: 0.75rem; border-radius: 8px;">
                        <div style="font-weight: bold; margin-bottom: 0.5rem;">🔤 משפחת מילים שנספרו</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted); line-height: 1.6;">
                            ${(analysis.variations || []).join(', ')}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // ============ Competitor Analysis Functions ============
        
        let competitorAnalysisState = {
            keyword: '',
            autocomplete: [],
            serpResults: [],
            competitorsData: [],
            gapAnalysis: ''
        };
        
        function toggleCompetitorReport() {
            const panel = document.getElementById('competitorReportPanel');
            const btn = document.getElementById('competitorReportBtn');
            
            if (panel.style.display === 'none') {
                panel.style.display = 'flex';
                btn.classList.add('active');
                // Hide other panels
                document.getElementById('seoReportPanel').style.display = 'none';
                document.getElementById('seoReportBtn').classList.remove('active');
                document.getElementById('aiReportPanel').style.display = 'none';
                document.getElementById('aiReportBtn').classList.remove('active');
                
                // Auto-load existing data if available
                autoLoadCompetitorData();
            } else {
                panel.style.display = 'none';
                btn.classList.remove('active');
            }
        }
        
        async function autoLoadCompetitorData() {
            if (!selectedPage) return;
            
            const introDiv = document.querySelector('.competitor-report-intro');
            const resultsDiv = document.getElementById('competitorAnalysisResults');
            
            // Show loading
            introDiv.innerHTML = `
                <div style="text-align: center; padding: 1rem;">
                    <div class="spinner"></div>
                    <p>בודק נתונים קיימים...</p>
                </div>
            `;
            
            try {
                const result = await apiCall(`/api/seo/load-competitor-data?page_path=${encodeURIComponent(selectedPage.path)}`);
                
                if (result.success && result.exists) {
                    // Data exists - load it and show rescan option
                    const analysis = result.analysis || {};
                    competitorAnalysisState.keyword = analysis.target_keyword || '';
                    competitorAnalysisState.autocomplete = analysis.autocomplete_suggestions || [];
                    competitorAnalysisState.serpResults = analysis.serp_results || [];
                    competitorAnalysisState.competitorsData = analysis.competitors_data || [];
                    competitorAnalysisState.gapAnalysis = result.report || '';
                    
                    // Show last scan date
                    const scanDate = analysis.scan_date ? new Date(analysis.scan_date).toLocaleDateString('he-IL') : 'לא ידוע';
                    
                    introDiv.innerHTML = `
                        <div style="text-align: center; padding: 0.5rem;">
                            <p style="color: var(--accent-success); margin-bottom: 0.5rem;">
                                ✅ נמצאו נתונים מסריקה קודמת (${scanDate})
                            </p>
                            <button class="btn btn-secondary" onclick="runCompetitorAnalysis()" style="margin: 5px;">
                                🔄 סרוק מחדש
                            </button>
                        </div>
                    `;
                    introDiv.style.display = 'block';
                    resultsDiv.style.display = 'block';
                    
                    // Render the results
                    renderCompetitorResults();
                    
                } else {
                    // No data - show scan button
                    const keyword = uploadState.keyword || selectedPage?.keyword || 'לא נמצאה מילת מפתח';
                    introDiv.innerHTML = `
                        <p>סרוק את 5 התוצאות הראשונות בגוגל עבור: <strong>"${keyword}"</strong></p>
                        <button class="btn btn-primary" onclick="runCompetitorAnalysis()">
                            🚀 סרוק מתחרים
                        </button>
                    `;
                    introDiv.style.display = 'block';
                    resultsDiv.style.display = 'none';
                }
                
            } catch (error) {
                console.error('Error loading competitor data:', error);
                // Show scan button on error
                introDiv.innerHTML = `
                    <p>סרוק את 5 התוצאות הראשונות בגוגל עבור מילת המפתח.</p>
                    <button class="btn btn-primary" onclick="runCompetitorAnalysis()">
                        🚀 סרוק מתחרים
                    </button>
                `;
                introDiv.style.display = 'block';
                resultsDiv.style.display = 'none';
            }
        }
        
        async function runCompetitorAnalysis() {
            const keyword = uploadState.keyword || selectedPage?.keyword;
            
            if (!keyword) {
                showToast('לא נמצאה מילת מפתח. בדוק את page_info.json', 'error');
                return;
            }
            
            const resultsDiv = document.getElementById('competitorAnalysisResults');
            const introDiv = document.querySelector('.competitor-report-intro');
            
            // Show loading state
            introDiv.style.display = 'none';
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = `
                <div class="competitor-loading">
                    <div class="spinner"></div>
                    <h4>מנתח מתחרים עבור: "${keyword}"</h4>
                    <div class="competitor-progress">
                        <div class="competitor-progress-step active" id="step-autocomplete">
                            <span class="step-icon">⏳</span>
                            <span>שלב 1: שולף השלמות מגוגל...</span>
                        </div>
                        <div class="competitor-progress-step" id="step-serp">
                            <span class="step-icon">⏳</span>
                            <span>שלב 2: מחפש תוצאות חיפוש...</span>
                        </div>
                        <div class="competitor-progress-step" id="step-scrape">
                            <span class="step-icon">⏳</span>
                            <span>שלב 3: סורק תוכן מתחרים...</span>
                        </div>
                        <div class="competitor-progress-step" id="step-analyze">
                            <span class="step-icon">⏳</span>
                            <span>שלב 4: מייצר ניתוח פערים...</span>
                        </div>
                    </div>
                </div>
            `;
            
            try {
                // Step 1: Get autocomplete suggestions
                updateCompetitorStep('step-autocomplete', 'active');
                const autocompleteResult = await apiCall('/api/seo/autocomplete', {
                    method: 'POST',
                    body: JSON.stringify({ keyword })
                });
                
                if (!autocompleteResult.success) {
                    throw new Error(autocompleteResult.error || 'שגיאה בשליפת השלמות');
                }
                
                competitorAnalysisState.keyword = keyword;
                competitorAnalysisState.autocomplete = autocompleteResult.suggestions || [];
                updateCompetitorStep('step-autocomplete', 'done');
                
                // Step 2: Get SERP results (10 results, but only scrape top 5)
                updateCompetitorStep('step-serp', 'active');
                const ourUrl = uploadState.url || selectedPage?.url || '';
                const serpResult = await apiCall('/api/seo/serp', {
                    method: 'POST',
                    body: JSON.stringify({ 
                        keyword,
                        max_results: 10,
                        our_url: ourUrl
                    })
                });
                
                if (!serpResult.success) {
                    throw new Error(serpResult.error || 'שגיאה בחיפוש גוגל');
                }
                
                competitorAnalysisState.serpResults = serpResult.results || [];
                updateCompetitorStep('step-serp', 'done');
                
                // Step 3: Scrape competitors
                updateCompetitorStep('step-scrape', 'active');
                
                // Filter out our own domain from competitors
                const OUR_DOMAINS = ['loan-israel.co.il', 'www.loan-israel.co.il'];
                const urls = competitorAnalysisState.serpResults
                    .map(r => r.url)
                    .filter(url => {
                        try {
                            const domain = new URL(url).hostname.toLowerCase();
                            return !OUR_DOMAINS.some(ourDomain => domain.includes(ourDomain.replace('www.', '')));
                        } catch {
                            return false;
                        }
                    });
                console.log(`[Competitors] Filtered to ${urls.length} competitor URLs (removed our domain)`);
                
                const relatedTerms = competitorAnalysisState.autocomplete.slice(0, 10);
                
                const scrapeResult = await apiCall('/api/seo/scrape-competitors', {
                    method: 'POST',
                    body: JSON.stringify({
                        urls,
                        keyword,
                        related_terms: relatedTerms
                    })
                });
                
                if (!scrapeResult.success) {
                    throw new Error(scrapeResult.error || 'שגיאה בסריקת מתחרים');
                }
                
                competitorAnalysisState.competitorsData = scrapeResult.competitors_data || [];
                updateCompetitorStep('step-scrape', 'done');
                
                // Step 4: Save data to folder
                const fullData = {
                    scan_date: new Date().toISOString(),
                    target_keyword: keyword,
                    autocomplete_suggestions: competitorAnalysisState.autocomplete,
                    related_keywords: relatedTerms,
                    serp_results: competitorAnalysisState.serpResults,
                    competitors_data: competitorAnalysisState.competitorsData
                };
                
                await apiCall('/api/seo/save-competitor-data', {
                    method: 'POST',
                    body: JSON.stringify({
                        page_path: selectedPage.path,
                        data: fullData
                    })
                });
                
                // Step 5: Analyze with Claude
                updateCompetitorStep('step-analyze', 'active');
                const analyzeResult = await apiCall('/api/seo/analyze-competitors', {
                    method: 'POST',
                    body: JSON.stringify({
                        page_path: selectedPage.path,
                        data: fullData
                    })
                });
                
                if (!analyzeResult.success) {
                    throw new Error(analyzeResult.error || 'שגיאה בניתוח');
                }
                
                competitorAnalysisState.gapAnalysis = analyzeResult.analysis || '';
                updateCompetitorStep('step-analyze', 'done');
                
                // Render results
                renderCompetitorResults();
                showToast('✅ ניתוח מתחרים הושלם!', 'success');
                
            } catch (error) {
                console.error('Competitor analysis error:', error);
                resultsDiv.innerHTML = `
                    <div class="competitor-section" style="text-align: center; color: var(--accent-error);">
                        <h4>❌ שגיאה בניתוח</h4>
                        <p>${error.message}</p>
                        <button class="btn btn-primary" onclick="runCompetitorAnalysis()" style="margin-top: 1rem;">
                            🔄 נסה שוב
                        </button>
                    </div>
                `;
            }
        }
        
        function updateCompetitorStep(stepId, status) {
            const step = document.getElementById(stepId);
            if (!step) return;
            
            step.classList.remove('active', 'done');
            step.classList.add(status);
            
            const icon = step.querySelector('.step-icon');
            if (icon) {
                if (status === 'active') {
                    icon.textContent = '⏳';
                } else if (status === 'done') {
                    icon.textContent = '✅';
                }
            }
        }
        
        function renderCompetitorResults() {
            const resultsDiv = document.getElementById('competitorAnalysisResults');
            
            let html = '';
            
            // Rescan button at top
            html += `
                <div style="text-align: left; margin-bottom: 1rem;">
                    <button class="btn btn-small" onclick="runCompetitorAnalysis()">
                        🔄 סרוק מחדש
                    </button>
                </div>
            `;
            
            // Autocomplete section
            if (competitorAnalysisState.autocomplete.length > 0) {
                html += `
                    <div class="competitor-section">
                        <h4>🔎 השלמות גוגל (${competitorAnalysisState.autocomplete.length})</h4>
                        <div class="autocomplete-tags">
                            ${competitorAnalysisState.autocomplete.map(s => `
                                <span class="autocomplete-tag">${s}</span>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // SERP results section
            if (competitorAnalysisState.serpResults.length > 0) {
                html += `
                    <div class="competitor-section">
                        <h4>🏆 תוצאות חיפוש (${competitorAnalysisState.serpResults.length})</h4>
                        ${competitorAnalysisState.serpResults.map((result, i) => {
                            const competitor = competitorAnalysisState.competitorsData[i];
                            const wordCount = competitor?.structure?.word_count || null;
                            const schemas = competitor?.meta?.schemas_found?.join(', ') || null;
                            const isOurs = result.is_ours;
                            const willBeScrapped = i < 5;
                            
                            return `
                                <div class="serp-result" style="${isOurs ? 'border: 2px solid var(--accent-success); background: rgba(46, 160, 67, 0.1);' : ''}">
                                    <div class="serp-rank" style="${isOurs ? 'background: var(--accent-success);' : ''}">${result.rank}</div>
                                    <div class="serp-info">
                                        <div class="serp-title">
                                            ${isOurs ? '<span style="background: var(--accent-success); color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-left: 8px;">🏠 שלנו</span>' : ''}
                                            ${willBeScrapped && !isOurs ? '<span style="background: var(--accent-primary); color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px; margin-left: 5px;">נסרק</span>' : ''}
                                            ${result.title || 'ללא כותרת'}
                                        </div>
                                        <div class="serp-url" style="${isOurs ? 'color: var(--accent-success);' : ''}">${result.url}</div>
                                        ${wordCount ? `
                                            <div class="serp-stats">
                                                📝 ${wordCount} מילים | 📊 ${schemas || 'אין'}
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }
            
            // Gap Analysis section
            if (competitorAnalysisState.gapAnalysis) {
                html += `
                    <div class="competitor-section">
                        <h4>📋 ניתוח פערים אסטרטגי</h4>
                        <div class="gap-analysis-content">
                            ${competitorAnalysisState.gapAnalysis.replace(/\n/g, '<br>').replace(/##\s*(.*)/g, '<h3>$1</h3>').replace(/###\s*(.*)/g, '<h4>$1</h4>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>')}
                        </div>
                    </div>
                `;
            }
            
            resultsDiv.innerHTML = html;
        }
        
        async function loadExistingCompetitorData() {
            if (!selectedPage) {
                showToast('לא נבחר עמוד', 'error');
                return;
            }
            
            try {
                const result = await apiCall(`/api/seo/load-competitor-data?page_path=${encodeURIComponent(selectedPage.path)}`);
                
                if (!result.success) {
                    showToast('שגיאה בטעינת נתונים', 'error');
                    return;
                }
                
                if (!result.exists) {
                    showToast('לא נמצאה סריקה קודמת. הרץ סריקה חדשה.', 'info');
                    return;
                }
                
                // Populate state from loaded data
                const analysis = result.analysis || {};
                competitorAnalysisState.keyword = analysis.target_keyword || '';
                competitorAnalysisState.autocomplete = analysis.autocomplete_suggestions || [];
                competitorAnalysisState.serpResults = analysis.serp_results || [];
                competitorAnalysisState.competitorsData = analysis.competitors_data || [];
                competitorAnalysisState.gapAnalysis = result.report || '';
                
                // Hide intro, show results
                document.querySelector('.competitor-report-intro').style.display = 'none';
                document.getElementById('competitorAnalysisResults').style.display = 'block';
                
                // Render
                renderCompetitorResults();
                showToast('✅ נתונים נטענו בהצלחה', 'success');
                
            } catch (error) {
                console.error('Error loading competitor data:', error);
                showToast('שגיאה בטעינת נתונים', 'error');
            }
        }
        
        // ============ End Competitor Analysis Functions ============
        
        async function generateAiReport() {
            const newContent = uploadState.newContent;
            const oldContent = uploadState.backupContent;
            
            if (!newContent && !oldContent) {
                document.getElementById('aiReportContent').innerHTML = `
                    <div class="empty-state" style="padding: 2rem; text-align: center;">
                        אין תוכן לניתוח
                    </div>
                `;
                return;
            }
            
            document.getElementById('aiReportContent').innerHTML = `
                <div style="padding: 2rem; text-align: center;">
                    <div class="spinner"></div>
                    <p>מנתח תוכן ישן וחדש...</p>
                </div>
            `;
            
            try {
                // Analyze both old and new content
                let oldResult = null;
                let newResult = null;
                
                if (oldContent) {
                    oldResult = await apiCall('/api/ai-detection', {
                        method: 'POST',
                        body: JSON.stringify({ content: oldContent })
                    });
                }
                
                if (newContent) {
                    newResult = await apiCall('/api/ai-detection', {
                        method: 'POST',
                        body: JSON.stringify({ content: newContent })
                    });
                }
                
                // Store new result for prompt generation
                aiReportData = newResult;
                selectedAiIssues = new Set();
                
                renderAiReportComparison(oldResult, newResult);
                
            } catch (error) {
                console.error('AI detection error:', error);
                document.getElementById('aiReportContent').innerHTML = `
                    <div class="empty-state" style="padding: 2rem; text-align: center; color: #ef4444;">
                        שגיאה בניתוח: ${error.message}
                    </div>
                `;
            }
        }
        
        function renderAiReportComparison(oldResult, newResult) {
            let html = `<div style="display: flex; flex-direction: column; gap: 1rem; padding: 0.5rem;">`;
            
            // Summary comparison
            html += `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    ${renderAiScoreCard(oldResult, 'תוכן ישן (WordPress)', '#6366f1')}
                    ${renderAiScoreCard(newResult, 'תוכן חדש (לאחר עריכה)', '#10b981')}
                </div>
            `;
            
            // Show improvement/degradation
            if (oldResult?.success && newResult?.success) {
                const diff = oldResult.score - newResult.score;
                const diffColor = diff > 0 ? '#10b981' : diff < 0 ? '#ef4444' : '#6b7280';
                const diffText = diff > 0 ? `שיפור של ${diff} נקודות` : diff < 0 ? `החמרה של ${Math.abs(diff)} נקודות` : 'ללא שינוי';
                const diffIcon = diff > 0 ? '📉' : diff < 0 ? '📈' : '➡️';
                
                html += `
                    <div style="text-align: center; padding: 0.75rem; background: rgba(255,255,255,0.05); border-radius: 8px;">
                        <span style="font-size: 1.2rem;">${diffIcon}</span>
                        <span style="color: ${diffColor}; font-weight: bold; margin-right: 0.5rem;">${diffText}</span>
                    </div>
                `;
            }
            
            // Toolbar for new content issues
            if (newResult?.success && newResult.total_issues > 0) {
                html += `
                    <div style="padding: 0.75rem; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; display: flex; gap: 0.5rem; align-items: center;">
                        <span style="font-weight: bold;">תיקון תוכן חדש:</span>
                        <button class="btn btn-small" onclick="selectAllAiIssues()">✅ בחר הכל</button>
                        <button class="btn btn-small" onclick="clearAllAiIssues()">❌ נקה</button>
                        <button class="btn btn-small btn-primary" onclick="generateAiFixPrompt()" id="aiFixPromptBtn" disabled>
                            🚀 צור פרומפט
                        </button>
                    </div>
                `;
            }
            
            // Side by side issues
            html += `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; max-height: 45vh; overflow-y: auto;">
                    ${renderAiIssuesList(oldResult, 'old')}
                    ${renderAiIssuesList(newResult, 'new')}
                </div>
            `;
            
            html += `</div>`;
            
            document.getElementById('aiReportContent').innerHTML = html;
        }
        
        function renderAiScoreCard(result, title, accentColor) {
            if (!result || !result.success) {
                return `
                    <div style="padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 8px; text-align: center;">
                        <div style="font-weight: bold; margin-bottom: 0.5rem; color: ${accentColor};">${title}</div>
                        <div style="color: var(--text-muted);">אין נתונים</div>
                    </div>
                `;
            }
            
            const scoreColor = result.score < 15 ? '#10b981' : result.score < 30 ? '#f59e0b' : result.score < 50 ? '#f97316' : '#ef4444';
            
            return `
                <div style="padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 8px; border-top: 3px solid ${accentColor};">
                    <div style="font-weight: bold; margin-bottom: 0.75rem; color: ${accentColor};">${title}</div>
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div style="font-size: 2rem; font-weight: bold; color: ${scoreColor};">${result.score}</div>
                        <div style="flex: 1;">
                            <div style="font-size: 0.85rem;">${result.confidence}</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">${result.total_issues || 0} בעיות</div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderAiIssuesList(result, type) {
            if (!result || !result.success) {
                return `<div style="color: var(--text-muted); text-align: center; padding: 1rem;">אין נתונים</div>`;
            }
            
            if (!result.issues || result.issues.length === 0) {
                return `
                    <div style="text-align: center; padding: 1rem; color: #10b981;">
                        ✅ לא זוהו סימני AI בולטים
                    </div>
                `;
            }
            
            let html = `<div style="font-size: 0.85rem;">`;
            
            const categories = result.categories || {};
            for (const [catKey, cat] of Object.entries(categories)) {
                const catIssues = result.issues.filter(i => i.category === catKey);
                
                html += `
                    <div style="margin-bottom: 0.75rem;">
                        <div style="font-weight: bold; padding: 0.4rem; background: rgba(255,255,255,0.05); border-radius: 4px; font-size: 0.8rem;">
                            ${cat.name} (${cat.count})
                        </div>
                `;
                
                for (const issue of catIssues.slice(0, 5)) {
                    if (type === 'new') {
                        const isSelected = selectedAiIssues.has(issue.id);
                        html += `
                            <label style="display: flex; align-items: flex-start; gap: 0.4rem; padding: 0.4rem; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.03); font-size: 0.8rem;">
                                <input type="checkbox" 
                                       onchange="toggleAiIssue('${issue.id}')" 
                                       ${isSelected ? 'checked' : ''}
                                       style="margin-top: 2px;">
                                <span style="color: #fbbf24;">"${escapeHtml(issue.phrase)}"</span>
                            </label>
                        `;
                    } else {
                        html += `
                            <div style="padding: 0.4rem; border-bottom: 1px solid rgba(255,255,255,0.03); font-size: 0.8rem;">
                                <span style="color: #a78bfa;">"${escapeHtml(issue.phrase)}"</span>
                            </div>
                        `;
                    }
                }
                
                if (catIssues.length > 5) {
                    html += `<div style="padding: 0.25rem; color: var(--text-muted); font-size: 0.75rem;">...ועוד ${catIssues.length - 5}</div>`;
                }
                
                html += `</div>`;
            }
            
            html += `</div>`;
            return html;
        }
        
        // renderAiReport is replaced by renderAiReportComparison for side-by-side view
        
        function toggleAiIssue(issueId) {
            if (selectedAiIssues.has(issueId)) {
                selectedAiIssues.delete(issueId);
            } else {
                selectedAiIssues.add(issueId);
            }
            updateAiPromptButton();
        }
        
        function selectAllAiIssues() {
            if (!aiReportData || !aiReportData.issues) return;
            aiReportData.issues.forEach(issue => {
                selectedAiIssues.add(issue.id);
            });
            renderAiReport(aiReportData);
            updateAiPromptButton();
        }
        
        function clearAllAiIssues() {
            selectedAiIssues.clear();
            renderAiReport(aiReportData);
            updateAiPromptButton();
        }
        
        function updateAiPromptButton() {
            const btn = document.getElementById('aiFixPromptBtn');
            if (btn) {
                btn.disabled = selectedAiIssues.size === 0;
            }
        }
        
        function generateAiFixPrompt() {
            if (!aiReportData || selectedAiIssues.size === 0) {
                showToast('בחר לפחות בעיה אחת לתיקון', 'error');
                return;
            }
            
            const selectedIssues = aiReportData.issues.filter(i => selectedAiIssues.has(i.id));
            
            // Build smart prompt
            let prompt = `# משימה: הפוך תוכן AI לטבעי ואנושי יותר

## קובץ לעריכה
@${selectedPage.path}

## הנחיות חשובות
- בדוק כל פריט **בהקשר שלו** לפני שמחליט אם לתקן
- השתמש בשיקול דעת - לא כל דגל דורש תיקון!
- המטרה: טקסט טבעי, אנושי וקריא
- שמור על המשמעות המקורית
- אל תחליף עיוור - קרא את ההקשר

## בעיות שזוהו (${selectedIssues.length} נבחרו)

`;
            
            // Group by category
            const byCategory = {};
            selectedIssues.forEach(issue => {
                if (!byCategory[issue.category]) byCategory[issue.category] = [];
                byCategory[issue.category].push(issue);
            });
            
            const categoryNames = {
                'ai_phrase': 'ביטויי AI גנריים',
                'claude_fingerprint': 'טביעות אצבע של Claude',
                'formal_language': 'שפה רשמית מדי',
                'tautology': 'כפילויות מיותרות',
                'superlative': 'שפה מוגזמת',
                'generic_conclusion': 'סיום גנרי',
                'didactic_pattern': 'תבנית דידקטית',
                'impersonal': 'העדר אישיות'
            };
            
            for (const [cat, issues] of Object.entries(byCategory)) {
                prompt += `### ${categoryNames[cat] || cat}\n\n`;
                
                issues.forEach((issue, idx) => {
                    prompt += `${idx + 1}. **"${issue.phrase}"**\n`;
                    prompt += `   - הקשר: ${issue.context}\n`;
                    prompt += `   - המלצה: ${issue.suggestion}\n`;
                    if (issue.replacement) {
                        prompt += `   - אפשרות החלפה: "${issue.replacement}"\n`;
                    }
                    prompt += `\n`;
                });
            }
            
            prompt += `
## חשוב מאוד!
- לא לתקן הכל על עיוור - חלק מהשפה הפורמלית יכולה להיות מתאימה
- לקרוא את ההקשר לפני כל החלטה
- לוודא שהתוצאה נשמעת טבעית ולא מכונית
- לשמור על הסגנון הכללי של הטקסט

🏁 סיום!
`;
            
            // Show prompt preview
            showPromptPreview(prompt, 'ai_humanize');
        }
        
        async function checkBrokenLinks(urls) {
            const results = [];
            const checked = new Set();
            
            for (const link of urls) {
                // Skip duplicates
                if (checked.has(link.href)) continue;
                checked.add(link.href);
                
                // Skip non-http links
                if (!link.href.startsWith('http')) continue;
                
                try {
                    // Use our server as proxy to check links (to avoid CORS)
                    const response = await fetch(`/api/check-link?url=${encodeURIComponent(link.href)}`, {
                        method: 'GET',
                        signal: AbortSignal.timeout(5000)
                    });
                    const data = await response.json();
                    
                    if (!data.ok || data.status >= 400) {
                        results.push({
                            url: link.href,
                            text: link.text,
                            status: data.status || 'Error',
                            isExternal: link.isExternal
                        });
                    }
                } catch (err) {
                    // Timeout or network error - might be broken
                    results.push({
                        url: link.href,
                        text: link.text,
                        status: 'Timeout/Error',
                        isExternal: link.isExternal
                    });
                }
            }
            
            return results;
        }
        
        function generateSeoReport() {
            try {
                const oldFrame = document.getElementById('compareOldFrame');
                const newFrame = document.getElementById('compareNewFrame');
                
                let oldAnalysis = { available: false };
                let newAnalysis = { available: false };
                
                if (oldFrame) {
                    try {
                        const oldDoc = oldFrame.contentDocument || oldFrame.contentWindow.document;
                        if (oldDoc && oldDoc.body) {
                            oldAnalysis = analyzeContent(oldDoc);
                            oldAnalysis.available = true;
                        }
                    } catch (e) {
                        console.log('Cannot access old frame:', e);
                    }
                }
                
                if (newFrame) {
                    try {
                        const newDoc = newFrame.contentDocument || newFrame.contentWindow.document;
                        if (newDoc && newDoc.body) {
                            newAnalysis = analyzeContent(newDoc);
                            newAnalysis.available = true;
                        }
                    } catch (e) {
                        console.log('Cannot access new frame:', e);
                    }
                }
                
                // Get keyword from page info
                const keyword = uploadState.pageInfo?.keyword || 'הלוואה';
                
                // Analyze keyword density for both
                if (oldAnalysis.available) {
                    oldAnalysis.keywordAnalysis = analyzeKeywordDensity(oldAnalysis.text, oldAnalysis.headings, keyword);
                }
                if (newAnalysis.available) {
                    newAnalysis.keywordAnalysis = analyzeKeywordDensity(newAnalysis.text, newAnalysis.headings, keyword);
                }
                
                // Store for broken link check
                window.currentSeoAnalysis = { oldAnalysis, newAnalysis, keyword };
                
                // Generate report HTML
                const reportHtml = generateSeoReportHtml(oldAnalysis, newAnalysis, keyword);
                document.getElementById('seoReportContent').innerHTML = reportHtml;
                
            } catch (error) {
                console.error('Error generating SEO report:', error);
                document.getElementById('seoReportContent').innerHTML = `
                    <div style="color: #ef4444; padding: 1rem;">
                        <h4>❌ שגיאה בהפקת הדוח</h4>
                        <pre style="background: #1e1e1e; padding: 1rem; border-radius: 6px; overflow-x: auto;">${error.message}\n${error.stack}</pre>
                    </div>
                `;
            }
        }
        
        async function checkBrokenLinksInReport() {
            const analysis = window.currentSeoAnalysis;
            if (!analysis || !analysis.newAnalysis.links?.urls) {
                showToast('אין קישורים לבדוק', 'info');
                return;
            }
            
            const btn = document.getElementById('checkLinksBtn');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '⏳ בודק קישורים...';
            }
            
            showToast('בודק קישורים... זה עלול לקחת זמן', 'info');
            
            const brokenLinks = await checkBrokenLinks(analysis.newAnalysis.links.urls);
            
            // Display results
            const resultsDiv = document.getElementById('brokenLinksResults');
            if (resultsDiv) {
                if (brokenLinks.length === 0) {
                    resultsDiv.innerHTML = '<div style="color: #10b981; padding: 1rem;">✅ כל הקישורים תקינים!</div>';
                } else {
                    resultsDiv.innerHTML = `
                        <div style="color: #ef4444; padding: 0.5rem 0;">❌ נמצאו ${brokenLinks.length} קישורים שבורים:</div>
                        <table style="width: 100%; font-size: 0.8rem; border-collapse: collapse;">
                            <tr style="background: rgba(255,255,255,0.1);">
                                <th style="padding: 0.5rem; text-align: right;">טקסט</th>
                                <th style="padding: 0.5rem; text-align: right;">סטטוס</th>
                                <th style="padding: 0.5rem; text-align: right;">URL</th>
                            </tr>
                            ${brokenLinks.map(l => `
                                <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                                    <td style="padding: 0.5rem;">${l.text || '-'}</td>
                                    <td style="padding: 0.5rem; color: #ef4444;">${l.status}</td>
                                    <td style="padding: 0.5rem; direction: ltr; font-size: 0.7rem; max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${l.url}</td>
                                </tr>
                            `).join('')}
                        </table>
                    `;
                }
            }
            
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = '🔗 בדוק קישורים שבורים';
            }
        }
        
        function analyzeContent(doc) {
            const body = doc.body;
            const text = body.innerText;
            const words = text.split(/\s+/).filter(w => w.length > 0);
            
            // Store full HTML content for advanced analyzer
            const htmlContent = doc.documentElement.outerHTML;
            
            // Headings - filter out empty headings
            // Use textContent instead of innerText to get text even from hidden elements
            const h1sRaw = Array.from(body.querySelectorAll('h1'));
            const h2sRaw = Array.from(body.querySelectorAll('h2'));
            const h1s = h1sRaw.map(h => h.textContent.trim()).filter(t => t.length > 0);
            const h2s = h2sRaw.map(h => h.textContent.trim()).filter(t => t.length > 0);
            const h3s = Array.from(body.querySelectorAll('h3')).map(h => h.textContent.trim()).filter(t => t.length > 0);
            const h4s = Array.from(body.querySelectorAll('h4')).map(h => h.textContent.trim()).filter(t => t.length > 0);
            
            // Debug: Log heading extraction with detailed info
            const h2Details = h2sRaw.slice(0, 10).map((h, i) => ({
                index: i,
                textContent: h.textContent?.substring(0, 50),
                innerHTML: h.innerHTML?.substring(0, 80),
                outerHTML: h.outerHTML?.substring(0, 100)
            }));
            console.log('📑 Heading Extraction Debug:', {
                h1sFound: h1sRaw.length,
                h1sWithText: h1s.length,
                h1Texts: h1s,
                h2sFound: h2sRaw.length,
                h2sWithText: h2s.length,
                h2Texts: h2s.slice(0, 5), // First 5 for preview
                h2EmptyCount: h2sRaw.length - h2s.length,
                h2Details: h2Details
            });
            
            // Links
            const links = Array.from(body.querySelectorAll('a[href]'));
            const internalLinks = links.filter(l => {
                const href = l.getAttribute('href');
                return href && (href.startsWith('/') || href.includes('loan-israel.co.il'));
            });
            const externalLinks = links.filter(l => {
                const href = l.getAttribute('href');
                return href && href.startsWith('http') && !href.includes('loan-israel.co.il');
            });
            
            // Collect all link URLs for broken link check - with context (5 words before/after)
            const allLinkUrls = links.map(l => {
                const href = l.getAttribute('href');
                const linkText = l.innerText.trim().substring(0, 50);
                
                // Get surrounding text context - extract ~5 words before and after
                let contextBefore = '';
                let contextAfter = '';
                let isUIPattern = false;
                let uiPatternType = '';
                
                try {
                    const parent = l.parentElement;
                    if (parent) {
                        const parentText = parent.innerText;
                        const linkIndex = parentText.indexOf(l.innerText.trim());
                        
                        // Get text before the link
                        if (linkIndex > 0) {
                            const textBefore = parentText.substring(0, linkIndex).trim();
                            const wordsBefore = textBefore.split(/\s+/).filter(w => w.length > 0);
                            contextBefore = wordsBefore.slice(-5).join(' ');
                        }
                        
                        // Get text after the link
                        const afterIndex = linkIndex + l.innerText.trim().length;
                        if (afterIndex < parentText.length) {
                            const textAfter = parentText.substring(afterIndex).trim();
                            const wordsAfter = textAfter.split(/\s+/).filter(w => w.length > 0);
                            contextAfter = wordsAfter.slice(0, 5).join(' ');
                        }
                        
                        // Check for UI patterns (flip cards, mobile/desktop variants)
                        let element = l;
                        for (let i = 0; i < 5 && element; i++) {
                            const classes = element.className?.toLowerCase() || '';
                            const id = element.id?.toLowerCase() || '';
                            const combined = classes + ' ' + id;
                            
                            // Flip card patterns
                            if (combined.match(/card-front|card-back|flip-front|flip-back|flipcard/)) {
                                isUIPattern = true;
                                uiPatternType = 'flip-card';
                                break;
                            }
                            // Mobile/Desktop patterns
                            if (combined.match(/mobile-only|desktop-only|d-none|d-md-none|d-lg-none|hidden-mobile|hidden-desktop|show-mobile|show-desktop/)) {
                                isUIPattern = true;
                                uiPatternType = 'responsive';
                                break;
                            }
                            // Navigation/Header/Footer patterns
                            if (element.tagName?.toLowerCase() === 'nav' || 
                                element.tagName?.toLowerCase() === 'header' || 
                                element.tagName?.toLowerCase() === 'footer') {
                                isUIPattern = true;
                                uiPatternType = 'navigation';
                                break;
                            }
                            element = element.parentElement;
                        }
                    }
                } catch(e) {}
                
                return {
                    href: href,
                    text: linkText,
                    isExternal: href?.startsWith('http') && !href?.includes('loan-israel.co.il'),
                    contextBefore: contextBefore,
                    contextAfter: contextAfter,
                    isUIPattern: isUIPattern,
                    uiPatternType: uiPatternType
                };
            }).filter(l => l.href && l.href.startsWith('http'));
            
            // Images
            const images = Array.from(body.querySelectorAll('img'));
            const imagesWithAlt = images.filter(img => img.alt && img.alt.trim().length > 0);
            
            // Bold/Strong text - collect with context for spam detection (5 words before/after)
            const boldElements = body.querySelectorAll('strong, b');
            const boldItems = Array.from(boldElements).map(el => {
                const boldText = el.innerText.trim();
                const parent = el.parentElement;
                let contextBefore = '';
                let contextAfter = '';
                let parentTag = parent?.tagName?.toLowerCase() || '';
                
                try {
                    if (parent) {
                        const parentText = parent.innerText;
                        const boldIndex = parentText.indexOf(boldText);
                        
                        // Get 5 words before
                        if (boldIndex > 0) {
                            const textBefore = parentText.substring(0, boldIndex).trim();
                            const wordsBefore = textBefore.split(/\s+/).filter(w => w.length > 0);
                            contextBefore = wordsBefore.slice(-5).join(' ');
                        }
                        
                        // Get 5 words after
                        const afterIndex = boldIndex + boldText.length;
                        if (afterIndex < parentText.length) {
                            const textAfter = parentText.substring(afterIndex).trim();
                            const wordsAfter = textAfter.split(/\s+/).filter(w => w.length > 0);
                            contextAfter = wordsAfter.slice(0, 5).join(' ');
                        }
                    }
                } catch(e) {}
                
                // Count words in bold text
                const boldWordCount = boldText.split(/\s+/).filter(w => w.length > 0).length;
                
                return {
                    text: boldText,
                    wordCount: boldWordCount,
                    contextBefore,
                    contextAfter,
                    parentTag,
                    isSingleWord: boldWordCount === 1
                };
            });
            
            // Calculate bold percentage
            const totalBoldChars = boldItems.reduce((sum, b) => sum + b.text.length, 0);
            const boldPercentage = text.length > 0 ? (totalBoldChars / text.length * 100) : 0;
            
            // Paragraphs
            const paragraphs = body.querySelectorAll('p');
            
            return {
                text,
                content: htmlContent,  // Full HTML for KeywordDensityAnalyzer
                wordCount: words.length,
                charCount: text.length,
                headings: { h1s, h2s, h3s, h4s },
                headingCount: {
                    h1: h1s.length,
                    h2: h2s.length,
                    h3: h3s.length,
                    h4: h4s.length
                },
                links: {
                    total: links.length,
                    internal: internalLinks.length,
                    external: externalLinks.length,
                    urls: allLinkUrls
                },
                images: {
                    total: images.length,
                    withAlt: imagesWithAlt.length
                },
                boldCount: boldElements.length,
                boldItems: boldItems,
                boldPercentage: boldPercentage.toFixed(2),
                paragraphCount: paragraphs.length,
                schema: extractSchemaData(doc)
            };
        }
        
        function extractSchemaData(doc) {
            const schemas = [];
            const issues = [];
            
            // Find all JSON-LD scripts
            const scriptTags = doc.querySelectorAll('script[type="application/ld+json"]');
            
            if (scriptTags.length === 0) {
                return { exists: false, schemas: [], issues: ['❌ לא נמצא Schema (JSON-LD)'] };
            }
            
            scriptTags.forEach((script, idx) => {
                try {
                    const data = JSON.parse(script.textContent);
                    const schemaInfo = analyzeSchemaObject(data, issues);
                    schemas.push(schemaInfo);
                } catch (e) {
                    issues.push(`❌ Schema #${idx + 1}: JSON לא תקין - ${e.message}`);
                }
            });
            
            // Extract FAQ questions from content for comparison
            const faqQuestions = [];
            doc.querySelectorAll('h2, h3, h4, .faq-question, [class*="question"], details summary').forEach(el => {
                const text = el.innerText.trim();
                if (text.endsWith('?') || text.includes('?')) {
                    faqQuestions.push(text);
                }
            });
            
            return {
                exists: true,
                count: scriptTags.length,
                schemas: schemas,
                issues: issues,
                contentQuestions: faqQuestions
            };
        }
        
        function analyzeSchemaObject(data, issues) {
            const result = {
                type: data['@type'] || 'Unknown',
                raw: data
            };
            
            // Handle @graph structure
            if (data['@graph']) {
                result.type = 'Graph';
                result.items = data['@graph'].map(item => analyzeSchemaItem(item, issues));
                return result;
            }
            
            // Single schema
            return analyzeSchemaItem(data, issues);
        }
        
        function analyzeSchemaItem(item, issues) {
            const type = item['@type'] || 'Unknown';
            const result = { type, details: {} };
            
            // Person validation
            if (type === 'Person') {
                const name = item.name || '';
                const jobTitle = item.jobTitle || '';
                
                result.details.name = name;
                result.details.jobTitle = jobTitle;
                
                if (name && name !== 'אייל עובדיה') {
                    issues.push(`⚠️ Person.name: "${name}" - צריך להיות "אייל עובדיה"`);
                }
                if (jobTitle && !jobTitle.includes('המנהל המקצועי') && !jobTitle.includes('היועץ הראשי')) {
                    issues.push(`⚠️ Person.jobTitle: "${jobTitle}" - צריך להיות "המנהל המקצועי והיועץ הראשי"`);
                }
            }
            
            // Organization validation
            if (type === 'Organization') {
                const name = item.name || '';
                const url = item.url || '';
                
                result.details.name = name;
                result.details.url = url;
                
                const validNames = ['רק תבקש', 'אפטריו', 'אפטריו בע"מ', 'Rak Tevakesh'];
                if (name && !validNames.some(v => name.includes(v))) {
                    issues.push(`⚠️ Organization.name: "${name}" - צריך להיות "רק תבקש" או "אפטריו בע"מ"`);
                }
                if (url && !url.includes('loan-israel.co.il')) {
                    issues.push(`⚠️ Organization.url: "${url}" - צריך להיות "https://loan-israel.co.il"`);
                }
            }
            
            // FAQPage validation
            if (type === 'FAQPage') {
                const mainEntity = item.mainEntity || [];
                result.details.questionCount = Array.isArray(mainEntity) ? mainEntity.length : 0;
                result.details.questions = [];
                
                if (Array.isArray(mainEntity)) {
                    mainEntity.forEach(qa => {
                        if (qa['@type'] === 'Question') {
                            result.details.questions.push({
                                question: qa.name || '',
                                answer: qa.acceptedAnswer?.text?.substring(0, 100) || ''
                            });
                        }
                    });
                }
            }
            
            // Article validation
            if (type === 'Article' || type === 'NewsArticle' || type === 'BlogPosting') {
                result.details.headline = item.headline || '';
                result.details.author = item.author?.name || item.author || '';
                result.details.datePublished = item.datePublished || '';
                result.details.dateModified = item.dateModified || '';
            }
            
            return result;
        }
        
        function analyzeKeywordDensity(text, headings, keyword) {
            const lowerText = text.toLowerCase();
            const lowerKeyword = keyword.toLowerCase();
            
            // Count keyword occurrences (including Hebrew variations)
            const keywordVariations = getHebrewVariations(lowerKeyword);
            let totalCount = 0;
            let variationCounts = {};
            
            keywordVariations.forEach(variation => {
                const regex = new RegExp(variation, 'gi');
                const matches = lowerText.match(regex);
                const count = matches ? matches.length : 0;
                variationCounts[variation] = count;
                totalCount += count;
            });
            
            // Word count
            const words = text.split(/\s+/).filter(w => w.length > 0);
            const wordCount = words.length;
            
            // Density percentage
            const density = wordCount > 0 ? ((totalCount / wordCount) * 100).toFixed(2) : 0;
            
            // Keyword in headings
            const allHeadings = [...headings.h1s, ...headings.h2s, ...headings.h3s, ...headings.h4s];
            const h2Count = headings.h2s.length;
            let keywordInH2 = 0;
            
            headings.h2s.forEach(h => {
                const lowerH = h.toLowerCase();
                if (keywordVariations.some(v => lowerH.includes(v))) {
                    keywordInH2++;
                }
            });
            
            const h2KeywordPercent = h2Count > 0 ? ((keywordInH2 / h2Count) * 100).toFixed(0) : 0;
            
            // Check if keyword in H1
            const keywordInH1 = headings.h1s.some(h => 
                keywordVariations.some(v => h.toLowerCase().includes(v))
            );
            
            return {
                keyword,
                totalCount,
                variationCounts,
                wordCount,
                density,
                keywordInH1,
                keywordInH2,
                h2Count,
                h2KeywordPercent
            };
        }
        
        function getHebrewVariations(keyword) {
            // Add common Hebrew prefixes and variations
            const variations = [keyword];
            const prefixes = ['ה', 'ב', 'ל', 'מ', 'ו', 'כ', 'ש'];
            
            // Add prefix variations
            prefixes.forEach(p => {
                variations.push(p + keyword);
            });
            
            // Common word variations for loans
            if (keyword.includes('הלוואה')) {
                variations.push('הלוואות', 'ההלוואה', 'ההלוואות', 'להלוואה', 'בהלוואה');
            }
            if (keyword.includes('מיידית')) {
                variations.push('מיידי', 'המיידית', 'מייד', 'מיידיות');
            }
            
            return [...new Set(variations)];
        }
        
        // Helper function to create expandable section
        function createExpandableSection(options) {
            const {
                id,
                icon,
                title,
                summaryBadges = [],  // Array of { text, status: 'good'|'warning'|'bad'|'neutral' }
                actionButton = null, // { text, onclick }
                content,
                open = false
            } = options;
            
            const badgesHtml = summaryBadges.map(b => 
                `<span class="seo-summary-badge ${b.status}">${b.text}</span>`
            ).join('');
            
            const actionHtml = actionButton ? 
                `<button class="seo-action-btn" onclick="${actionButton.onclick}">${actionButton.text}</button>` : '';
            
            return `
                <details class="seo-expandable-section" ${open ? 'open' : ''}>
                    <summary class="seo-section-header">
                        <span class="seo-section-icon">${icon}</span>
                        <span class="seo-section-title">${title}</span>
                        <div class="seo-section-summary">${badgesHtml}</div>
                        <div class="seo-section-actions">${actionHtml}</div>
                        <span class="seo-section-arrow">▼</span>
                    </summary>
                    <div class="seo-section-content">
                        ${content}
                    </div>
                </details>
            `;
        }
        
        function generateSeoReportHtml(oldA, newA, keyword) {
            // Get metadata from uploadState
            const backupMeta = uploadState.backupMeta || {};
            const pageInfo = uploadState.pageInfo || {};
            
            const title = backupMeta.title || '';
            const description = backupMeta.description || '';
            const slug = backupMeta.slug || '';
            
            // Check keyword in metadata
            const keywordVariations = getHebrewVariations(keyword.toLowerCase());
            const keywordInTitle = keywordVariations.some(v => title.toLowerCase().includes(v));
            const keywordInDesc = keywordVariations.some(v => description.toLowerCase().includes(v));
            const keywordInSlug = keywordVariations.some(v => decodeURIComponent(slug).toLowerCase().includes(v.replace(/\s/g, '-')));
            
            // Build sections
            let html = '';
            
            // Keyword Header
            html += `
                <div style="background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); padding: 0.75rem 1rem; border-radius: 8px; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.75rem;">
                    <span style="font-size: 1.3rem;">🔑</span>
                    <span style="font-size: 1.1rem; font-weight: 600; color: white;">מילת מפתח: ${keyword}</span>
                    <button onclick="refreshNewContentPreview()" style="margin-right: auto; background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.4rem 0.75rem; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">🔄 רענן</button>
                </div>
            `;
            
            // 1. META SECTION (Title & Description)
            html += generateMetaSection(title, description, slug, keywordInTitle, keywordInDesc, keywordInSlug);
            
            // 2. KEYWORDS SECTION
            html += generateKeywordsSection(oldA, newA, keyword);
            
            // 3. HEADINGS SECTION
            html += generateHeadingsSection(oldA, newA, keyword);
            
            // 4. LINKS SECTION
            html += newA.available ? generateLinksSection(newA) : '';
            
            // 5. BOLD SPAM SECTION
            html += newA.available ? generateBoldSection(newA, keyword) : '';
            
            // 6. SCHEMA SECTION
            html += newA.available ? generateSchemaSection(newA) : '';
            
            // 7. OPPORTUNITIES SECTION
            html += generateOpportunitiesSection(newA, keyword, pageInfo);
            
            // 8. BROKEN LINKS CHECK
            html += createExpandableSection({
                id: 'broken-links',
                icon: '🔗',
                title: 'בדיקת קישורים שבורים',
                summaryBadges: [{ text: 'לחץ לבדיקה', status: 'neutral' }],
                content: `
                    <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.75rem;">
                        בדיקה זו מוצאת קישורים שמחזירים שגיאות 404, 403 או אחרות
                    </p>
                    <button class="btn btn-small" id="checkLinksBtn" onclick="checkBrokenLinksInReport()">
                        🔗 בדוק קישורים שבורים
                    </button>
                    <div id="brokenLinksResults" style="margin-top: 0.75rem;"></div>
                `
            });
            
            return html;
        }
        
        // META SECTION
        function generateMetaSection(title, description, slug, keywordInTitle, keywordInDesc, keywordInSlug) {
            const titleStatus = title.length <= 60 ? 'good' : title.length <= 70 ? 'warning' : 'bad';
            const descStatus = description.length <= 160 ? 'good' : description.length <= 180 ? 'warning' : 'bad';
            
            const badges = [
                { text: `Title: ${title.length}/60`, status: titleStatus },
                { text: `Desc: ${description.length}/160`, status: descStatus }
            ];
            
            if (!keywordInTitle) badges.push({ text: '❌ מילה חסרה ב-Title', status: 'bad' });
            if (!keywordInDesc) badges.push({ text: '❌ מילה חסרה ב-Desc', status: 'bad' });
            
            const content = `
                <div class="seo-metric-row">
                    <span class="seo-metric-label">Title:</span>
                    <span class="seo-metric-value" title="${title}">${title || '(לא נשלף)'}</span>
                    <span class="seo-metric-status" style="background: ${titleStatus === 'good' ? 'rgba(16,185,129,0.2)' : titleStatus === 'warning' ? 'rgba(245,158,11,0.2)' : 'rgba(239,68,68,0.2)'}; color: ${titleStatus === 'good' ? '#10b981' : titleStatus === 'warning' ? '#f59e0b' : '#ef4444'};">
                        ${title.length}/60
                    </span>
                </div>
                <div class="seo-metric-row">
                    <span class="seo-metric-label">Description:</span>
                    <span class="seo-metric-value" title="${description}">${description ? description.substring(0, 100) + (description.length > 100 ? '...' : '') : '(לא נשלף)'}</span>
                    <span class="seo-metric-status" style="background: ${descStatus === 'good' ? 'rgba(16,185,129,0.2)' : descStatus === 'warning' ? 'rgba(245,158,11,0.2)' : 'rgba(239,68,68,0.2)'}; color: ${descStatus === 'good' ? '#10b981' : descStatus === 'warning' ? '#f59e0b' : '#ef4444'};">
                        ${description.length}/160
                    </span>
                </div>
                <div class="seo-metric-row">
                    <span class="seo-metric-label">Slug:</span>
                    <span class="seo-metric-value">${slug || '(לא נשלף)'}</span>
                </div>
                <div style="margin-top: 0.5rem; display: flex; flex-wrap: wrap; gap: 0.5rem;">
                    <span class="seo-summary-badge ${keywordInTitle ? 'good' : 'bad'}">${keywordInTitle ? '✅' : '❌'} מילת מפתח ב-Title</span>
                    <span class="seo-summary-badge ${keywordInDesc ? 'good' : 'bad'}">${keywordInDesc ? '✅' : '❌'} מילת מפתח ב-Description</span>
                    <span class="seo-summary-badge ${keywordInSlug ? 'good' : 'warning'}">${keywordInSlug ? '✅' : '⚠️'} מילת מפתח ב-Slug</span>
                </div>
            `;
            
            return createExpandableSection({
                id: 'meta',
                icon: '📝',
                title: 'מטא-תגיות',
                summaryBadges: badges,
                open: true,
                content: content
            });
        }
        
        // KEYWORDS SECTION - Enhanced with KeywordDensityAnalyzer module
        function generateKeywordsSection(oldA, newA, keyword) {
            // Use advanced analyzer if content is available
            let advancedAnalysis = null;
            let oldAdvancedAnalysis = null;
            
            // Get metadata from uploadState (from JSON/WordPress)
            const backupMeta = uploadState.backupMeta || {};
            const pageInfo = uploadState.pageInfo || {};
            
            // Get values from input fields (what user is about to upload)
            const inputTitle = document.getElementById('uploadTitle')?.value || '';
            const inputDesc = document.getElementById('uploadDescription')?.value || '';
            
            // New content uses input field values first, then page_info.json
            const newMeta = {
                title: inputTitle || pageInfo.new_title || pageInfo.title || '',
                description: inputDesc || pageInfo.new_description || pageInfo.description || ''
            };
            
            // Old content uses backup metadata from WordPress
            const oldMeta = {
                title: backupMeta.title || '',
                description: backupMeta.description || ''
            };
            
            const kdExists = typeof KeywordDensityAnalyzer !== 'undefined';
            console.log('🔍 Analyzer Debug:', {
                kdExists,
                keyword,
                newAvailable: newA.available,
                newContentLength: newA.content?.length || 0,
                oldAvailable: oldA.available,
                oldContentLength: oldA.content?.length || 0,
                newMeta,
                oldMeta
            });
            
            if (kdExists) {
                try {
                    if (newA.available && newA.content && newA.content.length > 100) {
                        console.log('✅ Running KeywordDensityAnalyzer on new content...');
                        console.log('📝 New Meta - Title:', newMeta.title?.substring(0, 50), 'Desc:', newMeta.description?.substring(0, 50));
                        const analyzer = new KeywordDensityAnalyzer(newA.content, keyword, {
                            externalTitle: newMeta.title,
                            externalDescription: newMeta.description
                        });
                        advancedAnalysis = analyzer.analyze();
                        console.log('✅ Advanced analysis result:', advancedAnalysis);
                    } else {
                        console.warn('⚠️ No new content available for analysis:', {
                            available: newA.available,
                            hasContent: !!newA.content,
                            contentLength: newA.content?.length || 0
                        });
                    }
                    if (oldA.available && oldA.content && oldA.content.length > 100) {
                        console.log('📝 Old Meta - Title:', oldMeta.title?.substring(0, 50), 'Desc:', oldMeta.description?.substring(0, 50));
                        const oldAnalyzer = new KeywordDensityAnalyzer(oldA.content, keyword, {
                            externalTitle: oldMeta.title,
                            externalDescription: oldMeta.description
                        });
                        oldAdvancedAnalysis = oldAnalyzer.analyze();
                    }
                } catch (e) {
                    console.error('❌ KeywordDensityAnalyzer error:', e);
                }
            }
            
            // Fallback to simple density calculation
            function calcDensity(analysis) {
                if (!analysis.available || !analysis.wordCount || analysis.wordCount === 0) return '0';
                if (!keyword || !analysis.content) return '0';
                const contentLower = (analysis.content || '').toLowerCase();
                const keywordLower = keyword.toLowerCase();
                const occurrences = contentLower.split(keywordLower).length - 1;
                const density = (occurrences / analysis.wordCount) * 100;
                return isNaN(density) ? '0' : density.toFixed(2);
            }
            
            // Use advanced analysis if available
            const newDensity = advancedAnalysis ? advancedAnalysis.weightedDensity.toFixed(2) : calcDensity(newA);
            const oldDensity = oldAdvancedAnalysis ? oldAdvancedAnalysis.weightedDensity.toFixed(2) : calcDensity(oldA);
            
            const newDensityNum = parseFloat(newDensity) || 0;
            const oldDensityNum = parseFloat(oldDensity) || 0;
            
            const densityStatus = newDensityNum < 1 ? 'warning' : newDensityNum <= 3 ? 'good' : newDensityNum <= 4 ? 'warning' : 'bad';
            const change = (newDensityNum - oldDensityNum).toFixed(2);
            const changeNum = parseFloat(change) || 0;
            
            const badges = [
                { text: `צפיפות: ${newDensity}%`, status: densityStatus }
            ];
            
            // Add algorithm indicator badge - IMPORTANT: Shows which algorithm is active
            if (advancedAnalysis) {
                badges.push({ text: '🚀 אלגוריתם מתקדם', status: 'good' });
                const scoreStatus = advancedAnalysis.score >= 80 ? 'good' : advancedAnalysis.score >= 60 ? 'warning' : 'bad';
                badges.push({ text: `ציון: ${advancedAnalysis.score}`, status: scoreStatus });
            } else {
                badges.push({ text: '⚠️ אלגוריתם בסיסי', status: 'warning' });
            }
            
            if (oldA.available && changeNum !== 0) {
                badges.push({ text: `${changeNum > 0 ? '↑' : '↓'} ${Math.abs(changeNum)}%`, status: changeNum < 0 ? 'good' : 'warning' });
            }
            
            // Generate content based on whether advanced analysis is available
            // Add algorithm indicator at the top
            const algorithmIndicator = advancedAnalysis 
                ? `<div style="background: linear-gradient(135deg, rgba(16,185,129,0.2), rgba(5,150,105,0.2)); border: 1px solid #10b981; border-radius: 8px; padding: 0.5rem 0.75rem; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 1.2rem;">🚀</span>
                    <div>
                        <div style="font-weight: 600; color: #10b981; font-size: 0.85rem;">אלגוריתם מתקדם פעיל</div>
                        <div style="font-size: 0.75rem; color: #6ee7b7;">צפיפות משוקללת + ניתוח ספאם + זיהוי וריאציות עבריות</div>
                    </div>
                </div>`
                : `<div style="background: rgba(245,158,11,0.15); border: 1px solid #f59e0b; border-radius: 8px; padding: 0.5rem 0.75rem; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 1.2rem;">⚠️</span>
                    <div>
                        <div style="font-weight: 600; color: #f59e0b; font-size: 0.85rem;">אלגוריתם בסיסי</div>
                        <div style="font-size: 0.75rem; color: #fcd34d;">מודול KeywordDensityAnalyzer לא זוהה - רענן את הדף</div>
                    </div>
                </div>`;
            
            let content = algorithmIndicator + `
                <div class="seo-comparison-mini">
                    <div>
                        <div style="font-weight: 500; margin-bottom: 0.25rem; color: #9ca3af;">📄 ישן</div>
                        <div class="old-value">צפיפות: ${oldDensity}% | מילים: ${oldA.wordCount || 0}</div>
                    </div>
                    <div>
                        <div style="font-weight: 500; margin-bottom: 0.25rem; color: #10b981;">✨ חדש</div>
                        <div class="new-value">צפיפות: ${newDensity}% | מילים: ${newA.wordCount || 0}</div>
                    </div>
                </div>
                <div style="margin-top: 0.75rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <span style="font-size: 0.85rem;">צפיפות מילת מפתח${advancedAnalysis ? ' (משוקללת)' : ''}:</span>
                        <div class="seo-progress-bar" style="flex: 1; max-width: 200px;">
                            <div class="fill ${densityStatus}" style="width: ${Math.min(newDensityNum * 20, 100)}%;"></div>
                        </div>
                        <span style="font-size: 0.9rem; font-weight: 500; color: ${densityStatus === 'good' ? '#10b981' : densityStatus === 'warning' ? '#f59e0b' : '#ef4444'};">
                            ${newDensity}%
                        </span>
                    </div>
                    <div style="font-size: 0.8rem; color: var(--text-secondary);">💡 טווח מומלץ: 1.5-2.5%${advancedAnalysis ? ' (משוקלל לפי אזורים)' : ''}</div>
                </div>
            `;
            
            // Add advanced analysis UI if available
            if (advancedAnalysis) {
                content += generateAdvancedDensityContent(advancedAnalysis, oldAdvancedAnalysis, keyword);
            }
            
            // Header Quality Scoring & Intro Analysis
            let headerQualityAnalysis = null;
            let introAnalysis = null;
            
            if (typeof HeaderQualityScorer !== 'undefined' && newA.available && newA.content) {
                try {
                    const headerScorer = new HeaderQualityScorer(newA.content, keyword);
                    headerQualityAnalysis = headerScorer.analyze();
                    console.log('✅ HeaderQualityScorer result:', headerQualityAnalysis);
                    
                    if (typeof IntroAnalyzer !== 'undefined') {
                        const introAnalyzerInstance = new IntroAnalyzer(newA.content, keyword, headerQualityAnalysis.global_metrics);
                        introAnalysis = introAnalyzerInstance.analyze();
                        console.log('✅ IntroAnalyzer result:', introAnalysis);
                    }
                } catch (e) {
                    console.error('❌ Header/Intro analysis error:', e);
                }
            }
            
            if (headerQualityAnalysis || introAnalysis) {
                content += generateHeaderQualityContent(headerQualityAnalysis, introAnalysis, keyword);
            }
            
            content += generateKeywordOccurrencesAnalysis(oldA, newA, keyword);
            
            return createExpandableSection({
                id: 'keywords',
                icon: '🔍',
                title: 'ניתוח מילות מפתח',
                summaryBadges: badges,
                content: content
            });
        }
        
        // Generate advanced density analysis content
        function generateAdvancedDensityContent(analysis, oldAnalysis, keyword) {
            const { breakdown, score, status, suggestions, totalOccurrences, totalWords, optimalRange } = analysis;
            
            let html = `
                <div class="kd-module" style="margin-top: 1rem;">
                    <div class="kd-summary-cards">
                        <div class="kd-card kd-score-card" style="border-color: ${status.color}">
                            <div class="kd-card-icon">${status.icon}</div>
                            <div class="kd-card-value" style="color: ${status.color}">${score}</div>
                            <div class="kd-card-label">ציון כללי</div>
                        </div>
                        <div class="kd-card">
                            <div class="kd-card-icon">🔢</div>
                            <div class="kd-card-value">${totalOccurrences}</div>
                            <div class="kd-card-label">מופעים</div>
                        </div>
                        <div class="kd-card kd-status-card" style="background: ${status.color}20; border-color: ${status.color}">
                            <div class="kd-card-value" style="color: ${status.color}; font-size: 1rem;">${status.label}</div>
                            <div class="kd-card-label">סטטוס</div>
                        </div>
                    </div>
                    
                    <div class="kd-zones">
                        <h4>📍 פילוח לפי אזורים</h4>
                        
                        <!-- Title Zone with old vs new -->
                        <div class="kd-zone-row" style="flex-direction: column; align-items: stretch;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <span class="kd-zone-label">🏷️ כותרת עמוד</span>
                                <span class="kd-zone-status ${breakdown.title?.found ? 'found' : 'missing'}">
                                    ${breakdown.title?.found ? '✅ נמצא' : '❌ חסר'}
                                </span>
                                ${!breakdown.title?.found && breakdown.title?.text ? 
                                    `<button class="kd-fix-btn" onclick="fixKeywordIssue('missingTitle', {keyword: '${keyword.replace(/'/g, "\\'")}', currentTitle: '${(breakdown.title.text || '').replace(/'/g, "\\'")}'})">🔧 תקן</button>` : ''
                                }
                            </div>
                            ${breakdown.title?.text ? `
                            <div style="background: rgba(16,185,129,0.1); border-radius: 4px; padding: 0.5rem; font-size: 0.8rem;">
                                <div style="color: #10b981; font-weight: 500;">✨ חדש:</div>
                                <div style="color: var(--text-primary); direction: rtl;">${breakdown.title.text || 'לא הוגדר'}</div>
                            </div>` : ''}
                            ${oldAnalysis?.breakdown?.title?.text ? `
                            <div style="background: rgba(156,163,175,0.1); border-radius: 4px; padding: 0.5rem; font-size: 0.8rem; margin-top: 0.25rem;">
                                <div style="color: #9ca3af; font-weight: 500;">📄 ישן:</div>
                                <div style="color: var(--text-secondary); direction: rtl;">${oldAnalysis.breakdown.title.text || 'לא הוגדר'}</div>
                            </div>` : ''}
                        </div>
                        
                        <!-- Meta Description Zone with old vs new -->
                        <div class="kd-zone-row" style="flex-direction: column; align-items: stretch;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <span class="kd-zone-label">📝 תיאור מטא</span>
                                <span class="kd-zone-status ${breakdown.metaDescription?.found ? 'found' : 'missing'}">
                                    ${breakdown.metaDescription?.found ? '✅ נמצא' : '❌ חסר'}
                                </span>
                            </div>
                            ${breakdown.metaDescription?.text ? `
                            <div style="background: rgba(16,185,129,0.1); border-radius: 4px; padding: 0.5rem; font-size: 0.8rem;">
                                <div style="color: #10b981; font-weight: 500;">✨ חדש:</div>
                                <div style="color: var(--text-primary); direction: rtl;">${breakdown.metaDescription.text || 'לא הוגדר'}</div>
                            </div>` : ''}
                            ${oldAnalysis?.breakdown?.metaDescription?.text ? `
                            <div style="background: rgba(156,163,175,0.1); border-radius: 4px; padding: 0.5rem; font-size: 0.8rem; margin-top: 0.25rem;">
                                <div style="color: #9ca3af; font-weight: 500;">📄 ישן:</div>
                                <div style="color: var(--text-secondary); direction: rtl;">${oldAnalysis.breakdown.metaDescription.text || 'לא הוגדר'}</div>
                            </div>` : ''}
                        </div>
                        
                        <div class="kd-zone-row">
                            <span class="kd-zone-label">📌 H1</span>
                            <span class="kd-zone-count">${breakdown.h1?.foundCount || 0}/${breakdown.h1?.totalItems || 0}${oldAnalysis ? ` <span style="color:#9ca3af">(היה: ${oldAnalysis.breakdown?.h1?.foundCount || 0}/${oldAnalysis.breakdown?.h1?.totalItems || 0})</span>` : ''}</span>
                            <span class="kd-zone-status ${breakdown.h1?.foundCount > 0 ? 'found' : 'missing'}">
                                ${breakdown.h1?.foundCount > 0 ? '✅' : '❌'}
                            </span>
                        </div>
                        
                        <div class="kd-zone-row">
                            <span class="kd-zone-label">📌 H2</span>
                            <span class="kd-zone-count">${breakdown.h2?.foundCount || 0}/${breakdown.h2?.totalItems || 0}${oldAnalysis ? ` <span style="color:#9ca3af">(היה: ${oldAnalysis.breakdown?.h2?.foundCount || 0}/${oldAnalysis.breakdown?.h2?.totalItems || 0})</span>` : ''}</span>
                            <span class="kd-zone-status ${breakdown.h2?.foundCount > 0 ? 'found' : breakdown.h2?.totalItems > 0 ? 'missing' : 'neutral'}">
                                ${breakdown.h2?.foundCount > 0 ? '✅' : breakdown.h2?.totalItems > 0 ? '⚠️' : '-'}
                            </span>
                        </div>
                        
                        <div class="kd-zone-row">
                            <span class="kd-zone-label">📄 גוף התוכן</span>
                            <span class="kd-zone-count">${breakdown.body?.count || 0} מופעים${oldAnalysis ? ` <span style="color:#9ca3af">(היה: ${oldAnalysis.breakdown?.body?.count || 0})</span>` : ''}</span>
                            <div class="kd-density-bar">
                                <div class="kd-density-fill" style="width: ${Math.min((analysis.weightedDensity || 0) / 5 * 100, 100)}%; background: ${status.color}"></div>
                                <span class="kd-density-optimal" style="left: ${optimalRange[0] / 5 * 100}%; width: ${(optimalRange[1] - optimalRange[0]) / 5 * 100}%"></span>
                            </div>
                        </div>
                    </div>
            `;
            
            // Add suggestions if any
            if (suggestions && suggestions.length > 0) {
                html += `
                    <div class="kd-suggestions">
                        <h4>💡 הצעות לשיפור</h4>
                        ${suggestions.map(s => `
                            <div class="kd-suggestion kd-suggestion-${s.severity}">
                                <div class="kd-suggestion-icon">${s.severity === 'high' ? '🔴' : s.severity === 'medium' ? '🟡' : '🟢'}</div>
                                <div class="kd-suggestion-text">${s.message}</div>
                                <button class="kd-fix-btn" onclick="fixKeywordIssue('${s.type}', ${JSON.stringify({keyword, ...s}).replace(/"/g, '&quot;')})">
                                    🔧 תקן עם Claude
                                </button>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            html += `</div>`;
            
            // Add Spam Analysis if SpamAnalyzer is available - compare old vs new
            if (typeof SpamAnalyzer !== 'undefined') {
                try {
                    let newSpamResult = null;
                    let oldSpamResult = null;
                    
                    // Analyze new content
                    if (uploadState.newContent) {
                        const spamAnalyzer = new SpamAnalyzer(uploadState.newContent, keyword);
                        newSpamResult = spamAnalyzer.analyze();
                        newSpamResult.keyword = keyword;
                    }
                    
                    // Analyze old content
                    if (uploadState.backupContent) {
                        const oldSpamAnalyzer = new SpamAnalyzer(uploadState.backupContent, keyword);
                        oldSpamResult = oldSpamAnalyzer.analyze();
                        oldSpamResult.keyword = keyword;
                    }
                    
                    if (newSpamResult || oldSpamResult) {
                        html += generateSpamAnalysisContent(newSpamResult, oldSpamResult, keyword);
                    }
                } catch (e) {
                    console.warn('SpamAnalyzer error:', e);
                }
            }
            
            return html;
        }
        
        // Generate spam analysis content for the SEO report - with old vs new comparison
        function generateSpamAnalysisContent(newSpam, oldSpam, keyword) {
            // Helper to get change indicator
            function getChange(newVal, oldVal) {
                if (oldVal === undefined || oldVal === null) return '';
                const diff = newVal - oldVal;
                if (diff === 0) return '';
                const arrow = diff > 0 ? '↑' : '↓';
                const color = diff > 0 ? '#ef4444' : '#10b981'; // Higher risk = bad, lower = good
                return `<span style="color: ${color}; font-size: 0.75rem; margin-right: 0.25rem;">${arrow}${Math.abs(diff)}</span>`;
            }
            
            // Use new or old as primary
            const primary = newSpam || oldSpam;
            const { overall_spam_risk, risk_score, headers_analysis, emphasis_analysis } = primary;
            
            const riskColors = { 'Low': '#10b981', 'Medium': '#f59e0b', 'High': '#ef4444' };
            const riskColor = riskColors[overall_spam_risk] || '#6b7280';
            
            const oldRisk = oldSpam?.risk_score ?? null;
            const oldHeaders = oldSpam?.headers_analysis ?? null;
            const oldEmphasis = oldSpam?.emphasis_analysis ?? null;
            
            let html = `
                <div class="spam-module">
                    <div class="spam-header">
                        <h3>🛡️ ניתוח ספאם בכותרות והדגשות</h3>
                        <div class="spam-risk-badge" style="background: ${riskColor}20; color: ${riskColor}; border: 1px solid ${riskColor};">
                            ${overall_spam_risk === 'Low' ? '✅' : overall_spam_risk === 'Medium' ? '⚠️' : '🔴'} 
                            סיכון: ${overall_spam_risk === 'Low' ? 'נמוך' : overall_spam_risk === 'Medium' ? 'בינוני' : 'גבוה'}
                        </div>
                    </div>
                    
                    <!-- Old vs New Comparison Cards -->
                    <div class="seo-comparison-mini" style="margin-bottom: 1rem;">
                        <div style="flex: 1;">
                            <div style="font-weight: 500; margin-bottom: 0.25rem; color: #9ca3af;">📄 ישן</div>
                            <div class="old-value" style="font-size: 0.85rem;">
                                ${oldSpam ? `סיכון: ${oldSpam.risk_score}% | כותרות: ${oldSpam.headers_analysis.score} | הדגשות: ${oldSpam.emphasis_analysis.score}` : 'לא זמין'}
                            </div>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 500; margin-bottom: 0.25rem; color: #10b981;">✨ חדש</div>
                            <div class="new-value" style="font-size: 0.85rem;">
                                ${newSpam ? `סיכון: ${newSpam.risk_score}% | כותרות: ${newSpam.headers_analysis.score} | הדגשות: ${newSpam.emphasis_analysis.score}` : 'לא זמין'}
                            </div>
                        </div>
                    </div>
                    
                    <div class="spam-summary-cards">
                        <div class="spam-card" style="border-color: ${riskColor}">
                            <div class="spam-card-value" style="color: ${riskColor}">${risk_score}${getChange(risk_score, oldRisk)}</div>
                            <div class="spam-card-label">ציון סיכון</div>
                            <div class="spam-card-hint">0 = בטוח, 100 = ספאם</div>
                        </div>
                        <div class="spam-card" style="border-color: ${headers_analysis.status === 'good' ? '#10b981' : headers_analysis.status === 'warning' ? '#f59e0b' : '#ef4444'}">
                            <div class="spam-card-value">${headers_analysis.score}${oldHeaders ? getChange(100 - headers_analysis.score, 100 - oldHeaders.score) : ''}</div>
                            <div class="spam-card-label">ציון כותרות</div>
                        </div>
                        <div class="spam-card" style="border-color: ${emphasis_analysis.status === 'good' ? '#10b981' : emphasis_analysis.status === 'warning' ? '#f59e0b' : '#ef4444'}">
                            <div class="spam-card-value">${emphasis_analysis.score}${oldEmphasis ? getChange(100 - emphasis_analysis.score, 100 - oldEmphasis.score) : ''}</div>
                            <div class="spam-card-label">ציון הדגשות</div>
                        </div>
                    </div>
            `;
            
            // Headers Analysis Section with comparison
            html += `
                    <div class="spam-section">
                        <h4>📑 ניתוח כותרות</h4>
                        <div class="spam-metrics">
                            <div class="spam-metric">
                                <span class="spam-metric-label">סה"כ כותרות:</span>
                                <span class="spam-metric-value">${headers_analysis.metrics.totalHeaders}${oldHeaders ? ` <span style="color:#9ca3af">(היה: ${oldHeaders.metrics.totalHeaders})</span>` : ''}</span>
                            </div>
                            <div class="spam-metric">
                                <span class="spam-metric-label">יחס התאמה:</span>
                                <span class="spam-metric-value ${headers_analysis.metrics.exactMatchRatio > 0.6 ? 'bad' : 'good'}">
                                    ${Math.round(headers_analysis.metrics.exactMatchRatio * 100)}%${oldHeaders ? ` <span style="color:#9ca3af">(היה: ${Math.round(oldHeaders.metrics.exactMatchRatio * 100)}%)</span>` : ''}
                                </span>
                            </div>
                            <div class="spam-metric">
                                <span class="spam-metric-label">מתחילות במילת מפתח:</span>
                                <span class="spam-metric-value ${headers_analysis.metrics.startsWithKeywordRatio > 0.5 ? 'bad' : 'good'}">
                                    ${Math.round(headers_analysis.metrics.startsWithKeywordRatio * 100)}%${oldHeaders ? ` <span style="color:#9ca3af">(היה: ${Math.round(oldHeaders.metrics.startsWithKeywordRatio * 100)}%)</span>` : ''}
                                </span>
                            </div>
                        </div>
            `;
            
            // Header issues (only from new analysis)
            if (headers_analysis.issues && headers_analysis.issues.length > 0) {
                html += `<div class="spam-issues">`;
                headers_analysis.issues.forEach(issue => {
                    const escData = JSON.stringify({keyword, ...issue}).replace(/"/g, '&quot;');
                    html += `
                        <div class="spam-issue spam-issue-${issue.severity}">
                            <div class="spam-issue-icon">${issue.severity === 'high' ? '🔴' : '🟡'}</div>
                            <div class="spam-issue-content">
                                <div class="spam-issue-message">${issue.message}</div>
                                <div class="spam-issue-suggestion">${issue.suggestion}</div>
                            </div>
                            <button class="spam-fix-btn" onclick="fixSpamIssue('${issue.type}', ${escData})">🔧 תקן</button>
                        </div>
                    `;
                });
                html += `</div>`;
            }
            html += `</div>`;
            
            // Emphasis Analysis Section with comparison
            html += `
                    <div class="spam-section">
                        <h4>💪 ניתוח הדגשות</h4>
                        <div class="spam-metrics">
                            <div class="spam-metric">
                                <span class="spam-metric-label">מופעים:</span>
                                <span class="spam-metric-value">${emphasis_analysis.metrics.totalKeywords}${oldEmphasis ? ` <span style="color:#9ca3af">(היה: ${oldEmphasis.metrics.totalKeywords})</span>` : ''}</span>
                            </div>
                            <div class="spam-metric">
                                <span class="spam-metric-label">מודגשים:</span>
                                <span class="spam-metric-value">${emphasis_analysis.metrics.boldedKeywords}${oldEmphasis ? ` <span style="color:#9ca3af">(היה: ${oldEmphasis.metrics.boldedKeywords})</span>` : ''}</span>
                            </div>
                            <div class="spam-metric">
                                <span class="spam-metric-label">יחס הדגשה:</span>
                                <span class="spam-metric-value ${emphasis_analysis.metrics.boldRatio > 0.4 ? 'bad' : emphasis_analysis.metrics.boldRatio > 0.2 ? 'warning' : 'good'}">
                                    ${Math.round(emphasis_analysis.metrics.boldRatio * 100)}%${oldEmphasis ? ` <span style="color:#9ca3af">(היה: ${Math.round(oldEmphasis.metrics.boldRatio * 100)}%)</span>` : ''}
                                </span>
                            </div>
                            <div class="spam-metric">
                                <span class="spam-metric-label">מבודדות:</span>
                                <span class="spam-metric-value ${emphasis_analysis.metrics.isolatedBoldCount > 0 ? 'warning' : 'good'}">
                                    ${emphasis_analysis.metrics.isolatedBoldCount}${oldEmphasis ? ` <span style="color:#9ca3af">(היה: ${oldEmphasis.metrics.isolatedBoldCount})</span>` : ''}
                                </span>
                            </div>
                        </div>
                        
                        <div class="spam-context-quality">
                            <div class="spam-context-bar">
                                <div class="spam-context-fill" style="width: ${emphasis_analysis.contextQuality.score}%; background: ${emphasis_analysis.contextQuality.score > 70 ? '#10b981' : emphasis_analysis.contextQuality.score > 40 ? '#f59e0b' : '#ef4444'}"></div>
                            </div>
                            <div class="spam-context-label">איכות הקשר: ${emphasis_analysis.contextQuality.score}% - ${emphasis_analysis.contextQuality.explanation}</div>
                        </div>
            `;
            
            // Emphasis issues
            if (emphasis_analysis.issues && emphasis_analysis.issues.length > 0) {
                html += `<div class="spam-issues">`;
                emphasis_analysis.issues.forEach(issue => {
                    const escData = JSON.stringify({keyword, ...issue}).replace(/"/g, '&quot;');
                    html += `
                        <div class="spam-issue spam-issue-${issue.severity}">
                            <div class="spam-issue-icon">${issue.severity === 'high' ? '🔴' : '🟡'}</div>
                            <div class="spam-issue-content">
                                <div class="spam-issue-message">${issue.message}</div>
                                <div class="spam-issue-suggestion">${issue.suggestion}</div>
                            </div>
                            <button class="spam-fix-btn" onclick="fixSpamIssue('${issue.type}', ${escData})">🔧 תקן</button>
                        </div>
                    `;
                });
                html += `</div>`;
            }
            html += `</div></div>`;
            
            return html;
        }
        
        // HEADER QUALITY SCORING - Advanced per-header analysis
        function generateHeaderQualityContent(headerAnalysis, introAnalysis, keyword) {
            if (!headerAnalysis) return '';
            
            const { global_metrics, headers_analysis, summary } = headerAnalysis;
            
            // Score color helper
            function getScoreColor(score) {
                if (score >= 8) return '#10b981'; // green
                if (score >= 6) return '#f59e0b'; // yellow
                if (score >= 4) return '#fb923c'; // orange
                return '#ef4444'; // red
            }
            
            // Label translation
            function translateLabel(label) {
                const labels = {
                    'Excellent': 'מצוין',
                    'Good': 'טוב',
                    'Weak': 'חלש',
                    'Critical': 'קריטי'
                };
                return labels[label] || label;
            }
            
            let html = `
                <div class="header-quality-module" style="margin-top: 1rem; background: var(--bg-tertiary); border-radius: 8px; padding: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h4 style="margin: 0; color: var(--text-primary);">🎯 דירוג איכות כותרות</h4>
                        <div style="display: flex; gap: 0.5rem;">
                            <span style="background: ${getScoreColor(summary.average_score)}20; color: ${getScoreColor(summary.average_score)}; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem; font-weight: bold;">
                                ממוצע: ${summary.average_score}/10
                            </span>
                            ${summary.weak_headers > 0 ? `<span style="background: #f59e0b20; color: #f59e0b; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem;">
                                ${summary.weak_headers} חלשות
                            </span>` : ''}
                            ${summary.critical_headers > 0 ? `<span style="background: #ef444420; color: #ef4444; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem;">
                                ${summary.critical_headers} קריטיות
                            </span>` : ''}
                        </div>
                    </div>
                    
                    <!-- Global Metrics -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.75rem; margin-bottom: 1rem; background: rgba(0,0,0,0.2); padding: 0.75rem; border-radius: 6px;">
                        <div style="text-align: center;">
                            <div style="font-size: 1.25rem; font-weight: bold; color: var(--accent-primary);">${global_metrics.total_headers}</div>
                            <div style="font-size: 0.7rem; color: var(--text-secondary);">כותרות</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.25rem; font-weight: bold; color: var(--accent-primary);">${global_metrics.avg_words_per_section}</div>
                            <div style="font-size: 0.7rem; color: var(--text-secondary);">מילים/קטע</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.25rem; font-weight: bold; color: var(--accent-primary);">${global_metrics.keyword_ratio}%</div>
                            <div style="font-size: 0.7rem; color: var(--text-secondary);">עם מילת מפתח</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 0.9rem; font-weight: bold; color: ${global_metrics.structure_health === 'Healthy' ? '#10b981' : '#f59e0b'};">${global_metrics.structure_health === 'Healthy' ? 'בריא' : global_metrics.structure_health === 'Slightly Cluttered' ? 'צפוף מעט' : global_metrics.structure_health === 'Sparse' ? 'דליל' : global_metrics.structure_health}</div>
                            <div style="font-size: 0.7rem; color: var(--text-secondary);">מבנה</div>
                        </div>
                    </div>
                    
                    <!-- Per-Header Scores -->
                    <details style="margin-bottom: 0.5rem;">
                        <summary style="cursor: pointer; color: var(--accent-primary); font-weight: bold; font-size: 0.85rem; padding: 0.5rem 0;">
                            ▶ פירוט לפי כותרת (${headers_analysis.length})
                        </summary>
                        <div style="max-height: 400px; overflow-y: auto; padding: 0.5rem;">
            `;
            
            // Add each header
            headers_analysis.forEach((header, index) => {
                const scoreColor = getScoreColor(header.score);
                const hasIssues = header.issues && header.issues.length > 0;
                const hasSuggestion = header.suggestion !== null;
                
                html += `
                    <div style="background: rgba(255,255,255,0.03); border-radius: 6px; padding: 0.75rem; margin-bottom: 0.5rem; border-right: 3px solid ${scoreColor};">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 0.5rem;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                                    <span style="background: ${header.tag === 'H1' ? '#8b5cf6' : header.tag === 'H2' ? '#3b82f6' : '#6b7280'}; color: white; padding: 0.1rem 0.4rem; border-radius: 4px; font-size: 0.7rem; font-weight: bold;">${header.tag}</span>
                                    <span style="font-size: 0.85rem; color: var(--text-primary); direction: rtl;">${header.text.substring(0, 60)}${header.text.length > 60 ? '...' : ''}</span>
                                </div>
                                ${hasIssues ? `<div style="display: flex; flex-wrap: wrap; gap: 0.25rem; margin-top: 0.25rem;">
                                    ${header.issues.map(issue => `<span style="background: rgba(239,68,68,0.2); color: #fca5a5; padding: 0.1rem 0.4rem; border-radius: 4px; font-size: 0.65rem;">${issue}</span>`).join('')}
                                </div>` : ''}
                            </div>
                            <div style="display: flex; flex-direction: column; align-items: center; min-width: 50px;">
                                <div style="width: 36px; height: 36px; border-radius: 50%; background: ${scoreColor}20; border: 2px solid ${scoreColor}; display: flex; align-items: center; justify-content: center; font-weight: bold; color: ${scoreColor};">${header.score}</div>
                                <div style="font-size: 0.6rem; color: var(--text-secondary); margin-top: 0.1rem;">${translateLabel(header.label)}</div>
                            </div>
                        </div>
                        ${hasSuggestion ? `
                            <div style="margin-top: 0.5rem; padding: 0.5rem; background: rgba(59,130,246,0.1); border-radius: 4px; border-right: 2px solid #3b82f6;">
                                <div style="font-size: 0.75rem; color: #93c5fd;">💡 ${header.suggestion.message}</div>
                                ${header.suggestion.example ? `<div style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 0.25rem;">לדוגמה: ${header.suggestion.example}</div>` : ''}
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            html += `
                        </div>
                    </details>
                </div>
            `;
            
            // Add Intro Analysis if available
            if (introAnalysis) {
                const verdictColors = {
                    'Strong Hook': '#10b981',
                    'Adequate': '#f59e0b',
                    'Weak': '#ef4444'
                };
                const verdictHebrew = {
                    'Strong Hook': 'פתיח חזק',
                    'Adequate': 'מספק',
                    'Weak': 'חלש'
                };
                const verdictColor = verdictColors[introAnalysis.verdict] || '#6b7280';
                
                html += `
                    <div class="intro-analysis-module" style="margin-top: 1rem; background: var(--bg-tertiary); border-radius: 8px; padding: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h4 style="margin: 0; color: var(--text-primary);">🎣 ניתוח פתיח (500 מילים ראשונות)</h4>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <span style="background: ${introAnalysis.page_type === 'Tool/Calculator' ? '#8b5cf620' : '#3b82f620'}; color: ${introAnalysis.page_type === 'Tool/Calculator' ? '#a78bfa' : '#60a5fa'}; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem;">
                                    ${introAnalysis.page_type === 'Tool/Calculator' ? '🔧 עמוד כלי' : '📄 מאמר'}
                                </span>
                                <span style="background: ${verdictColor}20; color: ${verdictColor}; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem; font-weight: bold;">
                                    ${introAnalysis.score}/100 - ${verdictHebrew[introAnalysis.verdict]}
                                </span>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; background: rgba(0,0,0,0.2); padding: 0.75rem; border-radius: 6px;">
                            <!-- TTFK -->
                            <div style="text-align: center; padding: 0.5rem; border-radius: 6px; background: ${introAnalysis.ttfk.rating === 'Excellent' ? 'rgba(16,185,129,0.1)' : introAnalysis.ttfk.rating === 'Good' ? 'rgba(245,158,11,0.1)' : 'rgba(239,68,68,0.1)'};">
                                <div style="font-size: 0.7rem; color: var(--text-secondary); margin-bottom: 0.25rem;">הופעה ראשונה של מילת מפתח</div>
                                <div style="font-size: 1.1rem; font-weight: bold; color: ${introAnalysis.ttfk.rating === 'Excellent' ? '#10b981' : introAnalysis.ttfk.rating === 'Good' ? '#f59e0b' : '#ef4444'};">
                                    ${introAnalysis.ttfk.wordIndex >= 0 ? `מילה #${introAnalysis.ttfk.wordIndex + 1}` : 'לא נמצא'}
                                </div>
                                <div style="font-size: 0.65rem; color: var(--text-secondary);">
                                    ${introAnalysis.ttfk.rating === 'Excellent' ? '✅ מצוין' : introAnalysis.ttfk.rating === 'Good' ? '👍 טוב' : introAnalysis.ttfk.rating === 'Adequate' ? '⚠️ מספק' : introAnalysis.ttfk.rating === 'Late' ? '⚠️ מאוחר' : '❌ חסר'}
                                </div>
                            </div>
                            
                            <!-- Local Density -->
                            <div style="text-align: center; padding: 0.5rem; border-radius: 6px; background: ${introAnalysis.local_density.status === 'optimal' ? 'rgba(16,185,129,0.1)' : 'rgba(245,158,11,0.1)'};">
                                <div style="font-size: 0.7rem; color: var(--text-secondary); margin-bottom: 0.25rem;">צפיפות מקומית</div>
                                <div style="font-size: 1.1rem; font-weight: bold; color: ${introAnalysis.local_density.status === 'optimal' ? '#10b981' : '#f59e0b'};">
                                    ${introAnalysis.local_density.density}
                                </div>
                                <div style="font-size: 0.65rem; color: var(--text-secondary);">
                                    יעד: ${introAnalysis.local_density.optimal_range} (${introAnalysis.local_density.occurrences} מופעים)
                                </div>
                            </div>
                            
                            <!-- Zone Info -->
                            <div style="text-align: center; padding: 0.5rem;">
                                <div style="font-size: 0.7rem; color: var(--text-secondary); margin-bottom: 0.25rem;">אזור בדיקה</div>
                                <div style="font-size: 0.9rem; font-weight: bold; color: var(--accent-primary);">
                                    ${introAnalysis.zone_word_count} מילים
                                </div>
                                <div style="font-size: 0.65rem; color: var(--text-secondary);">
                                    ${introAnalysis.zone_checked}
                                </div>
                            </div>
                        </div>
                        
                        ${introAnalysis.note ? `
                            <div style="margin-top: 0.75rem; padding: 0.5rem; background: rgba(139,92,246,0.1); border-radius: 4px; font-size: 0.75rem; color: #a78bfa;">
                                ℹ️ ${introAnalysis.note}
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            return html;
        }
        
        // HEADINGS SECTION
        function generateHeadingsSection(oldA, newA, keyword) {
            const newH = newA.headings || {};
            const h1Count = (newH.h1s || []).length;
            const h2Count = (newH.h2s || []).length;
            const h3Count = (newH.h3s || []).length;
            const total = h1Count + h2Count + h3Count + (newH.h4s || []).length + (newH.h5s || []).length + (newH.h6s || []).length;
            
            // Run HeaderQualityScorer to get per-header scores
            let headerScores = null;
            if (typeof HeaderQualityScorer !== 'undefined' && newA.available && newA.content) {
                try {
                    const scorer = new HeaderQualityScorer(newA.content, keyword);
                    headerScores = scorer.analyze();
                    console.log('📊 Header scores for detail view:', headerScores);
                } catch (e) {
                    console.error('HeaderQualityScorer error in headings section:', e);
                }
            }
            
            // Check hierarchy
            const hierarchyIssues = [];
            if (h1Count === 0) hierarchyIssues.push('חסר H1');
            if (h1Count > 1) hierarchyIssues.push('יותר מ-H1 אחד');
            
            const badges = [
                { text: `H1: ${h1Count}`, status: h1Count === 1 ? 'good' : 'bad' },
                { text: `H2: ${h2Count}`, status: h2Count > 0 ? 'good' : 'warning' },
                { text: `H3: ${h3Count}`, status: 'neutral' },
                { text: `סה"כ: ${total}`, status: 'neutral' }
            ];
            
            if (hierarchyIssues.length > 0) {
                badges.push({ text: `⚠️ ${hierarchyIssues[0]}`, status: 'bad' });
            }
            
            const content = generateHeadingsDetail(keyword, oldA, newA, headerScores);
            
            return createExpandableSection({
                id: 'headings',
                icon: '📑',
                title: 'מבנה כותרות',
                summaryBadges: badges,
                content: content
            });
        }
        
        // LINKS SECTION - Wrapper for existing function
        function generateLinksSection(analysis) {
            if (!analysis.links?.urls || analysis.links.urls.length === 0) {
                return createExpandableSection({
                    id: 'links',
                    icon: '🔗',
                    title: 'קישורים',
                    summaryBadges: [{ text: 'אין קישורים', status: 'neutral' }],
                    content: '<p>לא נמצאו קישורים בעמוד</p>'
                });
            }
            
            const urls = analysis.links.urls;
            const internalLinks = urls.filter(l => !l.isExternal);
            const externalLinks = urls.filter(l => l.isExternal);
            
            // Find duplicates
            const urlCounts = {};
            urls.forEach(link => {
                const normalizedUrl = link.href.replace(/\/$/, '').toLowerCase();
                if (!urlCounts[normalizedUrl]) urlCounts[normalizedUrl] = 0;
                urlCounts[normalizedUrl]++;
            });
            const duplicateCount = Object.values(urlCounts).filter(c => c > 1).length;
            
            const badges = [
                { text: `פנימיים: ${internalLinks.length}`, status: 'neutral' },
                { text: `חיצוניים: ${externalLinks.length}`, status: 'neutral' }
            ];
            
            if (duplicateCount > 0) {
                badges.push({ text: `⚠️ ${duplicateCount} כפולים`, status: 'bad' });
            }
            
            // Generate content using existing function but wrap it
            const linksContent = generateLinksAnalysisContent(analysis);
            
            return createExpandableSection({
                id: 'links',
                icon: '🔗',
                title: 'קישורים',
                summaryBadges: badges,
                content: linksContent
            });
        }
        
        // BOLD SECTION - Wrapper for existing function
        function generateBoldSection(analysis, keyword) {
            const boldContent = generateBoldSpamContent(analysis, keyword);
            const boldItems = analysis.boldItems || analysis.boldElements || [];
            const boldPercentage = parseFloat(analysis.boldPercentage) || 0;
            
            // Count suspicious using same logic as generateBoldSpamContent
            const keywordLower = keyword?.toLowerCase() || '';
            let suspiciousCount = 0;
            boldItems.forEach(bold => {
                const boldLower = (bold.text || '').toLowerCase();
                const wordCount = bold.wordCount || (bold.text || '').split(/\s+/).length;
                
                if (bold.isSingleWord && keywordLower) {
                    const keywordWords = keywordLower.split(/\s+/);
                    if (keywordWords.some(kw => kw.length > 2 && boldLower.includes(kw))) {
                        suspiciousCount++;
                        return;
                    }
                }
                if (wordCount <= 2 && (bold.text || '').length < 20) {
                    const patterns = ['הלוואה', 'מימון', 'אשראי', 'הלוואות', 'ריבית', 'בנק'];
                    if (patterns.some(p => boldLower.includes(p))) {
                        suspiciousCount++;
                        return;
                    }
                }
                if (keywordLower && (boldLower === keywordLower || boldLower.includes(keywordLower))) {
                    suspiciousCount++;
                }
            });
            
            const badges = [
                { text: `הדגשות: ${boldItems.length}`, status: 'neutral' }
            ];
            
            if (suspiciousCount > 0) {
                badges.push({ text: `⚠️ ${suspiciousCount} חשודות`, status: 'warning' });
            } else if (boldItems.length > 0) {
                badges.push({ text: '✅ תקין', status: 'good' });
            }
            
            if (boldPercentage > 5) {
                badges.push({ text: `⚠️ ${boldPercentage}% מודגש`, status: 'bad' });
            }
            
            return createExpandableSection({
                id: 'bold',
                icon: '🅱️',
                title: 'ניתוח הדגשות',
                summaryBadges: badges,
                content: boldContent
            });
        }
        
        // SCHEMA SECTION - Wrapper for existing function  
        function generateSchemaSection(analysis) {
            const schemaContent = generateSchemaAnalysisContent(analysis);
            const schema = analysis.schema;
            const hasSchema = schema && schema.exists && schema.count > 0;
            
            let badges;
            if (hasSchema) {
                const issueCount = schema.issues?.length || 0;
                badges = [{ text: `✅ ${schema.count} schemas`, status: 'good' }];
                if (issueCount > 0) {
                    badges.push({ text: `⚠️ ${issueCount} בעיות`, status: 'warning' });
                }
            } else {
                badges = [{ text: '❌ אין Schema', status: 'bad' }];
            }
            
            return createExpandableSection({
                id: 'schema',
                icon: '📋',
                title: 'Schema / JSON-LD',
                summaryBadges: badges,
                content: schemaContent
            });
        }
        
        // OPPORTUNITIES SECTION - New!
        function generateOpportunitiesSection(analysis, keyword, pageInfo) {
            const autocomplete = pageInfo.google_autocomplete || [];
            const relatedKw = pageInfo.related_keywords || [];
            const allKeywords = [...new Set([...autocomplete, ...relatedKw])];
            
            if (allKeywords.length === 0) {
                return createExpandableSection({
                    id: 'opportunities',
                    icon: '💡',
                    title: 'הזדמנויות מילות מפתח',
                    summaryBadges: [{ text: 'סרוק מתחרים קודם', status: 'neutral' }],
                    content: `
                        <p style="color: var(--text-secondary); margin-bottom: 0.75rem;">
                            לא נמצאו מילות מפתח קשורות. הפעל סריקת מתחרים כדי לקבל המלצות.
                        </p>
                        <button class="btn btn-small" onclick="toggleCompetitorReport()">🔍 סרוק מתחרים</button>
                    `
                });
            }
            
            const contentLower = (analysis.content || '').toLowerCase();
            const headings = analysis.headings || {};
            const h1Text = (headings.h1s || []).join(' ').toLowerCase();
            const h2Text = (headings.h2s || []).join(' ').toLowerCase();
            const h3Text = (headings.h3s || []).join(' ').toLowerCase();
            
            // Analyze each keyword
            const keywordAnalysis = allKeywords.map(kw => {
                const kwLower = kw.toLowerCase();
                const contentCount = (contentLower.split(kwLower).length - 1);
                const inH1 = h1Text.includes(kwLower);
                const inH2 = h2Text.includes(kwLower);
                const inH3 = h3Text.includes(kwLower);
                
                const locations = [];
                if (inH1) locations.push('H1');
                if (inH2) locations.push('H2');
                if (inH3) locations.push('H3');
                if (contentCount > 0 && !inH1 && !inH2 && !inH3) locations.push('תוכן');
                else if (contentCount > 0) locations.push('תוכן');
                
                return {
                    keyword: kw,
                    count: contentCount,
                    inH1, inH2, inH3,
                    locations,
                    isMissing: contentCount === 0
                };
            });
            
            const foundKw = keywordAnalysis.filter(k => !k.isMissing);
            const missingKw = keywordAnalysis.filter(k => k.isMissing);
            
            const badges = [
                { text: `נמצאו: ${foundKw.length}`, status: 'good' },
                { text: `חסרות: ${missingKw.length}`, status: missingKw.length > 0 ? 'warning' : 'good' }
            ];
            
            let itemsHtml = '';
            
            // Missing keywords first (these need action)
            if (missingKw.length > 0) {
                itemsHtml += `<div style="margin-bottom: 0.75rem; font-weight: 600; color: #f59e0b;">❌ מילות מפתח חסרות (${missingKw.length}):</div>`;
                missingKw.forEach((kwData, idx) => {
                    itemsHtml += `
                        <div class="seo-opportunity-item missing">
                            <input type="checkbox" id="opp-missing-${idx}" checked>
                            <label for="opp-missing-${idx}" style="flex: 1; cursor: pointer;">${kwData.keyword}</label>
                            <span class="seo-summary-badge bad">❌ לא נמצא</span>
                        </div>
                    `;
                });
                
                itemsHtml += `
                    <div style="margin: 1rem 0;">
                        <button class="btn btn-primary" onclick="generateKeywordPrompt()">
                            ✨ צור פרומפט לשילוב מילות מפתח
                        </button>
                    </div>
                `;
            }
            
            // Found keywords (informational)
            if (foundKw.length > 0) {
                itemsHtml += `<div style="margin-bottom: 0.5rem; margin-top: 1rem; font-weight: 600; color: #10b981;">✅ מילות מפתח שנמצאו (${foundKw.length}):</div>`;
                itemsHtml += `<div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.5rem;">מציג היכן כל מילה מופיעה ובאיזו תדירות</div>`;
                
                foundKw.forEach(kwData => {
                    const locationBadges = kwData.locations.map(loc => {
                        const color = loc === 'H1' ? '#f59e0b' : loc === 'H2' ? '#60a5fa' : loc === 'H3' ? '#a78bfa' : '#6b7280';
                        return `<span style="background: ${color}; color: #1a1a2e; padding: 1px 6px; border-radius: 3px; font-size: 0.7rem; font-weight: bold;">${loc}</span>`;
                    }).join(' ');
                    
                    itemsHtml += `
                        <div class="seo-opportunity-item found" style="justify-content: space-between;">
                            <span style="flex: 1;">${kwData.keyword}</span>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                ${locationBadges}
                                <span class="seo-summary-badge good" style="min-width: 50px; text-align: center;">${kwData.count}x</span>
                            </div>
                        </div>
                    `;
                });
            }
            
            if (missingKw.length === 0) {
                itemsHtml += `<div style="margin-top: 1rem; padding: 0.75rem; background: rgba(16,185,129,0.15); border-radius: 6px; color: #10b981;">
                    ✅ כל מילות המפתח הקשורות מופיעות בתוכן!
                </div>`;
            }
            
            return createExpandableSection({
                id: 'opportunities',
                icon: '💡',
                title: 'הזדמנויות מילות מפתח',
                summaryBadges: badges,
                content: itemsHtml
            });
        }
        
        // Helper to generate keyword integration prompt
        function generateKeywordPrompt() {
            const checkboxes = document.querySelectorAll('[id^="opp-kw-"]:checked:not(:disabled)');
            const keywords = Array.from(checkboxes).map(cb => cb.nextElementSibling.textContent.trim());
            
            if (keywords.length === 0) {
                showToast('בחר לפחות מילת מפתח אחת', 'warning');
                return;
            }
            
            const prompt = `שלב את מילות המפתח הבאות בתוכן העמוד בצורה טבעית:

מילות מפתח להוספה: ${keywords.join(', ')}

הנחיות:
1. הוסף שאלה חדשה לאזור ה-FAQ שמשלבת את המילים באופן טבעי
2. או הוסף פסקה קצרה שמשלבת את המילים
3. אל תשנה כותרות קיימות
4. שמור על הסגנון והטון של העמוד
5. וודא שהתוספת רלוונטית לנושא העמוד`;

            // Show prompt preview
            showPromptPreview(prompt, 'שילוב מילות מפתח');
        }
        
        // Content generator for links (used inside expandable section)
        function generateLinksAnalysisContent(analysis) {
            if (!analysis.links?.urls || analysis.links.urls.length === 0) {
                return '<p>לא נמצאו קישורים</p>';
            }
            
            const urls = analysis.links.urls;
            
            // Find duplicates
            const urlCounts = {};
            urls.forEach(link => {
                const normalizedUrl = link.href.replace(/\/$/, '').toLowerCase();
                if (!urlCounts[normalizedUrl]) {
                    urlCounts[normalizedUrl] = { count: 0, occurrences: [], original: link.href, uiPatternCount: 0 };
                }
                urlCounts[normalizedUrl].count++;
                if (link.isUIPattern) {
                    urlCounts[normalizedUrl].uiPatternCount++;
                }
                urlCounts[normalizedUrl].occurrences.push({
                    text: link.text || '',
                    contextBefore: link.contextBefore || '',
                    contextAfter: link.contextAfter || '',
                    isUIPattern: link.isUIPattern || false,
                    uiPatternType: link.uiPatternType || ''
                });
            });
            
            // Separate real duplicates from UI pattern duplicates
            const allDuplicates = Object.entries(urlCounts).filter(([url, data]) => data.count > 1);
            const realDuplicates = allDuplicates.filter(([url, data]) => {
                const nonUICount = data.count - data.uiPatternCount;
                return nonUICount > 1 || data.count > 2;
            });
            const uiPatternDuplicates = allDuplicates.filter(([url, data]) => {
                const nonUICount = data.count - data.uiPatternCount;
                return nonUICount <= 1 && data.count <= 2;
            });
            const duplicates = realDuplicates;
            
            // Separate internal and external
            const internalLinks = urls.filter(l => !l.isExternal);
            const externalLinks = urls.filter(l => l.isExternal);
            
            let html = `
                <div style="display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 0.75rem; font-size: 0.9rem;">
                    <span><strong>סה"כ:</strong> ${urls.length}</span>
                    <span><strong>פנימיים:</strong> ${internalLinks.length}</span>
                    <span><strong>חיצוניים:</strong> ${externalLinks.length}</span>
                    <span><strong>יחס:</strong> 
                        <span class="${getLinkRatioClass(urls.length, analysis.wordCount)}">
                            ${analysis.wordCount > 0 ? (urls.length / analysis.wordCount * 100).toFixed(2) : 0}%
                        </span>
                    </span>
                </div>
                <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.75rem;">
                    💡 יחס מומלץ: 1-3%
                </div>
            `;
            
            // Duplicates warning - real duplicates (problematic)
            if (duplicates.length > 0) {
                html += `
                    <div style="background: rgba(239, 68, 68, 0.2); border: 1px solid #ef4444; border-radius: 6px; padding: 0.75rem; margin-bottom: 1rem;">
                        <h6 style="color: #ef4444; margin: 0 0 0.5rem 0;">⚠️ נמצאו ${duplicates.length} קישורים כפולים בעייתיים!</h6>
                        ${duplicates.map(([url, data]) => `
                            <div style="background: rgba(0,0,0,0.2); border-radius: 4px; padding: 0.5rem; margin-bottom: 0.5rem;">
                                <div style="font-size: 0.75rem; direction: ltr; color: #f87171; margin-bottom: 0.5rem; word-break: break-all;">
                                    🔗 ${data.original} <span style="color: #fbbf24;">(${data.count}x)</span>
                                </div>
                                <div style="font-size: 0.8rem; color: #e5e7eb; margin-bottom: 4px;">הופעות בתוכן:</div>
                                <div style="display: flex; flex-direction: column; gap: 6px; margin-top: 4px;">
                                    ${data.occurrences.map((occ, idx) => `
                                        <div style="background: rgba(255,255,255,0.05); padding: 8px; border-radius: 4px; border-right: 3px solid ${occ.isUIPattern ? '#60a5fa' : '#ef4444'};">
                                            <div style="font-size: 0.75rem; color: #9ca3af; margin-bottom: 4px; direction: rtl;">
                                                ${occ.contextBefore ? `<span style="color: #6b7280;">...${occ.contextBefore}</span>` : ''}
                                                <span style="background: #fef08a; color: #1f2937; padding: 1px 4px; border-radius: 2px; font-weight: bold;">${occ.text || '(ללא טקסט)'}</span>
                                                ${occ.contextAfter ? `<span style="color: #6b7280;">${occ.contextAfter}...</span>` : ''}
                                                ${occ.isUIPattern ? `<span style="color: #60a5fa; margin-right: 8px; font-size: 0.65rem;">📱 ${occ.uiPatternType}</span>` : ''}
                                            </div>
                                            <button onclick="removeDuplicateLink('${encodeURIComponent(data.original)}', '${encodeURIComponent(occ.text || '')}', ${idx})" 
                                                    style="background: #ef4444; color: white; border: none; padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 0.75rem; margin-top: 4px;">
                                                🗑️ הסר קישור זה
                                            </button>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else if (uiPatternDuplicates.length === 0) {
                html += `<div style="color: #10b981; margin-bottom: 1rem;">✅ אין קישורים כפולים</div>`;
            } else {
                html += `<div style="color: #10b981; margin-bottom: 1rem;">✅ אין קישורים כפולים בעייתיים</div>`;
            }
            
            // UI Pattern duplicates (legitimate - flip cards, mobile/desktop)
            if (uiPatternDuplicates.length > 0) {
                html += `
                    <details style="margin-bottom: 1rem;">
                        <summary style="cursor: pointer; font-weight: bold; padding: 0.5rem; background: rgba(96, 165, 250, 0.1); border-radius: 4px; color: #60a5fa;">
                            ✅ ${uiPatternDuplicates.length} כפילויות לגיטימיות (UI patterns)
                        </summary>
                        <div style="background: rgba(96, 165, 250, 0.1); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 6px; padding: 0.75rem; margin-top: 0.5rem;">
                            <p style="font-size: 0.75rem; color: #9ca3af; margin: 0 0 0.5rem 0;">
                                📱 כפילויות מ-Flip Cards, אלמנטים responsive, או ניווט - לא בעייתיות ל-SEO
                            </p>
                            ${uiPatternDuplicates.map(([url, data]) => `
                                <div style="background: rgba(0,0,0,0.2); border-radius: 4px; padding: 8px; margin-bottom: 6px;">
                                    <div style="font-size: 0.7rem; direction: ltr; margin-bottom: 6px;">
                                        <span style="color: #60a5fa;">🔗 ${data.original}</span>
                                        <span style="color: #9ca3af;"> (${data.count}x - ${data.occurrences[0]?.uiPatternType || 'UI pattern'})</span>
                                    </div>
                                    <div style="display: flex; flex-direction: column; gap: 4px;">
                                        ${data.occurrences.map((occ, idx) => `
                                            <div style="display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.05); padding: 4px 8px; border-radius: 4px; border-right: 2px solid #60a5fa;">
                                                <div style="font-size: 0.7rem; color: #9ca3af; direction: rtl;">
                                                    ${occ.contextBefore ? `<span style="color: #6b7280;">...${occ.contextBefore} </span>` : ''}
                                                    <span style="background: #60a5fa; color: #1f2937; padding: 1px 3px; border-radius: 2px; font-weight: bold;">${occ.text || '(ללא טקסט)'}</span>
                                                    ${occ.contextAfter ? `<span style="color: #6b7280;"> ${occ.contextAfter}...</span>` : ''}
                                                    <span style="color: #60a5fa; margin-right: 6px; font-size: 0.6rem;">📱 ${occ.uiPatternType || 'UI'}</span>
                                                </div>
                                                <button onclick="removeDuplicateLink('${encodeURIComponent(data.original)}', '${encodeURIComponent(occ.text || '')}', ${idx})" 
                                                        style="background: #374151; color: white; border: none; padding: 2px 8px; border-radius: 4px; cursor: pointer; font-size: 0.65rem; flex-shrink: 0;">
                                                    🗑️ הסר
                                                </button>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </details>
                `; 
            }
            
            // Internal links list
            // Check which URLs are duplicates (only real duplicates, not UI patterns)
            const duplicateUrls = new Set(duplicates.map(([url]) => url));
            const uiPatternDuplicateUrls = new Set(uiPatternDuplicates.map(([url]) => url));
            
            // Internal links list with context and remove option
            html += `
                <details style="margin-bottom: 0.75rem;">
                    <summary style="cursor: pointer; font-weight: bold; padding: 0.5rem; background: rgba(96, 165, 250, 0.1); border-radius: 4px;">
                        🏠 קישורים פנימיים (${internalLinks.length})
                    </summary>
                    <div style="max-height: 300px; overflow-y: auto; margin-top: 0.5rem;">
                        ${internalLinks.map((l, idx) => {
                            const normalizedHref = l.href.replace(/\/$/, '').toLowerCase();
                            const isDuplicate = duplicateUrls.has(normalizedHref);
                            const isUIPatternDup = uiPatternDuplicateUrls.has(normalizedHref);
                            return `
                                <div style="background: ${isDuplicate ? 'rgba(239, 68, 68, 0.15)' : isUIPatternDup ? 'rgba(96, 165, 250, 0.1)' : 'rgba(255,255,255,0.03)'}; 
                                            border: 1px solid ${isDuplicate ? '#ef4444' : isUIPatternDup ? 'rgba(96, 165, 250, 0.3)' : 'rgba(255,255,255,0.1)'}; 
                                            border-radius: 6px; padding: 8px; margin-bottom: 6px;
                                            ${isDuplicate ? 'border-right: 3px solid #ef4444;' : isUIPatternDup ? 'border-right: 3px solid #60a5fa;' : ''}">
                                    <div style="font-size: 0.75rem; color: #9ca3af; direction: rtl; margin-bottom: 4px;">
                                        ${l.contextBefore ? `<span style="color: #6b7280;">...${l.contextBefore} </span>` : ''}
                                        <span style="background: #60a5fa; color: #1f2937; padding: 1px 4px; border-radius: 2px; font-weight: bold;">${l.text || '(ללא טקסט)'}</span>
                                        ${l.contextAfter ? `<span style="color: #6b7280;"> ${l.contextAfter}...</span>` : ''}
                                        ${isDuplicate ? '<span style="color: #ef4444; margin-right: 8px; font-weight: bold;">⚠️ כפול!</span>' : ''}
                                        ${isUIPatternDup ? `<span style="color: #60a5fa; margin-right: 8px; font-size: 0.65rem;">📱 ${l.uiPatternType || 'UI'}</span>` : ''}
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 4px;">
                                        <a href="${l.href}" target="_blank" style="font-size: 0.65rem; direction: ltr; color: #60a5fa; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; text-decoration: none;" title="לחץ לפתיחה בטאב חדש">🔗 ${l.href}</a>
                                        <button onclick="removeDuplicateLink('${encodeURIComponent(l.href)}', '${encodeURIComponent(l.text || '')}', ${idx})" 
                                                style="background: #374151; color: white; border: none; padding: 3px 10px; border-radius: 4px; cursor: pointer; font-size: 0.7rem;">
                                            🗑️ הסר
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </details>
            `;
            
            // External links list with context and remove option
            html += `
                <details>
                    <summary style="cursor: pointer; font-weight: bold; padding: 0.5rem; background: rgba(16, 185, 129, 0.1); border-radius: 4px;">
                        🌐 קישורים חיצוניים (${externalLinks.length})
                    </summary>
                    <div style="max-height: 300px; overflow-y: auto; margin-top: 0.5rem;">
                        ${externalLinks.map((l, idx) => {
                            const normalizedHref = l.href.replace(/\/$/, '').toLowerCase();
                            const isDuplicate = duplicateUrls.has(normalizedHref);
                            const isUIPatternDup = uiPatternDuplicateUrls.has(normalizedHref);
                            return `
                                <div style="background: ${isDuplicate ? 'rgba(239, 68, 68, 0.15)' : isUIPatternDup ? 'rgba(96, 165, 250, 0.1)' : 'rgba(255,255,255,0.03)'}; 
                                            border: 1px solid ${isDuplicate ? '#ef4444' : isUIPatternDup ? 'rgba(96, 165, 250, 0.3)' : 'rgba(255,255,255,0.1)'}; 
                                            border-radius: 6px; padding: 8px; margin-bottom: 6px;
                                            ${isDuplicate ? 'border-right: 3px solid #ef4444;' : isUIPatternDup ? 'border-right: 3px solid #60a5fa;' : ''}">
                                    <div style="font-size: 0.75rem; color: #9ca3af; direction: rtl; margin-bottom: 4px;">
                                        ${l.contextBefore ? `<span style="color: #6b7280;">...${l.contextBefore} </span>` : ''}
                                        <span style="background: #10b981; color: #1f2937; padding: 1px 4px; border-radius: 2px; font-weight: bold;">${l.text || '(ללא טקסט)'}</span>
                                        ${l.contextAfter ? `<span style="color: #6b7280;"> ${l.contextAfter}...</span>` : ''}
                                        ${isDuplicate ? '<span style="color: #ef4444; margin-right: 8px; font-weight: bold;">⚠️ כפול!</span>' : ''}
                                        ${isUIPatternDup ? `<span style="color: #60a5fa; margin-right: 8px; font-size: 0.65rem;">📱 ${l.uiPatternType || 'UI'}</span>` : ''}
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 4px;">
                                        <a href="${l.href}" target="_blank" style="font-size: 0.65rem; direction: ltr; color: #10b981; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; text-decoration: none;" title="לחץ לפתיחה בטאב חדש">🔗 ${l.href}</a>
                                        <button onclick="removeDuplicateLink('${encodeURIComponent(l.href)}', '${encodeURIComponent(l.text || '')}', ${idx})" 
                                                style="background: #374151; color: white; border: none; padding: 3px 10px; border-radius: 4px; cursor: pointer; font-size: 0.7rem;">
                                            🗑️ הסר
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </details>
            `;
            
            return html;
        }
        
        // Legacy wrapper for backward compatibility
        function generateLinksAnalysis(analysis) {
            return generateLinksSection(analysis);
        }
        
        async function removeDuplicateLink(encodedUrl, encodedText, index) {
            const url = decodeURIComponent(encodedUrl);
            const text = decodeURIComponent(encodedText);
            
            if (!confirm(`האם להסיר את הקישור עם האנקר "${text || '(ללא טקסט)'}"?\n\nURL: ${url}`)) {
                return;
            }
            
            try {
                const pageFolder = getPageFolder(selectedPage.path);
                showToast('מסיר קישור...', 'info');
                
                const response = await fetch('/api/page/remove-link', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        page_folder: pageFolder,
                        url: url,
                        anchor_text: text,
                        occurrence_index: index
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    showToast('✅ הקישור הוסר ונשמר בהצלחה', 'success');
                    // Refresh the comparison view
                    if (typeof refreshCompareView === 'function') {
                        await refreshCompareView();
                    }
                } else {
                    showToast('שגיאה: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error removing link:', error);
                showToast('שגיאה בהסרת הקישור', 'error');
            }
        }
        
        // Content generator for Schema (used inside expandable section)
        function generateSchemaAnalysisContent(analysis) {
            const schema = analysis.schema;
            
            if (!schema) {
                return '<p style="color: #9ca3af;">לא זמין</p>';
            }
            
            let html = '';
            
            if (!schema.exists) {
                html += `
                    <div style="background: rgba(239, 68, 68, 0.15); border-radius: 6px; padding: 0.75rem;">
                        <span style="color: #ef4444;">❌ לא נמצא Schema (JSON-LD)</span>
                        <p style="font-size: 0.85rem; color: #9ca3af; margin: 0.5rem 0 0 0;">
                            מומלץ להוסיף Schema מסוג FAQPage, Article, או Organization
                        </p>
                    </div>
                `;
                return html;
            }
            
            html += `<div style="color: #10b981; margin-bottom: 0.75rem;">✅ נמצאו ${schema.count} Schema blocks</div>`;
            
            if (schema.issues && schema.issues.length > 0) {
                const issuesJson = JSON.stringify(schema.issues);
                html += `
                    <div style="background: rgba(251, 191, 36, 0.15); border-radius: 6px; padding: 0.75rem; margin-bottom: 0.75rem;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                            <span style="color: #fbbf24; font-weight: 600;">⚠️ בעיות (${schema.issues.length})</span>
                            <button onclick='fixSchemaWithClaude(${issuesJson.replace(/'/g, "&#39;")})' class="seo-action-btn" style="background: linear-gradient(135deg, #8b5cf6, #6366f1); color: white; border: none;">
                                🔧 תקן
                            </button>
                        </div>
                        <ul style="margin: 0; padding-right: 1.2rem; font-size: 0.85rem;">
                            ${schema.issues.map(issue => `<li style="color: #fbbf24; margin-bottom: 0.25rem;">${issue}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            if (schema.schemas && schema.schemas.length > 0) {
                html += `<details><summary style="cursor: pointer; font-size: 0.85rem; color: var(--text-secondary);">📋 פרטי Schema</summary><div style="margin-top: 0.5rem;">`;
                schema.schemas.forEach(s => {
                    if (s.type === 'Graph' && s.items) {
                        s.items.forEach(item => { html += renderSchemaItem(item); });
                    } else {
                        html += renderSchemaItem(s);
                    }
                });
                html += `</div></details>`;
            }
            
            return html;
        }
        
        // Legacy function
        function generateSchemaAnalysis(analysis) {
            const schema = analysis.schema;
            
            if (!schema) {
                return '<div class="seo-section"><h5>📋 Schema / JSON-LD</h5><p style="color: #9ca3af;">לא זמין</p></div>';
            }
            
            let html = `
                <div class="seo-section" style="background: var(--bg-tertiary); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                    <h5>📋 Schema / JSON-LD</h5>
            `;
            
            if (!schema.exists) {
                html += `
                    <div style="background: rgba(239, 68, 68, 0.2); border: 1px solid #ef4444; border-radius: 6px; padding: 0.75rem;">
                        <span style="color: #ef4444;">❌ לא נמצא Schema (JSON-LD)</span>
                        <p style="font-size: 0.75rem; color: #9ca3af; margin: 0.5rem 0 0 0;">
                            מומלץ להוסיף Schema מסוג FAQPage, Article, או Organization
                        </p>
                    </div>
                `;
            } else {
                // Schema found
                html += `
                    <div style="color: #10b981; margin-bottom: 0.75rem;">
                        ✅ נמצאו ${schema.count} Schema blocks
                    </div>
                `;
                
                // Issues
                if (schema.issues && schema.issues.length > 0) {
                    const issuesJson = JSON.stringify(schema.issues);
                    html += `
                        <div style="background: rgba(251, 191, 36, 0.2); border: 1px solid #fbbf24; border-radius: 6px; padding: 0.75rem; margin-bottom: 0.75rem;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                                <h6 style="color: #fbbf24; margin: 0;">⚠️ בעיות שנמצאו (${schema.issues.length}):</h6>
                                <button onclick='fixSchemaWithClaude(${issuesJson.replace(/'/g, "&#39;")})' 
                                        style="background: linear-gradient(135deg, #8b5cf6, #6366f1); color: white; border: none; padding: 4px 12px; border-radius: 6px; cursor: pointer; font-size: 0.75rem; display: flex; align-items: center; gap: 4px;">
                                    🔧 תקן עם Claude
                                </button>
                            </div>
                            <ul style="margin: 0; padding-right: 1.2rem; font-size: 0.8rem;">
                                ${schema.issues.map(issue => `<li style="color: #fbbf24; margin-bottom: 0.25rem;">${issue}</li>`).join('')}
                            </ul>
                            <div style="margin-top: 0.75rem; padding-top: 0.5rem; border-top: 1px solid rgba(251, 191, 36, 0.3);">
                                <div style="font-size: 0.7rem; color: #9ca3af; margin-bottom: 0.5rem;">📋 פרטים נכונים לתיקון:</div>
                                <div style="font-size: 0.7rem; background: rgba(0,0,0,0.2); padding: 6px; border-radius: 4px; direction: ltr;">
                                    <div><strong>Person.name:</strong> "אייל עובדיה"</div>
                                    <div><strong>Person.jobTitle:</strong> "המנהל המקצועי והיועץ הראשי"</div>
                                    <div><strong>Organization.name:</strong> "רק תבקש" (פורטל) / "אפטריו בע"מ" (חברה)</div>
                                    <div><strong>Organization.url:</strong> "https://loan-israel.co.il"</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // Schema details
                if (schema.schemas && schema.schemas.length > 0) {
                    html += `<div style="font-size: 0.8rem;">`;
                    
                    schema.schemas.forEach((s, idx) => {
                        if (s.type === 'Graph' && s.items) {
                            // Graph with multiple items
                            s.items.forEach(item => {
                                html += renderSchemaItem(item);
                            });
                        } else {
                            html += renderSchemaItem(s);
                        }
                    });
                    
                    html += `</div>`;
                }
                
                // FAQ Questions comparison
                if (schema.schemas?.some(s => s.type === 'FAQPage' || s.items?.some(i => i.type === 'FAQPage'))) {
                    const faqSchema = schema.schemas.find(s => s.type === 'FAQPage') || 
                                      schema.schemas.find(s => s.items?.some(i => i.type === 'FAQPage'))?.items?.find(i => i.type === 'FAQPage');
                    
                    if (faqSchema?.details?.questions) {
                        html += `
                            <details style="margin-top: 0.75rem;">
                                <summary style="cursor: pointer; font-weight: bold; padding: 0.5rem; background: rgba(139, 92, 246, 0.1); border-radius: 4px;">
                                    ❓ שאלות ב-Schema (${faqSchema.details.questions.length})
                                </summary>
                                <div style="max-height: 200px; overflow-y: auto; margin-top: 0.5rem; font-size: 0.75rem;">
                                    ${faqSchema.details.questions.map((q, i) => `
                                        <div style="background: rgba(255,255,255,0.05); padding: 6px; border-radius: 4px; margin-bottom: 4px; border-right: 2px solid #8b5cf6;">
                                            <div style="font-weight: bold; color: #c4b5fd;">${i + 1}. ${q.question}</div>
                                            <div style="color: #9ca3af; font-size: 0.7rem; margin-top: 2px;">${q.answer}...</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </details>
                        `;
                        
                        // Compare with content questions
                        if (schema.contentQuestions && schema.contentQuestions.length > 0) {
                            const schemaQs = faqSchema.details.questions.map(q => q.question.toLowerCase());
                            const contentQs = schema.contentQuestions.map(q => q.toLowerCase());
                            
                            const missingInContent = schemaQs.filter(sq => !contentQs.some(cq => cq.includes(sq.substring(0, 20)) || sq.includes(cq.substring(0, 20))));
                            
                            if (missingInContent.length > 0) {
                                const faqIssues = missingInContent.map(q => `שאלה ב-Schema לא נמצאה בתוכן: "${q.substring(0, 50)}..."`);
                                const faqIssuesJson = JSON.stringify(faqIssues);
                                html += `
                                    <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 6px; padding: 0.5rem; margin-top: 0.5rem;">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <span style="color: #f87171; font-size: 0.75rem;">⚠️ ${missingInContent.length} שאלות ב-Schema לא נמצאו בתוכן</span>
                                            <button onclick='fixSchemaWithClaude(${faqIssuesJson.replace(/'/g, "&#39;")})' 
                                                    style="background: linear-gradient(135deg, #8b5cf6, #6366f1); color: white; border: none; padding: 3px 8px; border-radius: 4px; cursor: pointer; font-size: 0.65rem;">
                                                🔧 תקן
                                            </button>
                                        </div>
                                        <details style="margin-top: 0.5rem;">
                                            <summary style="cursor: pointer; font-size: 0.7rem; color: #9ca3af;">הצג שאלות חסרות</summary>
                                            <ul style="margin: 0.25rem 0 0 0; padding-right: 1rem; font-size: 0.65rem; color: #f87171;">
                                                ${missingInContent.map(q => `<li>${q.substring(0, 60)}...</li>`).join('')}
                                            </ul>
                                        </details>
                                    </div>
                                `;
                            }
                        }
                    }
                }
            }
            
            html += '</div>';
            return html;
        }
        
        function fixSchemaWithClaude(issues) {
            const pageFolder = getPageFolder(selectedPage?.path);
            const pageName = selectedPage?.name || 'העמוד';
            
            // Check if issues are about FAQ questions
            const isFaqIssue = issues.some(i => i.includes('שאלה ב-Schema') || i.includes('FAQ'));
            
            let additionalInstructions = '';
            if (isFaqIssue) {
                additionalInstructions = `
### בעיית FAQ - שאלות חסרות ב-Schema:

**משימה:** סרוק את כל השאלות בתוכן העמוד (כותרות H2, H3, H4 שמסתיימות ב-?) והוסף אותן ל-FAQPage Schema.

**פורמט להוספה:**
\`\`\`json
{
  "@type": "Question",
  "name": "השאלה מהתוכן",
  "acceptedAnswer": {
    "@type": "Answer",
    "text": "התשובה מהפסקה שמתחת לשאלה"
  }
}
\`\`\`

**חשוב:** 
- הוסף כל שאלה שמופיעה בתוכן ולא קיימת ב-Schema
- העתק את הניסוח המדויק מהתוכן
- התשובה = הפסקה שמופיעה מתחת לכותרת השאלה
`;
            }
            
            const prompt = `# תיקון Schema / JSON-LD

## עמוד: ${pageName}
## נתיב: ${pageFolder}

## בעיות שנמצאו:
${issues.map((issue, i) => `${i + 1}. ${issue}`).join('\n')}

## הנחיות לתיקון:

### פרטים נכונים שחייבים להופיע:

**Person (הכותב):**
\`\`\`json
{
  "@type": "Person",
  "name": "אייל עובדיה",
  "jobTitle": "המנהל המקצועי והיועץ הראשי"
}
\`\`\`

**Organization (הפורטל):**
\`\`\`json
{
  "@type": "Organization",
  "name": "רק תבקש",
  "url": "https://loan-israel.co.il"
}
\`\`\`
${additionalInstructions}
## משימה:
1. פתח את קובץ ה-HTML של העמוד
2. מצא את ה-Schema (בתוך \`<script type="application/ld+json">\`)
3. תקן את הבעיות שרשומות למעלה
4. וודא שה-JSON תקין לאחר התיקון
5. שמור את הקובץ

**חשוב:** 
- תקן רק את ה-Schema, אל תשנה את התוכן!
- וודא שה-JSON תקין לאחר התיקון`;

            // Show prompt preview
            showSchemaFixPrompt(prompt);
        }
        
        function showSchemaFixPrompt(prompt) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'schemaFixModal';
            modal.innerHTML = `
                <div class="modal" style="max-width: 700px;">
                    <div class="modal-header">
                        <h2>🔧 תיקון Schema עם Claude Code</h2>
                        <button class="modal-close" onclick="document.getElementById('schemaFixModal').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div style="background: #1e1e1e; border-radius: 8px; padding: 1rem; max-height: 400px; overflow-y: auto;">
                            <pre style="margin: 0; white-space: pre-wrap; font-size: 0.8rem; color: #e5e7eb; direction: ltr;">${prompt.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</pre>
                        </div>
                    </div>
                    <div class="modal-footer" style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button class="btn btn-secondary" onclick="copySchemaPrompt()">📋 העתק</button>
                        <button class="btn btn-primary" onclick="sendSchemaFixToClaude(\`${encodeURIComponent(prompt)}\`)" style="background: linear-gradient(135deg, #8b5cf6, #6366f1);">
                            🚀 שלח ל-Claude Code
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.style.display = 'flex';
            
            // Store prompt for copy
            window.currentSchemaPrompt = prompt;
        }
        
        function copySchemaPrompt() {
            if (window.currentSchemaPrompt) {
                navigator.clipboard.writeText(window.currentSchemaPrompt);
                showToast('✅ הפרומפט הועתק!', 'success');
            }
        }
        
        async function sendSchemaFixToClaude(encodedPrompt) {
            const prompt = decodeURIComponent(encodedPrompt);
            const pagePath = selectedPage?.path;
            
            if (!pagePath) {
                showToast('לא נבחר עמוד', 'error');
                return;
            }
            
            try {
                showToast('🚀 שולח ל-Claude Code...', 'info');
                
                const response = await fetch('/api/prompt/run-agent', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        page_path: pagePath,
                        prompt: prompt,
                        agent_type: 'schema_fix'
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    showToast('🚀 Claude Code מריץ את התיקון!', 'success');
                    document.getElementById('schemaFixModal')?.remove();
                    
                    // Open work panel to see progress
                    const workPanel = document.getElementById('workPanel');
                    if (workPanel && workPanel.style.display === 'none') {
                        toggleWorkPanel();
                    }
                    
                    // Start polling for log updates
                    if (typeof startLogPolling === 'function') {
                        startLogPolling(pagePath);
                    }
                } else {
                    showToast('שגיאה: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error sending to Claude:', error);
                showToast('שגיאה בשליחה: ' + error.message, 'error');
            }
        }
        
        function renderSchemaItem(item) {
            const typeColors = {
                'Person': '#60a5fa',
                'Organization': '#10b981',
                'FAQPage': '#8b5cf6',
                'Article': '#f59e0b',
                'NewsArticle': '#f59e0b',
                'BlogPosting': '#f59e0b',
                'WebPage': '#6b7280',
                'WebSite': '#6b7280'
            };
            
            const color = typeColors[item.type] || '#9ca3af';
            
            let html = `
                <div style="background: rgba(255,255,255,0.05); border-radius: 4px; padding: 6px; margin-bottom: 6px; border-right: 3px solid ${color};">
                    <span style="color: ${color}; font-weight: bold;">📦 ${item.type}</span>
            `;
            
            if (item.details) {
                const d = item.details;
                if (d.name) html += `<div style="color: #9ca3af; font-size: 0.7rem;">שם: ${d.name}</div>`;
                if (d.jobTitle) html += `<div style="color: #9ca3af; font-size: 0.7rem;">תפקיד: ${d.jobTitle}</div>`;
                if (d.url) html += `<div style="color: #9ca3af; font-size: 0.7rem; direction: ltr;">URL: ${d.url}</div>`;
                if (d.headline) html += `<div style="color: #9ca3af; font-size: 0.7rem;">כותרת: ${d.headline}</div>`;
                if (d.author) html += `<div style="color: #9ca3af; font-size: 0.7rem;">מחבר: ${d.author}</div>`;
                if (d.questionCount !== undefined) html += `<div style="color: #9ca3af; font-size: 0.7rem;">שאלות: ${d.questionCount}</div>`;
            }
            
            html += '</div>';
            return html;
        }
        
        // ============ Keyword Density Fix Functions ============
        
        // Fix keyword issue by generating prompt and sending to Claude
        function fixKeywordIssue(issueType, data) {
            // Fix prompt templates for keyword density issues
            const fixPromptTemplates = {
                stuffing: `הפחת את צפיפות מילת המפתח "{keyword}" מ-{currentDensity}% ל-{targetDensity}%.
הסר {removeCount} מופעים מגוף התוכן.
עדיפות להסרה: פסקאות פתיחה וסיום.
שמור על קריאות טבעית.
אל תשנה כותרות.`,

                missingTitle: `הוסף את מילת המפתח "{keyword}" לכותרת העמוד.
כותרת נוכחית: "{currentTitle}"
שמור על אורך דומה ומשמעות.
הכותרת צריכה להיות אטרקטיבית לקליקים.`,

                missingMeta: `הוסף את מילת המפתח "{keyword}" לתיאור המטא.
תיאור נוכחי: "{currentMeta}"
שמור על אורך של עד 155 תווים.
התיאור צריך להיות אטרקטיבי לקליקים.`,

                missing_title: `הוסף את מילת המפתח "{keyword}" לכותרת העמוד.
כותרת נוכחית: "{currentText}"
שמור על אורך דומה ומשמעות.`,

                missing_meta: `הוסף את מילת המפתח "{keyword}" לתיאור המטא.
תיאור נוכחי: "{currentText}"`,

                missing_h1: `צור כותרת H1 חדשה לעמוד שמכילה את מילת המפתח "{keyword}".
הכותרת צריכה להיות ברורה ומתארת את תוכן העמוד.`,

                keyword_missing_h1: `שכתב את כותרת ה-H1 כך שתכלול את מילת המפתח "{keyword}".
כותרת נוכחית: "{currentText}"
שמור על אורך דומה ומשמעות.`,

                keyword_missing_h2: `הוסף את מילת המפתח "{keyword}" לאחת מכותרות ה-H2.
או צור כותרת H2 חדשה שמכילה את המילה.`,

                low_h2_coverage: `הוסף את מילת המפתח "{keyword}" לכותרות H2 נוספות.
שים לב לא להגזים - מספיק בכותרת אחת או שתיים נוספות.`,

                add_occurrences: `הוסף {addCount} מופעים של מילת המפתח "{keyword}" לתוכן.
מיקומים מומלצים:
- פסקת הפתיחה
- לפחות כותרת H2 אחת  
- פסקת הסיום
השתמש בווריאציות טבעיות של המילה (למשל: הלוואה, הלוואות, ההלוואה).
שמור על קריאות טבעית.`,

                remove_occurrences: `הפחת {removeCount} מופעים של מילת המפתח "{keyword}" מהתוכן.
נסה להסיר מופעים מיותרים שנראים לא טבעיים.
עדיפות להסרה: מופעים קרובים אחד לשני, מופעים בסוף פסקאות.`,

                clustering: `פזר את מופעי מילת המפתח "{keyword}" בתוכן.
כרגע יש ריכוז גבוה מדי בחלק אחד של הטקסט.
הזז חלק מהמופעים לפסקאות אחרות לאורך העמוד.`
            };
            
            // Parse data if it's a string
            let issueData = data;
            if (typeof data === 'string') {
                try {
                    issueData = JSON.parse(data.replace(/&quot;/g, '"'));
                } catch (e) {
                    console.error('Error parsing issue data:', e);
                    issueData = { keyword: data };
                }
            }
            
            // Get the template
            const template = fixPromptTemplates[issueType];
            if (!template) {
                console.error('Unknown fix type:', issueType);
                showToast('סוג תיקון לא מוכר', 'error');
                return;
            }
            
            // Generate prompt from template
            let prompt = template;
            Object.keys(issueData).forEach(key => {
                const placeholder = new RegExp(`\\{${key}\\}`, 'g');
                const value = issueData[key] !== undefined ? String(issueData[key]) : '';
                prompt = prompt.replace(placeholder, value);
            });
            
            // Add context about the page
            if (selectedPage) {
                prompt = `📄 עמוד: ${selectedPage.name}\n\n${prompt}`;
            }
            
            // Show prompt preview (uses existing showPromptPreview function)
            showPromptPreview(prompt);
        }
        
        // ============ Spam Issue Fix Function ============
        function fixSpamIssue(issueType, data) {
            // Spam fix prompt templates
            const spamFixPrompts = {
                humanize_headers: `שכתב את הכותרות הבאות כך שלא יכילו את מילת המפתח "{keyword}" באופן חוזר:

כותרות לשכתוב:
{headersList}

הנחיות:
- גוון את הניסוח בכל כותרת
- השתמש במילים נרדפות ובשאלות
- שמור על המשמעות המקורית
- אל תמקם את מילת המפתח בתחילת כל כותרת`,

                expand_bolds: `הרחב את ההדגשות הבאות לכלול את כל המשפט או ביטוי ארוך יותר:

הנחיות:
- במקום להדגיש רק "{keyword}", הדגש את כל המשפט שמכיל אותה
- דוגמה: במקום <strong>הלוואה</strong> -> <strong>איך לקבל הלוואה בתנאים טובים</strong>
- עבור על כל ההדגשות המבודדות והרחב אותן`,

                unbold_randomly: `הסר הדגשות ממילת המפתח "{keyword}" בתוכן.

הנחיות:
- הסר הדגשות באופן אקראי לאורך הטקסט
- שמור על הדגשות בכותרות ובמשפטים חשובים
- עדיפות להסרה: הדגשות מבודדות (רק המילה עצמה)
- היעד: הגעה ליחס של כ-20% הדגשות ממופעי מילת המפתח`,

                h1_isolation: `הרחב את כותרת ה-H1 כך שתכלול יותר ממילת המפתח בלבד:

כותרת נוכחית: "{currentText}"

הנחיות:
- הוסף מילות הקשר ותיאור
- דוגמה: "הלוואה מיידית" -> "מדריך מלא להלוואה מיידית: תנאים, ריביות וטיפים"
- שמור על הכותרת קצרה ואטרקטיבית`
            };
            
            // Map issue types to prompt templates
            const promptMap = {
                'REPETITIVE_PATTERN': 'humanize_headers',
                'LEADING_KEYWORD': 'humanize_headers',
                'H1_ISOLATION': 'h1_isolation',
                'HIGH_BOLD_RATIO': 'unbold_randomly',
                'ISOLATED_BOLD': 'expand_bolds',
                'BOLD_CLUSTER': 'expand_bolds'
            };
            
            // Parse data if it's a string
            let issueData = data;
            if (typeof data === 'string') {
                try {
                    issueData = JSON.parse(data.replace(/&quot;/g, '"'));
                } catch (e) {
                    console.error('Error parsing spam issue data:', e);
                    issueData = { keyword: data };
                }
            }
            
            // Get the template
            const promptType = promptMap[issueType] || issueType.toLowerCase();
            const template = spamFixPrompts[promptType];
            
            if (!template) {
                console.error('Unknown spam fix type:', issueType);
                showToast('סוג תיקון ספאם לא מוכר', 'error');
                return;
            }
            
            // Generate prompt from template
            let prompt = template;
            Object.keys(issueData).forEach(key => {
                const placeholder = new RegExp(`\\{${key}\\}`, 'g');
                const value = issueData[key] !== undefined ? String(issueData[key]) : '';
                prompt = prompt.replace(placeholder, value);
            });
            
            // Add context about the page
            if (selectedPage) {
                prompt = `📄 עמוד: ${selectedPage.name}\n🛡️ תיקון ספאם\n\n${prompt}`;
            }
            
            // Show prompt preview
            showPromptPreview(prompt);
        }
        
        function generateKeywordOccurrencesAnalysis(oldA, newA, mainKeyword) {
            try {
            // Get all keywords from page_info
            const pageInfo = uploadState.pageInfo || {};
            const autocomplete = pageInfo.google_autocomplete || [];
            const relatedKeywords = pageInfo.related_keywords || [];
            
            // Combine all keywords to analyze (only main keyword for density analysis)
            let allKeywords = [mainKeyword];
            if (autocomplete.length > 0) {
                allKeywords = allKeywords.concat(autocomplete.slice(0, 5));
            }
            
            // Remove duplicates and empty strings
            allKeywords = [...new Set(allKeywords.filter(k => k && k.trim()))];
            
            if (allKeywords.length === 0) {
                return '';
            }
            
            function escapeRegex(str) {
                return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            }
            
            // Helper to get all headings text
            function getHeadingsText(headings) {
                if (!headings) return '';
                const allHeadings = [
                    ...(headings.h1s || []),
                    ...(headings.h2s || []),
                    ...(headings.h3s || []),
                    ...(headings.h4s || []),
                    ...(headings.h5s || []),
                    ...(headings.h6s || [])
                ];
                return allHeadings.join(' ');
            }
            
            // Count headings with keyword
            function countHeadingsWithKeyword(headings, keyword) {
                if (!headings) return { total: 0, withKeyword: 0, h2Total: 0, h2WithKeyword: 0 };
                
                const variations = getHebrewVariations(keyword.toLowerCase());
                
                const h2s = headings.h2s || [];
                const h3s = headings.h3s || [];
                const allH = [...h2s, ...h3s];
                
                let h2WithKw = 0;
                h2s.forEach(h => {
                    if (variations.some(v => h.toLowerCase().includes(v))) h2WithKw++;
                });
                
                let allWithKw = 0;
                allH.forEach(h => {
                    if (variations.some(v => h.toLowerCase().includes(v))) allWithKw++;
                });
                
                return {
                    total: allH.length,
                    withKeyword: allWithKw,
                    h2Total: h2s.length,
                    h2WithKeyword: h2WithKw
                };
            }
            
            // Analyze occurrences and density for each keyword
            // useVariations = true for main keyword, false for related keywords (exact match)
            function analyzeKeyword(text, headings, wordCount, keyword, useVariations = true) {
                if (!text || !keyword) return null;
                
                const keywordLower = keyword.toLowerCase();
                const textLower = text.toLowerCase();
                const headingsText = getHeadingsText(headings).toLowerCase();
                
                let totalInContent = 0;
                let totalInHeadings = 0;
                
                if (useVariations) {
                    // For main keyword - use variations
                    const variations = getHebrewVariations(keywordLower);
                    variations.forEach(variation => {
                        const contentMatches = (textLower.match(new RegExp(escapeRegex(variation), 'g')) || []).length;
                        const headingMatches = (headingsText.match(new RegExp(escapeRegex(variation), 'g')) || []).length;
                        totalInContent += contentMatches;
                        totalInHeadings += headingMatches;
                    });
                } else {
                    // For related keywords - exact match only
                    totalInContent = (textLower.match(new RegExp(escapeRegex(keywordLower), 'g')) || []).length;
                    totalInHeadings = (headingsText.match(new RegExp(escapeRegex(keywordLower), 'g')) || []).length;
                }
                
                // Calculate density
                const density = wordCount > 0 ? (totalInContent / wordCount * 100) : 0;
                
                // Get heading stats
                const headingStats = countHeadingsWithKeyword(headings, keyword);
                const h2Percentage = headingStats.h2Total > 0 ? (headingStats.h2WithKeyword / headingStats.h2Total * 100) : 0;
                
                // Determine status based on SEO agent rules
                let densityStatus = 'good';
                let densityIcon = '✅';
                if (density > 4) { densityStatus = 'critical'; densityIcon = '🔴'; }
                else if (density > 3) { densityStatus = 'high'; densityIcon = '🟠'; }
                else if (density > 2.5) { densityStatus = 'borderline'; densityIcon = '⚠️'; }
                
                let h2Status = 'good';
                let h2Icon = '✅';
                if (h2Percentage > 50) { h2Status = 'spam'; h2Icon = '🔴'; }
                else if (h2Percentage > 40) { h2Status = 'high'; h2Icon = '⚠️'; }
                
                return {
                    inContent: totalInContent,
                    inHeadings: totalInHeadings,
                    density: density.toFixed(2),
                    densityStatus,
                    densityIcon,
                    h2Total: headingStats.h2Total,
                    h2WithKeyword: headingStats.h2WithKeyword,
                    h2Percentage: h2Percentage.toFixed(0),
                    h2Status,
                    h2Icon,
                    wordCount
                };
            }
            
            // Build analysis data for main keyword
            const oldWordCount = oldA.available ? oldA.wordCount : 0;
            const newWordCount = newA.available ? newA.wordCount : 0;
            
            const mainOld = oldA.available ? analyzeKeyword(oldA.text, oldA.headings, oldWordCount, mainKeyword) : null;
            const mainNew = newA.available ? analyzeKeyword(newA.text, newA.headings, newWordCount, mainKeyword) : null;
            
            // Build analysis for other keywords (exact match - no variations)
            const otherKeywordsAnalysis = allKeywords.slice(1).map(kw => ({
                keyword: kw,
                old: oldA.available ? analyzeKeyword(oldA.text, oldA.headings, oldWordCount, kw, false) : null,
                new: newA.available ? analyzeKeyword(newA.text, newA.headings, newWordCount, kw, false) : null
            })).filter(item => (item.old?.inContent > 0) || (item.new?.inContent > 0));
            
            // Determine improvement
            const densityImproved = mainOld && mainNew && parseFloat(mainNew.density) < parseFloat(mainOld.density) && mainOld.densityStatus !== 'good';
            const h2Improved = mainOld && mainNew && parseFloat(mainNew.h2Percentage) < parseFloat(mainOld.h2Percentage) && mainOld.h2Status !== 'good';
            
            // Try to use advanced analyzer for this section too
            let advancedNewData = null;
            let advancedOldData = null;
            const metaBackup = uploadState.backupMeta || {};
            const pageInfoData = uploadState.pageInfo || {};
            const titleInput = document.getElementById('uploadTitle')?.value || '';
            const descInput = document.getElementById('uploadDescription')?.value || '';
            
            if (typeof KeywordDensityAnalyzer !== 'undefined') {
                try {
                    if (newA.available && newA.content && newA.content.length > 100) {
                        const analyzer = new KeywordDensityAnalyzer(newA.content, mainKeyword, {
                            externalTitle: titleInput || pageInfoData.new_title || pageInfoData.title || '',
                            externalDescription: descInput || pageInfoData.new_description || pageInfoData.description || ''
                        });
                        advancedNewData = analyzer.analyze();
                    }
                    if (oldA.available && oldA.content && oldA.content.length > 100) {
                        const oldAnalyzer = new KeywordDensityAnalyzer(oldA.content, mainKeyword, {
                            externalTitle: metaBackup.title || '',
                            externalDescription: metaBackup.description || ''
                        });
                        advancedOldData = oldAnalyzer.analyze();
                    }
                } catch (e) {
                    console.warn('Advanced analyzer error in occurrences section:', e);
                }
            }
            
            const isAdvanced = advancedNewData || advancedOldData;
            
            let html = `
                <div class="seo-section" style="background: var(--bg-tertiary); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                    <h5>🔑 ניתוח צפיפות מילות מפתח</h5>
                    
                    <!-- Algorithm indicator -->
                    ${isAdvanced ? `
                    <div style="background: linear-gradient(135deg, rgba(16,185,129,0.2), rgba(5,150,105,0.2)); border: 1px solid #10b981; border-radius: 6px; padding: 0.5rem; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem; font-size: 0.8rem;">
                        <span>🚀</span>
                        <span style="color: #10b981; font-weight: 500;">אלגוריתם מתקדם פעיל</span>
                        <span style="color: #6ee7b7;">| צפיפות משוקללת + וריאציות עבריות + Title/Meta מ-JSON</span>
                    </div>
                    ` : `
                    <div style="background: rgba(245,158,11,0.15); border: 1px solid #f59e0b; border-radius: 6px; padding: 0.5rem; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem; font-size: 0.8rem;">
                        <span>⚠️</span>
                        <span style="color: #f59e0b; font-weight: 500;">אלגוריתם בסיסי</span>
                    </div>
                    `}
                    
                    <!-- Main Keyword Density Analysis -->
                    <div style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                        <h6 style="margin: 0 0 0.75rem 0; color: var(--accent-primary);">⭐ מילת מפתח ראשית: "${mainKeyword}"</h6>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <!-- Old Content -->
                            <div style="background: rgba(156,163,175,0.1); padding: 0.75rem; border-radius: 6px;">
                                <div style="font-weight: bold; color: #9ca3af; margin-bottom: 0.5rem;">📄 תוכן ישן</div>
                                ${mainOld ? `
                                    <div style="font-size: 0.8rem;">
                                        <div>מילים: <strong>${advancedOldData?.totalWords || mainOld.wordCount}</strong></div>
                                        <div>הופעות בתוכן: <strong>${advancedOldData?.totalOccurrences || mainOld.inContent}</strong></div>
                                        <div>צפיפות${isAdvanced ? ' (משוקללת)' : ''}: <span style="color: ${mainOld.densityStatus === 'good' ? '#10b981' : mainOld.densityStatus === 'critical' ? '#ef4444' : '#f59e0b'};">
                                            ${mainOld.densityIcon} <strong>${advancedOldData?.weightedDensity?.toFixed(2) || mainOld.density}%</strong>
                                        </span></div>
                                        ${advancedOldData ? `
                                        <div style="margin-top: 0.25rem; font-size: 0.75rem; color: #9ca3af;">
                                            Title: ${advancedOldData.breakdown?.title?.found ? '✅' : '❌'} | 
                                            Meta: ${advancedOldData.breakdown?.metaDescription?.found ? '✅' : '❌'} |
                                            ציון: ${advancedOldData.score}
                                        </div>
                                        ` : ''}
                                        <div style="margin-top: 0.5rem; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 0.5rem;">
                                            H2 עם מילת מפתח: <span style="color: ${mainOld.h2Status === 'good' ? '#10b981' : '#ef4444'};">
                                                ${mainOld.h2Icon} ${advancedOldData?.breakdown?.h2?.foundCount ?? mainOld.h2WithKeyword}/${advancedOldData?.breakdown?.h2?.totalItems ?? mainOld.h2Total} (${mainOld.h2Percentage}%)
                                            </span>
                                        </div>
                                        
                                        <!-- Expandable Calculation Details - Old -->
                                        ${advancedOldData ? `
                                        <details style="margin-top: 0.75rem; border-top: 1px dashed rgba(255,255,255,0.15); padding-top: 0.5rem;">
                                            <summary style="cursor: pointer; font-size: 0.75rem; color: #9ca3af; display: flex; align-items: center; gap: 0.25rem;">
                                                <span style="transition: transform 0.2s;">▶</span> פירוט חישוב
                                            </summary>
                                            <div style="margin-top: 0.5rem; font-size: 0.7rem; background: rgba(0,0,0,0.2); padding: 0.5rem; border-radius: 4px;">
                                                <div style="font-weight: 600; color: #9ca3af; margin-bottom: 0.5rem;">📊 נוסחת צפיפות משוקללת:</div>
                                                <div style="background: rgba(255,255,255,0.05); padding: 0.5rem; border-radius: 4px; font-family: monospace; direction: ltr; text-align: left; margin-bottom: 0.5rem;">
                                                    (Σ מופעים×משקל) / (Σ מילים×משקל) × 100
                                                </div>
                                                
                                                <div style="font-weight: 600; color: #9ca3af; margin-bottom: 0.25rem;">⚖️ משקלות אזורים:</div>
                                                <table style="width: 100%; font-size: 0.65rem; margin-bottom: 0.5rem;">
                                                    <tr><td>Title</td><td style="text-align: center;">×3</td><td>Meta</td><td style="text-align: center;">×2</td></tr>
                                                    <tr><td>H1</td><td style="text-align: center;">×3</td><td>H2</td><td style="text-align: center;">×2</td></tr>
                                                    <tr><td>H3-H6</td><td style="text-align: center;">×1.5</td><td>Body</td><td style="text-align: center;">×1</td></tr>
                                                </table>
                                                
                                                <div style="font-weight: 600; color: #9ca3af; margin-bottom: 0.25rem;">📍 פילוח מופעים:</div>
                                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.25rem;">
                                                    <div>Title: ${advancedOldData.breakdown?.title?.count || 0}×3 = ${(advancedOldData.breakdown?.title?.count || 0) * 3}</div>
                                                    <div>Meta: ${advancedOldData.breakdown?.metaDescription?.count || 0}×2 = ${(advancedOldData.breakdown?.metaDescription?.count || 0) * 2}</div>
                                                    <div>H1: ${advancedOldData.breakdown?.h1?.totalCount || 0}×3 = ${(advancedOldData.breakdown?.h1?.totalCount || 0) * 3}</div>
                                                    <div>H2: ${advancedOldData.breakdown?.h2?.totalCount || 0}×2 = ${(advancedOldData.breakdown?.h2?.totalCount || 0) * 2}</div>
                                                    <div>Body: ${advancedOldData.breakdown?.body?.count || 0}×1 = ${advancedOldData.breakdown?.body?.count || 0}</div>
                                                </div>
                                                
                                                <div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid rgba(255,255,255,0.1); font-weight: 600;">
                                                    סה"כ משוקלל: ${advancedOldData.totalWeightedCount || 0} / ${advancedOldData.totalWeightedWords || 0} = 
                                                    <span style="color: #f59e0b;">${advancedOldData.weightedDensity?.toFixed(2)}%</span>
                                                </div>
                                            </div>
                                        </details>
                                        ` : ''}
                                    </div>
                                ` : '<span style="color: #6b7280;">לא זמין</span>'}
                            </div>
                            
                            <!-- New Content -->
                            <div style="background: rgba(16,185,129,0.1); padding: 0.75rem; border-radius: 6px; border: ${mainNew?.densityStatus === 'good' && mainNew?.h2Status === 'good' ? '2px solid #10b981' : mainNew?.densityStatus === 'critical' || mainNew?.h2Status === 'spam' ? '2px solid #ef4444' : '1px solid rgba(255,255,255,0.1)'};">
                                <div style="font-weight: bold; color: #10b981; margin-bottom: 0.5rem;">✨ תוכן חדש</div>
                                ${mainNew ? `
                                    <div style="font-size: 0.8rem;">
                                        <div>מילים: <strong>${advancedNewData?.totalWords || mainNew.wordCount}</strong></div>
                                        <div>הופעות בתוכן: <strong>${advancedNewData?.totalOccurrences || mainNew.inContent}</strong></div>
                                        <div>צפיפות${isAdvanced ? ' (משוקללת)' : ''}: <span style="color: ${mainNew.densityStatus === 'good' ? '#10b981' : mainNew.densityStatus === 'critical' ? '#ef4444' : '#f59e0b'};">
                                            ${mainNew.densityIcon} <strong>${advancedNewData?.weightedDensity?.toFixed(2) || mainNew.density}%</strong>
                                            ${densityImproved ? '<span style="color: #10b981; margin-right: 8px;">📈 שופר!</span>' : ''}
                                        </span></div>
                                        ${advancedNewData ? `
                                        <div style="margin-top: 0.25rem; font-size: 0.75rem; color: #6ee7b7;">
                                            Title: ${advancedNewData.breakdown?.title?.found ? '✅' : '❌'} | 
                                            Meta: ${advancedNewData.breakdown?.metaDescription?.found ? '✅' : '❌'} |
                                            ציון: ${advancedNewData.score}
                                        </div>
                                        ` : ''}
                                        <div style="margin-top: 0.5rem; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 0.5rem;">
                                            H2 עם מילת מפתח: <span style="color: ${mainNew.h2Status === 'good' ? '#10b981' : '#ef4444'};">
                                                ${mainNew.h2Icon} ${advancedNewData?.breakdown?.h2?.foundCount ?? mainNew.h2WithKeyword}/${advancedNewData?.breakdown?.h2?.totalItems ?? mainNew.h2Total} (${mainNew.h2Percentage}%)
                                                ${h2Improved ? '<span style="color: #10b981; margin-right: 8px;">📈 שופר!</span>' : ''}
                                            </span>
                                        </div>
                                        
                                        <!-- Expandable Calculation Details - New -->
                                        ${advancedNewData ? `
                                        <details style="margin-top: 0.75rem; border-top: 1px dashed rgba(255,255,255,0.15); padding-top: 0.5rem;">
                                            <summary style="cursor: pointer; font-size: 0.75rem; color: #10b981; display: flex; align-items: center; gap: 0.25rem;">
                                                <span style="transition: transform 0.2s;">▶</span> פירוט חישוב
                                            </summary>
                                            <div style="margin-top: 0.5rem; font-size: 0.7rem; background: rgba(0,0,0,0.2); padding: 0.5rem; border-radius: 4px;">
                                                <div style="font-weight: 600; color: #10b981; margin-bottom: 0.5rem;">📊 נוסחת צפיפות משוקללת:</div>
                                                <div style="background: rgba(255,255,255,0.05); padding: 0.5rem; border-radius: 4px; font-family: monospace; direction: ltr; text-align: left; margin-bottom: 0.5rem;">
                                                    (Σ מופעים×משקל) / (Σ מילים×משקל) × 100
                                                </div>
                                                
                                                <div style="font-weight: 600; color: #10b981; margin-bottom: 0.25rem;">⚖️ משקלות אזורים:</div>
                                                <table style="width: 100%; font-size: 0.65rem; margin-bottom: 0.5rem;">
                                                    <tr><td>Title</td><td style="text-align: center;">×3</td><td>Meta</td><td style="text-align: center;">×2</td></tr>
                                                    <tr><td>H1</td><td style="text-align: center;">×3</td><td>H2</td><td style="text-align: center;">×2</td></tr>
                                                    <tr><td>H3-H6</td><td style="text-align: center;">×1.5</td><td>Body</td><td style="text-align: center;">×1</td></tr>
                                                </table>
                                                
                                                <div style="font-weight: 600; color: #10b981; margin-bottom: 0.25rem;">📍 פילוח מופעים:</div>
                                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.25rem;">
                                                    <div>Title: ${advancedNewData.breakdown?.title?.count || 0}×3 = ${(advancedNewData.breakdown?.title?.count || 0) * 3}</div>
                                                    <div>Meta: ${advancedNewData.breakdown?.metaDescription?.count || 0}×2 = ${(advancedNewData.breakdown?.metaDescription?.count || 0) * 2}</div>
                                                    <div>H1: ${advancedNewData.breakdown?.h1?.totalCount || 0}×3 = ${(advancedNewData.breakdown?.h1?.totalCount || 0) * 3}</div>
                                                    <div>H2: ${advancedNewData.breakdown?.h2?.totalCount || 0}×2 = ${(advancedNewData.breakdown?.h2?.totalCount || 0) * 2}</div>
                                                    <div>Body: ${advancedNewData.breakdown?.body?.count || 0}×1 = ${advancedNewData.breakdown?.body?.count || 0}</div>
                                                </div>
                                                
                                                <div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid rgba(255,255,255,0.1); font-weight: 600;">
                                                    סה"כ משוקלל: ${advancedNewData.totalWeightedCount || 0} / ${advancedNewData.totalWeightedWords || 0} = 
                                                    <span style="color: #10b981;">${advancedNewData.weightedDensity?.toFixed(2)}%</span>
                                                </div>
                                                
                                                <div style="margin-top: 0.5rem; padding: 0.5rem; background: rgba(16,185,129,0.1); border-radius: 4px;">
                                                    <div style="font-weight: 600; color: #10b981; margin-bottom: 0.25rem;">📈 נוסחת ציון:</div>
                                                    <div style="font-size: 0.65rem;">
                                                        אם צפיפות 1.5-2.5%: ציון = 100<br>
                                                        אם צפיפות 1.0-1.5% או 2.5-3.0%: ציון = 60-90<br>
                                                        מתחת ל-1.0% או מעל 3.0%: ציון נמוך יותר<br>
                                                        <strong>הציון שלך: ${advancedNewData.score}</strong> (${advancedNewData.status?.label || 'N/A'})
                                                    </div>
                                                </div>
                                            </div>
                                        </details>
                                        ` : ''}
                                    </div>
                                ` : '<span style="color: #6b7280;">לא זמין</span>'}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Density Legend -->
                    <div style="font-size: 0.7rem; color: var(--text-secondary); margin-bottom: 1rem; background: rgba(0,0,0,0.15); padding: 0.5rem; border-radius: 4px;">
                        <strong>מפתח צפיפות:</strong>
                        ✅ 1.5-2.5% אופטימלי |
                        ⚠️ 2.5-3% גבולי |
                        🟠 3-4% גבוה |
                        🔴 4%+ קריטי (Stuffing)
                        <br>
                        <strong>כותרות H2:</strong> מקסימום 40% עם מילת מפתח | מעל 50% = ספאם 🔴
                    </div>
                    
                    <!-- Detailed Variations Analysis -->
                    ${generateVariationsDetail(mainKeyword, oldA, newA)}
                    
                    <!-- Headings Detail -->
                    ${generateHeadingsDetail(mainKeyword, oldA, newA)}
            `;
            
            // Other keywords table
            if (otherKeywordsAnalysis.length > 0) {
                html += `
                    <details style="margin-top: 1rem;">
                        <summary style="cursor: pointer; color: var(--accent-primary); font-weight: bold;">
                            📊 מילות מפתח נוספות (${otherKeywordsAnalysis.length})
                        </summary>
                        <div style="overflow-x: auto; margin-top: 0.5rem;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.75rem;">
                                <thead>
                                    <tr style="background: rgba(255,255,255,0.05);">
                                        <th style="text-align: right; padding: 6px;">מילת מפתח</th>
                                        <th style="text-align: center; padding: 6px;">ישן</th>
                                        <th style="text-align: center; padding: 6px;">חדש</th>
                                        <th style="text-align: center; padding: 6px;">צפיפות ישנה</th>
                                        <th style="text-align: center; padding: 6px;">צפיפות חדשה</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${otherKeywordsAnalysis.map(item => `
                                        <tr style="border-bottom: 1px solid var(--border-color);">
                                            <td style="padding: 6px;">${item.keyword}</td>
                                            <td style="text-align: center; padding: 6px; color: #9ca3af;">${item.old?.inContent || 0}</td>
                                            <td style="text-align: center; padding: 6px; color: #10b981;">${item.new?.inContent || 0}</td>
                                            <td style="text-align: center; padding: 6px; color: #9ca3af;">${item.old?.density || 0}%</td>
                                            <td style="text-align: center; padding: 6px;">
                                                <span style="color: ${item.new?.densityStatus === 'good' ? '#10b981' : item.new?.densityStatus === 'critical' ? '#ef4444' : '#f59e0b'};">
                                                    ${item.new?.densityIcon || ''} ${item.new?.density || 0}%
                                                </span>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </details>
                `;
            }
            
            html += `</div>`;
            
            return html;
            } catch (error) {
                console.error('Error in keyword occurrences analysis:', error);
                return `<div style="color: #ef4444; padding: 0.5rem;">שגיאה בניתוח מילות מפתח: ${error.message}</div>`;
            }
        }
        
        function generateVariationsDetail(keyword, oldA, newA) {
            try {
                const variations = getHebrewVariations(keyword.toLowerCase());
                
                function countVariation(text, variation) {
                    if (!text) return 0;
                    const regex = new RegExp(variation.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
                    return (text.match(regex) || []).length;
                }
                
                const oldText = oldA.available ? oldA.text : '';
                const newText = newA.available ? newA.text : '';
                
                const variationCounts = variations.map(v => ({
                    variation: v,
                    oldCount: countVariation(oldText, v),
                    newCount: countVariation(newText, v)
                })).filter(v => v.oldCount > 0 || v.newCount > 0);
                
                if (variationCounts.length === 0) return '';
                
                return `
                    <details style="margin-top: 1rem;">
                        <summary style="cursor: pointer; color: var(--accent-primary); font-weight: bold;">
                            🔤 וריאציות מילת המפתח בתוכן (${variationCounts.length} וריאציות)
                        </summary>
                        <div style="background: rgba(0,0,0,0.2); padding: 0.75rem; border-radius: 6px; margin-top: 0.5rem;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.8rem;">
                                <thead>
                                    <tr style="background: rgba(255,255,255,0.05);">
                                        <th style="text-align: right; padding: 6px;">וריאציה</th>
                                        <th style="text-align: center; padding: 6px; color: #9ca3af;">ישן</th>
                                        <th style="text-align: center; padding: 6px; color: #10b981;">חדש</th>
                                        <th style="text-align: center; padding: 6px;">שינוי</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${variationCounts.map(v => {
                                        const change = v.newCount - v.oldCount;
                                        const changeColor = change > 0 ? '#f59e0b' : change < 0 ? '#10b981' : '#9ca3af';
                                        const changeIcon = change > 0 ? '📈' : change < 0 ? '📉' : '➡️';
                                        return `
                                            <tr style="border-bottom: 1px solid var(--border-color);">
                                                <td style="padding: 6px; font-family: monospace;">"${v.variation}"</td>
                                                <td style="text-align: center; padding: 6px; color: #9ca3af;">${v.oldCount}</td>
                                                <td style="text-align: center; padding: 6px; color: #10b981; font-weight: bold;">${v.newCount}</td>
                                                <td style="text-align: center; padding: 6px; color: ${changeColor};">
                                                    ${changeIcon} ${change > 0 ? '+' : ''}${change}
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                                <tfoot>
                                    <tr style="background: rgba(255,255,255,0.05); font-weight: bold;">
                                        <td style="padding: 6px;">סה"כ</td>
                                        <td style="text-align: center; padding: 6px; color: #9ca3af;">
                                            ${variationCounts.reduce((sum, v) => sum + v.oldCount, 0)}
                                        </td>
                                        <td style="text-align: center; padding: 6px; color: #10b981;">
                                            ${variationCounts.reduce((sum, v) => sum + v.newCount, 0)}
                                        </td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </details>
                `;
            } catch (e) {
                console.error('Error in variations detail:', e);
                return '';
            }
        }
        
        function generateHeadingsDetail(keyword, oldA, newA, headerScores = null) {
            try {
                const variations = getHebrewVariations(keyword.toLowerCase());
                
                function hasKeyword(text) {
                    const lower = text.toLowerCase();
                    return variations.some(v => lower.includes(v));
                }
                
                // Helper to find score for a heading by text
                function findHeaderScore(text, tag) {
                    if (!headerScores || !headerScores.headers_analysis) return null;
                    
                    // Normalize for comparison - remove extra whitespace and lowercase
                    const normalizeForCompare = (str) => {
                        return str.trim().toLowerCase().replace(/\s+/g, ' ');
                    };
                    
                    const normalizedText = normalizeForCompare(text);
                    
                    // First try exact match
                    let found = headerScores.headers_analysis.find(h => 
                        h.tag.toLowerCase() === tag.toLowerCase() && 
                        normalizeForCompare(h.text) === normalizedText
                    );
                    
                    // If no exact match, try partial match (one contains the other)
                    if (!found) {
                        found = headerScores.headers_analysis.find(h => 
                            h.tag.toLowerCase() === tag.toLowerCase() && 
                            (normalizeForCompare(h.text).includes(normalizedText) || 
                             normalizedText.includes(normalizeForCompare(h.text)))
                        );
                    }
                    
                    return found || null;
                }
                
                // Helper to render score badge with info icon
                function renderScoreBadge(score, scoreData) {
                    if (score === null || score === undefined) return '';
                    const color = score >= 8 ? '#10b981' : score >= 6 ? '#f59e0b' : score >= 4 ? '#fb923c' : '#ef4444';
                    
                    // Build tooltip content with clear sections using HTML
                    let tooltipHtml = '';
                    
                    // Section 1: What affected the score
                    if (scoreData && scoreData.notes && scoreData.notes.length > 0) {
                        const positiveNotes = scoreData.notes.filter(n => n.includes('(+'));
                        const negativeNotes = scoreData.notes.filter(n => n.includes('(-') || n.includes('🔴') || n.includes('🟠') || n.includes('⚠️'));
                        
                        if (positiveNotes.length > 0) {
                            tooltipHtml += '<div style="color: #10b981; margin-bottom: 6px;"><strong>✅ חיובי:</strong></div>';
                            positiveNotes.forEach(n => {
                                tooltipHtml += '<div style="margin-right: 8px; margin-bottom: 2px;">• ' + n + '</div>';
                            });
                        }
                        
                        if (negativeNotes.length > 0) {
                            tooltipHtml += '<div style="color: #ef4444; margin-top: 8px; margin-bottom: 6px;"><strong>❌ מוריד ציון:</strong></div>';
                            negativeNotes.forEach(n => {
                                tooltipHtml += '<div style="margin-right: 8px; margin-bottom: 2px;">• ' + n + '</div>';
                            });
                        }
                    }
                    
                    // Section 2: How to improve
                    if (scoreData && scoreData.suggestion && scoreData.suggestion.message) {
                        tooltipHtml += '<div style="color: #fcd34d; margin-top: 10px; margin-bottom: 6px; border-top: 1px solid #374151; padding-top: 8px;"><strong>💡 מה לעשות:</strong></div>';
                        tooltipHtml += '<div style="margin-right: 8px;">' + scoreData.suggestion.message + '</div>';
                        if (scoreData.suggestion.example) {
                            tooltipHtml += '<div style="margin-right: 8px; margin-top: 4px; color: #9ca3af;">📝 ' + scoreData.suggestion.example + '</div>';
                        }
                    }
                    
                    // If no specific suggestion but score is low, add generic advice
                    if (score < 6 && (!scoreData?.suggestion)) {
                        tooltipHtml += '<div style="color: #fcd34d; margin-top: 10px; margin-bottom: 6px; border-top: 1px solid #374151; padding-top: 8px;"><strong>💡 מה לעשות:</strong></div>';
                        if (scoreData?.issues?.includes('Critical Spam') || scoreData?.issues?.includes('High Spam')) {
                            tooltipHtml += '<div style="margin-right: 8px;">הסר את מילת המפתח מכותרת זו או נסח מחדש</div>';
                        }
                    }
                    
                    const tooltipContent = tooltipHtml;
                    
                    // Use a unique ID for tooltip management
                    const tooltipId = 'tip_' + Math.random().toString(36).substr(2, 9);
                    
                    return `<span style="display: inline-flex; align-items: center; gap: 2px;">
                        <span style="background: ${color}20; color: ${color}; padding: 1px 6px; border-radius: 10px; font-size: 0.65rem; font-weight: bold;">${score}/10</span>
                        ${tooltipContent ? `<span class="info-tooltip-trigger" style="cursor: help;" 
                            onmouseenter="showFloatingTooltip(event, '${tooltipId}')" 
                            onmouseleave="hideFloatingTooltip('${tooltipId}')">
                            <span style="background: ${color}40; color: ${color}; width: 14px; height: 14px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 0.55rem; font-weight: bold;">i</span>
                            <div id="${tooltipId}" class="floating-tooltip" style="display: none; position: fixed; background: #1f2937; border: 1px solid ${color}; padding: 10px 12px; border-radius: 8px; font-size: 0.7rem; min-width: 250px; max-width: 320px; z-index: 999999; box-shadow: 0 8px 24px rgba(0,0,0,0.5); text-align: right; line-height: 1.5; color: #e5e7eb; direction: rtl;">${tooltipContent}</div>
                        </span>` : ''}
                    </span>`;
                }
                
                // Helper to render suggestion tooltip (only for low scores)
                function renderSuggestion(scoreData) {
                    // Only show suggestions for headers with score < 7
                    if (!scoreData || !scoreData.suggestion || scoreData.score >= 7) return '';
                    const sug = scoreData.suggestion;
                    const bgColor = scoreData.score < 4 ? 'rgba(239,68,68,0.15)' : 'rgba(245,158,11,0.15)';
                    const borderColor = scoreData.score < 4 ? '#ef4444' : '#f59e0b';
                    return `<div style="background: ${bgColor}; border-right: 2px solid ${borderColor}; padding: 4px 8px; margin-top: 4px; border-radius: 4px; font-size: 0.65rem;">
                        <span style="color: ${scoreData.score < 4 ? '#fca5a5' : '#fcd34d'};">💡 ${sug.message}</span>
                        ${sug.example ? `<div style="color: #9ca3af; margin-top: 2px; direction: ltr; text-align: right;">${sug.example}</div>` : ''}
                    </div>`;
                }
                
                function getHeadingsList(headings) {
                    if (!headings) return { h1s: [], h2s: [], h3s: [], h4s: [], h5s: [], h6s: [] };
                    return {
                        h1s: headings.h1s || [],
                        h2s: headings.h2s || [],
                        h3s: headings.h3s || [],
                        h4s: headings.h4s || [],
                        h5s: headings.h5s || [],
                        h6s: headings.h6s || []
                    };
                }
                
                const oldHeadings = oldA.available ? getHeadingsList(oldA.headings) : null;
                const newHeadings = newA.available ? getHeadingsList(newA.headings) : null;
                
                // Hierarchy summary
                function getHierarchySummary(headings) {
                    if (!headings) return null;
                    
                    const counts = {
                        h1: headings.h1s.length,
                        h2: headings.h2s.length,
                        h3: headings.h3s.length,
                        h4: headings.h4s.length,
                        h5: headings.h5s.length,
                        h6: headings.h6s.length
                    };
                    
                    const total = Object.values(counts).reduce((a, b) => a + b, 0);
                    
                    // Check hierarchy issues
                    const issues = [];
                    if (counts.h1 === 0) issues.push('❌ חסר H1');
                    if (counts.h1 > 1) issues.push('⚠️ יותר מ-H1 אחד');
                    if (counts.h2 === 0 && total > 1) issues.push('⚠️ חסר H2');
                    if (counts.h3 > 0 && counts.h2 === 0) issues.push('❌ יש H3 בלי H2');
                    if (counts.h4 > 0 && counts.h3 === 0) issues.push('❌ יש H4 בלי H3');
                    
                    return { counts, total, issues };
                }
                
                const oldSummary = getHierarchySummary(oldHeadings);
                const newSummary = getHierarchySummary(newHeadings);
                
                function renderHeadingsList(headings, label) {
                    if (!headings) return '<span style="color: #6b7280;">לא זמין</span>';
                    
                    let html = '';
                    
                    // Helper to escape text for onclick
                    function escapeForJs(str) {
                        return str.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"').replace(/\n/g, '\\n');
                    }
                    
                    // H1
                    if (headings.h1s.length > 0) {
                        html += `<div style="margin-bottom: 0.5rem;"><strong style="color: #f59e0b;">H1:</strong></div>`;
                        headings.h1s.forEach((h, idx) => {
                            const has = hasKeyword(h);
                            const escaped = escapeForJs(h);
                            const scoreData = findHeaderScore(h, 'H1');
                            const score = scoreData ? scoreData.score : null;
                            
                            // Debug logging for first few headers
                            if (idx === 0) {
                                console.log('🔍 H1 Score Match Debug:', {
                                    headingText: h.substring(0, 50),
                                    scoreFound: !!scoreData,
                                    score: score,
                                    availableH1s: headerScores?.headers_analysis?.filter(x => x.tag === 'H1').map(x => x.text.substring(0, 50))
                                });
                            }
                            const borderColor = score !== null ? (score >= 6 ? '#10b981' : score >= 4 ? '#f59e0b' : '#ef4444') : (has ? '#10b981' : '#6b7280');
                            
                            html += `<div style="padding: 4px 8px; margin: 2px 0; background: ${has ? 'rgba(16,185,129,0.15)' : 'rgba(255,255,255,0.05)'}; border-radius: 4px; font-size: 0.75rem; border-right: 3px solid ${borderColor};">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="flex: 1;">${has ? '✅' : '⬜'} ${h} ${renderScoreBadge(score, scoreData)}</span>
                                    <button type="button" onclick="editHeading('h1', ${idx}, '${escaped}', event)" style="background: #4b5563; border: none; color: white; padding: 2px 8px; border-radius: 4px; cursor: pointer; font-size: 0.65rem;">✏️ ערוך</button>
                                </div>
                            </div>`;
                        });
                    }
                    
                    // H2
                    if (headings.h2s.length > 0) {
                        const withKw = headings.h2s.filter(h => hasKeyword(h)).length;
                        const pct = ((withKw / headings.h2s.length) * 100).toFixed(0);
                        const isSpam = pct > 50;
                        
                        // Calculate average H2 score if available
                        let avgH2Score = null;
                        if (headerScores && headerScores.headers_analysis) {
                            const h2Scores = headerScores.headers_analysis.filter(h => h.tag === 'H2' && h.score !== undefined);
                            if (h2Scores.length > 0) {
                                avgH2Score = (h2Scores.reduce((sum, h) => sum + h.score, 0) / h2Scores.length).toFixed(1);
                            }
                        }
                        
                        html += `<div style="margin: 0.75rem 0 0.5rem 0;">
                            <strong style="color: #60a5fa;">H2:</strong> 
                            <span style="color: ${isSpam ? '#ef4444' : pct > 40 ? '#f59e0b' : '#10b981'};">
                                ${withKw}/${headings.h2s.length} (${pct}%) ${isSpam ? '🔴 ספאם!' : pct > 40 ? '⚠️' : '✅'}
                            </span>
                            ${avgH2Score !== null ? `<span style="margin-right: 8px; color: #a78bfa; font-size: 0.7rem;">| ממוצע ציון: ${avgH2Score}/10</span>` : ''}
                        </div>`;
                        headings.h2s.forEach((h, idx) => {
                            const has = hasKeyword(h);
                            const escaped = escapeForJs(h);
                            const scoreData = findHeaderScore(h, 'H2');
                            const score = scoreData ? scoreData.score : null;
                            const borderColor = score !== null ? (score >= 6 ? '#10b981' : score >= 4 ? '#f59e0b' : '#ef4444') : (has ? '#ef4444' : '#6b7280');
                            const bgColor = score !== null && score < 6 ? 'rgba(239,68,68,0.15)' : (has ? 'rgba(239,68,68,0.1)' : 'rgba(255,255,255,0.05)');
                            
                            html += `<div style="padding: 4px 8px; margin: 2px 0; background: ${bgColor}; border-radius: 4px; font-size: 0.75rem; border-right: 3px solid ${borderColor};">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="flex: 1;">${has ? '🔴' : '⬜'} ${h} ${renderScoreBadge(score, scoreData)}</span>
                                    <button type="button" onclick="editHeading('h2', ${idx}, '${escaped}', event)" style="background: #4b5563; border: none; color: white; padding: 2px 8px; border-radius: 4px; cursor: pointer; font-size: 0.65rem;">✏️ ערוך</button>
                                </div>
                            </div>`;
                        });
                    }
                    
                    // H3
                    if (headings.h3s.length > 0) {
                        const withKw = headings.h3s.filter(h => hasKeyword(h)).length;
                        const pct = ((withKw / headings.h3s.length) * 100).toFixed(0);
                        
                        // Calculate average H3 score if available
                        let avgH3Score = null;
                        if (headerScores && headerScores.headers_analysis) {
                            const h3Scores = headerScores.headers_analysis.filter(h => h.tag === 'H3' && h.score !== undefined);
                            if (h3Scores.length > 0) {
                                avgH3Score = (h3Scores.reduce((sum, h) => sum + h.score, 0) / h3Scores.length).toFixed(1);
                            }
                        }
                        
                        html += `<div style="margin: 0.75rem 0 0.5rem 0;">
                            <strong style="color: #a78bfa;">H3:</strong> 
                            <span style="color: ${pct > 40 ? '#f59e0b' : '#10b981'};">
                                ${withKw}/${headings.h3s.length} (${pct}%)
                            </span>
                            ${avgH3Score !== null ? `<span style="margin-right: 8px; color: #6b7280; font-size: 0.7rem;">| ממוצע ציון: ${avgH3Score}/10</span>` : ''}
                        </div>`;
                        headings.h3s.slice(0, 15).forEach((h, idx) => {
                            const has = hasKeyword(h);
                            const escaped = escapeForJs(h);
                            const scoreData = findHeaderScore(h, 'H3');
                            const score = scoreData ? scoreData.score : null;
                            const borderColor = score !== null ? (score >= 6 ? '#10b981' : score >= 4 ? '#f59e0b' : '#ef4444') : (has ? '#f59e0b' : '#6b7280');
                            
                            html += `<div style="padding: 4px 8px; margin: 2px 0; background: ${has ? 'rgba(245,158,11,0.1)' : 'rgba(255,255,255,0.05)'}; border-radius: 4px; font-size: 0.7rem; border-right: 3px solid ${borderColor};">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="flex: 1;">${has ? '⚠️' : '⬜'} ${h} ${renderScoreBadge(score, scoreData)}</span>
                                    <button type="button" onclick="editHeading('h3', ${idx}, '${escaped}', event)" style="background: #4b5563; border: none; color: white; padding: 2px 6px; border-radius: 4px; cursor: pointer; font-size: 0.6rem;">✏️</button>
                                </div>
                            </div>`;
                        });
                        if (headings.h3s.length > 15) {
                            html += `<div style="color: #6b7280; font-size: 0.7rem; padding: 4px;">...ועוד ${headings.h3s.length - 15} כותרות</div>`;
                        }
                    }
                    
                    // H4-H6 (collapsed)
                    const otherHeadings = [...(headings.h4s || []), ...(headings.h5s || []), ...(headings.h6s || [])];
                    if (otherHeadings.length > 0) {
                        html += `<div style="margin: 0.75rem 0 0.5rem 0;">
                            <strong style="color: #6b7280;">H4-H6:</strong> 
                            <span style="color: #6b7280;">${otherHeadings.length} כותרות</span>
                        </div>`;
                        otherHeadings.slice(0, 5).forEach(h => {
                            html += `<div style="padding: 4px 8px; margin: 2px 0; background: rgba(255,255,255,0.03); border-radius: 4px; font-size: 0.65rem; color: #6b7280;">
                                ${h}
                            </div>`;
                        });
                        if (otherHeadings.length > 5) {
                            html += `<div style="color: #6b7280; font-size: 0.65rem; padding: 4px;">...ועוד ${otherHeadings.length - 5}</div>`;
                        }
                    }
                    
                    return html || '<span style="color: #6b7280;">אין כותרות</span>';
                }
                
                // Hierarchy comparison bar
                function renderHierarchyBar(summary, label, color) {
                    if (!summary) return `<div style="color: #6b7280;">לא זמין</div>`;
                    
                    const c = summary.counts;
                    return `
                        <div style="background: rgba(0,0,0,0.2); padding: 0.5rem; border-radius: 6px;">
                            <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 0.5rem;">
                                <span style="background: #f59e0b; color: #1a1a2e; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold;">
                                    H1: ${c.h1}
                                </span>
                                <span style="background: #60a5fa; color: #1a1a2e; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold;">
                                    H2: ${c.h2}
                                </span>
                                <span style="background: #a78bfa; color: #1a1a2e; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold;">
                                    H3: ${c.h3}
                                </span>
                                ${c.h4 > 0 ? `<span style="background: #6b7280; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem;">H4: ${c.h4}</span>` : ''}
                                ${c.h5 > 0 ? `<span style="background: #6b7280; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem;">H5: ${c.h5}</span>` : ''}
                                ${c.h6 > 0 ? `<span style="background: #6b7280; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem;">H6: ${c.h6}</span>` : ''}
                                <span style="color: #9ca3af; font-size: 0.75rem;">סה"כ: ${summary.total}</span>
                            </div>
                            ${summary.issues.length > 0 ? `
                                <div style="font-size: 0.7rem; color: #f59e0b;">
                                    ${summary.issues.join(' | ')}
                                </div>
                            ` : `<div style="font-size: 0.7rem; color: #10b981;">✅ היררכיה תקינה</div>`}
                        </div>
                    `;
                }
                
                // Return content directly - parent section handles the expandable wrapper
                return `
                    <!-- Hierarchy Summary -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 0.5rem;">
                        <div>
                            <div style="font-weight: bold; color: #9ca3af; margin-bottom: 0.25rem; font-size: 0.8rem;">📄 היררכיה ישנה</div>
                            ${renderHierarchyBar(oldSummary, 'old', '#9ca3af')}
                        </div>
                        <div>
                            <div style="font-weight: bold; color: #10b981; margin-bottom: 0.25rem; font-size: 0.8rem;">✨ היררכיה חדשה</div>
                            ${renderHierarchyBar(newSummary, 'new', '#10b981')}
                        </div>
                    </div>
                    
                    <!-- Detailed Headings List -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                        <div style="background: rgba(156,163,175,0.1); padding: 0.75rem; border-radius: 6px; max-height: 400px; overflow-y: auto;">
                            <div style="font-weight: bold; color: #9ca3af; margin-bottom: 0.5rem;">📄 כותרות ישנות</div>
                            ${renderHeadingsList(oldHeadings, 'old')}
                        </div>
                        <div style="background: rgba(16,185,129,0.1); padding: 0.75rem; border-radius: 6px; max-height: 400px; overflow-y: auto;">
                            <div style="font-weight: bold; color: #10b981; margin-bottom: 0.5rem;">✨ כותרות חדשות</div>
                            ${renderHeadingsList(newHeadings, 'new')}
                        </div>
                    </div>
                    <div style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 0.5rem;">
                        🔴 = מכיל מילת מפתח | ⬜ = ללא מילת מפתח
                    </div>
                `;
            } catch (e) {
                console.error('Error in headings detail:', e);
                return '';
            }
        }
        
        // Content generator for bold spam (used inside expandable section)
        function generateBoldSpamContent(analysis, keyword) {
            if (!analysis.boldItems || analysis.boldItems.length === 0) {
                return '<p style="color: #10b981;">✅ לא נמצאו הדגשות</p>';
            }
            
            const boldItems = analysis.boldItems;
            const boldPercentage = parseFloat(analysis.boldPercentage) || 0;
            const keywordLower = keyword?.toLowerCase() || '';
            
            // Detect suspicious bolds
            const suspiciousBolds = [];
            
            boldItems.forEach((bold, idx) => {
                const reasons = [];
                const boldLower = bold.text.toLowerCase();
                
                if (bold.isSingleWord && keywordLower) {
                    const keywordWords = keywordLower.split(/\s+/);
                    for (const kw of keywordWords) {
                        if (kw.length > 2 && boldLower.includes(kw)) {
                            reasons.push('מילת מפתח בודדת');
                            break;
                        }
                    }
                }
                
                if (bold.wordCount <= 2 && bold.text.length < 20) {
                    const keywordPatterns = ['הלוואה', 'מימון', 'אשראי', 'הלוואות', 'ריבית', 'בנק'];
                    for (const pattern of keywordPatterns) {
                        if (boldLower.includes(pattern)) {
                            reasons.push('מילה פיננסית קצרה');
                            break;
                        }
                    }
                }
                
                if (keywordLower && (boldLower === keywordLower || boldLower.includes(keywordLower))) {
                    reasons.push('מילת מפתח ראשית');
                }
                
                if (reasons.length > 0) {
                    suspiciousBolds.push({ ...bold, index: idx, reasons });
                }
            });
            
            let html = `
                <div style="display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 0.75rem; font-size: 0.9rem;">
                    <span><strong>סה"כ:</strong> ${boldItems.length}</span>
                    <span><strong>אחוז מודגש:</strong> 
                        <span class="seo-summary-badge ${boldPercentage > 5 ? 'bad' : boldPercentage > 3 ? 'warning' : 'good'}">
                            ${boldPercentage}%
                        </span>
                    </span>
                    <span><strong>חשודות:</strong> 
                        <span class="seo-summary-badge ${suspiciousBolds.length > 0 ? 'bad' : 'good'}">
                            ${suspiciousBolds.length}
                        </span>
                    </span>
                </div>
            `;
            
            if (suspiciousBolds.length > 0) {
                html += `
                    <div style="background: rgba(239, 68, 68, 0.15); border-radius: 6px; padding: 0.75rem; margin-bottom: 0.75rem;">
                        <div style="font-size: 0.8rem; color: #fbbf24; margin-bottom: 0.5rem;">
                            לפי כללי SEO: לא להדגיש מילות מפתח בודדות
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 6px;">
                            ${suspiciousBolds.map(bold => `
                                <div class="seo-heading-item has-keyword" style="border-right-color: #ef4444; padding: 8px;">
                                    <div style="flex: 1;">
                                        <div style="font-size: 0.75rem; direction: rtl; margin-bottom: 4px;">
                                            <span style="color: #6b7280;">${bold.contextBefore ? `...${bold.contextBefore} ` : ''}</span>
                                            <span style="background: #fef08a; color: #1f2937; padding: 1px 4px; border-radius: 2px; font-weight: bold;">${bold.text}</span>
                                            <span style="color: #6b7280;">${bold.contextAfter ? ` ${bold.contextAfter}...` : ''}</span>
                                        </div>
                                        <span style="font-size: 0.7rem; color: #f87171;">📛 ${bold.reasons.join(', ')}</span>
                                    </div>
                                    <button type="button" onclick="removeBoldWithContext('${encodeURIComponent(bold.text)}', '${encodeURIComponent(bold.contextBefore || '')}', '${encodeURIComponent(bold.contextAfter || '')}', event)" class="seo-edit-btn" style="background: #f97316;">
                                        🔓 הסר
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else {
                html += `<div style="color: #10b981; margin-bottom: 0.5rem;">✅ אין הדגשות חשודות</div>`;
            }
            
            // All bolds list (collapsed) - with context for identification
            html += `
                <details>
                    <summary style="cursor: pointer; font-size: 0.85rem; color: var(--text-secondary);">
                        📋 כל ההדגשות (${boldItems.length})
                    </summary>
                    <div style="max-height: 300px; overflow-y: auto; margin-top: 0.5rem;">
                        ${boldItems.slice(0, 30).map((bold, idx) => `
                            <div class="seo-heading-item" style="display: flex; align-items: center; gap: 8px; padding: 6px; margin: 4px 0; background: rgba(255,255,255,0.03); border-radius: 4px;">
                                <div style="flex: 1; font-size: 0.75rem; direction: rtl;">
                                    <span style="color: #6b7280;">${bold.contextBefore ? `...${bold.contextBefore} ` : ''}</span>
                                    <span style="background: #fef08a; color: #1f2937; padding: 1px 4px; border-radius: 2px; font-weight: bold;">${bold.text}</span>
                                    <span style="color: #6b7280;">${bold.contextAfter ? ` ${bold.contextAfter}...` : ''}</span>
                                </div>
                                <button type="button" onclick="removeBoldWithContext('${encodeURIComponent(bold.text)}', '${encodeURIComponent(bold.contextBefore || '')}', '${encodeURIComponent(bold.contextAfter || '')}', event)" 
                                        style="background: #374151; color: white; border: none; padding: 2px 8px; border-radius: 4px; cursor: pointer; font-size: 0.65rem; white-space: nowrap;">
                                    הסר
                                </button>
                            </div>
                        `).join('')}
                        ${boldItems.length > 30 ? `<div style="color: var(--text-secondary); font-size: 0.8rem; padding: 0.5rem;">...ועוד ${boldItems.length - 30}</div>` : ''}
                    </div>
                </details>
            `;
            
            return html;
        }
        
        // Legacy function (kept for backward compatibility)
        function generateBoldSpamAnalysis(analysis, keyword) {
            if (!analysis.boldItems || analysis.boldItems.length === 0) {
                return '<div class="seo-section"><h5>🔤 הדגשות (Bold)</h5><p style="color: #10b981;">✅ לא נמצאו הדגשות</p></div>';
            }
            
            const boldItems = analysis.boldItems;
            const boldPercentage = parseFloat(analysis.boldPercentage) || 0;
            const keywordLower = keyword?.toLowerCase() || '';
            
            // Detect suspicious bolds
            const suspiciousBolds = [];
            
            boldItems.forEach((bold, idx) => {
                const reasons = [];
                const boldLower = bold.text.toLowerCase();
                
                // Check 1: Single word bold containing keyword
                if (bold.isSingleWord && keywordLower) {
                    const keywordWords = keywordLower.split(/\s+/);
                    for (const kw of keywordWords) {
                        if (kw.length > 2 && boldLower.includes(kw)) {
                            reasons.push('מילת מפתח בודדת מודגשת');
                            break;
                        }
                    }
                }
                
                // Check 2: Very short bold (1-2 words that look like keyword stuffing)
                if (bold.wordCount <= 2 && bold.text.length < 20) {
                    // Check if it's a common keyword pattern
                    const keywordPatterns = ['הלוואה', 'מימון', 'אשראי', 'הלוואות', 'ריבית', 'בנק'];
                    for (const pattern of keywordPatterns) {
                        if (boldLower.includes(pattern)) {
                            reasons.push('מילה פיננסית קצרה מודגשת (חשד לספאם)');
                            break;
                        }
                    }
                }
                
                // Check 3: Keyword exact match
                if (keywordLower && (boldLower === keywordLower || boldLower.includes(keywordLower))) {
                    reasons.push('מילת המפתח הראשית מודגשת');
                }
                
                if (reasons.length > 0) {
                    suspiciousBolds.push({
                        ...bold,
                        index: idx,
                        reasons: reasons
                    });
                }
            });
            
            // Build HTML
            let html = `
                <div class="seo-section" style="background: var(--bg-tertiary); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                    <h5>🔤 ניתוח הדגשות (Bold Spam)</h5>
                    
                    <div style="display: flex; flex-wrap: wrap; gap: 1.5rem; margin-bottom: 1rem;">
                        <div><strong>סה"כ הדגשות:</strong> ${boldItems.length}</div>
                        <div><strong>אחוז טקסט מודגש:</strong> 
                            <span class="${boldPercentage > 5 ? 'seo-bad' : boldPercentage > 3 ? 'seo-warning' : 'seo-good'}">
                                ${boldPercentage}%
                            </span>
                            ${boldPercentage > 5 ? '<span style="color: #ef4444;"> (מעל 5% = ספאם!)</span>' : ''}
                        </div>
                        <div><strong>חשודות:</strong> 
                            <span style="color: ${suspiciousBolds.length > 0 ? '#ef4444' : '#10b981'};">
                                ${suspiciousBolds.length}
                            </span>
                        </div>
                    </div>
            `;
            
            // Suspicious bolds section
            if (suspiciousBolds.length > 0) {
                html += `
                    <div style="background: rgba(239, 68, 68, 0.2); border: 1px solid #ef4444; border-radius: 6px; padding: 0.75rem; margin-bottom: 1rem;">
                        <h6 style="color: #ef4444; margin: 0 0 0.5rem 0;">⚠️ נמצאו ${suspiciousBolds.length} הדגשות חשודות!</h6>
                        <div style="font-size: 0.75rem; color: #fbbf24; margin-bottom: 0.5rem;">
                            לפי כללי SEO: לא להדגיש מילות מפתח בודדות, רק משפטים שלמים בעלי ערך לקורא
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 6px;">
                            ${suspiciousBolds.map(bold => `
                                <div style="background: rgba(0,0,0,0.2); padding: 8px; border-radius: 4px; border-right: 3px solid #ef4444;">
                                    <div style="font-size: 0.75rem; color: #9ca3af; direction: rtl; margin-bottom: 4px;">
                                        ${bold.contextBefore ? `<span style="color: #6b7280;">...${bold.contextBefore}</span>` : ''}
                                        <span style="background: #fef08a; color: #1f2937; padding: 1px 4px; border-radius: 2px; font-weight: bold;">${bold.text}</span>
                                        ${bold.contextAfter ? `<span style="color: #6b7280;">${bold.contextAfter}...</span>` : ''}
                                    </div>
                                    <div style="font-size: 0.7rem; color: #f87171; margin-bottom: 4px;">
                                        📛 ${bold.reasons.join(' | ')}
                                    </div>
                                    <button type="button" onclick="removeBoldWithContext('${encodeURIComponent(bold.text)}', '${encodeURIComponent(bold.contextBefore || '')}', '${encodeURIComponent(bold.contextAfter || '')}', event)" 
                                            style="background: #f97316; color: white; border: none; padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">
                                        🔓 הסר הדגשה
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else {
                html += `<div style="color: #10b981; margin-bottom: 1rem;">✅ לא נמצאו הדגשות חשודות</div>`;
            }
            
            // All bolds list (collapsible) - with context
            html += `
                <details>
                    <summary style="cursor: pointer; font-weight: bold; padding: 0.5rem; background: rgba(251, 191, 36, 0.1); border-radius: 4px;">
                        📋 כל ההדגשות (${boldItems.length})
                    </summary>
                    <div style="max-height: 300px; overflow-y: auto; margin-top: 0.5rem;">
                        ${boldItems.slice(0, 30).map((b, idx) => `
                            <div style="display: flex; align-items: center; gap: 8px; padding: 6px; margin: 4px 0; background: rgba(255,255,255,0.03); border-radius: 4px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <div style="flex: 1; font-size: 0.75rem; direction: rtl;">
                                    <span style="color: #6b7280;">${b.contextBefore ? `...${b.contextBefore} ` : ''}</span>
                                    <span style="background: #fef08a; color: #1f2937; padding: 1px 4px; border-radius: 2px; font-weight: bold;">${b.text}</span>
                                    <span style="color: #6b7280;">${b.contextAfter ? ` ${b.contextAfter}...` : ''}</span>
                                </div>
                                <button type="button" onclick="removeBoldWithContext('${encodeURIComponent(b.text)}', '${encodeURIComponent(b.contextBefore || '')}', '${encodeURIComponent(b.contextAfter || '')}', event)" 
                                        style="background: #374151; color: white; border: none; padding: 2px 8px; border-radius: 4px; cursor: pointer; font-size: 0.65rem; white-space: nowrap;">
                                    הסר
                                </button>
                            </div>
                        `).join('')}
                        ${boldItems.length > 30 ? `<div style="color: #9ca3af; font-size: 0.8rem; padding: 0.5rem;">...ועוד ${boldItems.length - 30}</div>` : ''}
                    </div>
                </details>
            `;
            
            html += '</div>';
            return html;
        }
        
        async function removeBoldFormatting(encodedText, index, event) {
            // Prevent any default behavior
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            const text = decodeURIComponent(encodedText);
            
            if (!confirm(`האם להסיר את ההדגשה מ: "${text}"?`)) {
                return;
            }
            
            try {
                const pageFolder = getPageFolder(selectedPage.path);
                showToast('מסיר הדגשה...', 'info');
                
                const response = await fetch('/api/page/remove-bold', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        page_folder: pageFolder,
                        bold_text: text,
                        occurrence_index: index
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    // Show context of what was removed
                    const removedText = result.removed_text || text;
                    const before = result.context_before ? `...${result.context_before}` : '';
                    const after = result.context_after ? `${result.context_after}...` : '';
                    const contextMsg = before || after ? `\n📍 הוסר מ: ${before} [${removedText}] ${after}` : '';
                    
                    showToast(`✅ ההדגשה הוסרה ונשמרה!${contextMsg}`, 'success');
                    console.log(`🔓 Bold removed: "${removedText}"`);
                    console.log(`   Context: ${before} [${removedText}] ${after}`);
                    
                    if (typeof refreshNewContentPreview === 'function') {
                        await refreshNewContentPreview();
                    }
                } else {
                    showToast('שגיאה: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error removing bold:', error);
                showToast('שגיאה בהסרת ההדגשה', 'error');
            }
        }
        
        // New function: Remove bold using context for precise matching
        async function removeBoldWithContext(encodedText, encodedContextBefore, encodedContextAfter, event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            const text = decodeURIComponent(encodedText);
            const contextBefore = decodeURIComponent(encodedContextBefore);
            const contextAfter = decodeURIComponent(encodedContextAfter);
            
            // Show preview of what will be removed
            const preview = `${contextBefore ? '...' + contextBefore + ' ' : ''}[${text}]${contextAfter ? ' ' + contextAfter + '...' : ''}`;
            if (!confirm(`האם להסיר את ההדגשה?\n\n${preview}`)) {
                return;
            }
            
            try {
                const pageFolder = getPageFolder(selectedPage.path);
                showToast('מסיר הדגשה...', 'info');
                
                const response = await fetch('/api/page/remove-bold', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        page_folder: pageFolder,
                        bold_text: text,
                        context_before: contextBefore,
                        context_after: contextAfter
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    const removedText = result.removed_text || text;
                    showToast(`✅ ההדגשה "${removedText}" הוסרה בהצלחה!`, 'success');
                    console.log(`🔓 Bold removed with context: "${removedText}"`);
                    
                    if (typeof refreshNewContentPreview === 'function') {
                        await refreshNewContentPreview();
                    }
                } else {
                    showToast('שגיאה: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error removing bold:', error);
                showToast('שגיאה בהסרת ההדגשה', 'error');
            }
        }
        
        function generateColumnReport(analysis) {
            const ka = analysis.keywordAnalysis || {};
            const densityClass = getDensityClass(ka.density);
            const h2PercentClass = getH2PercentClass(ka.h2KeywordPercent);
            
            return `
                <div class="seo-section">
                    <h5>📊 צפיפות מילת מפתח</h5>
                    <div class="seo-metric">
                        <span class="seo-metric-label">צפיפות כללית:</span>
                        <span class="seo-metric-value ${densityClass}">${ka.density}%</span>
                    </div>
                    <div class="seo-metric">
                        <span class="seo-metric-label">מספר הופעות:</span>
                        <span class="seo-metric-value">${ka.totalCount}</span>
                    </div>
                    <div class="seo-metric">
                        <span class="seo-metric-label">מילת מפתח ב-H1:</span>
                        <span class="seo-metric-value ${ka.keywordInH1 ? 'good' : 'bad'}">${ka.keywordInH1 ? '✅ כן' : '❌ לא'}</span>
                    </div>
                    <div class="seo-metric">
                        <span class="seo-metric-label">מילת מפתח ב-H2:</span>
                        <span class="seo-metric-value ${h2PercentClass}">${ka.keywordInH2}/${ka.h2Count} (${ka.h2KeywordPercent}%)</span>
                    </div>
                </div>
                
                <div class="seo-section">
                    <h5>📝 סטטיסטיקות תוכן</h5>
                    <div class="seo-metric">
                        <span class="seo-metric-label">מספר מילים:</span>
                        <span class="seo-metric-value">${analysis.wordCount.toLocaleString()}</span>
                    </div>
                    <div class="seo-metric">
                        <span class="seo-metric-label">פסקאות:</span>
                        <span class="seo-metric-value">${analysis.paragraphCount}</span>
                    </div>
                    <div class="seo-metric">
                        <span class="seo-metric-label">טקסט מודגש:</span>
                        <span class="seo-metric-value">${analysis.boldCount}</span>
                    </div>
                </div>
                
                <div class="seo-section">
                    <h5>🔗 קישורים</h5>
                    <div class="seo-metric">
                        <span class="seo-metric-label">קישורים פנימיים:</span>
                        <span class="seo-metric-value">${analysis.links.internal}</span>
                    </div>
                    <div class="seo-metric">
                        <span class="seo-metric-label">קישורים חיצוניים:</span>
                        <span class="seo-metric-value">${analysis.links.external}</span>
                    </div>
                </div>
                
                <div class="seo-section">
                    <h5>🖼️ תמונות</h5>
                    <div class="seo-metric">
                        <span class="seo-metric-label">סה"כ תמונות:</span>
                        <span class="seo-metric-value">${analysis.images.total}</span>
                    </div>
                    <div class="seo-metric">
                        <span class="seo-metric-label">עם Alt Text:</span>
                        <span class="seo-metric-value ${analysis.images.withAlt === analysis.images.total ? 'good' : 'warning'}">${analysis.images.withAlt}/${analysis.images.total}</span>
                    </div>
                </div>
                
                <div class="seo-section">
                    <h5>📑 מבנה כותרות</h5>
                    <div class="seo-metric">
                        <span class="seo-metric-label">H1:</span>
                        <span class="seo-metric-value ${analysis.headingCount.h1 === 1 ? 'good' : 'bad'}">${analysis.headingCount.h1}</span>
                    </div>
                    <div class="seo-metric">
                        <span class="seo-metric-label">H2:</span>
                        <span class="seo-metric-value">${analysis.headingCount.h2}</span>
                    </div>
                    <div class="seo-metric">
                        <span class="seo-metric-label">H3:</span>
                        <span class="seo-metric-value">${analysis.headingCount.h3}</span>
                    </div>
                    <div class="heading-structure">
                        ${analysis.headings.h1s.map(h => `<div class="heading-item h1">H1: ${h}</div>`).join('')}
                        ${analysis.headings.h2s.map(h => `<div class="heading-item h2">H2: ${h}</div>`).join('')}
                        ${analysis.headings.h3s.slice(0, 5).map(h => `<div class="heading-item h3">H3: ${h}</div>`).join('')}
                        ${analysis.headings.h3s.length > 5 ? `<div class="heading-item h3">... ועוד ${analysis.headings.h3s.length - 5}</div>` : ''}
                    </div>
                </div>
            `;
        }
        
        function generateComparisonSummary(oldA, newA) {
            const improvements = [];
            const warnings = [];
            
            // Word count comparison
            const wordDiff = newA.wordCount - oldA.wordCount;
            if (wordDiff > 100) {
                improvements.push(`✅ נוספו ${wordDiff} מילים לתוכן`);
            } else if (wordDiff < -100) {
                warnings.push(`⚠️ הוסרו ${Math.abs(wordDiff)} מילים מהתוכן`);
            }
            
            // Keyword density
            const oldDensity = parseFloat(oldA.keywordAnalysis?.density || 0);
            const newDensity = parseFloat(newA.keywordAnalysis?.density || 0);
            
            if (newDensity >= 1 && newDensity <= 2.5) {
                improvements.push(`✅ צפיפות מילת מפתח אופטימלית (${newDensity}%)`);
            } else if (newDensity > 3) {
                warnings.push(`⚠️ צפיפות מילת מפתח גבוהה מדי (${newDensity}%) - Keyword Stuffing!`);
            } else if (newDensity < 0.5) {
                warnings.push(`⚠️ צפיפות מילת מפתח נמוכה (${newDensity}%)`);
            }
            
            // H2 keyword percentage
            const newH2Percent = parseFloat(newA.keywordAnalysis?.h2KeywordPercent || 0);
            if (newH2Percent > 50) {
                warnings.push(`⚠️ מילת מפתח ב-${newH2Percent}% מכותרות H2 - יותר מדי!`);
            } else if (newH2Percent >= 20 && newH2Percent <= 40) {
                improvements.push(`✅ מילת מפתח ב-${newH2Percent}% מכותרות H2 - מאוזן`);
            }
            
            // Links
            if (newA.links.internal > oldA.links.internal) {
                improvements.push(`✅ נוספו ${newA.links.internal - oldA.links.internal} קישורים פנימיים`);
            }
            if (newA.links.external > oldA.links.external) {
                improvements.push(`✅ נוספו ${newA.links.external - oldA.links.external} קישורים חיצוניים`);
            }
            
            // Images alt
            if (newA.images.withAlt === newA.images.total && newA.images.total > 0) {
                improvements.push(`✅ כל התמונות עם Alt Text`);
            } else if (newA.images.total > 0 && newA.images.withAlt < newA.images.total) {
                warnings.push(`⚠️ ${newA.images.total - newA.images.withAlt} תמונות ללא Alt Text`);
            }
            
            return `
                <div class="seo-section" style="margin-top: 1.5rem; grid-column: 1 / -1;">
                    <h5>📋 סיכום השוואה</h5>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div style="background: rgba(16, 185, 129, 0.1); padding: 1rem; border-radius: 8px;">
                            <strong style="color: var(--success);">שיפורים:</strong>
                            <ul style="margin: 0.5rem 0 0 0; padding-right: 1.2rem;">
                                ${improvements.length > 0 ? improvements.map(i => `<li>${i}</li>`).join('') : '<li>אין שיפורים משמעותיים</li>'}
                            </ul>
                        </div>
                        <div style="background: rgba(245, 158, 11, 0.1); padding: 1rem; border-radius: 8px;">
                            <strong style="color: #f59e0b;">נקודות לתשומת לב:</strong>
                            <ul style="margin: 0.5rem 0 0 0; padding-right: 1.2rem;">
                                ${warnings.length > 0 ? warnings.map(w => `<li>${w}</li>`).join('') : '<li>הכל נראה תקין!</li>'}
                            </ul>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function getDensityClass(density) {
            const d = parseFloat(density);
            if (d >= 1 && d <= 2.5) return 'good';
            if (d > 3) return 'bad';
            if (d < 0.5) return 'warning';
            return '';
        }
        
        function getLinkRatioClass(linkCount, wordCount) {
            if (wordCount === 0) return '';
            const ratio = (linkCount / wordCount) * 100;
            if (ratio >= 1 && ratio <= 3) return 'good';  // Ideal: 1-3%
            if (ratio > 5) return 'bad';  // Too many links
            if (ratio < 0.5) return 'warning';  // Too few links
            return '';
        }
        
        function getH2PercentClass(percent) {
            const p = parseFloat(percent);
            if (p > 50) return 'bad';
            if (p >= 20 && p <= 40) return 'good';
            return '';
        }
        
        function toggleSyncScroll() {
            syncScrollEnabled = !syncScrollEnabled;
            const btn = document.getElementById('syncScrollBtn');
            if (syncScrollEnabled) {
                btn.classList.add('active');
                btn.innerHTML = '🔗 גלילה מסונכרנת';
                showToast('גלילה מסונכרנת פעילה', 'info');
            } else {
                btn.classList.remove('active');
                btn.innerHTML = '🔓 גלילה חופשית';
                showToast('גלילה חופשית פעילה', 'info');
            }
        }
        
        function setupSyncScroll() {
            const oldFrame = document.getElementById('compareOldFrame');
            const newFrame = document.getElementById('compareNewFrame');
            
            if (!oldFrame || !newFrame) return;
            
            const oldWin = oldFrame.contentWindow;
            const newWin = newFrame.contentWindow;
            
            if (!oldWin || !newWin) return;
            
            // Sync old -> new
            oldWin.addEventListener('scroll', () => {
                if (!syncScrollEnabled || syncScrolling) return;
                syncScrolling = true;
                
                const oldDoc = oldWin.document.documentElement;
                const newDoc = newWin.document.documentElement;
                
                // Calculate scroll percentage
                const scrollPercent = oldWin.scrollY / (oldDoc.scrollHeight - oldWin.innerHeight);
                const newScrollY = scrollPercent * (newDoc.scrollHeight - newWin.innerHeight);
                
                newWin.scrollTo(0, newScrollY);
                
                setTimeout(() => { syncScrolling = false; }, 50);
            });
            
            // Sync new -> old
            newWin.addEventListener('scroll', () => {
                if (!syncScrollEnabled || syncScrolling) return;
                syncScrolling = true;
                
                const oldDoc = oldWin.document.documentElement;
                const newDoc = newWin.document.documentElement;
                
                // Calculate scroll percentage
                const scrollPercent = newWin.scrollY / (newDoc.scrollHeight - newWin.innerHeight);
                const oldScrollY = scrollPercent * (oldDoc.scrollHeight - oldWin.innerHeight);
                
                oldWin.scrollTo(0, oldScrollY);
                
                setTimeout(() => { syncScrolling = false; }, 50);
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ============ Title/Description Agent ============
        async function runTitleDescriptionAgent() {
            if (!selectedPage) {
                showToast('בחר עמוד קודם', 'error');
                return;
            }

            const pagePath = selectedPage.path || '';
            // Handle both / and \ separators
            let pageDir = pagePath.substring(0, Math.max(pagePath.lastIndexOf('/'), pagePath.lastIndexOf('\\')));
            const pageInfoPath = pageDir + '/page_info.json';
            
            // Try to read keyword from page_info.json first
            let keyword = uploadState.keyword || '';
            let h1 = uploadState.h1 || '';
            
            if (!keyword) {
                try {
                    const pageInfoResult = await apiCall(`/api/file/content?path=${encodeURIComponent(pageInfoPath)}`);
                    if (pageInfoResult.content) {
                        const pageInfo = JSON.parse(pageInfoResult.content);
                        keyword = pageInfo.keyword || '';
                        console.log('Got keyword from page_info.json:', keyword);
                    }
                } catch (e) {
                    console.log('Could not read page_info.json:', e);
                }
            }
            
            // If still no keyword, ask user
            if (!keyword) {
                keyword = prompt('מהי מילת המפתח הראשית של העמוד?');
                if (!keyword) {
                    showToast('נדרשת מילת מפתח', 'error');
                    return;
                }
            }

            const currentTitle = document.getElementById('uploadTitle').value || '';
            const currentDesc = document.getElementById('uploadDescription').value || '';

            showToast('מפעיל סוכן טייטלים מנצחים...', 'info');

            // Get suffix info from config
            const site = selectedPage.site || 'main';
            const suffix = getSiteSuffix(site);
            const suffixLen = suffix ? suffix.length : 0;
            const maxTitleLen = 70 - suffixLen; // Leave room for suffix
            const hasSuffix = suffix && suffix.length > 0;

            // Build the prompt for the agent
            const agentPath = 'פרומטים/כללי/טייטלים ודסקריפשנים.md';

            // Build suffix info section
            const suffixSection = hasSuffix ? `
## 🏷️ הגדרות סיומת (SITE SUFFIX)
- **SITE_SUFFIX:** \`${suffix}\`
- **SITE_SUFFIX_LENGTH:** ${suffixLen} תווים
- **MAX_TITLE_LENGTH:** ${maxTitleLen} תווים (ללא הסיומת!)
- **🚨 חשוב מאוד:** הסיומת מתווספת אוטומטית ע"י תבנית וורדפרס!
- **❌ אל תכלול את הסיומת בכותרות שאתה יוצר!**
` : `
## 🏷️ הגדרות סיומת
- **אין סיומת קשיחה** - האורך המקסימלי הוא 60 תווים
`;

            const promptContent = `# משימה: יצירת טייטל ודסקריפשן מנצחים

## הוראות
@${agentPath}
${suffixSection}
## פרטי העמוד
- **שם העמוד:** ${selectedPage.name}
- **מילת מפתח ראשית:** ${keyword}
- **H1 נוכחי:** ${h1 || 'לא ידוע'}
- **Title נוכחי:** ${currentTitle || 'אין'}
- **Description נוכחית:** ${currentDesc || 'אין'}

## קובץ לעדכון
**חובה לעדכן את:** ${pageInfoPath}

הקובץ הזה מכיל את המטא-דאטה של העמוד. עדכן אותו עם השדות הבאים:
- \`title\` - האפשרות המומלצת (ללא סיומת!)
- \`description\` - האפשרות המומלצת  
- \`title_options\` - מערך של 3 אפשרויות עם הסברים
- \`description_options\` - מערך של 3 אפשרויות עם הסברים

## משימה
1. קרא את ${pageInfoPath}
2. צור 3 אפשרויות ל-Title ו-3 אפשרויות ל-Description לפי העקרונות בהוראות
3. עדכן את ${pageInfoPath} עם השדות החדשים
4. שמור את הקובץ

⚠️ **כללים קריטיים:**
- 🚨 מילת המפתח "${keyword}" חייבת להופיע בכל Title ובכל Description!
- 🚨 אורך Title: עד ${maxTitleLen} תווים (${hasSuffix ? 'הסיומת מתווספת אוטומטית!' : 'אין סיומת קשיחה'})
- ❌ ${hasSuffix ? 'לא לכלול את הסיומת "' + suffix + '" בכותרות!' : ''}
- אורך Description: עד 160 תווים
- לא להבטיח הבטחות שלא ניתן לקיים (כמו "כסף תוך 24 שעות")

🏁 סיום!`;

            try {
                const result = await apiCall('/api/prompt/run-agent', {
                    method: 'POST',
                    body: JSON.stringify({
                        page_path: pagePath,
                        prompt: promptContent,
                        agent_type: 'title_description',
                        page_info_path: pageInfoPath
                    })
                });

                if (result.success) {
                    showToast('✅ סוכן הופעל! עקוב אחרי ההתקדמות בטרמינל', 'success');
                    
                    // Open work status panel
                    const workStatusPanel = document.getElementById('workStatusPanel');
                    if (workStatusPanel) {
                        workStatusPanel.style.display = 'block';
                        workStatusPanel.classList.add('active');
                    }
                    
                    // Start polling for the page_info.json updates
                    pollForTitleDescReport(pageInfoPath);
                } else {
                    showToast(result.error || 'שגיאה בהפעלת הסוכן', 'error');
                }
            } catch (error) {
                console.error('Title/Desc agent error:', error);
                showToast('שגיאה בהפעלת סוכן הטייטלים', 'error');
            }
        }

        async function pollForTitleDescReport(pageInfoPath) {
            let attempts = 0;
            const maxAttempts = 60; // 5 minutes max
            let initialTitleCount = 0;
            let initialDescCount = 0;
            const startTime = Date.now();
            
            // Get initial content to compare
            try {
                const initial = await apiCall(`/api/file/content?path=${encodeURIComponent(pageInfoPath)}`);
                if (initial.content) {
                    const initialData = JSON.parse(initial.content);
                    initialTitleCount = (initialData.title_options || []).length;
                    initialDescCount = (initialData.description_options || []).length;
                }
            } catch (e) {}
            
            const checkReport = async () => {
                attempts++;
                
                try {
                    // Read current page_info.json
                    const current = await apiCall(`/api/file/content?path=${encodeURIComponent(pageInfoPath)}`);
                    
                    if (current.content) {
                        try {
                            const data = JSON.parse(current.content);
                            const hasTitleOptions = data.title_options && data.title_options.length > 0;
                            const hasDescOptions = data.description_options && data.description_options.length > 0;
                            
                            // Wait at least 3 attempts (15 seconds) to avoid showing old options
                            if ((hasTitleOptions || hasDescOptions) && attempts >= 3) {
                                showToast('✅ טייטלים ודסקריפשנים מוכנים!', 'success');
                                showTitleDescOptions(data);
                                return;
                            }
                        } catch (e) {}
                    }
                    
                    if (attempts < maxAttempts) {
                        setTimeout(checkReport, 5000); // Check every 5 seconds
                    } else {
                        showToast('הזמן הקצוב עבר. בדוק את הטרמינל.', 'warning');
                    }
                } catch (error) {
                    console.error('Poll error:', error);
                }
            };
            
            // Wait 15 seconds before first check to give agent time to start
            setTimeout(checkReport, 15000);
        }

        function showTitleDescOptions(data) {
            // Create a modal to show the options
            let modal = document.getElementById('titleDescReportModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'titleDescReportModal';
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal modal-large">
                        <div class="modal-header">
                            <h2>🏆 המלצות טייטל ודסקריפשן</h2>
                            <button class="modal-close" onclick="closeModal('titleDescReportModal')">&times;</button>
                        </div>
                        <div class="modal-body" id="titleDescReportContent" style="max-height: 70vh; overflow-y: auto;">
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeModal('titleDescReportModal')">סגור</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            // Build HTML for options
            let html = '<div style="direction: rtl; text-align: right;">';
            
            // Selected options
            html += '<div style="background: #1a3a1a; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #2a5a2a;">';
            html += '<h3 style="color: #4ade80; margin: 0 0 10px 0;">✅ נבחרו:</h3>';
            html += `<p><strong>Title:</strong> ${data.title || 'לא נבחר'}</p>`;
            html += `<p><strong>Description:</strong> ${data.description || 'לא נבחר'}</p>`;
            html += '</div>';
            
            // Title options
            if (data.title_options && data.title_options.length > 0) {
                html += '<h3 style="color: #60a5fa;">📝 אפשרויות Title:</h3>';
                html += '<div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px;">';
                data.title_options.forEach((opt, i) => {
                    const text = typeof opt === 'string' ? opt : opt.text;
                    const reason = typeof opt === 'object' ? opt.reason : '';
                    const charCount = text ? text.length : 0;
                    const isGoodLength = charCount <= 60;
                    html += `
                        <div style="background: #1a1a2e; padding: 12px; border-radius: 8px; border: 1px solid #333; cursor: pointer;" 
                             onclick="selectTitleOption('${text.replace(/'/g, "\\'")}')">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: bold;">אפשרות ${i + 1}</span>
                                <span style="color: ${isGoodLength ? '#4ade80' : '#f87171'};">${charCount} תווים</span>
                            </div>
                            <p style="margin: 8px 0; color: #e2e8f0;">"${text}"</p>
                            ${reason ? `<p style="margin: 0; color: #94a3b8; font-size: 0.9em;">💡 ${reason}</p>` : ''}
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            // Description options
            if (data.description_options && data.description_options.length > 0) {
                html += '<h3 style="color: #60a5fa;">📝 אפשרויות Description:</h3>';
                html += '<div style="display: flex; flex-direction: column; gap: 10px;">';
                data.description_options.forEach((opt, i) => {
                    const text = typeof opt === 'string' ? opt : opt.text;
                    const reason = typeof opt === 'object' ? opt.reason : '';
                    const charCount = text ? text.length : 0;
                    const isGoodLength = charCount <= 160;
                    html += `
                        <div style="background: #1a1a2e; padding: 12px; border-radius: 8px; border: 1px solid #333; cursor: pointer;"
                             onclick="selectDescOption('${text.replace(/'/g, "\\'")}')">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: bold;">אפשרות ${i + 1}</span>
                                <span style="color: ${isGoodLength ? '#4ade80' : '#f87171'};">${charCount} תווים</span>
                            </div>
                            <p style="margin: 8px 0; color: #e2e8f0;">"${text}"</p>
                            ${reason ? `<p style="margin: 0; color: #94a3b8; font-size: 0.9em;">💡 ${reason}</p>` : ''}
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            html += '</div>';
            
            document.getElementById('titleDescReportContent').innerHTML = html;
            openModal('titleDescReportModal');
        }
        
        function selectTitleOption(text) {
            document.getElementById('uploadTitle').value = text;
            updateTitleCharCountWithSuffix();
            showToast('✅ Title נבחר!', 'success');
        }
        
        function selectDescOption(text) {
            document.getElementById('uploadDescription').value = text;
            document.getElementById('uploadDescCount').textContent = `${text.length}/160 תווים`;
            showToast('✅ Description נבחר!', 'success');
        }
        
        // Upload WordPress Post Title (separate from Yoast SEO Title)
        async function uploadWpPostTitle() {
            if (!uploadState.postId) {
                showToast('חסר Post ID', 'error');
                return;
            }
            
            const wpTitle = document.getElementById('uploadWpTitle').value.trim();
            if (!wpTitle) {
                showToast('כותרת עמוד ריקה', 'error');
                return;
            }
            
            showToast('מעדכן כותרת עמוד...', 'info');
            
            try {
                const pageFolder = getPageFolder(selectedPage.path);
                const result = await apiCall('/api/wordpress/update-wp-title', {
                    method: 'POST',
                    body: JSON.stringify({
                        site: selectedPage.site || 'main',
                        post_id: uploadState.postId,
                        wp_post_title: wpTitle,
                        page_folder: pageFolder
                    })
                });
                
                if (result.success) {
                    showToast('✅ כותרת עמוד עודכנה בהצלחה!', 'success');
                    // Update local state
                    if (uploadState.pageInfo) {
                        uploadState.pageInfo.wp_post_title = wpTitle;
                        uploadState.pageInfo.page_name = wpTitle;
                    }
                } else {
                    showToast(`❌ שגיאה: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('Upload WP title error:', error);
                showToast('שגיאה בעדכון כותרת עמוד', 'error');
            }
        }

        async function uploadToWP(type) {
            if (!uploadState.postId) {
                showToast('חסר Post ID', 'error');
                return;
            }

            const title = document.getElementById('uploadTitle').value;
            const description = document.getElementById('uploadDescription').value;
            
            // Validate based on type
            if (type === 'title' && !title) {
                showToast('אין Title להעלאה', 'error');
                return;
            }
            if (type === 'description' && !description) {
                showToast('אין Description להעלאה', 'error');
                return;
            }
            if ((type === 'content' || type === 'all') && !uploadState.newContent) {
                showToast('אין תוכן להעלאה', 'error');
                return;
            }

            const typeLabels = {
                'title': 'Title',
                'description': 'Description', 
                'content': 'תוכן',
                'all': 'הכל'
            };
            
            if (!confirm(`האם אתה בטוח שרוצה להעלות ${typeLabels[type]} ל-WordPress?`)) {
                return;
            }

            showToast(`מעלה ${typeLabels[type]} ל-WordPress...`, 'info');

            // Build payload based on type
            const pageFolder = selectedPage?.path?.replace(/[\/\\][^\/\\]+\.html$/i, '') || '';
            const payload = {
                post_id: uploadState.postId,
                url: uploadState.url,
                page_folder: pageFolder
            };
            
            if (type === 'title' || type === 'all') {
                payload.title = title || undefined;
            }
            if (type === 'description' || type === 'all') {
                payload.meta_description = description || undefined;
            }
            if (type === 'content' || type === 'all') {
                payload.content = uploadState.newContent;
            }

            try {
                console.log('📤 Sending to WordPress:', payload);
                console.log('   Post ID:', payload.post_id);
                console.log('   Title:', payload.title);
                console.log('   Description:', payload.meta_description);
                console.log('   Has Content:', !!payload.content);
                if (payload.content) {
                    console.log('   Content length:', payload.content.length);
                    console.log('   Has <style>:', payload.content.includes('<style'));
                    console.log('   Has style=:', payload.content.includes('style='));
                    console.log('   First 500 chars:', payload.content.substring(0, 500));
                }
                
                const result = await apiCall('/api/wordpress/upload', {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                
                console.log('📥 WordPress response:', result);

                if (result.success) {
                    // Show detailed success/warning message
                    let successMsg = `✅ הועלה ל-${result.site}!`;
                    let toastType = 'success';
                    
                    // Check what was actually updated
                    const updates = [];
                    if (result.post_title_updated) updates.push('Post Title');
                    if (result.content_updated) updates.push('Content');
                    if (result.yoast_title_updated) updates.push('Yoast Title');
                    if (result.yoast_desc_updated) updates.push('Yoast Desc');
                    
                    if (updates.length > 0) {
                        successMsg += ` (${updates.join(', ')})`;
                    }
                    
                    // Show warning if Yoast wasn't updated
                    if (result.warning) {
                        console.warn('WordPress upload warning:', result.warning);
                        showToast(`⚠️ ${result.warning}`, 'warning', 8000);
                        toastType = 'warning';
                    }
                    
                    showToast(successMsg, toastType);
                    
                    // Update page_info.json with the uploaded values
                    const pagePath = selectedPage.path || '';
                    let pageDir = pagePath.substring(0, Math.max(pagePath.lastIndexOf('/'), pagePath.lastIndexOf('\\')));
                    const pageInfoPath = pageDir + '/page_info.json';
                    
                    try {
                        // Read current page_info.json
                        const pageInfoResult = await apiCall(`/api/file/content?path=${encodeURIComponent(pageInfoPath)}`);
                        if (pageInfoResult.content) {
                            const pageInfo = JSON.parse(pageInfoResult.content);
                            
                            // Update BOTH the main fields AND the uploaded tracking fields
                            if (type === 'title' || type === 'all') {
                                // Update the main title field (this is what the UI displays)
                                pageInfo.title = payload.title;
                                // Also track the upload
                                pageInfo.uploaded_title = payload.title;
                                pageInfo.uploaded_title_at = new Date().toISOString();
                            }
                            if (type === 'description' || type === 'all') {
                                // Update the main description field (this is what the UI displays)
                                pageInfo.description = payload.meta_description;
                                // Also track the upload
                                pageInfo.uploaded_description = payload.meta_description;
                                pageInfo.uploaded_description_at = new Date().toISOString();
                            }
                            pageInfo.last_upload = new Date().toISOString();
                            pageInfo.last_upload_type = type;
                            
                            // Save updated page_info.json
                            await apiCall('/api/file/save-content', {
                                method: 'POST',
                                body: JSON.stringify({
                                    path: pageInfoPath,
                                    content: JSON.stringify(pageInfo, null, 2)
                                })
                            });
                            console.log('✅ page_info.json updated with new values');
                            
                            // Update the local cache and UI
                            if (uploadState.pageInfo) {
                                if (type === 'title' || type === 'all') {
                                    uploadState.pageInfo.title = payload.title;
                                }
                                if (type === 'description' || type === 'all') {
                                    uploadState.pageInfo.description = payload.meta_description;
                                }
                            }
                            
                            // Refresh page info cache for sidebar display
                            if (pageInfoCache[selectedPage.path]) {
                                pageInfoCache[selectedPage.path] = pageInfo;
                            }
                            
                            // Update the input fields to show new values
                            if (type === 'title' || type === 'all') {
                                document.getElementById('uploadTitle').value = payload.title;
                                updateTitleCharCountWithSuffix();
                            }
                            if (type === 'description' || type === 'all') {
                                document.getElementById('uploadDescription').value = payload.meta_description;
                                updateCharCount('uploadDescription', 'uploadDescCount', 160);
                            }
                        }
                    } catch (e) {
                        console.error('Error updating page_info.json:', e);
                    }
                    
                    closeModal('uploadModal');
                    
                    // Save to archive
                    await apiCall('/api/archive/save', {
                        method: 'POST',
                        body: JSON.stringify({
                            page_name: selectedPage.name,
                            page_path: selectedPage.path
                        })
                    });
                } else {
                    showToast(result.error || 'שגיאה בהעלאה', 'error');
                }
            } catch (error) {
                console.error('Upload error:', error);
                showToast('שגיאה בהעלאה ל-WordPress', 'error');
            }
        }

        async function restoreBackup(type) {
            if (!uploadState.postId) {
                showToast('חסר Post ID', 'error');
                return;
            }
            
            if (!uploadState.backupMeta && !uploadState.backupContent) {
                showToast('אין גיבוי לשחזור. לחץ על "שלוף וגבה" קודם.', 'error');
                return;
            }

            const typeLabels = {
                'title': 'Title',
                'description': 'Description', 
                'content': 'תוכן',
                'all': 'הכל'
            };
            
            if (!confirm(`⚠️ האם אתה בטוח שרוצה לשחזר ${typeLabels[type]} מהגיבוי?\n\nזה יחזיר את הגרסה הקודמת ל-WordPress!`)) {
                return;
            }

            showToast(`משחזר ${typeLabels[type]} מהגיבוי...`, 'info');

            // Build payload from backup data
            const pageFolder = selectedPage?.path?.replace(/[\/\\][^\/\\]+\.html$/i, '') || '';
            const payload = {
                post_id: uploadState.postId,
                url: uploadState.url,
                page_folder: pageFolder
            };
            
            const backupMeta = uploadState.backupMeta || {};
            
            if (type === 'title' || type === 'all') {
                if (backupMeta.title) {
                    payload.title = backupMeta.title;
                } else {
                    showToast('אין Title בגיבוי', 'error');
                    if (type === 'title') return;
                }
            }
            if (type === 'description' || type === 'all') {
                if (backupMeta.description) {
                    payload.meta_description = backupMeta.description;
                } else {
                    showToast('אין Description בגיבוי', 'error');
                    if (type === 'description') return;
                }
            }
            if (type === 'content' || type === 'all') {
                if (uploadState.backupContent) {
                    payload.content = uploadState.backupContent;
                    payload.skip_cleanup = true;  // Don't clean backup content - it's already from WordPress
                } else {
                    showToast('אין תוכן בגיבוי', 'error');
                    if (type === 'content') return;
                }
            }

            try {
                const result = await apiCall('/api/wordpress/upload', {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });

                if (result.success) {
                    showToast(`✅ ${typeLabels[type]} שוחזר מהגיבוי בהצלחה!`, 'success');
                } else {
                    showToast(result.error || 'שגיאה בשחזור', 'error');
                }
            } catch (error) {
                console.error('Restore error:', error);
                showToast('שגיאה בשחזור מהגיבוי', 'error');
            }
        }

        // ============ Agent Management ============
        // Legacy function - kept for backwards compatibility
        function renderAgentListOld() {
            const list = document.getElementById('agentList');
            if (!list) return;
            list.innerHTML = Object.entries(agents).map(([id, agent]) => `
                <div class="agent-list-item">
                    <div class="agent-list-item-info">
                        <span class="agent-list-item-name">${agent.name}</span>
                        <span class="agent-list-item-type">${agent.type === 'two-step' ? 'דו-שלבי' : agent.type === 'multi-step' ? 'רב-שלבי' : 'חד-שלבי'}</span>
                    </div>
                    <div class="agent-list-item-actions">
                        <button class="btn btn-small btn-secondary" onclick="editAgent('${id}')">✏️</button>
                        <button class="btn btn-small btn-secondary" onclick="deleteAgent('${id}')">🗑️</button>
                    </div>
                </div>
            `).join('');
        }

        function openAddAgent() {
            // Reset form
            document.getElementById('newAgentName').value = '';
            document.getElementById('newAgentId').value = '';
            document.getElementById('newAgentDesc').value = '';
            document.getElementById('newAgentType').value = 'single-step';
            toggleAgentTypeFields();
            openModal('addAgentModal');
        }

        function toggleAgentTypeFields() {
            const type = document.getElementById('newAgentType').value;
            document.getElementById('singleStepFields').style.display = type === 'single-step' ? 'block' : 'none';
            document.getElementById('twoStepFields').style.display = type === 'two-step' ? 'block' : 'none';
        }

        async function saveNewAgent() {
            const id = document.getElementById('newAgentId').value;
            const name = document.getElementById('newAgentName').value;
            const desc = document.getElementById('newAgentDesc').value;
            const type = document.getElementById('newAgentType').value;
            const createFile = document.getElementById('createAgentFile').checked;

            if (!id || !name) {
                showToast('נא למלא שם ומזהה', 'error');
                return;
            }

            let config;
            if (type === 'single-step') {
                config = {
                    type: 'single-step',
                    name,
                    description: desc,
                    agent: document.getElementById('singleAgentFile').value,
                    output_suffix: document.getElementById('singleOutputSuffix').value,
                    output_folder: document.getElementById('singleOutputFolder').value
                };
            } else {
                config = {
                    type: 'two-step',
                    name,
                    description: desc,
                    step1: {
                        agent: document.getElementById('step1AgentFile').value,
                        output_suffix: document.getElementById('step1OutputSuffix').value,
                        output_folder: document.getElementById('step1OutputFolder').value
                    },
                    step2: {
                        agent: document.getElementById('step2AgentFile').value,
                        output_suffix: document.getElementById('step2OutputSuffix').value,
                        output_folder: document.getElementById('step2OutputFolder').value
                    }
                };
            }

            const result = await apiCall('/api/agents/create', {
                method: 'POST',
                body: JSON.stringify({ id, config, create_file: createFile })
            });

            if (result.success) {
                showToast('הסוכן נוסף בהצלחה', 'success');
                closeModal('addAgentModal');
                loadAgents();
            } else {
                showToast(result.error || 'שגיאה', 'error');
            }
        }

        async function deleteAgent(id) {
            if (!confirm(`למחוק את הסוכן "${agents[id].name}"?`)) return;
            
            const result = await apiCall(`/api/agents/${id}`, { method: 'DELETE' });
            if (result.success) {
                showToast('הסוכן נמחק', 'success');
                loadAgents();
            } else {
                showToast(result.error || 'שגיאה', 'error');
            }
        }

        // ============ Modals ============
        function openModal(id) {
            document.getElementById(id).classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }
        
        function showModal(title, content) {
            // Create or reuse generic modal
            let modal = document.getElementById('genericModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'genericModal';
                modal.className = 'modal-overlay';
                document.body.appendChild(modal);
            }
            
            modal.innerHTML = `
                <div class="modal" style="max-width: 900px;">
                    <div class="modal-header">
                        <h2>${title}</h2>
                        <button class="modal-close" onclick="closeModal('genericModal')">&times;</button>
                    </div>
                    <div class="modal-body">
                        ${content}
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeModal('genericModal')">סגור</button>
                    </div>
                </div>
            `;
            
            modal.classList.add('active');
        }

        async function openSettings() {
            // Render dynamic site cards first
            await renderSiteConfigCards();
            // Then load WP settings into them
            await loadWpSettingsDynamic();
            openModal('settingsModal');
        }

        async function loadWpSettingsDynamic() {
            const result = await apiCall('/api/wordpress/settings');
            if (result.success) {
                for (const [siteId, site] of Object.entries(result.sites)) {
                    const card = document.querySelector(`.site-config-card[data-site-id="${siteId}"]`);
                    if (!card) continue;
                    
                    const urlInput = card.querySelector('[data-field="wp_url"]');
                    const userInput = card.querySelector('[data-field="wp_user"]');
                    const statusSpan = card.querySelector(`[data-wp-status="${siteId}"]`);
                    const suffixInput = card.querySelector('[data-field="title_suffix"]');
                    const suffixEnabledInput = card.querySelector('[data-field="title_suffix_enabled"]');
                    
                    if (urlInput) urlInput.value = site.site_url || '';
                    if (userInput) userInput.value = site.username || '';
                    if (statusSpan && site.has_password) {
                        statusSpan.textContent = '🔑 יש סיסמה';
                    }
                    // Load suffix settings
                    if (suffixInput) suffixInput.value = site.title_suffix || '';
                    if (suffixEnabledInput) suffixEnabledInput.checked = site.title_suffix_enabled || false;
                }
            }
        }

        async function syncWpTitles() {
            const btn = document.getElementById('syncWpTitlesBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '⏳ מסנכרן...';
            btn.disabled = true;
            
            try {
                const result = await apiCall('/api/wordpress/sync-wp-titles', {
                    method: 'POST',
                    body: JSON.stringify({})
                });
                
                if (result.success) {
                    showToast(`✅ סונכרנו ${result.updated} כותרות מתוך ${result.total}`, 'success');
                    if (result.errors && result.errors.length > 0) {
                        console.warn('Sync errors:', result.errors);
                    }
                    // Reload page list to show updated titles
                    await loadPages();
                } else {
                    showToast(`❌ שגיאה: ${result.error}`, 'error');
                }
            } catch (e) {
                showToast(`❌ שגיאה: ${e.message}`, 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function saveSettings() {
            // Save WordPress settings for all sites dynamically
            const siteCards = document.querySelectorAll('.site-config-card[data-site-id]');
            
            for (const card of siteCards) {
                const siteId = card.dataset.siteId;
                await apiCall('/api/wordpress/settings', {
                    method: 'POST',
                    body: JSON.stringify({
                        site_id: siteId,
                        username: card.querySelector('[data-field="wp_user"]')?.value || '',
                        password: card.querySelector('[data-field="wp_pass"]')?.value || '',
                        site_url: card.querySelector('[data-field="wp_url"]')?.value || '',
                        title_suffix: card.querySelector('[data-field="title_suffix"]')?.value || '',
                        title_suffix_enabled: card.querySelector('[data-field="title_suffix_enabled"]')?.checked || false
                    })
                });
            }
            
            // Also save sites settings (names and folders)
            await saveSitesSettingsDynamic();
            
            showToast('ההגדרות נשמרו', 'success');
            closeModal('settingsModal');
        }

        // ============ Sites Settings (Dynamic) ============
        // loadSitesSettings is now replaced by renderSiteConfigCards()
        async function loadSitesSettings() {
            // Deprecated - use renderSiteConfigCards() instead
            await renderSiteConfigCards();
        }
        
        async function saveSitesSettingsDynamic(showNotification = false) {
            try {
                const sites = {};
                const siteCards = document.querySelectorAll('.site-config-card[data-site-id]');
                
                for (const card of siteCards) {
                    const siteId = card.dataset.siteId;
                    sites[siteId] = {
                        name: card.querySelector('[data-field="name"]')?.value || siteId,
                        folder: card.querySelector('[data-field="folder"]')?.value || ''
                    };
                }
                
                const result = await apiCall('/api/sites/settings', {
                    method: 'POST',
                    body: JSON.stringify({ sites })
                });
                
                if (result.success) {
                    // Update site config cache and refresh site filter
                    await loadSiteConfig();
                    await populateSiteFilter();
                    if (showNotification) {
                        showToast('✅ הגדרות האתרים נשמרו', 'success');
                    }
                } else {
                    showToast('שגיאה: ' + (result.error || 'לא ידוע'), 'error');
                }
            } catch (e) {
                showToast('שגיאה בשמירה: ' + e.message, 'error');
            }
        }
        
        // Keep for backwards compatibility
        async function saveSitesSettings(showNotification = false) {
            return saveSitesSettingsDynamic(showNotification);
        }
        
        function updateSiteFilterLabels() {
            // Deprecated - site filter is now populated dynamically by populateSiteFilter()
            populateSiteFilter();
            
            const siteFilter = document.getElementById('siteFilter');
            if (siteFilter) {
                siteFilter.options[1].text = `🏠 ${mainName}`;
                siteFilter.options[2].text = `💼 ${businessName}`;
            }
        }

        // ============ UI Helpers ============
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            // Clear previous toasts - show only one at a time
            container.innerHTML = '';
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span>${message}</span>`;
            container.appendChild(toast);
            
            setTimeout(() => toast.remove(), 4000);
        }

        function capitalize(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        // ============ Event Listeners ============
        document.getElementById('agentSelect').addEventListener('change', (e) => {
            selectAgent(e.target.value);
        });

        document.getElementById('modeSelect').addEventListener('change', (e) => {
            currentMode = e.target.value;
        });

        // Settings tabs
        document.querySelectorAll('[data-settings-tab]').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('[data-settings-tab]').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                const tabName = tab.dataset.settingsTab;
                document.getElementById('settingsSites').style.display = tabName === 'sites' ? 'block' : 'none';
                document.getElementById('settingsAgents').style.display = tabName === 'agents' ? 'block' : 'none';
            });
        });

        // Mode tabs
        document.querySelectorAll('.header .tabs [data-tab]').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.header .tabs [data-tab]').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                const tabName = tab.dataset.tab;
                
                // Show/hide main sections based on tab
                const mainEl = document.querySelector('main.main');
                const agentsSection = document.getElementById('agentsSection');
                const duplicatesSection = document.getElementById('duplicatesSection');
                const reportsSection = document.getElementById('reportsSection');
                
                if (tabName === 'agents') {
                    mainEl.style.display = 'none';
                    agentsSection.classList.add('active');
                    duplicatesSection.classList.remove('active');
                    reportsSection.classList.remove('active');
                    loadAgentBuilderList();
                    loadDataSources();  // Load custom data sources for shortcode sidebar
                } else if (tabName === 'duplicates') {
                    mainEl.style.display = 'none';
                    agentsSection.classList.remove('active');
                    duplicatesSection.classList.add('active');
                    reportsSection.classList.remove('active');
                    initDuplicatesTab();  // Initialize duplicates tab
                } else if (tabName === 'reports') {
                    mainEl.style.display = 'none';
                    agentsSection.classList.remove('active');
                    duplicatesSection.classList.remove('active');
                    reportsSection.classList.add('active');
                    initReportsTab();  // Initialize reports tab
                } else {
                    mainEl.style.display = 'flex';
                    agentsSection.classList.remove('active');
                    duplicatesSection.classList.remove('active');
                    reportsSection.classList.remove('active');
                }
            });
        });

        // ============ Server Control ============
        async function restartServer() {
            if (!confirm('לאתחל את השרת?')) return;
            
            showToast('מאתחל שרת...', 'info');
            
            try {
                await apiCall('/api/server/restart', { method: 'POST' });
            } catch (e) {
                // Expected - server is restarting
            }
            
            // Wait and reload
            showToast('ממתין לשרת...', 'info');
            setTimeout(() => {
                location.reload();
            }, 3000);
        }
        
        // ============ Git Integration ============
        async function checkGitStatus() {
            try {
                const result = await apiCall('/api/git/status');
                if (!result.success) {
                    const badge = document.getElementById('gitStatusBadge');
                    badge.className = 'git-badge';
                    badge.innerHTML = '<span class="git-icon">⚠</span><span class="git-text">שגיאה</span>';
                    return;
                }
                
                const badge = document.getElementById('gitStatusBadge');
                const pushBtn = document.getElementById('gitPushBtn');
                const pullBtn = document.getElementById('gitPullBtn');
                
                // Determine status - show BOTH behind and ahead with arrows
                let statusParts = [];
                
                // Check if behind (need to pull)
                if (result.behind > 0) {
                    statusParts.push(`↓${result.behind}`);
                    pullBtn.disabled = false;
                    pullBtn.classList.add('active');
                } else {
                    pullBtn.disabled = true;
                    pullBtn.classList.remove('active');
                }
                
                // Check if has local changes or ahead (need to push)
                if (result.has_changes) {
                    statusParts.push(`↑${result.changed_files}`);
                    pushBtn.disabled = false;
                    pushBtn.classList.add('active');
                } else if (result.ahead > 0) {
                    statusParts.push(`↑${result.ahead}`);
                    pushBtn.disabled = false;
                    pushBtn.classList.add('active');
                } else {
                    pushBtn.disabled = true;
                    pushBtn.classList.remove('active');
                }
                
                // Set badge based on combined status
                if (result.behind > 0 && (result.has_changes || result.ahead > 0)) {
                    // Both - need pull AND push
                    badge.className = 'git-badge behind';
                    badge.innerHTML = `<span class="git-icon">↕</span><span class="git-text">${statusParts.join(' ')}</span>`;
                } else if (result.behind > 0) {
                    // Only behind - arrow down
                    badge.className = 'git-badge behind';
                    badge.innerHTML = `<span class="git-icon">↓</span><span class="git-text">${result.behind} למשוך</span>`;
                } else if (result.has_changes || result.ahead > 0) {
                    // Only ahead/changes - arrow up
                    badge.className = 'git-badge has-changes';
                    badge.innerHTML = `<span class="git-icon">↑</span><span class="git-text">${statusParts.join(' ')}</span>`;
                } else {
                    // All synced
                    badge.className = 'git-badge synced';
                    badge.innerHTML = '<span class="git-icon">✓</span><span class="git-text">מסונכרן</span>';
                }
            } catch (e) {
                console.error('Git status error:', e);
            }
        }
        
        async function gitPull() {
            const pullBtn = document.getElementById('gitPullBtn');
            const badge = document.getElementById('gitStatusBadge');
            
            pullBtn.disabled = true;
            badge.className = 'git-badge pulling';
            badge.innerHTML = '<span class="git-icon">⏳</span><span class="git-text">מושך...</span>';
            
            try {
                const result = await apiCall('/api/git/pull', { method: 'POST' });
                showToast(result.success ? '✅ Git Pull בוצע!' : '❌ ' + (result.output || result.error), result.success ? 'success' : 'error');
            } catch (e) {
                showToast('❌ שגיאה: ' + e.message, 'error');
            }
            
            await checkGitStatus();
        }
        
        async function gitPush() {
            const pushBtn = document.getElementById('gitPushBtn');
            const badge = document.getElementById('gitStatusBadge');
            
            pushBtn.disabled = true;
            badge.className = 'git-badge pushing';
            badge.innerHTML = '<span class="git-icon">⏳</span><span class="git-text">מעלה...</span>';
            
            try {
                const result = await apiCall('/api/git/push', { method: 'POST', body: '{}' });
                showToast(result.success ? '✅ Git Push בוצע!' : '❌ ' + (result.output || result.error), result.success ? 'success' : 'error');
            } catch (e) {
                showToast('❌ שגיאה: ' + e.message, 'error');
            }
            
            await checkGitStatus();
        }
        
        async function gitSync() {
            const syncBtn = document.getElementById('gitSyncBtn');
            const badge = document.getElementById('gitStatusBadge');
            
            syncBtn.disabled = true;
            badge.className = 'git-badge syncing';
            badge.innerHTML = '<span class="git-icon">🔄</span><span class="git-text">מסנכרן...</span>';
            
            try {
                const result = await apiCall('/api/git/sync', { method: 'POST', body: '{}' });
                if (result.success) {
                    showToast('✅ ' + result.message, 'success');
                } else {
                    const errorMsg = result.errors ? result.errors.join(', ') : result.error;
                    showToast('❌ ' + errorMsg, 'error');
                }
            } catch (e) {
                showToast('❌ שגיאה: ' + e.message, 'error');
            }
            
            syncBtn.disabled = false;
            await checkGitStatus();
        }
        
        async function reloadConfig() {
            const result = await apiCall('/api/server/reload-config', { method: 'POST' });
            if (result.success) {
                showToast('ההגדרות נטענו מחדש', 'success');
                loadAgents();
            } else {
                showToast(result.error || 'שגיאה', 'error');
            }
        }

        // ============ Global Values ============
        async function loadGlobalValues() {
            try {
                const result = await apiCall('/api/global-values');
                if (result.success && result.values) {
                    // Load BOI Interest Rate
                    if (result.values.BOI_INTEREST_RATE) {
                        const input = document.getElementById('boiInterestInput');
                        if (input) input.value = result.values.BOI_INTEREST_RATE.value || '';
                    }
                }
            } catch (e) {
                console.error('Error loading global values:', e);
            }
        }
        
        async function saveGlobalValue(key, value) {
            try {
                const result = await apiCall('/api/global-values', {
                    method: 'POST',
                    body: JSON.stringify({ key, value })
                });
                if (result.success) {
                    showToast(`✅ ${key} נשמר: ${value}`, 'success');
                } else {
                    showToast(result.error || 'שגיאה בשמירה', 'error');
                }
            } catch (e) {
                showToast('שגיאה בשמירה: ' + e.message, 'error');
            }
        }

        // ============ Claude Control ============
        async function stopClaude() {
            try {
                const result = await apiCall('/api/workflow/stop', { method: 'POST' });
                if (result.success) {
                    showToast('Claude הופסק', 'success');
                    hideStopButton();
                    stopPolling();
                } else {
                    showToast(result.error || 'שגיאה בעצירה', 'error');
                }
            } catch (e) {
                showToast('שגיאה: ' + e.message, 'error');
            }
        }
        
        function showStopButton() {
            document.getElementById('stopClaudeBtn').style.display = 'inline-block';
        }
        
        function hideStopButton() {
            document.getElementById('stopClaudeBtn').style.display = 'none';
            // NOTE: Don't clear runningStepPromptInfo here - it's called in many places
            // including status checks before server knows step is running
            // Only clear it when step is ACTUALLY complete (in startStatusPolling callbacks)
        }

        // ============ Global Status Refresh ============
        let globalStatusInterval = null;
        
        function startGlobalStatusRefresh() {
            if (globalStatusInterval) return;
            
            globalStatusInterval = setInterval(async () => {
                // Check if current page was running locally
                let wasCurrentPageRunning = false;
                let currentPageKey = null;
                if (selectedPage) {
                    for (const [runPath, runInfo] of Object.entries(localRunningPages)) {
                        if (runPath.includes(selectedPage.name) || selectedPage.path.includes(selectedPage.name)) {
                            wasCurrentPageRunning = true;
                            currentPageKey = runPath;
                            break;
                        }
                    }
                }
                
                const oldStatus = JSON.stringify(pageStatusMap);
                await loadPageStatus();
                await loadMultiAgentStatus();
                const newStatus = JSON.stringify(pageStatusMap);
                
                // Check if current page completed (has log with completion marker OR has step 2 report)
                let isCurrentPageRunning = wasCurrentPageRunning;
                if (wasCurrentPageRunning && selectedPage) {
                    // Check log to see if completed
                    const agentIdForLog = selectedAgent?.id || '';
                    const logResult = await apiCall(`/api/worklog?page=${encodeURIComponent(selectedPage.path)}&agent_id=${encodeURIComponent(agentIdForLog)}`);
                    if (logResult.success && logResult.content) {
                        if (logResult.content.includes('🏁 סיום!') || logResult.content.includes('✅ Claude סיים!')) {
                            isCurrentPageRunning = false;
                            // Remove from local running
                            if (currentPageKey) delete localRunningPages[currentPageKey];
                            
                            // Debounce - skip if already handled recently
                            if (!shouldRefreshOnCompletion()) {
                                return;
                            }
                            
                            // Update ALL status indicators
                            const pageName = selectedPage.name || 'העמוד';
                            
                            // 1. Update work status panel
                            updateWorkStatusTitle(`📄 ${pageName} - הושלם ✅`);
                            setWorkStatusDot('completed');
                            hideStopButton();
                            clearRunningStepPrompt(); // Step actually completed
                            
                            // 2. Refresh page status and sidebar
                            await loadPageStatus();
                            await loadMultiAgentStatus();
                            renderPageList();
                            
                            // 3. Refresh preview to show updated page
                            loadPreview();
                            
                            // 4. Reload reports to show step 2 report
                            loadReports();
                            
                            // 5. Update header status
                            updateStatusDisplay('completed', 'הושלם');
                            
                            // 6. Notify user
                            showToast(`✅ ${pageName} - הושלם!`, 'success');
                            
                            // 7. Check if Full Auto mode - trigger next step
                            checkFullAutoNext();
                        }
                    }
                    
                    // Also check if step 2 report was created (backup check)
                    const normalizedPath = selectedPage.path.replace(/\\/g, '/');
                    const status = pageStatusMap[selectedPage.path] || pageStatusMap[normalizedPath] || {};
                    if ((status.hasStep2Report || status.hasFixed) && isCurrentPageRunning) {
                        isCurrentPageRunning = false;
                        if (currentPageKey) delete localRunningPages[currentPageKey];
                        
                        // Update ALL status indicators
                        const pageName = selectedPage.name || 'העמוד';
                        
                        updateWorkStatusTitle(`📄 ${pageName} - הושלם ✅`);
                        setWorkStatusDot('completed');
                        hideStopButton();
                        clearRunningStepPrompt(); // Step actually completed
                        renderPageList();
                        loadPreview();
                        loadReports();
                        updateStatusDisplay('completed', 'הושלם');
                        showToast(`✅ ${pageName} - הושלם!`, 'success');
                    }
                }
                
                // Re-render if any status changed
                if (oldStatus !== newStatus || Object.keys(localRunningPages).length > 0) {
                    renderPageList();
                }
                
                // If current page stopped running, update the bottom status bar
                if (wasCurrentPageRunning && !isCurrentPageRunning && selectedPage) {
                    const pageName = selectedPage.name || 'העמוד';
                    
                    // Check if it completed normally (has completion marker in log)
                    const agentIdForLog2 = selectedAgent?.id || '';
                    const logResult = await apiCall(`/api/worklog?page=${encodeURIComponent(selectedPage.path)}&agent_id=${encodeURIComponent(agentIdForLog2)}`);
                    const completedNormally = logResult.success && logResult.content && 
                        (logResult.content.includes('🏁 סיום!') || logResult.content.includes('✅ Claude סיים!'));
                    
                    if (completedNormally) {
                        // Check if this is an old log (less than 10 lines means it might be stale/clearing)
                        const logLines = logResult.content.split('\n').filter(l => l.trim()).length;
                        if (logLines < 10) {
                            console.log('⚠️ Log too short in status poll, might be stale - skipping');
                            return;
                        }
                        
                        // Debounce - skip if already handled recently
                        if (!shouldRefreshOnCompletion()) {
                            return;
                        }
                        
                        console.log('✅ Process completed normally!');
                        updateWorkStatusTitle(`📄 ${pageName} - הסתיים`);
                        setWorkStatusDot('completed');
                        clearRunningStepPrompt(); // Step actually completed
                        showToast(`✅ ${pageName} הסתיים`, 'success');
                        
                        // Auto-refresh reports and preview
                        await loadPageStatus();
                        await loadMultiAgentStatus();
                        loadReports();
                        loadPreview();
                        renderPageList();
                        updateWorkflowButtons();
                        
                        // Check if Full Auto should continue
                        checkFullAutoNext();
                    } else {
                        // Stopped mid-process - delete the log
                        await apiCall(`/api/worklog/page/${encodeURIComponent(selectedPage.path)}`, { method: 'DELETE' });
                        updateWorkStatusTitle(`📄 ${pageName} - הופסק`);
                        setWorkStatusDot('pending');
                        hideWorkStatusPanel();
                        showToast(`⚠️ ${pageName} הופסק`, 'warning');
                    }
                    hideStopButton();
                }
            }, 2000);  // Check every 2 seconds
        }
        
        // ============ Panel Resize ============
        function initPanelResize() {
            const resizeHandle = document.getElementById('resizeHandle');
            const reportPanel = document.getElementById('reportPanel');
            const previewPanel = document.getElementById('previewPanel');
            const panels = document.querySelector('.panels');
            
            if (!resizeHandle || !reportPanel || !previewPanel || !panels) return;
            
            let isResizing = false;
            let startX = 0;
            let startReportWidth = 0;
            let startPreviewWidth = 0;
            
            resizeHandle.addEventListener('mousedown', (e) => {
                isResizing = true;
                startX = e.clientX;
                startReportWidth = reportPanel.offsetWidth;
                startPreviewWidth = previewPanel.offsetWidth;
                
                document.body.classList.add('resizing');
                resizeHandle.classList.add('dragging');
                
                e.preventDefault();
            });
            
            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;
                
                const dx = e.clientX - startX;
                const totalWidth = panels.offsetWidth - resizeHandle.offsetWidth;
                
                let newReportWidth = startReportWidth + dx;
                let newPreviewWidth = startPreviewWidth - dx;
                
                // Minimum widths
                const minWidth = 200;
                if (newReportWidth < minWidth) {
                    newReportWidth = minWidth;
                    newPreviewWidth = totalWidth - minWidth;
                }
                if (newPreviewWidth < minWidth) {
                    newPreviewWidth = minWidth;
                    newReportWidth = totalWidth - minWidth;
                }
                
                // Convert to percentages for flex
                const reportPercent = (newReportWidth / totalWidth) * 100;
                const previewPercent = (newPreviewWidth / totalWidth) * 100;
                
                reportPanel.style.flex = `0 0 ${reportPercent}%`;
                previewPanel.style.flex = `0 0 ${previewPercent}%`;
            });
            
            document.addEventListener('mouseup', () => {
                if (isResizing) {
                    isResizing = false;
                    document.body.classList.remove('resizing');
                    resizeHandle.classList.remove('dragging');
                    
                    // Save preference to localStorage
                    const totalWidth = panels.offsetWidth - resizeHandle.offsetWidth;
                    const reportPercent = (reportPanel.offsetWidth / totalWidth) * 100;
                    localStorage.setItem('panelReportWidth', reportPercent.toFixed(1));
                }
            });
            
            // Restore saved width
            const savedWidth = localStorage.getItem('panelReportWidth');
            if (savedWidth) {
                const reportPercent = parseFloat(savedWidth);
                const previewPercent = 100 - reportPercent;
                reportPanel.style.flex = `0 0 ${reportPercent}%`;
                previewPanel.style.flex = `0 0 ${previewPercent}%`;
            }
        }
        
        // ============ Init ============
        document.addEventListener('DOMContentLoaded', async () => {
            // Load configs first (for dynamic dropdowns and UI settings)
            await loadUIConfig();
            await loadSiteConfig();
            await populateSiteFilter();
            await populateWpSiteSelect();
            
            // Setup upload date filter toggle
            const uploadDateFilter = document.getElementById('uploadDateFilter');
            if (uploadDateFilter) {
                uploadDateFilter.addEventListener('change', function() {
                    const customDateRange = document.getElementById('customDateRange');
                    if (this.value === 'custom') {
                        customDateRange.style.display = 'flex';
                    } else {
                        customDateRange.style.display = 'none';
                    }
                });
            }
            
            // Load pages and agents
            loadPages();
            loadAgents();
            loadGlobalValues();  // Load global values like BOI interest rate
            startGlobalStatusRefresh();  // Start global status monitoring
            initPanelResize();  // Initialize panel resize functionality
            
            // Git status - check on load and every 30 seconds
            checkGitStatus();
            setInterval(checkGitStatus, 30000);
            
            // Check if advanced analyzers loaded
            setTimeout(() => {
                checkAnalyzerModules();
            }, 500);
        });
        
        // Check and log analyzer module status
        function checkAnalyzerModules() {
            const kdLoaded = typeof KeywordDensityAnalyzer !== 'undefined';
            const spamLoaded = typeof SpamAnalyzer !== 'undefined';
            
            console.log('%c📊 SEO Analyzer Modules Status:', 'font-weight: bold; font-size: 14px;');
            console.log(`  ✓ KeywordDensityAnalyzer: ${kdLoaded ? '✅ נטען' : '❌ לא נטען'}`);
            console.log(`  ✓ SpamAnalyzer: ${spamLoaded ? '✅ נטען' : '❌ לא נטען'}`);
            
            if (kdLoaded && spamLoaded) {
                console.log('%c🚀 אלגוריתם מתקדם מוכן לפעולה! (מוטמע ב-HTML)', 'color: #10b981; font-weight: bold;');
            } else {
                console.warn('%c⚠️ אזהרה: מודול ניתוח מתקדם לא נטען!', 'color: orange; font-weight: bold;');
            }
        }

        // ============ Agent Builder ============
        
        let currentAgent = null;
        let agentsCache = {};
        
        async function loadAgentBuilderList() {
            try {
                const result = await apiCall('/api/agents');
                if (result.success) {
                    agentsCache = result.agents;
                    renderAgentList(result.agents);
                    populateChainAgentSelect(result.agents);
                }
            } catch (e) {
                console.error('Error loading agents:', e);
            }
        }
        
        function renderAgentList(agents) {
            const container = document.getElementById('agentBuilderList');
            if (!container) return;
            if (!agents) return;
            
            // Get filter value
            const filterEl = document.getElementById('agentStatusFilter');
            const filter = filterEl?.value || 'all';
            
            container.innerHTML = '';
            
            for (const [id, agent] of Object.entries(agents)) {
                // Check if agent is enabled (default to true for backward compatibility)
                const isEnabled = agent.enabled !== false;
                
                // Apply filter
                if (filter === 'active' && !isEnabled) continue;
                if (filter === 'inactive' && isEnabled) continue;
                
                const card = document.createElement('div');
                card.className = 'agent-list-card' + (currentAgent?.id === id ? ' active' : '') + (!isEnabled ? ' inactive' : '');
                card.setAttribute('role', 'button');
                card.setAttribute('tabindex', '0');
                card.setAttribute('aria-label', agent.name || id);
                card.setAttribute('data-agent-id', id);
                card.style.cursor = 'pointer';
                
                // Use addEventListener for better reliability
                const agentId = id; // Capture in closure
                card.addEventListener('click', function(e) {
                    // Don't trigger if clicking on delete button or toggle
                    if (e.target.closest('.btn-delete-agent') || e.target.closest('.agent-active-toggle')) return;
                    console.log('🖱️ Card clicked:', agentId);
                    selectBuilderAgent(agentId);
                });
                
                const typeClass = agent.type === 'build' ? 'build' : 'update';
                const statusClass = agent.status === 'test' ? 'test' : 'active';
                // Count steps - support both new format (steps array) and old format (step1, step2, etc.)
                let stepsCount = agent.steps?.length || 0;
                if (stepsCount === 0) {
                    // Old format - count stepX properties
                    for (let i = 1; i <= 10; i++) {
                        if (agent[`step${i}`]) stepsCount++;
                    }
                    if (stepsCount === 0) stepsCount = 1; // Default to 1 for single-step agents
                }
                
                card.innerHTML = `
                    <div class="agent-list-card-header">
                        <div class="agent-list-card-name">${agent.name || id}</div>
                        <div style="display: flex; gap: 0.3rem; align-items: center;">
                            <label class="agent-active-toggle" title="${isEnabled ? 'לחץ להפסקה' : 'לחץ להפעלה'}" onclick="event.stopPropagation();">
                                <input type="checkbox" ${isEnabled ? 'checked' : ''} onchange="toggleAgentEnabled('${id}', this.checked)">
                                <span>${isEnabled ? '✅' : '⏸️'}</span>
                            </label>
                            <button class="btn-delete-agent" onclick="event.stopPropagation(); deleteAgentById('${id}')" title="מחק סוכן">🗑️</button>
                        </div>
                    </div>
                    <div class="agent-list-card-info">
                        <span class="agent-type-badge ${typeClass}">${agent.type === 'build' ? 'בנייה' : 'עדכון'}</span>
                        <span class="agent-status-badge ${statusClass}">${agent.status === 'test' ? '🧪 טסט' : '✅ פעיל'}</span>
                        <span>${stepsCount} שלבים</span>
                    </div>
                `;
                
                container.appendChild(card);
            }
        }
        
        function filterAgentList() {
            renderAgentList(agentsCache || agents);
        }
        
        async function toggleAgentEnabled(agentId, enabled) {
            try {
                const result = await apiCall(`/api/agents/${agentId}`, {
                    method: 'PUT',
                    body: JSON.stringify({ enabled: enabled })
                });
                
                if (result.success) {
                    // Update cache
                    if (agentsCache && agentsCache[agentId]) {
                        agentsCache[agentId].enabled = enabled;
                    }
                    if (agents && agents[agentId]) {
                        agents[agentId].enabled = enabled;
                    }
                    showToast(enabled ? '✅ הסוכן הופעל' : '⏸️ הסוכן הופסק', 'info');
                    // Also update the main dashboard agent select
                    renderAgentSelect();
                } else {
                    showToast('שגיאה בעדכון', 'error');
                }
            } catch (e) {
                showToast('שגיאה: ' + e.message, 'error');
            }
        }
        
        function populateChainAgentSelect(agents) {
            const select = document.getElementById('chainAgentSelect');
            if (!select) return;
            
            select.innerHTML = '<option value="">בחר סוכן...</option>';
            for (const [id, agent] of Object.entries(agents)) {
                if (currentAgent && id === currentAgent.id) continue;
                select.innerHTML += `<option value="${id}">${agent.name || id}</option>`;
            }
        }
        
        // Render site restriction checkboxes
        function renderAgentSitesCheckboxes(selectedSites = []) {
            const container = document.getElementById('agentSitesCheckboxes');
            if (!container) return;
            
            container.innerHTML = '';
            
            // Use siteConfigCache to get available sites
            for (const [siteId, siteInfo] of Object.entries(siteConfigCache)) {
                const isChecked = selectedSites.includes(siteId);
                const icon = siteInfo.icon || '📁';
                const name = siteInfo.name || siteId;
                
                container.innerHTML += `
                    <label style="display: inline-flex; align-items: center; gap: 0.3rem; margin-left: 1rem; cursor: pointer;">
                        <input type="checkbox" class="agent-site-checkbox" value="${siteId}" ${isChecked ? 'checked' : ''}>
                        ${icon} ${name}
                    </label>
                `;
            }
            
            // If no sites selected, add info text
            if (Object.keys(siteConfigCache).length === 0) {
                container.innerHTML = '<span style="color: #888;">טוען אתרים...</span>';
                loadSiteConfig().then(() => renderAgentSitesCheckboxes(selectedSites));
            }
        }
        
        // Get selected sites from checkboxes
        function getSelectedAgentSites() {
            const checkboxes = document.querySelectorAll('.agent-site-checkbox:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }
        
        async function selectBuilderAgent(agentId) {
            try {
                console.log('📋 selectBuilderAgent:', agentId);
                const result = await apiCall(`/api/agents/${agentId}`);
                console.log('📋 API result:', result);
                
                if (result.success) {
                    currentAgent = result.agent;
                    currentAgent.id = agentId;
                    renderAgentEditor(result.agent);
                    
                    // Update step reports shortcodes for this agent
                    updateStepReportsShortcodes(result.agent);
                    
                    // Load custom data sources
                    loadCustomDataSources();
                    
                    // Update list selection - find and highlight by agentId
                    document.querySelectorAll('.agent-list-card').forEach(card => {
                        card.classList.remove('active');
                    });
                    // Re-render the list to update active state
                    renderAgentList(agents);
                } else {
                    console.error('API returned error:', result.error);
                    showToast(`שגיאה: ${result.error || 'לא ידוע'}`, 'error');
                }
            } catch (e) {
                console.error('Error loading agent:', e);
                showToast('שגיאה בטעינת סוכן: ' + e.message, 'error');
            }
        }
        
        function updateStepReportsShortcodes(agent) {
            const container = document.getElementById('stepReportsList');
            if (!container) return;
            
            container.innerHTML = '';
            
            // Get steps
            const steps = agent.steps || [];
            let stepCount = steps.length;
            
            // Fallback to stepX format
            if (stepCount === 0) {
                for (let i = 1; i <= 10; i++) {
                    if (agent[`step${i}`]) stepCount++;
                }
            }
            
            // Add step report shortcodes
            for (let i = 1; i <= stepCount; i++) {
                const step = steps[i-1] || agent[`step${i}`] || {};
                const stepName = step.name || `שלב ${i}`;
                const shortcodeName = step.output?.shortcode_name || `STEP${i}_REPORT`;
                const promptFile = step.prompt_file || step.agent || '';
                
                const item = document.createElement('div');
                item.className = 'shortcode-item';
                item.onclick = () => insertShortcode(shortcodeName);
                item.title = `דוח מ${stepName}\nקובץ: ${promptFile}`;
                item.innerHTML = `{{${shortcodeName}}}`;
                container.appendChild(item);
            }
            
            // Add PREVIOUS_STEP_REPORT
            const prevItem = document.createElement('div');
            prevItem.className = 'shortcode-item step-context';
            prevItem.onclick = () => insertShortcode('PREVIOUS_STEP_REPORT');
            prevItem.title = 'דוח מהשלב הקודם (דינאמי)';
            prevItem.innerHTML = '{{PREVIOUS_STEP_REPORT}}<span class="shortcode-hint">🔄 שלב קודם</span>';
            container.appendChild(prevItem);
            
            // Update step files list
            updateStepFilesList(agent);
        }
        
        function updateStepFilesList(agent) {
            const container = document.getElementById('stepFilesList');
            if (!container) return;
            
            container.innerHTML = '';
            
            // Get steps
            const steps = agent.steps || [];
            let stepCount = steps.length;
            
            // Fallback to stepX format
            if (stepCount === 0) {
                for (let i = 1; i <= 10; i++) {
                    if (agent[`step${i}`]) stepCount++;
                }
            }
            
            if (stepCount === 0) {
                container.innerHTML = '<div class="step-file-note">אין שלבים בסוכן זה</div>';
                return;
            }
            
            // Create step file items
            for (let i = 1; i <= stepCount; i++) {
                const step = steps[i-1] || agent[`step${i}`] || {};
                const stepName = step.name || `שלב ${i}`;
                let promptFile = step.prompt_file || step.agent || '';
                
                // Add .md extension if missing
                if (promptFile && !promptFile.endsWith('.md')) {
                    promptFile += '.md';
                }
                
                const shortcodeName = `STEP${i}_PROMPT_FILE`;
                
                const item = document.createElement('div');
                item.className = 'step-file-item';
                item.innerHTML = `
                    <div class="step-file-header">
                        <span class="step-file-num">שלב ${i}</span>
                        <div class="step-file-actions">
                            <button class="step-file-btn" onclick="copyShortcode('${shortcodeName}')" title="העתק שורטקוד">📋</button>
                            <button class="step-file-btn" onclick="insertShortcode('${shortcodeName}')" title="הכנס לעורך">⬇️</button>
                            <button class="step-file-btn edit" onclick="editPromptFile('${promptFile}')" title="ערוך קובץ">✏️</button>
                            <button class="step-file-btn" onclick="linkPromptFile(${i-1})" title="קשר קובץ">🔗</button>
                        </div>
                    </div>
                    <div class="step-file-path" onclick="copyShortcode('${shortcodeName}')" title="לחץ להעתקה">
                        ${promptFile || 'לא הוגדר קובץ'}
                    </div>
                    <div class="step-file-shortcode" onclick="copyShortcode('${shortcodeName}')" style="cursor:pointer;" title="לחץ להעתקה">{{${shortcodeName}}}</div>
                `;
                container.appendChild(item);
            }
        }
        
        // Link a prompt file to a step
        function linkPromptFile(stepIndex) {
            if (!currentAgent?.steps?.[stepIndex]) {
                showToast('שלב לא נמצא', 'error');
                return;
            }
            
            const step = currentAgent.steps[stepIndex];
            const currentPath = step.prompt_file || '';
            const folderName = currentAgent.folder_name || 'סוכן';
            const suggestedPath = currentPath || `פרומטים/${folderName}/שלב ${stepIndex + 1}.md`;
            
            const newPath = prompt('הזן נתיב לקובץ הפרומפט:', suggestedPath);
            
            if (newPath !== null) {
                step.prompt_file = newPath;
                updateStepFilesList(currentAgent);
                
                // Also update the input in the step card if visible
                const promptFileInput = document.getElementById(`promptFile_${stepIndex}`);
                if (promptFileInput) {
                    promptFileInput.value = newPath;
                }
                
                showToast(`נתיב עודכן: ${newPath}`, 'success');
            }
        }
        
        // Toggle collapsible sections
        function toggleSection(header) {
            header.classList.toggle('collapsed');
            const content = header.nextElementSibling;
            if (content && content.classList.contains('collapsible-content')) {
                content.classList.toggle('collapsed');
            }
        }
        
        function copyShortcode(shortcodeName) {
            const text = `{{${shortcodeName}}}`;
            navigator.clipboard.writeText(text).then(() => {
                showToast(`הועתק: ${text}`, 'success');
            }).catch(err => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showToast(`הועתק: ${text}`, 'success');
            });
        }
        
        async function editPromptFile(filePath) {
            if (!filePath) {
                showToast('לא הוגדר קובץ', 'error');
                return;
            }
            
            try {
                // Fetch file content
                const result = await apiCall(`/api/prompt-file?path=${encodeURIComponent(filePath)}`);
                if (result.success) {
                    openFileEditorModal(filePath, result.content);
                } else {
                    showToast(result.error || 'שגיאה בטעינת הקובץ', 'error');
                }
            } catch (e) {
                console.error('Error loading file:', e);
                showToast('שגיאה בטעינת הקובץ', 'error');
            }
        }
        
        function openFileEditorModal(filePath, content) {
            // Create or show file editor modal
            let modal = document.getElementById('fileEditorModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'fileEditorModal';
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal" style="max-width: 900px; width: 90%;">
                        <div class="modal-header">
                            <h2>📝 עריכת קובץ</h2>
                            <button class="modal-close" onclick="closeModal('fileEditorModal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div style="margin-bottom: 1rem;">
                                <label style="font-weight: bold;">נתיב:</label>
                                <code id="fileEditorPath" style="background: var(--bg-tertiary); padding: 0.3rem 0.6rem; border-radius: 4px; font-size: 0.85rem;"></code>
                            </div>
                            <textarea id="fileEditorContent" style="width: 100%; min-height: 500px; font-family: monospace; font-size: 0.9rem; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border); border-radius: 6px; padding: 1rem; direction: ltr; text-align: left;"></textarea>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeModal('fileEditorModal')">ביטול</button>
                            <button class="btn btn-primary" onclick="savePromptFile()">💾 שמור</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            document.getElementById('fileEditorPath').textContent = filePath;
            document.getElementById('fileEditorContent').value = content;
            modal.dataset.filePath = filePath;
            openModal('fileEditorModal');
        }
        
        async function savePromptFile() {
            const modal = document.getElementById('fileEditorModal');
            const filePath = modal.dataset.filePath;
            const content = document.getElementById('fileEditorContent').value;
            
            try {
                const result = await apiCall('/api/prompt-file', {
                    method: 'POST',
                    body: JSON.stringify({ path: filePath, content: content })
                });
                
                if (result.success) {
                    showToast('הקובץ נשמר בהצלחה', 'success');
                    closeModal('fileEditorModal');
                } else {
                    showToast(result.error || 'שגיאה בשמירה', 'error');
                }
            } catch (e) {
                console.error('Error saving file:', e);
                showToast('שגיאה בשמירת הקובץ', 'error');
            }
        }
        
        async function loadCustomDataSources() {
            try {
                const result = await apiCall('/api/data-sources');
                if (result.success) {
                    const container = document.getElementById('customSourcesList');
                    if (!container) return;
                    
                    container.innerHTML = '';
                    
                    for (const source of result.sources || []) {
                        const item = document.createElement('div');
                        item.className = 'shortcode-item';
                        item.style.display = 'flex';
                        item.style.justifyContent = 'space-between';
                        item.style.alignItems = 'center';
                        
                        const textSpan = document.createElement('span');
                        textSpan.textContent = `{{${source.shortcode}}}`;
                        textSpan.onclick = () => insertShortcode(source.shortcode);
                        textSpan.style.cursor = 'pointer';
                        textSpan.title = `${source.description}\nנתיב: ${source.path}`;
                        
                        const deleteBtn = document.createElement('span');
                        deleteBtn.textContent = '×';
                        deleteBtn.style.cursor = 'pointer';
                        deleteBtn.style.color = '#ef4444';
                        deleteBtn.style.marginRight = '5px';
                        deleteBtn.onclick = (e) => {
                            e.stopPropagation();
                            deleteDataSource(source.id);
                        };
                        
                        item.appendChild(textSpan);
                        item.appendChild(deleteBtn);
                        container.appendChild(item);
                    }
                    
                    // Add button
                    const btn = document.createElement('button');
                    btn.className = 'add-source-btn';
                    btn.onclick = openAddDataSourceModal;
                    btn.textContent = '+ הוסף מאגר';
                    container.appendChild(btn);
                }
            } catch (e) {
                console.error('Error loading data sources:', e);
            }
        }
        
        function openAddDataSourceModal() {
            const modal = document.getElementById('dataSourceModal');
            document.getElementById('dataSourceName').value = '';
            document.getElementById('dataSourceShortcode').value = '';
            document.getElementById('dataSourcePath').value = '';
            document.getElementById('dataSourceDescription').value = '';
            delete modal.dataset.editId;  // Clear edit mode
            openModal('dataSourceModal');
        }
        
        async function saveDataSource() {
            const modal = document.getElementById('dataSourceModal');
            const editId = modal?.dataset?.editId;
            const name = document.getElementById('dataSourceName').value.trim();
            const shortcode = document.getElementById('dataSourceShortcode').value.trim().toUpperCase();
            const path = document.getElementById('dataSourcePath').value.trim();
            const description = document.getElementById('dataSourceDescription').value.trim();
            
            if (!name || !shortcode || !path) {
                showToast('נא למלא שם, שורטקוד ונתיב', 'error');
                return;
            }
            
            try {
                let result;
                if (editId) {
                    // Update existing
                    result = await apiCall(`/api/data-sources/${editId}`, {
                        method: 'PUT',
                        body: JSON.stringify({
                            name: name,
                            shortcode: shortcode,
                            path: path,
                            description: description
                        })
                    });
                } else {
                    // Create new
                    result = await apiCall('/api/data-sources', {
                        method: 'POST',
                        body: JSON.stringify({
                            id: shortcode.toLowerCase().replace(/_/g, '-'),
                            name: name,
                            shortcode: shortcode,
                            path: path,
                            description: description
                        })
                    });
                }
                
                if (result.success) {
                    showToast(editId ? 'מאגר עודכן בהצלחה' : 'מאגר נוסף בהצלחה', 'success');
                    closeModal('dataSourceModal');
                    delete modal.dataset.editId;  // Clear edit mode
                    loadDataSources();
                } else {
                    showToast(result.error || 'שגיאה בשמירה', 'error');
                }
            } catch (e) {
                showToast('שגיאה בשמירה', 'error');
            }
        }
        
        // Legacy deleteDataSource - replaced by new one above
        async function deleteDataSourceLegacy(sourceId) {
            if (!confirm(`האם למחוק את המאגר ${sourceId}?`)) return;
            
            try {
                const result = await apiCall(`/api/data-sources/${sourceId}`, {
                    method: 'DELETE'
                });
                
                if (result.success) {
                    showToast('מאגר נמחק', 'success');
                    loadCustomDataSources();
                } else {
                    showToast(result.error || 'שגיאה במחיקה', 'error');
                }
            } catch (e) {
                showToast('שגיאה במחיקה', 'error');
            }
        }
        
        function renderAgentEditor(agent) {
            console.log('🎨 renderAgentEditor:', agent);
            
            if (!agent) {
                console.error('renderAgentEditor: agent is null/undefined');
                return;
            }
            
            try {
                // Show editor controls
                const noAgentEl = document.getElementById('noAgentSelected');
                if (noAgentEl) noAgentEl.style.display = 'none';
                
                const settingsPanel = document.getElementById('agentSettingsPanel');
                if (settingsPanel) settingsPanel.style.display = 'block';
                
                const saveBtn = document.getElementById('saveAgentBtn');
                if (saveBtn) saveBtn.style.display = 'inline-flex';
                
                const deleteBtn = document.getElementById('deleteAgentBtn');
                if (deleteBtn) deleteBtn.style.display = 'inline-flex';
                
                const duplicateBtn = document.getElementById('duplicateAgentBtn');
                if (duplicateBtn) duplicateBtn.style.display = 'inline-flex';
                
                // Show and update agent header in steps editor
                const agentHeader = document.getElementById('currentAgentHeader');
                if (agentHeader) agentHeader.style.display = 'flex';
                
                const editingName = document.getElementById('editingAgentName');
                if (editingName) editingName.textContent = agent.name || agent.id;
            } catch (e) {
                console.error('Error in renderAgentEditor setup:', e);
            }
            
            const editingTypeEl = document.getElementById('editingAgentType');
            if (editingTypeEl) {
                editingTypeEl.className = 'agent-type-badge ' + (agent.type === 'build' || agent.mode === 'build' ? 'build' : 'update');
                editingTypeEl.textContent = agent.type === 'build' || agent.mode === 'build' ? 'בנייה' : 'עדכון';
            }
            
            // Count steps for display
            let stepCount = agent.steps?.length || 0;
            if (stepCount === 0) {
                for (let i = 1; i <= 10; i++) {
                    if (agent[`step${i}`]) stepCount++;
                }
            }
            const stepsEl = document.getElementById('editingAgentSteps');
            if (stepsEl) stepsEl.textContent = `${stepCount} שלבים`;
            
            // Update sidebar header (legacy)
            const nameEl = document.getElementById('currentAgentName');
            if (nameEl) nameEl.textContent = agent.name || agent.id;
            
            const typeEl = document.getElementById('currentAgentType');
            if (typeEl) {
                typeEl.style.display = 'inline';
                typeEl.className = 'agent-type-badge ' + (agent.type === 'build' ? 'build' : 'update');
                typeEl.textContent = agent.type === 'build' ? 'בנייה' : 'עדכון';
            }
            
            // Fill settings (with null checks)
            const setVal = (id, val) => { const el = document.getElementById(id); if (el) el.value = val; };
            setVal('agentNameInput', agent.name || '');
            setVal('agentIdInput', agent.id || '');
            setVal('agentDescInput', agent.description || '');
            setVal('agentFolderInput', agent.folder_name || '');
            setVal('agentTypeSelect', agent.type || 'update');
            setVal('agentStatusSelect', agent.status || 'active');
            setVal('agentModelSelect', agent.model?.name || 'claude-sonnet-4-5');
            
            // Site restrictions
            renderAgentSitesCheckboxes(agent.sites || []);
            
            // Chain settings
            const chainEnabled = agent.chain?.enabled || false;
            const chainCheck = document.getElementById('chainEnabledCheck');
            if (chainCheck) chainCheck.checked = chainEnabled;
            const chainRow = document.getElementById('chainAgentRow');
            if (chainRow) chainRow.style.display = chainEnabled ? 'block' : 'none';
            setVal('chainAgentSelect', agent.chain?.next_agent || '');
            
            // WordPress settings
            setVal('wpActionSelect', agent.wordpress?.action || '');
            setVal('wpSiteSelect', agent.wordpress?.site || 'main');
            const wpCatRow = document.getElementById('wpCategoryRow');
            if (wpCatRow) wpCatRow.style.display = agent.wordpress?.action === 'create' ? 'block' : 'none';
            
            // Convert old format steps (step1, step2...) to array if needed
            let stepsArray = agent.steps || [];
            if (stepsArray.length === 0) {
                // Check for old format
                for (let i = 1; i <= 10; i++) {
                    const stepKey = `step${i}`;
                    if (agent[stepKey]) {
                        const oldStep = agent[stepKey];
                        stepsArray.push({
                            id: stepKey,
                            name: oldStep.name || `שלב ${i}`,
                            order: i,
                            prompt_file: oldStep.agent || '',
                            prompt_template: oldStep.prompt_template || '', // Include full template if exists
                            shortcodes: oldStep.shortcodes || [],
                            output: {
                                path: oldStep.output_name || oldStep.report_name || `דוח שלב ${i}.md`,
                                shortcode_name: `STEP${i}_REPORT`
                            }
                        });
                    }
                }
            }
            currentAgent.steps = stepsArray; // Store in currentAgent for editing
            
            // Expand first step by default and adjust textarea height
            setTimeout(() => {
                // Open first step
                const firstStepBody = document.getElementById('stepBody_0');
                if (firstStepBody) {
                    firstStepBody.style.display = 'block';
                    firstStepBody.closest('.step-card')?.classList.add('expanded');
                }
                
                // Adjust textarea height based on content
                const editor = document.getElementById('promptEditor_0');
                if (editor && editor.value.length > 100) {
                    editor.style.minHeight = Math.min(600, editor.scrollHeight) + 'px';
                }
            }, 100);
            
            // Render steps
            renderAgentSteps(stepsArray);
            
            // Load data sources
            loadDataSources();
        }
        
        function renderAgentSteps(steps) {
            const container = document.getElementById('stepsList');
            container.innerHTML = '';
            
            steps.forEach((step, index) => {
                const stepCard = document.createElement('div');
                stepCard.className = 'step-card';
                stepCard.innerHTML = `
                    <div class="step-card-header" onclick="toggleStepCard(${index})">
                        <div class="step-card-title">
                            <span class="step-number">${step.order || index + 1}</span>
                            <input type="text" value="${step.name || ''}" 
                                   onchange="updateStepField(${index}, 'name', this.value)"
                                   onclick="event.stopPropagation()"
                                   style="border: none; background: transparent; font-weight: 600; font-size: 1rem; color: var(--text-primary);">
                        </div>
                        <div>
                            <button class="btn btn-small btn-secondary" onclick="event.stopPropagation(); moveStep(${index}, -1)" ${index === 0 ? 'disabled' : ''}>↑</button>
                            <button class="btn btn-small btn-secondary" onclick="event.stopPropagation(); moveStep(${index}, 1)" ${index === steps.length - 1 ? 'disabled' : ''}>↓</button>
                            <button class="btn btn-small btn-danger" onclick="event.stopPropagation(); removeStep(${index})">🗑️</button>
                        </div>
                    </div>
                    <div class="step-card-body" id="stepBody_${index}">
                        <div class="setting-row prompt-file-row">
                            <div>
                                <label>📂 קובץ פרומפט</label>
                                <input type="text" value="${step.prompt_file || ''}" 
                                       id="promptFile_${index}"
                                       onchange="updateStepField(${index}, 'prompt_file', this.value)"
                                       placeholder="פרומטים/סוכן.md">
                            </div>
                            <div class="prompt-buttons">
                                <button class="load-prompt-btn" onclick="loadPromptFileContent(${index})" title="טען את קובץ התבנית">📖 תבנית</button>
                                <button class="load-prompt-btn preview-btn" onclick="previewRenderedPrompt(${index})" title="הצג פרומפט מלא עם מידע דינמי">👁️ תצוגה מקדימה</button>
                            </div>
                        </div>
                        <div class="setting-row prompt-main-editor">
                            <div class="prompt-editor-header">
                                <label>📝 תבנית הפרומפט המלאה</label>
                                <div class="prompt-editor-actions">
                                    <button type="button" class="btn btn-small btn-secondary" onclick="insertAtCursor(${index}, '{{PAGE_HTML}}')">+ PAGE_HTML</button>
                                    <button type="button" class="btn btn-small btn-secondary" onclick="insertAtCursor(${index}, '{{KEYWORDS_AUTOCOMPLETE}}')">+ KEYWORDS</button>
                                    <button type="button" class="btn btn-small btn-secondary" onclick="insertAtCursor(${index}, '{{SERP_ORGANIC}}')">+ SERP</button>
                                    <button type="button" class="btn btn-small btn-secondary" onclick="insertAtCursor(${index}, '{{STEP'+(index)+'_REPORT}}')">+ PREV_REPORT</button>
                                </div>
                            </div>
                            <textarea class="prompt-editor" id="promptEditor_${index}"
                                      onchange="updateStepField(${index}, 'prompt_template', this.value)"
                                      oninput="autoResizeTextarea(this)"
                                      placeholder="כתוב כאן את הפרומפט המלא עם {{שורטקודים}}...

דוגמה:
קרא את קובץ ההוראות {{PROMPT_FILE_PATH}} ובצע את ההוראות.

## מילות מפתח
{{KEYWORDS_AUTOCOMPLETE}}

## מידע ממתחרים  
{{SERP_ORGANIC}}

בסוף שמור את הדוח ב: {{OUTPUT_PATH}}">${formatPromptTemplate(step.prompt_template || '')}</textarea>
                            <div class="prompt-editor-hint">
                                💡 ערוך את התבנית המלאה כאן. השורטקודים ({{...}}) יוחלפו בנתונים אמיתיים בזמן ריצה.
                            </div>
                        </div>
                        <div class="setting-row" style="display: flex; gap: 1rem;">
                            <div style="flex: 1;">
                                <label>📤 קובץ פלט</label>
                                <input type="text" value="${step.output?.path || ''}" 
                                       onchange="updateStepOutput(${index}, 'path', this.value)"
                                       placeholder="דוח שלב X.md">
                            </div>
                            <div style="flex: 1;">
                                <label>🏷️ שם שורטקוד לפלט</label>
                                <input type="text" value="${step.output?.shortcode_name || ''}" 
                                       onchange="updateStepOutput(${index}, 'shortcode_name', this.value)"
                                       placeholder="STEP${index + 1}_REPORT">
                            </div>
                        </div>
                        <div class="setting-row">
                            <label>🧠 מודל AI</label>
                            <select onchange="updateStepField(${index}, 'model', this.value)" style="max-width: 250px;">
                                <option value="" ${!step.model ? 'selected' : ''}>ברירת מחדל (מהסוכן)</option>
                                <option value="claude-opus-4-5" ${step.model === 'claude-opus-4-5' ? 'selected' : ''}>Claude Opus 4.5</option>
                                <option value="claude-sonnet-4-5" ${step.model === 'claude-sonnet-4-5' ? 'selected' : ''}>Claude Sonnet 4.5</option>
                                <option value="claude-sonnet-4" ${step.model === 'claude-sonnet-4' ? 'selected' : ''}>Claude Sonnet 4</option>
                                <option value="claude-haiku-4-5" ${step.model === 'claude-haiku-4-5' ? 'selected' : ''}>Claude Haiku 4.5</option>
                            </select>
                        </div>
                        <div class="setting-row">
                            <label>🏷️ שורטקודים בשימוש <span style="color: var(--text-tertiary);">(הפרד בפסיקים)</span></label>
                            <input type="text" value="${(step.shortcodes || []).join(', ')}" 
                                   onchange="updateStepShortcodes(${index}, this.value)"
                                   placeholder="PAGE_HTML, KEYWORDS_AUTOCOMPLETE, SERP_ORGANIC"
                                   style="font-family: monospace;">
                        </div>
                        <div class="shortcodes-helper">
                            <span class="helper-label">הוסף שורטקוד:</span>
                            <button type="button" class="shortcode-add-btn" onclick="addShortcodeToStep(${index}, 'PAGE_HTML')">PAGE_HTML</button>
                            <button type="button" class="shortcode-add-btn" onclick="addShortcodeToStep(${index}, 'PAGE_KEYWORD')">PAGE_KEYWORD</button>
                            <button type="button" class="shortcode-add-btn" onclick="addShortcodeToStep(${index}, 'KEYWORDS_AUTOCOMPLETE')">KEYWORDS</button>
                            <button type="button" class="shortcode-add-btn" onclick="addShortcodeToStep(${index}, 'DENSITY_ANALYSIS')">DENSITY</button>
                            <button type="button" class="shortcode-add-btn" onclick="addShortcodeToStep(${index}, 'SERP_ORGANIC')">SERP</button>
                            <button type="button" class="shortcode-add-btn" onclick="addShortcodeToStep(${index}, 'SERP_AI_OVERVIEW')">AI_OVERVIEW</button>
                            <button type="button" class="shortcode-add-btn" onclick="addShortcodeToStep(${index}, 'STEP'+(index)+'_REPORT')">PREV_REPORT</button>
                        </div>
                    </div>
                `;
                container.appendChild(stepCard);
            });
            
            // Add "Add Step" button
            const addBtn = document.createElement('button');
            addBtn.className = 'add-step-btn';
            addBtn.innerHTML = '➕ הוסף שלב חדש';
            addBtn.onclick = addNewStep;
            container.appendChild(addBtn);
        }
        
        function toggleStepCard(index) {
            const body = document.getElementById(`stepBody_${index}`);
            const card = body?.closest('.step-card');
            if (body) {
                const isHidden = body.style.display === 'none' || !body.style.display || body.classList.contains('collapsed');
                if (isHidden) {
                    body.style.display = 'block';
                    body.classList.remove('collapsed');
                    card?.classList.add('expanded');
                    // Auto-resize textarea after showing
                    setTimeout(() => {
                        const editor = document.getElementById(`promptEditor_${index}`);
                        if (editor) autoResizeTextarea(editor);
                    }, 50);
                } else {
                    body.style.display = 'none';
                    body.classList.add('collapsed');
                    card?.classList.remove('expanded');
                }
            }
        }
        
        function updateStepField(index, field, value) {
            if (!currentAgent?.steps?.[index]) return;
            currentAgent.steps[index][field] = value;
            
            // Update step files list when prompt_file changes
            if (field === 'prompt_file') {
                updateStepFilesList(currentAgent);
            }
        }
        
        function updateStepOutput(index, field, value) {
            if (!currentAgent?.steps?.[index]) return;
            if (!currentAgent.steps[index].output) {
                currentAgent.steps[index].output = {};
            }
            currentAgent.steps[index].output[field] = value;
        }
        
        function updateStepShortcodes(index, value) {
            if (!currentAgent?.steps?.[index]) return;
            // Parse comma-separated shortcodes
            const shortcodes = value.split(',')
                .map(s => s.trim().toUpperCase())
                .filter(s => s.length > 0);
            currentAgent.steps[index].shortcodes = shortcodes;
        }
        
        function addShortcodeToStep(index, shortcode) {
            if (!currentAgent?.steps?.[index]) return;
            if (!currentAgent.steps[index].shortcodes) {
                currentAgent.steps[index].shortcodes = [];
            }
            if (!currentAgent.steps[index].shortcodes.includes(shortcode)) {
                currentAgent.steps[index].shortcodes.push(shortcode);
                // Update the input field
                const input = document.querySelector(`#stepBody_${index} input[onchange*="updateStepShortcodes"]`);
                if (input) {
                    input.value = currentAgent.steps[index].shortcodes.join(', ');
                }
                // Also insert into the prompt template at cursor
                insertAtCursor(index, `{{${shortcode}}}`);
                showToast(`נוסף: {{${shortcode}}}`, 'success');
            }
        }
        
        function insertAtCursor(index, text) {
            const editor = document.getElementById(`promptEditor_${index}`);
            if (!editor) return;
            
            const cursorPos = editor.selectionStart;
            const before = editor.value.substring(0, cursorPos);
            const after = editor.value.substring(cursorPos);
            editor.value = before + text + after;
            editor.focus();
            editor.selectionStart = editor.selectionEnd = cursorPos + text.length;
            updateStepField(index, 'prompt_template', editor.value);
        }
        
        // Convert \n from JSON to actual newlines for display
        function formatPromptTemplate(template) {
            if (!template) return '';
            // Convert escaped newlines to actual newlines
            return template
                .replace(/\\n/g, '\n')
                .replace(/\\t/g, '\t');
        }
        
        // Convert newlines back to \n for saving to JSON
        function unformatPromptTemplate(template) {
            if (!template) return '';
            return template;  // Keep as-is, JSON.stringify handles it
        }
        
        // Auto-resize textarea based on content
        function autoResizeTextarea(textarea) {
            // Save scroll position before resize
            const scrollTop = window.scrollY || document.documentElement.scrollTop;
            const scrollLeft = window.scrollX || document.documentElement.scrollLeft;
            
            // Resize the textarea
            textarea.style.height = 'auto';
            textarea.style.height = Math.max(350, Math.min(800, textarea.scrollHeight)) + 'px';
            
            // Restore scroll position after resize (prevent page jump)
            window.scrollTo(scrollLeft, scrollTop);
        }
        
        async function loadPromptFileContent(index) {
            const promptFile = document.getElementById(`promptFile_${index}`)?.value;
            if (!promptFile) {
                showToast('אין קובץ פרומפט להציג', 'warning');
                return;
            }
            
            try {
                const result = await apiCall(`/api/prompt-file?path=${encodeURIComponent(promptFile)}`);
                if (result.success) {
                    const editor = document.getElementById(`promptEditor_${index}`);
                    if (editor) {
                        editor.value = result.content;
                        editor.style.minHeight = '400px';
                        updateStepField(index, 'prompt_template', result.content);
                        showToast('תוכן הפרומפט נטען בהצלחה!', 'success');
                    }
                } else {
                    showToast(result.error || 'שגיאה בטעינת קובץ', 'error');
                }
            } catch (e) {
                showToast('שגיאה: ' + e.message, 'error');
            }
        }
        
        async function previewRenderedPrompt(index) {
            // Show preview modal with rendered prompt
            if (!selectedPagePath) {
                showToast('בחר עמוד כדי לראות תצוגה מקדימה עם נתונים אמיתיים', 'warning');
                return;
            }
            
            const step = currentAgent?.steps?.[index];
            if (!step) {
                showToast('לא נמצא שלב', 'error');
                return;
            }
            
            // Get the template content
            let template = step.prompt_template || '';
            if (!template && step.prompt_file) {
                // Load from file first
                try {
                    const result = await apiCall(`/api/prompt-file?path=${encodeURIComponent(step.prompt_file)}`);
                    if (result.success) {
                        template = result.content;
                    }
                } catch (e) {
                    console.error('Error loading prompt file:', e);
                }
            }
            
            if (!template) {
                showToast('אין תבנית פרומפט להצגה', 'warning');
                return;
            }
            
            // Create modal
            const modal = document.createElement('div');
            modal.className = 'prompt-preview-modal';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            
            modal.innerHTML = `
                <div class="prompt-preview-content">
                    <div class="prompt-preview-header">
                        <h3>👁️ תצוגה מקדימה - ${step.name}</h3>
                        <button class="btn btn-secondary" onclick="this.closest('.prompt-preview-modal').remove()">✕</button>
                    </div>
                    <div class="prompt-preview-body">
                        <div class="prompt-preview-info">
                            <h4>ℹ️ מידע</h4>
                            <p>זוהי התבנית שתשלח לקלוד. השורטקודים (כמו <code>{{KEYWORDS_AUTOCOMPLETE}}</code>) יוחלפו במידע אמיתי בזמן ריצה.</p>
                            <p><strong>עמוד:</strong> ${selectedPagePath || 'לא נבחר'}</p>
                            <p><strong>שורטקודים בשימוש:</strong> ${step.shortcodes?.join(', ') || 'אין'}</p>
                        </div>
                        <div class="prompt-preview-text">${escapeHtml(template)}</div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function moveStep(index, direction) {
            if (!currentAgent?.steps) return;
            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= currentAgent.steps.length) return;
            
            const temp = currentAgent.steps[index];
            currentAgent.steps[index] = currentAgent.steps[newIndex];
            currentAgent.steps[newIndex] = temp;
            
            // Update order numbers
            currentAgent.steps.forEach((step, i) => {
                step.order = i + 1;
            });
            
            renderAgentSteps(currentAgent.steps);
            
            // Update step files list after reordering
            updateStepFilesList(currentAgent);
        }
        
        function removeStep(index) {
            if (!currentAgent?.steps) return;
            if (!confirm('האם למחוק את השלב?')) return;
            
            currentAgent.steps.splice(index, 1);
            
            // Update order numbers
            currentAgent.steps.forEach((step, i) => {
                step.order = i + 1;
                step.id = `step${i + 1}`;
            });
            
            renderAgentSteps(currentAgent.steps);
            
            // Update step files list after removing
            updateStepFilesList(currentAgent);
        }
        
        function addNewStep() {
            if (!currentAgent) return;
            if (!currentAgent.steps) currentAgent.steps = [];
            
            const newIndex = currentAgent.steps.length + 1;
            currentAgent.steps.push({
                id: `step${newIndex}`,
                name: `שלב ${newIndex}`,
                order: newIndex,
                prompt_file: '',
                prompt_template: '',
                shortcodes: [],
                output: {
                    path: `דוח שלב ${newIndex}.md`,
                    shortcode_name: `STEP${newIndex}_REPORT`
                }
            });
            
            renderAgentSteps(currentAgent.steps);
            
            // Update step files list to show new step's prompt file shortcode
            updateStepFilesList(currentAgent);
        }
        
        function insertShortcode(name) {
            // Find the focused prompt editor
            const activeEditor = document.activeElement;
            if (activeEditor && activeEditor.classList.contains('prompt-editor')) {
                const start = activeEditor.selectionStart;
                const end = activeEditor.selectionEnd;
                const text = activeEditor.value;
                const shortcode = `{{${name}}}`;
                
                activeEditor.value = text.substring(0, start) + shortcode + text.substring(end);
                activeEditor.selectionStart = activeEditor.selectionEnd = start + shortcode.length;
                activeEditor.focus();
                
                // Trigger change event
                activeEditor.dispatchEvent(new Event('change'));
            } else {
                // Copy to clipboard
                navigator.clipboard.writeText(`{{${name}}}`);
                showToast(`הועתק: {{${name}}}`, 'success');
            }
        }
        
        async function saveCurrentAgent() {
            if (!currentAgent) return;
            
            // Collect settings from form
            currentAgent.name = document.getElementById('agentNameInput').value;
            currentAgent.description = document.getElementById('agentDescInput').value;
            currentAgent.folder_name = document.getElementById('agentFolderInput').value;
            currentAgent.type = document.getElementById('agentTypeSelect').value;
            currentAgent.status = document.getElementById('agentStatusSelect').value;
            
            currentAgent.model = {
                provider: 'claude',
                name: document.getElementById('agentModelSelect').value,
                temperature: 0.7
            };
            
            // Site restrictions
            currentAgent.sites = getSelectedAgentSites();
            
            currentAgent.chain = {
                enabled: document.getElementById('chainEnabledCheck').checked,
                next_agent: document.getElementById('chainAgentSelect').value || null
            };
            
            const wpAction = document.getElementById('wpActionSelect').value;
            if (wpAction) {
                currentAgent.wordpress = {
                    action: wpAction,
                    site: document.getElementById('wpSiteSelect').value,
                    update_fields: ['content']
                };
            } else {
                currentAgent.wordpress = null;
            }
            
            try {
                const result = await apiCall(`/api/agents/${currentAgent.id}`, {
                    method: 'PUT',
                    body: JSON.stringify(currentAgent)
                });
                
                if (result.success) {
                    showToast('הסוכן נשמר בהצלחה!', 'success');
                    loadAgentBuilderList();
                } else {
                    showToast(result.error || 'שגיאה בשמירה', 'error');
                }
            } catch (e) {
                showToast('שגיאה: ' + e.message, 'error');
            }
        }
        
        function openAddAgentBuilderModal() {
            // Reset form fields
            document.getElementById('builderAgentName').value = '';
            document.getElementById('builderAgentDesc').value = '';
            openModal('addAgentBuilderModal');
        }
        
        function generateAgentId() {
            // Generate unique ID based on timestamp
            const timestamp = Date.now().toString(36);
            const random = Math.random().toString(36).substr(2, 4);
            return `agent_${timestamp}_${random}`;
        }
        
        async function saveNewAgentBuilder() {
            const name = document.getElementById('builderAgentName').value.trim();
            const desc = document.getElementById('builderAgentDesc').value.trim();
            
            // Validation
            if (!name) {
                showToast('נא להזין שם לסוכן', 'error');
                return;
            }
            
            // Auto-generate ID
            const id = generateAgentId();
            
            // Start with 1 step, user will add more in the builder
            const steps = [{
                id: 'step1',
                name: 'שלב 1',
                order: 1,
                prompt_file: '',
                prompt_template: '',
                shortcodes: ['PAGE_HTML'],
                output: {
                    path: 'דוח שלב 1.md',
                    shortcode_name: 'STEP1_REPORT'
                }
            }];
            
            const newAgent = {
                id: id,
                name: name,
                description: desc,
                version: '1.0',
                type: 'update',
                status: 'test',
                model: {
                    provider: 'claude',
                    name: 'claude-sonnet-4',
                    temperature: 0.7
                },
                folder_name: name, // Folder name = agent name
                steps: steps,
                chain: { enabled: false, next_agent: null },
                wordpress: null
            };
            
            try {
                const result = await apiCall('/api/agents', {
                    method: 'POST',
                    body: JSON.stringify(newAgent)
                });
                
                if (result.success) {
                    showToast(`✅ הסוכן "${name}" נוצר בהצלחה!`, 'success');
                    closeModal('addAgentBuilderModal');
                    await loadAgentBuilderList();
                    selectBuilderAgent(id);
                } else {
                    showToast(result.error || 'שגיאה ביצירה', 'error');
                }
            } catch (e) {
                showToast('שגיאה: ' + e.message, 'error');
            }
        }
        
        // Legacy function - kept for backward compatibility
        async function createNewAgent() {
            openAddAgentBuilderModal();
        }
        
        async function deleteAgentById(agentId) {
            const agents = await apiCall('/api/agents');
            const agent = agents?.agents?.[agentId];
            const agentName = agent?.name || agentId;
            
            if (!confirm(`האם למחוק את הסוכן "${agentName}"?`)) return;
            
            try {
                const result = await apiCall(`/api/agents/${agentId}`, {
                    method: 'DELETE'
                });
                
                if (result.success) {
                    showToast(`הסוכן "${agentName}" נמחק`, 'success');
                    
                    // If deleted the current agent, clear the editor
                    if (currentAgent?.id === agentId) {
                        currentAgent = null;
                        document.getElementById('stepsList').innerHTML = `
                            <div class="empty-state" id="noAgentSelected">
                                <div class="empty-state-icon">🤖</div>
                                <p>בחר סוכן מהרשימה או צור סוכן חדש</p>
                            </div>
                        `;
                        document.getElementById('agentSettingsPanel').style.display = 'none';
                        document.getElementById('saveAgentBtn').style.display = 'none';
                        document.getElementById('deleteAgentBtn').style.display = 'none';
                        document.getElementById('currentAgentName').textContent = 'בחר סוכן לעריכה';
                    }
                    
                    await loadAgentBuilderList();
                } else {
                    showToast(result.error || 'שגיאה במחיקה', 'error');
                }
            } catch (e) {
                showToast('שגיאה: ' + e.message, 'error');
            }
        }
        
        async function deleteCurrentAgent() {
            if (!currentAgent) return;
            if (!confirm(`האם למחוק את הסוכן "${currentAgent.name}"?`)) return;
            
            try {
                const result = await apiCall(`/api/agents/${currentAgent.id}`, {
                    method: 'DELETE'
                });
                
                if (result.success) {
                    showToast('הסוכן נמחק', 'success');
                    currentAgent = null;
                    document.getElementById('stepsList').innerHTML = `
                        <div class="empty-state" id="noAgentSelected">
                            <div class="empty-state-icon">🤖</div>
                            <p>בחר סוכן מהרשימה או צור סוכן חדש</p>
                        </div>
                    `;
                    document.getElementById('agentSettingsPanel').style.display = 'none';
                    document.getElementById('saveAgentBtn').style.display = 'none';
                    document.getElementById('deleteAgentBtn').style.display = 'none';
                    document.getElementById('duplicateAgentBtn').style.display = 'none';
                    document.getElementById('currentAgentName').textContent = 'בחר סוכן לעריכה';
                    document.getElementById('currentAgentType').style.display = 'none';
                    loadAgentBuilderList();
                } else {
                    showToast(result.error || 'שגיאה במחיקה', 'error');
                }
            } catch (e) {
                showToast('שגיאה: ' + e.message, 'error');
            }
        }
        
        async function duplicateAgent() {
            if (!currentAgent) return;
            
            const newId = prompt('הזן מזהה לסוכן המשוכפל:', currentAgent.id + '_copy');
            if (!newId) return;
            
            const newName = prompt('הזן שם לסוכן המשוכפל:', currentAgent.name + ' (עותק)');
            if (!newName) return;
            
            try {
                // Use the new full duplication endpoint that copies prompt files too
                const result = await apiCall(`/api/agents/${currentAgent.id}/duplicate`, {
                    method: 'POST',
                    body: JSON.stringify({ 
                        new_id: newId, 
                        new_name: newName 
                    })
                });
                
                if (result.success) {
                    showToast('✅ הסוכן שוכפל בהצלחה עם כל הקבצים!', 'success');
                    loadAgentBuilderList();
                    selectBuilderAgent(newId);
                } else {
                    showToast(result.error || 'שגיאה בשכפול', 'error');
                }
            } catch (e) {
                showToast('שגיאה: ' + e.message, 'error');
            }
        }
        
        // Chain checkbox toggle
        document.getElementById('chainEnabledCheck')?.addEventListener('change', function() {
            document.getElementById('chainAgentRow').style.display = this.checked ? 'block' : 'none';
        });
        
        // WordPress action change
        document.getElementById('wpActionSelect')?.addEventListener('change', function() {
            document.getElementById('wpCategoryRow').style.display = this.value === 'create' ? 'block' : 'none';
            if (this.value === 'create') {
                loadWpCategories();
            }
        });
        
        async function loadWpCategories() {
            const site = document.getElementById('wpSiteSelect').value;
            try {
                const result = await apiCall(`/api/wordpress/categories?site=${site}`);
                if (result.success) {
                    const select = document.getElementById('wpCategorySelect');
                    select.innerHTML = '<option value="">בחר קטגוריה...</option>';
                    result.categories.forEach(cat => {
                        select.innerHTML += `<option value="${cat.id}">${cat.name}</option>`;
                    });
                }
            } catch (e) {
                console.error('Error loading categories:', e);
            }
        }
        
        async function createNewCategory() {
            const name = prompt('הזן שם לקטגוריה החדשה:');
            if (!name) return;
            
            const site = document.getElementById('wpSiteSelect').value;
            try {
                const result = await apiCall('/api/wordpress/categories', {
                    method: 'POST',
                    body: JSON.stringify({ site, name })
                });
                
                if (result.success) {
                    showToast('הקטגוריה נוצרה בהצלחה!', 'success');
                    loadWpCategories();
                    document.getElementById('wpCategorySelect').value = result.category.id;
                } else {
                    showToast(result.error || 'שגיאה ביצירת קטגוריה', 'error');
                }
            } catch (e) {
                showToast('שגיאה: ' + e.message, 'error');
            }
        }
        
        async function loadDataSources() {
            try {
                const result = await apiCall('/api/data-sources');
                if (result.success) {
                    renderDataSources(result.sources);
                    renderCustomDataSourcesShortcodes(result.sources);
                }
            } catch (e) {
                console.error('Error loading data sources:', e);
            }
        }
        
        function renderDataSources(sources) {
            const container = document.getElementById('dataSourcesList');
            if (!container) return;
            
            container.innerHTML = '';
            sources.forEach(source => {
                const item = document.createElement('div');
                item.className = 'data-source-item';
                item.innerHTML = `
                    <div class="data-source-info">
                        <span class="data-source-name">${source.name}</span>
                        <span class="data-source-shortcode">{{${source.shortcode}}}</span>
                    </div>
                    <button class="btn btn-small btn-danger" onclick="deleteDataSource('${source.id}')">🗑️</button>
                `;
                container.appendChild(item);
            });
        }
        
        function renderCustomDataSourcesShortcodes(sources) {
            // Render custom data sources in shortcode sidebar with edit/delete buttons
            const container = document.getElementById('customDataSourcesList');
            if (!container) return;
            
            container.innerHTML = '';
            sources.forEach(source => {
                const item = document.createElement('div');
                item.className = 'shortcode-item';
                item.title = source.description || source.path;
                item.innerHTML = `
                    <span onclick="copyShortcode('${source.shortcode}')" ondblclick="insertShortcode('${source.shortcode}')" style="flex:1;cursor:pointer;">
                        📁 {{${source.shortcode}}}
                    </span>
                    <div class="shortcode-actions">
                        <button onclick="editDataSource('${source.id}')" title="ערוך">✏️</button>
                        <button onclick="deleteDataSource('${source.id}')" title="מחק">🗑️</button>
                    </div>
                `;
                container.appendChild(item);
            });
            
            if (sources.length === 0) {
                container.innerHTML = '<div class="no-sources">אין מאגרים מוגדרים</div>';
            }
        }
        
        async function editDataSource(sourceId) {
            try {
                const result = await apiCall('/api/data-sources');
                if (!result.success) return;
                
                const source = result.sources.find(s => s.id === sourceId);
                if (!source) {
                    showToast('מאגר לא נמצא', 'error');
                    return;
                }
                
                // Fill modal with current values
                document.getElementById('dataSourceName').value = source.name || '';
                document.getElementById('dataSourceShortcode').value = source.shortcode || '';
                document.getElementById('dataSourcePath').value = source.path || '';
                document.getElementById('dataSourceDescription').value = source.description || '';
                
                // Store source ID for update
                document.getElementById('dataSourceModal').dataset.editId = sourceId;
                
                openModal('dataSourceModal');
            } catch (e) {
                showToast('שגיאה בטעינת מאגר', 'error');
            }
        }
        
        async function deleteDataSource(sourceId) {
            if (!confirm('למחוק את המאגר?')) return;
            
            try {
                const result = await apiCall(`/api/data-sources/${sourceId}`, { method: 'DELETE' });
                if (result.success) {
                    showToast('מאגר נמחק', 'success');
                    loadDataSources();
                } else {
                    showToast(result.error || 'שגיאה במחיקה', 'error');
                }
            } catch (e) {
                showToast('שגיאה במחיקה', 'error');
            }
        }
        
        async function addDataSource() {
            const id = prompt('מזהה המאגר (באנגלית):');
            if (!id) return;
            
            const name = prompt('שם המאגר:');
            if (!name) return;
            
            const shortcode = prompt('שם השורטקוד (באנגלית, ללא סוגריים):');
            if (!shortcode) return;
            
            const path = prompt('נתיב לקובץ:');
            if (!path) return;
            
            const source = {
                id,
                name,
                shortcode: shortcode.toUpperCase(),
                path,
                type: 'text',
                description: name
            };
            
            try {
                const result = await apiCall('/api/data-sources', {
                    method: 'POST',
                    body: JSON.stringify(source)
                });
                
                if (result.success) {
                    showToast('המאגר נוסף בהצלחה!', 'success');
                    loadDataSources();
                } else {
                    showToast(result.error || 'שגיאה בהוספת מאגר', 'error');
                }
            } catch (e) {
                showToast('שגיאה: ' + e.message, 'error');
            }
        }
        
        async function deleteDataSource(sourceId) {
            if (!confirm('האם למחוק את המאגר?')) return;
            
            try {
                const result = await apiCall(`/api/data-sources/${sourceId}`, {
                    method: 'DELETE'
                });
                
                if (result.success) {
                    showToast('המאגר נמחק', 'success');
                    loadDataSources();
                } else {
                    showToast(result.error || 'שגיאה במחיקה', 'error');
                }
            } catch (e) {
                showToast('שגיאה: ' + e.message, 'error');
            }
        }
    </script>
    
    <!-- Prompt Modal -->
    <div id="promptModal" class="modal-overlay" onclick="closePromptModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 id="promptModalTitle">📝 פרומפט שנשלח לקלוד</h2>
                <button class="modal-close" onclick="closePromptModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="promptModalContent" class="prompt-content">טוען...</div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="copyPromptContent()">📋 העתק</button>
                <button class="btn" onclick="closePromptModal()">סגור</button>
            </div>
        </div>
    </div>
    
    <script>
        // Prompt Modal Functions
        function openPromptModal(pagePath, step, agentType, agentId = null) {
            const modal = document.getElementById('promptModal');
            const titleEl = document.getElementById('promptModalTitle');
            const contentEl = document.getElementById('promptModalContent');
            
            // Get agent ID from selected agent if not provided
            if (!agentId && selectedAgent) {
                agentId = selectedAgent.id;
            }
            
            // Get step name from agent if available
            let stepName = step;
            const stepNum = parseInt(step.replace('step', ''));
            if (selectedAgent) {
                if (selectedAgent.steps && selectedAgent.steps[stepNum - 1]) {
                    stepName = selectedAgent.steps[stepNum - 1].name || `שלב ${stepNum}`;
                } else if (selectedAgent[step]) {
                    stepName = selectedAgent[step].name || `שלב ${stepNum}`;
                }
            } else {
                const defaultNames = {
                    'step1': 'שלב 1 - דוח תוכן',
                    'step2': 'שלב 2 - הרחבת דוח',
                    'step3': 'שלב 3 - יישום תיקונים',
                    'step4': 'שלב 4 - Debug',
                    'step5': 'שלב 5 - הסרת AI',
                    'step6': 'שלב 6 - QA סופי'
                };
                stepName = defaultNames[step] || step;
            }
            
            titleEl.textContent = `📝 פרומפט - ${stepName}`;
            contentEl.textContent = 'טוען...';
            modal.classList.add('active');
            
            // Fetch prompt - now with agent_id for full template
            let url = `/api/step/prompt?page_path=${encodeURIComponent(pagePath)}&step=${step}&agent_type=${agentType}`;
            if (agentId) {
                url += `&agent_id=${encodeURIComponent(agentId)}`;
            }
            
            fetch(url)
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        // Show source indicator
                        let sourceIndicator = '';
                        if (data.source === 'agent_template') {
                            sourceIndicator = '<div class="prompt-source">📋 מקור: תבנית סוכן (עם שורטקודים מוחלפים)</div>';
                        } else {
                            sourceIndicator = '<div class="prompt-source">📁 מקור: קובץ שנשמר</div>';
                        }
                        
                        // Format and highlight content
                        let content = data.prompt || '';
                        
                        // Convert newlines to HTML
                        content = content.replace(/\n/g, '<br>');
                        
                        // Highlight shortcode placeholders that weren't replaced
                        content = content.replace(/\{\{([^}]+)\}\}/g, '<span class="shortcode-placeholder">{{$1}}</span>');
                        
                        // Highlight section headers
                        content = content.replace(/(## [^\<]+)/g, '<div class="prompt-section-header">$1</div>');
                        
                        // Highlight keyword sections
                        content = content.replace(/(מילות מפתח נלוות|מילות מפתח חשובות)/g, 
                            '<span class="prompt-highlight">$1</span>');
                        
                        contentEl.innerHTML = sourceIndicator + '<div class="prompt-body">' + content + '</div>';
                    } else {
                        contentEl.textContent = `❌ שגיאה: ${data.error}`;
                    }
                })
                .catch(err => {
                    contentEl.textContent = `❌ שגיאה: ${err.message}`;
                });
        }
        
        function closePromptModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('promptModal').classList.remove('active');
        }
        
        function copyPromptContent() {
            const content = document.getElementById('promptModalContent').innerText;
            navigator.clipboard.writeText(content).then(() => {
                showToast('הפרומפט הועתק', 'success');
            }).catch(err => {
                showToast('שגיאה בהעתקה', 'error');
            });
        }
        
        function showPromptButton(step) {
            // Show the prompt button immediately when a step starts running
            console.log('📝 showPromptButton called with step:', step);
            const promptBtn = document.getElementById('viewPromptBtn');
            if (!promptBtn) return;
            
            // Use the actual agent ID - dynamic for all agents!
            const agentId = selectedAgent?.id || 'seo';
            const agentType = selectedAgent?.folder_name || selectedAgent?.folder || 'SEO';
            
            // Store current prompt info for viewing
            window.currentPromptInfo = {
                pagePath: selectedPage?.path,
                step: step,
                agentType: agentType,
                agentId: agentId  // Store actual agent ID
            };
            console.log('📝 Set currentPromptInfo to:', window.currentPromptInfo);
            
            // Mark that a step is running - create a COPY to prevent overwriting
            window.runningStepPromptInfo = {
                pagePath: selectedPage?.path,
                step: step,
                agentType: agentType,
                agentId: agentId  // Store actual agent ID
            };
            console.log('📝 Set runningStepPromptInfo to:', window.runningStepPromptInfo);
            
            // Show the button with animation
            promptBtn.style.display = 'inline-flex';
            promptBtn.classList.add('pulse-animation');
            
            // Remove animation after 2 seconds
            setTimeout(() => {
                promptBtn.classList.remove('pulse-animation');
            }, 2000);
        }
        
        function clearRunningStepPrompt() {
            // Clear the running step marker when step completes
            console.log('🧹 clearRunningStepPrompt called, stack:', new Error().stack);
            window.runningStepPromptInfo = null;
        }
        
        function viewCurrentPrompt() {
            console.log('📝 viewCurrentPrompt called');
            console.log('📝 currentPromptInfo:', window.currentPromptInfo);
            console.log('📝 runningStepPromptInfo:', window.runningStepPromptInfo);
            
            // Use runningStepPromptInfo if a step is actively running (takes priority!)
            const promptInfo = window.runningStepPromptInfo || window.currentPromptInfo;
            
            if (!promptInfo) {
                showToast('אין פרומפט זמין', 'error');
                return;
            }
            const { pagePath, step, agentType, agentId } = promptInfo;
            console.log('📝 Opening prompt for:', { pagePath, step, agentType, agentId });
            openPromptModal(pagePath, step, agentType, agentId);
        }

        // ============ Reports System ============
        
        // Global state for reports
        let currentReportType = 'interest-rate';
        let interestRateData = null;
        let whatsappData = null;
        let yearUpdateData = null;
        
        function initReportsTab() {
            console.log('📊 Initializing reports tab');
            // Auto-scan the current report type
            refreshCurrentReport();
        }
        
        function switchReportType(reportType) {
            currentReportType = reportType;
            
            // Update tab buttons
            document.querySelectorAll('.report-type-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.report === reportType) {
                    tab.classList.add('active');
                }
            });
            
            // Show/hide report content
            document.querySelectorAll('.report-content').forEach(content => {
                content.classList.remove('active');
            });
            
            if (reportType === 'interest-rate') {
                document.getElementById('reportInterestRate').classList.add('active');
            } else if (reportType === 'whatsapp') {
                document.getElementById('reportWhatsApp').classList.add('active');
            } else if (reportType === 'year-update') {
                document.getElementById('reportYearUpdate').classList.add('active');
            }
        }
        
        function refreshCurrentReport() {
            if (currentReportType === 'interest-rate') {
                scanInterestRate();
            } else if (currentReportType === 'whatsapp') {
                scanWhatsAppLinks();
            } else if (currentReportType === 'year-update') {
                scanYearOccurrences();
            }
        }
        
        // ============ Interest Rate Report ============
        
        async function scanInterestRate() {
            const sentence = document.getElementById('currentInterestSentence').value;
            const tbody = document.getElementById('interestRateTableBody');
            const statsContainer = document.getElementById('interestRateStats');
            
            tbody.innerHTML = '<tr><td colspan="5" class="report-loading"><div class="spinner"></div><br>סורק עמודים...</td></tr>';
            
            try {
                const result = await apiCall('/api/reports/interest-rate?sentence=' + encodeURIComponent(sentence));
                
                if (result.success) {
                    interestRateData = result.data;
                    renderInterestRateStats(result.data, statsContainer);
                    renderInterestRateTable(result.data, tbody);
                } else {
                    tbody.innerHTML = `<tr><td colspan="5" style="color: var(--accent);">שגיאה: ${result.error}</td></tr>`;
                }
            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="5" style="color: var(--accent);">שגיאה: ${error.message}</td></tr>`;
            }
        }
        
        function renderInterestRateStats(data, container) {
            const total = data.updated.length + data.outdated.length + data.not_found.length;
            const updated = data.updated.length;
            const needUpload = data.need_upload.length;
            const outdated = data.outdated.length;
            
            container.innerHTML = `
                <div class="report-stat-card success">
                    <div class="stat-value">${updated}</div>
                    <div class="stat-label">עמודים מעודכנים</div>
                </div>
                <div class="report-stat-card warning">
                    <div class="stat-value">${needUpload}</div>
                    <div class="stat-label">צריך העלאה לוורדפרס</div>
                </div>
                <div class="report-stat-card">
                    <div class="stat-value">${outdated}</div>
                    <div class="stat-label">לא מעודכנים</div>
                </div>
                <div class="report-stat-card">
                    <div class="stat-value">${total}</div>
                    <div class="stat-label">סה"כ עמודים</div>
                </div>
            `;
        }
        
        function renderInterestRateTable(data, tbody) {
            let html = '';
            
            // Pages that need upload (updated but not uploaded)
            data.need_upload.forEach(page => {
                const specialAttr = page.is_special ? 'data-special="true"' : '';
                const specialIcon = page.is_special ? '⭐ ' : '';
                html += `
                    <tr data-status="updated_not_uploaded" data-site="${page.site}" ${specialAttr}>
                        <td class="page-name">${specialIcon}${page.name}</td>
                        <td><span class="site-badge">${page.site}</span></td>
                        <td style="color: var(--success);">✅ מעודכן</td>
                        <td style="color: var(--warning);">⚠️ לא עלה</td>
                        <td class="action-buttons">
                            <button class="btn-action btn-upload" onclick="uploadPageToWP('${page.path.replace(/\\/g, '\\\\').replace(/'/g, "\\'")}')">📤 העלה לוורדפרס</button>
                        </td>
                    </tr>
                `;
            });
            
            // Updated pages (already uploaded)
            data.updated.filter(p => !data.need_upload.find(n => n.path === p.path)).forEach(page => {
                const specialAttr = page.is_special ? 'data-special="true"' : '';
                const specialIcon = page.is_special ? '⭐ ' : '';
                html += `
                    <tr data-status="updated_uploaded" data-site="${page.site}" ${specialAttr}>
                        <td class="page-name">${specialIcon}${page.name}</td>
                        <td><span class="site-badge">${page.site}</span></td>
                        <td style="color: var(--success);">✅ מעודכן</td>
                        <td style="color: var(--success);">✅ עלה</td>
                        <td>-</td>
                    </tr>
                `;
            });
            
            // Outdated pages
            data.outdated.forEach(page => {
                const specialAttr = page.is_special ? 'data-special="true"' : '';
                const specialIcon = page.is_special ? '⭐ ' : '';
                html += `
                    <tr data-status="outdated" data-site="${page.site}" ${specialAttr}>
                        <td class="page-name">${specialIcon}${page.name}</td>
                        <td><span class="site-badge">${page.site}</span></td>
                        <td style="color: var(--accent);">❌ לא מעודכן</td>
                        <td>-</td>
                        <td class="action-buttons">
                            <button class="btn-action btn-edit" onclick="openPageInEditor('${page.path.replace(/\\/g, '\\\\').replace(/'/g, "\\'")}')">📝 פתח לעריכה</button>
                        </td>
                    </tr>
                `;
            });
            
            // Pages without any interest rate sentence
            data.not_found.forEach(page => {
                const specialAttr = page.is_special ? 'data-special="true"' : '';
                const specialIcon = page.is_special ? '⭐ ' : '';
                html += `
                    <tr data-status="not_found" data-site="${page.site}" ${specialAttr}>
                        <td class="page-name">${specialIcon}${page.name}</td>
                        <td><span class="site-badge">${page.site}</span></td>
                        <td style="color: var(--text-secondary);">➖ אין משפט ריבית</td>
                        <td>-</td>
                        <td class="action-buttons">
                            <button class="btn-action btn-edit" onclick="openPageInEditor('${page.path.replace(/\\/g, '\\\\').replace(/'/g, "\\'")}')">📝 פתח לעריכה</button>
                        </td>
                    </tr>
                `;
            });
            
            if (!html) {
                html = '<tr><td colspan="5" style="text-align: center; color: var(--text-secondary);">לא נמצאו עמודים</td></tr>';
            }
            
            tbody.innerHTML = html;
            
            // Apply current filter
            filterInterestRateTable();
        }
        
        function filterInterestRateTable() {
            const statusFilter = document.getElementById('interestRateFilter').value;
            const showMain = document.getElementById('interestRateSiteMain').checked;
            const showBusiness = document.getElementById('interestRateSiteBusiness').checked;
            const rows = document.querySelectorAll('#interestRateTableBody tr[data-status]');
            let visibleCount = 0;
            
            rows.forEach(row => {
                const status = row.getAttribute('data-status');
                const site = row.getAttribute('data-site');
                const isSpecial = row.getAttribute('data-special') === 'true';
                
                // Check site filter
                let siteMatch = false;
                if (site === 'main' && showMain) siteMatch = true;
                if (site === 'business' && showBusiness) siteMatch = true;
                
                // Check status filter
                let statusMatch = false;
                if (statusFilter === 'all') {
                    statusMatch = true;
                } else if (statusFilter === 'special') {
                    statusMatch = isSpecial;
                } else if (statusFilter === status) {
                    statusMatch = true;
                }
                
                const show = siteMatch && statusMatch;
                row.style.display = show ? '' : 'none';
                if (show) visibleCount++;
            });
            
            // Update visible count display
            const filterInfo = document.getElementById('interestRateFilterInfo');
            if (filterInfo) {
                filterInfo.textContent = `מציג ${visibleCount} עמודים`;
            }
        }
        
        async function uploadPageToWP(pagePath) {
            showToast('מעלה לוורדפרס...', 'info');
            try {
                const result = await apiCall('/api/wordpress/update', {
                    method: 'POST',
                    body: JSON.stringify({ page_path: pagePath })
                });
                
                if (result.success) {
                    showToast('הועלה בהצלחה!', 'success');
                    scanInterestRate(); // Refresh
                } else {
                    showToast('שגיאה: ' + result.error, 'error');
                }
            } catch (error) {
                showToast('שגיאה: ' + error.message, 'error');
            }
        }
        
        function openPageInEditor(pagePath) {
            // Switch to edit tab and select the page
            const editTab = document.querySelector('[data-tab="edit"]');
            if (editTab) {
                editTab.click();
            }
            
            // Find and select the page
            setTimeout(() => {
                const normalizedPath = pagePath.replace(/\\\\/g, '\\');
                const pageItem = document.querySelector(`.page-item[data-path="${normalizedPath}"]`);
                if (pageItem) {
                    pageItem.click();
                    pageItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 100);
        }
        
        // ============ WhatsApp Links Report ============
        
        async function scanWhatsAppLinks() {
            const siteFilter = document.getElementById('whatsappSiteFilter').value;
            const tbody = document.getElementById('whatsappTableBody');
            const statsContainer = document.getElementById('whatsappStats');
            
            tbody.innerHTML = '<tr><td colspan="6" class="report-loading"><div class="spinner"></div><br>סורק קישורים...</td></tr>';
            
            try {
                const result = await apiCall('/api/reports/whatsapp-links?site=' + siteFilter);
                
                if (result.success) {
                    whatsappData = result.data;
                    renderWhatsAppStats(result.data, statsContainer);
                    renderWhatsAppTable(result.data, tbody);
                } else {
                    tbody.innerHTML = `<tr><td colspan="6" style="color: var(--accent);">שגיאה: ${result.error}</td></tr>`;
                }
            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="6" style="color: var(--accent);">שגיאה: ${error.message}</td></tr>`;
            }
        }
        
        function renderWhatsAppStats(data, container) {
            const totalPages = new Set(data.links.map(l => l.page_path)).size;
            const totalLinks = data.links.length;
            
            container.innerHTML = `
                <div class="report-stat-card">
                    <div class="stat-value">${totalPages}</div>
                    <div class="stat-label">עמודים עם קישורים</div>
                </div>
                <div class="report-stat-card warning">
                    <div class="stat-value">${totalLinks}</div>
                    <div class="stat-label">סה"כ קישורי WhatsApp</div>
                </div>
            `;
        }
        
        function renderWhatsAppTable(data, tbody) {
            let html = '';
            
            data.links.forEach((link, index) => {
                const escapedPath = link.page_path.replace(/\\/g, '\\\\').replace(/'/g, "\\'");
                const escapedAnchor = (link.anchor || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                
                html += `
                    <tr>
                        <td class="page-name">${link.page_name}</td>
                        <td><span class="site-badge">${link.site}</span></td>
                        <td>${link.line_number}</td>
                        <td class="whatsapp-link" title="${link.url}">${link.url.substring(0, 40)}...</td>
                        <td class="anchor-text" title="${escapedAnchor}">${link.anchor || '(ללא טקסט)'}</td>
                        <td class="action-buttons">
                            <button class="btn-action btn-remove" onclick="removeWhatsAppLink('${escapedPath}', ${link.line_number}, ${index})">🗑️ הסר</button>
                            <button class="btn-action btn-edit" onclick="editWhatsAppAnchor('${escapedPath}', ${link.line_number}, '${escapedAnchor}', ${index})">✏️ ערוך</button>
                            <button class="btn-action btn-upload" onclick="uploadPageToWP('${escapedPath}')">📤 העלה</button>
                        </td>
                    </tr>
                `;
            });
            
            if (!html) {
                html = '<tr><td colspan="6" style="text-align: center; color: var(--text-secondary);">לא נמצאו קישורי WhatsApp</td></tr>';
            }
            
            tbody.innerHTML = html;
        }
        
        async function removeWhatsAppLink(pagePath, lineNumber, linkIndex) {
            if (!confirm('להסיר את קישור ה-WhatsApp ולהפנות ל-AWG?')) return;
            
            showToast('מסיר קישור...', 'info');
            try {
                const result = await apiCall('/api/reports/remove-whatsapp-link', {
                    method: 'POST',
                    body: JSON.stringify({ 
                        page_path: pagePath, 
                        line_number: lineNumber,
                        link_index: linkIndex
                    })
                });
                
                if (result.success) {
                    showToast('הקישור הוסר והופנה ל-AWG!', 'success');
                    scanWhatsAppLinks(); // Refresh
                } else {
                    showToast('שגיאה: ' + result.error, 'error');
                }
            } catch (error) {
                showToast('שגיאה: ' + error.message, 'error');
            }
        }
        
        async function editWhatsAppAnchor(pagePath, lineNumber, currentAnchor, linkIndex) {
            const newAnchor = prompt('ערוך את טקסט האנקור:', currentAnchor);
            if (newAnchor === null || newAnchor === currentAnchor) return;
            
            showToast('מעדכן אנקור...', 'info');
            try {
                const result = await apiCall('/api/reports/update-anchor', {
                    method: 'POST',
                    body: JSON.stringify({ 
                        page_path: pagePath, 
                        line_number: lineNumber,
                        new_anchor: newAnchor,
                        link_index: linkIndex
                    })
                });
                
                if (result.success) {
                    showToast('האנקור עודכן!', 'success');
                    scanWhatsAppLinks(); // Refresh
                } else {
                    showToast('שגיאה: ' + result.error, 'error');
                }
            } catch (error) {
                showToast('שגיאה: ' + error.message, 'error');
            }
        }
        
        // ============ Year Update Report ============
        
        async function scanYearOccurrences() {
            const yearFrom = document.getElementById('yearFrom').value;
            const yearTo = document.getElementById('yearTo').value;
            const tbody = document.getElementById('yearUpdateTableBody');
            const statsContainer = document.getElementById('yearUpdateStats');
            
            tbody.innerHTML = '<tr><td colspan="5" class="report-loading"><div class="spinner"></div><br>סורק...</td></tr>';
            
            try {
                const result = await apiCall('/api/reports/year-scan?year=' + yearFrom);
                
                if (result.success) {
                    yearUpdateData = result.data;
                    yearUpdateData.yearTo = yearTo;
                    renderYearUpdateStats(result.data, statsContainer);
                    renderYearUpdateTable(result.data, tbody, yearFrom, yearTo);
                } else {
                    tbody.innerHTML = `<tr><td colspan="5" style="color: var(--accent);">שגיאה: ${result.error}</td></tr>`;
                }
            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="5" style="color: var(--accent);">שגיאה: ${error.message}</td></tr>`;
            }
        }
        
        function renderYearUpdateStats(data, container) {
            const totalPages = new Set(data.occurrences.map(o => o.page_path)).size;
            const totalOccurrences = data.occurrences.length;
            
            container.innerHTML = `
                <div class="report-stat-card warning">
                    <div class="stat-value">${totalPages}</div>
                    <div class="stat-label">עמודים עם ${data.year || '2025'}</div>
                </div>
                <div class="report-stat-card">
                    <div class="stat-value">${totalOccurrences}</div>
                    <div class="stat-label">סה"כ מופעים</div>
                </div>
            `;
        }
        
        function renderYearUpdateTable(data, tbody, yearFrom, yearTo) {
            let html = '';
            
            // Patterns that indicate file/link paths (not content text)
            const linkPatterns = [
                /wp-content\/uploads/i,
                /\.webp|\.jpg|\.jpeg|\.png|\.gif|\.svg|\.pdf|\.mp4|\.mp3/i,
                /src=|href=|url\(/i,
                /\/\d{4}\/\d{2}\//  // URL date pattern like /2025/07/
            ];
            
            function isLinkContext(context) {
                return linkPatterns.some(pattern => pattern.test(context));
            }
            
            // Group by page
            const pageGroups = {};
            data.occurrences.forEach(occ => {
                if (!pageGroups[occ.page_path]) {
                    pageGroups[occ.page_path] = {
                        page_name: occ.page_name,
                        site: occ.site,
                        occurrences: []
                    };
                }
                pageGroups[occ.page_path].occurrences.push(occ);
            });
            
            Object.entries(pageGroups).forEach(([pagePath, pageData]) => {
                const escapedPath = pagePath.replace(/\\/g, '\\\\').replace(/'/g, "\\'");
                const occCount = pageData.occurrences.length;
                
                // Show first occurrence with page info
                pageData.occurrences.forEach((occ, idx) => {
                    const contextHtml = occ.context.replace(new RegExp(yearFrom, 'g'), `<span class="highlight">${yearFrom}</span>`);
                    const isLink = isLinkContext(occ.context);
                    
                    html += `
                        <tr data-is-link="${isLink}">
                            ${idx === 0 ? `
                                <td class="page-name" rowspan="${occCount}">
                                    ${pageData.page_name}
                                    <a href="/api/preview/${encodeURIComponent(pagePath)}" target="_blank" title="פתח לצפייה בחלון חדש" style="margin-right: 0.5rem; text-decoration: none;">🔗</a>
                                </td>
                                <td rowspan="${occCount}"><span class="site-badge">${pageData.site}</span></td>
                            ` : ''}
                            <td>${occ.line_number}${isLink ? ' 🖼️' : ''}</td>
                            <td class="context-text">${contextHtml}</td>
                            <td class="action-buttons">
                                ${idx === 0 ? `
                                    <button class="btn-action btn-replace" onclick="replaceYearInPage('${escapedPath}', '${yearFrom}', '${yearTo}', true)">🔄 החלף הכל (${occCount})</button>
                                    <button class="btn-action btn-upload" onclick="replaceAndUpload('${escapedPath}', '${yearFrom}', '${yearTo}')">📤 החלף + העלה</button>
                                ` : `
                                    <button class="btn-action btn-replace" onclick="replaceYearSingle('${escapedPath}', ${occ.line_number}, '${yearFrom}', '${yearTo}')">🔄 החלף</button>
                                `}
                            </td>
                        </tr>
                    `;
                });
            });
            
            if (!html) {
                html = `<tr><td colspan="5" style="text-align: center; color: var(--text-secondary);">לא נמצאו מופעים של ${yearFrom}</td></tr>`;
            }
            
            tbody.innerHTML = html;
            
            // Apply filter
            filterYearUpdateTable();
        }
        
        function filterYearUpdateTable() {
            const hideLinks = document.getElementById('yearHideLinks').checked;
            const rows = document.querySelectorAll('#yearUpdateTableBody tr[data-is-link]');
            let visibleCount = 0;
            let hiddenCount = 0;
            
            rows.forEach(row => {
                const isLink = row.getAttribute('data-is-link') === 'true';
                const show = !(hideLinks && isLink);
                
                row.style.display = show ? '' : 'none';
                if (show) visibleCount++;
                if (isLink) hiddenCount++;
            });
            
            // Update info
            const filterInfo = document.getElementById('yearFilterInfo');
            if (filterInfo) {
                if (hideLinks && hiddenCount > 0) {
                    filterInfo.textContent = `מציג ${visibleCount} שורות (הוסתרו ${hiddenCount} קישורי קבצים)`;
                } else {
                    filterInfo.textContent = `מציג ${rows.length} שורות`;
                }
            }
        }
        
        async function replaceYearInPage(pagePath, yearFrom, yearTo, replaceAll = true) {
            showToast('מחליף שנים...', 'info');
            try {
                const result = await apiCall('/api/reports/replace-year', {
                    method: 'POST',
                    body: JSON.stringify({ 
                        page_path: pagePath, 
                        year_from: yearFrom,
                        year_to: yearTo,
                        replace_all: replaceAll
                    })
                });
                
                if (result.success) {
                    showToast(`הוחלפו ${result.replaced_count} מופעים!`, 'success');
                    scanYearOccurrences(); // Refresh
                } else {
                    showToast('שגיאה: ' + result.error, 'error');
                }
            } catch (error) {
                showToast('שגיאה: ' + error.message, 'error');
            }
        }
        
        async function replaceYearSingle(pagePath, lineNumber, yearFrom, yearTo) {
            showToast('מחליף שנה...', 'info');
            try {
                const result = await apiCall('/api/reports/replace-year', {
                    method: 'POST',
                    body: JSON.stringify({ 
                        page_path: pagePath, 
                        year_from: yearFrom,
                        year_to: yearTo,
                        line_number: lineNumber,
                        replace_all: false
                    })
                });
                
                if (result.success) {
                    showToast('השנה הוחלפה!', 'success');
                    scanYearOccurrences(); // Refresh
                } else {
                    showToast('שגיאה: ' + result.error, 'error');
                }
            } catch (error) {
                showToast('שגיאה: ' + error.message, 'error');
            }
        }
        
        async function replaceAndUpload(pagePath, yearFrom, yearTo) {
            showToast('מחליף ומעלה...', 'info');
            try {
                // First replace
                const replaceResult = await apiCall('/api/reports/replace-year', {
                    method: 'POST',
                    body: JSON.stringify({ 
                        page_path: pagePath, 
                        year_from: yearFrom,
                        year_to: yearTo,
                        replace_all: true
                    })
                });
                
                if (!replaceResult.success) {
                    showToast('שגיאה בהחלפה: ' + replaceResult.error, 'error');
                    return;
                }
                
                // Then upload
                const uploadResult = await apiCall('/api/wordpress/update', {
                    method: 'POST',
                    body: JSON.stringify({ page_path: pagePath })
                });
                
                if (uploadResult.success) {
                    showToast(`הוחלפו ${replaceResult.replaced_count} מופעים והועלה לוורדפרס!`, 'success');
                    scanYearOccurrences(); // Refresh
                } else {
                    showToast('שגיאה בהעלאה: ' + uploadResult.error, 'error');
                }
            } catch (error) {
                showToast('שגיאה: ' + error.message, 'error');
            }
        }

        // ============ Duplicates Detection System ============
        
        // Global state for duplicates
        let currentDuplicatesReport = null;
        let selectedGroups = new Set();
        let availableDirectories = [];
        let duplicateSettings = {
            enabled_directories: ['main', 'business'],
            threshold: 0.5,
            include_meta: true,
            include_headings: true,
            cross_directory: false,
            auto_scan: false
        };
        let ignorePatterns = [];
        
        // Predefined templates for ignore patterns
        const ignoreTemplates = {
            'date-updated': {
                text: 'עודכן לאחרונה:',
                type: 'contains',
                description: 'תאריך עדכון - חוזר בכל העמודים'
            },
            'interest-rate': {
                text: 'הריביות בתוכן מעודכנות לפי ריבית פריים',
                type: 'contains',
                description: 'הצהרת ריבית - מעודכנת לפי בנק ישראל'
            },
            'copyright': {
                text: 'כל הזכויות שמורות',
                type: 'exact',
                description: 'זכויות יוצרים'
            },
            'contact-cta': {
                text: 'צור קשר עכשיו',
                type: 'exact',
                description: 'קריאה לפעולה סטנדרטית'
            },
            'disclaimer': {
                text: 'disclaimer',
                type: 'contains',
                description: 'הצהרות משפטיות'
            },
            'footer': {
                text: 'footer',
                type: 'contains',
                description: 'תוכן Footer'
            }
        };
        
        // Initialize duplicates tab
        async function initDuplicatesTab() {
            await loadAvailableDirectories();
            await loadDuplicateSettings();
            updateSelectedDirectoriesBar();
            
            if (duplicateSettings.auto_scan) {
                loadCachedReport();
            }
        }
        
        // Load available directories
        async function loadAvailableDirectories() {
            try {
                const result = await apiCall('/api/duplicates/directories');
                if (result.success) {
                    availableDirectories = result.directories;
                }
            } catch (err) {
                console.error('Error loading directories:', err);
            }
        }
        
        // Load settings
        async function loadDuplicateSettings() {
            try {
                const result = await apiCall('/api/duplicates/settings');
                if (result.success && result.settings) {
                    duplicateSettings = result.settings;
                    
                    // Apply settings to UI
                    const thresholdEl = document.getElementById('duplicates-threshold');
                    const metaEl = document.getElementById('include-meta');
                    const headingsEl = document.getElementById('include-headings');
                    
                    if (thresholdEl) thresholdEl.value = duplicateSettings.threshold || 0.5;
                    if (metaEl) metaEl.checked = duplicateSettings.include_meta !== false;
                    if (headingsEl) headingsEl.checked = duplicateSettings.include_headings !== false;
                }
            } catch (err) {
                console.error('Error loading settings:', err);
            }
        }
        
        // Save settings
        async function saveDuplicateSettings() {
            const selectedDirs = Array.from(
                document.querySelectorAll('.directory-checkbox:checked')
            ).map(cb => cb.value);
            
            if (selectedDirs.length === 0) {
                showToast('יש לבחור לפחות תיקייה אחת', 'warning');
                return;
            }
            
            duplicateSettings.enabled_directories = selectedDirs;
            duplicateSettings.cross_directory = document.getElementById('cross-directory-scan')?.checked || false;
            duplicateSettings.auto_scan = document.getElementById('auto-scan-enabled')?.checked || false;
            
            try {
                await apiCall('/api/duplicates/settings', {
                    method: 'POST',
                    body: JSON.stringify({ settings: duplicateSettings })
                });
                
                showToast('✅ ההגדרות נשמרו', 'success');
                closeDuplicateSettings();
                updateSelectedDirectoriesBar();
            } catch (err) {
                showToast('שגיאה בשמירת הגדרות', 'error');
            }
        }
        
        // Open settings modal
        async function openDuplicateSettings() {
            const modal = document.getElementById('duplicate-settings-modal');
            const loading = document.getElementById('directories-loading');
            const list = document.getElementById('directories-list');
            
            modal.classList.add('active');
            loading.style.display = 'block';
            list.style.display = 'none';
            
            // Load directories if not loaded
            if (availableDirectories.length === 0) {
                await loadAvailableDirectories();
            }
            
            // Render directories list
            list.innerHTML = availableDirectories.map(dir => `
                <div class="directory-item">
                    <label class="directory-checkbox-label">
                        <input type="checkbox" 
                               class="directory-checkbox" 
                               value="${dir.id}"
                               ${duplicateSettings.enabled_directories.includes(dir.id) ? 'checked' : ''}>
                        <div class="directory-info">
                            <strong>📁 ${dir.name}</strong>
                            <small>${dir.pages_count} עמודים</small>
                        </div>
                    </label>
                </div>
            `).join('');
            
            // Set other settings
            const crossDirEl = document.getElementById('cross-directory-scan');
            const autoScanEl = document.getElementById('auto-scan-enabled');
            if (crossDirEl) crossDirEl.checked = duplicateSettings.cross_directory || false;
            if (autoScanEl) autoScanEl.checked = duplicateSettings.auto_scan || false;
            
            loading.style.display = 'none';
            list.style.display = 'block';
        }
        
        function closeDuplicateSettings() {
            document.getElementById('duplicate-settings-modal').classList.remove('active');
        }
        
        // Update selected directories bar
        function updateSelectedDirectoriesBar() {
            const bar = document.getElementById('selected-directories-bar');
            const list = document.getElementById('selected-directories-list');
            
            if (!duplicateSettings.enabled_directories || duplicateSettings.enabled_directories.length === 0) {
                if (bar) bar.style.display = 'none';
                return;
            }
            
            if (list) {
                list.innerHTML = duplicateSettings.enabled_directories.map(dirId => {
                    const dir = availableDirectories.find(d => d.id === dirId);
                    const count = dir ? dir.pages_count : '?';
                    return `<span class="directory-badge">📁 ${dirId} (${count})</span>`;
                }).join('');
            }
            
            if (bar) bar.style.display = 'flex';
        }
        
        // Main scan function
        async function scanDuplicates() {
            if (!duplicateSettings.enabled_directories || duplicateSettings.enabled_directories.length === 0) {
                showToast('יש לבחור תיקיות בהגדרות', 'warning');
                openDuplicateSettings();
                return;
            }
            
            const threshold = parseFloat(document.getElementById('duplicates-threshold')?.value || 0.5);
            const includeMeta = document.getElementById('include-meta')?.checked !== false;
            const includeHeadings = document.getElementById('include-headings')?.checked !== false;
            
            const directoriesText = duplicateSettings.enabled_directories.join(', ');
            showToast('סורק כפילויות...', 'info');
            
            // Show loading in results area
            const resultsContainer = document.getElementById('duplicates-results');
            resultsContainer.innerHTML = `
                <div class="duplicates-loading">
                    <div class="loading-spinner">🔍</div>
                    <h3>סורק ${directoriesText}...</h3>
                    <p>זה עשוי לקחת מספר שניות</p>
                </div>
            `;
            
            try {
                const result = await apiCall('/api/duplicates/scan', {
                    method: 'POST',
                    body: JSON.stringify({ 
                        directories: duplicateSettings.enabled_directories,
                        threshold,
                        include_meta: includeMeta,
                        include_headings: includeHeadings,
                        cross_directory: duplicateSettings.cross_directory || false
                    })
                });
                
                if (result.success) {
                    currentDuplicatesReport = result.report;
                    displayDuplicateReport(result.report);
                    showToast('✅ סריקה הושלמה!', 'success');
                } else {
                    showToast('שגיאה: ' + (result.error || 'Unknown error'), 'error');
                    resultsContainer.innerHTML = `
                        <div class="duplicates-empty-state">
                            <div style="font-size: 4rem;">❌</div>
                            <h3>שגיאה בסריקה</h3>
                            <p>${result.error || 'נסה שוב'}</p>
                        </div>
                    `;
                }
            } catch (err) {
                console.error('Error scanning:', err);
                showToast('שגיאה בסריקה', 'error');
                resultsContainer.innerHTML = `
                    <div class="duplicates-empty-state">
                        <div style="font-size: 4rem;">❌</div>
                        <h3>שגיאה בסריקה</h3>
                        <p>${err.message}</p>
                    </div>
                `;
            }
        }
        
        // Load cached report
        async function loadCachedReport() {
            try {
                const result = await apiCall('/api/duplicates/report');
                if (result.success && result.report) {
                    currentDuplicatesReport = result.report;
                    displayDuplicateReport(result.report);
                    showToast('טעינת דוח אחרון', 'info');
                }
            } catch (err) {
                // No cached report, that's fine
            }
        }
        
        // Display statistics dashboard
        function displayStatistics(stats) {
            const totalPagesEl = document.getElementById('stat-total-pages');
            const pagesWithDupsEl = document.getElementById('stat-pages-with-duplicates');
            const snippetsEl = document.getElementById('stat-duplicate-snippets');
            const avgSimEl = document.getElementById('stat-avg-similarity');
            
            if (totalPagesEl) totalPagesEl.textContent = stats.total_pages || 0;
            if (pagesWithDupsEl) pagesWithDupsEl.textContent = stats.pages_with_duplicates || 0;
            if (snippetsEl) snippetsEl.textContent = stats.total_duplicate_snippets || 0;
            if (avgSimEl) avgSimEl.textContent = Math.round((stats.avg_similarity || 0) * 100) + '%';
            
            // Severity breakdown
            const criticalEl = document.getElementById('severity-critical');
            const highEl = document.getElementById('severity-high');
            const mediumEl = document.getElementById('severity-medium');
            
            if (criticalEl) criticalEl.textContent = stats.severity_breakdown?.critical || 0;
            if (highEl) highEl.textContent = stats.severity_breakdown?.high || 0;
            if (mediumEl) mediumEl.textContent = stats.severity_breakdown?.medium || 0;
            
            document.getElementById('duplicates-stats').style.display = 'grid';
            document.getElementById('severity-breakdown').style.display = 'flex';
        }
        
        // Main display function
        function displayDuplicateReport(data) {
            const container = document.getElementById('duplicates-results');
            
            if (!data.groups || data.groups.length === 0) {
                container.innerHTML = '<div class="no-duplicates">✅ לא נמצאו כפילויות!</div>';
                document.getElementById('duplicates-stats').style.display = 'none';
                document.getElementById('duplicates-filters').style.display = 'none';
                document.getElementById('bulk-actions-bar').style.display = 'none';
                document.getElementById('severity-breakdown').style.display = 'none';
                return;
            }
            
            // Show statistics
            if (data.statistics) {
                displayStatistics({...data.statistics, total_pages: data.total_pages});
            }
            
            // Show filters
            document.getElementById('duplicates-filters').style.display = 'flex';
            document.getElementById('bulk-actions-bar').style.display = 'flex';
            
            // Render groups
            renderDuplicateGroups(data.groups);
        }
        
        function renderDuplicateGroups(groups) {
            const container = document.getElementById('duplicates-results');
            
            let html = groups.map((group, idx) => {
                const seoImpact = getSeoImpactBadge(group.seo_impact);
                const similarity = group.similarity || 0;
                
                return `
                <div class="duplicate-group ${selectedGroups.has(group.id) ? 'selected' : ''}" data-group-id="${group.id}">
                    <div class="duplicate-group-header">
                        <input type="checkbox" 
                               class="group-checkbox" 
                               data-group-id="${group.id}"
                               onchange="toggleGroupSelection('${group.id}')"
                               ${selectedGroups.has(group.id) ? 'checked' : ''}>
                        
                        <div class="duplicate-header-info">
                            <span class="similarity-badge" style="background: ${getSimilarityColor(similarity)}">
                                ${Math.round(similarity * 100)}% דמיון
                            </span>
                            ${seoImpact}
                            <span class="pages-count">${group.pages.length} עמודים</span>
                        </div>
                        
                        <div class="duplicate-header-actions">
                            <button class="btn btn-sm" onclick="toggleGroupExpansion(${idx})">
                                <span id="expand-icon-${idx}">▼</span> הצג פרטים
                            </button>
                            <button class="btn btn-sm btn-info" onclick="showDiffViewer('${group.pages[0]?.path || ''}', '${group.pages[1]?.path || ''}')">
                                👁️ השוואה
                            </button>
                        </div>
                    </div>
                    
                    <div class="duplicate-pages">
                        ${group.pages.map((page, pIdx) => `
                            <div class="page-card">
                                <div class="page-card-header">
                                    <strong>${escapeHtml(page.keyword || 'לא ידוע')}</strong>
                                    <span class="page-badge">#${pIdx + 1}</span>
                                </div>
                                <div class="page-meta">
                                    <div class="page-title">${escapeHtml(page.title || 'ללא כותרת')}</div>
                                    <div class="page-description">${escapeHtml((page.description || '').substring(0, 100))}...</div>
                                </div>
                                <small class="page-path">${escapeHtml(page.path || '')}</small>
                                <div class="page-actions">
                                    ${page.url ? `<a href="${page.url}" target="_blank" class="btn btn-xs">🌐 צפה באתר</a>` : ''}
                                    <button class="btn btn-xs" onclick="openPageInEditor('${escapeHtml(page.path || '')}')">✏️ ערוך</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <!-- Expandable Details -->
                    <div id="group-details-${idx}" class="group-details" style="display: none;">
                        ${renderDuplicateSnippets(group, idx)}
                        ${renderHeadingsDuplicates(group)}
                    </div>
                </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }
        
        function renderDuplicateSnippets(group, groupIdx) {
            if (!group.duplicate_snippets || group.duplicate_snippets.length === 0) {
                return '<div class="no-snippets">לא נמצאו קטעים כפולים ספציפיים</div>';
            }
            
            return `
                <div class="duplicate-snippets">
                    <h4>📄 קטעי תוכן כפולים</h4>
                    ${group.duplicate_snippets.map((snippet, sIdx) => `
                        <div class="duplicate-snippet-item">
                            <input type="checkbox" 
                                   id="snippet-${groupIdx}-${sIdx}" 
                                   class="snippet-checkbox"
                                   data-group="${groupIdx}"
                                   data-snippet="${sIdx}"
                                   data-text="${escapeHtmlAttr(snippet.text || '')}">
                            <label for="snippet-${groupIdx}-${sIdx}">
                                <div class="snippet-preview">
                                    <div class="snippet-header">
                                        <strong>סוג: ${getSnippetTypeLabel(snippet.type)}</strong>
                                        <span class="snippet-length">${snippet.length || 0} תווים</span>
                                        <span class="snippet-pages-count">מופיע ב-${(snippet.pages || []).length} עמודים</span>
                                    </div>
                                    <pre>${escapeHtml(snippet.text || '')}</pre>
                                    
                                    <!-- Links to view in each page -->
                                    <div class="snippet-page-links">
                                        <span class="snippet-links-label">📍 צפה בעמוד:</span>
                                        ${(snippet.pages || group.pages?.map(p => p.path) || []).map((pagePath, pIdx) => {
                                            const pageInfo = group.pages?.find(p => p.path === pagePath) || { keyword: getKeywordFromPath(pagePath), path: pagePath };
                                            return `<button class="btn btn-xs btn-link" onclick="viewSnippetInPage('${escapeHtmlAttr(pagePath)}', '${escapeHtmlAttr(snippet.text || '')}')">
                                                📄 ${escapeHtml(pageInfo.keyword || 'עמוד ' + (pIdx + 1))}
                                            </button>`;
                                        }).join('')}
                                    </div>
                                </div>
                            </label>
                            <button class="btn btn-xs btn-secondary" onclick="addSnippetToIgnoreFromReport('${escapeHtmlAttr(snippet.text || '')}')">
                                🚫 התעלם
                            </button>
                        </div>
                    `).join('')}
                    
                    <div class="snippets-actions">
                        <button class="btn btn-sm" onclick="selectAllSnippets(${groupIdx})">
                            ✓ בחר הכל
                        </button>
                        <button class="btn btn-sm btn-success" onclick="sendSelectedToClaude(${groupIdx})" 
                                style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                            🤖 שלח לקלוד לתיקון
                        </button>
                    </div>
                </div>
            `;
        }
        
        function renderHeadingsDuplicates(group) {
            if (!group.headings_duplicates || Object.keys(group.headings_duplicates).length === 0) return '';
            
            let html = '<div class="headings-duplicates"><h4>📌 כותרות כפולות</h4>';
            
            for (const [level, headings] of Object.entries(group.headings_duplicates)) {
                if (headings && headings.length > 0) {
                    html += `
                        <div class="heading-level-group">
                            <strong>${level.toUpperCase()}:</strong>
                            <ul>
                                ${headings.map(h => `<li>${escapeHtml(h)}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
            }
            
            html += '</div>';
            return html;
        }
        
        // Toggle group expansion
        function toggleGroupExpansion(idx) {
            const details = document.getElementById(`group-details-${idx}`);
            const icon = document.getElementById(`expand-icon-${idx}`);
            
            if (details) {
                const isHidden = details.style.display === 'none';
                details.style.display = isHidden ? 'block' : 'none';
                if (icon) icon.textContent = isHidden ? '▲' : '▼';
            }
        }
        
        // Filtering and Sorting
        function applyDuplicatesFilter() {
            if (!currentDuplicatesReport || !currentDuplicatesReport.groups) return;
            
            const searchTerm = (document.getElementById('filter-search')?.value || '').toLowerCase();
            const sortBy = document.getElementById('filter-sort')?.value || 'similarity-desc';
            const severity = document.getElementById('filter-severity')?.value || 'all';
            
            let filteredGroups = [...currentDuplicatesReport.groups];
            
            // Filter by search
            if (searchTerm) {
                filteredGroups = filteredGroups.filter(group => 
                    group.pages.some(p => 
                        (p.keyword || '').toLowerCase().includes(searchTerm) ||
                        (p.title || '').toLowerCase().includes(searchTerm)
                    )
                );
            }
            
            // Filter by severity
            if (severity !== 'all') {
                filteredGroups = filteredGroups.filter(g => g.seo_impact?.level === severity);
            }
            
            // Sort
            filteredGroups.sort((a, b) => {
                switch(sortBy) {
                    case 'similarity-desc': return (b.similarity || 0) - (a.similarity || 0);
                    case 'similarity-asc': return (a.similarity || 0) - (b.similarity || 0);
                    case 'pages-count-desc': return (b.pages?.length || 0) - (a.pages?.length || 0);
                    case 'seo-impact-desc': return ((b.seo_impact?.score || 0) - (a.seo_impact?.score || 0));
                    case 'keyword-asc': 
                        const kw1 = a.pages?.[0]?.keyword || '';
                        const kw2 = b.pages?.[0]?.keyword || '';
                        return kw1.localeCompare(kw2, 'he');
                    default: return 0;
                }
            });
            
            renderDuplicateGroups(filteredGroups);
        }
        
        // Group selection
        function toggleGroupSelection(groupId) {
            if (selectedGroups.has(groupId)) {
                selectedGroups.delete(groupId);
            } else {
                selectedGroups.add(groupId);
            }
            updateSelectedCount();
            
            // Update UI
            const groupEl = document.querySelector(`[data-group-id="${groupId}"]`);
            if (groupEl) {
                groupEl.classList.toggle('selected', selectedGroups.has(groupId));
            }
        }
        
        function toggleAllGroupsSelection() {
            const selectAll = document.getElementById('select-all-groups')?.checked;
            const checkboxes = document.querySelectorAll('.group-checkbox');
            
            checkboxes.forEach(cb => {
                cb.checked = selectAll;
                const groupId = cb.dataset.groupId;
                if (selectAll) {
                    selectedGroups.add(groupId);
                } else {
                    selectedGroups.delete(groupId);
                }
            });
            
            updateSelectedCount();
        }
        
        function updateSelectedCount() {
            const countEl = document.getElementById('selected-count');
            if (countEl) countEl.textContent = `${selectedGroups.size} נבחרו`;
        }
        
        // Snippet selection
        function selectAllSnippets(groupIdx) {
            const checkboxes = document.querySelectorAll(`input[data-group="${groupIdx}"]`);
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            
            checkboxes.forEach(cb => {
                cb.checked = !allChecked;
            });
            
            showToast(allChecked ? 'ביטול בחירה' : 'נבחרו כל הקטעים', 'info');
        }
        
        // Bulk actions
        async function bulkSendToClaude() {
            if (selectedGroups.size === 0) {
                showToast('לא נבחרו קבוצות', 'warning');
                return;
            }
            
            const groups = currentDuplicatesReport.groups.filter(g => selectedGroups.has(g.id));
            
            // Build combined prompt
            const prompt = buildBulkFixPrompt(groups);
            showDuplicateFixPrompt(prompt, groups);
        }
        
        async function bulkIgnore() {
            if (selectedGroups.size === 0) return;
            
            if (!confirm(`להתעלם מ-${selectedGroups.size} קבוצות כפילויות?`)) return;
            
            showToast(`${selectedGroups.size} קבוצות נוספו לרשימת התעלמות`, 'success');
            selectedGroups.clear();
            updateSelectedCount();
        }
        
        async function bulkExport() {
            if (selectedGroups.size === 0) {
                showToast('לא נבחרו קבוצות', 'warning');
                return;
            }
            
            const groups = currentDuplicatesReport.groups.filter(g => selectedGroups.has(g.id));
            
            // Export to CSV
            let csv = 'דמיון,עמוד1,עמוד2,SEO Impact\n';
            groups.forEach(g => {
                const p1 = g.pages?.[0]?.keyword || '';
                const p2 = g.pages?.[1]?.keyword || '';
                csv += `${Math.round((g.similarity || 0) * 100)}%,${p1},${p2},${g.seo_impact?.level || ''}\n`;
            });
            
            // Download
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'duplicates-export.csv';
            a.click();
            URL.revokeObjectURL(url);
            
            showToast('הקובץ הורד', 'success');
        }
        
        // Send selected snippets to Claude
        async function sendSelectedToClaude(groupIdx) {
            const checkboxes = document.querySelectorAll(`input[data-group="${groupIdx}"]:checked`);
            
            if (checkboxes.length === 0) {
                showToast('לא נבחרו קטעים לתיקון', 'warning');
                return;
            }
            
            const group = currentDuplicatesReport?.groups?.[groupIdx];
            if (!group) return;
            
            const duplicates = Array.from(checkboxes).map(cb => ({
                text: cb.dataset.text,
                pages: group.pages.map(p => p.path)
            }));
            
            const prompt = buildDuplicateFixPrompt(duplicates, group);
            showDuplicateFixPrompt(prompt, [group]);
        }
        
        function buildDuplicateFixPrompt(duplicates, group) {
            let prompt = `# 🔧 תיקון כפילויות תוכן

## 📋 הוראות

זוהו ${duplicates.length} קטעי תוכן כפולים שחוזרים על עצמם במספר עמודים.
משימתך: **להתאים אישית כל קטע** כך שיהיה ייחודי לעמוד בו הוא מופיע, תוך שמירה על המסר והערך.

---

## ⚠️ כללים

1. **אסור להעתיק תוכן זהה** בין עמודים - זה פוגע ב-SEO
2. שמור על **אורך דומה** לטקסט המקורי
3. התאם את התוכן ל**מילת המפתח של העמוד**
4. שמור על **טון שיווקי ומקצועי**
5. וודא ש**כל עמוד מקבל גרסה ייחודית**

---

`;

            duplicates.forEach((dup, idx) => {
                prompt += `## 🔄 כפילות ${idx + 1}

### טקסט כפול נוכחי:
\`\`\`
${dup.text}
\`\`\`

### מופיע בעמודים הבאים:
${(dup.pages || []).map((pagePath, pIdx) => {
    const page = group?.pages?.find(p => p.path === pagePath);
    const keyword = page?.keyword || getKeywordFromPath(pagePath);
    return `${pIdx + 1}. **${keyword}** (\`${pagePath}\`)`;
}).join('\n')}

### ✏️ דרוש: צור גרסה ייחודית לכל עמוד

---

`;
            });

            prompt += `## 🏁 סיום

לאחר התיקונים, עדכן את כל העמודים בקבצי ה-HTML המתאימים.
`;

            return prompt;
        }
        
        function buildBulkFixPrompt(groups) {
            let prompt = `# 🔧 תיקון כפילויות תוכן - ${groups.length} קבוצות

## 📋 הוראות

זוהו ${groups.length} קבוצות של כפילויות תוכן שצריך לתקן.
משימתך: **להתאים אישית כל קטע** כך שיהיה ייחודי לעמוד בו הוא מופיע.

---

`;
            
            groups.forEach((group, gIdx) => {
                prompt += `## 📦 קבוצה ${gIdx + 1} - ${Math.round((group.similarity || 0) * 100)}% דמיון

### עמודים מעורבים:
${group.pages.map(p => `- **${p.keyword}** (\`${p.path}\`)`).join('\n')}

### קטעים כפולים:
${(group.duplicate_snippets || []).map((s, i) => `
${i + 1}. \`\`\`
${s.text}
\`\`\`
`).join('\n')}

---

`;
            });
            
            prompt += `## 🏁 סיכום

עבור על כל הקבוצות ותקן את הכפילויות. וודא שכל עמוד מקבל גרסה ייחודית!
`;
            
            return prompt;
        }
        
        function getKeywordFromPath(path) {
            const match = (path || '').match(/([^\/\\]+)[\/\\][^\/\\]+\.html$/);
            return match ? match[1] : 'לא ידוע';
        }
        
        function showDuplicateFixPrompt(prompt, groups) {
            const modal = document.getElementById('duplicate-fix-modal');
            const textarea = document.getElementById('duplicate-fix-prompt');
            
            if (textarea) textarea.value = prompt;
            if (modal) modal.classList.add('active');
            
            window.currentDuplicateFixContext = { prompt, groups };
        }
        
        function closeDuplicateFixModal() {
            document.getElementById('duplicate-fix-modal').classList.remove('active');
        }
        
        async function executeDuplicateFix() {
            const prompt = document.getElementById('duplicate-fix-prompt')?.value;
            const context = window.currentDuplicateFixContext;
            
            if (!prompt || !context) {
                showToast('חסר פרומפט', 'error');
                return;
            }
            
            try {
                const result = await apiCall('/api/duplicates/bulk-fix', {
                    method: 'POST',
                    body: JSON.stringify({
                        groups: context.groups,
                        prompt: prompt
                    })
                });
                
                if (result.success) {
                    showToast('✅ הפרומפט נשמר - מוכן לעיבוד', 'success');
                    closeDuplicateFixModal();
                } else {
                    showToast('שגיאה: ' + (result.error || ''), 'error');
                }
            } catch (err) {
                showToast('שגיאה: ' + err.message, 'error');
            }
        }
        
        // Heatmap
        function showHeatmap() {
            if (!currentDuplicatesReport || !currentDuplicatesReport.similarity_matrix) {
                showToast('אין מטריצת דמיון זמינה', 'warning');
                return;
            }
            
            const modal = document.getElementById('heatmap-modal');
            const container = document.getElementById('heatmap-container');
            
            if (container) {
                container.innerHTML = renderHeatmap(
                    currentDuplicatesReport.similarity_matrix,
                    currentDuplicatesReport.heatmap_labels || []
                );
            }
            if (modal) modal.classList.add('active');
        }
        
        function renderHeatmap(matrix, labels) {
            if (!matrix || matrix.length === 0) {
                return '<p>אין נתונים להצגה</p>';
            }
            
            let html = '<div class="heatmap-wrapper"><table class="heatmap-table">';
            
            // Header row
            html += '<tr><th></th>';
            labels.forEach(label => {
                html += `<th title="${escapeHtml(label)}">${escapeHtml((label || '').substring(0, 8))}</th>`;
            });
            html += '</tr>';
            
            matrix.forEach((row, i) => {
                html += `<tr><th title="${escapeHtml(labels[i] || '')}">${escapeHtml((labels[i] || '').substring(0, 8))}</th>`;
                row.forEach((val, j) => {
                    const color = getHeatmapColor(val);
                    const display = i === j ? '-' : Math.round(val * 100);
                    html += `<td style="background: ${color}" title="${Math.round(val * 100)}%">
                        ${display}
                    </td>`;
                });
                html += '</tr>';
            });
            
            html += '</table></div>';
            return html;
        }
        
        function getHeatmapColor(val) {
            if (val >= 0.85) return '#ef4444';
            if (val >= 0.7) return '#f97316';
            if (val >= 0.5) return '#eab308';
            if (val >= 0.3) return '#84cc16';
            return '#22c55e';
        }
        
        function closeHeatmap() {
            document.getElementById('heatmap-modal').classList.remove('active');
        }
        
        // Diff Viewer
        async function showDiffViewer(page1Path, page2Path) {
            if (!page1Path || !page2Path) {
                showToast('חסרים נתיבי עמודים', 'error');
                return;
            }
            
            const modal = document.getElementById('diff-viewer-modal');
            const container = document.getElementById('diff-viewer-container');
            
            if (container) {
                container.innerHTML = '<div class="loading-spinner">טוען השוואה...</div>';
            }
            if (modal) modal.classList.add('active');
            
            try {
                const result = await apiCall('/api/duplicates/compare', {
                    method: 'POST',
                    body: JSON.stringify({ page1: page1Path, page2: page2Path })
                });
                
                if (result.success) {
                    displayDiffViewer(result);
                } else {
                    container.innerHTML = `<p>שגיאה: ${result.error || 'Unknown'}</p>`;
                }
            } catch (err) {
                container.innerHTML = `<p>שגיאה: ${err.message}</p>`;
            }
        }
        
        function displayDiffViewer(diff) {
            const title1 = document.getElementById('diff-page1-title');
            const title2 = document.getElementById('diff-page2-title');
            const content1 = document.getElementById('diff-page1-content');
            const content2 = document.getElementById('diff-page2-content');
            
            if (title1) title1.textContent = diff.page1?.keyword || 'עמוד 1';
            if (title2) title2.textContent = diff.page2?.keyword || 'עמוד 2';
            
            const highlighted1 = highlightMatches(diff.page1?.content || '', diff.matches || []);
            const highlighted2 = highlightMatches(diff.page2?.content || '', diff.matches || []);
            
            if (content1) content1.innerHTML = `<pre>${highlighted1}</pre>`;
            if (content2) content2.innerHTML = `<pre>${highlighted2}</pre>`;
        }
        
        function highlightMatches(text, matches) {
            let result = escapeHtml(text);
            
            matches.forEach(match => {
                const escapedMatch = escapeHtml(match);
                const regex = new RegExp(escapedMatch.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
                result = result.replace(regex, `<span class="diff-match">${escapedMatch}</span>`);
            });
            
            return result;
        }
        
        function closeDiffViewer() {
            document.getElementById('diff-viewer-modal').classList.remove('active');
        }
        
        // Ignore Manager
        async function openIgnoreManager() {
            const modal = document.getElementById('ignore-manager-modal');
            if (modal) modal.classList.add('active');
            
            await loadIgnorePatterns();
            renderPatternsList();
        }
        
        function closeIgnoreManager() {
            document.getElementById('ignore-manager-modal').classList.remove('active');
        }
        
        async function loadIgnorePatterns() {
            try {
                const result = await apiCall('/api/duplicates/ignore');
                if (result.success) {
                    ignorePatterns = result.patterns || [];
                    updatePatternsCount();
                }
            } catch (err) {
                console.error('Error loading ignore patterns:', err);
            }
        }
        
        async function addIgnorePattern() {
            const text = document.getElementById('new-pattern-text')?.value?.trim();
            const typeEl = document.querySelector('input[name="pattern-type"]:checked');
            const type = typeEl?.value || 'exact';
            const description = document.getElementById('pattern-description')?.value?.trim() || '';
            
            if (!text) {
                showToast('יש להזין טקסט', 'warning');
                return;
            }
            
            try {
                const result = await apiCall('/api/duplicates/ignore', {
                    method: 'POST',
                    body: JSON.stringify({ pattern: text, type, description })
                });
                
                if (result.success) {
                    showToast('✅ הפטור נוסף', 'success');
                    document.getElementById('new-pattern-text').value = '';
                    document.getElementById('pattern-description').value = '';
                    await loadIgnorePatterns();
                    renderPatternsList();
                }
            } catch (err) {
                showToast('שגיאה בהוספת פטור', 'error');
            }
        }
        
        async function addTemplatePattern(templateId) {
            const template = ignoreTemplates[templateId];
            if (!template) return;
            
            try {
                const result = await apiCall('/api/duplicates/ignore', {
                    method: 'POST',
                    body: JSON.stringify({ 
                        pattern: template.text, 
                        type: template.type, 
                        description: template.description 
                    })
                });
                
                if (result.success) {
                    showToast(`✅ תבנית "${template.description}" נוספה`, 'success');
                    await loadIgnorePatterns();
                    renderPatternsList();
                }
            } catch (err) {
                showToast('שגיאה בהוספת תבנית', 'error');
            }
        }
        
        async function deleteIgnorePattern(patternId) {
            if (!confirm('למחוק פטור זה?')) return;
            
            try {
                const result = await apiCall(`/api/duplicates/ignore/${patternId}`, {
                    method: 'DELETE'
                });
                
                if (result.success) {
                    showToast('🗑️ הפטור נמחק', 'success');
                    await loadIgnorePatterns();
                    renderPatternsList();
                }
            } catch (err) {
                showToast('שגיאה במחיקת פטור', 'error');
            }
        }
        
        async function addSnippetToIgnoreFromReport(text) {
            try {
                const result = await apiCall('/api/duplicates/ignore', {
                    method: 'POST',
                    body: JSON.stringify({ 
                        pattern: text, 
                        type: 'exact',
                        description: 'נוסף מדוח כפילויות'
                    })
                });
                
                if (result.success) {
                    showToast('✅ נוסף לרשימת פטורים', 'success');
                }
            } catch (err) {
                showToast('שגיאה', 'error');
            }
        }
        
        function renderPatternsList() {
            const container = document.getElementById('patterns-list');
            
            if (!container) return;
            
            if (ignorePatterns.length === 0) {
                container.innerHTML = '<div class="no-patterns">אין פטורים מוגדרים</div>';
                return;
            }
            
            const typeLabels = {
                'exact': '🎯 התאמה מדויקת',
                'contains': '📝 מכיל טקסט',
                'regex': '🔣 Regex'
            };
            
            container.innerHTML = ignorePatterns.map(pattern => `
                <div class="pattern-item">
                    <div class="pattern-header">
                        <span class="pattern-type">${typeLabels[pattern.type] || pattern.type}</span>
                        <button class="btn-delete" onclick="deleteIgnorePattern('${pattern.id}')" title="מחק">
                            🗑️
                        </button>
                    </div>
                    <div class="pattern-text">${escapeHtml(pattern.text || '')}</div>
                    ${pattern.description ? `<div class="pattern-description">💬 ${escapeHtml(pattern.description)}</div>` : ''}
                    <div class="pattern-meta">
                        <small>נוסף: ${pattern.added_at ? new Date(pattern.added_at).toLocaleDateString('he-IL') : 'לא ידוע'}</small>
                    </div>
                </div>
            `).join('');
        }
        
        function updatePatternsCount() {
            const countEl = document.getElementById('patterns-count');
            if (countEl) {
                countEl.textContent = `${ignorePatterns.length} פטורים`;
            }
        }
        
        // Helper functions
        function getSimilarityColor(similarity) {
            if (similarity >= 0.85) return '#ef4444';
            if (similarity >= 0.70) return '#f59e0b';
            return '#10b981';
        }
        
        function getSeoImpactBadge(impact) {
            if (!impact) return '';
            
            const colors = {
                critical: '#ef4444',
                high: '#f59e0b',
                medium: '#10b981'
            };
            
            const icons = {
                critical: '🔴',
                high: '🟡',
                medium: '🟢'
            };
            
            return `<span class="seo-impact-badge" style="background: ${colors[impact.level] || '#666'}" title="${escapeHtml(impact.reason || '')}">
                ${icons[impact.level] || ''} SEO: ${impact.score || 0}/100
            </span>`;
        }
        
        function getSnippetTypeLabel(type) {
            const labels = {
                'body': 'טקסט גוף',
                'h1': 'כותרת H1',
                'h2': 'כותרת H2',
                'h3': 'כותרת H3',
                'title': 'Title',
                'description': 'Description'
            };
            return labels[type] || type || 'לא ידוע';
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function escapeHtmlAttr(text) {
            if (!text) return '';
            return text.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        }
        
        function openPageInEditor(path) {
            // Navigate to page in edit tab
            const pageItem = document.querySelector(`[data-path="${path}"]`);
            if (pageItem) {
                pageItem.click();
            } else {
                showToast('העמוד לא נמצא ברשימה', 'warning');
            }
        }
        
        // View snippet in page - opens a modal showing the page content with highlighted snippet
        async function viewSnippetInPage(pagePath, snippetText) {
            if (!pagePath || !snippetText) {
                showToast('חסרים נתונים', 'error');
                return;
            }
            
            // Show loading
            showToast('טוען עמוד...', 'info');
            
            try {
                // Fetch page content
                const result = await apiCall(`/api/page/html-content?page_folder=${encodeURIComponent(pagePath.replace(/[\/\\][^\/\\]+\.html$/, ''))}`);
                
                if (result.success && result.content) {
                    // Show modal with highlighted content
                    showSnippetLocationModal(pagePath, result.content, snippetText);
                } else {
                    // Try alternative: get preview
                    const previewResult = await apiCall(`/api/preview/${encodeURIComponent(pagePath)}`);
                    if (previewResult) {
                        showSnippetLocationModal(pagePath, previewResult, snippetText);
                    } else {
                        showToast('לא ניתן לטעון את תוכן העמוד', 'error');
                    }
                }
            } catch (err) {
                console.error('Error loading page:', err);
                showToast('שגיאה בטעינת העמוד', 'error');
            }
        }
        
        function showSnippetLocationModal(pagePath, content, snippetText) {
            // Create or get modal
            let modal = document.getElementById('snippet-location-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'snippet-location-modal';
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal snippet-location-modal">
                        <div class="modal-header">
                            <h2>📍 מיקום הקטע בעמוד</h2>
                            <button class="modal-close" onclick="closeSnippetLocationModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="snippet-location-info">
                                <strong>עמוד:</strong> <span id="snippet-location-page"></span>
                            </div>
                            <div class="snippet-location-search">
                                <strong>קטע מסומן:</strong>
                                <div id="snippet-location-text" class="snippet-highlight-preview"></div>
                            </div>
                            <div class="snippet-location-content" id="snippet-location-content"></div>
                            
                            <!-- Inline Editor Section -->
                            <div class="snippet-inline-editor" id="snippet-inline-editor" style="display: none;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                    <strong style="color: #1e293b;">✏️ עריכה ישירה:</strong>
                                    <button class="btn btn-small btn-secondary" onclick="cancelInlineEdit()">ביטול</button>
                                </div>
                                <textarea id="snippet-edit-textarea" dir="rtl"></textarea>
                                <div class="snippet-editor-actions">
                                    <button class="btn btn-success" onclick="saveInlineEdit()">💾 שמור שינויים</button>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeSnippetLocationModal()">סגור</button>
                            <button class="btn btn-primary" id="snippet-edit-btn" onclick="enableInlineEdit()">✏️ ערוך כאן</button>
                            <button class="btn btn-secondary" onclick="goToEditTab()">📁 עבור לעמוד מלא</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            // Get page keyword from path
            const keyword = getKeywordFromPath(pagePath);
            
            // Set content
            document.getElementById('snippet-location-page').textContent = keyword + ' (' + pagePath + ')';
            document.getElementById('snippet-location-text').textContent = snippetText.substring(0, 200) + (snippetText.length > 200 ? '...' : '');
            
            // Highlight snippet in content
            const contentEl = document.getElementById('snippet-location-content');
            const highlightedContent = highlightSnippetInContent(content, snippetText);
            contentEl.innerHTML = highlightedContent;
            
            // Store current page path and content for editing
            window.currentSnippetPagePath = pagePath;
            window.currentSnippetFullContent = content;
            window.currentSnippetText = snippetText;
            
            // Reset editor state
            document.getElementById('snippet-inline-editor').style.display = 'none';
            document.getElementById('snippet-edit-btn').style.display = 'inline-block';
            
            // Show modal
            modal.classList.add('active');
            
            // Scroll to first highlight
            setTimeout(() => {
                const firstHighlight = contentEl.querySelector('.snippet-highlight');
                if (firstHighlight) {
                    firstHighlight.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 100);
        }
        
        function enableInlineEdit() {
            const editor = document.getElementById('snippet-inline-editor');
            const textarea = document.getElementById('snippet-edit-textarea');
            const editBtn = document.getElementById('snippet-edit-btn');
            
            // Show editor with full content
            editor.style.display = 'block';
            editBtn.style.display = 'none';
            
            // Parse HTML to get editable text
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = window.currentSnippetFullContent || '';
            tempDiv.querySelectorAll('script, style').forEach(el => el.remove());
            const textContent = tempDiv.innerHTML;
            
            textarea.value = textContent;
            textarea.focus();
            
            // Try to scroll to and select the snippet
            const snippetText = window.currentSnippetText || '';
            const snippetStart = snippetText.substring(0, 50);
            const position = textarea.value.indexOf(snippetStart);
            if (position !== -1) {
                textarea.setSelectionRange(position, position + snippetText.length);
                // Scroll textarea to show selection
                textarea.blur();
                textarea.focus();
            }
        }
        
        function cancelInlineEdit() {
            document.getElementById('snippet-inline-editor').style.display = 'none';
            document.getElementById('snippet-edit-btn').style.display = 'inline-block';
        }
        
        async function saveInlineEdit() {
            const textarea = document.getElementById('snippet-edit-textarea');
            const newContent = textarea.value;
            const pagePath = window.currentSnippetPagePath;
            
            if (!pagePath) {
                showToast('שגיאה: לא נמצא נתיב עמוד', 'error');
                return;
            }
            
            showToast('💾 שומר שינויים...', 'info');
            
            try {
                const result = await apiCall('/api/page/content', {
                    method: 'POST',
                    body: JSON.stringify({
                        path: pagePath,
                        content: newContent
                    })
                });
                
                if (result.success) {
                    showToast('✅ השינויים נשמרו בהצלחה!', 'success');
                    
                    // Update stored content
                    window.currentSnippetFullContent = newContent;
                    
                    // Refresh the highlighted view
                    const contentEl = document.getElementById('snippet-location-content');
                    const highlightedContent = highlightSnippetInContent(newContent, window.currentSnippetText);
                    contentEl.innerHTML = highlightedContent;
                    
                    // Hide editor
                    cancelInlineEdit();
                } else {
                    showToast('❌ שגיאה בשמירה: ' + (result.error || 'שגיאה לא ידועה'), 'error');
                }
            } catch (error) {
                showToast('❌ שגיאה בשמירה: ' + error.message, 'error');
            }
        }
        
        function highlightSnippetInContent(htmlContent, snippetText) {
            // Parse HTML to get text
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlContent;
            
            // Remove scripts and styles
            tempDiv.querySelectorAll('script, style').forEach(el => el.remove());
            
            // Get the HTML content
            let content = tempDiv.innerHTML;
            
            // Escape special regex characters in snippet
            const escapedSnippet = snippetText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            
            // Try to find and highlight the snippet
            // First, try exact match
            const regex = new RegExp(`(${escapedSnippet.substring(0, 100)})`, 'gi');
            
            // Create a simpler approach - show the text content with highlighting
            const textContent = tempDiv.textContent || tempDiv.innerText;
            
            // Find position of snippet in text
            const snippetStart = snippetText.substring(0, 50);
            const position = textContent.indexOf(snippetStart);
            
            if (position !== -1) {
                // Show context around the match
                const contextStart = Math.max(0, position - 200);
                const contextEnd = Math.min(textContent.length, position + snippetText.length + 200);
                
                const before = escapeHtml(textContent.substring(contextStart, position));
                const match = escapeHtml(textContent.substring(position, position + snippetText.length));
                const after = escapeHtml(textContent.substring(position + snippetText.length, contextEnd));
                
                return `
                    <div class="snippet-context">
                        ${contextStart > 0 ? '<span class="context-ellipsis">...</span>' : ''}
                        <span class="context-before">${before}</span>
                        <span class="snippet-highlight">${match}</span>
                        <span class="context-after">${after}</span>
                        ${contextEnd < textContent.length ? '<span class="context-ellipsis">...</span>' : ''}
                    </div>
                    <div class="full-content-toggle">
                        <button class="btn btn-xs" onclick="toggleFullContent()">📄 הצג תוכן מלא</button>
                    </div>
                    <div id="full-content-area" class="full-content" style="display: none;">
                        <pre>${escapeHtml(textContent)}</pre>
                    </div>
                `;
            } else {
                // Snippet not found exactly, show full content
                return `
                    <div class="snippet-not-found">
                        ⚠️ הקטע לא נמצא בדיוק בעמוד. יתכן שהוא השתנה.
                    </div>
                    <div class="full-content">
                        <pre>${escapeHtml(textContent.substring(0, 3000))}${textContent.length > 3000 ? '\n\n... (קוצר)' : ''}</pre>
                    </div>
                `;
            }
        }
        
        function toggleFullContent() {
            const fullContent = document.getElementById('full-content-area');
            if (fullContent) {
                fullContent.style.display = fullContent.style.display === 'none' ? 'block' : 'none';
            }
        }
        
        function closeSnippetLocationModal() {
            const modal = document.getElementById('snippet-location-modal');
            if (modal) {
                modal.classList.remove('active');
            }
        }
        
        function goToEditTab() {
            closeSnippetLocationModal();
            
            // Switch to edit tab
            const editTab = document.querySelector('[data-tab="edit"]');
            if (editTab) {
                editTab.click();
            }
            
            // Find and click the page
            if (window.currentSnippetPagePath) {
                setTimeout(() => {
                    const pageItem = document.querySelector(`[data-path*="${getKeywordFromPath(window.currentSnippetPagePath)}"]`);
                    if (pageItem) {
                        pageItem.click();
                    }
                }, 300);
            }
        }
    </script>
    
    <!-- Delete Page Modal -->
    <div id="deletePageModal" class="system-modal" style="display:none;">
        <div class="modal-content">
            <h2 style="margin-bottom:1rem; color:var(--text-primary);">🗑️ מחיקת עמוד</h2>
            <p style="margin-bottom:1.5rem; color:var(--text-secondary);">
                האם אתה בטוח שברצונך למחוק את העמוד <strong id="deletePageName" style="color:var(--accent);"></strong>?
            </p>
            <p style="margin-bottom:1.5rem; font-size:0.85rem; color:var(--text-secondary);">
                ⚠️ העמוד יימחק מ-WordPress והקבצים יועברו לארכיון
            </p>
            
            <div class="delete-options" style="margin-bottom:1.5rem; display:flex; flex-direction:column; gap:0.75rem;">
                <label style="display:flex; align-items:center; gap:0.5rem; cursor:pointer; padding:0.5rem; border-radius:6px; border:1px solid var(--border); background:var(--bg-tertiary);">
                    <input type="radio" name="redirectType" value="301" checked style="cursor:pointer;">
                    <span style="color:var(--text-primary);">301 Redirect - הפניה קבועה (מומלץ לשמירת SEO)</span>
                </label>
                <label style="display:flex; align-items:center; gap:0.5rem; cursor:pointer; padding:0.5rem; border-radius:6px; border:1px solid var(--border); background:var(--bg-tertiary);">
                    <input type="radio" name="redirectType" value="410" style="cursor:pointer;">
                    <span style="color:var(--text-primary);">410 Gone - העמוד לא קיים יותר</span>
                </label>
                <label style="display:flex; align-items:center; gap:0.5rem; cursor:pointer; padding:0.5rem; border-radius:6px; border:1px solid var(--border); background:var(--bg-tertiary);">
                    <input type="radio" name="redirectType" value="none" style="cursor:pointer;">
                    <span style="color:var(--text-primary);">ללא הפניה (404 Not Found)</span>
                </label>
            </div>
            
            <div id="redirectTargetDiv" style="margin-bottom:1.5rem;">
                <label style="display:block; margin-bottom:0.5rem; color:var(--text-primary);">הפנה ל:</label>
                
                <!-- בחירת עמוד מהרשימה -->
                <div style="margin-bottom:0.75rem;">
                    <select id="redirectPageSelect" onchange="selectPageForRedirect()" style="width:100%; padding:0.5rem; border-radius:6px; border:1px solid var(--border); background:var(--bg-tertiary); color:var(--text-primary);">
                        <option value="">📄 בחר עמוד מהאתר...</option>
                        <!-- Populated dynamically -->
                    </select>
                    <div style="font-size:0.75rem; color:var(--text-secondary); margin-top:0.25rem;">
                        💡 בחר עמוד קיים או הזן כתובת ידנית למטה
                    </div>
                </div>
                
                <!-- או הזנה ידנית -->
                <div style="display:flex; gap:0.5rem;">
                    <input type="text" id="redirectTarget" placeholder="https://loan-israel.co.il/" style="flex:1; padding:0.5rem; border-radius:6px; border:1px solid var(--border); background:var(--bg-tertiary); color:var(--text-primary);" />
                    <button onclick="suggestRedirectTarget()" class="btn btn-secondary" style="white-space:nowrap;">📍 דף הבית</button>
                </div>
            </div>
            
            <div class="modal-actions" style="display:flex; gap:0.75rem; justify-content:flex-end;">
                <button class="btn btn-danger" onclick="executeDelete()">🗑️ מחק עמוד</button>
                <button class="btn btn-secondary" onclick="closeDeleteModal()">ביטול</button>
            </div>
        </div>
    </div>
    
    <script>
        // Delete Page Functionality
        let pageToDelete = null;
        
        // Show/hide redirect target based on redirect type
        document.addEventListener('change', function(e) {
            if (e.target && e.target.name === 'redirectType') {
                const redirectTargetDiv = document.getElementById('redirectTargetDiv');
                const redirectType = e.target.value;
                redirectTargetDiv.style.display = (redirectType === '301' || redirectType === '302') ? 'block' : 'none';
            }
        });
        
        function confirmDeletePage(pagePath) {
            pageToDelete = pagePath;
            const page = pages.find(p => p.path === pagePath || p.path.replace(/\\/g, '/') === pagePath);
            
            if (!page) {
                showToast('לא נמצא עמוד', 'error');
                return;
            }
            
            document.getElementById('deletePageName').textContent = page.name;
            const modal = document.getElementById('deletePageModal');
            modal.style.display = 'block'; // Block is enough because children are fixed positioned
            
            // Populate pages dropdown for redirect
            populateRedirectPagesDropdown(page.site || 'main', pagePath);
            
            // Set default redirect to homepage
            const site = page.site || 'main';
            const siteConfig = wpSitesConfig?.[site];
            const siteUrl = siteConfig ? siteConfig.site_url : 'https://loan-israel.co.il';
            document.getElementById('redirectTarget').value = siteUrl;
            
            // Reset to 301 default
            document.querySelector('input[name="redirectType"][value="301"]').checked = true;
            document.getElementById('redirectTargetDiv').style.display = 'block';
        }
        
        function populateRedirectPagesDropdown(site, currentPagePath) {
            const select = document.getElementById('redirectPageSelect');
            select.innerHTML = '<option value="">📄 בחר עמוד מהאתר...</option>';
            
            // Filter pages from the same site, excluding the current page
            const sameSitePages = pages.filter(p => {
                const pageSite = p.site || 'main';
                const normalizedPath = p.path.replace(/\\/g, '/');
                const normalizedCurrentPath = currentPagePath.replace(/\\/g, '/');
                
                return pageSite === site && 
                       normalizedPath !== normalizedCurrentPath &&
                       !p.name.toLowerCase().includes('_backup') &&
                       !p.path.toLowerCase().includes('_backup');
            });
            
            // Sort alphabetically
            sameSitePages.sort((a, b) => a.name.localeCompare(b.name, 'he'));
            
            // Add pages to dropdown
            sameSitePages.forEach(p => {
                const pageInfo = pageInfoCache[p.path];
                const url = pageInfo?.url || '';
                
                if (url) {
                    const option = document.createElement('option');
                    option.value = url;
                    option.textContent = `${p.name.replace('.html', '')}`;
                    select.appendChild(option);
                }
            });
            
            // Add count to placeholder
            if (sameSitePages.length > 0) {
                select.options[0].textContent = `📄 בחר עמוד מהאתר (${sameSitePages.length} עמודים)`;
            } else {
                select.options[0].textContent = '📄 אין עמודים זמינים באתר זה';
            }
        }
        
        function selectPageForRedirect() {
            const select = document.getElementById('redirectPageSelect');
            const selectedUrl = select.value;
            
            if (selectedUrl) {
                document.getElementById('redirectTarget').value = selectedUrl;
            }
        }
        
        function closeDeleteModal() {
            const modal = document.getElementById('deletePageModal');
            modal.style.display = 'none';
            pageToDelete = null;
        }
        
        async function executeDelete() {
            if (!pageToDelete) return;
            
            const redirectType = document.querySelector('input[name="redirectType"]:checked').value;
            const redirectTarget = document.getElementById('redirectTarget').value;
            
            const page = pages.find(p => p.path === pageToDelete || p.path.replace(/\\/g, '/') === pageToDelete);
            
            if (!page) {
                showToast('לא נמצא עמוד', 'error');
                return;
            }
            
            const pageInfo = pageInfoCache[page.path];
            
            if (!pageInfo || !pageInfo.wordpress_id) {
                showToast('❌ לא נמצא מזהה WordPress לעמוד. וודא שהעמוד פורסם ב-WordPress.', 'error');
                return;
            }
            
            // Validate redirect target if needed
            if ((redirectType === '301' || redirectType === '302') && !redirectTarget) {
                showToast('❌ יש להזין כתובת יעד להפניה', 'error');
                return;
            }
            
            showToast('🗑️ מוחק עמוד...', 'info');
            
            try {
                const result = await apiCall('/api/wordpress/delete-page', {
                    method: 'POST',
                    body: JSON.stringify({
                        post_id: pageInfo.wordpress_id,
                        url: pageInfo.url,
                        page_path: page.path,
                        redirect_type: redirectType,
                        redirect_target: redirectType === '301' || redirectType === '302' ? redirectTarget : null
                    })
                });
                
                if (result.success) {
                    showToast('✅ העמוד נמחק בהצלחה! הקבצים נשמרו בארכיון.', 'success');
                    closeDeleteModal();
                    
                    // Reload pages list
                    await loadPages();
                } else {
                    showToast('❌ שגיאה במחיקה: ' + (result.error || 'שגיאה לא ידועה'), 'error');
                }
            } catch (error) {
                showToast('❌ שגיאה במחיקה: ' + error.message, 'error');
            }
        }
        
        // Auto-suggest redirect target (homepage by default)
        function suggestRedirectTarget() {
            if (!pageToDelete) return;
            
            const page = pages.find(p => p.path === pageToDelete || p.path.replace(/\\/g, '/') === pageToDelete);
            if (!page) return;
            
            const site = page.site || 'main';
            const siteConfig = wpSitesConfig?.[site];
            const siteUrl = siteConfig ? siteConfig.site_url : 'https://loan-israel.co.il';
            document.getElementById('redirectTarget').value = siteUrl;
        }
        
        // Move system modals to body to ensure fixed positioning works relative to viewport
        document.addEventListener('DOMContentLoaded', () => {
            const modals = document.querySelectorAll('.system-modal');
            modals.forEach(modal => {
                if (modal.parentElement !== document.body) {
                    document.body.appendChild(modal);
                }
            });
        });
        
        // Close modal on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && document.getElementById('deletePageModal').style.display === 'flex') {
                closeDeleteModal();
            }
        });
        
        // Close modal on background click
        document.getElementById('deletePageModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeDeleteModal();
            }
        });
        
        // ============ Archive Tab Functionality ============
        
        // Handle archive tab click
        document.querySelector('.tab[data-tab="archive"]').addEventListener('click', function() {
            showArchiveModal();
        });
        
        async function showArchiveModal() {
            showToast('📦 טוען ארכיון...', 'info');
            
            const result = await apiCall('/api/pages/archived');
            
            if (!result.success) {
                showToast('❌ שגיאה בטעינת ארכיון: ' + result.error, 'error');
                return;
            }
            
            const archivedPages = result.pages || [];
            
            // Create modal HTML
            let modalHtml = `
                <div id="archiveModal" class="system-modal" style="display:block;">
                    <div class="modal-content">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
                            <h2 style="margin:0; color:var(--text-primary);">📦 עמודים בארכיון</h2>
                            <button onclick="closeArchiveModal()" class="btn btn-secondary">✕</button>
                        </div>
                        
                        ${archivedPages.length === 0 ? '<p style="text-align:center; color:var(--text-secondary);">אין עמודים בארכיון</p>' : ''}
                        
                        <div style="display:flex; flex-direction:column; gap:1rem;">
            `;
            
            archivedPages.forEach(page => {
                const archivedDate = page.archived_at ? new Date(page.archived_at).toLocaleString('he-IL') : 'לא ידוע';
                const metadata = page.metadata || {};
                const redirectInfo = metadata.redirect_type ? `(Redirect: ${metadata.redirect_type})` : '';
                
                modalHtml += `
                    <div style="background:var(--bg-tertiary); padding:1rem; border-radius:8px; border:1px solid var(--border);">
                        <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:0.5rem;">
                            <div style="flex:1;">
                                <div style="font-weight:bold; color:var(--text-primary); margin-bottom:0.25rem;">
                                    ${page.html_file || page.folder_name}
                                </div>
                                <div style="font-size:0.85rem; color:var(--text-secondary);">
                                    📅 נמחק: ${archivedDate}
                                </div>
                                <div style="font-size:0.85rem; color:var(--text-secondary);">
                                    📁 ${page.folder_name}
                                </div>
                                ${metadata.url ? `<div style="font-size:0.75rem; color:var(--info); margin-top:0.25rem;">🔗 ${metadata.url} ${redirectInfo}</div>` : ''}
                            </div>
                            <div style="display:flex; gap:0.5rem;">
                                <button onclick="restorePage('${page.folder_path.replace(/\\/g, '\\\\').replace(/'/g, "\\'")}', '${page.html_file || ''}')" class="btn btn-success btn-small">
                                    ♻️ שחזר
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            modalHtml += `
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to body (outside of any other container)
            const existingModal = document.getElementById('archiveModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Close on escape
            document.addEventListener('keydown', function escHandler(e) {
                if (e.key === 'Escape') {
                    closeArchiveModal();
                    document.removeEventListener('keydown', escHandler);
                }
            });
            
            // Close on background click
            document.getElementById('archiveModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeArchiveModal();
                }
            });
        }
        
        function closeArchiveModal() {
            const modal = document.getElementById('archiveModal');
            if (modal) {
                modal.remove();
            }
        }
        
        async function restorePage(archivePath, htmlFile) {
            if (!confirm(`האם אתה בטוח שברצונך לשחזר עמוד זה?\n\nהקבצים יוחזרו לתיקיית העמודים, וה-redirect יימחק (אם קיים).`)) {
                return;
            }
            
            showToast('♻️ משחזר עמוד...', 'info');
            
            try {
                const result = await apiCall('/api/page/restore', {
                    method: 'POST',
                    body: JSON.stringify({
                        archive_path: archivePath,
                        restore_to_wordpress: false,
                        delete_redirect: true
                    })
                });
                
                if (result.success) {
                    showToast('✅ העמוד שוחזר בהצלחה! ' + result.message, 'success');
                    closeArchiveModal();
                    
                    // Reload pages list
                    await loadPages();
                } else {
                    showToast('❌ שגיאה בשחזור: ' + (result.error || 'שגיאה לא ידועה'), 'error');
                }
            } catch (error) {
                showToast('❌ שגיאה בשחזור: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>

