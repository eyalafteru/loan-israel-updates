# 🤖 מידע לפיתוח AI - מערכת ניהול עמודים

> **קובץ זה מסכם את כל מה ש-AI צריך לדעת כדי להמשיך לפתח את הפרויקט**

---

## 📋 תקציר מנהלים

מערכת זו היא **Dashboard לניהול ועדכון תוכן** לאתרי WordPress עבור loan-israel.co.il.
המערכת מאפשרת הפעלת **סוכני AI (Claude)** על עמודי HTML, ביצוע אופטימיזציית SEO, ועדכון אוטומטי לוורדפרס.
כמו כן, המערכת כוללת מנגנוני ניהול מתקדמים לארכיון, שחזור עמודים וניהול הפניות 301.

### טכנולוגיות עיקריות
- **Backend:** Python Flask (dashboard_server.py) - כ-13,000 שורות קוד.
- **Frontend:** HTML/CSS/JS בקובץ אחד (dashboard.html) - כ-28,000 שורות קוד.
- **AI:** Claude Code (CLI) + Anthropic API + **Ollama (מודלים מקומיים: Gemma 2, Qwen 2.5)**.
- **CMS:** WordPress עם JWT Authentication ו-Yoast SEO Premium.
- **APIs חיצוניות:** Apify (SERP, Autocomplete, Web Scraper).
- **סריקה:** Playwright (Chrome מקומי) + Apify כגיבוי.

---

## 🗂️ מבנה הפרויקט

```
📁 loan-israel-updates/
├── 📄 dashboard_server.py    # ← השרת הראשי (Flask) - מטפל בכל הלוגיקה
├── 📄 dashboard.html         # ← הממשק הגרפי (HTML/JS/CSS)
├── 📄 config.json           # ← הגדרות מערכת, אתרים, נתיבים
├── 📄 ai_summarizer.py      # ← מנוע סיכום AI עם Ollama (חדש!)
├── 📄 local_scraper.py      # ← סקרייפר מקומי עם Playwright/Chrome (חדש!)
├── 📁 agents/               # ← הגדרות סוכנים (Dynamic JSON Loading)
│   ├── seo.json
│   ├── atomic_marketing.json
│   ├── business_loans_content.json
│   └── business_ultimate.json
├── 📁 generated_data/       # ← מידע שנוצר אוטומטית (חדש!)
│   ├── sources_registry.json    # מאגר מקורות מידע
│   └── scraped_sources/         # תוכן שנסרק
├── 📁 פרומטים/              # ← קבצי הוראות לסוכנים (Markdown)
│   ├── SEO/שלב 1-6.md
│   ├── אטומי/שלב 1-4.md
│   └── עסקים אולטימייט/
├── 📁 דפים לשינוי/          # ← העמודים לעריכה
│   ├── main/               # אתר ראשי
│   └── business/           # אתר עסקים
├── 📁 ארכיון/               # ← ארכיון עמודים שנמחקו (עם מטא-דאטה לשחזור)
├── 📁 מאגרי מידע/           # ← מקורות מידע לשורטקודים
├── 📄 requirements.txt
└── 📄 start_dashboard.bat   # ← הרצת המערכת
```

> ⚠️ **הערה חשובה:** תיקיית `agents/` היא המקור הבלעדי להגדרת סוכנים. סוכנים המוגדרים ב-`config.json` הישן נטענים כתמיכה לאחור אך הסוכנים בתיקייה מקבלים קדימות.

---

## 🚀 הרצת המערכת

```bash
# הרצה רגילה (לוקח פורט 8080 ברירת מחדל או 5000)
python dashboard_server.py

# או דרך הבאטץ'
start_dashboard.bat
```

**גישה:** `http://localhost:8080` (או הפורט שנבחר)

---

## 🏗️ ארכיטקטורה ורכיבים מרכזיים (Backend Reference)

שרת ה-Flask (`dashboard_server.py`) מכיל כ-150 Endpoints. להלן המיפוי המלא:

### 1. ניהול עמודים (Pages)
| Endpoint | Method | תפקיד |
|----------|--------|-------|
| `/api/pages` | GET | רשימת כל העמודים (עם סינון וחיפוש) |
| `/api/page/<path>` | GET | קבלת תוכן עמוד ספציפי |
| `/api/page/content` | POST | שמירת תוכן HTML לעמוד |
| `/api/page/info` | GET/POST | קריאה/עדכון של מטא-דאטה (`page_info.json`) |
| `/api/pages/create-folder` | POST | יצירת תיקייה חדשה |
| `/api/csv/*` | GET/POST | ייבוא וייצוא עמודים דרך CSV |

### 2. סוכנים וזרימת עבודה (Agents & Workflow)
| Endpoint | Method | תפקיד |
|----------|--------|-------|
| `/api/agents` | GET/POST | קבלת רשימת סוכנים / יצירת סוכן חדש |
| `/api/agents/<id>` | GET/PUT/DELETE | ניהול סוכן ספציפי |
| `/api/workflow/step<N>` | POST | הרצת שלב ספציפי (1-6) |
| `/api/workflow/single` | POST | הרצה אוטומטית מלאה (Full Auto) |
| `/api/workflow/status` | GET | סטטוס עבודות רצות |
| `/api/workflow/stop` | POST | עצירת עבודה רצה |
| `/api/prompt-file` | GET/POST | עריכת קבצי הפרומטים (.md) |

### 3. אינטגרציה עם WordPress
| Endpoint | Method | תפקיד |
|----------|--------|-------|
| `/api/wordpress/fetch` | POST | משיכת עמוד מ-WP ללוקאלי |
| `/api/wordpress/update` | POST | עדכון עמוד ב-WP (תוכן + מטא) |
| `/api/wordpress/upload` | POST | העלאת עמוד חדש ל-WP |
| `/api/wordpress/delete-page` | POST | מחיקה (Soft Delete) + הפנייה + ארכיון |
| `/api/wordpress/sync-wp-titles` | POST | סנכרון כותרות מ-WP ללוקאלי |
| `/api/wordpress/settings` | GET/POST | הגדרות חיבור (משתמש, סיסמה, URL) |

### 4. SEO ומחקר מתחרים
| Endpoint | Method | תפקיד |
|----------|--------|-------|
| `/api/seo/serp` | POST | בדיקת מיקומים בגוגל (Apify) |
| `/api/seo/scrape-competitors` | POST | סריקת תוכן מתחרים |
| `/api/seo/analyze-gaps` | POST | ניתוח פערים מול מתחרים (Gap Analysis) |
| `/api/keywords/*` | POST | ניהול מאגר מילות מפתח |
| `/api/ai-detection` | POST | בדיקת זיהוי AI בתוכן |

### 5. ארכיון וניהול קבצים
| Endpoint | Method | תפקיד |
|----------|--------|-------|
| `/api/archive` | GET | רשימת עמודים בארכיון |
| `/api/page/restore` | POST | שחזור עמוד מארכיון (כולל ביטול הפנייה) |
| `/api/duplicates/*` | GET/POST | זיהוי וניהול תוכן כפול (Duplicate Content) |
| `/api/files` | GET | סייר קבצים בסיסי |

### 6. ניהול מערכת ו-Git
| Endpoint | Method | תפקיד |
|----------|--------|-------|
| `/api/git/status` | GET | סטטוס Git הנוכחי |
| `/api/git/sync` | POST | סנכרון מלא (Pull + Push) |
| `/api/server/restart` | POST | איתחול השרת |
| `/api/reports/*` | GET/POST | דוחות מערכת (ריבית, וואטסאפ, שנים) |

---

## ⚙️ מאחורי הקלעים: מנוע הסוכנים (The Agent Engine)

זהו הלב של המערכת, המקשר בין הממשק, קבצי ההגדרות וה-AI.

### 1. ShortcodeEngine
מחלקה ב-Python האחראית על "הרכבת" הפרומפט הסופי לפני השליחה.
היא לוקחת את תבנית הפרומפט (Markdown) ומחליפה את ה-Placeholders במידע אמיתי:
*   `{{PAGE_HTML}}` ← קוראת את תוכן הקובץ הלוקאלי.
*   `{{SERP_ORGANIC}}` ← שולפת מידע מ-Cache או מ-API.
*   `{{INTERNAL_LINKS}}` ← טוענת מקובץ דאטה-בייס חיצוני.

### 2. תהליך הרצת סוכן (Workflow Execution)
כאשר לוחצים על "הפעל סוכן":
1.  השרת טוען את קובץ ה-JSON של הסוכן מתיקיית `agents/`.
2.  הוא מזהה את השלב הנוכחי ואת קובץ ה-MD המתאים מתיקיית `פרומטים/`.
3.  **ShortcodeEngine** מעבד את הפרומפט ומייצר טקסט מלא להרצה.
4.  השרת מפעיל תהליך חיצוני (Subprocess) שמריץ את הפקודה `claude`.
5.  הפלט מ-Claude נשמר לקובץ דוח (Markdown) ולוג בזמן אמת נשלח ל-Frontend.

### 3. סוכנים דינאמיים
המערכת סורקת את תיקיית `agents/` בכל בקשת API.
זה אומר שניתן ליצור, לערוך או למחוק סוכנים (קבצי JSON) תוך כדי שהמערכת רצה, והשינויים ישתקפו מיד בממשק.

---

## 🛠️ מדריך: איך ליצור סוכן חדש (Step-by-Step)

תהליך יצירת סוכן הוא פשוט ואינו דורש כתיבת קוד Python, רק הגדרות ופרומפטים.

### שלב 1: יצירת מבנה התיקיות
לך לתיקיית `פרומטים/` וצור תיקייה חדשה עבור הסוכן שלך.
*   דוגמה: `פרומטים/סוכן_מיוחד/`

### שלב 2: כתיבת קבצי ההנחיות (Prompts)
בתוך התיקייה שיצרת, צור קובץ Markdown (`.md`) לכל שלב שתרצה שהסוכן יבצע.
השתמש בשורטקודים כדי "להזריק" מידע דינאמי לפרומפט.

**דוגמה לקובץ `שלב 1.md`:**
```markdown
אתה מומחה תוכן. המשימה שלך היא לשכתב את העמוד הבא:
{{PAGE_HTML}}

אנא השתמש במילת המפתח: {{PAGE_KEYWORD}}
והתייחס למתחרים הבאים:
{{SERP_ORGANIC}}

שמור את התוצאה בקובץ: {{OUTPUT_PATH}}
```

### שלב 3: הגדרת קובץ הקונפיגורציה (JSON)
צור קובץ חדש בתיקיית `agents/` עם שם ייחודי (למשל: `my_special_agent.json`).
העתק את המבנה הבא והתאם אותו:

```json
{
  "id": "my_special_agent",
  "name": "הסוכן המיוחד שלי",
  "description": "תיאור קצר של מה הסוכן עושה",
  "sites": [], // השאר ריק כדי שיופיע בכל האתרים, או ["business"] להגבלה
  "model": {
    "provider": "claude",
    "name": "claude-sonnet-4-5"
  },
  "steps": [
    {
      "id": "step1",
      "name": "ניתוח ראשוני",
      "prompt_file": "פרומטים/סוכן_מיוחד/שלב 1.md",
      "output": {
        "path": "דוח ניתוח.md",
        "shortcode_name": "STEP1_REPORT"
      },
      "shortcodes": [
        "PAGE_HTML",
        "PAGE_KEYWORD",
        "SERP_ORGANIC"
      ]
    },
    {
      "id": "step2",
      "name": "יישום תיקונים",
      "prompt_file": "פרומטים/סוכן_מיוחד/שלב 2.md",
      "shortcodes": [
        "STEP1_REPORT", // שימוש בפלט של השלב הקודם!
        "PAGE_HTML"
      ]
    }
  ]
}
```

### שלב 4: בדיקה
1.  רענן את דף ה-Dashboard.
2.  הסוכן החדש יופיע ברשימת הסוכנים.
3.  בחר עמוד ובדוק את הסוכן.

> 💡 **טיפ:** הקפד לשמור את קובץ ה-JSON בקידוד **UTF-8** (ללא BOM) כדי למנוע שגיאות טעינה.

---

## 📊 דוחות מערכת (System Reports)

אזור ייעודי ב-Dashboard (`#reportsSection`) לביצוע פעולות רוחביות:

1.  **עדכוני ריבית (Interest Updates):** `/api/reports/interest-rate`
    *   סורק את כל העמודים למציאת משפט הריבית.
    *   מאפשר עדכון גורף והעלאה ל-WordPress.

2.  **קישורי WhatsApp:** `/api/reports/whatsapp-links`
    *   זיהוי קישורים שבורים או ישנים.

3.  **עדכון שנה (Year Scan):** `/api/reports/year-scan`
    *   איתור ועדכון אזכורי שנים (למשל 2024 -> 2026).

---

## 🔌 WordPress Integration (Multi-Site)

המערכת תומכת בניהול מספר אתרים במקביל:

| מזהה | שם | כתובת | משתמש API |
|------|-----|--------|-----------|
| `main` | אתר ראשי | loan-israel.co.il | admin |
| `business` | עסקים | loan-israel.co.il/Business | eyal10_Business |

**תהליך המחיקה והארכיון:**
1.  **מחיקה:** העמוד ב-WP עובר ל-Draft + נוצרת הפניית 301.
2.  **ארכיון:** הקבצים עוברים לתיקיית `ארכיון/`.
3.  **שחזור:** העמוד חוזר לתיקייה המקורית + WP Publish + מחיקת ההפנייה.

---

## 💡 טיפים לפיתוח ודיבאג

### Debugging
*   **לוגים:** כל פעולה נרשמת בטרמינל.
*   **קבצי Debug:** חפש קבצים כמו `request_debug.log` או `webhook_debug.log` בשורש הפרויקט במקרה של תקלות API.

---

---

## 📚 מאגר מקורות מידע (Sources Registry) - חדש!

### תיאור
מערכת מרכזית לניהול מקורות מידע חיצוניים (אתרי בנקים, חברות מימון, קרנות וכו') המשמשים לאימות ותמיכה בתוכן העמודים.

### רכיבים עיקריים

#### Backend - `SourcesRegistry` Class
מחלקה ב-`dashboard_server.py` לניהול מאגר מקורות:
- **הוספה מרובה**: הזנת רשימת מקורות בפורמט `שם[TAB]URL` או URLs בלבד
- **שיוך למספר עמודים**: כל מקור יכול להיות משויך לעמודים מרובים
- **סטטיסטיקות**: ספירת מקורות נסרקו/ממתינים/משויכים
- **מיגרציה**: ייבוא מקורות מעמודים קיימים

#### API Endpoints
| Endpoint | Method | תפקיד |
|----------|--------|-------|
| `/api/sources/registry` | GET/POST | ניהול מקורות |
| `/api/sources/registry/bulk` | POST | הוספה מרובה |
| `/api/sources/link` | POST | שיוך/ביטול שיוך לעמודים |
| `/api/sources/registry/scan` | POST | סריקה בודדת או כולם |
| `/api/sources/auto-assign` | POST | שיוך אוטומטי עם AI |
| `/api/sources/summary/<id>` | GET | סיכום AI של מקור |
| `/api/ai/models` | GET | רשימת מודלים זמינים |

#### ממשק משתמש
- **פאנל מקורות מידע**: בצד שמאל של ה-Dashboard
- **כפתורי פעולה לכל מקור**:
  - 📄 צפייה בסיכום
  - 🤖 שיוך אוטומטי AI
  - 🔄 סריקה מחדש
  - ✏️ עריכה
  - 🗑 מחיקה
  - 🔃 חידוש סיכום AI
- **סטטוס סריקה**: ⏳ ממתין | ✅ נסרק | ❌ שגיאה

### זרימת עבודה
```
1. הזנת מקורות → נשמרים למאגר (ללא שיוך)
        ↓
2. לחיצה על "סרוק הכל" → סריקת תוכן עם Chrome מקומי / Apify
        ↓
3. לחיצה על "שיוך אוטומטי" → AI מציע עמודים רלוונטיים
        ↓
4. עריכה → שינוי שיוכים לפי הצורך
        ↓
5. סיכום AI → יצירת סיכום מפורט לשימוש בתוכן
```

---

## 🧠 סיכום AI עם Ollama (חדש!)

### תיאור
המערכת משתמשת ב-**Ollama** להרצת מודלי שפה מקומיים על המחשב לצורך יצירת סיכומים מפורטים של מקורות מידע.

### מודלים נתמכים
| מודל | גודל | שימוש |
|------|------|-------|
| `gemma2:9b` | 5.4GB | ברירת מחדל - מאוזן |
| `qwen2.5:14b` | 9GB | איכותי יותר |
| `qwen2.5:7b` | 4.5GB | קל ומהיר |
| `llama3.1:8b` | 4.7GB | חלופה |

### התקנה ושימוש
```bash
# התקנת Ollama (Windows)
# הורד מ: https://ollama.com/download

# הורדת מודל
ollama pull gemma2:9b

# הפעלת השירות
ollama serve

# הפעלה עם GPU (NVIDIA)
setx OLLAMA_GPU_LAYERS 999
# ואז הפעל מחדש את Ollama
```

### מבנה הסיכום
הסיכום כולל:
- 🏦 **הגוף המלווה**: שם, סוג (בנק/חברה/קרן), רגולציה
- 📋 **פרטי המוצר**: שם, סוג, מטרה, תיאור
- 📈 **ריביות**: ריבית נקובה, סוג (קבועה/משתנה), פריים+, אפקטיבית, **אחוז מימון (LTV)**, הון עצמי
- 💰 **סכומים**: מינימום, מקסימום, סכום טיפוסי
- 📅 **תקופות**: מינימום, מקסימום החזר
- 📋 **דרישות**: תנאי זכאות, מסמכים נדרשים
- ⚠️ **הערות/אזהרות**: נקודות חשובות

### תהליך סריקה משופר
1. הסקרייפר מסיר אלמנטים מיותרים (iframes, תפריטים, פופאפים)
2. מחלץ נתונים מובנים מטבלאות ורשימות
3. שומר עד 12,000 תווים (במקום 8,000) לסיכום מלא יותר
4. ה-AI מחפש במיוחד: אחוזי מימון, LTV, הון עצמי, ריביות, עמלות

### קבצים רלוונטיים
- `ai_summarizer.py` - מחלקת הסיכום AI
- `local_scraper.py` - סקרייפר מקומי עם Chrome

---

## 🔍 סריקת מקורות (Data Scraping)

### אסטרטגיית סריקה דו-שלבית
המערכת מנסה קודם סקרייפר מקומי ועוברת ל-Apify כגיבוי:

1. **Chrome מקומי (🖥️)** - Playwright עם Chrome אמיתי
   - מהיר וחינמי
   - User-Agent אמיתי
   - מזהה חסימות ו-CAPTCHA

2. **Apify (☁️)** - שירות ענן כגיבוי
   - timeout של 10 דקות
   - עובד על אתרים שחוסמים סריקה

### קובץ `local_scraper.py`
```python
# סקרייפר מקומי עם Playwright
# משתמש ב-Chrome עם חלון גלוי
# User-Agent: Chrome עדכני
```

### התקנה
```bash
pip install playwright
playwright install chromium
```

---

*עודכן לאחרונה: 17 ינואר 2026 - הוספת מאגר מקורות מרכזי + סיכום AI עם Ollama + סריקה מקומית*
